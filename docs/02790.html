<html>
<head>
<title>How to Use Environment Variables to Store Secrets in AWS Amplify Backend</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用环境变量在AWS Amplify后端存储机密</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/how-to-use-environment-variables-to-store-secrets-in-aws-amplify-backend-f8637cb3d1b0?source=collection_archive---------49-----------------------#2021-05-25">https://medium.com/geekculture/how-to-use-environment-variables-to-store-secrets-in-aws-amplify-backend-f8637cb3d1b0?source=collection_archive---------49-----------------------#2021-05-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/963dd68a7f35c764726ad0e18d12e6f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*mTHo4TnEL1EDgPJ7.jpg"/></div></div></figure><p id="b1e1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae jo" href="https://12factor.net/" rel="noopener ugc nofollow" target="_blank">十二要素应用</a>是一种已知的构建软件即服务应用的方法。一个因素描述了应用程序的配置应该存储在环境中，而不是存储在代码中，以实现配置和代码的严格分离。</p><p id="2c21" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在本文中，我想演示如何使用环境变量和<a class="ae jo" href="https://aws.amazon.com/secrets-manager/" rel="noopener ugc nofollow" target="_blank"> AWS Secrets Manager </a>向<a class="ae jo" href="https://aws.amazon.com/amplify/" rel="noopener ugc nofollow" target="_blank"> AWS Amplify </a>后端添加敏感和不敏感的配置数据。</p><h1 id="32d6" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">配置类型</h1><p id="d186" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">存在许多类型的配置数据，例如:</p><ul class=""><li id="109b" class="ks kt hi is b it iu ix iy jb ku jf kv jj kw jn kx ky kz la bi translated">超时设定</li><li id="dd82" class="ks kt hi is b it lb ix lc jb ld jf le jj lf jn kx ky kz la bi translated">连接字符串</li><li id="bb56" class="ks kt hi is b it lb ix lc jb ld jf le jj lf jn kx ky kz la bi translated">外部API配置，如URL和端点</li><li id="bfd4" class="ks kt hi is b it lb ix lc jb ld jf le jj lf jn kx ky kz la bi translated">贮藏</li><li id="9722" class="ks kt hi is b it lb ix lc jb ld jf le jj lf jn kx ky kz la bi translated">URL、端口或模式的托管配置</li><li id="07a2" class="ks kt hi is b it lb ix lc jb ld jf le jj lf jn kx ky kz la bi translated">文件系统路径</li><li id="767e" class="ks kt hi is b it lb ix lc jb ld jf le jj lf jn kx ky kz la bi translated">框架配置</li><li id="5bc1" class="ks kt hi is b it lb ix lc jb ld jf le jj lf jn kx ky kz la bi translated">库配置</li><li id="9830" class="ks kt hi is b it lb ix lc jb ld jf le jj lf jn kx ky kz la bi translated">业务逻辑参数</li><li id="9ff0" class="ks kt hi is b it lb ix lc jb ld jf le jj lf jn kx ky kz la bi translated">还有更多</li></ul><p id="f734" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">除了类型之外，配置数据还可以分为敏感和不敏感。</p><h1 id="2c1a" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">敏感与不敏感</h1><p id="44c4" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">敏感配置数据是任何可能被第三方利用的数据，因此必须防止未经授权的访问。此类敏感数据的示例包括API密钥、用户名、密码、电子邮件等。这些数据不应该是版本控制的一部分。例如，不敏感配置数据是后端端点的超时字符串，可以安全地添加到版本控制中。</p><h1 id="7ea1" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">初始化放大</h1><blockquote class="lg lh li"><p id="bb96" class="iq ir lj is b it iu iv iw ix iy iz ja lk jc jd je ll jg jh ji lm jk jl jm jn hb bi translated">您需要安装和配置AWS帐户和Amplify CLI，以便能够执行以下步骤。<a class="ae jo" href="https://docs.amplify.aws/start/getting-started/installation/q/integration/js" rel="noopener ugc nofollow" target="_blank">查看官方文档</a>以设置先决条件。</p></blockquote><p id="d4e7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们首先创建一个新的Amplify项目:</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="21cd" class="lw jq hi ls b fi lx ly l lz ma">mkdir amplify-env-config-demo<br/>cd amplify-env-config-demo<br/><br/>▶ amplify init<br/>? Enter a name for the project amplifyenvconfigdemo<br/>? Initialize the project with the above configuration? Yes<br/>? Select the authentication method you want to use: AWS profile<br/>? Please choose the profile you want to use default</span></pre><p id="54d2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来，我们可以添加一个API，用于添加一些环境配置。</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="ca02" class="lw jq hi ls b fi lx ly l lz ma">▶ amplify add api<br/>? Please select from one of the below mentioned services: REST<br/>? Provide a friendly name for your resource to be used as a label for this category in the project: amplifyenvconfigdemoapi<br/>? Provide a path (e.g., /book/{isbn}): /handle<br/>? Choose a Lambda source Create a new Lambda function<br/>? Provide an AWS Lambda function name: amplifyenvconfigdemofunction<br/>? Choose the runtime that you want to use: NodeJS<br/>? Choose the function template that you want to use: Hello World<br/>? Do you want to configure advanced settings? No<br/>? Do you want to edit the local lambda function now? No<br/>? Restrict API access No<br/>? Do you want to add another path? No</span></pre><p id="35d6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们基于“Hello World”Amplify模板创建一个简单的<a class="ae jo" href="https://nodejs.org/" rel="noopener ugc nofollow" target="_blank"> Node.js </a> lambda函数。它将在路径<code class="du mb mc md ls b">/handle</code>上提供一个带有端点的REST API。</p><p id="b02c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Amplify CLI在<code class="du mb mc md ls b">amplify/backend/function/amplifyenvconfigdemofunction/src/index.js</code>生成“Hello World”功能代码:</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="86ea" class="lw jq hi ls b fi lx ly l lz ma">exports.handler = async event =&gt; {<br/>  // TODO implement<br/>  const response = {<br/>    statusCode: 200,<br/>    //  Uncomment below to enable CORS requests<br/>    //  headers: {<br/>    //      "Access-Control-Allow-Origin": "*",<br/>    //      "Access-Control-Allow-Headers": "*"<br/>    //  },<br/>    body: JSON.stringify('Hello from Lambda!'),<br/>  };<br/>  return response;<br/>};</span></pre><h1 id="15c4" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">添加不敏感的配置数据</h1><p id="67a8" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">由于我们现在有了一个正在运行的API，我们可以将一些不敏感的配置数据作为环境变量添加到我们的Amplify后端。</p><p id="a751" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，我们需要修改<code class="du mb mc md ls b">amplify/backend/function/amplifyenvconfigdemofunction/amplifyenvconfigdemofunction-cloudformation-template.json</code>文件。它包括一个<code class="du mb mc md ls b">Parameters</code>对象，我们可以在其中添加一个新的环境变量。在我们的例子中，我们想要添加一个字符串变量，它可以用键<code class="du mb mc md ls b">MyEnvVariableKey</code>访问，值为<code class="du mb mc md ls b">my-environment-variable</code>:</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="b5d5" class="lw jq hi ls b fi lx ly l lz ma">{<br/>  "AWSTemplateFormatVersion": "2010-09-09",<br/>  "Description": "Lambda Function resource stack creation using Amplify CLI",<br/>  "Parameters" : {<br/>    ...<br/>    "env": {<br/>      "Type": "String"<br/>    },<br/>    "s3Key": {<br/>      "Type": "String"<br/>    },<br/>    "MyEnvVariableKey" : {      "Type" : "String",      "Default" : "my-environment-variable"    }  },<br/>  ...<br/>}</span></pre><p id="4f8d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们还需要修改这个文件中的<code class="du mb mc md ls b">Resources &gt; Environment &gt; Variables</code>对象，以便能够将新的环境键映射到一个附加到全局<code class="du mb mc md ls b">process.env</code>变量并由Node.js运行时注入的变量:</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="261a" class="lw jq hi ls b fi lx ly l lz ma">{<br/>  "Resources": {<br/>    "Environment": {<br/>      "Variables": {<br/>        "ENV": {<br/>          "Ref": "env"<br/>        },<br/>        "REGION": {<br/>          "Ref": "AWS::Region"<br/>        },<br/>        "MY_ENV_VAR": {          "Ref": "MyEnvVariableKey"        }      }<br/>    }  <br/>  }<br/>}</span></pre><p id="afc9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后，我们需要运行<code class="du mb mc md ls b">amplify push</code>来构建我们所有的本地后端资源，并在云中提供它们。</p><p id="c64d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，我们可以通过访问全局<code class="du mb mc md ls b">process.env</code>变量来访问lambda函数中的这个变量:</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="71e9" class="lw jq hi ls b fi lx ly l lz ma">exports.handler = async event =&gt; {<br/>  console.log('MY_ENV_VAR', process.env.MY_ENV_VAR);<br/>  const response = {<br/>    statusCode: 200,<br/>    body: JSON.stringify('Hello from Lambda!'),<br/>  };<br/>  return response;<br/>};</span></pre><h1 id="1bcf" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">使用AWS Secrets Manager添加敏感数据</h1><p id="168c" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">AWS提供了<a class="ae jo" href="https://aws.amazon.com/secrets-manager/" rel="noopener ugc nofollow" target="_blank"> AWS秘密管理器</a>，帮助“保护访问您的应用程序、服务和IT资源所需的秘密”。我们将使用这项服务，以便能够从我们的后端访问敏感数据。</p><p id="f54f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">首先，我们需要点击“存储新密码”来创建一个新密码:</p><figure class="ln lo lp lq fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es me"><img src="../Images/e27b7f53769d51de246360f6645acc32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oX2EOmtK17b4X-YfNAcKYQ.jpeg"/></div></div></figure><p id="6592" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来，我们单击“其他类型的秘密”,并在相应的“秘密密钥/值”输入中输入密钥和值:</p><figure class="ln lo lp lq fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es me"><img src="../Images/1452570417e903cf4aa5dc726e2e7f12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5o-LvwPbaf8hzv5LaHCc7w.jpeg"/></div></div></figure><p id="bf60" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">可以向一个秘密添加多个键/值对。可以通过单击“+添加行”按钮来添加新对。</p><p id="ffac" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在下一个屏幕中，我们需要为我们的秘密添加一个名称和一些其他可选信息:</p><figure class="ln lo lp lq fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es me"><img src="../Images/afc27c8526eb37155c3fa1a0259a2570.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AVJ2OS0WEG0wEoEuIJQFyg.jpeg"/></div></div></figure><p id="5d50" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们通过单击“下一步”按钮跳过以下所有屏幕来完成向导。</p><p id="1e08" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在我们可以在AWS Secrets Manager中打开这个秘密并检查它的值:</p><figure class="ln lo lp lq fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es me"><img src="../Images/4e2f44242b047e2910c46d59062aca84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bf9uFSMkvyAUV9UZ8cdx2Q.jpeg"/></div></div></figure><p id="25ad" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们需要复制“秘密ARN”值，因为我们需要在Cloudformation配置文件<code class="du mb mc md ls b">amplifyenvconfigdemofunction-cloudformation-template.json</code>中添加一个新的配置对象:</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="b198" class="lw jq hi ls b fi lx ly l lz ma">"lambdaexecutionpolicy": {<br/>  "DependsOn": ["LambdaExecutionRole"],<br/>  "Type": "AWS::IAM::Policy",<br/>  "Properties": {<br/>  "PolicyName": "lambda-execution-policy",<br/>  "Roles": [{ "Ref": "LambdaExecutionRole" }],<br/>  "PolicyDocument": {<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {          "Effect": "Allow",          "Action": ["secretsmanager:GetSecretValue"],          "Resource": {            "Fn::Sub": [              "arn:aws:secretsmanager:${region}:${account}:secret:key_id",              {                 "region": {                  "Ref": "AWS::Region"                },                "account": {                  "Ref": "AWS::AccountId"                }              }            ]          }        }      ]<br/>    }<br/>  }<br/>}</span></pre><p id="1ea9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">同样，我们需要运行<code class="du mb mc md ls b">amplify push</code>来构建我们所有的本地后端资源，并在云中提供它们。</p><p id="95e8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在我们需要添加一些JavaScript代码来访问Node.js lambda函数内部的秘密。</p><p id="c5c1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">首先，我们需要通过运行以下命令将AWS SDK添加到<code class="du mb mc md ls b">amplify/backend/function/amplifyenvconfigdemofunction/src/package.json</code>:</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="9ffa" class="lw jq hi ls b fi lx ly l lz ma">npm install aws-sdk</span></pre><p id="c88f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后我们可以使用<code class="du mb mc md ls b">SecretsManager</code>通过传递我们在AWS秘密管理器中定义的“秘密名称”来获得我们的秘密值:</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="0faf" class="lw jq hi ls b fi lx ly l lz ma">const AWS = require('aws-sdk');const secretsManager = new AWS.SecretsManager();<br/>exports.handler = async event =&gt; {<br/>  console.log('MY_ENV_VAR', process.env.MY_ENV_VAR);<br/><br/>  const secretData = await secretsManager    .getSecretValue({ SecretId: 'dev/demoSecret' })    .promise();  const secretValues = JSON.parse(secretData.SecretString);  console.log('DEMO_API_KEY', secretValues.DEMO_API_KEY);<br/>  const response = {<br/>    statusCode: 200,<br/>    body: JSON.stringify('Hello from Lambda!'),<br/>  };<br/>  return response;<br/>};</span></pre><h1 id="91bf" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">结论</h1><p id="055a" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">在本文中，我演示了如何向AWS Amplify后端添加敏感和不敏感环境配置。如果你更喜欢视觉教程，你也可以观看Nader Dabit 的这个视频。</p><p id="358c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你喜欢这篇文章，请在<a class="ae jo" href="https://twitter.com/mokkapps" rel="noopener ugc nofollow" target="_blank"> Twitter </a>上关注我，从我这里获得关于新博客文章和更多内容的通知。</p></div><div class="ab cl mf mg gp mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="hb hc hd he hf"><p id="4e3b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lj">最初发布于</em><a class="ae jo" href="https://www.mokkapps.de/blog/how-to-use-environment-variables-to-store-secrets-in-aws-amplify-backend/" rel="noopener ugc nofollow" target="_blank"><em class="lj">https://www . mokkapps . de</em></a><em class="lj">。</em></p></div></div>    
</body>
</html>