<html>
<head>
<title>NodeJs Image upload with Multer</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Multer上传NodeJs图像</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/nodejs-image-upload-with-multer-e6cf08c1562f?source=collection_archive---------1-----------------------#2022-05-12">https://medium.com/geekculture/nodejs-image-upload-with-multer-e6cf08c1562f?source=collection_archive---------1-----------------------#2022-05-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/c1d3cf22becc4a3268dc9f86c513fa4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CPllEtejNuFpU73oVX3xCA.png"/></div></div></figure><h1 id="418f" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated"><strong class="ak">简介</strong></h1><p id="1443" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">我曾经发表过一篇<a class="ae km" rel="noopener" href="/geekculture/how-to-upload-images-to-cloudinary-with-a-react-app-f0dcc357999c">文章</a>关于如何用React应用上传图片到cloudinary，但是如果我们想上传图片到我们自己的Nodejs服务器上呢？这就是我将在本教程中涉及的内容。我将向您展示如何使用Multer上传图像，以及如何使用Sharp处理图像。在本教程结束时，您将能够在现有的或新的项目中实现这一点。</p><p id="6a7e" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">Multer是一个处理<code class="du ks kt ku kv b">multipart/form-data</code>的node.js中间件，主要用于上传文件。</p></div><div class="ab cl kw kx gp ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="hb hc hd he hf"><h1 id="3ea7" class="iq ir hi bd is it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn bi translated">先决条件</h1><ul class=""><li id="2c7a" class="li lj hi jq b jr js jv jw jz lk kd ll kh lm kl ln lo lp lq bi translated">对javascript的基本理解</li><li id="6dbe" class="li lj hi jq b jr lr jv ls jz lt kd lu kh lv kl ln lo lp lq bi translated">NodeJs/Express的基础知识</li><li id="9f71" class="li lj hi jq b jr lr jv ls jz lt kd lu kh lv kl ln lo lp lq bi translated">您机器上安装的最新版本的nodeJs</li><li id="5f1b" class="li lj hi jq b jr lr jv ls jz lt kd lu kh lv kl ln lo lp lq bi translated">邮递员</li></ul><h1 id="fecb" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">1.设置我们的项目</h1><h2 id="8151" class="lw ir hi bd is lx ly lz iw ma mb mc ja jz md me je kd mf mg ji kh mh mi jm mj bi translated">1.1安装节点</h2><p id="2278" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">打开cmd并运行下面的命令来检查你是否安装了NodeJs，如果你没有查看这篇关于如何在你的windows机器上安装Nodejs的<a class="ae km" href="https://www.geeksforgeeks.org/installation-of-node-js-on-windows/" rel="noopener ugc nofollow" target="_blank">文章</a>。</p><pre class="mk ml mm mn fd mo kv mp mq aw mr bi"><span id="34b8" class="lw ir hi kv b fi ms mt l mu mv">node -v</span></pre><h2 id="31ea" class="lw ir hi bd is lx ly lz iw ma mb mc ja jz md me je kd mf mg ji kh mh mi jm mj bi translated">1.2创建文件夹目录</h2><p id="42d1" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">您可以在终端中运行该命令，或者在文件浏览器中创建一个文件夹，然后在终端中导航到该文件夹</p><pre class="mk ml mm mn fd mo kv mp mq aw mr bi"><span id="8ac3" class="lw ir hi kv b fi ms mt l mu mv">mkdir image-upload-with-multer<br/>cd image-upload-with-multer</span></pre><h1 id="746a" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">2.项目初始化</h1><h2 id="d32f" class="lw ir hi bd is lx ly lz iw ma mb mc ja jz md me je kd mf mg ji kh mh mi jm mj bi translated">2.1创建package.json文件</h2><p id="706e" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">运行npm init以创建package.json文件。</p><pre class="mk ml mm mn fd mo kv mp mq aw mr bi"><span id="5a69" class="lw ir hi kv b fi ms mt l mu mv">npm init -y</span></pre><p id="777f" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">“y”标志使用默认设置创建文件。</p><h2 id="1de3" class="lw ir hi bd is lx ly lz iw ma mb mc ja jz md me je kd mf mg ji kh mh mi jm mj bi translated">2.2安装依赖和开发依赖</h2><pre class="mk ml mm mn fd mo kv mp mq aw mr bi"><span id="3cf1" class="lw ir hi kv b fi ms mt l mu mv">npm i express multer sharp</span></pre><p id="6072" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">我们将使用express来设置我们的服务器，multer来处理文件上传，sharp来裁剪图像到我们想要的大小。</p><pre class="mk ml mm mn fd mo kv mp mq aw mr bi"><span id="4b5d" class="lw ir hi kv b fi ms mt l mu mv">npm i -D nodemon</span></pre><p id="ebf1" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">每当文件改变时，我们将需要nodemon来重启我们的服务器。D标志是作为开发依赖项安装的，因为在生产环境中不需要它。</p><p id="3d25" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">在安装nodemon之后，打开package.json文件并添加一个新脚本，如下所示</p><pre class="mk ml mm mn fd mo kv mp mq aw mr bi"><span id="bc42" class="lw ir hi kv b fi ms mt l mu mv">"dev":"nodemon app.js"</span></pre><p id="98e7" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">您的package.json文件应该如下所示</p><figure class="mk ml mm mn fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mw"><img src="../Images/9e05189c3b616170ed6e7fffd1c4b994.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6HrqMc3ivvguGPIyJ3HClQ.png"/></div></div></figure><h1 id="d7b7" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">3.设置我们的服务器</h1><h2 id="9e5d" class="lw ir hi bd is lx ly lz iw ma mb mc ja jz md me je kd mf mg ji kh mh mi jm mj bi translated">3.1基本服务器设置</h2><p id="fb92" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">在根目录中创建一个“app.js”文件，然后粘贴以下代码</p><pre class="mk ml mm mn fd mo kv mp mq aw mr bi"><span id="f3e0" class="lw ir hi kv b fi ms mt l mu mv">const express = require('express')</span><span id="bf30" class="lw ir hi kv b fi mx mt l mu mv">const multer = require('multer')</span><span id="853b" class="lw ir hi kv b fi mx mt l mu mv">const sharp = require('sharp')</span><span id="a5b5" class="lw ir hi kv b fi mx mt l mu mv">const port = process.env.PORT || 5000</span><span id="6983" class="lw ir hi kv b fi mx mt l mu mv">const app = express()<br/>app.use(express.json())</span><span id="ccdf" class="lw ir hi kv b fi mx mt l mu mv">app.listen(port, () =&gt; {<br/>console.log('Server is running on port '+ port)<br/>})</span></pre><p id="e158" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">然后，您可以在终端中运行以下命令</p><pre class="mk ml mm mn fd mo kv mp mq aw mr bi"><span id="b453" class="lw ir hi kv b fi ms mt l mu mv">npm run dev</span></pre><p id="5810" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">如果一切顺利，您应该会在控制台上看到这个</p><figure class="mk ml mm mn fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es my"><img src="../Images/5e4d9ed7d8fa1306fb2a988459ca2595.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1vQZXVC_op045AJEMpuIXA.png"/></div></div></figure><h1 id="369a" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">4.穆尔特</h1><h2 id="496c" class="lw ir hi bd is lx ly lz iw ma mb mc ja jz md me je kd mf mg ji kh mh mi jm mj bi translated">4.1配置乘法器</h2><p id="841a" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">在“app.use”下面粘贴以下代码</p><pre class="mk ml mm mn fd mo kv mp mq aw mr bi"><span id="c9d4" class="lw ir hi kv b fi ms mt l mu mv">const upload = multer({</span><span id="c68f" class="lw ir hi kv b fi mx mt l mu mv">limits: {</span><span id="024a" class="lw ir hi kv b fi mx mt l mu mv">fileSize: 1000000</span><span id="43ad" class="lw ir hi kv b fi mx mt l mu mv">},</span><span id="5b1b" class="lw ir hi kv b fi mx mt l mu mv">fileFilter(req, file, cb) {</span><span id="14f0" class="lw ir hi kv b fi mx mt l mu mv">if(!file.originalname.match(/\.(jpg|jpeg|png)$/)) {</span><span id="dce2" class="lw ir hi kv b fi mx mt l mu mv">return cb( new Error('Please upload a valid image file'))</span><span id="a166" class="lw ir hi kv b fi mx mt l mu mv">}</span><span id="371a" class="lw ir hi kv b fi mx mt l mu mv">cb(undefined, true)</span><span id="dfc5" class="lw ir hi kv b fi mx mt l mu mv">}<br/>})</span></pre><p id="826d" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">limits属性指定上载数据的限制。在这里，我们为上传的图像设置了1mb的限制。</p><p id="88d6" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">由于我们正在进行图像上传，我们需要限制文件类型，只接受图像。可以为每个端点设置不同的Multer来接受不同类型的文件。</p><p id="dfad" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">fileFilter属性接受三个参数，即请求、要上传的文件和回调。</p><p id="7116" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">回调接受两个参数，如果发生任何错误，则为错误，第二个参数为布尔值(如果应该接受上传，则为真，否则为假)</p><p id="29a4" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">“file.pathname”包含用户计算机上的文件名及其扩展名，因此我们正在检查文件扩展名是否与接受的三种图像类型相匹配。如果没有，我们使用回调抛出一个错误。如果匹配，我们将' undefined '作为第一个参数传递给回调，将' true '作为第二个参数，指定应该允许上传。</p><p id="13b9" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">这种验证也可以针对其他文件类型进行修改。</p><p id="d372" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">更多信息请参考multer <a class="ae km" href="https://www.npmjs.com/package/multer" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><h1 id="3300" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">5.图像上传路线</h1><p id="df11" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">配置multer后，复制并粘贴以下代码来创建图像上传路径</p><pre class="mk ml mm mn fd mo kv mp mq aw mr bi"><span id="9c78" class="lw ir hi kv b fi ms mt l mu mv">app.post('/image', upload.single('upload'), async (req, res) =&gt; {</span><span id="4041" class="lw ir hi kv b fi mx mt l mu mv">try {</span><span id="f9a5" class="lw ir hi kv b fi mx mt l mu mv">await sharp(req.file.buffer).resize({ width: 250, height: 250 }).png().toFile(__dirname + `/images/${req.file.originalname}`)</span><span id="7bad" class="lw ir hi kv b fi mx mt l mu mv">res.status(201).send('Image uploaded succesfully')</span><span id="cdea" class="lw ir hi kv b fi mx mt l mu mv">} catch (error) {</span><span id="51f7" class="lw ir hi kv b fi mx mt l mu mv">console.log(error)</span><span id="075e" class="lw ir hi kv b fi mx mt l mu mv">res.status(400).send(error)</span><span id="f752" class="lw ir hi kv b fi mx mt l mu mv">}</span><span id="de07" class="lw ir hi kv b fi mx mt l mu mv">})</span></pre><p id="b167" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">为了传入multer中间件，我们使用“上传”，这是我们之前做的配置，然后我们调用它的一个函数，返回我们需要的中间件。该功能是“单一”的。Single需要一个参数，一个可以是任何内容的字符串。在这里，我们称之为“上传”。</p><p id="6e98" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">您还可以使用“upload.array()”上传多个文件。有关如何设置的步骤，请访问multer <a class="ae km" href="https://expressjs.com/en/resources/middleware/multer.html" rel="noopener ugc nofollow" target="_blank">文档</a></p><p id="70c5" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">multer完成图像处理和验证后，可以在“req.file”上访问数据，您可以将此记录到控制台，以查看其外观。</p><p id="84f2" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">我们做的下一件事是将图像缓冲区传递给sharp，调整它的大小，并使用“toFile”属性保存图像。toFile属性将输出图像数据写入文件。它将文件路径作为一个参数，在这里，我指定它用原始文件名保存图像。</p><p id="889c" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">这只是你可以用sharp做什么的一个提示。夏普比这强大得多，你绝对应该看看文档<a class="ae km" href="https://sharp.pixelplumbing.com/" rel="noopener ugc nofollow" target="_blank">这里</a></p><p id="dac2" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">保存文件，服务器应该重新启动。</p><p id="8f5a" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">您的app.js文件应该是这样的</p><figure class="mk ml mm mn fd ij"><div class="bz dy l di"><div class="mz na l"/></div></figure><h1 id="27b2" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">6.邮递员测试</h1><p id="6da0" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">在项目的根目录下创建一个名为“images”的新文件夹</p><p id="7187" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">转到postman，创建一个新的post请求到url，如下所示</p><pre class="mk ml mm mn fd mo kv mp mq aw mr bi"><span id="b47a" class="lw ir hi kv b fi ms mt l mu mv">localhost:5000/image</span></pre><p id="d7d7" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">在“正文”选项卡中，选择“表单-数据”。键是我们之前传递给' upload.single '的字符串，值是要上传的图像。</p><p id="32a6" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">将密钥类型更改为文件，并选择要上传的图像。</p><p id="773d" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">注意:图像必须小于1mb</p><figure class="mk ml mm mn fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nb"><img src="../Images/ec792e762451c2e0924f77a881d49c18.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D3OqYa1weXEorG5K0iofPg.png"/></div></div></figure><p id="279b" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">点击发送按钮，你应该会得到一个响应，图像已经上传成功，如下所示。</p><figure class="mk ml mm mn fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nb"><img src="../Images/21f774ede57d22d5c0122a66baaa7a81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bwSblAq1Pk2xqUFjCVrruw.png"/></div></div></figure><p id="0ede" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">前往项目文件夹，您应该能够看到上传的图像。</p><figure class="mk ml mm mn fd ij er es paragraph-image"><div class="er es nc"><img src="../Images/20a53e184fc14ad67811f59de1da3091.png" data-original-src="https://miro.medium.com/v2/resize:fit:1132/format:webp/1*cB13HIkbEK_SVzQkIAavFw.png"/></div></figure><h1 id="c5af" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">7.结论</h1><p id="def1" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">我们已经成功构建了一个nodejs服务器，它使用multer和sharp接受图像上传。</p><p id="3cb9" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">Github回购可以在这里找到<a class="ae km" href="https://github.com/breellz/image-upload-with-multer" rel="noopener ugc nofollow" target="_blank">https://github.com/breellz/image-upload-with-multer</a></p><p id="fdbc" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">觉得这个有用就留个掌声。</p><p id="b875" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">感谢阅读</p></div></div>    
</body>
</html>