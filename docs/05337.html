<html>
<head>
<title>Unit testing DateTime.now() with the help of Dart extensions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">借助Dart扩展对DateTime.now()进行单元测试</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/unit-testing-datetime-now-with-the-help-of-dart-extensions-d2b0c9f991bf?source=collection_archive---------29-----------------------#2021-07-18">https://medium.com/geekculture/unit-testing-datetime-now-with-the-help-of-dart-extensions-d2b0c9f991bf?source=collection_archive---------29-----------------------#2021-07-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/c7d86c8e7524a2242fdceb13d68f7662.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*pitcnNP2pb13GEHa.png"/></div></div></figure><h1 id="4b45" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">问题是…</h1><p id="0bcc" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">在我们的应用程序中，无论是在UI端还是在数据端，我们经常需要为日期设置“默认值”，在大多数情况下，最简单的方法是使用DateTime.now()，毕竟，我们最有可能使用当前时间作为默认值。</p><p id="160b" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">虽然这非常方便，但是在测试的时候会造成复杂性。在Dart中，不可能简单地全局覆盖方法或函数，只能模拟传入类中的参数，向类中添加DateTime参数虽然很容易，但并不是很少需要，而且很可能会导致不必要的膨胀。</p><p id="955a" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">然而，对于小部件，情况就完全不同了，您要么需要将DateTime传递给小部件，要么创建一个自定义类，并将其添加到一些依赖注入中，以便能够在测试中模拟它。</p><h1 id="183f" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">一个解决方案…</h1><p id="843d" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">我发现的一个解决方案是dart 2.7中引入的扩展</p><blockquote class="kr ks kt"><p id="9114" class="jo jp ku jq b jr km jt ju jv kn jx jy kv ko kb kc kw kp kf kg kx kq kj kk kl hb bi translated">Dart 2.7中引入的扩展方法是向现有库添加功能的一种方式。( <a class="ae ky" href="https://dart.dev/guides/language/extension-methods" rel="noopener ugc nofollow" target="_blank"> <em class="hi">链接</em> </a> <em class="hi"> ) </em></p></blockquote><p id="a8d5" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">使用它，我们能够在DateTime上创建一个扩展，用它我们既可以获得“当前”时间，又可以实现一个setter来允许我们覆盖“当前”时间。</p><pre class="kz la lb lc fd ld le lf lg aw lh bi"><span id="8947" class="li ir hi le b fi lj lk l ll lm">extension ExtendedDateTime on DateTime { static DateTime? _customTime; static DateTime get current { return _customTime ?? DateTime.now(); } static set customTime(DateTime customTime) { _customTime = customTime; } }</span></pre><p id="d968" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">我们有一个可空的DateTime，当我们在代码中使用ExtendedDateTime.current时，它将返回DateTime.now()的值。</p><p id="bc3e" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">这本身没什么特别的，set方法才是我们真正关心的。</p><p id="2a0e" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">以下面这个类为例。</p><pre class="kz la lb lc fd ld le lf lg aw lh bi"><span id="031a" class="li ir hi le b fi lj lk l ll lm">class User { final String userName; final DateTime createdDate; User(this.userName, this.createdDate); static User createUser(String userName) =&gt; User(userName, DateTime.now()); }</span></pre><p id="8797" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">在我们代码的逻辑中，我们希望创建一个新用户，所以我希望验证当我调用User.createUser时，它会返回一个新用户，并带有传入的名称和当前日期时间。然而，在测试执行期间，调用函数和验证预期之间会有几毫秒的时间。</p><pre class="kz la lb lc fd ld le lf lg aw lh bi"><span id="352b" class="li ir hi le b fi lj lk l ll lm">final result = User.createUser('Reme'); expect(result, equals(User('Reme', DateTime.now());</span></pre><p id="e66f" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">由于这几毫秒的时间，上面的例子几乎肯定会失败。</p><p id="90a2" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">既然我们已经将扩展添加到项目中，我们可以重构代码，使其看起来更像:</p><pre class="kz la lb lc fd ld le lf lg aw lh bi"><span id="0a4b" class="li ir hi le b fi lj lk l ll lm">class User { final String userName; final DateTime createdDate; User(this.userName, this.createdDate); static User createUser(String userName) =&gt; User(userName, ExtendedDateTime.current); }</span></pre><p id="dee3" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">之后，我们的测试看起来会像这样:</p><pre class="kz la lb lc fd ld le lf lg aw lh bi"><span id="b2c8" class="li ir hi le b fi lj lk l ll lm">ExtendedDateTime.current = DateTime.parse( "2020-05-15 13:07:53.531Z", ); final result = User.createUser('Reme'); expect(result, equals(User('Reme', "2020-05-15 13:07:53.531Z");</span></pre><h1 id="2cf9" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">最后的想法…</h1><p id="ed23" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">正如你所看到的，通过对我们的代码做很小的改动，我们现在可以很容易地保持事情的简单，而不会影响我们测试它们的能力。</p><p id="3808" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">我经常喜欢说，也许有人对我说过一次，不记得了…</p><blockquote class="kr ks kt"><p id="bf48" class="jo jp ku jq b jr km jt ju jv kn jx jy kv ko kb kc kw kp kf kg kx kq kj kk kl hb bi translated"><em class="hi">工作代码！=可测试代码，但可测试代码==工作代码。</em></p></blockquote><p id="87f1" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">这可能并不总是有趣的，但是今天几分钟的测试可以节省你明天几个小时的调试时间。</p><p id="1c6d" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">我希望你喜欢这篇文章，如果你有任何问题，意见或建议，请随时发表评论。</p><p id="7432" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">如果你喜欢，一颗心会很棒，如果你真的喜欢，一杯<a class="ae ky" href="https://www.buymeacoffee.com/remelehane" rel="noopener ugc nofollow" target="_blank">咖啡</a>会很棒。</p><p id="6e86" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">感谢阅读。</p></div><div class="ab cl ln lo gp lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="hb hc hd he hf"><p id="09a4" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated"><em class="ku">原载于2021年7月18日</em><a class="ae ky" href="https://remelehane.dev/posts/unit-testing-dattimenow-with-the-help-of-dart-extensions/" rel="noopener ugc nofollow" target="_blank"><em class="ku">https://remelehane . dev</em></a><em class="ku">。</em></p><div class="lu lv ez fb lw lx"><a href="https://itnext.io/flutter-web-should-i-use-it-part-1-seo-842d87ff9d28" rel="noopener  ugc nofollow" target="_blank"><div class="ly ab dw"><div class="lz ab ma cl cj mb"><h2 class="bd hj fi z dy mc ea eb md ed ef hh bi translated">Flutter Web:我应该使用它吗？(第1部分—搜索引擎优化)</h2><div class="me l"><h3 class="bd b fi z dy mc ea eb md ed ef dx translated">有很多关于网页抖动和它的缺点的讨论，在这一部分我们将讨论SEO和网页清理器。</h3></div><div class="mf l"><p class="bd b fp z dy mc ea eb md ed ef dx translated">itnext.io</p></div></div><div class="mg l"><div class="mh l mi mj mk mg ml io lx"/></div></div></a></div><div class="lu lv ez fb lw lx"><a href="https://blog.usejournal.com/developing-on-an-m1-mac-flutter-563c8dcc28f" rel="noopener  ugc nofollow" target="_blank"><div class="ly ab dw"><div class="lz ab ma cl cj mb"><h2 class="bd hj fi z dy mc ea eb md ed ef hh bi translated">在M1 Mac上开发(颤振)</h2><div class="me l"><h3 class="bd b fi z dy mc ea eb md ed ef dx translated">作为一名开发新款M1 Macbook Pro的Flutter and React开发人员，我有一个简短的见解</h3></div><div class="mf l"><p class="bd b fp z dy mc ea eb md ed ef dx translated">blog.usejournal.com</p></div></div><div class="mg l"><div class="mm l mi mj mk mg ml io lx"/></div></div></a></div></div></div>    
</body>
</html>