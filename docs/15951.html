<html>
<head>
<title>Conftest | kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">库伯内特斯</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/conftest-kubernetes-9a064c302d43?source=collection_archive---------5-----------------------#2022-12-02">https://medium.com/geekculture/conftest-kubernetes-9a064c302d43?source=collection_archive---------5-----------------------#2022-12-02</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="15d4" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">Kubernetes中Conftest的用法</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/1cd3e9a13c9e78b83458ec5c4cc4a060.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5LdcOMT4TgWYDezP"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Photo by <a class="ae jn" href="https://unsplash.com/ja/@clintadair?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Clint Adair</a> on <a class="ae jn" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="a533" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><a class="ae jn" href="https://www.conftest.dev/" rel="noopener ugc nofollow" target="_blank"><strong class="jq hj"/></a>是一个针对kubernetes配置的单元测试框架。它使用<a class="ae jn" href="https://www.openpolicyagent.org/docs/latest/policy-language/" rel="noopener ugc nofollow" target="_blank"> rego语言</a>来编写政策。并帮助我们针对结构化的配置数据编写测试。</p><h2 id="1036" class="kk kl hi bd km kn ko kp kq kr ks kt ku jx kv kw kx kb ky kz la kf lb lc ld le bi translated">安装— Linux</h2><pre class="iy iz ja jb fd lf lg lh bn li lj bi"><span id="b4fa" class="lk kl hi lg b be ll lm l ln lo">LATEST_VERSION=$(wget -O - "https://api.github.com/repos/open-policy-agent/conftest/releases/latest" | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/' | cut -c 2-)<br/>wget "https://github.com/open-policy-agent/conftest/releases/download/v${LATEST_VERSION}/conftest_${LATEST_VERSION}_Linux_x86_64.tar.gz"<br/>tar xzf conftest_${LATEST_VERSION}_Linux_x86_64.tar.gz<br/>sudo mv conftest /usr/local/bin</span></pre><p id="8b29" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">其他操作系统的安装过程— <a class="ae jn" href="https://www.conftest.dev/install/" rel="noopener ugc nofollow" target="_blank">安装过程</a></p><h2 id="d5c9" class="kk kl hi bd km kn ko kp kq kr ks kt ku jx kv kw kx kb ky kz la kf lb lc ld le bi translated">政策:</h2><p id="d257" class="pw-post-body-paragraph jo jp hi jq b jr lp ij jt ju lq im jw jx lr jz ka kb ls kd ke kf lt kh ki kj hb bi translated">让我们创建一个目录来存储策略。默认情况下，<strong class="jq hj"> conftest </strong>在<strong class="jq hj"> /root/policy </strong>目录下查找策略。但是我们也可以将策略存储在不同的目录中，然后在运行conftest时传递目录路径。</p><pre class="iy iz ja jb fd lf lg lh bn li lj bi"><span id="bfac" class="lk kl hi lg b be ll lm l ln lo"># Create new directory to srore policies<br/>&gt;&gt; mkdir -p conftest/policy</span></pre><p id="d12c" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">假设我们想要拒绝kubernetes集群上的"<strong class="jq hj"> NodePort </strong>"类型服务。为此，我们可以使用以下rego策略:</p><pre class="iy iz ja jb fd lf lg lh bn li lj bi"><span id="6931" class="lk kl hi lg b be ll lm l ln lo"># /conftest/policy/nodeport-service-deny.rego<br/><br/>package main<br/><br/>deny[msg] {<br/>  input.kind = "Service"<br/>  input.spec.type = "NodePort"<br/>  msg = "NodePort Service is not Allowed"<br/>}</span></pre><h2 id="3588" class="kk kl hi bd km kn ko kp kq kr ks kt ku jx kv kw kx kb ky kz la kf lb lc ld le bi translated">k8s-清单</h2><p id="51f2" class="pw-post-body-paragraph jo jp hi jq b jr lp ij jt ju lq im jw jx lr jz ka kb ls kd ke kf lt kh ki kj hb bi translated">下面是我们要测试的服务清单文件:</p><pre class="iy iz ja jb fd lf lg lh bn li lj bi"><span id="c600" class="lk kl hi lg b be ll lm l ln lo"># k8s/srv-test.yaml<br/><br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  labels:<br/>    app: test<br/>  name: srv-test<br/>spec: <br/>  type: NodePort<br/>  selector:<br/>    app: test<br/>  ports:<br/>  - port: 80<br/>    protocol: TCP<br/>    targetPort: 80<br/>    nodePort: 32000</span></pre><h2 id="9b28" class="kk kl hi bd km kn ko kp kq kr ks kt ku jx kv kw kx kb ky kz la kf lb lc ld le bi translated">试验</h2><p id="6ab4" class="pw-post-body-paragraph jo jp hi jq b jr lp ij jt ju lq im jw jx lr jz ka kb ls kd ke kf lt kh ki kj hb bi translated">现在，让我们为上面定义的服务清单文件运行conftest:</p><pre class="iy iz ja jb fd lf lg lh bn li lj bi"><span id="4b06" class="lk kl hi lg b be ll lm l ln lo">#                  [Policy Path]      [K8s Manifest]<br/>&gt;&gt; conftest test -p conftest/policy/  k8s/srv-test.yaml <br/><br/>FAIL - k8s/srv-test.yaml - main - NodePort Service is not Allowed<br/><br/>1 test, 0 passed, 0 warnings, 1 failure, 0 exceptions</span></pre><p id="e18f" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在上面的演示中，我们可以看到测试<strong class="jq hj">失败</strong>。因为我们使用了“<strong class="jq hj">节点端口</strong>”类型的服务。现在让我们将“<strong class="jq hj">节点端口</strong>”服务改为“<strong class="jq hj">负载平衡器</strong>”，看看我们的策略如何反应。</p><pre class="iy iz ja jb fd lf lg lh bn li lj bi"><span id="537f" class="lk kl hi lg b be ll lm l ln lo"># k8s/srv-test.yaml<br/><br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  labels:<br/>    app: test<br/>  name: srv-test<br/>spec: <br/>  type: LoadBalancer   #&lt;-----<br/>  selector:<br/>    app: test<br/>  ports:<br/>  - port: 80<br/>    protocol: TCP<br/>    targetPort: 80<br/>    nodePort: 32000</span></pre><p id="8fc3" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在，让我们再做一次测试:</p><pre class="iy iz ja jb fd lf lg lh bn li lj bi"><span id="deb9" class="lk kl hi lg b be ll lm l ln lo">#                  [Policy Path]      [K8s Manifest]<br/>&gt;&gt; conftest test -p conftest/policy/ k8s/srv-test.yaml <br/><br/>1 test, 1 passed, 0 warnings, 0 failures, 0 exceptions</span></pre><p id="bd53" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">太好了！</strong>我们可以看到，这一次k8s服务清单文件已经通过了conftest测试。</p><p id="d051" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">关于这些政策的更多示例可在此处找到— <a class="ae jn" href="https://github.com/open-policy-agent/conftest/tree/master/examples/kubernetes" rel="noopener ugc nofollow" target="_blank">常见示例</a></p></div><div class="ab cl lu lv gp lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="hb hc hd he hf"><blockquote class="mb mc md"><p id="459b" class="jo jp me jq b jr js ij jt ju jv im jw mf jy jz ka mg kc kd ke mh kg kh ki kj hb bi translated"><em class="hi">如果你觉得这篇文章很有帮助，请点击</em> <strong class="jq hj"> <em class="hi">关注</em> </strong> <em class="hi">👉</em><strong class="jq hj"><em class="hi"/></strong><em class="hi"/><strong class="jq hj"><em class="hi">拍手</em> </strong> <em class="hi">👏</em> <strong class="jq hj"> <em class="hi"> </em> </strong> <em class="hi">按钮帮助我写更多这样的文章。<br/>谢谢🖤 </em></p></blockquote></div><div class="ab cl lu lv gp lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="hb hc hd he hf"><h2 id="7b98" class="kk kl hi bd km kn ko kp kq kr ks kt ku jx kv kw kx kb ky kz la kf lb lc ld le bi translated">🚀👉关于Kubernetes的所有文章</h2><div class="mi mj ez fb mk"><div role="button" tabindex="0" class="ab bv ff cb dy ml mm bn mn jh mo"><div class="mp l"><div class="ab q"><div class="l di"><img alt="Md Shamim" class="l de bw mq mr du" src="../Images/b46bdc53005abde6c6cb3e8ff0c200c3.png" width="20" height="20" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:40:40/1*Hqd8Xz1WHsoL1s2To3awnA.png"/><div class="dr bw l mq mr ds n aw dt"/></div><div class="gg l dw"><p class="bd b fp z dy dz ea eb ec ed ee ef dx translated"><a class="ae af ag ah ai aj ak al am an ao ap aq ar as" rel="noopener follow" target="_top" href="/@shamimice03?source=post_page-----9a064c302d43--------------------------------"> Md沙米姆</a></p></div></div><div class="mu mv fg l"><h2 class="bd hj si sj dy sk ea eb sl ed ef hh bi translated">关于Kubernetes的所有文章</h2></div><div class="ab q"><div class="l dw"><a class="bd b be z bi sm au sn so sp pl sq an fx fy sr ss st gb gc gd de bk ge" rel="noopener follow" target="_top" href="/@shamimice03/list/all-articles-on-kubernetes-7ae1a0f96f3b?source=post_page-----9a064c302d43--------------------------------">View list</a></div><div class="su l dw"><span class="bd b fp z dx">24 stories</span></div></div></div><div class="nh dh ni dy ab nj dw di"><div class="di mz bv na nb"><div class="dh l"><img alt="" class="dh" src="../Images/f1050aa27a3ef03122558b1ba1de1f58.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*7DhVxBWLKw_5M_jP"/></div></div><div class="di mz bv nc nd ne"><div class="dh l"><img alt="" class="dh" src="../Images/f1c4131e92176033bce05392de197205.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/1*AkrEbqlA_j76u2I5Tm8npg.png"/></div></div><div class="di bv nf ng ne"><div class="dh l"><img alt="" class="dh" src="../Images/27d4385154af67764cf37713dbbdc38e.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*98RmgcHgM1cyOobu"/></div></div></div></div></div></div></div>    
</body>
</html>