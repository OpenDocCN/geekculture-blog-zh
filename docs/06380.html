<html>
<head>
<title>Auth0 Multi-Tenancy with React. Part1: Introductory word</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带React的Auth0多租户。第一部分:引言</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/auth0-multi-tenancy-with-react-part1-introductory-word-7f2782cf71d?source=collection_archive---------26-----------------------#2021-08-18">https://medium.com/geekculture/auth0-multi-tenancy-with-react-part1-introductory-word-7f2782cf71d?source=collection_archive---------26-----------------------#2021-08-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="024c" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">这是一组介绍使用React和Auth0构建多租户架构的可能方法的文章。我们将为每个可用选项实施POC(概念验证),并强调每个选项的利弊。它让你清楚地了解为当前项目选择哪些选项。</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/25395c2b2aee0f053dff9bcda63c2b31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IlR7VPsxCbGeRTPwVfvTPg.jpeg"/></div></div></figure><h1 id="d4a7" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated"><strong class="ak">文章系列内容:</strong></h1><ol class=""><li id="292e" class="kb kc hi kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">带React的Auth0多租户。第一部分:引言— <strong class="kd hj">我们现在正在读这篇文章</strong></li><li id="7c37" class="kb kc hi kd b ke kt kg ku ki kv kk kw km kx ko kp kq kr ks bi translated"><a class="ae ky" rel="noopener" href="/geekculture/auth0-multi-tenancy-with-react-part2-multi-tenancy-attaching-tenant-specific-metadata-to-the-user-e125aa585e32"> Auth0多租户与React。第2部分:多租户，其中一个Auth0租户将特定于租户的元数据附加到用户</a></li><li id="9219" class="kb kc hi kd b ke kt kg ku ki kv kk kw km kx ko kp kq kr ks bi translated">带React的Auth0多租户。第3部分:具有不同数据库连接的一个Auth0租户的多租户</li><li id="0451" class="kb kc hi kd b ke kt kg ku ki kv kk kw km kx ko kp kq kr ks bi translated">带React的Auth0多租户。第4部分:具有多个授权租户的多租户— <strong class="kd hj"> TBD </strong></li></ol></div><div class="ab cl kz la gp lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="hb hc hd he hf"><p id="992d" class="pw-post-body-paragraph lg lh hi kd b ke li ij lj kg lk im ll ki lm ln lo kk lp lq lr km ls lt lu ko hb bi translated">您可以自己实现授权，但它不适用于企业应用程序，在企业应用程序中，您更可能使用已经实现的决策，如Auth0、Azure Active Directory等。这里我们要考虑更深层次的Auth0。</p><p id="0028" class="pw-post-body-paragraph lg lh hi kd b ke li ij lj kg lk im ll ki lm ln lo kk lp lq lr km ls lt lu ko hb bi translated">Auth0针对任何知名技术(React、Angular、Vue、NodeJS等)发布的帮助单租户应用集成Auth0的文章有很多:<a class="ae ky" href="https://auth0.com/docs/quickstarts" rel="noopener ugc nofollow" target="_blank"><em class="lv">auth 0</em></a>入门。</p><p id="f655" class="pw-post-body-paragraph lg lh hi kd b ke li ij lj kg lk im ll ki lm ln lo kk lp lq lr km ls lt lu ko hb bi translated">在这里，我们将重点关注多租户架构和一些可能的实现方式。有几种方法可以做这件事。</p><h1 id="b825" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">什么是多租户？</h1><blockquote class="lw lx ly"><p id="35d4" class="lg lh lv kd b ke li ij lj kg lk im ll lz lm ln lo ma lp lq lr mb ls lt lu ko hb bi translated"><strong class="kd hj">多租户</strong>是指一个软件实例运行在一台服务器上，多组用户可以访问该服务器。</p></blockquote><h1 id="a91c" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">多租户何时适用？</h1><p id="19e4" class="pw-post-body-paragraph lg lh hi kd b ke kf ij lj kg kh im ll ki mc ln lo kk md lq lr km me lt lu ko hb bi translated">例如，您正在开发一个可能由不同组织使用的应用程序，并且您有一些特定于领域的实体，这些实体必须仅对属于特定组织的用户可见。当你的应用被认为是一个刚起步的小应用时，将用户的所有个人数据保存在一个数据库中可能是一个好主意，但当它增长时，最好将每个组织的用户分开。有时，它还可以帮助以更公平的方式在组织之间分摊基础架构成本(组织拥有的用户越多，应该支付的成本就越多)。所有这些业务案例都应该提前考虑，并反映在架构决策中。或者，您应该为项目制定一个路线图，并根据项目的成功程度，从单租户架构迁移到多租户架构，查看所有迁移选项，并估计可能需要的工作量。</p><p id="40a0" class="pw-post-body-paragraph lg lh hi kd b ke li ij lj kg lk im ll ki lm ln lo kk lp lq lr km ls lt lu ko hb bi translated">此外，如果您的应用程序应该在不同的地区工作，如美国、欧洲，一些法律要求可能会强制您将用户存储在数据库中，该数据库实际上位于用户来自的特定地区(图1)。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mf"><img src="../Images/7f5642d67a4990ed5250f4f50723f228.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3A8XTisAWwZWO326CFsd5g.png"/></div></div><figcaption class="mg mh et er es mi mj bd b be z dx">Figure 1 — Reasons to apply multi-tenancy architecture</figcaption></figure><p id="dd85" class="pw-post-body-paragraph lg lh hi kd b ke li ij lj kg lk im ll ki lm ln lo kk lp lq lr km ls lt lu ko hb bi translated">Auth0提供了几种分离用户的方法:</p><ol class=""><li id="9ae3" class="kb kc hi kd b ke li kg lk ki mk kk ml km mm ko kp kq kr ks bi translated">Auth0允许<strong class="kd hj">在特殊属性</strong> <code class="du mn mo mp mq b">app_metadata</code>或<code class="du mn mo mp mq b">user_metadata</code>中存储与用户相关的任何应用程序属性，例如，您可以保存用户属于哪个组织。这些属性可以在用户创建期间通过Auth0 Dashboard或通过<a class="ae ky" href="https://auth0.com/docs/api/management/v2" rel="noopener ugc nofollow" target="_blank"> Auth0管理API </a>保存</li><li id="6d32" class="kb kc hi kd b ke kt kg ku ki kv kk kw km kx ko kp kq kr ks bi translated">Auth0允许<strong class="kd hj">在一个租户</strong>中创建多个连接，每个连接将用户存储在一个单独的数据库中。</li><li id="1cd6" class="kb kc hi kd b ke kt kg ku ki kv kk kw km kx ko kp kq kr ks bi translated">Auth0允许<strong class="kd hj">为每个组织</strong>创建多个租户，您可以选择哪个区域更适合您</li></ol><p id="f61c" class="pw-post-body-paragraph lg lh hi kd b ke li ij lj kg lk im ll ki lm ln lo kk lp lq lr km ls lt lu ko hb bi translated">我们将回顾每一个可用的选项，将会有一堆文章，每篇文章都致力于每一个选项。我们将考虑利弊，并深入了解每个选项的适用范围。</p><p id="823a" class="pw-post-body-paragraph lg lh hi kd b ke li ij lj kg lk im ll ki lm ln lo kk lp lq lr km ls lt lu ko hb bi translated">但是在进一步讨论之前，让我们将Auth0集成到用于单租户架构的React应用程序中。</p></div><div class="ab cl kz la gp lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="hb hc hd he hf"><h1 id="1283" class="jj jk hi bd jl jm mr jo jp jq ms js jt io mt ip jv ir mu is jx iu mv iv jz ka bi translated">设置授权0租户</h1><p id="5f5d" class="pw-post-body-paragraph lg lh hi kd b ke kf ij lj kg kh im ll ki mc ln lo kk md lq lr km me lt lu ko hb bi translated">如果您已经知道如何做，您可以跳过这一节，但它也将用于下一篇文章，至少是对这一节的快速回顾。</p><h2 id="4f49" class="mw jk hi bd jl mx my mz jp na nb nc jt ki nd ne jv kk nf ng jx km nh ni jz nj bi translated">租户创建</h2><p id="68e1" class="pw-post-body-paragraph lg lh hi kd b ke kf ij lj kg kh im ll ki mc ln lo kk md lq lr km me lt lu ko hb bi translated">在继续之前，我只是快速地跟随着您抛出创建租户的过程。一旦创建了您的Auth0帐户(它是免费的)，您需要创建第一个租户(图2)。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nk"><img src="../Images/2540df17170cb64512ef316833412abe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xu0_UJEtVVAvfrcmtoQP6Q.png"/></div></div><figcaption class="mg mh et er es mi mj bd b be z dx">Figure 2 — Tenant creation</figcaption></figure><p id="dd94" class="pw-post-body-paragraph lg lh hi kd b ke li ij lj kg lk im ll ki lm ln lo kk lp lq lr km ls lt lu ko hb bi translated">在这里，您需要提出一个租户域名，并根据您的法律要求选择所需的区域。</p><h2 id="5dc1" class="mw jk hi bd jl mx my mz jp na nb nc jt ki nd ne jv kk nf ng jx km nh ni jz nj bi translated">应用程序创建</h2><p id="975a" class="pw-post-body-paragraph lg lh hi kd b ke kf ij lj kg kh im ll ki mc ln lo kk md lq lr km me lt lu ko hb bi translated">我们将开发一个单页面应用程序，因此让我们为此创建一个应用程序:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nl"><img src="../Images/bc338c435a12fb612749123a105286ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fa2llQudmB15LXP3EomP4w.png"/></div></div><figcaption class="mg mh et er es mi mj bd b be z dx">Figure 3 — Application creation flow</figcaption></figure><p id="4938" class="pw-post-body-paragraph lg lh hi kd b ke li ij lj kg lk im ll ki lm ln lo kk lp lq lr km ls lt lu ko hb bi translated">将应用程序名称和应用程序类型定义为SPA:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nm"><img src="../Images/9224b07993a747cd68cf6d7f690822f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CO1jwZ4saCXmePEiTjCvSA.png"/></div></div><figcaption class="mg mh et er es mi mj bd b be z dx">Figure 4 — Create an Application for SPA</figcaption></figure><p id="1357" class="pw-post-body-paragraph lg lh hi kd b ke li ij lj kg lk im ll ki lm ln lo kk lp lq lr km ls lt lu ko hb bi translated">在<strong class="kd hj">设置</strong>选项卡中创建应用程序后，您将看到<strong class="kd hj"> <em class="lv">域</em> </strong>和<strong class="kd hj"> <em class="lv"> ClientID </em> </strong>，稍后我们将在React应用程序中使用它们:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nn"><img src="../Images/d0c1f6994ab91d15c55a6d4747ba3bf7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zcAJzX_NFTHuTtJoAqUvTw.png"/></div></div><figcaption class="mg mh et er es mi mj bd b be z dx">Figure 5 — Application settings</figcaption></figure><p id="04b9" class="pw-post-body-paragraph lg lh hi kd b ke li ij lj kg lk im ll ki lm ln lo kk lp lq lr km ls lt lu ko hb bi translated">在我们继续之前，我们需要完成应用程序设置并定义以下字段:<strong class="kd hj"> <em class="lv">允许回拨URL、允许注销URL、允许Web源</em> </strong>。我们将在本地开发React应用程序，它将在<code class="du mn mo mp mq b">http://localhost:3000</code>中运行，因此我们需要为所有提到的字段设置此URL:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es no"><img src="../Images/04c0f4a64ca335a4015847cda17e690c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mnYQwXEYo-kXCMogSfIXsA.png"/></div></div><figcaption class="mg mh et er es mi mj bd b be z dx">Figure 6 — Tenant redirect URI settings</figcaption></figure><p id="373f" class="pw-post-body-paragraph lg lh hi kd b ke li ij lj kg lk im ll ki lm ln lo kk lp lq lr km ls lt lu ko hb bi translated">我们现在完成了Auth0应用程序设置。</p><h1 id="173c" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">用于单租户架构的Auth0与Auth0集成</h1><p id="f4e8" class="pw-post-body-paragraph lg lh hi kd b ke kf ij lj kg kh im ll ki mc ln lo kk md lq lr km me lt lu ko hb bi translated">让我们用<code class="du mn mo mp mq b">create-react-app</code>搭建React应用程序，并安装由Auth0团队和<code class="du mn mo mp mq b">material-ui</code>开发的<a class="ae ky" href="https://www.npmjs.com/package/@auth0/auth0-react" rel="noopener ugc nofollow" target="_blank"> Auth0 React SDK </a>，作为所有必要组件的库:</p><pre class="iy iz ja jb fd np mq nq nr aw ns bi"><span id="5dcb" class="mw jk hi mq b fi nt nu l nv nw">npx create-react-app auth0-multitenancy --template typescript<br/>npm i -S @auth0/auth0-react <!-- -->@material-ui/core</span></pre><p id="a0d7" class="pw-post-body-paragraph lg lh hi kd b ke li ij lj kg lk im ll ki lm ln lo kk lp lq lr km ls lt lu ko hb bi translated">首先，让我们创建一个<code class="du mn mo mp mq b">Layout</code>组件，它使用<code class="du mn mo mp mq b">Logout</code>按钮为任意页面呈现任意内容的静态标题:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="nx ny l"/></div></figure><p id="0bfa" class="pw-post-body-paragraph lg lh hi kd b ke li ij lj kg lk im ll ki lm ln lo kk lp lq lr km ls lt lu ko hb bi translated">之后，让我们实现一个页面来呈现用户的个人信息:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="nx ny l"/></div></figure><p id="4e91" class="pw-post-body-paragraph lg lh hi kd b ke li ij lj kg lk im ll ki lm ln lo kk lp lq lr km ls lt lu ko hb bi translated">最后，将该页面放入<code class="du mn mo mp mq b">App.tsx</code>组件，并用Auth0库中的<code class="du mn mo mp mq b">Auth0Provider</code>进行包装:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="nx ny l"/></div></figure><p id="36b5" class="pw-post-body-paragraph lg lh hi kd b ke li ij lj kg lk im ll ki lm ln lo kk lp lq lr km ls lt lu ko hb bi translated">请注意，我们用<code class="du mn mo mp mq b">withAuthenticationRequired</code>高阶组件(第5行)包装<code class="du mn mo mp mq b">IndexPage</code>、HOC(关于HOC模式的更多细节，您可以在这篇<a class="ae ky" href="https://enlear.academy/all-about-high-order-component-and-render-props-patterns-60bc2492548b" rel="noopener ugc nofollow" target="_blank">文章</a>中查看)，并且该页面仅对授权用户可见，否则，用户将被重定向到Auth0服务器的通用登录页面。在运行应用程序之前，确保在<code class="du mn mo mp mq b">.env</code>文件中定义了图5中的两个变量:</p><pre class="iy iz ja jb fd np mq nq nr aw ns bi"><span id="30c9" class="mw jk hi mq b fi nt nu l nv nw">REACT_APP_AUTH0_DOMAIN=YOUR_DOMAIN_NAME<br/>REACT_APP_AUTH0_CLIENT_ID=YOUR_CLIENT_ID</span></pre><blockquote class="lw lx ly"><p id="3493" class="lg lh lv kd b ke li ij lj kg lk im ll lz lm ln lo ma lp lq lr mb ls lt lu ko hb bi translated">你可以在<strong class="kd hj"><em class="hi"/></strong>分支的<a class="ae ky" href="https://github.com/vladimirtopolev/auth0-multi-tenancy" rel="noopener ugc nofollow" target="_blank">回购</a>中找到完整的代码。</p></blockquote><p id="ce3e" class="pw-post-body-paragraph lg lh hi kd b ke li ij lj kg lk im ll ki lm ln lo kk lp lq lr km ls lt lu ko hb bi translated">让我们通过Auth0 Dashboard创建第一个用户。进入<strong class="kd hj">用户管理/用户</strong>选项卡，在此创建一个用户，设置电子邮件和密码:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nz"><img src="../Images/fe077edee787d918d9060709cd676b85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N2z4oNbS83AUAG2zDhZaAw.png"/></div></div></figure><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es oa"><img src="../Images/b45352d2c4877bdbd8cb4436feb6e9c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9_RDHL9LqArLCUe73qfDsQ.png"/></div></div></figure><p id="8037" class="pw-post-body-paragraph lg lh hi kd b ke li ij lj kg lk im ll ki lm ln lo kk lp lq lr km ls lt lu ko hb bi translated">在应用程序运行之后，当您转到<code class="du mn mo mp mq b">localhost:3000</code> URL时，应用程序会将您重定向到Auth0通用登录页面。填写电子邮件和密码后，您将看到此页面:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ob"><img src="../Images/69e8f64844f4fd15bc5cc82b5ab06be5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5Se17epaOToQKxygyFg11w.png"/></div></div></figure></div></div>    
</body>
</html>