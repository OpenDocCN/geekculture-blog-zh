<html>
<head>
<title>How to: Display Client’s Local Time in Your Elixir/Phoenix App (1.6+)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何:在您的Elixir/Phoenix应用程序(1.6以上)中显示客户端的当地时间</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/how-to-display-clients-local-time-in-your-elixir-phoenix-app-1-6-fea924222baa?source=collection_archive---------9-----------------------#2021-11-22">https://medium.com/geekculture/how-to-display-clients-local-time-in-your-elixir-phoenix-app-1-6-fea924222baa?source=collection_archive---------9-----------------------#2021-11-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/f50be4e83d4963770eb64973f80fb7a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WrcyjY5mewRHf3Hgwk3Vfg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Undraw’s time management</figcaption></figure><h1 id="d763" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">背景</h1><p id="c04e" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">随着我们走向2021年底，我一直在推动将首批几个早期访问邀请代码发送给那些注册了变形早期访问发布的人——这样做，我想找到一种快速而简单的方法来显示某人的当前时间，无论他们在世界的哪个地方。</p><blockquote class="kq kr ks"><p id="2198" class="js jt kt ju b jv ku jx jy jz kv kb kc kw kx kf kg ky kz kj kk la lb kn ko kp hb bi translated">对于那些刚刚收听的人来说，<a class="ae lc" href="https://metamorphic.app" rel="noopener ugc nofollow" target="_blank">变形</a>改变了我们在线联系和分享的方式。我设计它的时候，考虑到了我的家庭，提供了一个安全、有趣、简单的联系和分享的方式；同时与监控资本主义的破坏性力量绝缘，监控资本主义是主要社交网络、视频聊天和搜索公司的动力和驱动力。</p></blockquote><p id="9f7f" class="pw-post-body-paragraph js jt hi ju b jv ku jx jy jz kv kb kc kd kx kf kg kh kz kj kk kl lb kn ko kp hb bi translated">通常，在开发中显示本地时间非常容易，因为您的“服务器”和“客户机”(您和您的计算机)在同一个位置。然而，在生产中，由于客户机不再位于服务器所在的位置，这往往会变得更加复杂。</p><p id="b5e9" class="pw-post-body-paragraph js jt hi ju b jv ku jx jy jz kv kb kc kd kx kf kg kh kz kj kk kl lb kn ko kp hb bi translated">任何使用<em class="kt">时间</em>的人，或者作为一名开发者，都知道<em class="kt">时间</em>是一个极其复杂的编程<em class="kt"> </em>概念(问题、哲学等)。).我们不会进入那些本质的细节，谢天谢地，我们可以依靠精彩的库来为我们做这些工作。</p><p id="1f6b" class="pw-post-body-paragraph js jt hi ju b jv ku jx jy jz kv kb kc kd kx kf kg kh kz kj kk kl lb kn ko kp hb bi translated">但是，即使有了这些出色的库，用客户的当地时区显示他们的时间在生产中仍然很复杂。</p><p id="9ccb" class="pw-post-body-paragraph js jt hi ju b jv ku jx jy jz kv kb kc kd kx kf kg kh kz kj kk kl lb kn ko kp hb bi translated">所以，我将向你展示我用变形做这件事的快速简单的方法。</p><h1 id="6c99" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">先决条件</h1><p id="3d3b" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">在这篇文章中，我们将做如下假设:</p><ul class=""><li id="b482" class="ld le hi ju b jv ku jz kv kd lf kh lg kl lh kp li lj lk ll bi translated">你有一个<a class="ae lc" href="https://phoenixframework.org" rel="noopener ugc nofollow" target="_blank"> Phoenix </a>的应用程序启动并运行(1.6以上)</li><li id="a7c2" class="ld le hi ju b jv lm jz ln kd lo kh lp kl lq kp li lj lk ll bi translated">你有17.5以上的凤凰城直播</li><li id="cceb" class="ld le hi ju b jv lm jz ln kd lo kh lp kl lq kp li lj lk ll bi translated">你有仙丹1.12+和OTP 24+</li><li id="8900" class="ld le hi ju b jv lm jz ln kd lo kh lp kl lq kp li lj lk ll bi translated">您已经安装了<a class="ae lc" href="https://hex.pm/packages/timex" rel="noopener ugc nofollow" target="_blank"> Timex </a>库(或者了解如何在Elixir或另一个库中使用等效的时间相关函数)</li></ul><p id="25bb" class="pw-post-body-paragraph js jt hi ju b jv ku jx jy jz kv kb kc kd kx kf kg kh kz kj kk kl lb kn ko kp hb bi translated">好吧，我们开始吧。</p><h1 id="6307" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">方法</h1><p id="855e" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">假设我们有一个登录用户的仪表板或主页，在这个页面上，我们向他们显示当地时区的实时时钟。</p><p id="512d" class="pw-post-body-paragraph js jt hi ju b jv ku jx jy jz kv kb kc kd kx kf kg kh kz kj kk kl lb kn ko kp hb bi translated">有很多不同的方法可以做到这一点，但是假设我们不想用任何细节来打扰他们，我们也不想在数据库中保存人们的时区(为了隐私或简单起见)。</p><p id="361a" class="pw-post-body-paragraph js jt hi ju b jv ku jx jy jz kv kb kc kd kx kf kg kh kz kj kk kl lb kn ko kp hb bi translated">为了实现这一点，我们将利用Phoenix LiveView令人难以置信的<a class="ae lc" href="https://hexdocs.pm/phoenix_live_view/Phoenix.LiveView.html#on_mount/1" rel="noopener ugc nofollow" target="_blank"> on_mount/1 </a>和<a class="ae lc" href="https://hexdocs.pm/phoenix_live_view/Phoenix.LiveView.html#attach_hook/4" rel="noopener ugc nofollow" target="_blank"> attach_hook/4 </a>函数，通过一个简单的JavaScript钩子获取客户端的本地时区，并在挂载LiveView页面时将其分配给我们的socket。</p><p id="9bdb" class="pw-post-body-paragraph js jt hi ju b jv ku jx jy jz kv kb kc kd kx kf kg kh kz kj kk kl lb kn ko kp hb bi translated">我们走吧。</p><h1 id="6cc2" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">第一步</h1><p id="0c3d" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">首先，让我们创建我们的<code class="du lr ls lt lu b">on_mount/4</code>函数，我们将用我们的<code class="du lr ls lt lu b">on_mount/1</code>回调函数调用它(我们正在定义我们的<code class="du lr ls lt lu b">on_mount/1</code>回调钩子将如何工作):</p><pre class="lv lw lx ly fd lz lu ma mb aw mc bi"><span id="b8fe" class="md iv hi lu b fi me mf l mg mh"># your_app_web/hooks/local_time_zone_hook.ex<br/># You can organize your code however you like.</span><span id="2862" class="md iv hi lu b fi mi mf l mg mh">defmodule YourAppWeb.Hooks.LocalTimeZoneHook do<br/>  @moduledoc false<br/>  import Phoenix.LiveView<br/>  <br/>  def on_mount(:default, _params, _session, socket) do<br/>    {:cont,<br/>      socket<br/>      |&gt; attach_hook(:local_tz, :handle_event, fn<br/>        "local-timezone", %{"local-timezone" =&gt; local_timezone},<br/>          socket -&gt;<br/>            # Handle our "local-timezone" event and detach hook<br/>            socket =<br/>              socket<br/>              |&gt; assign(:local_timezone, local_timezone)<br/>            {:halt, detach_hook(socket, :local_tz, :handle_event)}</span><span id="5beb" class="md iv hi lu b fi mi mf l mg mh">        _event, _params, socket -&gt;<br/>          {:cont, socket}<br/>      end)<br/>    }<br/>  end<br/>end</span></pre><p id="d4a4" class="pw-post-body-paragraph js jt hi ju b jv ku jx jy jz kv kb kc kd kx kf kg kh kz kj kk kl lb kn ko kp hb bi translated">好的，本质上我们所做的是在我们的<code class="du lr ls lt lu b">on_mount/4</code>回调中调用<code class="du lr ls lt lu b">attach_hook/4</code>，我们稍后将调用我们的<code class="du lr ls lt lu b">on_mount/1</code>来挂钩到我们的LiveView的挂载过程。</p><p id="f652" class="pw-post-body-paragraph js jt hi ju b jv ku jx jy jz kv kb kc kd kx kf kg kh kz kj kk kl lb kn ko kp hb bi translated">我们附加的钩子叫做<code class="du lr ls lt lu b">local_tz</code>(或者在我们的JavaScript文件中叫做<code class="du lr ls lt lu b">LocalTz</code>)。</p><p id="19b9" class="pw-post-body-paragraph js jt hi ju b jv ku jx jy jz kv kb kc kd kx kf kg kh kz kj kk kl lb kn ko kp hb bi translated">在不太了解我们的钩子的情况下，我们已经知道它将发送一个名为“local-timezone”的事件，我们将对该事件进行模式匹配，并将其作为<code class="du lr ls lt lu b">local_timezone</code>分配给我们的套接字。</p><p id="ca4e" class="pw-post-body-paragraph js jt hi ju b jv ku jx jy jz kv kb kc kd kx kf kg kh kz kj kk kl lb kn ko kp hb bi translated">现在让我们编写JavaScript钩子。</p><h1 id="8392" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">第二步</h1><p id="92b8" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">为了简单起见，我们将在我们的<code class="du lr ls lt lu b">app.js</code>文件中编写我们的钩子，但是您可以组织您的代码来满足您的应用程序的需要。</p><p id="963f" class="pw-post-body-paragraph js jt hi ju b jv ku jx jy jz kv kb kc kd kx kf kg kh kz kj kk kl lb kn ko kp hb bi translated">在您的<code class="du lr ls lt lu b">app.js</code>中，您应该已经有了这样的内容:</p><pre class="lv lw lx ly fd lz lu ma mb aw mc bi"><span id="c05b" class="md iv hi lu b fi me mf l mg mh"># your_app_web/assets/js/app.js</span><span id="e2e1" class="md iv hi lu b fi mi mf l mg mh">...<br/>let liveSocket = new LiveSocket('/live', Socket, {<br/>  hooks: Hooks,<br/>  ...</span></pre><p id="bb07" class="pw-post-body-paragraph js jt hi ju b jv ku jx jy jz kv kb kc kd kx kf kg kh kz kj kk kl lb kn ko kp hb bi translated">这一行连接了我们编写的任何JavaScript挂钩，并将它们添加到我们的套接字中。</p><p id="f5f8" class="pw-post-body-paragraph js jt hi ju b jv ku jx jy jz kv kb kc kd kx kf kg kh kz kj kk kl lb kn ko kp hb bi translated">因此，在此之上，让我们添加我们的<code class="du lr ls lt lu b">LocalTz</code>钩子:</p><pre class="lv lw lx ly fd lz lu ma mb aw mc bi"><span id="4f22" class="md iv hi lu b fi me mf l mg mh"># your_app_web/assets/js/app.js</span><span id="4efe" class="md iv hi lu b fi mi mf l mg mh">...<br/>Hooks.LocalTz = {<br/>  mounted() {<br/>    let localTz =<br/>      Intl.DateTimeFormat().resolvedOptions().timeZone<br/>    this.pushEvent("local-timezone", {local_timezone: localTz})<br/>  }<br/>}</span><span id="e98f" class="md iv hi lu b fi mi mf l mg mh">let liveSocket = ...</span></pre><p id="4286" class="pw-post-body-paragraph js jt hi ju b jv ku jx jy jz kv kb kc kd kx kf kg kh kz kj kk kl lb kn ko kp hb bi translated">这就是我们的钩子！</p><p id="a01a" class="pw-post-body-paragraph js jt hi ju b jv ku jx jy jz kv kb kc kd kx kf kg kh kz kj kk kl lb kn ko kp hb bi translated">如您所见，我们使用了一些很棒的JavaScript来(1)获取客户端的本地时区，(2)将其分配给<code class="du lr ls lt lu b">localTz</code>，以及(3)向服务器发送一个名为“local-timezone”的事件，其中包含我们想要的相关数据。</p><p id="d0bf" class="pw-post-body-paragraph js jt hi ju b jv ku jx jy jz kv kb kc kd kx kf kg kh kz kj kk kl lb kn ko kp hb bi translated">完成后，我们可以进入最后一步。</p><h1 id="7fa2" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">第三步</h1><p id="ee13" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">在最后一步中，我们将处理事件并启用我们的实时时钟。根据您的应用程序的需求，有很大的定制和扩展空间(这里我们不会深入讨论)。</p><p id="6d2c" class="pw-post-body-paragraph js jt hi ju b jv ku jx jy jz kv kb kc kd kx kf kg kh kz kj kk kl lb kn ko kp hb bi translated">我们需要做的是用<code class="du lr ls lt lu b">on_mount/1</code>函数调用我们的钩子，连接我们的时钟，并显示我们的时钟(我们假设您有身份验证或您的应用程序需要的任何东西)。</p><p id="f481" class="pw-post-body-paragraph js jt hi ju b jv ku jx jy jz kv kb kc kd kx kf kg kh kz kj kk kl lb kn ko kp hb bi translated">让我们来看看:</p><figure class="lv lw lx ly fd ij"><div class="bz dy l di"><div class="mj mk l"/></div><figcaption class="iq ir et er es is it bd b be z dx">your_app_web/dashboard_live/index.ex</figcaption></figure><p id="d08f" class="pw-post-body-paragraph js jt hi ju b jv ku jx jy jz kv kb kc kd kx kf kg kh kz kj kk kl lb kn ko kp hb bi translated">这是怎么回事？</p><p id="f633" class="pw-post-body-paragraph js jt hi ju b jv ku jx jy jz kv kb kc kd kx kf kg kh kz kj kk kl lb kn ko kp hb bi translated">在第5行，我们使用<code class="du lr ls lt lu b">on_mount/1</code>回调来调用我们的钩子，并将客户端的本地时区弹出到我们的socket上的assign中。现在，这并不一定会超过我们其余的mount函数，所以我们开始我们的<code class="du lr ls lt lu b">@date</code>赋值，而不参考客户机的本地时区。</p><p id="2bb7" class="pw-post-body-paragraph js jt hi ju b jv ku jx jy jz kv kb kc kd kx kf kg kh kz kj kk kl lb kn ko kp hb bi translated">然后，如果套接字连接，我们开始每秒向自己发送一条消息，并更新我们的时钟:<code class="du lr ls lt lu b">Process.send_after(self(), :tick, 1000)</code>。我们在第41行的<code class="du lr ls lt lu b">handle_info/2</code>函数中处理它(在该函数中，我们再次向自己发送消息，以创建时钟的循环“循环”或“滴答”)。最后，在我们的<code class="du lr ls lt lu b">handle_info/2</code>结束之前，我们调用我们的<code class="du lr ls lt lu b">put_date/1</code>函数，它只是更新我们的<code class="du lr ls lt lu b">@date</code>赋值。</p><p id="2c77" class="pw-post-body-paragraph js jt hi ju b jv ku jx jy jz kv kb kc kd kx kf kg kh kz kj kk kl lb kn ko kp hb bi translated">需要特别注意的是，现在，在我们的<code class="du lr ls lt lu b">put_date/1</code>函数中，我们可以调用<code class="du lr ls lt lu b">Timex.now(socket.assigns.local_timezone)</code>，我们将从客户端插入本地时区，我们的钩子在<code class="du lr ls lt lu b">local_timezone</code> assign下为我们将该时区放入套接字。</p><p id="8d00" class="pw-post-body-paragraph js jt hi ju b jv ku jx jy jz kv kb kc kd kx kf kg kh kz kj kk kl lb kn ko kp hb bi translated">最后，由于我们使用的是<code class="du lr ls lt lu b">phx-hook</code>，我们需要确保在HTML、<code class="du lr ls lt lu b">id="local-timezone"</code>和<code class="du lr ls lt lu b">phx-hook="LocalTimeZone"</code>中分配一个惟一的DOM id。</p><h1 id="c6f2" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">奖金(第6步)</h1><p id="ee51" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">现在，在初始安装和我们时钟的第一次“滴答”之间很可能有一点延迟(所以在时钟切换到客户机的本地时间之前，您会看到一会儿UTC时间)。</p><p id="5abe" class="pw-post-body-paragraph js jt hi ju b jv ku jx jy jz kv kb kc kd kx kf kg kh kz kj kk kl lb kn ko kp hb bi translated">因此，让我们稍微修改一下，为改进UX打下基础:</p><figure class="lv lw lx ly fd ij"><div class="bz dy l di"><div class="mj mk l"/></div></figure><p id="c7ae" class="pw-post-body-paragraph js jt hi ju b jv ku jx jy jz kv kb kc kd kx kf kg kh kz kj kk kl lb kn ko kp hb bi translated">不错！让我们看看我们改变了什么:</p><ul class=""><li id="c74a" class="ld le hi ju b jv ku jz kv kd lf kh lg kl lh kp li lj lk ll bi translated"><code class="du lr ls lt lu b">assign(:timezone_loaded, false)</code> —在第17行，我们用一个标志替换了我们的<code class="du lr ls lt lu b">@date</code>赋值，以表明我们是否已经加载了客户端的本地时区信息。</li><li id="71d1" class="ld le hi ju b jv lm jz ln kd lo kh lp kl lq kp li lj lk ll bi translated"><code class="du lr ls lt lu b">lines 28 — 32</code> —这里，我们在HTML中添加了一个简单的<code class="du lr ls lt lu b">if else</code>块，用于显示加载客户端本地时区前后的信息。</li><li id="1c17" class="ld le hi ju b jv lm jz ln kd lo kh lp kl lq kp li lj lk ll bi translated"><code class="du lr ls lt lu b">maybe_update_assigns_for_clock(socket)</code> —在第47行，我们在<code class="du lr ls lt lu b">handle_info/2</code>回调中调用了一个新的<code class="du lr ls lt lu b">maybe_update_assigns_for_clock/1</code>函数，以便在本地时区信息从我们的钩子中加载后更新我们的套接字。</li><li id="b17a" class="ld le hi ju b jv lm jz ln kd lo kh lp kl lq kp li lj lk ll bi translated"><code class="du lr ls lt lu b">maybe_update_assigns_for_clock/1</code> —在第50–61行，我们实现了一个简单的<code class="du lr ls lt lu b">if else do end</code>块，在这里我们检查<code class="du lr ls lt lu b">:date</code>键的<code class="du lr ls lt lu b">socket.assigns</code>图并相应地继续。这个函数的两个分支都通过调用我们现有的<code class="du lr ls lt lu b">put_date/1</code>函数来确保我们的时钟继续运行。</li></ul><p id="6a72" class="pw-post-body-paragraph js jt hi ju b jv ku jx jy jz kv kb kc kd kx kf kg kh kz kj kk kl lb kn ko kp hb bi translated">这样，在加载本地时区信息之前，我们已经用加载消息代替了查看UTC时间。您可以在此基础上进行扩展，根据应用程序的需求改进和进一步定制UX。</p><h1 id="4d0b" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">结论</h1><p id="e1cc" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">我们完事了。只需几行简单的JavaScript代码和Phoenix LiveView的新<code class="du lr ls lt lu b">on_mount/1</code>功能，我们就可以轻松显示每个客户所在时区的时间。</p><p id="cec2" class="pw-post-body-paragraph js jt hi ju b jv ku jx jy jz kv kb kc kd kx kf kg kh kz kj kk kl lb kn ko kp hb bi translated">感谢您的关注，如果您正在为如何处理客户的当地时间而绞尽脑汁，我希望这能帮助您，或者激励您创建更棒的东西。</p><blockquote class="kq kr ks"><p id="83a2" class="js jt kt ju b jv ku jx jy jz kv kb kc kw kx kf kg ky kz kj kk la lb kn ko kp hb bi translated"><em class="hi">如果你有兴趣了解更多关于</em>变形<em class="hi">的信息，那么就跟随我们的公司</em> <a class="ae lc" href="https://metamorphic.transistor.fm" rel="noopener ugc nofollow" target="_blank"> <em class="hi">播客</em> </a> <em class="hi">和</em> <a class="ae lc" href="https://metamorphic.app" rel="noopener ugc nofollow" target="_blank"> <em class="hi">报名参加邀请码</em> </a> <em class="hi">来我们的早期接入发布吧——我们的网络生活即将迎来一场变革！</em></p></blockquote><p id="7188" class="pw-post-body-paragraph js jt hi ju b jv ku jx jy jz kv kb kc kd kx kf kg kh kz kj kk kl lb kn ko kp hb bi translated">永远欢迎改进和想法，谢谢！</p><p id="5fdf" class="pw-post-body-paragraph js jt hi ju b jv ku jx jy jz kv kb kc kd kx kf kg kh kz kj kk kl lb kn ko kp hb bi translated">💚标记</p></div></div>    
</body>
</html>