<html>
<head>
<title>Automate Your GCP VM Instance Program</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">自动化您的GCP虚拟机实例程序</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/automate-your-gcp-vm-instance-program-fda3a5e66bfa?source=collection_archive---------3-----------------------#2022-07-03">https://medium.com/geekculture/automate-your-gcp-vm-instance-program-fda3a5e66bfa?source=collection_archive---------3-----------------------#2022-07-03</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="19d2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您有任何位于Google Cloud的VM实例中的脚本需要在每天/每周/每月的特定时间运行，并且这是一个非常长时间运行的过程(例如，用于机器学习模型训练的数据管道、数据爬虫等)。)，那么本文将指导您实现任务的自动化。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/a86171bde5d0deafd9617345a773c408.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4ZxsZYc3CWAMAewb"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Photo by <a class="ae jt" href="https://unsplash.com/@agk42?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Alex Knight</a> on <a class="ae jt" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h2 id="19ab" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">问题场景</h2><p id="72b4" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">您的脚本/程序可以使用任何语言，但是为了简单起见，让我们假设我们正在尝试自动化Python脚本。</p><p id="5f74" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">比方说，你正在做谷歌计算引擎的虚拟机实例。你有一个Python脚本<code class="du ku kv kw kx b">main.py</code>，它执行一些特定的任务(例如，从多个站点收集数据，训练机器学习模型等。).您需要在每周五的12:00 AM执行相同的任务(运行脚本),然后您有几个选项来自动执行这个过程。</p><ol class=""><li id="e1c5" class="ky kz hi ih b ii ij im in iq la iu lb iy lc jc ld le lf lg bi translated">对发布/订阅主题使用云函数。</li><li id="3e6a" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc ld le lf lg bi translated">在VM实例中添加一个<code class="du ku kv kw kx b">startup-script</code>来自动运行程序。</li></ol><p id="1a69" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如上所述，本文主要关注长期运行的流程；我将解释如何解决长时间运行的流程。如果你的工作时间少于540秒，你可以考虑第一个选项。否则，最好采用第二种方法。第一个选项不适用于长时间运行的流程，因为谷歌云功能最多可以运行940秒。</p><p id="e1f1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是，什么是“启动脚本”？</p><blockquote class="lm ln lo"><p id="17e7" class="if ig lp ih b ii ij ik il im in io ip lq ir is it lr iv iw ix ls iz ja jb jc hb bi translated">启动脚本是在虚拟机(VM)实例的启动过程中执行任务的文件。启动脚本可以应用于项目中的所有虚拟机，也可以应用于单个VM⁴.</p></blockquote><h2 id="f9dc" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">配置虚拟机实例和环境</h2><p id="61b5" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">如果您尝试向VM实例添加一个<code class="du ku kv kw kx b">startup-script</code>，您的启动脚本将在<code class="du ku kv kw kx b">root</code>用户模式下运行。</p><p id="da44" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当您使用SSH连接将VM实例远程连接到本地机器时，您将以不同于root模式的用户身份登录。您可以通过以下命令进入root用户模式:</p><pre class="je jf jg jh fd lt kx lu lv aw lw bi"><span id="7c7d" class="ju jv hi kx b fi lx ly l lz ma">$ sudo su -</span></pre><p id="34f0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该命令将带您进入根用户模式。您将不会在root模式下找到您的编码资源，您可能在通过SSH将VM实例连接到您的本地机器时使用它。所以，我建议维护一个git repo来维护你的代码，并在root用户中克隆git repo。您还应该将程序依赖项安装到root用户中。例如，如果您的程序运行在Anaconda虚拟环境中，那么在root用户中安装Anaconda。通过登录到根用户模式，确保您可以正确运行您的程序。假设您可以在虚拟环境中通过以下命令完美地运行您的程序:</p><pre class="je jf jg jh fd lt kx lu lv aw lw bi"><span id="691d" class="ju jv hi kx b fi lx ly l lz ma">$ python main.py</span></pre><p id="e935" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您的虚拟机中可能存在不同的python解释器。只要确定您正在使用哪个python解释器来运行您的程序，您就可以在终端中运行以下命令来查看您正在使用哪个解释器。如果您在虚拟环境中工作，那么激活它，并运行以下命令。</p><pre class="je jf jg jh fd lt kx lu lv aw lw bi"><span id="5d3f" class="ju jv hi kx b fi lx ly l lz ma">$ which python</span></pre><p id="1fd5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将为您的python解释器提供路径，如<code class="du ku kv kw kx b">usr/bin/python3</code>。</p><h2 id="2581" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">启动脚本</h2><p id="9bd7" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">要在实例中附加一个<code class="du ku kv kw kx b">startup-script</code>，请转到<em class="lp">计算引擎&gt;虚拟机实例</em>页面。然后单击您的目标虚拟机实例。现在，编辑实例。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mb"><img src="../Images/a18aeff4b2c6fed48d9d95bd6479aec7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FvhE2RQ8SzhijRCGumeahw.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Screenshot 1: VM instance page</figcaption></figure><p id="517c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">点击编辑。之后，向下滚动页面，你会发现一个叫做“元数据”的部分。在那里，在自动化部分下，您可以添加您的<code class="du ku kv kw kx b">startup-script</code>。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es mc"><img src="../Images/3d7150c03c5f3db53d5a4947726bcfff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1354/format:webp/1*N9bEO7ZH__YCOEG4jpdpwg.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx">Screenshot 2: Startup-script section</figcaption></figure><p id="283a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如:假设我们的驱动代码存在于<code class="du ku kv kw kx b">/root/data_pipeline/src/main.py</code>文件中。所以，为了在VM启动时自动运行程序，我们可以编写下面的<code class="du ku kv kw kx b">startup-script</code>。</p><pre class="je jf jg jh fd lt kx lu lv aw lw bi"><span id="ed57" class="ju jv hi kx b fi lx ly l lz ma">#! /bin/bash<br/><br/>/usr/bin/python3 /root/data_pipeline/src/main.py</span></pre><p id="1446" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们希望运行程序保持运行，没有任何形式的中断，即使其他一些虚拟机和主GCP项目中的配置发生了变化。为了不间断地运行程序，我们应该启用<code class="du ku kv kw kx b">shielded-learn-integrity-policy</code>策略。为此，我们可以在调用<code class="du ku kv kw kx b">main.py</code>脚本之前添加以下命令。</p><pre class="je jf jg jh fd lt kx lu lv aw lw bi"><span id="0a9f" class="ju jv hi kx b fi lx ly l lz ma">#! /bin/bash</span><span id="aeff" class="ju jv hi kx b fi md ly l lz ma">gcloud compute instances update &lt;instance-name&gt; --zone &lt;instance-zone-name&gt; --shielded-learn-integrity-policy</span><span id="5d10" class="ju jv hi kx b fi md ly l lz ma">/usr/bin/python3 /root/data_pipeline/src/main.py</span></pre><p id="a49b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当<code class="du ku kv kw kx b">main.py</code>程序执行完成时，我们希望我们的VM实例自动停止。为此，我们可以在<code class="du ku kv kw kx b">startup-script</code>的末尾添加以下命令:</p><pre class="je jf jg jh fd lt kx lu lv aw lw bi"><span id="9362" class="ju jv hi kx b fi lx ly l lz ma">#! /bin/bash</span><span id="280d" class="ju jv hi kx b fi md ly l lz ma">gcloud compute instances update &lt;your-instance-name&gt; --zone &lt;instance-zone-name&gt; --shielded-learn-integrity-policy</span><span id="8860" class="ju jv hi kx b fi md ly l lz ma">/usr/bin/python3 /root/data_pipeline/src/main.py</span><span id="184e" class="ju jv hi kx b fi md ly l lz ma">gcloud compute instances stop &lt;your-instance-name&gt; --zone &lt;instance-zone-name&gt;</span></pre><p id="90b6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您也可以根据需要在<code class="du ku kv kw kx b">startup-script</code>中添加其他命令。例如:</p><pre class="je jf jg jh fd lt kx lu lv aw lw bi"><span id="20bc" class="ju jv hi kx b fi lx ly l lz ma">#! /bin/bash</span><span id="0f47" class="ju jv hi kx b fi md ly l lz ma">sudo service tor restart</span><span id="73e4" class="ju jv hi kx b fi md ly l lz ma">gcloud compute instances update &lt;your-instance-name&gt; --zone &lt;instance-zone-name&gt; --shielded-learn-integrity-policy</span><span id="dcdb" class="ju jv hi kx b fi md ly l lz ma">ulimit -n 100000</span><span id="d0e1" class="ju jv hi kx b fi md ly l lz ma">/usr/bin/python3 /root/data_pipeline/src/main.py</span><span id="e77c" class="ju jv hi kx b fi md ly l lz ma">gcloud compute instances stop &lt;your-instance-name&gt; --zone &lt;instance-zone-name&gt;</span></pre><p id="e4ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面的脚本让我们的程序在VM实例启动时自动执行，并在程序执行完成后停止VM实例。</p><p id="3db4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们需要安排实例自动启动VM实例。</p><h2 id="f67e" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">调度虚拟机实例</h2><p id="02cc" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">转到<em class="lp">导航菜单&gt;计算引擎&gt;虚拟机实例</em>页面。有一段叫<code class="du ku kv kw kx b">INSTANCE SCHEDULES</code>。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es me"><img src="../Images/a543adb52e20a4546d739ee8960c6c7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MTFaMPwNxKtRWaPjgATa0A.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Screenshot 3: Instance Schedules page on GCP UI</figcaption></figure><p id="f31a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">去那个选项卡。现在，您会在顶栏中找到一个名为<code class="du ku kv kw kx b">CREATE SCHEDULE</code>的部分</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mf"><img src="../Images/324a398397e8023f5df8958cb6fc05c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KqPsutTeTys9glxVpAMKTQ.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Screenshot 4: Create Schedules page on GCP UI</figcaption></figure><p id="55c4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您单击创建时间表，您将看到如下页面:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es mg"><img src="../Images/c7865f651c420a52af3bc3239d4602fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1148/format:webp/1*--24Ekwmb9dRJDiHcorv2w.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx">Screenshot 5: Scheduler form to submit</figcaption></figure><p id="9afa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你想取什么名字都行。区域面积必须与虚拟机实例的区域相匹配。定义一个<strong class="ih hj">开始时间</strong>和<strong class="ih hj">频率</strong>(如每日/每周/每月等。).您不需要定义任何<strong class="ih hj">停止时间，</strong>，因为我们已经有了一个在<code class="du ku kv kw kx b">main.py</code>程序在<code class="du ku kv kw kx b">startup-script</code>中结束执行后自动停止实例的命令。</p><p id="35c4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您还可以使用CRON表达式来定义实例的开始时间。最后，提交页面。这将创建一个调度程序页面。转到该页面，您会发现在其中添加实例的选项。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mh"><img src="../Images/b09b24027c932cc5343bd5f269f5c0d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G03mxOpN5t9ePboH9Gi2FA.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Screenshot 6: Adding your instance to schedulerScreenshot 1</figcaption></figure><p id="29ab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">只需将目标实例添加到其中，就大功告成了。</p><p id="8186" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将允许您的实例在预定页面上您定义的开始时间自动启动，从<code class="du ku kv kw kx b">startup-script</code>调用<code class="du ku kv kw kx b">main.py</code>文件，在程序完成执行后，VM实例将自动关闭。</p></div><div class="ab cl mi mj gp mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="hb hc hd he hf"><h2 id="e0aa" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">参考</h2><p id="5ea8" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">[1].【https://cloud.google.com/functions/quotas】<a class="ae jt" href="https://cloud.google.com/functions/quotas" rel="noopener ugc nofollow" target="_blank"><br/>【2】。</a><a class="ae jt" href="https://cloud.google.com/compute/docs/instances/startup-scripts/linux" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/compute/docs/instances/startup-scripts/Linux</a><br/>[3]。<a class="ae jt" href="https://cloud.google.com/compute/shielded-vm/docs/integrity-monitoring#updating-baseline" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/compute/shielded-VM/docs/integrity-monitoring # updating-baseline</a>T10【4】。<a class="ae jt" href="https://cloud.google.com/compute/docs/instances/startup-scripts/" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/compute/docs/instances/startup-scripts/</a></p><p id="c473" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">作者</strong></p><div class="mp mq ez fb mr ms"><a href="https://www.linkedin.com/in/sksoumik/" rel="noopener  ugc nofollow" target="_blank"><div class="mt ab dw"><div class="mu ab mv cl cj mw"><h2 class="bd hj fi z dy mx ea eb my ed ef hh bi translated">Sadman Kabir Soumik -人工智能工程师- Venturas Ltd | LinkedIn</h2><div class="mz l"><h3 class="bd b fi z dy mx ea eb my ed ef dx translated">三年行业经验，八年动手编程经验的AI/ML工程师。在过去…</h3></div><div class="na l"><p class="bd b fp z dy mx ea eb my ed ef dx translated">www.linkedin.com</p></div></div><div class="nb l"><div class="nc l nd ne nf nb ng jn ms"/></div></div></a></div></div></div>    
</body>
</html>