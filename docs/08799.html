<html>
<head>
<title>React — Uncouples, injects and reverses dependencies</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">反应——分离、注入和逆转依赖关系</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/react-uncouples-injects-and-reverses-dependencies-2103cfd0341f?source=collection_archive---------23-----------------------#2021-11-14">https://medium.com/geekculture/react-uncouples-injects-and-reverses-dependencies-2103cfd0341f?source=collection_archive---------23-----------------------#2021-11-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/ed0885395d355f44af4ac04d87b3aa73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a-cCDZPv7-f-HsI7cSGT3w.png"/></div></div></figure><p id="b583" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">其思想是使用上下文、服务和存储库，对react中的依赖性进行解耦、注入和反转。</p><p id="c2c4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">(西班牙语)这一概念是对反应、使用、服务和储存的依赖的发展和变化。</p><h1 id="e83c" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">我们走吧！</h1><p id="9056" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">创建项目</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="e329" class="la jp hi kw b fi lb lc l ld le">yarn create react-app todo-app --template typescript<br/>yarn add styled-components  @types/styled-components</span></pre><p id="69e2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">清理和创建文件夹:</p><p id="d253" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">src/服务，src/存储库，src/上下文，src/提供者，src/组件，src/__测试_ _</p><figure class="kr ks kt ku fd ij er es paragraph-image"><div class="er es lf"><img src="../Images/d147b74ed5e92c063d884466f2252dbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:608/format:webp/1*6GgtWz1Gm4NQXjSATa9V0A.png"/></div></figure><h2 id="d166" class="la jp hi bd jq lg lh li ju lj lk ll jy jb lm ln kc jf lo lp kg jj lq lr kk ls bi translated">创建存储库和服务</h2><p id="9f63" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">src/repositories/todo . repository . ts</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="7b6f" class="la jp hi kw b fi lb lc l ld le">abstract class TodoRepository {<br/>  abstract add(todo: string): void;<br/>  abstract getAll(): string[];<br/>  abstract delete(todo: string): void;<br/><br/>  protected validateExistTodo(todos: string[], todo: string): boolean {<br/>    const tempTodos = todos.map((todo) =&gt; todo.toLocaleLowerCase());<br/>    return tempTodos.includes(todo.toLocaleLowerCase());<br/>  }<br/>}<br/><br/>export default TodoRepository;<br/></span></pre><p id="b9a2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">src/repositories/todoinmemory . repository . ts</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="f8e6" class="la jp hi kw b fi lb lc l ld le">import TodoRepository from "./todo.repository";<br/><br/>class TodoInMemoryRepository extends TodoRepository {<br/>  private todos: string[] = [];<br/><br/>  public add(todo: string) {<br/>    if (!this.validateExistTodo(this.todos, todo)) {<br/>      this.todos.unshift(todo);<br/>    }<br/>  }<br/><br/>  public delete(todo: string) {<br/>    if (this.validateExistTodo(this.todos, todo)) {<br/>      this.todos = this.todos.filter(<br/>        (_todo) =&gt; _todo.toLocaleLowerCase() !== todo.toLocaleLowerCase()<br/>      );<br/>    }<br/>  }<br/><br/>  public getAll(): string[] {<br/>    return this.todos;<br/>  }<br/>}<br/><br/>export default TodoInMemoryRepository;<br/></span></pre><p id="c5e6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">src/repositories/todoinlocalstorage . repository . ts</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="80fb" class="la jp hi kw b fi lb lc l ld le">import TodoRepository from "./todo.repository";<br/><br/>class TodoInLocalStorageRepository extends TodoRepository {<br/>  private todos: string[] = [];<br/>  private key: string = "todos";<br/><br/>  public constructor() {<br/>    super();<br/>    this.getFromLocalStorage();<br/>  }<br/><br/>  private getFromLocalStorage() {<br/>    const tempTodos = window.localStorage.getItem(this.key);<br/>    this.todos = tempTodos === null ? [] : JSON.parse(tempTodos);<br/>  }<br/><br/>  private insertToLocalStorage() {<br/>    window.localStorage.setItem(this.key, JSON.stringify(this.todos));<br/>  }<br/><br/>  public add(todo: string) {<br/>    if (!this.validateExistTodo(this.todos, todo)) {<br/>      this.todos.unshift(todo);<br/>      this.insertToLocalStorage();<br/>    }<br/>  }<br/><br/>  public delete(todo: string) {<br/>    if (this.validateExistTodo(this.todos, todo)) {<br/>      this.todos = this.todos.filter(<br/>        (_todo) =&gt; _todo.toLocaleLowerCase() !== todo.toLocaleLowerCase()<br/>      );<br/>      this.insertToLocalStorage();<br/>    }<br/>  }<br/><br/>  public getAll(): string[] {<br/>    return this.todos;<br/>  }<br/>}<br/><br/>export default TodoInLocalStorageRepository;<br/></span></pre><p id="c813" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">src/services/todo.service.ts</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="6a0a" class="la jp hi kw b fi lb lc l ld le">import TodoRepository from "../repositories/todo.repository";<br/><br/>class TodoService {<br/>  private repository: TodoRepository;<br/>  public constructor(repository: TodoRepository) {<br/>    this.repository = repository;<br/>  }<br/>  public getAll(): string[] {<br/>    return this.repository.getAll();<br/>  }<br/>  public add(todo: string): void {<br/>    this.repository.add(todo);<br/>  }<br/>  public delete(todo: string): void {<br/>    this.repository.delete(todo);<br/>  }<br/>}<br/><br/>export default TodoService;<br/></span></pre><p id="5f07" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请注意，在构造中，我们注入了抽象存储库，而不是实现。</p><h2 id="1ced" class="la jp hi bd jq lg lh li ju lj lk ll jy jb lm ln kc jf lo lp kg jj lq lr kk ls bi translated">创建上下文</h2><p id="687a" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">src/contexts/todos.context.ts</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="1301" class="la jp hi kw b fi lb lc l ld le">import { createContext } from "react";<br/><br/>type TypeTodosContext = {<br/>  todos: string[];<br/>  add: (todo: string) =&gt; void;<br/>  delete: (todo: string) =&gt; void;<br/>};<br/><br/>const InitialTodosContext: TypeTodosContext = {<br/>  todos: [],<br/>  add: () =&gt; {},<br/>  delete: () =&gt; {},<br/>};<br/><br/>const TodosContext = createContext&lt;TypeTodosContext&gt;(InitialTodosContext);<br/><br/>export default TodosContext;<br/></span></pre><h2 id="35b6" class="la jp hi bd jq lg lh li ju lj lk ll jy jb lm ln kc jf lo lp kg jj lq lr kk ls bi translated">编写组件</h2><p id="07a5" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">Todo.tsx</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="8a86" class="la jp hi kw b fi lb lc l ld le">import React, { useContext } from "react";<br/>import styled from "styled-components";<br/>import TodosContext from "../contexts/todos.context";<br/><br/>const TodoContainer = styled.div`<br/>  display: flex;<br/>  justify-content: space-between;<br/>  padding: 20px;<br/>  background-color: #f0f0f0;<br/>  margin: 10px 0;<br/>`;<br/>type TodoProps = {<br/>  name: string;<br/>};<br/>const Todo: React.FC&lt;TodoProps&gt; = ({ name }): JSX.Element =&gt; {<br/>  const ctx = useContext(TodosContext);<br/>  const handlerClick = () =&gt; {<br/>    ctx.delete(name);<br/>  };<br/>  return (<br/>    &lt;TodoContainer&gt;<br/>      &lt;span&gt;{name}&lt;/span&gt;<br/>      &lt;button onClick={handlerClick}&gt;❌&lt;/button&gt;<br/>    &lt;/TodoContainer&gt;<br/>  );<br/>};<br/><br/>export default Todo;<br/></span></pre><p id="0aad" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">TodoList.tsx</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="50e0" class="la jp hi kw b fi lb lc l ld le">import React, { useContext } from "react";<br/>import styled from "styled-components";<br/>import TodosContext from "../contexts/todos.context";<br/>import Todo from "./Todo";<br/><br/>const Ul = styled.ul`<br/>  list-style: none;<br/>`;<br/>const TodoList: React.FC = (): JSX.Element =&gt; {<br/>  const { todos } = useContext(TodosContext);<br/>  return (<br/>    &lt;Ul&gt;<br/>      {todos.map((todo: string, index: number) =&gt; (<br/>        &lt;li key={index}&gt;<br/>          &lt;Todo name={todo} /&gt;<br/>        &lt;/li&gt;<br/>      ))}<br/>    &lt;/Ul&gt;<br/>  );<br/>};<br/><br/>export default TodoList;<br/></span></pre><p id="0df3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">TodoForm.tsx</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="f9ad" class="la jp hi kw b fi lb lc l ld le">import React, { SyntheticEvent, useContext, useRef } from "react";<br/>import styled from "styled-components";<br/>import TodosContext from "../contexts/todos.context";<br/><br/>const Form = styled.form`<br/>  display: flex;<br/>  justify-content: center;<br/>`;<br/>const Input = styled.input`<br/>  padding: 10px;<br/>  &amp;[type="submit"] {<br/>    cursor: pointer;<br/>  }<br/>`;<br/>const TodoForm = (): JSX.Element =&gt; {<br/>  const inputText = useRef&lt;HTMLInputElement&gt;(null);<br/>  const { add } = useContext(TodosContext);<br/>  const handleSubmit = (event: SyntheticEvent&lt;HTMLFormElement&gt;) =&gt; {<br/>    event.preventDefault();<br/>    if (inputText.current !== null) {<br/>      add(inputText.current.value || "");<br/>      inputText.current.value = "";<br/>    }<br/>  };<br/>  return (<br/>    &lt;Form onSubmit={handleSubmit}&gt;<br/>      &lt;Input<br/>        ref={inputText}<br/>        type="text"<br/>        name="todo"<br/>        placeholder="Add todo"<br/>        required<br/>      /&gt;<br/>      &lt;Input type="submit" value="ADD" /&gt;<br/>    &lt;/Form&gt;<br/>  );<br/>};<br/><br/>export default TodoForm;<br/></span></pre><p id="66ac" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">TodoApp.tsx</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="535e" class="la jp hi kw b fi lb lc l ld le">import React from "react";<br/>import styled from "styled-components";<br/>import TodoForm from "./TodoForm";<br/>import TodoList from "./TodoList";<br/><br/>const Div = styled.div`<br/>  max-width: 800px;<br/>  margin: 0 auto;<br/>`;<br/>const TodoApp = (): JSX.Element =&gt; {<br/>  return (<br/>    &lt;Div&gt;<br/>      &lt;TodoForm /&gt;<br/>      &lt;TodoList /&gt;<br/>    &lt;/Div&gt;<br/>  );<br/>};<br/><br/>export default TodoApp;<br/></span></pre><p id="bd03" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">好了，我们有了所有的组件，现在我们编写注入服务的提供者、存储库，并为上下文定义处理程序。</p><h2 id="608a" class="la jp hi bd jq lg lh li ju lj lk ll jy jb lm ln kc jf lo lp kg jj lq lr kk ls bi translated">写提供者</h2><p id="c092" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">src/provides/todos . provider . tsx</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="8355" class="la jp hi kw b fi lb lc l ld le">import React, { ReactNode, useEffect, useState } from "react";<br/>import TodosContext from "../contexts/todos.context";<br/>import TodoService from "../services/todo.service";<br/><br/>type TypeTodoProvider = {<br/>  service: TodoService;<br/>  children?: ReactNode;<br/>};<br/>const TodosProvider: React.FC&lt;TypeTodoProvider&gt; = ({<br/>  service,<br/>  children,<br/>}): JSX.Element =&gt; {<br/>  const [todos, setTodos] = useState&lt;string[]&gt;([]);<br/><br/>  useEffect(() =&gt; {<br/>    getAll();<br/>    // eslint-disable-next-line react-hooks/exhaustive-deps<br/>  }, []);<br/><br/>  const getAll = (): void =&gt; {<br/>    setTodos([...service.getAll()]);<br/>  };<br/>  const add = (todo: string): void =&gt; {<br/>    service.add(todo);<br/>    getAll();<br/>  };<br/><br/>  const _delete = (todo: string): void =&gt; {<br/>    service.delete(todo);<br/>    getAll();<br/>  };<br/><br/>  const contextValue = {<br/>    todos,<br/>    add,<br/>    delete: _delete,<br/>  };<br/>  return (<br/>    &lt;TodosContext.Provider value={contextValue}&gt;<br/>      {children}<br/>    &lt;/TodosContext.Provider&gt;<br/>  );<br/>};<br/><br/>export default TodosProvider;<br/></span></pre><p id="3633" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这就是全部，转到index.tsx并在提供者内部调用您的应用程序</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="a842" class="la jp hi kw b fi lb lc l ld le">import React from "react";<br/>import ReactDOM from "react-dom";<br/>import TodoApp from "./components/TodoApp";<br/>import TodosProvider from "./providers/todos.provider";<br/>import reportWebVitals from "./reportWebVitals";<br/>import TodoInMemoryRepository from "./repositories/todoInMemory.repository";<br/>import TodoService from "./services/todo.service";</span><span id="b88e" class="la jp hi kw b fi lt lc l ld le">const repository = new TodoInMemoryRepository();<br/>const todoService = new TodoService(repository);</span><span id="48bb" class="la jp hi kw b fi lt lc l ld le">ReactDOM.render(<br/>  &lt;React.StrictMode&gt;<br/>    &lt;TodosProvider service={todoService}&gt;<br/>      &lt;TodoApp /&gt;<br/>    &lt;/TodosProvider&gt;<br/>  &lt;/React.StrictMode&gt;,<br/>  document.getElementById("root")<br/>);<br/><br/>// If you want to start measuring performance in your app, pass a function<br/>// to log results (for example: reportWebVitals(console.log))<br/>// or send to an analytics endpoint. Learn more: https://bit.ly/CRA-vitals<br/>reportWebVitals();</span></pre><p id="9582" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">看看我们是如何定义服务并通过props传递给提供者的，服务需要一个存储库，但这可能有多个与服务无关的实现。</p><p id="021b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果我们改变了存储库，我们不会遭受代码的改变。</p><p id="96b8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">测试它:</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="48ba" class="la jp hi kw b fi lb lc l ld le"><em class="lu">const repository = new TodoInLocalStorageRepository()</em>;</span><span id="151c" class="la jp hi kw b fi lt lc l ld le"><em class="lu">const todoService = new TodoService(repository)</em>;</span></pre><p id="4dad" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">是啊，所有作品！。</p><figure class="kr ks kt ku fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lv"><img src="../Images/abc3918fb72df5980303e8ecf3e61c3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xTBm2oksTidRy0Xivt9C8Q.png"/></div></div></figure><p id="b4e3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在可以运行本地存储和内存数据测试的应用程序，没有额外的代码或问题。</p><p id="b6db" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">编写一个测试:</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="6eff" class="la jp hi kw b fi lb lc l ld le">import React from "react";<br/>import { render, screen, fireEvent } from "@testing-library/react";<br/>import TodoService from "../services/todo.service";<br/>import TodoApp from "../components/TodoApp";<br/>import TodosProvider from "../providers/todos.provider";<br/>import TodoInMemoryRepository from "../repositories/todoInMemory.repository";<br/><br/>const renderApp = (service: TodoService) =&gt; {<br/>  return render(<br/>    &lt;TodosProvider service={service}&gt;<br/>      &lt;TodoApp /&gt;<br/>    &lt;/TodosProvider&gt;<br/>  );<br/>};<br/><br/>test("should add todo in todo app", () =&gt; {<br/>  const repository = new TodoInMemoryRepository();<br/>  const service = new TodoService(repository);<br/>  const { container } = renderApp(service);<br/>  const textInput = screen.getByPlaceholderText(/add todo/i);<br/>  const button = container.querySelectorAll("input[type=submit]")[0];<br/>  const todo = "test me";<br/>  fireEvent.change(textInput, { target: { value: todo } });<br/>  fireEvent.click(button);<br/>  expect(screen.getByText(todo)).toBeInTheDocument();<br/>});<br/></span></pre><p id="0b48" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae lw" href="https://github.com/hcastillaq/react-injection-reverses-dependencies" rel="noopener ugc nofollow" target="_blank"> - &gt; Github代码</a></p></div></div>    
</body>
</html>