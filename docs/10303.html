<html>
<head>
<title>How to schedule maintenance tasks for self-hosted Elasticsearch/Opensearch cluster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何为自托管Elasticsearch/Opensearch集群安排维护任务</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/how-to-schedule-maintenance-tasks-for-self-hosted-elasticsearch-opensearch-cluster-be0148553ad6?source=collection_archive---------9-----------------------#2022-01-22">https://medium.com/geekculture/how-to-schedule-maintenance-tasks-for-self-hosted-elasticsearch-opensearch-cluster-be0148553ad6?source=collection_archive---------9-----------------------#2022-01-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="c782" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您运行自己的Elasticsearch/Opensearch部署，您可能需要安排维护脚本。例如拍摄索引的快照/备份、迁移到另一个Elasticsearch集群、将Elasticsearch数据转移到S3、将数据导入Elasticsearch、删除/移动/存档旧索引、重新编制索引、重新平衡不均匀的碎片分布、将报告查询导出到S3等。</p><p id="c5e0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为此，一个小型开源工具<a class="ae jd" href="https://github.com/bluxmit/alnoda-workspaces/tree/main/workspaces/elasticsearch-workspace" rel="noopener ugc nofollow" target="_blank"> Elasticsearch-Workspace </a>可能会派上用场。本文将演示如何使用Kibana和Elasticsearch-Workspace启动本地Elasticsearch集群，加载测试数据，将Elasticsearch索引导出到S3，并安排定期备份。</p><p id="36e6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建<code class="du je jf jg jh b">docker-compose.yaml</code>文件，使用Kibana在本地启动3节点Elasticsearch集群</p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="feec" class="jq jr hi jh b fi js jt l ju jv">version: '2.2'<br/>services:<br/>  es01:<br/>    image: docker.elastic.co/elasticsearch/elasticsearch:7.16.3<br/>    container_name: es01<br/>    environment:<br/>      - node.name=es01<br/>      - cluster.name=es-docker-cluster<br/>      - discovery.seed_hosts=es02,es03<br/>      - cluster.initial_master_nodes=es01,es02,es03<br/>      - bootstrap.memory_lock=true<br/>      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"<br/>    ulimits:<br/>      memlock:<br/>        soft: -1<br/>        hard: -1<br/>    volumes:<br/>      - data01:/usr/share/elasticsearch/data<br/>    ports:<br/>      - 9200:9200<br/>    networks:<br/>      - elastic</span><span id="e6af" class="jq jr hi jh b fi jw jt l ju jv">es02:<br/>    image: docker.elastic.co/elasticsearch/elasticsearch:7.16.3<br/>    container_name: es02<br/>    environment:<br/>      - node.name=es02<br/>      - cluster.name=es-docker-cluster<br/>      - discovery.seed_hosts=es01,es03<br/>      - cluster.initial_master_nodes=es01,es02,es03<br/>      - bootstrap.memory_lock=true<br/>      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"<br/>    ulimits:<br/>      memlock:<br/>        soft: -1<br/>        hard: -1<br/>    volumes:<br/>      - data02:/usr/share/elasticsearch/data<br/>    networks:<br/>      - elastic</span><span id="d710" class="jq jr hi jh b fi jw jt l ju jv">es03:<br/>    image: docker.elastic.co/elasticsearch/elasticsearch:7.16.3<br/>    container_name: es03<br/>    environment:<br/>      - node.name=es03<br/>      - cluster.name=es-docker-cluster<br/>      - discovery.seed_hosts=es01,es02<br/>      - cluster.initial_master_nodes=es01,es02,es03<br/>      - bootstrap.memory_lock=true<br/>      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"<br/>    ulimits:<br/>      memlock:<br/>        soft: -1<br/>        hard: -1<br/>    volumes:<br/>      - data03:/usr/share/elasticsearch/data<br/>    networks:<br/>      - elastic</span><span id="9ab3" class="jq jr hi jh b fi jw jt l ju jv">kib01:<br/>    image: docker.elastic.co/kibana/kibana:7.16.3<br/>    container_name: kib01<br/>    ports:<br/>      - 5601:5601<br/>    environment:<br/>      ELASTICSEARCH_URL: <a class="ae jd" href="http://es01:9200" rel="noopener ugc nofollow" target="_blank">http://es01:9200</a><br/>      ELASTICSEARCH_HOSTS: '["<a class="ae jd" href="http://es01:9200" rel="noopener ugc nofollow" target="_blank">http://es01:9200</a>","<a class="ae jd" href="http://es02:9200" rel="noopener ugc nofollow" target="_blank">http://es02:9200</a>","<a class="ae jd" href="http://es03:9200" rel="noopener ugc nofollow" target="_blank">http://es03:9200</a>"]'<br/>    networks:<br/>      - elastic<br/>  <br/>  workspace:<br/>    image: alnoda/elasticsearch-workspace<br/>    container_name: workspace<br/>    ports:<br/>      - 8020-8030:8020-8030<br/>    networks:<br/>      - elastic</span><span id="c629" class="jq jr hi jh b fi jw jt l ju jv">volumes:<br/>  data01:<br/>    driver: local<br/>  data02:<br/>    driver: local<br/>  data03:<br/>    driver: local</span><span id="5551" class="jq jr hi jh b fi jw jt l ju jv">networks:<br/>  elastic:<br/>    driver: bridge</span></pre><p id="8dc5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">并以<code class="du je jf jg jh b">docker-compose up</code>开始。等到集群完全准备好，打开<a class="ae jd" href="https://github.com/bluxmit/alnoda-workspaces/blob/main/http:/localhost:5601" rel="noopener ugc nofollow" target="_blank"> http://localhost:5601 </a>上的Kibana，导入所有样本数据集。</p><figure class="ji jj jk jl fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es jx"><img src="../Images/b4e755f59aae470b16a94a855eef83bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nF2PO0l2Djv_PwLHb7ZOHg.png"/></div></div></figure><p id="7678" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">打开工作区UI<a class="ae jd" href="http://localhost:8020/" rel="noopener ugc nofollow" target="_blank">http://localhost:8020/</a>快速访问所有工作区工具</p><figure class="ji jj jk jl fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es kf"><img src="../Images/2d75b5f1b4cf6d77e8950daf158743c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vsuhqsh6V1jB05V55d2fQA.png"/></div></div></figure><p id="6f92" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">打开基于浏览器的终端<a class="ae jd" href="http://localhost:8026/" rel="noopener ugc nofollow" target="_blank"> http://localhost:8026/ </a>，检查集群节点和碎片</p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="183f" class="jq jr hi jh b fi js jt l ju jv">vulcanizer --host es01 nodes<br/>vulcanizer --host es01 shards</span></pre><figure class="ji jj jk jl fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es kg"><img src="../Images/0f11455976aa1ed6bdbec4ebf170bfae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vdUD4HdfoAPWKi7KjFlp2Q.png"/></div></div></figure><p id="036c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用elasticdump将索引<code class="du je jf jg jh b">kibana_sample_data_ecommerce</code>(来自电子商务样本数据集)导出到S3。改变你的S3密钥，秘密和桶名</p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="c998" class="jq jr hi jh b fi js jt l ju jv">elasticdump \<br/>  --s3AccessKeyId "${access_key_id}" \<br/>  --s3SecretAccessKey "${access_key_secret}" \<br/>  --input=http://es01:9200/kibana_sample_data_ecommerce \<br/>  --output "s3://${bucket_name}/kibana_sample_data_ecommerce.json"</span></pre><figure class="ji jj jk jl fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es kh"><img src="../Images/b38f4eab260d70afbd9bbc9051d018bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cDWzXEJJXwKkTkKSq_-Paw.png"/></div></div></figure><p id="f76e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">检查导出的指数是否出现在您的S3时段中。</p><p id="1cce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，让我们定期安排导出。打开基于浏览器的IDE<a class="ae jd" href="http://localhost:8026/" rel="noopener ugc nofollow" target="_blank">http://localhost:8026/</a>，用脚本创建文件<code class="du je jf jg jh b">/home/project/export.sh</code> file，将数据导出到S3。用<code class="du je jf jg jh b">chmod +x /home/project/export.sh</code>使其可执行</p><figure class="ji jj jk jl fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es ki"><img src="../Images/05be572a10f6e9d5c515416f94be6e67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2ciUa2-oRjSmsl3gm7pI_g.png"/></div></div></figure><p id="9f0b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">打开基于浏览器的调度程序<a class="ae jd" href="http://localhost:8026/" rel="noopener ugc nofollow" target="_blank">http://localhost:8026/</a>(user/pass:admin/admin)，并调度脚本，例如每周。选择类别—“常规”，插件—“外壳脚本”</p><figure class="ji jj jk jl fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es kj"><img src="../Images/d081f44baaf8dd2acaf7f2e3b33032e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cwQp7YghWU6RQL_6rsog-g.png"/></div></div></figure><p id="3def" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Cronicle仪表板将显示执行日志。</p><p id="1c35" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="kk">披露者:</em> </strong> <em class="kk">我是elasticsearch-workspace(以及该repo中的其他工作区)的创建者。我将它们用于自己的发展，并乐于与社区分享。希望你觉得有用！</em></p></div></div>    
</body>
</html>