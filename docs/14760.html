<html>
<head>
<title>Configuring Postfix for Multi-Domain Mail Relay</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为多域邮件中继配置Postfix</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/configuring-postfix-for-multi-domain-mail-relay-d33cd236298a?source=collection_archive---------0-----------------------#2022-09-22">https://medium.com/geekculture/configuring-postfix-for-multi-domain-mail-relay-d33cd236298a?source=collection_archive---------0-----------------------#2022-09-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/6b5d4e2762fa89a9ad24f54e573c4aaa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WMu5ZzZLIcoAuTivenClMA.jpeg"/></div></div></figure><p id="48b3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">用Postfix托管多域电子邮件环境相对简单。好吧，就像管理电子邮件一样简单……设置虚拟邮箱，通过设置管理用户界面(<em class="jo"> postfixadmin </em>)让生活变得更简单，你就大功告成了。但是，如果您在限制端口25接收流量的环境中运行服务器，该怎么办呢？这就是谷歌云和其他云服务为防止恶意行为者滥用其云环境发送垃圾邮件而做的事情。</p><p id="7aaa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了解决这个问题，我们必须使用邮件中继服务，比如<a class="ae jp" href="https://www.mailgun.com" rel="noopener ugc nofollow" target="_blank"> Mailgun </a>、<a class="ae jp" href="https://www.mailjet.com" rel="noopener ugc nofollow" target="_blank"> MailJet </a>或<a class="ae jp" href="https://sendgrid.com" rel="noopener ugc nofollow" target="_blank"> SendGrid </a>。这需要一些额外的步骤。在本文中，我们将研究托管多域电子邮件服务器所需的步骤，该服务器使用postfix中继服务。这不是一个设置邮件服务器的端到端指南，而是对我之前的系列文章<a class="ae jp" rel="noopener" href="/geekculture/how-to-host-a-personal-email-server-on-google-cloud-for-free-part-i-8124d65d1d25"> <strong class="is hj">如何在Google Cloud上托管个人邮件服务器的补充(免费！)</strong> </a>。假设您拥有使用虚拟邮箱的正确配置的单域电子邮件环境，并且能够正确配置DNS以将其他域的电子邮件定向到您的服务器，以及获取其他域的SSL证书。如果您的配置不同或者您刚刚开始，请查看之前的指南。</p><h1 id="3eda" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">后缀配置</h1><p id="de29" class="pw-post-body-paragraph iq ir hi is b it ko iv iw ix kp iz ja jb kq jd je jf kr jh ji jj ks jl jm jn hb bi translated">实际上，我们只需要配置2个更改，但每个更改都包括几个步骤。首先，我们需要为每个域提供中继身份验证参数的映射。然后，我们需要为每个域提供SSL证书的映射。如果为所有域颁发了一个证书，后一步是可选的，但是强烈建议每个域都有自己的证书。让我们开始吧。</p><h2 id="5aaf" class="kt jr hi bd js ku kv kw jw kx ky kz ka jb la lb ke jf lc ld ki jj le lf km lg bi translated">每个域的身份验证</h2><p id="517c" class="pw-post-body-paragraph iq ir hi is b it ko iv iw ix kp iz ja jb kq jd je jf kr jh ji jj ks jl jm jn hb bi translated">如果您按照指南的第2部分中的<a class="ae jp" rel="noopener" href="/geekculture/how-to-host-a-personal-email-server-on-google-cloud-for-free-part-ii-20aaeb0ae9eb">操作，您会看到一个<code class="du lh li lj lk b">/etc/postfix/sasl_passwd</code>文件，其中有一行类似于下面的内容(<em class="jo">用户名</em> &amp; <em class="jo">密码</em>是您自己的):</a></p><pre class="ll lm ln lo fd lp lk lq bn lr ls bi"><span id="4c08" class="lt jr hi lk b be lu lv l lw lx">[smtp.mailgun.org]:2525    username:password</span></pre><p id="78c7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可能在创建地图后删除了该文件，因此如果是这样，您必须重新创建该文件。我们想要做的是更新映射以使用每个域的身份验证。一旦您有了每个域的SMTP凭证，更新文件如下:</p><pre class="ll lm ln lo fd lp lk lq bn lr ls bi"><span id="0360" class="lt jr hi lk b be lu lv l lw lx">@example.com     username:password<br/>@example2.com    username2:password2<br/>@example3.com    username3:password3</span></pre><p id="49f7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">注意:</strong>您的邮件中继服务可能要求每个域使用不同的认证参数，或者对所有域使用相同的认证参数。请遵循您的提供商提供的指南。</p><p id="88d6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后，使用以下命令从该文件创建地图。</p><pre class="ll lm ln lo fd lp lk lq bn lr ls bi"><span id="3e62" class="lt jr hi lk b be lu lv l lw lx">sudo postmap /etc/postfix/sasl_passwd</span></pre><p id="a71f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在打开<code class="du lh li lj lk b">/etc/postfix/main.cf</code>添加下面一行。</p><pre class="ll lm ln lo fd lp lk lq bn lr ls bi"><span id="ded2" class="lt jr hi lk b be lu lv l lw lx">smtp_sender_dependent_authentication = yes</span></pre><p id="8980" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这告诉Postfix我们需要在依赖于发送者的基础上通过中继服务进行认证。这将关闭SMTP连接缓存，以确保每个请求都使用正确的凭据。这就是SASL认证。</p><h2 id="fb6d" class="kt jr hi bd js ku kv kw jw kx ky kz ka jb la lb ke jf lc ld ki jj le lf km lg bi translated">每个域的加密</h2><p id="f4b9" class="pw-post-body-paragraph iq ir hi is b it ko iv iw ix kp iz ja jb kq jd je jf kr jh ji jj ks jl jm jn hb bi translated">现在我们将创建一个映射，将Postfix指向每个域的SSL证书。创建文件<code class="du lh li lj lk b">/etc/postfix/ssl_map</code>并添加以下行，用您自己的路径替换域和证书路径。</p><pre class="ll lm ln lo fd lp lk lq bn lr ls bi"><span id="bfb4" class="lt jr hi lk b be lu lv l lw lx">mail.example.com<br/>    /etc/letsencrypt/live/mail.example.com/privkey.pem<br/>    /etc/letsencrypt/live/mail.example.com/fullchain.pem<br/><br/>mail.example2.com<br/>    /etc/letsencrypt/live/mail.example2.com/privkey.pem<br/>    /etc/letsencrypt/live/mail.example2.com/fullchain.pem<br/><br/>mail.example3.com<br/>    /etc/letsencrypt/live/mail.example3.com/privkey.pem<br/>    /etc/letsencrypt/live/mail.example3.com/fullchain.pem</span></pre><p id="e006" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后，运行以下命令。</p><pre class="ll lm ln lo fd lp lk lq bn lr ls bi"><span id="591e" class="lt jr hi lk b be lu lv l lw lx">sudo postmap -F hash:/etc/postfix/ssl_map</span></pre><p id="e4a9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们在这里使用<code class="du lh li lj lk b">-F</code>选项，因为我们要映射到文件。</p><p id="bea4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们还想将这个命令添加到部署后挂钩中，以便在证书更新时运行。更新<code class="du lh li lj lk b">/etc/letsencrypt/renewal-hooks/deploy/mail-permissions</code>像这样:</p><pre class="ll lm ln lo fd lp lk lq bn lr ls bi"><span id="5b30" class="lt jr hi lk b be lu lv l lw lx">#!/bin/sh<br/>setfacl -R -m u:www-data:rx /etc/letsencrypt/live/ /etc/letsencrypt/archive/<br/>postmap -F hash:/etc/postfix/ssl_map<br/>service dovecot restart<br/>service postfix restart</span></pre><p id="2922" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">告诉Postfix在<code class="du lh li lj lk b">/etc/postfix/main.cf</code>中添加下面一行来使用新地图。</p><pre class="ll lm ln lo fd lp lk lq bn lr ls bi"><span id="9196" class="lt jr hi lk b be lu lv l lw lx">tls_server_sni_maps = hash:/etc/postfix/ssl_map</span></pre><p id="c624" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后，重启Postfix。</p><pre class="ll lm ln lo fd lp lk lq bn lr ls bi"><span id="5654" class="lt jr hi lk b be lu lv l lw lx">sudo service postfix restart</span></pre><h2 id="5a40" class="kt jr hi bd js ku kv kw jw kx ky kz ka jb la lb ke jf lc ld ki jj le lf km lg bi translated">鸽房</h2><p id="00d9" class="pw-post-body-paragraph iq ir hi is b it ko iv iw ix kp iz ja jb kq jd je jf kr jh ji jj ks jl jm jn hb bi translated">我们还必须告诉Dovecot为每个域使用正确的证书。打开<code class="du lh li lj lk b">/etc/dovecot/conf.d/10-ssl.conf</code>，在<code class="du lh li lj lk b">ssl_cert</code>和<code class="du lh li lj lk b">ssl_key</code>下为每个域添加一个<code class="du lh li lj lk b">local_name</code>条目。不要注释掉这些默认值。</p><pre class="ll lm ln lo fd lp lk lq bn lr ls bi"><span id="5167" class="lt jr hi lk b be lu lv l lw lx">...<br/><br/>ssl_cert =&lt;/etc/letsencrypt/live/mail.example.com/fullchain.pem<br/>ssl_key =&lt;/etc/letsencrypt/live/mail.example.com/privkey.pem<br/><br/>local_name mail.example.com {<br/>   ssl_cert =&lt;/etc/letsencrypt/live/mail.example.com/fullchain.pem<br/>   ssl_key =&lt;/etc/letsencrypt/live/mail.example.com/privkey.pem<br/>}<br/><br/>local_name mail.example2.com {<br/>   ssl_cert =&lt;/etc/letsencrypt/live/mail.example2.com/fullchain.pem<br/>   ssl_key =&lt;/etc/letsencrypt/live/mail.example2.com/privkey.pem<br/>}<br/><br/>...</span></pre><p id="031f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后重启Dovecot。</p><pre class="ll lm ln lo fd lp lk lq bn lr ls bi"><span id="fde2" class="lt jr hi lk b be lu lv l lw lx">sudo service dovecot restart</span></pre><p id="430c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">注意:</strong>如果您按照本系列的<a class="ae jp" rel="noopener" href="/geekculture/how-to-host-a-personal-email-server-on-google-cloud-for-free-part-v-f9a4b3643622">指南</a>使用Roundcube webmail，您可以基于每个域对其进行配置。这不是必须的，但是如果你需要的话会很有帮助。如果你有兴趣的话，请点击这里查看Roundcube指南。</p><h1 id="6b19" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">结论</h1><p id="0255" class="pw-post-body-paragraph iq ir hi is b it ko iv iw ix kp iz ja jb kq jd je jf kr jh ji jj ks jl jm jn hb bi translated">干得好！我们现在可以通过自己选择的中继服务从服务器上的多个域发送电子邮件。我希望你喜欢这个指南，并发现它很有帮助。如果有，请鼓掌，关注我，跟上我以后的文章和指南。如果您有任何问题或意见，我希望收到您的来信。感谢阅读！</p></div></div>    
</body>
</html>