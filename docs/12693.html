<html>
<head>
<title>Accessing environment variables from kubernetes/helm in NextJs app on the client side</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在客户端从NextJs应用程序中的kubernetes/helm访问环境变量</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/accessing-environment-variables-from-kubernetes-helm-in-nextjs-app-on-the-client-side-281cf5b60a3a?source=collection_archive---------0-----------------------#2022-05-27">https://medium.com/geekculture/accessing-environment-variables-from-kubernetes-helm-in-nextjs-app-on-the-client-side-281cf5b60a3a?source=collection_archive---------0-----------------------#2022-05-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="39aa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我将一个kubernetes秘密作为环境变量注入到我的NextJs应用程序中，如下所示:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/ee976f58e8b12bc7fccbc8ccdcd883db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fNn_pV7VfEAraFd2gKr9GQ.png"/></div></div></figure><p id="e5a2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我想在客户端代码中使用这个秘密的env变量(用户名)。</p><p id="3f19" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了做到这一点，我遵循了以下文件-</p><div class="jp jq ez fb jr js"><a href="https://nextjs.org/docs/basic-features/environment-variables#exposing-environment-variables-to-the-browser" rel="noopener  ugc nofollow" target="_blank"><div class="jt ab dw"><div class="ju ab jv cl cj jw"><h2 class="bd hj fi z dy jx ea eb jy ed ef hh bi translated">基本功能:环境变量| Next.js</h2><div class="jz l"><h3 class="bd b fi z dy jx ea eb jy ed ef dx translated">学习在Next.js应用程序中添加和访问环境变量。</h3></div><div class="ka l"><p class="bd b fp z dy jx ea eb jy ed ef dx translated">nextjs.org</p></div></div><div class="kb l"><div class="kc l kd ke kf kb kg jn js"/></div></div></a></div><p id="b3c6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在使用“yarn dev”运行我的应用程序之前，当我导出变量时，我能够在本地以NEXT_PUBLIC_USERNAME的身份访问用户名。</p><p id="859c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是当我在更高的环境下推送这段代码时，我发现客户端的NEXT_PUBLIC_USERNAME是<strong class="ih hj">` undefined`</strong><strong class="ih hj"/>。</p><p id="2718" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">虽然在服务器端，同样的变量给出了正确的值。原来在运行时注入的环境变量在NextJs应用程序的服务器端总是可以访问的。</strong></p><p id="ca8a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后我仔细阅读了上面的文档，要暴露给browser/client的env变量将只在构建时设置其值<strong class="ih hj">。</strong></p><p id="9451" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是在更高级的环境中，这些env变量是在运行时使用kubernetes <strong class="ih hj">注入到容器中的。因此在构建时，设置给这些NEXT_PUBLIC_* env变量的值是未定义的。</strong></p><p id="76bc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">NEXT_PUBLIC变量未定义的另一个主要原因是<strong class="ih hj">它与NextJs提供的</strong> <a class="ae kh" href="https://nextjs.org/docs/advanced-features/automatic-static-optimization" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">自动静态优化</strong> </a> <strong class="ih hj">不兼容。</strong></p><h1 id="245d" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">解决方案#1 —</h1><p id="c428" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">因为NEXT_PUBLIC的东西帮不了我们。剩下的唯一方法是<strong class="ih hj">以某种方式将env变量从服务器传递到客户机</strong>。</p><p id="0cab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">看了很多文档，碰到一个服务器端函数<code class="du ll lm ln lo b">getServerSideProps</code>。</p><p id="d45a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">这个函数只在运行时针对每个页面请求在服务器上运行</strong>。使用这个函数，我们可以在运行时将道具从服务器端传递到客户端。就在那时我有了这个想法！</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lp"><img src="../Images/c2c0942473527b304860065f82679fbe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3C09YvhvWrDtiiiAx7TyyQ.png"/></div></div></figure><p id="e21e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就是我在客户端成功访问kubernetes注入的env变量的方法！！</p><p id="255f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我认为代码是不言自明的，如果你通过下面的链接-</p><div class="jp jq ez fb jr js"><a href="https://nextjs.org/docs/basic-features/data-fetching/get-server-side-props" rel="noopener  ugc nofollow" target="_blank"><div class="jt ab dw"><div class="ju ab jv cl cj jw"><h2 class="bd hj fi z dy jx ea eb jy ed ef hh bi translated">数据提取:getServerSideProps | Next.js</h2><div class="jz l"><h3 class="bd b fi z dy jx ea eb jy ed ef dx translated">如果您从页面中导出一个名为getServerSideProps(服务器端呈现)的函数，Next.js将预先呈现这个…</h3></div><div class="ka l"><p class="bd b fp z dy jx ea eb jy ed ef dx translated">nextjs.org</p></div></div><div class="kb l"><div class="lq l kd ke kf kb kg jn js"/></div></div></a></div><p id="1130" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">如果我们没有任何敏感的env变量要从服务器传递到客户端，这个解决方案可以很好地工作。如果我们有它们，那么使用这个解决方案不会有帮助，因为它会在network选项卡中显示一个条目，并且我们敏感的env变量会被暴露。</strong></p><h1 id="6438" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">解决方案#2 —</h1><p id="7a71" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">如前所述，运行时的NEXT_PUBLIC env变量与NextJs提供的<a class="ae kh" href="https://nextjs.org/docs/advanced-features/automatic-static-optimization" rel="noopener ugc nofollow" target="_blank">自动静态优化</a>不兼容。</p><p id="ca48" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，如果我们想在没有任何间歇性问题的情况下使用它(值在重新加载或重定向时未定义，或者无论如何值本身未定义)，<strong class="ih hj">我们应该使用</strong> <code class="du ll lm ln lo b"><strong class="ih hj">getInitialProps</strong></code> <strong class="ih hj">退出</strong> <a class="ae kh" href="https://nextjs.org/docs/advanced-features/automatic-static-optimization" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">自动静态优化</strong> </a> <strong class="ih hj">。</strong></p><p id="bab5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将始终确保我们能够访问NEXT_PUBLIC env变量的正确值。</p><p id="5f39" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们还需要在next.config.js文件的publicRuntimeConfig中添加相同的配置，如下所示:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lr"><img src="../Images/9fa7bf2868386b4c8d04a1959c4721e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nWwU1zWRA2hNRc48eg07KQ.png"/></div></div></figure><p id="8202" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们可以按以下方式使用env变量:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ls"><img src="../Images/3f735786cd9495e636d2813f2447ee28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ca32neS--q1pkPH8gV_X7w.png"/></div></div></figure><p id="0bda" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">如果我们要从其他页面重定向到这个页面，我们也必须在所有其他页面中使用这个getInitialProps。否则，env变量将给出未定义的值。</strong></p><p id="5a57" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">声明:我对NextJs非常陌生，所以如果我在上面的帖子中提到了什么错误，请纠正我。如果有任何疑问，也可以在这里发表评论。</p></div></div>    
</body>
</html>