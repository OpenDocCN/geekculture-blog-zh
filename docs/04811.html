<html>
<head>
<title>JWT Authentication — Part 1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">JWT认证—第1部分</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/jwt-authentication-part-1-45af02b29fce?source=collection_archive---------18-----------------------#2021-07-04">https://medium.com/geekculture/jwt-authentication-part-1-45af02b29fce?source=collection_archive---------18-----------------------#2021-07-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/15a39717bf5ec359c0573c68bef01acd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wqr72wJLDPDSnJcNOpUfeQ.png"/></div></div></figure><h1 id="6173" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated"><strong class="ak">简介</strong></h1><p id="f5c8" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">我写这篇文章的目的是总结我在当前工作中研究JWT实现时收集的所有信息。我们将简要介绍我认为使用JWT时最需要注意的几点，在文章的最后，我将给出一个使用nodejs实现JWT的例子。</p><p id="ffa9" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">编辑:第二部分现在出来了，如果你是来看代码的，请在这里看<a class="ae kr" href="https://andre-benevides.medium.com/jwt-authentication-part-2-3eb727805ad8" rel="noopener">第二部分</a>。</p><h1 id="b3a9" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated"><strong class="ak">什么是JWT？</strong></h1><p id="5ef3" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">根据jwt.io的定义:</p><p id="04f7" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">JSON Web Token (JWT)是一个开放标准(RFC 7519 ),它定义了一种紧凑且独立的方式，以JSON对象的形式在各方之间安全地传输信息。该信息可以被验证和信任，因为它是数字签名的。jwt可以使用秘密(使用HMAC算法)或使用RSA或ECDSA的公钥/私钥对进行签名。</p><p id="fbe2" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">既然我们已经解决了这个问题，让我们更深入地了解JWT世界。</p><h1 id="0e99" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated"><strong class="ak">令牌到底是什么？</strong></h1><p id="bc30" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">前段时间我在网上看到了这个解释，这是我能想到的向不了解技术或之前不了解身份验证、会话和/或令牌的人解释令牌是什么的最佳示例:</p><p id="bb05" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">如果我给你10 €，你给我一张你签名的欠条，说你欠我10 €，在以后的生活中，我可以回到你身边，给你看这张纸条，你会知道这张纸条是你签名的，并把钱还给我，但如果有人试图伪造这张纸条，从你那里得到一些钱，你会知道这张纸条是假的，从未由你签名，所以你拒绝交易。用相当基本的术语来说，这就是认证服务器和它的客户端之间发生的事情。</p><p id="604a" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">JSON Web令牌是一种特殊类型的令牌，由3个base64编码的字符串组成:头、有效负载和签名(<header>)。<payload>。<signature>)。令牌结构的设计方式方便了它在web上的使用，例如，甚至可以在URL参数中传递。</signature></payload></header></p><p id="5b7f" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">在头中，有一个JSON编码的对象，它定义了所使用的算法。</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="b19a" class="lb ir hi kx b fi lc ld l le lf">{ "alg" : "HS256", "typ" : "JWT" }</span></pre><p id="0384" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">有效负载部分由认证服务器定义的一组声明组成。因为这些数据是JSON编码的，所以您可以存储任何您想要/需要的数据。有效负载的示例如下:</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="3ad6" class="lb ir hi kx b fi lc ld l le lf">{"user":{"id":1,"username":"myDemoUser1","accesses":["CREATE","UPDATE","READ","DELETE"]},"iat":1605058642,"exp":1605067642,"aud":" YOUR-AUD-HERE","iss":"YOUR-ISSUER-NAME"}</span></pre><p id="2ea8" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">最后一部分是签名，该签名由报头中指定的算法的加密签名的结果字符串组成。签名过程举例如下:</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="ce7b" class="lb ir hi kx b fi lc ld l le lf">HMAC-SHA256(secret, base64urlEncoding(header) + '.' + base64urlEncoding(payload)</span></pre><p id="78e3" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">“秘密”应该是认证服务器及其用户之间的预共享密钥。</p><h1 id="7c4f" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated"><strong class="ak">可用于JWT令牌声明的标准字段</strong></h1><p id="4f29" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">接下来，我将向您展示标准字段和推荐字段，但重要的是要理解，您不必强制使用这些字段中的任何一个，您可以使用自己的字段和/或混合使用标准字段和自己的字段。</p><figure class="ks kt ku kv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lg"><img src="../Images/cc5252b5ee8f1bb2874e9ce70d5d4105.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wC5H5XTtSOrqKg9aIPUtAQ.png"/></div></div></figure><p id="21c6" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">注意:您应该使用的最低限度是“typ”和“alg”字段。</p><figure class="ks kt ku kv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lh"><img src="../Images/118ee5b95c286c1e54fae0a8779f7f34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JkssvvB26k4qCe0myTMGnw.png"/></div></div></figure><h1 id="cb2c" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">JWT安全吗？</h1><p id="aae1" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">TLDR:如果配置正确，它是安全的，否则它是不安全的。在任何情况下，JWT不一定比cookie更安全，因为会话cookie的正确实现也使用非对称签名。继续阅读，获取更深入的答案。</p><p id="778c" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">JWT中的内容本质上并不安全，因为它们是以base64编码的，base64绝不是加密算法，但是如前所述，JWT由3部分组成，令牌的最后一部分是由认证服务器用密钥生成的签名。这个签名确保服务器知道他签署了这个令牌，并且这个令牌是有效的。任何篡改签名的企图都将使令牌被认证服务器视为无效。也就是说，JWT是安全的，但如果您没有正确配置令牌，它可能不如基于会话的身份验证安全。例如，一个永不过期的令牌很容易被任何人劫持和使用，而认证服务器对此一无所知。我通常每5分钟让令牌过期一次，但是您应该考虑哪个过期时间更适合您的范围。让您的令牌在短时间内过期会使任何被劫持的令牌在短短几分钟内无法使用，从而最大限度地降低损坏的风险。</p><h1 id="d738" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated"><strong class="ak">JWT是否用于认证或授权？</strong></h1><p id="9822" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">这些术语听起来非常相似，但它们是非常不同的过程。身份认证是识别用户对系统的访问的过程。授权是确定您是否被授权访问特定资源的过程。幸运的是(或者不幸的是，这取决于你对JWT的看法), JWT的工作方式使得两种情况都可以使用:令牌本身可以用于身份验证，而令牌有效负载的内容可以包含关于你被授权查看和/或操作的资源的信息。</p><p id="1c71" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">还记得我之前在解释有效载荷时使用的有效载荷吗？</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="36d7" class="lb ir hi kx b fi lc ld l le lf">{"user":{"id":1,"username":"myDemoUser1","accesses":["CREATE","UPDATE","READ","DELETE"]},"iat":1605058642,"exp":1605067642,"aud":"YOUR-AUD-HERE","iss":"YOUR-ISSUER-NAME"}</span></pre><p id="aca8" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">这个JSON有一个访问声明，在这种情况下，让任何正在读取这个令牌的服务知道这个用户可以“创建”、“更新”、“读取”和“删除”资源。</p><h1 id="08ee" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated"><strong class="ak">优点&amp;缺点</strong></h1><h1 id="2240" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated"><strong class="ak">优点</strong></h1><p id="4adf" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">因为令牌可以在“任何地方”生成，所以将认证服务器从您的资源服务器(例如:后端API)中分离/分散是非常容易的。</p><h1 id="d194" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated"><strong class="ak">百感交集</strong></h1><p id="9b2a" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">令牌是“可移植的”,单个令牌可以由多个客户端使用。有些人认为这是一个优点，但在我看来，这是一个缺点，因为这使它不那么独特和安全。</p><p id="b371" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">另一个优点是，由于JWT是一个自包含的令牌，包含认证服务器所需的所有认证信息，它是无状态的，因此您不需要管理会话。我见过这样的情况，开发人员使用令牌作为成功登录的证明，现在令牌必须存储在客户端的某个地方。因此，您有效地将会话管理从服务器更改到了客户端。</p><h1 id="9d2e" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated"><strong class="ak">缺点</strong></h1><p id="216d" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">根据令牌的工作方式，如果您需要停用用户，您需要等到生成的最后一个令牌过期后，才能将用户真正锁定在您的系统之外。</p><p id="52b8" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">如果用户需要更改其密码，并且在密码更改之前生成了令牌，则该令牌在过期之前仍然有效。</p><p id="3cc2" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">不存在“真正的注销”,因为令牌在到期之前一直有效，并且您无法在不破坏JWT标准的“无状态性”的情况下销毁令牌。</p><p id="da44" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">安全顾问Tim McLean报告了一些JWT库中的漏洞，这些漏洞使用alg属性来错误地验证令牌。被报告为不安全的库已被修补，但这是一个例子，说明您在使用第三方库时需要小心，因为尽管JWT标准实际上是安全的，但您的库可能会错误地验证令牌。</p><h1 id="c988" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated"><strong class="ak">最佳实践</strong></h1><p id="eef5" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">由于其JSON编码的数据，JWT允许您在应用程序之间共享信息，但请注意，这可能是一个滑坡，因为如果您开始在令牌中共享太多的信息，您将向您的系统和用户开放泄漏，从而暴露敏感的数据。永远记住，虽然你不能只用眼睛阅读令牌，但你传递的信息是用base64编码的，我提醒你，这不是一种加密措施，可以非常容易地还原成纯文本。</p><p id="cf5b" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">验证令牌时，始终检查令牌中的算法声明。如果令牌被盗，恶意参与者可以将声明更改为一些不太安全的算法，并试图篡改您的令牌。由于这个漏洞，你应该保留一个你的系统可以接受的算法的白名单。例如，算法声明“无”是一个有效选项，如果您的身份验证服务器未正确配置，它会将令牌作为未签名的令牌接受。</p><p id="1c1f" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">即使您使用的是安全的内部网络，也要始终验证您在每个请求中收到的每个令牌。如果您将身份认证服务器设置为总是检查令牌，那么当您的内部网络出现漏洞时，以及当您的服务转移到公共域时，您就可以保护您的系统，您已经正确设置了所有内容，现在您不必记住需要进行验证。</p><p id="fb91" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">始终检查发行人索赔。JWT的标准领域之一是iss声明。这有助于您的服务了解令牌的颁发者以及该颁发者是否合法。另外，在验证issue声明时，要确保发布者被准确地解析为您所知道的那样。例如，颁发者“testtest”与“testTest”和/或“testtest/a”不同。</p><p id="d99b" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">总是检查观众的要求。如果您已经检查了发行者声明，那么您还必须检查受众声明。该字段告诉您令牌的接收者。您的服务应该检查这一声明，并将其与白名单进行比较。如果受众声明被列入白名单，服务器可以接受资源请求，否则服务器应该立即拒绝令牌。如果您使用JWT作为访问令牌，那么受众声明的一个良好实践应该是令牌所针对的API的URL。</p><p id="6bc9" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">始终生成具有小有效性窗口的令牌。JWT在发给客户后几乎不可能被撤销。服务器应该总是寻找exp声明，并检查令牌是否还没有过期。请注意，恶意用户可能会更改“时钟”以在过去发出请求，并使其看起来好像令牌尚未过期。为了解决这个问题，您可以使用“nbf”声明，即“不在之前”时间，该声明告诉服务器在特定日期和时间之前不能使用令牌。您还可以添加iat声明“issued at”来告诉服务器令牌是何时发出的。这有助于服务器拒绝被认为太旧而不能使用的令牌。</p><p id="3c14" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">请注意，对令牌的有效负载或报头的任何更改都会生成不同的签名。因此，在验证令牌时记住签名是很重要的(这可能是最重要的一步！).这些变化可能小到在报头或有效载荷中添加一个空格。如果两个客户端在完全相同的时间请求令牌，理论上可能会出现“重复”令牌的情况，我认为这很难发生，但您可以使用“jti”声明，这是由您的身份验证服务器生成的ID，有助于区分令牌。尽管所有其他声明都是相同的，但是每个令牌的ID总是不同的，因此使它们是唯一的。</p><p id="3d3e" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">不要使用对称签名。尽可能避免使用对称签名，而是使用非对称签名。使用对称签名，您永远无法确定谁签署了令牌，而使用非对称签名，唯一能够签署令牌的实体是拥有私钥的实体，这让我想起了下一个好的实践。</p><p id="ecbb" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">不要把你的认证服务器的私钥给任何人。这只应由服务器单独使用，并应保存在安全的地方。</p><p id="451d" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">不要使用JWT作为会话cookies。</p><h1 id="339f" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated"><strong class="ak">最终想法</strong></h1><p id="1902" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">我真的希望我的总结能帮助您更好地理解JSON Web Token。我认为重要的是，JWT并没有神奇地比其他经过测试的方法(如会话cookies)更安全，JWT的每一项安全措施本质上都和其他工具一样。虽然我没有将JWT与其他工具进行比较，但我试图避免一些网站给你的JWT的美化视图，因为重要的是要明白，如果你决定在你的应用程序中使用JWT，你不会自动更安全，你需要做你的尽职调查，以确保你的应用程序尽可能安全。</p><p id="bfae" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">请继续关注第2部分，在那里我将指导您使用nodejs和express完成一个代码示例。</p><p id="6f67" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">我希望你喜欢这篇文章，我会在我的下一篇文章中看到你。在那之前，注意安全！</p></div></div>    
</body>
</html>