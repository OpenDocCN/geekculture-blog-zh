<html>
<head>
<title>Introduction to Spring Cloud Config</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Spring云配置简介</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/introduction-to-spring-cloud-config-a5919335fea?source=collection_archive---------10-----------------------#2021-05-20">https://medium.com/geekculture/introduction-to-spring-cloud-config-a5919335fea?source=collection_archive---------10-----------------------#2021-05-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="68c6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">开发应用程序的最佳实践是使其松散耦合。我们应该能够添加新的功能，属性，而不影响它的其他现有的功能。随着我们的应用程序发展成不同的微服务、模块，管理应用程序的属性变得很困难。哪个属性用于开发平台，哪个属性用于生产构建。随着属性的变化，我们必须重新构建、重新测试并再次部署应用程序。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/28dcf4e136ecdcd548ac15d0e749f222.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Su7Wi8LsXpkLsJ9tWU9Vwg.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Services connecting to config server for a single source of providing properties.</figcaption></figure><p id="19d4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我们能够将所有的配置从不同服务的逻辑中分离出来，并且所有的服务都能够动态地读取应用程序，那该有多好。有不同的方法，比如Spring Cloud Config、Consul、Zookeeper等等。在本文中，我们将使用Spring cloud-config来集中管理应用程序的属性和配置。回购的详细代码可以在<a class="ae jt" href="https://github.com/ruminder-hub/spring_cloud_config" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">这里</strong> </a>找到，配置服务器和客户端代码可以在这个<a class="ae jt" href="https://github.com/ruminder-hub/medium/tree/main/spring_cloud_config" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">链接</strong> </a>找到。</p><h2 id="3e25" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">优势</h2><p id="e1c8" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">一致性:它是配置的唯一真理。<br/> <strong class="ih hj">省时</strong>:您不需要重新部署应用程序，因为更改是动态进行的。<br/> <strong class="ih hj">基于配置文件的配置:</strong>可以根据配置文件设置不同的配置。</p><h2 id="b320" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated"><strong class="ak">配置来源:</strong></h2><p id="6477" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">我们可以将所有配置放入一个微服务中，所有服务都可以从中获取数据。但是我们如何将配置放入其中呢？如果我们将它添加到源代码中，那么每当我们做出更改时，我们都需要重新部署它。我们可以使用数据库，这是一种可能性。然而，我们在这里使用git repo作为配置的来源。Spring Cloud config从git repo获取配置，任何服务都可以从中获取。</p><h2 id="7a19" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">Git回购</h2><p id="4d47" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">要创建一个repo并添加属性，请执行以下命令</p><pre class="je jf jg jh fd ku kv kw kx aw ky bi"><span id="90c0" class="ju jv hi kv b fi kz la l lb lc">mkdir configuration_repo<br/>cd configuration_repo<br/>git init .<br/>echo logging.level.root: INFO &gt; config-client-production.properties<br/>echo logging.level.root: DEBUG &gt; config-client-development.properties<br/>git add .<br/>git commit -m "Initialization of properties"<br/>git push</span></pre><p id="66af" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们已经基于概要文件创建了两个不同的配置文件。在代码中增加了更多的属性，你可以在这里  <strong class="ih hj">勾选<a class="ae jt" href="https://github.com/ruminder-hub/spring_cloud_config" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">。</strong></a></strong></p><h2 id="5762" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">Spring云配置服务器</h2><p id="3cab" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">我们已经创建了配置服务器接收属性的源。现在我们需要创建一个配置服务器，它将有助于微服务的配置。创建一个添加了spring config server依赖项的spring项目。如果您在创建项目后添加了spring-cloud-config-server 依赖项。您必须在dependencyManagement中添加spring-cloud依赖项。将@EnableConfigServer批注添加到Spring boot应用程序类。</p><pre class="je jf jg jh fd ku kv kw kx aw ky bi"><span id="03a8" class="ju jv hi kv b fi kz la l lb lc">@SpringBootApplication<br/>@EnableConfigServer<br/>public class SpringCloudConfigServerApplication {<br/>   public static void main(String[] args) {<br/>     SpringApplication.<em class="ld">run</em>(SpringCloudConfigServerApplication.class, args);<br/>   }<br/>}</span></pre><p id="98c3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们需要指定路径/URL，配置服务器将从这里读取属性文件中的文件。我们可以使用file、ssh或HTTP来指定git repo路径。</p><pre class="je jf jg jh fd ku kv kw kx aw ky bi"><span id="2ee4" class="ju jv hi kv b fi kz la l lb lc">spring.application.name=cloud-config-server<br/>server.port=8888<br/>spring.cloud.config.server.git.uri=https://github.com/ruminder-hub/spring_cloud_config</span></pre><p id="f0d2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我在这里使用HTTP地址，你可以通过改变路径来使用文件。你可以在我的代码中用注释找到其他选项。要验证其工作，请使用以下网址之一。</p><pre class="je jf jg jh fd ku kv kw kx aw ky bi"><span id="9b4a" class="ju jv hi kv b fi kz la l lb lc">/{application}/{profile}[/{label}]<br/>/{application}-{profile}.yml<br/>/{label}/{application}-{profile}.yml<br/>/{application}-{profile}.properties<br/>/{label}/{application}-{profile}.properties</span></pre><p id="dd96" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">application代表文件名，profile代表您想要使用的概要文件，label是branch name。<br/><strong class="ih hj">curl http://localhost:8888/config-client/development/main</strong></p><p id="d1ba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="ld"> ***如果您使用带有标签的URL，则必须提供分支名称，如果不提供，它将默认为master(在GitHub中是默认的)，但是GitHub已经将其更改为main，因此您需要在路径中提供main。</em> <strong class="ih hj"> <em class="ld"> *** </em> </strong></p><h2 id="ae2e" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">Spring云配置客户端</h2><p id="75c9" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">不，我们将创建微服务，它将使用来自配置服务器的配置。要做到这一点，服务必须声明自己是spring config服务器的客户机。为此，添加了依赖关系<strong class="ih hj">spring-cloud-starter-config</strong>。将以下值添加到属性文件中。</p><pre class="je jf jg jh fd ku kv kw kx aw ky bi"><span id="0840" class="ju jv hi kv b fi kz la l lb lc">spring.application.name=config-client spring.profiles.active=development<br/>spring.cloud.config.uri=http://localhost:8888</span></pre><p id="b6b8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们正在设置应用程序和配置文件的名称，以了解获取配置的git repo的确切文件。</p><ul class=""><li id="fc95" class="le lf hi ih b ii ij im in iq lg iu lh iy li jc lj lk ll lm bi translated">现在，即使我们设置了这些属性，服务<strong class="ih hj">也不会工作</strong>。原因:Github已经将默认分支更改为<strong class="ih hj"> main </strong>但是spring仍然认为主分支是默认的。<strong class="ih hj"> </strong>所以需要再设置一个属性<strong class="ih hj">spring . cloud . config . label = main。</strong></li><li id="179c" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">如果您使用的是最新版本的spring boot，请使用spring . config . import = config server:http://localhost:8888，而不是config.URL。</li><li id="98a5" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">要测试，请使用不同级别的API打印日志并打印database_name来创建控制器。这里的 可以找到<a class="ae jt" href="https://github.com/ruminder-hub/medium/blob/main/spring_cloud_config/spring_cloud_config_client/src/main/java/com/ruminderhub/spring_cloud_config_client/SpringCloudConfigClientApplication.java" rel="noopener ugc nofollow" target="_blank">的代码。</a></li></ul><h2 id="5d7d" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">要点</h2><ul class=""><li id="59a6" class="le lf hi ih b ii kp im kq iq ls iu lt iy lu jc lj lk ll lm bi translated">为了减少从远程获取配置的延迟，服务会在第一次获取后制作属性的本地副本。</li><li id="c349" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">您可以为不同的应用程序设置不同的git repo。</li><li id="e2e5" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">您可以控制您的服务检查配置服务器是否有任何属性更改的频率。设置<strong class="ih hj">刷新率</strong>的值</li><li id="d7e0" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">有可能配置的本地副本被破坏，即使获取了最新的副本也无法更新它。为此，您可以使用<strong class="ih hj"> force-pull </strong>来强制更新配置。</li></ul></div><div class="ab cl lv lw gp lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="hb hc hd he hf"><p id="da26" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从上面的文章中，我相信你会对在你的项目中使用Spring Cloud Config有更好的理解。如果你有任何问题，请在聊天中发表。谢了。</p></div></div>    
</body>
</html>