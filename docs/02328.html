<html>
<head>
<title>Combining Back-End and Front-End with NodeJs and ReactJs-Reset Password (Part 8)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将后端和前端与NodeJs和ReactJs结合起来——重置密码(第8部分)</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/combining-back-end-and-front-end-with-nodejs-and-reactjs-reset-password-part-8-a53398d11747?source=collection_archive---------4-----------------------#2021-05-11">https://medium.com/geekculture/combining-back-end-and-front-end-with-nodejs-and-reactjs-reset-password-part-8-a53398d11747?source=collection_archive---------4-----------------------#2021-05-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/dc8a657834cf3e1feb96769997a22d33.png" data-original-src="https://miro.medium.com/v2/resize:fit:896/format:webp/0*IsjHTqMe1s7HENFb.jpg"/></div></figure><p id="c8a9" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在这篇文章中，我将解释如何编码忘记/重置密码，如何发送电子邮件，以及如何将这些文件与前端结合起来。如果你没看过我之前的文章，可以去我的简介。让我们从忘记密码开始。</p><p id="a248" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">首先，我们需要mailgun。我们去mailgun网站并添加一个帐户。注册申请是免费的，所以你可以免费使用。之后，我们将在终端中编写npm install mailgun-js并安装包。我们将转到controllers/auth.js文件，将mailgun-js作为mailgun导入，并删除其中的register方法，我们将重新编写它。</p><p id="dc06" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在，我们要去</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="3115" class="jt ju hi jp b fi jv jw l jx jy"><a class="ae jz" href="https://app.mailgun.com/app/dashboard" rel="noopener ugc nofollow" target="_blank">https://app.mailgun.com/app/dashboard</a></span></pre><p id="1cb8" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">还有发送/总览，复制链接没有？，将其粘贴到域变量中。</p><p id="142a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">然后我们将创建另一个变量:</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="5ee6" class="jt ju hi jp b fi jv jw l jx jy"><em class="ka">const mg = mailgun({apiKey: process.env.MAILGUN_APIKEY, domain: DOMAIN});</em></span></pre><p id="b516" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们需要MAILGUN_APIKEY，所以我们将去。env文件并创建MAILGUN_APIKEY变量。为此，在mailgun站点上，我们将单击API部分并选择Node.Js。我们将复制API密钥并将其粘贴到MAILGUN_APIKEY中。</p><p id="f9df" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">之后，我们将把forgotCode作为一个数字添加到用户数据库中。那么我们可以从forgotPassword函数开始。</p><p id="90ca" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在这个函数中，我们将向我们的用户发送一封电子邮件。在电子邮件中，我们为支票用户提供了一个6位数的代码。我将把它创建为一个全局变量，这样我们就可以在这个页面的任何地方访问它:</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="92b5" class="jt ju hi jp b fi jv jw l jx jy">let forgotToken = Math.floor(Math.random()*999999);</span></pre><p id="35c3" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">你可以用jwt来检查用户，我解释过了。该函数将是异步函数。</p><p id="6b58" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们将在请求中收到一个电子邮件地址。然后，等于req.forgotCode到forgotToken。req.forgotCode在架构中。它可以被设置，但如果我们不在activateAccount部分给它，它将是不可见的。</p><p id="0de7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在电子邮件中，我们将发送数据。数据将如下所示:</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="ec23" class="jt ju hi jp b fi jv jw l jx jy">const data = {</span><span id="6867" class="jt ju hi jp b fi kb jw l jx jy">from: ' *',</span><span id="62ab" class="jt ju hi jp b fi kb jw l jx jy">to: email,</span><span id="4209" class="jt ju hi jp b fi kb jw l jx jy">subject: '* ',</span><span id="f111" class="jt ju hi jp b fi kb jw l jx jy">html:`</span><span id="b12f" class="jt ju hi jp b fi kb jw l jx jy">&lt;h2&gt;Hello ! Please copy token that sent.&lt;/h2&gt;</span><span id="99e2" class="jt ju hi jp b fi kb jw l jx jy">&lt;p&gt;${forgotToken}&lt;/p&gt;</span><span id="f692" class="jt ju hi jp b fi kb jw l jx jy">`};</span></pre><p id="ce7b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">你可以写任何关于电子邮件的东西。只是从'到'部分将电子邮件和HTML部分必须${forgotToken}。</p><p id="e352" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">然后，我们使用mg变量来发送数据。</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="cba7" class="jt ju hi jp b fi jv jw l jx jy">mg.messages().send(data, function (<em class="ka">error</em>, <em class="ka">body</em>) {</span><span id="6c22" class="jt ju hi jp b fi kb jw l jx jy">if(<em class="ka">error</em>){</span><span id="8f65" class="jt ju hi jp b fi kb jw l jx jy">return <em class="ka">res</em>.json({</span><span id="223a" class="jt ju hi jp b fi kb jw l jx jy">message: <em class="ka">error</em>.message</span><span id="cc61" class="jt ju hi jp b fi kb jw l jx jy">})<br/>}</span><span id="2789" class="jt ju hi jp b fi kb jw l jx jy">return <em class="ka">res</em>.json({</span><span id="6ebc" class="jt ju hi jp b fi kb jw l jx jy">message : "email has been send"</span><span id="eddf" class="jt ju hi jp b fi kb jw l jx jy">})<br/>});</span></pre><p id="9cd4" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果发送函数返回成功，邮件将被发送。然后我们会重设密码。为此，我们将创建一个resetPassword函数。</p><p id="a9b5" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在resetPassword中，我们请求三个变量:forgotCode、email和Password。该电子邮件将用于在数据库中搜索。</p><p id="0f3a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果forgotCode存在并且等于forgotToken，那么我们将搜索数据库并用新密码重置密码。代码在这里:</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="3181" class="jt ju hi jp b fi jv jw l jx jy">const {forgotCode, email, password } = <em class="ka">req</em>.body;</span><span id="406a" class="jt ju hi jp b fi kb jw l jx jy">if(forgotCode){</span><span id="252a" class="jt ju hi jp b fi kb jw l jx jy">if(forgotCode == forgotToken){</span><span id="df7a" class="jt ju hi jp b fi kb jw l jx jy">const user = await User.findOne({email: email})</span><span id="4828" class="jt ju hi jp b fi kb jw l jx jy">user.password = password;</span><span id="86d6" class="jt ju hi jp b fi kb jw l jx jy">user.save();</span><span id="9d48" class="jt ju hi jp b fi kb jw l jx jy"><em class="ka">res</em>.status(200).json({</span><span id="73f0" class="jt ju hi jp b fi kb jw l jx jy">success: true</span><span id="f2bf" class="jt ju hi jp b fi kb jw l jx jy">})</span><span id="9208" class="jt ju hi jp b fi kb jw l jx jy">}else{</span><span id="661c" class="jt ju hi jp b fi kb jw l jx jy"><em class="ka">res</em>.status(400).json({</span><span id="cdf4" class="jt ju hi jp b fi kb jw l jx jy">success: false,</span><span id="7d7c" class="jt ju hi jp b fi kb jw l jx jy">message: "Wrong code!"</span><span id="33ea" class="jt ju hi jp b fi kb jw l jx jy">})<br/>}<br/>}</span></pre><p id="b216" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在，我们将使用这两个。为此，我们将转到routes/auth.js文件并添加以下代码:</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="999a" class="jt ju hi jp b fi jv jw l jx jy">router.post('/forgotPassword', forgotPassword);</span><span id="c2e3" class="jt ju hi jp b fi kb jw l jx jy">router.put('/resetPassword', resetPassword);</span></pre><p id="96af" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">ForgotPassword是post请求，resetPassword是put请求。</p><p id="4858" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">后端部分结束了，我们来创建两个页面:ForgotPassword.js和ResetPassword.js，前端部分在这里:</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="2f03" class="jt ju hi jp b fi jv jw l jx jy">&lt;div <em class="ka">className</em>="wrapper1"&gt;</span><span id="abd2" class="jt ju hi jp b fi kb jw l jx jy">&lt;div <em class="ka">className</em>="form-wrapper"&gt;</span><span id="3155" class="jt ju hi jp b fi kb jw l jx jy">&lt;h1&gt;Forgot Password&lt;/h1&gt;</span><span id="5191" class="jt ju hi jp b fi kb jw l jx jy">&lt;form &gt;</span><span id="b7f1" class="jt ju hi jp b fi kb jw l jx jy">&lt;div <em class="ka">className</em>="email"&gt;</span><span id="2561" class="jt ju hi jp b fi kb jw l jx jy">&lt;label <em class="ka">htmlFor</em>="email"&gt;&lt;/label&gt;</span><span id="88ff" class="jt ju hi jp b fi kb jw l jx jy">&lt;input</span><span id="1c44" class="jt ju hi jp b fi kb jw l jx jy"><em class="ka">type</em>="text"</span><span id="c51e" class="jt ju hi jp b fi kb jw l jx jy"><em class="ka">className</em>=""</span><span id="9ae8" class="jt ju hi jp b fi kb jw l jx jy"><em class="ka">placeholder</em>="E-mail"</span><span id="70ca" class="jt ju hi jp b fi kb jw l jx jy"><em class="ka">type</em>="email"</span><span id="715e" class="jt ju hi jp b fi kb jw l jx jy"><em class="ka">name</em>="email"<br/>/&gt;</span><span id="3c04" class="jt ju hi jp b fi kb jw l jx jy">&lt;/div&gt;</span><span id="93d7" class="jt ju hi jp b fi kb jw l jx jy">&lt;button <em class="ka">className</em> = "buttonsign"</span><span id="2dab" class="jt ju hi jp b fi kb jw l jx jy"><em class="ka">value</em> = "Confirm"</span><span id="0ab3" class="jt ju hi jp b fi kb jw l jx jy">&gt;</span><span id="3aae" class="jt ju hi jp b fi kb jw l jx jy">&lt;h5&gt;Confirm &lt;/h5&gt;</span><span id="bb1c" class="jt ju hi jp b fi kb jw l jx jy">&lt;/button&gt;</span><span id="3c4a" class="jt ju hi jp b fi kb jw l jx jy">&lt;/form&gt;</span><span id="2fbb" class="jt ju hi jp b fi kb jw l jx jy">&lt;/div&gt;</span><span id="2416" class="jt ju hi jp b fi kb jw l jx jy">&lt;/div&gt;</span></pre><p id="808f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们会把它写到函数的返回部分。然后，我们将使用useState(" ")来设置电子邮件。在function中，我们也将创建一个新的异步函数，名为forgotPassword。</p><p id="3099" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在forgotPassword中，我们将一个名为item和equals的变量赋给email。</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="0653" class="jt ju hi jp b fi jv jw l jx jy">let result = await fetch("http://localhost:5000/forgotPassword",</span><span id="0908" class="jt ju hi jp b fi kb jw l jx jy">{</span><span id="bb7c" class="jt ju hi jp b fi kb jw l jx jy">method: "POST",</span><span id="835d" class="jt ju hi jp b fi kb jw l jx jy">body:JSON.stringify(item),</span><span id="3246" class="jt ju hi jp b fi kb jw l jx jy">headers: {</span><span id="0494" class="jt ju hi jp b fi kb jw l jx jy">"Content-Type":"application/json",</span><span id="f172" class="jt ju hi jp b fi kb jw l jx jy">"Accept":"application/json"</span><span id="b3a4" class="jt ju hi jp b fi kb jw l jx jy">}</span><span id="9e58" class="jt ju hi jp b fi kb jw l jx jy">}).then(history.push("/resetPassword")) // redirect to page</span><span id="d493" class="jt ju hi jp b fi kb jw l jx jy">result = await result.json()</span><span id="38de" class="jt ju hi jp b fi kb jw l jx jy">console.log("result", result)</span></pre><p id="a8cd" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在，我们将在如下按钮中使用该函数:</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="7f27" class="jt ju hi jp b fi jv jw l jx jy"><em class="ka">onClick</em>={forgotPassword}</span></pre><p id="28f9" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在div中，我们将添加以下代码:</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="ddfc" class="jt ju hi jp b fi jv jw l jx jy"><em class="ka">onChange</em> =  {(<em class="ka">e</em>) =&gt; setEmail(<em class="ka">e</em>.target.value)}</span></pre><p id="f3d4" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在我们将转到resetPassword页面。在这个页面上，我们有三个div和一个按钮。电子邮件、resetToken和newPassword有三个部分。我们将用useState(" ")来设置它们。我们将像这样创建一个名为resetPassword的异步函数:</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="d505" class="jt ju hi jp b fi jv jw l jx jy">const resetPassword = async (<em class="ka">e</em>) =&gt; {</span><span id="3a81" class="jt ju hi jp b fi kb jw l jx jy">let item = { email, newPassword, resetToken }</span><span id="46d3" class="jt ju hi jp b fi kb jw l jx jy">console.log(item)</span><span id="8536" class="jt ju hi jp b fi kb jw l jx jy">let result = await fetch("http://localhost:5000/resetPassword",</span><span id="d573" class="jt ju hi jp b fi kb jw l jx jy">{</span><span id="f281" class="jt ju hi jp b fi kb jw l jx jy">method: "PUT",</span><span id="b4a6" class="jt ju hi jp b fi kb jw l jx jy">body:JSON.stringify(item)</span><span id="822e" class="jt ju hi jp b fi kb jw l jx jy">}).then(history.push("/") )</span><span id="6082" class="jt ju hi jp b fi kb jw l jx jy">result = await result.json()</span><span id="274f" class="jt ju hi jp b fi kb jw l jx jy">console.log("result", result)</span></pre><p id="da3a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">然后，在div中使用set函数，如下所示:</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="4842" class="jt ju hi jp b fi jv jw l jx jy"><em class="ka">onChange</em> =  {(<em class="ka">e</em>) =&gt; setEmail(<em class="ka">e</em>.target.value)}</span></pre><p id="9176" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">并像这样使用resetPassword函数:</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="c75c" class="jt ju hi jp b fi jv jw l jx jy"><em class="ka">onClick</em>={resetPassword}</span></pre><p id="b25f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在这些之后，如果你去localhost:3000/forgotPassword，你可以看到输入和一个按钮。如果你写了一封电子邮件，存在于数据库中，一个随机代码将被发送，你将重定向到重置密码页面。在这个页面上，您可以看到三个输入和一个按钮。如果您写入真值，密码将被更改。</p><p id="59ee" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">就是这样！本文已完成，感谢阅读。</p></div></div>    
</body>
</html>