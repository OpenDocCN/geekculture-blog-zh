<html>
<head>
<title>Understanding Monarch, Google’s Planet-Scale Monitoring System</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">了解Monarch，谷歌的全球监测系统</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/understanding-monarch-googles-planet-scale-monitoring-system-60e59b63ac0c?source=collection_archive---------7-----------------------#2021-05-20">https://medium.com/geekculture/understanding-monarch-googles-planet-scale-monitoring-system-60e59b63ac0c?source=collection_archive---------7-----------------------#2021-05-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="0489" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Monarch是Google开发的一个星球级内存时间序列数据库。它主要是作为一个可靠的监控系统被谷歌的内部系统使用，如Spanner，BigTable，Colossus，BlobStore。</p><p id="54c0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就像任何谷歌服务一样，它必须被设计成大规模、高可用性、支持区域性。另一个对Monarch很重要的用例是尽可能少地依赖其他Google服务，因为其他服务都在使用Monarch进行自己的监控，任何一个服务中断都会影响到另一个服务。</p><p id="f19c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Monarch是一种必须高度可用和分区的服务，因此它通过在整合一致性延迟的情况下向客户端服务提供所需的提示来损害一致性。</p><p id="e4fd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">君主尝试</p><h2 id="8292" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated"><strong class="ak">数据存储:</strong></h2><p id="02ac" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">数据以两种格式存储:</p><ul class=""><li id="c2fc" class="kd ke hi ih b ii ij im in iq kf iu kg iy kh jc ki kj kk kl bi translated"><strong class="ih hj">叶</strong>是实际监控数据存储在内存中的组件</li><li id="bffb" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated"><strong class="ih hj">日志</strong>是持久性存储，可用于在组件故障的情况下重放事件</li></ul><h2 id="bf85" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">数据摄取</h2><p id="b174" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">数据接收管道尝试遵循以下准则:</p><ul class=""><li id="2d23" class="kd ke hi ih b ii ij im in iq kf iu kg iy kh jc ki kj kk kl bi translated">将客户端服务的数据存储在尽可能靠近服务操作区域的地方，以使网络延迟最小</li><li id="94c4" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">将客户服务的数据存储在同一个叶中，因为数据查询很有可能集中在该叶上以获得更快的查询响应</li></ul><figure class="ks kt ku kv fd kw er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es kr"><img src="../Images/3bbb89de50aa84010a1e0b50cea5660d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Wp9T_r-lVewq1l9r5l3GUQ.png"/></div></div><figcaption class="ld le et er es lf lg bd b be z dx">Fig: Monarch components layout (from <a class="ae lh" href="https://www.vldb.org/pvldb/vol13/p3181-adams.pdf" rel="noopener ugc nofollow" target="_blank">https://www.vldb.org/pvldb/vol13/p3181-adams.pdf</a>)</figcaption></figure><p id="e49b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">数据遍历将以下列方式进行:</p><ul class=""><li id="fa0b" class="kd ke hi ih b ii ij im in iq kf iu kg iy kh jc ki kj kk kl bi translated"><strong class="ih hj">接收路由器</strong>将数据路由到叶路由器</li><li id="9a67" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated"><strong class="ih hj">叶子路由器</strong>将数据路由到叶子</li><li id="63e7" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated"><strong class="ih hj">范围分配器</strong>决定存储数据的叶子</li></ul><p id="782c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">摄取路由器根据位置字段将时间序列数据区域化到区域中，而叶路由器根据范围分配器在叶之间分发数据</p><figure class="ks kt ku kv fd kw er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es li"><img src="../Images/a38b9e944746dcf33c2a51568117f34d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MkzytmvSiea3RybHtdMUCQ.png"/></div></div><figcaption class="ld le et er es lf lg bd b be z dx">Fig: Data Format layout(from <a class="ae lh" href="https://www.vldb.org/pvldb/vol13/p3181-adams.pdf" rel="noopener ugc nofollow" target="_blank">https://www.vldb.org/pvldb/vol13/p3181-adams.pdf</a>)</figcaption></figure><p id="33fe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">收到的数据有以下几类:</p><p id="6dca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">目标</strong>用于标识数据已经生成的节点/服务/组件表单。基于上图，一个目标字符串<strong class="ih hj"><em class="lj">ComputeTask::SQL-DBA::db . server::aa::0876</em></strong>代表一个数据库服务器的Borg任务。目标字符串的格式在叶之间的数据放置中很重要，因为目标范围用于字典式分片和叶之间的负载平衡。</p><p id="a096" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">指标</strong>包含键-值对格式的指标信息，其中键是目标的指标类型，值是基于时间序列的数据点。支持的度量类型有布尔值、int64、double、字符串、分布或其他类型的元组。度量值可以是累积的或标准的。使用累积点的优点是间歇性的数据丢失不会对分布产生太大影响。</p><p id="c371" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">数据可以在<strong class="ih hj">增量时间序列</strong>中发送，其中仅发送时间序列数据中的增量，而不是整个度量。这减少了数据的连续输入，并且只需要处理数据范围的变化。</p><p id="6bd6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">分桶</strong>有助于在将数据点发送到摄取管道之前，在一定时间内聚合数据点。这减少了网络处理，并且可以执行批量插入。</p><p id="70c4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">准入窗口</strong>用于拒绝在特定持续时间之后接收的查询，从而可以避免处理在特定持续时间之后接收的数据的压力。</p><h2 id="6ab5" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">数据查询</h2><p id="2f0d" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">Monarch提供了一个全局联合查询引擎。所有查询都可以在全局级别触发，Monarch负责将查询路由到存储相关数据的树叶，并合并树叶的响应。</p><p id="d469" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在上图中可以看到的用于数据查询的组件如下:</p><ul class=""><li id="12bf" class="kd ke hi ih b ii ij im in iq kf iu kg iy kh jc ki kj kk kl bi translated"><strong class="ih hj">混合器</strong>将查询分解成子查询，并合并来自子查询的响应。根混合器接收查询并将它们扇出到区域混合器，区域混合器进一步将其扇出到叶子，从而形成<strong class="ih hj">查询树</strong>。混合器还检查索引服务器，将查询限制在数据所在的区域或叶</li><li id="ca72" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated"><strong class="ih hj">索引服务器</strong>索引每个区域和叶的数据，这些数据可用于了解查询针对哪些叶</li><li id="9e92" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated"><strong class="ih hj">评估器</strong>从持续查询中生成响应，并将数据写回树叶</li></ul><p id="ff85" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Monarch的<strong class="ih hj">查询语言</strong>支持以下关键字:</p><ul class=""><li id="24df" class="kd ke hi ih b ii ij im in iq kf iu kg iy kh jc ki kj kk kl bi translated">取得</li><li id="3705" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">过滤器</li><li id="7665" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">加入</li><li id="4bf8" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">排列</li><li id="fa94" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">分组依据</li></ul><p id="9e83" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">特殊查询</strong>是来自系统外用户的查询。</p><p id="fc31" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">常备查询</strong>是类似于其他数据库系统中视图的查询。长期查询会定期计算并存储回Monarch，以获得更快的查询响应。</p><p id="0e33" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于可以根据查询的广度在区域或根级别进行评估，所以固定查询的性能也更高。这将查询空间最小化到特定于区域的树叶。</p><p id="bf78" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">对查询进行级别分析</strong>，基于不同的身份验证级别和更好的查询局部性来分解查询。可以基于上面提到的查询树来定义级别。</p><p id="c067" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">副本解析</strong>用于找出回答查询的最佳副本，因为在查询负载、系统配置等方面可能存在差异，这使得某个副本更适合于响应。</p><p id="d50f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">用户隔离</strong>限制任何用户在系统中可以使用的内存量，这样其他遵守规则的用户就不会受到影响。</p><h2 id="3577" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">表演</h2><ul class=""><li id="3b47" class="kd ke hi ih b ii jy im jz iq lk iu ll iy lm jc ki kj kk kl bi translated">Monarch在五大洲的38个地区经营。它有大约40万个任务</li><li id="d30f" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">截至2019年7月，Monarch存储了近9500亿个时间序列，使用了约750TB的内存和高度优化的数据结构</li><li id="919f" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">2019年7月，Monarch的内部部署每秒钟吸收了约4.4万亿字节的数据</li><li id="d0a8" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">Monarch持续指数增长，截至2019年7月，每秒钟服务超过600万次查询。</li></ul><figure class="ks kt ku kv fd kw er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es ln"><img src="../Images/0936b0545df2726ea7278df84ea472c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qfpVOf2yse9pnZ6v0Qqo_g.png"/></div></div><figcaption class="ld le et er es lf lg bd b be z dx">Fig: Performance(from <a class="ae lh" href="https://www.vldb.org/pvldb/vol13/p3181-adams.pdf" rel="noopener ugc nofollow" target="_blank">https://www.vldb.org/pvldb/vol13/p3181-adams.pdf</a>)</figcaption></figure><p id="ca6f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我希望你喜欢这篇文章。如果你对这篇文章有任何疑问，请告诉我。快乐阅读！！T3】</p><p id="0218" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">参考资料:</p><ul class=""><li id="3452" class="kd ke hi ih b ii ij im in iq kf iu kg iy kh jc ki kj kk kl bi translated">【https://www.vldb.org/pvldb/vol13/p3181-adams.pdf T4】</li></ul></div></div>    
</body>
</html>