<html>
<head>
<title>Simple steps to enable CORS in API Gateway through console/cloud formation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过控制台/云结构在API网关中启用CORS的简单步骤</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/simple-steps-to-enable-cors-in-api-gateway-through-console-cloud-formation-c09d9df31c07?source=collection_archive---------4-----------------------#2021-06-20">https://medium.com/geekculture/simple-steps-to-enable-cors-in-api-gateway-through-console-cloud-formation-c09d9df31c07?source=collection_archive---------4-----------------------#2021-06-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="53eb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">什么是CORS？</p><p id="2793" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">跨来源资源共享</strong> ( <a class="ae jd" href="https://developer.mozilla.org/en-US/docs/Glossary/CORS" rel="noopener ugc nofollow" target="_blank"> CORS </a>)是一种基于HTTP报头的机制，它允许服务器指示除了它自己以外的任何其他<a class="ae jd" href="https://developer.mozilla.org/en-US/docs/Glossary/Origin" rel="noopener ugc nofollow" target="_blank">来源</a>(域、方案或端口)，浏览器应该允许从这些来源加载资源。CORS还依赖于一种机制，通过这种机制，浏览器向托管跨源资源的服务器发出“预检”请求，以检查服务器是否允许实际的请求。在该预检中，浏览器发送指示HTTP方法的标题和将在实际请求中使用的标题。</p><p id="a6d4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们看看如何启用API网关中的CORS来限制只能通过特定域访问API。</p><p id="4bdd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们有之前创建的API，它基于URI路径返回文件。我们将使用这个API来配置CORS设置。</p><p id="340b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果没有启用CORS，可以通过公共IP和域访问该API。但是，要通过私有服务器/域访问该API或限制通过特定服务器访问API，我们必须通过控制台启用CORS设置。</p><p id="22c9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我创建了一个简单的脚本来调用AWS Rest API，并将其部署到一个私有VM。我们将通过私有IP地址访问脚本，并研究启用和禁用cors时API的行为。</p><p id="bcee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">test-cors-script.html</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="a259" class="jn jo hi jj b fi jp jq l jr js">&lt;html&gt;<br/>  &lt;head&gt; &lt;/head&gt;<br/>  &lt;body&gt;<br/>    &lt;p&gt;Testing CORS API&lt;/p&gt;<br/>    &lt;script type="text/javascript"&gt;<br/>      var apiUrl =<br/>        "<a class="ae jd" href="https://gmtrzm0ank.execute-api.us-west-2.amazonaws.com/dev/config" rel="noopener ugc nofollow" target="_blank">https://gmtrzm0ank.execute-api.us-west-2.amazonaws.com/dev/config</a>";<br/>      fetch(apiUrl, {<br/>    method: "GET"<br/>   })<br/>        .then((response) =&gt; {<br/>          return response.json();<br/>        })<br/>        .then((data) =&gt; {<br/>          console.log("data ", data);<br/>        })<br/>        .catch((err) =&gt; {<br/>          console.log("error ", err);<br/>        });<br/>    &lt;/script&gt;<br/>  &lt;/body&gt;<br/>&lt;/html&gt;</span></pre><figure class="je jf jg jh fd ju er es paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="er es jt"><img src="../Images/62b2d1d5f1ac1d5a3b1d310c19e99cf7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lgDkGSEEJZa03xtY2cbuiw.png"/></div></div></figure><p id="4b15" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">部署了使用S3服务返回test.json文件内容的API。</p><figure class="je jf jg jh fd ju er es paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="er es kb"><img src="../Images/73a840a0532bd5f66310d2d758844f48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E5DJqM61dVrj6YqaYq7iWQ.png"/></div></div></figure><p id="2434" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">目前，我们刚刚部署了API，还没有启用cors，让我们首先检查从浏览器调用API时的行为。</p><figure class="je jf jg jh fd ju er es paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="er es kc"><img src="../Images/399f70fa88a82cb4d15f6084d90016a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6IYus0Svq0wPu09rqziy1g.png"/></div></div></figure><p id="52e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当从浏览器调用时，API会按预期返回文件的内容。</p><p id="546c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们通过从私有VM运行我们的脚本来调用相同的API，我们将在开发人员的控制台中检查API的响应。</p><figure class="je jf jg jh fd ju er es paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="er es kd"><img src="../Images/1d088491518a4b1422ff064a5128b651.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fwvuvtPv2AMDEUJ1baRN_A.png"/></div></div></figure><p id="3e35" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如我们所看到的，当我们试图通过私有服务器访问它时，我们的脚本无法从同一个API获取响应。它给出了CORS标准误差。</p><p id="47d2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们将为我们的API启用CORS，然后将检查响应。要启用CORS，请转到API网关，单击我们要启用CORS的方法。单击操作并启用CORS。</p><figure class="je jf jg jh fd ju er es paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="er es ke"><img src="../Images/5ab2edee9f0d1dcd489dfe3b21f9acf4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IQjGmtUD3tDPPfauZcidjA.png"/></div></div></figure><figure class="je jf jg jh fd ju er es paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="er es kf"><img src="../Images/e29182fb9ce75dd56933229122294057.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*scFBA8QSMZTx3b53g0gOiw.png"/></div></div></figure><p id="fcb8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">选择所有选项来处理错误响应。如果您的API返回像x-api-key这样的额外头，您可以添加access-control-allow-headers。您还可以在access-control-allow-origin中指定域，以限制API只能通过特定的服务器进行访问，或者如果您希望API可以从任何地方进行访问，也可以加上' * '。</p><figure class="je jf jg jh fd ju er es paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="er es kg"><img src="../Images/667342a41b6962449a38ce66fb65d8fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HayS1NlH995rAW5PPfzh9Q.png"/></div></div></figure><p id="9834" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当您使用AWS管理控制台启用CORS时，API Gateway会创建一个“选项”方法，并尝试将Access-Control-Allow-Origin标头添加到现有的方法集成响应中。这个方法确保来自API的响应具有批准您的请求所需的头和域。启用CORS后，我们必须再次部署API，以使更改对API产生影响。</p><p id="e6b8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如您在下面看到的，现在我们能够从私有服务器通过脚本访问我们的AWS API。</p><figure class="je jf jg jh fd ju er es paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="er es kh"><img src="../Images/2fb91c007d3394341575064d5c6d361c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8Xj5prhyqZmpUqE_NgFUHg.png"/></div></div></figure><p id="70b1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您还可以在CORS指定一个特定的域，以便只通过特定的服务器访问您的API。</p><figure class="je jf jg jh fd ju er es paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="er es ki"><img src="../Images/d2f8c92d501d5d7ea06b9a237315e663.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LGuv1XBZA8ajIj6wgf4WJQ.png"/></div></div></figure><p id="af66" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">启用后，API将只能从“www.myserver.com”访问它。当我们试图从不同的服务器或浏览器访问API时，它会给出如下所示的CORS错误。</p><figure class="je jf jg jh fd ju er es paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="er es kj"><img src="../Images/9050d8af4b07257b0c4cc40d8432190d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w0SFZPC3dGKAvYqwuBOBmw.png"/></div></div></figure><p id="3442" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以这都是关于如何在API网关中启用CORS。为了从云形成中配置相同的设置，我已经在<a class="ae jd" href="https://github.com/Rohan009/aws_s3_api_binary_files" rel="noopener ugc nofollow" target="_blank">https://github.com/Rohan009/aws_s3_api_binary_files</a>上传了所有需要的YAML和部署文件</p><p id="228d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面的链接包含了yaml中配置cors的allowedOriginHost参数和swagger定义。</p><p id="5a6e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">谢谢你。</p></div></div>    
</body>
</html>