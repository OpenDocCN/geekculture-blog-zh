<html>
<head>
<title>Automatically run Cypress tests on every code push with GitHub Action and Docker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用GitHub Action和Docker在每次代码推送时自动运行Cypress测试</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/automatically-run-cypress-tests-on-every-code-push-with-github-action-and-docker-f6f305632fc5?source=collection_archive---------5-----------------------#2021-07-29">https://medium.com/geekculture/automatically-run-cypress-tests-on-every-code-push-with-github-action-and-docker-f6f305632fc5?source=collection_archive---------5-----------------------#2021-07-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/d7e88c80fc69a964b48f8bb40cf0648d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*W0JB93S_pClp6MRv.png"/></div></div></figure><p id="3e38" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">自从我在Amazon Mechanical Turk上发布了用于众包图像分割注释的Turkey <a class="ae jo" href="https://github.com/yanfengliu/turkey" rel="noopener ugc nofollow" target="_blank">知识库</a>以来，我一直在思考如何使用软件工程的最佳实践来不断改进它。我最近实现的一个关键改进是让GitHub repo在每次代码推送时运行完整的系统测试。它是完全自动化的、一致的、不受环境限制的、免费的。</p><h1 id="ce00" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">1.火鸡</h1><p id="1f5f" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">我正在测试的产品叫做<code class="du ks kt ku kv b">Turkey</code>。这是一个HTML文件，你可以粘贴到亚马逊机械土耳其人作为一个自定义的工作。它允许在同一作业中众包图像注释数据，如实例分段、边界框和线条。它支持撤消、重做、放大、缩小、拖动和重置。我在大学时做了这个，因为没有一个好的免费的在线图像注释众包解决方案，我们需要一个研究项目。</p><h1 id="b793" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">2.柏树</h1><p id="e988" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">Cypress非常适合系统测试。我计划单独写一篇关于编写好的Cypress测试的文章。就本文的范围而言，我将只谈论我使用它的目的。随着<code class="du ks kt ku kv b">Turkey</code>功能的扩展，很难跟踪它做的所有事情。手动可靠地测试所有特性更加困难。Cypress以编程方式模拟点击、拖动和输入。用户在使用我的产品时通常会做的所有事情。由于图像注释工具的性质，仅仅知道Cypress找到了渲染组件并与它们成功交互是不够的。我还需要确保图形用户界面(GUI)看起来完全符合我的预期。所以我用一个名为<code class="du ks kt ku kv b">cypress-image-snapshot</code> ( <a class="ae jo" href="https://www.npmjs.com/package/cypress-image-snapshot" rel="noopener ugc nofollow" target="_blank"> npm链接</a>)的Cypress插件包截图，并与存储版本进行对比。<code class="du ks kt ku kv b">Turkey</code>的典型测试如下所示:</p><figure class="kw kx ky kz fd ij"><div class="bz dy l di"><div class="la lb l"/></div></figure><p id="0190" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">命令<code class="du ks kt ku kv b">matchImageSnapshot</code>将只对<code class="du ks kt ku kv b">cy.get("canvas")</code>返回的内容进行截图，将其与存储的同名截图进行比较，并检查不同像素的百分比。如果百分比高于可定制的阈值，则失败。如果没有以该名称存储的截图，那么它会将新捕获的截图存储为正确答案。</p><p id="9b4b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要运行测试，首先需要在localhost上服务网站，然后运行<code class="du ks kt ku kv b">cypress run</code>。它将自动运行在cypress文件夹中找到的所有测试。您也可以使用<code class="du ks kt ku kv b">cypress open</code>来观看它的运行，但是要注意，除非被覆盖，否则这种模式可能会使用与headless模式不同的视口。分辨率差异将导致快照比较失败。</p><h1 id="9710" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">3.GitHub操作</h1><p id="c277" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">GitHub在2018年发布了他们的动作功能。很高兴在GitHub上看到对CI/CD的原生支持。通过在repo中指定一个<code class="du ks kt ku kv b">\\.github\\workflows\\github-actions.yml</code>文件，GitHub会自动选择动作定义。然后，每次请求拉或推时都会触发该操作。Cypress现在有了他们官方的GitHub动作，选项<a class="ae jo" href="https://github.com/cypress-io/github-action" rel="noopener ugc nofollow" target="_blank">相当令人印象深刻</a>。所以我开始尝试最基本的版本:</p><figure class="kw kx ky kz fd ij"><div class="bz dy l di"><div class="la lb l"/></div></figure><p id="08df" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们一行一行地检查文件:</p><ul class=""><li id="8031" class="lc ld hi is b it iu ix iy jb le jf lf jj lg jn lh li lj lk bi translated"><code class="du ks kt ku kv b">name: Turkey end-to-end tests chrome headless</code>:动作名称。除了帮助您记住它的作用之外，不会影响任何功能</li><li id="6b31" class="lc ld hi is b it ll ix lm jb ln jf lo jj lp jn lh li lj lk bi translated"><code class="du ks kt ku kv b">on: [push]</code>:此动作每隔<code class="du ks kt ku kv b">git push</code>触发一次</li><li id="6374" class="lc ld hi is b it ll ix lm jb ln jf lo jj lp jn lh li lj lk bi translated"><code class="du ks kt ku kv b">jobs:</code>定义触发动作时运行的内容。</li><li id="cdbb" class="lc ld hi is b it ll ix lm jb ln jf lo jj lp jn lh li lj lk bi translated">这也只是工作的一个名字。您可以定义多个作业。默认情况下，作业并行运行，但也可以按顺序运行。因此，在我们的例子中，我们可以运行多个作业，每个支持的浏览器一个，或者设置略有不同。</li><li id="9fe8" class="lc ld hi is b it ll ix lm jb ln jf lo jj lp jn lh li lj lk bi translated"><code class="du ks kt ku kv b">runs-on: ubuntu-20.04</code>:动作运行的操作系统。事实证明，这将对我们的系统测试结果产生影响。稍后会详细介绍。</li><li id="7f81" class="lc ld hi is b it ll ix lm jb ln jf lo jj lp jn lh li lj lk bi translated"><code class="du ks kt ku kv b">steps</code>:工作步骤。这些按顺序运行。</li><li id="540c" class="lc ld hi is b it ll ix lm jb ln jf lo jj lp jn lh li lj lk bi translated"><code class="du ks kt ku kv b">- uses: actions/checkout@v2</code>:使用版本2的社区操作，将您的回购下载到主机。</li><li id="8592" class="lc ld hi is b it ll ix lm jb ln jf lo jj lp jn lh li lj lk bi translated"><code class="du ks kt ku kv b">- uses: cypress-io/github-action@v2</code>:使用运行作业的cypress动作。它运行<code class="du ks kt ku kv b">cypress run</code>。注意，要使其工作，repo中必须有一个<code class="du ks kt ku kv b">package.json</code>文件，并且在其中有一个<code class="du ks kt ku kv b">cypress</code>作为依赖项。</li><li id="6419" class="lc ld hi is b it ll ix lm jb ln jf lo jj lp jn lh li lj lk bi translated"><code class="du ks kt ku kv b">with:</code>我们传递给cypress动作的额外设置</li><li id="df3c" class="lc ld hi is b it ll ix lm jb ln jf lo jj lp jn lh li lj lk bi translated"><code class="du ks kt ku kv b">start: npm start</code>:在运行<code class="du ks kt ku kv b">cypress run</code>之前，我们先运行<code class="du ks kt ku kv b">npm start</code>开始托管网站</li><li id="519f" class="lc ld hi is b it ll ix lm jb ln jf lo jj lp jn lh li lj lk bi translated"><code class="du ks kt ku kv b">wait-on: "&lt;http://localhost:5000&gt;"</code>:等到网站上线</li><li id="6c0a" class="lc ld hi is b it ll ix lm jb ln jf lo jj lp jn lh li lj lk bi translated"><code class="du ks kt ku kv b">browser: chrome</code>:我们在chrome上运行测试，不管cypress软件包附带的是什么版本。</li><li id="f677" class="lc ld hi is b it ll ix lm jb ln jf lo jj lp jn lh li lj lk bi translated"><code class="du ks kt ku kv b">headless: true</code>:我们使用无头模式是为了和我们在本地做的事情保持一致，也是因为我们无论如何都看不到它</li></ul><p id="8574" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我推送代码，看到动作运行，大声欢呼，看到测试失败。哪里出了问题？为了能够调试这个，我需要GitHub来保存工件，以便我可以下载截图diffs并亲自查看。所以在最后对yml文件做一点补充:</p><figure class="kw kx ky kz fd ij"><div class="bz dy l di"><div class="la lb l"/></div></figure><p id="8f95" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这告诉GitHub，如果测试失败，可以使用<code class="du ks kt ku kv b">cypress-screenshots</code>文件夹中的任何内容。它还会一直提供cypress视频，每次测试运行时都会保存下来。所以我下载了这些差异，它们看起来像这样:</p><figure class="kw kx ky kz fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lq"><img src="../Images/967087f10f370575db36634bec44eb3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-t-EAJlI-cYkB3z8R8UVgg.png"/></div></div></figure><p id="e6fc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">前后看起来和人眼一模一样，那么这是怎么回事呢？事实证明，操作系统之间的渲染是非常不同的。当测试在本地运行时，它在我的Windows 10机器上，但在GitHub Actions上，它在Ubuntu上。网站在不同的浏览器或机器上看起来也不同，即使它们运行在相同的操作系统上。物理监视器也会影响用于渲染的颜色配置文件。因此，唯一绝对确定的方法是在一致、隔离的环境中运行测试。你猜对了——我们需要码头工人。</p><h1 id="42be" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">4.码头工人</h1><p id="eedd" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">Cypress GitHub动作本身支持Docker，并且Cypress也在Docker Hub上托管了他们的官方Docker映像，所以只需一行代码，我们就可以非常容易地运行Cypress测试的Docker版本:</p><figure class="kw kx ky kz fd ij"><div class="bz dy l di"><div class="la lb l"/></div></figure><p id="8067" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这与其余的定义配合得出奇地好。工件仍然被上传，即使它们是由Docker中运行的测试生成的。现在的重点是让相同的设置在本地工作。</p><p id="e80f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">事实证明，我们不必使用《奔跑吧》所处的确切环境。我们只需要Docker默认使用的Linux环境。我们在<code class="du ks kt ku kv b">cypress/included:8.0.0</code>的基础上编写了自己的<code class="du ks kt ku kv b">Dockerfile</code>，并添加了我们在本地托管网站时使用的其他依赖项:</p><figure class="kw kx ky kz fd ij"><div class="bz dy l di"><div class="la lb l"/></div></figure><p id="ede7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du ks kt ku kv b">package.json</code>中的脚本如下所示:</p><figure class="kw kx ky kz fd ij"><div class="bz dy l di"><div class="la lb l"/></div></figure><p id="d058" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">所以<code class="du ks kt ku kv b">npm run test:chrome</code>启动网站，等待它在端口5000上准备好，然后在chrome上运行测试。我们清空了<code class="du ks kt ku kv b">cypress/screenshots</code>文件夹，这样第一次运行将会生成基本事实截图，然后我们将它们推送到回购上。这一次，测试通过了。当一切最终都运转正常时，这是一种非常令人满意的感觉。</p><h1 id="5afb" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">参考</h1><ul class=""><li id="c002" class="lc ld hi is b it kn ix ko jb lr jf ls jj lt jn lh li lj lk bi translated"><a class="ae jo" href="https://github.com/yanfengliu/turkey" rel="noopener ugc nofollow" target="_blank">https://github.com/yanfengliu/turkey</a></li><li id="b3db" class="lc ld hi is b it ll ix lm jb ln jf lo jj lp jn lh li lj lk bi translated"><a class="ae jo" href="https://docs.cypress.io/guides/continuous-integration/github-actions" rel="noopener ugc nofollow" target="_blank">https://docs . cypress . io/guides/continuous-integration/github-actions</a></li><li id="bb0e" class="lc ld hi is b it ll ix lm jb ln jf lo jj lp jn lh li lj lk bi translated">https://docs.github.com/en/actions<a class="ae jo" href="https://docs.github.com/en/actions" rel="noopener ugc nofollow" target="_blank"/></li></ul><p id="9ea9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">(这是我最初的想法<a class="ae jo" href="https://yanfeng.notion.site/Automatically-run-Cypress-tests-on-every-code-push-with-GitHub-Action-and-Docker-6283469aa9414540b982ff25156a213f" rel="noopener ugc nofollow" target="_blank">链接</a>为了更好的阅读体验)</p></div></div>    
</body>
</html>