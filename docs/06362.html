<html>
<head>
<title>How to call Google Cloud Run (or Cloud Functions) from Apps Scripts</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何从应用程序脚本调用Google Cloud Run(或云功能)</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/how-to-call-google-cloud-run-or-cloud-functions-from-apps-scripts-c0086289c965?source=collection_archive---------8-----------------------#2021-08-18">https://medium.com/geekculture/how-to-call-google-cloud-run-or-cloud-functions-from-apps-scripts-c0086289c965?source=collection_archive---------8-----------------------#2021-08-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="5754" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">这里有一个简单快捷的方法</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/b0e812b085ef8fbb157309ea634a1092.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mq8C6uHqvDmfvb6CfADiMQ.jpeg"/></div></div></figure><p id="6e4d" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><em class="kf">即使我拥有GCP项目的</em> <strong class="jl hj"> <em class="kf">所有者</em> </strong> <em class="kf">权限，我也很难从</em> <strong class="jl hj"> <em class="kf"> Apps脚本</em> </strong> <em class="kf">到</em> <strong class="jl hj"> <em class="kf">云运行</em> </strong> <em class="kf">进行认证调用。这篇文章描述了如何在不重新发明轮子的情况下做到这一点。</em></p><h2 id="a202" class="kg kh hi bd ki kj kk kl km kn ko kp kq js kr ks kt jw ku kv kw ka kx ky kz la bi translated">背景阅读</h2><p id="1705" class="pw-post-body-paragraph jj jk hi jl b jm lb ij jo jp lc im jr js ld ju jv jw le jy jz ka lf kc kd ke hb bi translated">因此，这里是我用来完成这项工作的参考资料。guillaume blaquiere 的这篇文章是一个好的开始，但并没有完全奏效:</p><div class="li lj ez fb lk ll"><a rel="noopener follow" target="_blank" href="/google-cloud/call-cloud-run-from-app-script-the-easy-way-70677086efa1"><div class="lm ab dw"><div class="ln ab lo cl cj lp"><h2 class="bd hj fi z dy lq ea eb lr ed ef hh bi translated">从应用程序脚本调用云运行:简单的方法</h2><div class="ls l"><h3 class="bd b fi z dy lq ea eb lr ed ef dx translated">在谷歌，应用脚本和云运行属于两个不同的世界，一个在云中，另一个在Workspace中。两者并用是…</h3></div><div class="lt l"><p class="bd b fp z dy lq ea eb lr ed ef dx translated">medium.com</p></div></div><div class="lu l"><div class="lv l lw lx ly lu lz jh ll"/></div></div></a></div><p id="cfe9" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">这个stackoverflow问题也帮助我拼凑出了这个谜题:</p><div class="li lj ez fb lk ll"><a href="https://stackoverflow.com/questions/66543047/call-google-cloud-functions-from-app-scripts" rel="noopener  ugc nofollow" target="_blank"><div class="lm ab dw"><div class="ln ab lo cl cj lp"><h2 class="bd hj fi z dy lq ea eb lr ed ef hh bi translated">从应用程序脚本调用谷歌云功能</h2><div class="ls l"><h3 class="bd b fi z dy lq ea eb lr ed ef dx translated">感谢贡献一个堆栈溢出的答案！请务必回答问题。提供详细信息并分享…</h3></div><div class="lt l"><p class="bd b fp z dy lq ea eb lr ed ef dx translated">stackoverflow.com</p></div></div><div class="lu l"><div class="ma l lw lx ly lu lz jh ll"/></div></div></a></div><p id="055c" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">仅供参考，这是由<a class="lg lh ge" href="https://medium.com/u/b78c1a5c6205?source=post_page-----c0086289c965--------------------------------" rel="noopener" target="_blank"> salmaan rashid </a>提供的关于用于身份验证的不同GCP令牌的很好资源:</p><div class="li lj ez fb lk ll"><a rel="noopener follow" target="_blank" href="/google-cloud/authenticating-using-google-openid-connect-tokens-e7675051213b"><div class="lm ab dw"><div class="ln ab lo cl cj lp"><h2 class="bd hj fi z dy lq ea eb lr ed ef hh bi translated">使用Google OpenID连接令牌进行身份验证</h2><div class="ls l"><h3 class="bd b fi z dy lq ea eb lr ed ef dx translated">越来越多部署在Google Cloud上的服务可以默认启用自动预认证…</h3></div><div class="lt l"><p class="bd b fp z dy lq ea eb lr ed ef dx translated">medium.com</p></div></div></div></a></div><h1 id="4a03" class="mb kh hi bd ki mc md me km mf mg mh kq io mi ip kt ir mj is kw iu mk iv kz ml bi translated">逐步地</h1><ol class=""><li id="637e" class="mm mn hi jl b jm lb jp lc js mo jw mp ka mq ke mr ms mt mu bi translated">确保应用程序脚本与云运行服务在同一个GCP项目中。没有这一点，它几乎是没有希望的。谷歌有手册解释如何设置应用Sritps项目<a class="ae mv" href="https://developers.google.com/apps-script/guides/cloud-platform-projects#standard_cloud_platform_projects" rel="noopener ugc nofollow" target="_blank">这里</a>。</li></ol><p id="278e" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">项目级别的认证和授权工作。默认情况下， Apps脚本创建一个<strong class="jl hj">隐藏的</strong> GCP项目。因此，如果您希望应用程序脚本与其他GCP服务交互，您需要将应用程序脚本的执行移动到目标GCP项目。</p><p id="321b" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><strong class="jl hj"> 2。在您的GCP项目</strong>中，启用<em class="kf">API&amp;服务</em>下的OAuth同意屏幕</p><p id="31e4" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">这是一个强制性的步骤，有许多手册描述了如何去做。<a class="ae mv" href="https://support.google.com/cloud/answer/6158849?hl=en#" rel="noopener ugc nofollow" target="_blank">这里的</a>是GCP一号。同意屏幕允许有权访问给定项目的用户向OAuth 2.0客户端授予代表他们访问服务的权限。只要选择一个测试或内部类型的应用程序，以避免代表谷歌的验证，只要这只是为了内部目的。然后将您的电子邮件帐户添加到测试用户列表中。</p><p id="b739" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><strong class="jl hj"> 3。该应用程序脚本函数调用GCP云运行服务</strong></p><pre class="iy iz ja jb fd mw mx my mz aw na bi"><span id="1d98" class="kg kh hi mx b fi nb nc l nd ne">CLOUD_RUN_URL="https://cloud-run-base-url";</span><span id="f7de" class="kg kh hi mx b fi nf nc l nd ne">function callCloudRun() {<br/> // Use the OpenID token inside App Scripts<br/> const token = ScriptApp.getIdentityToken();</span><span id="4787" class="kg kh hi mx b fi nf nc l nd ne">var options = {<br/>  'method' : 'get',<br/>  'headers': {'Authorization': 'Bearer ' + token},<br/> };</span><span id="2998" class="kg kh hi mx b fi nf nc l nd ne">// call the server<br/> var response = UrlFetchApp.fetch(CLOUD_RUN_URL + '/hello', options);</span><span id="2400" class="kg kh hi mx b fi nf nc l nd ne">}</span></pre><p id="99f9" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">将使用应用程序脚本OAuth 2.0客户端调用云运行服务，您可以在GCP的<em class="kf">API&amp;服务&gt;凭证</em>下看到:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ng"><img src="../Images/a28371bbceba2626e65df5aa8893c852.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B_0ILKQPSs4T2qlHVpl41g.png"/></div></div></figure><p id="cbcf" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">在请求的授权头中，上面的代码将<a class="ae mv" href="https://openid.net/specs/openid-connect-core-1_0.html" rel="noopener ugc nofollow" target="_blank"> OpenID </a>令牌解码后看起来像这样:</p><pre class="iy iz ja jb fd mw mx my mz aw na bi"><span id="84e4" class="kg kh hi mx b fi nb nc l nd ne">{<br/> at_hash=xxxxxxx,<br/> sub=xxxxxxx,<br/> aud=app-scripts-oauth2.0-client-id.apps.googleusercontent.com,<br/> email_verified=true,<br/> iss=<a class="ae mv" href="https://accounts.google.com" rel="noopener ugc nofollow" target="_blank">https://accounts.google.com</a>,<br/> hd=example.com,<br/> exp=1628072693,<br/> iat=1628069093,<br/> <a class="ae mv" href="mailto:email=name@example.com" rel="noopener ugc nofollow" target="_blank">email=name@example.com</a><br/>}</span></pre><p id="a2e9" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">它告诉GCP防火墙是谁发出的请求，如果令牌是有效的，并且用户被授权访问服务或API，它将通过。</p><p id="2ee3" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><strong class="jl hj"> 4。编辑应用程序脚本清单</strong></p><p id="9767" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">Apps脚本有一个名为<code class="du nh ni nj mx b">appsscripts.json</code>的JSON配置文件，它通常是自动生成的。这里的解释了如何访问它<a class="ae mv" href="https://developers.google.com/apps-script/concepts/manifests" rel="noopener ugc nofollow" target="_blank">。在<code class="du nh ni nj mx b">oauthScopes</code>下面添加三个额外的示波器。它们允许一个脚本访问GCP，并生成上面提到的OpenID令牌。</a></p><pre class="iy iz ja jb fd mw mx my mz aw na bi"><span id="1221" class="kg kh hi mx b fi nb nc l nd ne">"oauthScopes": [<br/>  ...,<br/>  "https://www.googleapis.com/auth/script.container.ui",<br/>  "https://www.googleapis.com/auth/cloud-platform",<br/>  "openid"<br/>]</span></pre><p id="1c80" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><strong class="jl hj"> 5。最后一英里是最棘手的！</strong></p><p id="381f" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">最后一部分来自GCP官方关于云运行的文档。</p><blockquote class="nk nl nm"><p id="0c7d" class="jj jk kf jl b jm jn ij jo jp jq im jr nn jt ju jv no jx jy jz np kb kc kd ke hb bi translated">如果您有多个OAuth客户端id(例如，Android、iOS和web各有一个)，您必须在添加每个客户端id后重新部署服务，以确保服务接受更改。同样，如果您删除一个客户端ID，您必须重新部署您的服务以删除该客户端ID并拒绝请求。项目中的所有客户端id都将被接受。</p></blockquote><p id="4811" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><strong class="jl hj">我所要做的就是重新部署云运行服务！</strong>无论何时部署云运行服务，它都会以某种方式存储特定GCP项目中所有OAuth2.0客户端id的快照。因此，如果您首先部署服务，然后才向GCP项目添加应用程序脚本，服务将不会识别应用程序脚本OAuth 2.0客户端的新客户端ID。你只需要重新部署服务，它就能工作。</p><h2 id="10a4" class="kg kh hi bd ki kj kk kl km kn ko kp kq js kr ks kt jw ku kv kw ka kx ky kz la bi translated">结论</h2><p id="872e" class="pw-post-body-paragraph jj jk hi jl b jm lb ij jo jp lc im jr js ld ju jv jw le jy jz ka lf kc kd ke hb bi translated">当您考虑用于身份验证和授权的GCP安全模型时，上面的步骤完全有意义。有些人可能会说这看起来很复杂，但实际上它可以保证你的信息和资源的安全。</p><p id="b2c7" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">同样的方法也适用于谷歌云功能。</p><p id="2338" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><em class="kf">我的名字叫尼克·瓦克莱夫，我是</em><a class="ae mv" href="https://techccino.com?utm_source=medium.com&amp;utm_medium=tech-blog&amp;utm_content=call-cloudrun-from-appsscripts" rel="noopener ugc nofollow"><em class="kf">Techccino Ltd</em></a><em class="kf">的创始人。如果你有兴趣构建自己的网络应用</em> <a class="ae mv" href="https://techccino.com/" rel="noopener ugc nofollow" target="_blank"> <em class="kf">联系</em> </a> <em class="kf">。</em></p></div></div>    
</body>
</html>