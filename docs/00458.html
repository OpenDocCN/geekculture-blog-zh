<html>
<head>
<title>The Pooling of Connections in Redis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Redis中的连接池</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/the-pooling-of-connections-in-redis-e8188335bf64?source=collection_archive---------0-----------------------#2021-02-12">https://medium.com/geekculture/the-pooling-of-connections-in-redis-e8188335bf64?source=collection_archive---------0-----------------------#2021-02-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><h2 id="5930" class="hg hh hi bd b fp hj hk hl hm hn ho dx hp translated" aria-label="kicker paragraph">Redis事件</h2><div class=""/><div class=""><h2 id="eee8" class="pw-subtitle-paragraph io hr hi bd b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf dx translated">Redis在多线程环境中的最佳实践</h2></div><p id="3243" class="pw-post-body-paragraph jg jh hi ji b jj jk is jl jm jn iv jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">大家好，</p><p id="5306" class="pw-post-body-paragraph jg jh hi ji b jj jk is jl jm jn iv jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">今天我们将学习如何在多线程环境中使用Redis。如果你是Redis的新手，最好先把之前的文章过一遍再进一步阅读。你可以在这里找到Redis文章树。</p><h2 id="538f" class="kc kd hi bd ke kf kg kh ki kj kk kl km jp kn ko kp jt kq kr ks jx kt ku kv ho bi translated">数据库连接池</h2><p id="f084" class="pw-post-body-paragraph jg jh hi ji b jj kw is jl jm kx iv jo jp ky jr js jt kz jv jw jx la jz ka kb hb bi translated">连接池意味着在每次请求连接时重用连接，而不是创建连接。为了便于连接重用，数据库连接的内存缓存(称为连接池)由连接池模块作为一个层来维护。连接池在后台执行，不影响应用程序的编码方式。</p><figure class="lc ld le lf fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es lb"><img src="../Images/e0fa2ccb81cd8b6d795b4fd5b5f85eb7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*q3G7f9lEO3aKNizX"/></div></div><figcaption class="ln lo et er es lp lq bd b be z dx">Photo by <a class="ae lr" href="https://unsplash.com/@trommelkopf?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Steve Harvey</a> on <a class="ae lr" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h2 id="1c93" class="kc kd hi bd ke kf kg kh ki kj kk kl km jp kn ko kp jt kq kr ks jx kt ku kv ho bi translated">杰迪池</h2><p id="5ebf" class="pw-post-body-paragraph jg jh hi ji b jj kw is jl jm kx iv jo jp ky jr js jt kz jv jw jx la jz ka kb hb bi translated">我们要通过Redis的Java客户端Jedis来学习Redis连接池。</p><p id="b767" class="pw-post-body-paragraph jg jh hi ji b jj jk is jl jm jn iv jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">在多线程环境中使用Redis有一些问题。Redis连接实例是单线程的。如果我们在多个线程之间重用单个Redis连接，可能不足以在有限的时间内完成所需的任务。如果我们为一个线程创建一个单独的Redis连接，这将增加Redis服务器的开销。</p><p id="1c95" class="pw-post-body-paragraph jg jh hi ji b jj jk is jl jm jn iv jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">我们需要在多线程环境中建立一个连接池来应对这些挑战。这允许我们从多个线程与Redis对话，同时仍然获得重用连接的好处。JedisPool对象是线程安全的，可以同时在多个线程中使用。我们的想法是，从池中取出连接，并在完成后将其释放回池中。该池只需配置一次，可以重复使用多次。</p><figure class="lc ld le lf fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es ls"><img src="../Images/7bcba3f00b78689377b75f653cb5a0a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*r6vx2zEUuctpj2t8"/></div></div><figcaption class="ln lo et er es lp lq bd b be z dx">Photo by <a class="ae lr" href="https://unsplash.com/@photos_by_lanty?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Photos by Lanty</a> on <a class="ae lr" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h2 id="ac22" class="kc kd hi bd ke kf kg kh ki kj kk kl km jp kn ko kp jt kq kr ks jx kt ku kv ho bi translated">Jedis池配置</h2><p id="13c4" class="pw-post-body-paragraph jg jh hi ji b jj kw is jl jm kx iv jo jp ky jr js jt kz jv jw jx la jz ka kb hb bi translated">在使用池之前，我们需要根据我们的目的相应地配置初始配置。我将逐一解释初始配置的属性。</p><ol class=""><li id="ce82" class="lt lu hi ji b jj jk jm jn jp lv jt lw jx lx kb ly lz ma mb bi translated"><em class="mc"> maxTotal: </em>该属性管理在给定时间可以产生的最大连接数。因为Jedis连接不能跨线程共享，所以这个设置会影响应用程序在与Redis交互时的并发量。注意，每个连接都有一些内存和CPU开销，因此将这个值设置得很高可能会有负面影响。如果没有设置，默认值为8，对于大多数应用程序来说，这个值太低了。当选择一个值时，要考虑在高负载下可能有多少个对Redis的并发调用。</li><li id="2c8b" class="lt lu hi ji b jj md jm me jp mf jt mg jx mh kb ly lz ma mb bi translated"><em class="mc"> maxIdle: </em>这是连接池中可以空闲而不被快速关闭的最大连接数。如果未设置，默认值为8。这个值的建议值与<em class="mc"> maxTotal </em>相同，有助于在应用程序在短时间内出现大量负载时避免不必要的连接开销。如果一个连接长时间空闲，它仍然会被驱逐，直到空闲连接数达到<em class="mc"> minIdle </em>。<em class="mc">迷你轴</em>解释如下。</li><li id="ae76" class="lt lu hi ji b jj md jm me jp mf jt mg jx mh kb ly lz ma mb bi translated"><em class="mc"> minIdle: </em>这是可以立即使用的连接数。即使负载减少，它们仍会保留在池中。如果未设置，默认值为0。当选择一个值时，考虑您对Redis的<em class="mc">稳态</em>并发请求。例如，如果您的应用程序同时从10个线程调用Redis，那么您应该将这个值设置为至少10(稍微高一点，以便给您一些空间)。</li><li id="a22a" class="lt lu hi ji b jj md jm me jp mf jt mg jx mh kb ly lz ma mb bi translated"><em class="mc"> blockWhenExhausted: </em>这控制线程请求连接时的行为，但是没有空闲的线程，并且池不能创建更多的线程(由于<em class="mc"> maxTotal配置</em>)。如果设置为true，调用线程将在抛出异常之前阻塞<em class="mc"> maxWaitMillis </em>。缺省值为true，我建议将其真正用于生产环境。您可以在测试环境中将其设置为false，以帮助您更容易地发现为<em class="mc"> maxTotal </em>使用什么值。</li><li id="9a5b" class="lt lu hi ji b jj md jm me jp mf jt mg jx mh kb ly lz ma mb bi translated"><em class="mc"> maxWaitMillis: </em>如果调用JedisPool.getResource()会阻塞，要等待多长时间，以毫秒为单位。默认值为-1，表示无限期阻塞。</li><li id="faa6" class="lt lu hi ji b jj md jm me jp mf jt mg jx mh kb ly lz ma mb bi translated"><em class="mc"> TestOnBorrow: </em>控制连接从池中返回之前是否进行测试。默认值为false。设置为true可能会增加对连接波动的恢复能力，但从池中获取连接时也可能会有性能损失。</li></ol><p id="87e6" class="pw-post-body-paragraph jg jh hi ji b jj jk is jl jm jn iv jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">在池连接设置中设置这些参数之前，我们需要三思。</p><figure class="lc ld le lf fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es mi"><img src="../Images/ad9634bc2ffe6efb24569b54156136d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MYbKu4EtegzOs09X"/></div></div><figcaption class="ln lo et er es lp lq bd b be z dx">Photo by <a class="ae lr" href="https://unsplash.com/@rimakruciene?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Rima Kruciene</a> on <a class="ae lr" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h2 id="b9c7" class="kc kd hi bd ke kf kg kh ki kj kk kl km jp kn ko kp jt kq kr ks jx kt ku kv ho bi translated">样本池配置设置代码</h2><figure class="lc ld le lf fd lg"><div class="bz dy l di"><div class="mj mk l"/></div></figure><p id="51db" class="pw-post-body-paragraph jg jh hi ji b jj jk is jl jm jn iv jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">如果我们不想改变默认值，我们可以保留一些配置。我们可以通过调用下面的代码来获得Jedis实例。</p><pre class="lc ld le lf fd ml mm mn mo aw mp bi"><span id="7b06" class="kc kd hi mm b fi mq mr l ms mt">jedisInstance = getJedisInstance().getResource()</span></pre><p id="8071" class="pw-post-body-paragraph jg jh hi ji b jj jk is jl jm jn iv jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">我们可以继续使用<em class="mc"> jedisInstance </em>对象进行存储和检索。</p></div><div class="ab cl mu mv gp mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="hb hc hd he hf"><p id="e1e1" class="pw-post-body-paragraph jg jh hi ji b jj jk is jl jm jn iv jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">我相信你已经理解了今天讨论的主题。如果您有任何问题或任何澄清，不要犹豫，通过回复部分与我联系。感谢您花费宝贵的时间阅读这篇文章。</p><p id="f089" class="pw-post-body-paragraph jg jh hi ji b jj jk is jl jm jn iv jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated"><strong class="ji hs"> <em class="mc">喜欢这篇文章吗？成为</em> </strong> <a class="ae lr" href="https://sthenusan.medium.com/membership" rel="noopener"> <strong class="ji hs"> <em class="mc">中等会员</em> </strong> </a> <strong class="ji hs"> <em class="mc">继续无限制的学习。如果你使用上面的链接，我会收到你的一部分会员费，不需要你额外付费。</em> </strong></p><p id="6de2" class="pw-post-body-paragraph jg jh hi ji b jj jk is jl jm jn iv jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">干杯…</p><figure class="lc ld le lf fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es nb"><img src="../Images/fd1c5847478a6384596a7479479ed2fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5y5nhPvRQm5A_eRf"/></div></div><figcaption class="ln lo et er es lp lq bd b be z dx">Photo by <a class="ae lr" href="https://unsplash.com/@nicklbaert?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Niclas Illg</a> on <a class="ae lr" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="eaef" class="nc kd hi bd ke nd ne nf ki ng nh ni km ix nj iy kp ja nk jb ks jd nl je kv nm bi translated">参考</h1><div class="nn no ez fb np nq"><a href="https://redis.io/" rel="noopener  ugc nofollow" target="_blank"><div class="nr ab dw"><div class="ns ab nt cl cj nu"><h2 class="bd hs fi z dy nv ea eb nw ed ef hr bi translated">雷迪斯</h2><div class="nx l"><h3 class="bd b fi z dy nv ea eb nw ed ef dx translated">宣布RedisConf 2021(4月20-21日):内容征集现已开放。Redis是一个开源软件(BSD许可)…</h3></div><div class="ny l"><p class="bd b fp z dy nv ea eb nw ed ef dx translated">redis.io</p></div></div><div class="nz l"><div class="oa l ob oc od nz oe ll nq"/></div></div></a></div><div class="nn no ez fb np nq"><a href="https://redislabs.com/blog/connection-pools-for-serverless-functions-and-backend-services/" rel="noopener  ugc nofollow" target="_blank"><div class="nr ab dw"><div class="ns ab nt cl cj nu"><h2 class="bd hs fi z dy nv ea eb nw ed ef hr bi translated">无服务器功能和后端服务的连接池| Redis实验室</h2><div class="nx l"><h3 class="bd b fi z dy nv ea eb nw ed ef dx translated">当编写连接到数据库的服务器应用程序时，您经常必须处理连接池，用…</h3></div><div class="ny l"><p class="bd b fp z dy nv ea eb nw ed ef dx translated">redislabs.com</p></div></div><div class="nz l"><div class="of l ob oc od nz oe ll nq"/></div></div></a></div></div></div>    
</body>
</html>