<html>
<head>
<title>Secure App with Refresh-Token</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用刷新令牌的安全应用</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/secure-app-with-refresh-token-ddbee3716bba?source=collection_archive---------6-----------------------#2021-07-18">https://medium.com/geekculture/secure-app-with-refresh-token-ddbee3716bba?source=collection_archive---------6-----------------------#2021-07-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="f949" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我最近思考了刷新令牌的概念，以及为什么这比只使用长期访问令牌使应用程序更加安全。我读了很多StackOverflow的回答和博客帖子，但不幸的是，没有找到一个评论让我100%清楚。</p><p id="397b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以我想写一篇自己的博文，描述刷新令牌流，以及为什么将访问令牌与刷新令牌分开是有用的。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/a5a8b25c1c1c8d3586949371134d3948.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ccvQfiQmnlwRYEeK"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Photo by <a class="ae jt" href="https://unsplash.com/@jamessutton_photography?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">James Sutton</a> on <a class="ae jt" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="0ba7" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">刷新令牌的概念</h1><p id="608f" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">从客户端-应用程序的角度来看，授权流程基本如下:</p><ol class=""><li id="787d" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lc ld le lf bi translated">要登录应用程序，将用户名和密码发送到后端</li><li id="942a" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">该响应将包括:用于访问受限资源的短期访问令牌、过期时间(访问令牌的有效时间)以及用于在旧的访问令牌过期时获得新的访问令牌的长期刷新令牌</li><li id="86fa" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">每当您想要访问受限路由时，请向服务器发送访问令牌</li><li id="84b0" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">当访问令牌不再有效(例如过期)时，服务器返回认证错误(例如401未授权)</li><li id="dad2" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">客户端向服务器发送刷新令牌，以便获得新的访问令牌</li></ol><h1 id="c2e1" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">对代币的访问</h1><p id="d95f" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">攻击者获取用户令牌的方式有几种可能性。</p><ol class=""><li id="1bd4" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lc ld le lf bi translated">黑客可以完全访问服务器端，然后倒楣的事情发生了:你的访问令牌的泄漏是你最小的问题</li><li id="6e9f" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">黑客可以访问客户端，这也很成问题。黑客可以窃取您的刷新令牌，并在需要时生成新的访问令牌，或者直接从您的客户端获取他需要的所有信息</li><li id="1ece" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">黑客可以访问日志文件或读取客户端和服务器之间的流量，这取决于黑客可以访问什么！</li></ol><p id="9767" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">短期访问令牌这个令牌可能不再有效</p><p id="2ea8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">长期存在的refresh_token那么您会遇到与客户端泄漏相同的问题，黑客可以生成新的访问令牌(只要刷新令牌没有被身份验证服务器无效)</p><h1 id="82c4" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">防止令牌被第三方使用</h1><h2 id="87de" class="ll jv hi bd jw lm ln lo ka lp lq lr ke iq ls lt ki iu lu lv km iy lw lx kq ly bi translated">知识产权保护</h2><p id="9120" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">防止黑客使用令牌的一种可能性是只将创建者的ip列入白名单。如果请求带有另一个IP(例如攻击者的IP)，则拒绝该请求并返回“401未授权”。</p><p id="1468" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这对于访问令牌来说是可以的，但是对于刷新令牌来说可能就不需要它了。我们大多数人都没有一个静态的ip。所以每天晚上ip地址都在变，你就被赶出了应用程序。如果您想实现“保持我登录”功能，这不是最佳选择。</p><p id="e27a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，尤其是在公司内部网络中，攻击者也有可能使用与受害者相同的ip，从而绕过这种保护。有一些防火墙选项可以防止这种情况。例如，限制一个交换机端口上允许的IP范围。我不会深究这个话题，但请记住。</p><h1 id="b875" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">环境保护</h1><p id="aa6a" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">您还可以将令牌绑定到其他环境属性，如</p><ul class=""><li id="e917" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lz ld le lf bi translated">使用的浏览器(通过用户代理)</li><li id="d1d5" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lz ld le lf bi translated">使用的操作系统(通过用户代理)</li><li id="afc0" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lz ld le lf bi translated">屏幕尺寸+颜色深度</li><li id="b3c4" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lz ld le lf bi translated">启用黑暗模式</li><li id="a905" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lz ld le lf bi translated">地理定位(如果获得许可)</li></ul><p id="689f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以根据需要组合这些属性，在登录时将它们保存在服务器端——在令牌旁边——并验证每个请求的属性(可能只有在通过refresh-token收集新的访问令牌以优化性能时)</p><p id="bf25" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，此信息可能是伪造的。如果用户代理说它是Firefox浏览器，就不能保证它是真的。您可以随意修改用户代理。</p><h1 id="1d90" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">首要目标</h1><p id="afd5" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">主要目标应该是保护刷新令牌。如果刷新令牌泄漏，黑客可以创建新的访问令牌并以您的名义执行受限的操作，除非您应用IP保护或环境保护或使刷新令牌无效。</p><h1 id="af46" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">能够访问网络或日志文件的黑客</h1><h2 id="4157" class="ll jv hi bd jw lm ln lo ka lp lq lr ke iq ls lt ki iu lu lv km iy lw lx kq ly bi translated">为什么要关注这种情况</h2><p id="8492" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">让我们仔细看看这种情况，因为这是最有可能的情况，也是我们最有可能采取对策的情况。</p><p id="8b58" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">简单回顾一下:如果黑客可以直接访问服务器，那么令牌就是你最小的问题。如果黑客可以直接访问客户端，那么他就可以点击用户界面，系统就没有机会将用户识别为黑客。</p><h2 id="06f3" class="ll jv hi bd jw lm ln lo ka lp lq lr ke iq ls lt ki iu lu lv km iy lw lx kq ly bi translated">一些假设</h2><p id="9588" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">让我们假设访问令牌受到ip和环境保护的保护。因此，只有我的设备上具有我的当前ip的浏览器才被允许使用特定的访问令牌。当发生任何变化时(新的ip、其他浏览器、其他设备)，我必须使用刷新令牌来创建新的访问令牌。</p><p id="6333" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这种情况下，在很多情况下，这种不同类型令牌的分离是有意义的。</p><h2 id="8f24" class="ll jv hi bd jw lm ln lo ka lp lq lr ke iq ls lt ki iu lu lv km iy lw lx kq ly bi translated">情况A:黑客在日志文件中发现了一个访问令牌</h2><p id="7fa0" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">只要他只找到访问令牌而没有刷新令牌，一切都没问题。找到的访问令牌可能已过期。如果不是，我们的环境和ip检查会确保令牌不能被重用。</p><h2 id="7b62" class="ll jv hi bd jw lm ln lo ka lp lq lr ke iq ls lt ki iu lu lv km iy lw lx kq ly bi translated">情况B:黑客读取流量</h2><p id="ae41" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">防止好奇者发现网络流量的第一条规则是通过https使用加密流量。但是特别是在企业的内部网络中，通常有一些传统的应用程序使用没有加密的纯文本http。如果是这样的话，如果你能访问网络，阅读流量就很容易了。</p><p id="412e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">确保至少令牌的刷新是加密的。无论您有一个配置了https的独立身份验证服务器，还是您自己加密刷新令牌，都要确保刷新令牌总是在网络上加密。</p><p id="ea08" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">攻击者只能嗅探访问令牌，但是这个令牌是无用的，因为它是受ip和环境保护的。</p><p id="eac0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果刷新令牌是未加密的并且也是可见的:同样在这种情况下，从业务中提取刷新令牌比如果你有一个长期存在的访问令牌更困难。可以从通过网络发送的每个请求中提取长期访问令牌。如果访问令牌在例如1小时内有效，那么从黑客的角度来看，在最坏的情况下，您必须等待1小时才能访问请求令牌。</p><h1 id="8ac0" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">关键要点</h1><p id="7a26" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">这些是我在构建授权应用程序时应该注意的要点:</p><ol class=""><li id="a3a0" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lc ld le lf bi translated">始终使用HTTPS加密网络流量。也在公司内部网络中</li><li id="4164" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">将资源服务器与身份验证服务器分开。如果加密(无论如何)对于一个资源服务器来说是不可能的，请确保至少身份验证服务器是加密的</li><li id="870d" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">使用只能在有限时间内使用的短期访问令牌。如果在日志文件中找到它，它可能已经过期</li><li id="f0b7" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">考虑使用ip保护和环境保护来保护您的访问令牌</li></ol><h1 id="4c7d" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">结论</h1><p id="8d0a" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">你同意我的论证吗？请在评论中告诉我，让我们一起讨论更安全的网络的最佳解决方案。</p></div></div>    
</body>
</html>