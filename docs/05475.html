<html>
<head>
<title>Easily Run your Unit Test with GoLang + Gin + Postgres</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用GoLang + Gin + Postgres轻松运行单元测试</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/easily-run-your-unit-test-with-golang-gin-postgres-8a402a29e3f6?source=collection_archive---------1-----------------------#2021-07-22">https://medium.com/geekculture/easily-run-your-unit-test-with-golang-gin-postgres-8a402a29e3f6?source=collection_archive---------1-----------------------#2021-07-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="e050" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">GoLang pointers让我们很容易模仿对象！</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/770ddf6723786034b62bd46427385b30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xmL_QiM6CkyYNEbU"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Photo by <a class="ae jn" href="https://unsplash.com/@flowforfrank?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Ferenc Almasi</a> on <a class="ae jn" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="0841" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">编写单元测试总是令人困惑，尤其是当我们在应用程序中集成了多个库和框架时。请跟随我们编写我们的初始项目和测试模板，这样您就可以轻松地开始您的项目了！</p><h1 id="bf96" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">该结构</h1><p id="156d" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">任何项目中最重要的一个方面是我们的文件夹结构。GoLang可以将一个目录下的多个文件编译成一个包，当我们导入一个包时，它会导入整个目录。因为我们要构建一个REST API，所以我们可以遵循一个基本的结构模型——控制器，并像这样构造我们的文件夹:</p><pre class="iy iz ja jb fd lh li lj lk aw ll bi"><span id="beca" class="lm kl hi li b fi ln lo l lp lq">|__main.go            # initialize our app<br/>|__internals<br/>|  |__api<br/>|     |__controllers  # all our controllers<br/>|        |__sample-controller.go<br/>|     |__router       # our routers<br/>|        |__router.go<br/>|     |__api.go       # initialize gin<br/>|  |__pkg<br/>|     |__database.go  # configuration to our DB<br/>|     |__models.go    # DB models<br/>|__test               # all our test</span></pre><p id="2978" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">对于这个项目，我们将使用<code class="du lr ls lt li b">go-pg/pg/v10</code> ORM库，我们可以在这里找到<a class="ae jn" href="https://pg.uptrace.dev/" rel="noopener ugc nofollow" target="_blank"/>。</p><h1 id="a534" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">设置</h1><p id="5b3f" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">对于这个单元测试，我们所做的就是看看我们是否可以创建一个在测试环境中运行的模拟<code class="du lr ls lt li b">gin</code>服务器，并根据它的实际意图将其路由器映射到控制器。因为我们的控制器可以访问内置的数据库，所以我们必须将指针改为指向一个模拟数据库，这样它就可以创建/删除值。</p><p id="9764" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">首先，让我们确保我们的数据库连接被导出为一个指针，以便它可以被其他包引用:</p><p id="1a7c" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">数据库. go </strong></p><pre class="iy iz ja jb fd lh li lj lk aw ll bi"><span id="e3c2" class="lm kl hi li b fi ln lo l lp lq">package db</span><span id="3f1a" class="lm kl hi li b fi lu lo l lp lq">import (<br/>  "context"<br/>  "github.com/go-pg/pg/v10"<br/>)</span><span id="bf52" class="lm kl hi li b fi lu lo l lp lq"><br/>var DB *pg.DB</span><span id="4ec1" class="lm kl hi li b fi lu lo l lp lq">//SetupDB opens a database and saves the reference to `Database` pointer. This allows us to have access to the initialized DB from other packages</span><span id="de0d" class="lm kl hi li b fi lu lo l lp lq">func SetupDB() {<br/>  DB = pg.Connect(&amp;pg.Options{<br/>    Addr:     "some_host" + ":" + "some_port",<br/>    User:     "username",<br/>    Password: "password",<br/>    Database: "database",<br/>  })<br/>  <br/>  // Check if database is connected<br/>  ctx := context.Background()</span><span id="e247" class="lm kl hi li b fi lu lo l lp lq">  if err := DB.Ping(ctx); err != nil {<br/>    panic(err)<br/>  }<br/>}</span></pre><p id="57ef" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">初始化应用程序时，我们可以运行<code class="du lr ls lt li b">setupDB()</code>。</p><p id="fa47" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">为了引用数据库，当我们将包<code class="du lr ls lt li b">import</code>到我们的控制器中时，我们可以简单地获得指针，如下所示:</p><p id="8e2d" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">样本控制器. go </strong></p><pre class="iy iz ja jb fd lh li lj lk aw ll bi"><span id="0b7d" class="lm kl hi li b fi ln lo l lp lq">package controllers</span><span id="7809" class="lm kl hi li b fi lu lo l lp lq"><br/>import (<br/>  "net/http"<br/>  "github.com/gin-gonic/gin"</span><span id="ff75" class="lm kl hi li b fi lu lo l lp lq">  // rename packe for easier read  <br/>  pg "sample/internal/pkg/db"<br/>  models "sample/internal/pkg/models"<br/>)</span><span id="6ad2" class="lm kl hi li b fi lu lo l lp lq">// Get all Sample object from DB<br/>func GetSamples(c *gin.Context) {<br/>  var samples = []models.Sample{}</span><span id="d37d" class="lm kl hi li b fi lu lo l lp lq">  // We access the DB pointer from the package <br/>  err := pg.DB.Model(&amp;samples).Select()<br/>  if err != nil {<br/>    c.JSON(http.StatusBadRequest, {})<br/>    return<br/>  }</span><span id="be88" class="lm kl hi li b fi lu lo l lp lq">  c.JSON(http.StatusOK, actions)<br/>}</span></pre><p id="aa2d" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">就是这样！接下来让我们进入测试文件夹来构建我们的测试用例。</p><p id="509f" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这里我们至少需要一个文件，<code class="du lr ls lt li b">init_test.go</code>，它将负责设置我们的测试环境。</p><p id="0087" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj"> init_test.go </strong></p><pre class="iy iz ja jb fd lh li lj lk aw ll bi"><span id="475a" class="lm kl hi li b fi ln lo l lp lq">package test</span><span id="6f70" class="lm kl hi li b fi lu lo l lp lq">import (<br/>  "context"<br/>  "fmt"<br/>  "log"<br/>  "os"<br/>  "testing"</span><span id="d538" class="lm kl hi li b fi lu lo l lp lq">  "sample/internal/api/controllers"<br/>  "sample/internal/pkg/models"</span><span id="e5d0" class="lm kl hi li b fi lu lo l lp lq">  // Grabs the same DB pointer<br/>  pointer_db "sample/internal/pkg/db"</span><span id="727a" class="lm kl hi li b fi lu lo l lp lq">  "github.com/gin-gonic/gin"<br/>  "github.com/go-pg/pg/v10"<br/>  "github.com/go-pg/pg/v10/orm"</span><span id="8c4e" class="lm kl hi li b fi lu lo l lp lq">  unitTest "github.com/Valiben/gin_unit_test"<br/>)</span><span id="6016" class="lm kl hi li b fi lu lo l lp lq">func init() {<br/>  // initialize the router<br/>  router := gin.Default()</span><span id="1603" class="lm kl hi li b fi lu lo l lp lq">  // Handlers for testing<br/>  router.GET("/sample", controllers.GetSamples)<br/></span><span id="fe68" class="lm kl hi li b fi lu lo l lp lq">  // Setup the router<br/>  unitTest.SetRouter(router)<br/>  newLog := log.New(os.Stdout, "",log.Llongfile|log.Ldate|log.Ltime)<br/>  unitTest.SetLog(newLog)<br/>}</span><span id="08ef" class="lm kl hi li b fi lu lo l lp lq">...</span></pre><p id="0bc1" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">但是我们还没有完成，上面的代码仅仅创建了<code class="du lr ls lt li b">gin</code>测试环境，它还没有为测试准备好我们的数据库。</p><p id="8dbb" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我们需要做的是<code class="du lr ls lt li b">BeforeAll</code>创建一个数据库和<code class="du lr ls lt li b">AfterAll</code>删除数据库进行清理。使用<code class="du lr ls lt li b">TestMain()</code>可以做到这一点</p><p id="2425" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">为此，我们可以将它添加到我们的<code class="du lr ls lt li b">init_test.go</code></p><p id="51b4" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj"> init_test.go(续)</strong></p><pre class="iy iz ja jb fd lh li lj lk aw ll bi"><span id="7d0c" class="lm kl hi li b fi ln lo l lp lq">....</span><span id="d487" class="lm kl hi li b fi lu lo l lp lq">// TestMain will automatically run before all test and hook back in // after all test is done<br/>func TestMain(m *testing.M) {</span><span id="6487" class="lm kl hi li b fi lu lo l lp lq">  // create a local connection<br/>  pgdb := pg.Connect(&amp;pg.Options{<br/>    Addr:     os.Getenv("DATABASE_URL") + ":5432",<br/>    User:     "username",<br/>    Password: "password",<br/>  })</span><span id="00d7" class="lm kl hi li b fi lu lo l lp lq">  defer pgdb.Close()</span><span id="d9d9" class="lm kl hi li b fi lu lo l lp lq">  // trigger function to create schema<br/>  createSchema(pgdb)</span><span id="cbe2" class="lm kl hi li b fi lu lo l lp lq">  // THIS IS KEY, we replace the DB pointer to the mock one we    <br/>  // recently build<br/>  pointer_db.DB = pgdb</span><span id="4231" class="lm kl hi li b fi lu lo l lp lq">  log.Println("Everything above here run before ALL test")</span><span id="6e34" class="lm kl hi li b fi lu lo l lp lq">  // Run test suites<br/>  exitVal := m.Run()</span><span id="ef1c" class="lm kl hi li b fi lu lo l lp lq">  log.Println("Everything below run after ALL test")</span><span id="791c" class="lm kl hi li b fi lu lo l lp lq">  // we can do clean up code here</span><span id="f973" class="lm kl hi li b fi lu lo l lp lq">  os.Exit(exitVal)<br/>}</span><span id="53ed" class="lm kl hi li b fi lu lo l lp lq">// Schema in the mock DB still needs to be created<br/>func createSchema(db *pg.DB) error {<br/>  models := []interface{}{<br/>    (*models.Action)(nil),<br/>  }</span><span id="f71e" class="lm kl hi li b fi lu lo l lp lq">  for _, model := range models {<br/>    err := db.Model(model).CreateTable(&amp;orm.CreateTableOptions{<br/>      // set Temp=True so no tables/data are actually created<br/>      Temp:        true,<br/>    })<br/>  }</span><span id="e540" class="lm kl hi li b fi lu lo l lp lq">  return nil<br/>}</span></pre><p id="c75e" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">注意，在<code class="du lr ls lt li b">TestMain</code>中，我们用函数中最近创建的值覆盖了<code class="du lr ls lt li b">pointer_db.DB</code>值。因为它是一个指针，所以在测试期间，甚至控制器内部的<code class="du lr ls lt li b">pointer_db.DB</code>都指向模拟数据库。这意味着我们需要做的最后一件事是编写一个测试！</p><p id="e66a" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">注意:我不得不将我们的数据库库重命名为<code class="du lr ls lt li b">pointer_db</code>，因为默认的<code class="du lr ls lt li b">pg</code>在这个实例中被postgres库使用，而不是在<code class="du lr ls lt li b">sample-controller.py</code>中</p><p id="1c18" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">给<code class="du lr ls lt li b">sample-controller.go</code>写一个吧</p><p id="9f63" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">sample _ controller _ test . go</strong></p><pre class="iy iz ja jb fd lh li lj lk aw ll bi"><span id="5a42" class="lm kl hi li b fi ln lo l lp lq">package test</span><span id="e97e" class="lm kl hi li b fi lu lo l lp lq">import (<br/>  "testing"<br/>  unitTest "github.com/Valiben/gin_unit_test"<br/>  "github.com/Valiben/gin_unit_test/utils"</span><span id="4f6d" class="lm kl hi li b fi lu lo l lp lq">  pg "sample/internal/pkg/db"<br/>  "sample/internal/pkg/models"<br/>)</span><span id="3320" class="lm kl hi li b fi lu lo l lp lq">// Our test will see if we receive an array of samples<br/>func TestGetSample(t *testing.T) {<br/>  var resp []models.Sample</span><span id="28a0" class="lm kl hi li b fi lu lo l lp lq">  // Our db starts empty, so we will need to populate it<br/>  populateDatabase(test_models)</span><span id="e2de" class="lm kl hi li b fi lu lo l lp lq">  err := unitTest.TestHandlerUnMarshalResp(<br/>            utils.GET, "/sample","json", nil, &amp;resp)</span><span id="8a03" class="lm kl hi li b fi lu lo l lp lq">  if err != nil {<br/>    t.Errorf("TestGetSample: %v\n", err)<br/>    return<br/>  }</span><span id="5eef" class="lm kl hi li b fi lu lo l lp lq">  // Validate there is at least one<br/>  if len(resp) != 1 {<br/>    t.Errorf("Expected %v but got %v", 1, len(resp))<br/>    return<br/>  }</span><span id="3560" class="lm kl hi li b fi lu lo l lp lq">  // Emptying the DB for the next test<br/>  clearDatabase(test_models)</span><span id="e34b" class="lm kl hi li b fi lu lo l lp lq">  t.Log("Success")<br/>}<br/></span><span id="0440" class="lm kl hi li b fi lu lo l lp lq">// Takes in array of interface to create object in DB<br/>func populateDatabase(test_models []interface{}) error {<br/>  for _, model := range test_models {<br/>    _, err := pg.DB.Model(model).Insert()<br/>    if err != nil {<br/>      fmt.Print(err.Error())<br/>      return err<br/>    }<br/>  }<br/>  return nil<br/>}</span><span id="314c" class="lm kl hi li b fi lu lo l lp lq">func clearDatabase(test_models []interface{}) error {<br/>  for _, model := range test_models {<br/>    _, err := pg.DB.Model(model).Delete()<br/>    if err != nil {<br/>      fmt.Print(err.Error())<br/>      return err<br/>    }<br/>  }<br/>  return nil<br/>}</span></pre><p id="df48" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">就是它</strong>！接下来你可以写更多的例子来看看当它通过API被触发时你的控制器应该如何表现。</p><p id="6e16" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这种方法的关键是:</p><ul class=""><li id="d046" class="lv lw hi jq b jr js ju jv jx lx kb ly kf lz kj ma mb mc md bi translated">postgres数据库需要运行，因为它不在真空中工作</li><li id="8d7f" class="lv lw hi jq b jr me ju mf jx mg kb mh kf mi kj ma mb mc md bi translated">在每个测试中，我们需要填充并创建我们的表</li></ul><p id="67d6" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">如果您对完整的项目感兴趣，请查看我的</strong><a class="ae jn" href="https://github.com/sutjin/go-rest-template" rel="noopener ugc nofollow" target="_blank"><strong class="jq hj">Github</strong></a><strong class="jq hj">中的示例。</strong></p><p id="2358" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">如果您正在通过GitLab运行这个项目，并且想要为它构建一个测试工作，那么您很幸运！我写过一篇关于如何将postgres作为Gitlab构建的一部分的文章</p><p id="b7f3" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><a class="ae jn" rel="noopener" href="/geekculture/using-a-database-for-unit-testing-with-docker-in-gitlab-pipeline-c919121e25ef">在GitLab Pipeline中使用Docker进行单元测试的数据库|作者Nabil Sutjipto | Geek Culture | 2021年5月| Medium </a></p><p id="507b" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">祝你下一个项目好运！</p></div></div>    
</body>
</html>