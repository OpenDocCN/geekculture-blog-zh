<html>
<head>
<title>Dockerizing Playwright/E2E Tests</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">剧作家/E2E测试</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/dockerizing-playwright-e2e-tests-c041fede3186?source=collection_archive---------19-----------------------#2021-03-08">https://medium.com/geekculture/dockerizing-playwright-e2e-tests-c041fede3186?source=collection_archive---------19-----------------------#2021-03-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="4235" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi jd translated"><span class="l je jf jg bm jh ji jj jk jl di">厌倦了管理你的自动化测试机器吗？您是否每隔一周更新一次Chrome版本，或者维护多个似乎总是需要系统更新的虚拟机？您在扩展每小时、每天可以运行的测试数量方面有问题吗？</span></p><p id="c9f8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果是这样(也许即使不是)，这个指南是给<em class="jm">你</em>的！</p><p id="37d1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将消除这些问题，并在您的测试设置中考虑可伸缩性、灵活性和隔离性。</p><p id="1cae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可能会问，我们如何去做？我们将在Docker容器中运行您的测试套件！</p><figure class="jo jp jq jr fd js er es paragraph-image"><div class="er es jn"><img src="../Images/9c1ef28bdc5b08a7c8e52e16cb60335f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1244/format:webp/0*i3lo3-a89IItNvKY.jpg"/></div></figure><p id="466e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你没怎么想过，你可能会想为什么要做这样的事情。</p><p id="063b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">嗯……归根结底就是两件事，<strong class="ih hj">隔离性&amp;可扩展性。</strong></p><p id="f0a0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不，我们不是在谈论2020年版的隔离。</p><p id="ace2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们正在谈论<em class="jm">隔离你的测试运行</em>，这样它们可以在同一时间在多个设置上运行多次。</p><p id="b353" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">也许你今天只运行了少数几个测试，但是将来你可能需要覆盖<em class="jm">几十个</em>浏览器&amp;操作系统组合<strong class="ih hj">快速和大规模</strong>。</p><p id="4b59" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本教程中，我将尝试介绍在Docker容器中运行典型web应用程序的基础知识，以及如何使用剧作家在Docker容器中运行测试。</p><blockquote class="jv jw jx"><p id="400f" class="if ig jm ih b ii ij ik il im in io ip jy ir is it jz iv iw ix ka iz ja jb jc hb bi translated"><em class="hi">注意，对于一个真正的产品设置，你会希望把NGINX作为容器中的web服务器，以及一个编排系统(如Kubernetes)来探索。对于一个健壮的CI/CD管道，您还希望将测试作为脚本运行，并让您的CI/CD提供者在一个安装了依赖项的容器中运行所有这些，稍后会详细介绍。</em></p></blockquote><p id="5731" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以在这里克隆repo <a class="ae kb" href="https://github.com/tipalti/e2e-in-docker-tutorial" rel="noopener ugc nofollow" target="_blank">来获得完整的教程，或者你可以在我们进行的过程中复制脚本块。</a></p><div class="kc kd ez fb ke kf"><a href="https://github.com/tipalti/e2e-in-docker-tutorial" rel="noopener  ugc nofollow" target="_blank"><div class="kg ab dw"><div class="kh ab ki cl cj kj"><h2 class="bd hj fi z dy kk ea eb kl ed ef hh bi translated">蒂帕蒂/e2e码头教程</h2><div class="km l"><h3 class="bd b fi z dy kk ea eb kl ed ef dx translated">运行自动化/E2E测试的教程存储库。通过创建……为蒂帕尔蒂/e2e码头教程开发做出贡献</h3></div><div class="kn l"><p class="bd b fp z dy kk ea eb kl ed ef dx translated">github.com</p></div></div><div class="ko l"><div class="kp l kq kr ks ko kt jt kf"/></div></div></a></div></div><div class="ab cl ku kv gp kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="hb hc hd he hf"><h1 id="76c1" class="lb lc hi bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">基础知识</h1><h2 id="4d58" class="lz lc hi bd ld ma mb mc lh md me mf ll iq mg mh lp iu mi mj lt iy mk ml lx mm bi translated">创建您的应用</h2><p id="5d80" class="pw-post-body-paragraph if ig hi ih b ii mn ik il im mo io ip iq mp is it iu mq iw ix iy mr ja jb jc hb bi translated">对于这个例子，我们将使用<a class="ae kb" href="https://cli.vuejs.org/" rel="noopener ugc nofollow" target="_blank"> Vue CLI </a>来创建我们的应用程序。</p><p id="87f3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过在shell中运行以下命令来安装Vue CLI:</p><pre class="jo jp jq jr fd ms mt mu mv aw mw bi"><span id="65d9" class="lz lc hi mt b fi mx my l mz na">npm i -g @vue/cli @vue/cli-service-global</span></pre><p id="73ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们创建应用程序，这里我们称之为<code class="du nb nc nd mt b">e2e-in-docker-tutorial</code>(但是使用你喜欢的任何东西):</p><pre class="jo jp jq jr fd ms mt mu mv aw mw bi"><span id="662b" class="lz lc hi mt b fi mx my l mz na">vue create e2e-in-docker-tutorial</span></pre><p id="4d17" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您想要自定义设置，请遵循屏幕上的说明，但为此我们将使用<code class="du nb nc nd mt b">Default (Vue 3 Preview)</code>选项。</p><figure class="jo jp jq jr fd js er es paragraph-image"><div class="er es ne"><img src="../Images/72b4512e8046e0bc5c68bbce3226898b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1026/0*N-GYU0dzNZaotlaJ"/></div></figure><p id="8afe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一切安装完成后，让我们确保它的工作。</p><p id="e648" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将通过运行以下程序在本地提供应用程序:</p><pre class="jo jp jq jr fd ms mt mu mv aw mw bi"><span id="eb0c" class="lz lc hi mt b fi mx my l mz na">npm run serve</span></pre><p id="5fb3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在它选择的端口上打开localhost浏览器(<a class="ae kb" href="http://localhost:8080" rel="noopener ugc nofollow" target="_blank"> http://localhost:8080 </a>)，您应该会看到类似这样的内容。</p><figure class="jo jp jq jr fd js er es paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="er es nf"><img src="../Images/454de7f878449f167bbbb0130930f9a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jdFY_Q_0QtTlbN_k"/></div></div></figure><h2 id="fd5f" class="lz lc hi bd ld ma mb mc lh md me mf ll iq mg mh lp iu mi mj lt iy mk ml lx mm bi translated">阿爸，给我造点什么吧！</h2><p id="d889" class="pw-post-body-paragraph if ig hi ih b ii mn ik il im mo io ip iq mp is it iu mq iw ix iy mr ja jb jc hb bi translated">我们现在将编写一个小的示例页面，稍后可以使用它进行测试。它将有一些基本的逻辑和一些交互性。</p><p id="2b58" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个例子中，我们将创建一个狗骨计数器，这样我们就可以跟踪卡瓦雄亚瑟得到了多少次款待。</p><figure class="jo jp jq jr fd js er es paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="er es nk"><img src="../Images/6513fdc23c66adc4f50a29374ef38fbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wE9Vau80_xpWm0zv9HRv8A.jpeg"/></div></div><figcaption class="nl nm et er es nn no bd b be z dx">“Is that a dog?” — Arthur</figcaption></figure><p id="9f7b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将只有两个按钮，“给一根骨头”和“拿一根骨头”(薛定谔的骨头在v2中到来)。</p><p id="16f5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们还将添加一条消息，以便他可以告诉我们他的感受。当给它一根骨头时，它会高兴地汪汪叫，但当你拿走一根骨头时，它会悲伤地呜呜叫。</p><p id="b3e8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我们将保持一个计数器运行，以便我们可以跟踪他的骨摄入量(必须注意钙的摄入量，你知道…)。</p><p id="65a2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将在SCSS的<a class="ae kb" href="http://getbem.com/" rel="noopener ugc nofollow" target="_blank"> BEM </a>中编写样式，因此我们需要将<code class="du nb nc nd mt b">sass</code>和<code class="du nb nc nd mt b">scss-loader</code>添加到<code class="du nb nc nd mt b">devDependencies</code>中。<strong class="ih hj">注意，由于与Vue CLI中的<code class="du nb nc nd mt b">postcss-loader</code>存在一些兼容性问题，我们在这里使用版本10 </strong>。</p><pre class="jo jp jq jr fd ms mt mu mv aw mw bi"><span id="d80d" class="lz lc hi mt b fi mx my l mz na">npm i -D sass sass-loader@^10</span></pre><p id="fc07" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du nb nc nd mt b">App.vue</code>应该是这样的:</p><pre class="jo jp jq jr fd ms mt mu mv aw mw bi"><span id="125b" class="lz lc hi mt b fi mx my l mz na">&lt;template&gt;<br/>  &lt;Arthur /&gt;<br/>&lt;/template&gt;<br/><br/>&lt;script&gt;<br/>import Arthur from './components/Arthur.vue'<br/><br/>export default {<br/>  name: 'App',<br/>  components: {<br/>    Arthur<br/>  }<br/>}<br/>&lt;/script&gt;<br/><br/>&lt;style&gt;<br/>#app {<br/>  font-family: Avenir, Helvetica, Arial, sans-serif;<br/>  -webkit-font-smoothing: antialiased;<br/>  -moz-osx-font-smoothing: grayscale;<br/>  text-align: center;<br/>  color: #2c3e50;<br/>  margin-top: 60px;<br/>}<br/>&lt;/style&gt;</span></pre><p id="872e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们还有看起来像这样的<code class="du nb nc nd mt b">Arthur.vue</code>组件:</p><pre class="jo jp jq jr fd ms mt mu mv aw mw bi"><span id="984c" class="lz lc hi mt b fi mx my l mz na">&lt;template&gt;<br/>  &lt;div class="arthur"&gt;<br/>    &lt;h1&gt;Arthur's Bone Counter&lt;/h1&gt;<br/>    &lt;img src="~@/assets/arthur.jpg" class="arthur__img" /&gt;<br/>    &lt;h2 id="dog-message"&gt;<br/>      {{ dogMessage }}<br/>    &lt;/h2&gt;<br/>    &lt;h3 id="bone-count"&gt;<br/>      Current bone count: {{ boneCount }}<br/>    &lt;/h3&gt;<br/>    &lt;div&gt;<br/>      &lt;button class="arthur__method-button" @click="giveBone" id="give-bone"&gt;Give a bone&lt;/button&gt;<br/>      &lt;button class="arthur__method-button" @click="takeBone" id="take-bone"&gt;Take a bone&lt;/button&gt;<br/>    &lt;/div&gt;<br/>  &lt;/div&gt;<br/>&lt;/template&gt;<br/><br/>&lt;script&gt;<br/>export default {<br/>  name: 'Arthur',<br/>  data() {<br/>    return {<br/>      boneCount: 0,<br/>      dogMessage: `I'm waiting...`<br/>    }<br/>  },<br/>  methods: {<br/>    giveBone() {<br/>      this.boneCount++;<br/>      this.dogMessage = 'Woof!';<br/>    },<br/>    takeBone() {<br/>      if (this.boneCount &gt; 0) {<br/>        this.boneCount--;<br/>        this.dogMessage = 'Whine!';<br/>      } else {<br/>        this.dogMessage = `I'm confused!`;<br/>      }<br/>    }<br/>  }<br/>}<br/>&lt;/script&gt;<br/><br/>&lt;style lang="scss"&gt;<br/>.arthur {<br/>  &amp;__img {<br/>    height: 50vh; // width scales automatically to height when unset<br/>  }<br/>  &amp;__method-button {<br/>    margin: 1rem;<br/>    font-size: 125%;<br/>  }<br/>}<br/>&lt;/style&gt;</span></pre><p id="e9a2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">完成所有设置后，我们可以运行应用程序，我们应该会看到:</p><figure class="jo jp jq jr fd js er es paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="er es np"><img src="../Images/eb08848fb436ffc0769d221e389a3f69.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5xqyTTDyaSeiITCg"/></div></div></figure><p id="608f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">点击“给一根骨头”按钮给亚瑟一根骨头，他会感谢你的！</p><p id="110e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果它不听你的话，你也可以把骨头拿走，但是如果你想拿一块不存在的骨头，它会很困惑的！</p><h2 id="56a8" class="lz lc hi bd ld ma mb mc lh md me mf ll iq mg mh lp iu mi mj lt iy mk ml lx mm bi translated">托管您构建的应用</h2><p id="a417" class="pw-post-body-paragraph if ig hi ih b ii mn ik il im mo io ip iq mp is it iu mq iw ix iy mr ja jb jc hb bi translated">为了托管构建，我们需要将http-server添加到我们的devDependencies并创建一个启动脚本，从添加http-server开始:</p><pre class="jo jp jq jr fd ms mt mu mv aw mw bi"><span id="abf5" class="lz lc hi mt b fi mx my l mz na">npm i -D http-server</span></pre><p id="5cbe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">并向package.json添加一个启动脚本，该脚本将托管dist文件夹，该文件夹是通过在端口8080上运行一个构建而创建的:</p><pre class="jo jp jq jr fd ms mt mu mv aw mw bi"><span id="f80e" class="lz lc hi mt b fi mx my l mz na">“start”: “http-server dist -- port 8080”</span></pre><p id="650f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要对此进行测试，请运行以下命令，然后打开浏览器到<a class="ae kb" href="http://localhost:8080" rel="noopener ugc nofollow" target="_blank"> http://localhost:8080 </a>:</p><pre class="jo jp jq jr fd ms mt mu mv aw mw bi"><span id="f4e6" class="lz lc hi mt b fi mx my l mz na">npm run build<br/>npm start</span></pre><p id="dade" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您应该看到应用程序现在正在运行。干得好！让我们把这些都打包到一个Docker容器中！</p><h1 id="ed15" class="lb lc hi bd ld le nq lg lh li nr lk ll lm ns lo lp lq nt ls lt lu nu lw lx ly bi translated">我来了，看了，做了记录</h1><h2 id="4248" class="lz lc hi bd ld ma mb mc lh md me mf ll iq mg mh lp iu mi mj lt iy mk ml lx mm bi translated">创建Dockerfile文件</h2><p id="af84" class="pw-post-body-paragraph if ig hi ih b ii mn ik il im mo io ip iq mp is it iu mq iw ix iy mr ja jb jc hb bi translated">现在让我们创建一个<code class="du nb nc nd mt b">Dockerfile</code>来构建骨骼计数器并为我们服务。</p><p id="11a0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在repo的根中创建Dockerfile(字面意思是Dockerfile，没有扩展),我们将基于当前的Alpine节点LTS(撰写本文时有14个)。</p><p id="bbc8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将添加一些代码来复制文件，构建应用程序并在Docker容器中使用http-server从我们的start命令运行它。</p><pre class="jo jp jq jr fd ms mt mu mv aw mw bi"><span id="5de4" class="lz lc hi mt b fi mx my l mz na">FROM mhart/alpine-node:14<br/><br/>WORKDIR /app<br/><br/>COPY package.json package-lock.json ./<br/><br/># If you have native dependencies, you'll need extra tools<br/># RUN apk add --no-cache make gcc g++ python3<br/><br/>RUN npm ci<br/><br/>COPY . .<br/><br/>RUN npm run build<br/><br/># Run the npm start command to host the server<br/>CMD ["npm", "start"]</span></pre><p id="a43b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们还将添加一个<code class="du nb nc nd mt b">.dockerignore</code>来确保我们<em class="jm">不会意外地复制我们不想要的东西，比如node_modules </em>，因为我们将把它安装在代理上。</p><pre class="jo jp jq jr fd ms mt mu mv aw mw bi"><span id="939e" class="lz lc hi mt b fi mx my l mz na">node_modules<br/>npm-debug.log<br/>dist</span></pre><p id="9f52" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">回到over文件，重要的是要注意我们为什么首先复制<code class="du nb nc nd mt b">package*</code>文件，这是因为层缓存。</p><p id="a02d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我们在<code class="du nb nc nd mt b">package.json</code>或<code class="du nb nc nd mt b">package-lock.json</code>改变了什么，码头工人会知道，并从那条线向下重建。</p><p id="6c65" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，如果你只改变了应用程序文件，它将使用缓存版本的<code class="du nb nc nd mt b">package.json</code>和它的安装，并将只运行我们构建的层和之后的层。</p><p id="9096" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当您进行大型安装，或者需要多次重建映像以获得更大的存储库时，这可以大大节省时间。</p><p id="13fe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们构建图像并将其标记为<code class="du nb nc nd mt b">arthur</code>。确保您在docker文件所在的根目录中。</p><pre class="jo jp jq jr fd ms mt mu mv aw mw bi"><span id="26ad" class="lz lc hi mt b fi mx my l mz na">docker build . -t arthur</span></pre><p id="ca7b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">输出应该如下所示:</p><figure class="jo jp jq jr fd js er es paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="er es nv"><img src="../Images/5c7987be459c9b944bbd7aa718df49a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*uSIHASrfnEXPn5lB"/></div></div></figure><p id="79f7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">构建完成后，我们将运行刚刚构建的映像，并将正在运行的容器上的端口8080转发到主机端口9000，而不是直接到达主机上的8080。</p><pre class="jo jp jq jr fd ms mt mu mv aw mw bi"><span id="d541" class="lz lc hi mt b fi mx my l mz na">docker run -p 9000:8080 arthur</span></pre><figure class="jo jp jq jr fd js er es paragraph-image"><div class="er es nw"><img src="../Images/41d531d5b0b97d3763700ec1a7749209.png" data-original-src="https://miro.medium.com/v2/resize:fit:1136/0*Zjftn0OeW9TPNNTX"/></div></figure><p id="5852" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意，我们在日志中看到它在端口8080上运行，但这是来自容器内部的<strong class="ih hj">。</strong>要查看站点，我们需要使用<code class="du nb nc nd mt b">-p 9000:8080</code>标志设置主机端口9000。</p><p id="92a6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">导航到<a class="ae kb" href="http://localhost:9000" rel="noopener ugc nofollow" target="_blank"> http://localhost:9000 </a>，您应该会看到应用程序:</p><figure class="jo jp jq jr fd js er es paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="er es nx"><img src="../Images/1fb0425e3dcba4597245262419772648.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vb6wT3-EQYW5XVux"/></div></div></figure><p id="a3f0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">恭喜你！<strong class="ih hj">您现在正在Docker容器中运行一个web应用程序！在继续之前，喝杯你想要的庆祝咖啡或啤酒，我就在这里看Youtube上的猫视频。</strong></p><h1 id="61b3" class="lb lc hi bd ld le nq lg lh li nr lk ll lm ns lo lp lq nt ls lt lu nu lw lx ly bi translated">你应该测试你的应用程序</h1><h2 id="29f3" class="lz lc hi bd ld ma mb mc lh md me mf ll iq mg mh lp iu mi mj lt iy mk ml lx mm bi translated">编写剧作家测试</h2><p id="fe59" class="pw-post-body-paragraph if ig hi ih b ii mn ik il im mo io ip iq mp is it iu mq iw ix iy mr ja jb jc hb bi translated">在下一部分中，我们将介绍如何向项目中添加剧作家和笑话，并且我们将针对正在运行的应用程序运行一些测试。我们将使用<code class="du nb nc nd mt b">jest-playwright</code>来配置Jest并在测试时运行服务器，它应该带有许多样板类型的代码。</p><p id="d35d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">剧作家是微软的一个库，它的API几乎是1比1，可以通过标准的javascript API运行浏览器。</p><p id="3248" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最大的区别是，Puppeteer仅限于基于chromium的浏览器，但剧作家包括一个特殊的WebKit浏览器运行时，可以帮助覆盖浏览器与Safari的兼容性。</p><p id="a7c7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">出于你自己的需要，你可能想使用Selenium，Cypress.io，Puppeteer，或者其他什么东西。JavaScript生态系统中有许多优秀的自动化和端到端测试工具，所以不要害怕尝试其他东西！</p><p id="0a30" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以回到我们的教程，让我们从添加我们需要的<code class="du nb nc nd mt b">devDependencies</code>开始，它们是Jest，剧作家的预置，剧作家本身，以及一个很好的expect库来帮助我们断言条件。</p><pre class="jo jp jq jr fd ms mt mu mv aw mw bi"><span id="cb97" class="lz lc hi mt b fi mx my l mz na">npm install -D jest jest-playwright-preset playwright expect-playwright</span></pre><p id="e943" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将在项目的根目录下创建一个<code class="du nb nc nd mt b">jest.e2e.config.js</code>文件，并指定<code class="du nb nc nd mt b">preset</code>以及一个仅运行e2e测试的<code class="du nb nc nd mt b">testMatch</code>属性。我们还将在这里设置expect-剧作家断言。</p><pre class="jo jp jq jr fd ms mt mu mv aw mw bi"><span id="54ef" class="lz lc hi mt b fi mx my l mz na">module.exports = {<br/>  preset: 'jest-playwright-preset',<br/>  setupFilesAfterEnv: ['expect-playwright'],<br/>  testMatch: ['**/*.e2e.js']<br/>};</span></pre><blockquote class="jv jw jx"><p id="ccab" class="if ig jm ih b ii ij ik il im in io ip jy ir is it jz iv iw ix ka iz ja jb jc hb bi translated">请注意，这种通过命名的分离对于这个演示项目来说并不重要。然而，在一个真实的项目中，你也会有单元测试(<strong class="ih hj">你*确实*有100%覆盖率的单元测试，不是吗… </strong>)，并且你会因为性能和其他原因想要单独运行这些套件。</p></blockquote><p id="adfd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们还将为<code class="du nb nc nd mt b">jest-playwright</code>添加一个配置文件，这样我们就可以在运行测试之前运行服务器。用以下内容创建一个<code class="du nb nc nd mt b">jest-playwright.config.js</code>。</p><pre class="jo jp jq jr fd ms mt mu mv aw mw bi"><span id="bb16" class="lz lc hi mt b fi mx my l mz na">// jest-playwright.config.js<br/><br/>module.exports = {<br/>    browsers: ['chromium', 'webkit', 'firefox'],<br/>    serverOptions: {<br/>        command: 'npm run start',<br/>        port: 8080,<br/>        usedPortAction: 'kill', // kill any process using port 8080<br/>        waitOnScheme: {<br/>            delay: 1000, // wait 1 second for tcp connect <br/>        }<br/>    }<br/>}</span></pre><p id="3fae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我们运行e2e测试套件时，这个配置文件也会自动为我们启动服务器，太棒了！</p><h2 id="f63e" class="lz lc hi bd ld ma mb mc lh md me mf ll iq mg mh lp iu mi mj lt iy mk ml lx mm bi translated">编写测试</h2><p id="0d88" class="pw-post-body-paragraph if ig hi ih b ii mn ik il im mo io ip iq mp is it iu mq iw ix iy mr ja jb jc hb bi translated">现在让我们继续写一个快速测试场景，我们将打开站点，测试一些动作，并断言它们做了我们期望的事情(安排、动作、断言！).</p><p id="60ac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">继续在<code class="du nb nc nd mt b">__tests__/e2e/</code>目录中创建<code class="du nb nc nd mt b">arthur.e2e.js</code>(如果不存在，则创建该目录)。</p><p id="2002" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">测试将如下所示:</p><pre class="jo jp jq jr fd ms mt mu mv aw mw bi"><span id="ac77" class="lz lc hi mt b fi mx my l mz na">describe('arthur', () =&gt; {<br/>    beforeEach(async () =&gt; {<br/>        await page.goto('http://localhost:8080/')<br/>    })<br/><br/>    test('should show the page with buttons and initial state', async () =&gt; {<br/>        await expect(page).toHaveText("#dog-message", "I'm waiting...");<br/>        await expect(page).toHaveText("#bone-count", "Current bone count: 0");<br/>    });<br/><br/>    test('should count up and woof when a bone is given', async () =&gt; {<br/>        await page.click("#give-bone");<br/>        await expect(page).toHaveText("#dog-message", "Woof!");<br/>        await expect(page).toHaveText("#bone-count", "Current bone count: 1");<br/>        <br/>    });<br/><br/>    test('should count down and whine when a bone is taken', async () =&gt; {<br/>        await page.click("#give-bone");<br/>        await page.click("#give-bone");<br/>        // first give 2 bones so we have bones to take!<br/>        await expect(page).toHaveText("#dog-message", "Woof!");<br/>        await expect(page).toHaveText("#bone-count", "Current bone count: 2");<br/><br/><br/>        await page.click("#take-bone");<br/>        <br/>        await expect(page).toHaveText("#dog-message", "Whine!");<br/>        await expect(page).toHaveText("#bone-count", "Current bone count: 1");<br/><br/>    });<br/><br/>    test('should be confused when a bone is taken and the count is zero', async () =&gt; {<br/>        // check it's 0 first<br/>        await expect(page).toHaveText("#dog-message", "I'm waiting...");<br/>        await expect(page).toHaveText("#bone-count", "Current bone count: 0");<br/>        <br/>        await page.click("#take-bone");<br/>        <br/>        await expect(page).toHaveText("#dog-message", "I'm confused!");<br/>        await expect(page).toHaveText("#bone-count", "Current bone count: 0");<br/>    });<br/>})</span></pre><p id="e679" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，我们不会详细讨论剧作家的语法，但是你应该对上面的测试有一个基本的概念。</p><p id="5045" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果不太清楚，你可以查看一下剧作家的文档，或者试着用调试器一步一步地测试。</p><p id="a535" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您继续操作并启用了VS代码上的<code class="du nb nc nd mt b">eslint</code>，您也可能在上面的文件中得到一些<code class="du nb nc nd mt b">eslint</code>错误。</p><p id="a8f8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以添加<code class="du nb nc nd mt b">eslint-plugin-jest-playwright</code>并使用推荐设置上的扩展来正确地在e2e目录中lint。</p><p id="8075" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先安装<code class="du nb nc nd mt b">devDependencies</code> <code class="du nb nc nd mt b">eslint-plugin-jest-playwright</code>:</p><pre class="jo jp jq jr fd ms mt mu mv aw mw bi"><span id="db47" class="lz lc hi mt b fi mx my l mz na">npm i -D eslint-plugin-jest-playwright</span></pre><p id="0a73" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后在<code class="du nb nc nd mt b">__tests__/e2e</code>中创建一个<code class="du nb nc nd mt b">.eslintrc.js</code>文件，如下所示:</p><pre class="jo jp jq jr fd ms mt mu mv aw mw bi"><span id="9501" class="lz lc hi mt b fi mx my l mz na">module.exports = {<br/>    extends: [<br/>        'plugin:jest-playwright/recommended'<br/>    ]<br/>};</span></pre><p id="e263" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">再见，红色的波浪线！</p><h2 id="7ddc" class="lz lc hi bd ld ma mb mc lh md me mf ll iq mg mh lp iu mi mj lt iy mk ml lx mm bi translated">运行测试运行！</h2><p id="8648" class="pw-post-body-paragraph if ig hi ih b ii mn ik il im mo io ip iq mp is it iu mq iw ix iy mr ja jb jc hb bi translated">既然已经正确设置了测试，我们将继续添加一个脚本来从<code class="du nb nc nd mt b">package.json</code>运行它们。</p><p id="0111" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">添加如下<code class="du nb nc nd mt b">test:e2e</code>脚本:</p><pre class="jo jp jq jr fd ms mt mu mv aw mw bi"><span id="13ea" class="lz lc hi mt b fi mx my l mz na">“test:e2e”: “jest — config jest.e2e.config.js”</span></pre><p id="a58b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将告诉jest使用e2e配置，而不是默认的单元测试配置(<code class="du nb nc nd mt b">jest.config.js</code>)。</p><p id="8e6d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在继续进行测试，继续努力！</p><blockquote class="jv jw jx"><p id="8ced" class="if ig jm ih b ii ij ik il im in io ip jy ir is it jz iv iw ix ka iz ja jb jc hb bi translated">请注意，如果您没有正确的系统依赖项，您可能需要设置一些库。为此，请直接查阅剧作家文档，或者直接跳到Docker部分，那里有你需要的所有东西。</p></blockquote><h2 id="f825" class="lz lc hi bd ld ma mb mc lh md me mf ll iq mg mh lp iu mi mj lt iy mk ml lx mm bi translated">在Docker容器中运行它</h2><p id="4ca9" class="pw-post-body-paragraph if ig hi ih b ii mn ik il im mo io ip iq mp is it iu mq iw ix iy mr ja jb jc hb bi translated">现在，我们将把它们放在一起，在一个Docker容器中运行e2e测试，这个容器有我们需要的所有依赖项，这将使我们能够轻松地<strong class="ih hj">伸缩</strong>以及<a class="ae kb" href="https://docs.github.com/en/actions/learn-github-actions/managing-complex-workflows#using-a-build-matrix" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">运行一个矩阵</strong> </a> ( <em class="jm">我们在本文中没有涉及，但可能在第2部分</em>中)。</p><p id="1a01" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">像这样创建一个<code class="du nb nc nd mt b">Dockerfile.e2e</code>:</p><pre class="jo jp jq jr fd ms mt mu mv aw mw bi"><span id="413e" class="lz lc hi mt b fi mx my l mz na"># Prebuilt MS image<br/>FROM mcr.microsoft.com/playwright:bionic<br/><br/>WORKDIR /app<br/><br/>COPY package.json package-lock.json ./<br/><br/>RUN npm ci<br/><br/>COPY . .<br/><br/>RUN npm run build<br/><br/># Run the npm run test:e2e command to host the server and run the e2e tests<br/>CMD ["npm", "run", "test:e2e"]</span></pre><blockquote class="jv jw jx"><p id="7a7b" class="if ig jm ih b ii ij ik il im in io ip jy ir is it jz iv iw ix ka iz ja jb jc hb bi translated">请注意，这里的CMD设置为运行e2e测试。这是因为我们希望将测试作为容器的启动命令运行，而不是作为容器构建过程的一部分。这并不是您与CI提供者一起运行的方式，因此YMMV。</p></blockquote><p id="6d4f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">继续运行容器的<code class="du nb nc nd mt b">docker build</code>，并指定不同的<code class="du nb nc nd mt b">tag</code>和<code class="du nb nc nd mt b">Dockerfile:</code></p><pre class="jo jp jq jr fd ms mt mu mv aw mw bi"><span id="ed1a" class="lz lc hi mt b fi mx my l mz na">docker build . -f Dockerfile.e2e -t arthur-e2e</span></pre><p id="ffc5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个演示<strong class="ih hj">中，我们用</strong>中的测试构建了容器 <strong class="ih hj">，但是理论上你可以从<code class="du nb nc nd mt b">COPY</code>命令中排除测试，并且可以<strong class="ih hj">挂载一个测试卷</strong>，这样你就不需要在测试变化之间重新构建。</strong></p><p id="5ba4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以使用下面的命令运行容器并查看测试结果(在测试结束时，<code class="du nb nc nd mt b">--rm</code>标志将移除容器，这样我们就不会让容器挂起):</p><pre class="jo jp jq jr fd ms mt mu mv aw mw bi"><span id="4b83" class="lz lc hi mt b fi mx my l mz na">docker run --rm arthur-e2e</span></pre><p id="97d6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您应该会看到如下所示的输出:</p><figure class="jo jp jq jr fd js er es paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="er es ny"><img src="../Images/e1f874aa1808f788f72b904232e7fa55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*v0Jm4TtHgyeVH51Q"/></div></div></figure><p id="8f61" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">干得好！你刚刚在Docker容器中运行了WebKit、Chromium和FireFox的e2e测试！</p><p id="52c0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你喜欢这个教程，并且你想加入一个正在寻找优秀人才的令人惊叹的创业公司，请前往<a class="ae kb" href="https://www.tipalti.com/careers" rel="noopener ugc nofollow" target="_blank"> Tipalti Careers </a>！</p><p id="e07e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您想评论或添加一些反馈，也请随意，我们一直在寻求改进！</p></div></div>    
</body>
</html>