# 代码生成很可怕；我喜欢它

> 原文：<https://medium.com/geekculture/code-generation-is-terrible-i-love-it-27d2ba2ce68b?source=collection_archive---------49----------------------->

重复生成的代码“干”吗？

![](img/b700c60b21318ebc3af046d2078f0821.png)

Photo by [Austrian National Library](https://unsplash.com/@austriannationallibrary?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) on [Unsplash](https://unsplash.com/s/photos/factory-line?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)

如果你没有听说过“不要重复自己”或者 DRY，那么我很可能没有审查过你的代码。不要两次写同样的代码。如果你需要在两个地方做同样的事情，是时候重构和提取代码了。这是一个非常简单的概念，但也是不完整的。

我在没有这样做的公司工作过。您最终得到的是在 10 个位置复制/粘贴块，它们的功能略有不同。如果一个有错误，你不能确定下一个复制/粘贴块是否有同样的错误。你花了几个晚上调试为什么 Y 块不能正常工作，只是为了发现它实际上是 z 块。

这些天来，如果我看到一个合并的请求，而这个合并在多个地方改变了同一行，我就开始反胃。时不时的，还是会发生。罪魁祸首通常不是政治、管理，就是“新人”。最近，复制代码的最大元凶是代码生成器，而不是人。

我对代码生成器的介绍是在 2000 年代末，当时我在尝试使用 Ruby on Rails。观看教程“运行这个命令…”并在几分钟内建立一个完整的“Hello，World”网站。当我每周都开始新项目，但从未完成时，这对我很有吸引力。

然而，惊讶是短暂的，当我发现我犯了一个错别字，并传播到 10 个不同的地方。很容易解决:从头开始，这次做对了。如果发生了这种情况，而且我的注意力持续时间超过了 7 天，结果将会是灾难性的。

Ruby on Rails 使用的另一个工具是“ActiveRecord ”,这是我第一次将动态元编程理解为一个概念。

对于外行来说，元编程是将一个程序用作另一个程序的数据的概念。反射是元编程的子集，其中程序将自身用作数据。

Ruby on Rails 动态运行时反射的最好例子是在活动记录对象上调用类似于“find_by_email”的方法。它会看到对一个不存在的函数的调用，并根据名字和对象动态地生成它*，所以:*

*   *' find ':我们希望找到这种类型的(单个)记录*
*   *' by ':我们希望使用字段的值来找到它。*
*   *'电子邮件':我们要使用的字段是'电子邮件'。*

*所以现在，有了足够的信息来猜测开发人员试图做什么，活动记录就可以让它发生。这好像是**干的**？绝对的！我们现在已经将所有类似的“find”方法减少到一个函数，这个函数嵌套在父对象中的某个位置。*

*这对于 Ruby on Rails 来说效果很好。许多语言甚至开始复制它，因为它很有效，而且超级容易使用。这只需要该语言的两个特性就可以工作:*

1.  *能够在运行时知道对不存在的方法的调用；和*
2.  *能够在运行时知道对象上有哪些字段可用。*

*需要的功能很少，但是还需要更多的功能才能使*有用*。首先，Ruby on Rails 是一种动态类型语言。虽然并非不可能，但“如何检查一个不存在的方法的类型安全？”想起来了。像继承这样的工具也有助于将这些动态功能分配给对象。*

*虽然我非常喜欢这种类型的动态元编程，但它在大型作品中表现不佳。两大原因是它的速度和可靠性。虽然可以做得很好，但也很容易做错。软件开发中的许多事情都是如此，但是可怕的动态元编程不会在你编译代码时出现，它会在你运行代码时出现。如果你幸运的话，它会在你运行它的时候发生，而不是当你的代码运行在一个你甚至不能访问的产品服务器上的时候。*

*向前跳大约 12 年。我现在已经毕业了，我在一家大型计算机公司工作，在 Go 中编写微型容器包，这时我开始开发一个现有的包，它使用了一个有趣的工具: [go-swagger](https://github.com/go-swagger/go-swagger) 。它的基础非常简单:给定一个 API 描述，生成其余必要的代码，这样您就可以添加实现细节了。*

*go-swagger 是代码生成的另一个例子。输出是可执行的 Go 代码，因为上面的 Ruby on Rails 示例是 Ruby 代码。区别在于输入。Ruby on Rails 依赖于长 bash 命令，而 go-swagger 使用 YAML 或 JSON 文件存储数据。通过这一个小的改变，您现在可以重新运行这个生成。API 可能会发生变化，因此这非常有帮助。*

*在使用 go-swagger 后不久，就必须对 API 进行修改。因为一个小小的改动，几十个文件被修改了。这是干的吗？代码生成是否只是去除了“当你需要重复你的代码时重构”的想法，并使用自动化加剧了这个问题？更重要的是，为什么这是一件好事？*

*巧合的是，在我寻找复制/粘贴块 A 和 Z 中的 bug 的时候，我读了安迪·亨特和迪夫·托马斯的开创性著作《实用程序员》。这本书就是“干”的来源。他们实际上出版了他们新的“20 周年”版本的[干燥章节](http://media.pragprog.com/titles/tpp20/dry.pdf)作为样本，我绝对推荐阅读它和这本书。*

*不幸的是，我在关于干燥的章节中错过了一个关键的想法。这是微妙的，但它甚至在干燥的定义。*

> *“每一项知识都必须在一个系统中有一个单一的、明确的、权威的表述”——安迪·亨特和迪夫·托马斯；务实的程序员*

*你看到了吗？实际上并没有提到*代码*。讲的是**知识**。那是什么意思？这意味着这与重构代码无关。它是关于重构知识的，重构知识是你的代码的超集。更具体地说，这种情况下的“知识”可以指从您使用的 SQL、您设计的 API、您编程的对象甚至您编写的文档中的一切。*

*那么这如何适用于我们这一代人呢？简单地说，系统中只有一个“权威表示”，那就是 API 文档。API 文档应该尽可能系统地影响程序的设计。*

*为什么 go-swagger 不只是动态读取 API 描述，并在运行时产生一个起作用的 API？Go 是一种非常轻量级的、面向性能的静态类型编程语言。虽然它在任何语言中都是绝对可能的，但在考虑性能时，它不一定有用。*

*围棋已经演变成了一种小而锋利的工具语言。它对小目录大小的包的关注有助于使代码可重用和易于阅读。包是静态类型的，“什么都不隐藏”。当你创建对象时，没有神奇的构造方法碰巧执行随机任务。构造函数看起来如此明显，以至于当我开始学习 Go 时，没有构造函数的语言看起来几乎是过时的。*

*代码生成以一种执行的方式为静态类型编程语言提供了元编程。go-swagger 使用一组基于 API 不变的部件的库包，以及一组用于表示您的 API 的部件的结构化实现函数和数据模型来实现这一点。这是一个很好的方法，因为对库包的修改不需要中断实现细节。*

*对于精通 Go 的人来说，像 Active Record 那样加载一个整体包来慢慢构建动态功能的想法是完全愚蠢的。有些 ORM 确实是为 Go 而存在的，但是在有人告诉你只使用这个或那个 SQL helper 并完成它之前，你不能在一个讨论中进行两个以上的评论。*

*那么，如何使用 go-swagger 的 YAML Go 生成方法来管理 SQL 数据库呢？它是存在的。有几个不同的包，像 [sqlingo](https://github.com/lqs/sqlingo) 或 [xo](https://github.com/xo/xo) ，允许你从你的数据库模式生成 go 代码。但是如果您想同时使用这个 SQL 平台和 go-swagger 呢？那不会是枯燥的，因为现在你有*两个独立的*可能冲突的知识体:你的数据库和你的 API。我喜欢把这些看作是“由外向内”的方法，因为程序的外部部分决定或产生了内部正在发生的事情。*

*最近，我开始从事一个涉及到 Kubernetes 的项目，一些 Kubernetes 工具可以生成脚手架和 YAML 文件。关于这些工具，我注意到的有趣的事情是，这与狂妄自大的方法相反。他们通过扫描 Go 码生产 YAML。您可以在代码中放置“标记”，即奇特的注释，controller-gen 工具会读取注释和相关代码，并生成您的 YAML。*

*controller-gen 方法很有帮助，因为它在系统中有一个“权威表示”,那就是您的代码。这是一种“由内而外”的方法，因为代码规定了 YAML 的外观，只是作为代码存在。*

*这让我想到了一个思想实验:如果完全采用这种“由内向外”的权威表示方法，会是什么样子？嗯，它将从一些简单的 Go 模型开始，混合有标签、标记和文档。文档和模型将生成 API 描述，而模型将生成 SQL 数据库和一组助手函数。*

*go-swagger 确实允许类似的事情发生。它允许您在代码中添加注释，以生成 API 描述。这种方法非常相似，但它缺少一个关键部分。它不能从你的代码中获取所有的内容。它*不*要求你复制关于哪个 API 路由做什么的知识。*

*至于 SQL？我还没有找到这样的工具。我已经找到了大量的 SQL 构建器，也找到了一些要生成的 SQL，但是我还没有找到任何可以为我构建 SQL 的工具。*

## *资源*

*[Ruby on Rails](https://rubyonrails.org)*

*[务实的程序员](https://pragprog.com/titles/tpp20/the-pragmatic-programmer-20th-anniversary-edition/) —安迪·亨特和迪夫·托马斯(20 周年纪念版)*

*[干章](http://media.pragprog.com/titles/tpp20/dry.pdf)务实的程序员，《20 周年纪念》版*

*[围棋编程语言](https://golang.org)*

*[招摇过市](https://github.com/go-swagger/go-swagger)*

*[Kubernetes](https://kubernetes.io)*