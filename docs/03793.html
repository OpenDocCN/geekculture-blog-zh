<html>
<head>
<title>Customer Churn prediction with Spark</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用Spark进行客户流失预测</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/customer-churn-prediction-with-spark-f71c358a48bb?source=collection_archive---------42-----------------------#2021-06-15">https://medium.com/geekculture/customer-churn-prediction-with-spark-f71c358a48bb?source=collection_archive---------42-----------------------#2021-06-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/c5ee6806d49f073edd7373e572d8dd66.png" data-original-src="https://miro.medium.com/v2/resize:fit:550/format:webp/1*VevMPiGb-LJaRLtXey693Q.png"/></div></figure><figure class="in io ip iq fd ij er es paragraph-image"><div class="er es im"><img src="../Images/5429365168ac9806b798bf1de1d1731a.png" data-original-src="https://miro.medium.com/v2/resize:fit:706/format:webp/1*17SMTDfn7MRswwXfz6y4jA.jpeg"/></div></figure></div><div class="ab cl ir is gp it" role="separator"><span class="iu bw bk iv iw ix"/><span class="iu bw bk iv iw ix"/><span class="iu bw bk iv iw"/></div><div class="hb hc hd he hf"><p id="8419" class="pw-post-body-paragraph iy iz hi ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hb bi translated">2020年6月15日</p><h2 id="a88d" class="jx jy hi bd jz ka kb kc kd ke kf kg kh jj ki kj kk jn kl km kn jr ko kp kq kr bi translated">项目定义</h2><p id="cd47" class="pw-post-body-paragraph iy iz hi ja b jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr kw jt ju jv hb bi translated">客户流失预测具有挑战性，但这是数据分析师和/或企业在所有B2C行业中经常遇到的问题。<br/>准确而成功地预测客户流失对每个B2C公司来说都是非常高效和节省时间/金钱的。</p><p id="dc48" class="pw-post-body-paragraph iy iz hi ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hb bi translated">这是我在一门叫做Udacity数据科学Nanadegree的课程中的最后一个项目。我曾在一家名为Sparkify的虚拟音乐流媒体服务上预测客户流失。为此，我使用了最小的可用数据集(128MB)，但它们有一个中型和一个大型，但对于最后一个，建议使用IBM Watson Studio或AWS来构建和调整机器学习模型。</p></div><div class="ab cl ir is gp it" role="separator"><span class="iu bw bk iv iw ix"/><span class="iu bw bk iv iw ix"/><span class="iu bw bk iv iw"/></div><div class="hb hc hd he hf"><h2 id="8cbd" class="jx jy hi bd jz ka kb kc kd ke kf kg kh jj ki kj kk jn kl km kn jr ko kp kq kr bi translated">问题陈述</h2><p id="d950" class="pw-post-body-paragraph iy iz hi ja b jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr kw jt ju jv hb bi translated">通过Sparkify，用户可以播放他们想要的歌曲，如果他们需要就喜欢它们，如果他们必须强调与歌曲相关的挑战，就提供拇指向下。用户可以付费订阅，也可以免费收听。</p><p id="381f" class="pw-post-body-paragraph iy iz hi ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hb bi translated">作为Sparkify数据科学家团队的一员，我们被要求寻找客户流失的指标。从探索数据开始，看看我们可以使用数据集中的哪些功能，我们将进行探索性的数据分析，并根据用户特征评估适合的模型。</p><p id="7e39" class="pw-post-body-paragraph iy iz hi ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hb bi translated">在我们的数据集中，我们创建了一个名为“Churn”的新列，我们将使用它作为我们的机器学习模型的标签。我们将使用取消确认事件来定义该项目的变动。</p><figure class="in io ip iq fd ij"><div class="bz dy l di"><div class="kx ky l"/></div></figure><p id="89fc" class="pw-post-body-paragraph iy iz hi ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hb bi translated">数据集中大约有23%的用户有过不愉快，这表明数据集是不平衡的。</p></div><div class="ab cl ir is gp it" role="separator"><span class="iu bw bk iv iw ix"/><span class="iu bw bk iv iw ix"/><span class="iu bw bk iv iw"/></div><div class="hb hc hd he hf"><h2 id="f6aa" class="jx jy hi bd jz ka kb kc kd ke kf kg kh jj ki kj kk jn kl km kn jr ko kp kq kr bi translated">韵律学</h2><p id="7cdd" class="pw-post-body-paragraph iy iz hi ja b jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr kw jt ju jv hb bi translated">为了解决这个问题，我们将使用分类算法。</p><p id="6725" class="pw-post-body-paragraph iy iz hi ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hb bi translated">为了预测数据集的类别，我们可以使用许多分类算法。当我们在开发我们的机器学习模型时，我们会训练和评估一定数量的机器学习模型，我们会保留那些预测性能更好的机器学习模型。我们将使用其中的3种:逻辑回归、随机森林和梯度。被提升的树。</p><p id="fdbb" class="pw-post-body-paragraph iy iz hi ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hb bi translated">两个指标用于评估我们的模型:</p><p id="a827" class="pw-post-body-paragraph iy iz hi ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hb bi translated">准确度衡量分类器做出正确预测的频率。它是正确预测数与总预测数的比率。</p><p id="0c26" class="pw-post-body-paragraph iy iz hi ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hb bi translated">F1分数，它是精确度和召回分数的加权平均值。该分数的范围从0到1，1是F1的最佳分数。</p></div><div class="ab cl ir is gp it" role="separator"><span class="iu bw bk iv iw ix"/><span class="iu bw bk iv iw ix"/><span class="iu bw bk iv iw"/></div><div class="hb hc hd he hf"><h2 id="6c80" class="jx jy hi bd jz ka kb kc kd ke kf kg kh jj ki kj kk jn kl km kn jr ko kp kq kr bi translated">数据探索和可视化</h2><p id="bc1b" class="pw-post-body-paragraph iy iz hi ja b jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr kw jt ju jv hb bi translated">加载和清理数据集</p><p id="e817" class="pw-post-body-paragraph iy iz hi ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hb bi translated">在以JSON格式加载原始数据集之后，我们丢弃了所有不必要的或缺失的数据，比如没有userids或sessionsIDs的记录。</p><figure class="in io ip iq fd ij"><div class="bz dy l di"><div class="kx ky l"/></div></figure><figure class="in io ip iq fd ij er es paragraph-image"><div class="er es kz"><img src="../Images/c1139238fec25aef6b45d4ed43cb2dc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:964/format:webp/1*ZaELkU3E7lP-pufH_GifcQ.png"/></div></figure><p id="df71" class="pw-post-body-paragraph iy iz hi ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hb bi translated">在这里，我们将深入观察那些留下来的cs用户的行为，那些流失的用户以及影响流失的属性。</p><figure class="in io ip iq fd ij er es paragraph-image"><div class="er es la"><img src="../Images/f2bf501f85779d7f3c598d1a48730368.png" data-original-src="https://miro.medium.com/v2/resize:fit:744/format:webp/1*HMUAD7ouirXISZ0d6Xn0vQ.png"/></div><figcaption class="lb lc et er es ld le bd b be z dx">Churn based on gender</figcaption></figure><figure class="in io ip iq fd ij er es paragraph-image"><div class="er es lf"><img src="../Images/bafaa3a5eb036653f65dcddfe8fa4a49.png" data-original-src="https://miro.medium.com/v2/resize:fit:756/format:webp/1*WBwSEfM_V0xNbw0Jv2OzlQ.png"/></div><figcaption class="lb lc et er es ld le bd b be z dx">Churn based on free or paid users</figcaption></figure><figure class="in io ip iq fd ij er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es lg"><img src="../Images/aa3ecced56b6b04227dfc394205e63e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KXsZVMa8ZrK1eVjmL2F9yQ.png"/></div></div><figcaption class="lb lc et er es ld le bd b be z dx">Churn based on activities</figcaption></figure><p id="231a" class="pw-post-body-paragraph iy iz hi ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hb bi translated">从第一张图表中，我们可以看到19%的女性用户和26%的男性用户有过不愉快的经历。男性用户的流失率更高，从第二张图表可以看出，免费用户的流失率比免费用户高。在最后一张图表中，我们可以看到与客户流失相比的活动相关变量。很难有一个明确的互动访问页面和流失。滚动规避、提交降级/升级、拇指向下、升级等属性似乎比其他页面访问与客户流失的关系更密切。</p><h2 id="dfb0" class="jx jy hi bd jz ka kb kc kd ke kf kg kh jj ki kj kk jn kl km kn jr ko kp kq kr bi translated">特征工程</h2><p id="5619" class="pw-post-body-paragraph iy iz hi ja b jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr kw jt ju jv hb bi translated">基于前面的分析，我们将生成以下特征:</p><ul class=""><li id="ff0e" class="ll lm hi ja b jb jc jf jg jj ln jn lo jr lp jv lq lr ls lt bi translated">任期:最后一次访问日和注册日之间的天数</li><li id="2600" class="ll lm hi ja b jb lu jf lv jj lw jn lx jr ly jv lq lr ls lt bi translated">state:位置变量中的州名</li><li id="de5d" class="ll lm hi ja b jb lu jf lv jj lw jn lx jr ly jv lq lr ls lt bi translated">浏览器:从用户代理检索的浏览器信息</li><li id="e645" class="ll lm hi ja b jb lu jf lv jj lw jn lx jr ly jv lq lr ls lt bi translated">os:从用户代理检索的操作系统信息</li><li id="e317" class="ll lm hi ja b jb lu jf lv jj lw jn lx jr ly jv lq lr ls lt bi translated">设备:从用户代理检索的设备信息</li><li id="19bd" class="ll lm hi ja b jb lu jf lv jj lw jn lx jr ly jv lq lr ls lt bi translated">num_songs:用户听的歌曲数量</li><li id="0b2d" class="ll lm hi ja b jb lu jf lv jj lw jn lx jr ly jv lq lr ls lt bi translated">num_artists:用户收听的艺术家数量</li><li id="ca46" class="ll lm hi ja b jb lu jf lv jj lw jn lx jr ly jv lq lr ls lt bi translated">avg_length:用户听的歌曲的平均长度</li><li id="81c3" class="ll lm hi ja b jb lu jf lv jj lw jn lx jr ly jv lq lr ls lt bi translated">几个布尔变量表示对“滚动避免”、“提交降级”、“提交升级”、“拇指向下”、“添加朋友”和“添加到播放列表”的页面访问</li></ul><figure class="in io ip iq fd ij"><div class="bz dy l di"><div class="kx ky l"/></div></figure><h2 id="4655" class="jx jy hi bd jz ka kb kc kd ke kf kg kh jj ki kj kk jn kl km kn jr ko kp kq kr bi translated">特征转换</h2><p id="5e17" class="pw-post-body-paragraph iy iz hi ja b jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr kw jt ju jv hb bi translated">使用StringIndexer和OneHotEconderEstimator将分类变量转换为数字变量，以便在我们的机器学习模型中使用它们，并使用StandardScaler来避免特征“支配”其他特征。然后，我们建立我们的管道，我们将使用3个机器学习模型来预测流失:逻辑回归，随机森林分类器和梯度增强树分类器。</p><h2 id="b545" class="jx jy hi bd jz ka kb kc kd ke kf kg kh jj ki kj kk jn kl km kn jr ko kp kq kr bi translated">字符串索引</h2><p id="57ca" class="pw-post-body-paragraph iy iz hi ja b jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr kw jt ju jv hb bi translated">所有分类变量以及我们的标签列(' churn ')都需要使用Sparks StringIndexer进行索引，以便这些列不再包含表示类别值的字符串，而是包含索引。</p><h2 id="db77" class="jx jy hi bd jz ka kb kc kd ke kf kg kh jj ki kj kk jn kl km kn jr ko kp kq kr bi translated">一个热编码</h2><p id="dc26" class="pw-post-body-paragraph iy iz hi ja b jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr kw jt ju jv hb bi translated">我们的分类特征不是有序的，正因为如此，我们希望使用Sparks OneHotEncoder)执行一次热编码，这将为每个分类值创建一个新的二进制列(虚拟变量)。</p><h2 id="9b9f" class="jx jy hi bd jz ka kb kc kd ke kf kg kh jj ki kj kk jn kl km kn jr ko kp kq kr bi translated">…向量化…</h2><p id="764b" class="pw-post-body-paragraph iy iz hi ja b jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr kw jt ju jv hb bi translated">由于Spark分类器希望特性以单个列的形式出现，我们将应用VectorAssembler。</p><h2 id="2364" class="jx jy hi bd jz ka kb kc kd ke kf kg kh jj ki kj kk jn kl km kn jr ko kp kq kr bi translated">缩放比例</h2><p id="191f" class="pw-post-body-paragraph iy iz hi ja b jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr kw jt ju jv hb bi translated">最后，我们将使用Sparks StandardScaler来缩放特征值。当数值变量的范围差别很大时，这是有意义的。正如我们上面已经提到的,“下一首歌”事件比其他页面事件发生得更频繁。因此，计数变量的范围会有很大不同，缩放似乎是一个很好的选择。</p><figure class="in io ip iq fd ij"><div class="bz dy l di"><div class="kx ky l"/></div></figure><p id="c429" class="pw-post-body-paragraph iy iz hi ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hb bi translated">此外，我们将在建模前删除一些不必要的列。</p><h2 id="4486" class="jx jy hi bd jz ka kb kc kd ke kf kg kh jj ki kj kk jn kl km kn jr ko kp kq kr bi translated">建模</h2><p id="431c" class="pw-post-body-paragraph iy iz hi ja b jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr kw jt ju jv hb bi translated">对于我们的预测模型，我们将数据分成两个子集，分别用于训练(70%)和测试(30%)。</p><figure class="in io ip iq fd ij er es paragraph-image"><div class="er es lz"><img src="../Images/6c9a72471c8ee0a25cef401cc539f7cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1250/format:webp/1*WGnm9LilwRqckP7TOqDXew.png"/></div></figure><p id="e2e8" class="pw-post-body-paragraph iy iz hi ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hb bi translated">机器学习的最佳实践还建议创建一个验证数据集，但我们不会这样做，原因如下:<br/>验证数据集通常在模型优化过程中使用。只有在所有优化迭代之后，测试数据集才用于最终评估模型。<br/>我们将使用PySparks CrossValidator进行模型优化，现在没有必要。交叉验证将仅获得训练数据集作为输入，并将其分成几个子集用于优化本身。因此，我们将只需要一个进一步的数据子集(测试数据)来评估模型的性能。不创建验证集的优点是训练集可以更大(我们可以进行70/30分割，而不是60/20/20分割)，这对于最终的模型性能可能是至关重要的，因为我们现在只处理相当小的数据集，并且正在处理类不平衡。</p></div><div class="ab cl ir is gp it" role="separator"><span class="iu bw bk iv iw ix"/><span class="iu bw bk iv iw ix"/><span class="iu bw bk iv iw"/></div><div class="hb hc hd he hf"><p id="b0b9" class="pw-post-body-paragraph iy iz hi ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hb bi translated">下一步是训练和评估我们的模型。</p><p id="360a" class="pw-post-body-paragraph iy iz hi ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hb bi translated">在使用默认超参数拟合这些分类器之后，我们可以看到梯度。提升的树分类器表现最好，具有0.991的相当好的f1分数。</p><figure class="in io ip iq fd ij er es paragraph-image"><div class="er es ma"><img src="../Images/fdb6d6675dfba41655e4993103703483.png" data-original-src="https://miro.medium.com/v2/resize:fit:1006/format:webp/1*ezFKBvLfK1ihot0UV-3now.png"/></div><figcaption class="lb lc et er es ld le bd b be z dx"><strong class="bd jz">Logistic Regression Model</strong></figcaption></figure><figure class="in io ip iq fd ij er es paragraph-image"><div class="er es mb"><img src="../Images/5f40a0309bcb7469d13f73f6b2138022.png" data-original-src="https://miro.medium.com/v2/resize:fit:942/format:webp/1*SzxCyBWLi1eaYt-fGZFD6Q.png"/></div><figcaption class="lb lc et er es ld le bd b be z dx"><strong class="bd jz">Random Forest Classifier</strong></figcaption></figure><figure class="in io ip iq fd ij er es paragraph-image"><div class="er es mc"><img src="../Images/9943af739a9a0bb86d02edc17cdf3c30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1026/format:webp/1*ugZI7zwZvyV0hMyOvEHJ8Q.png"/></div><figcaption class="lb lc et er es ld le bd b be z dx"><strong class="bd jz">Gradient.Boosted Tree Classifier</strong></figcaption></figure><figure class="in io ip iq fd ij er es paragraph-image"><div class="er es md"><img src="../Images/cae03901181b52b55d70459ce7474e7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:758/format:webp/1*imxnEFPqOxUJ92440Td4hg.png"/></div><figcaption class="lb lc et er es ld le bd b be z dx">Confusion Matrix for Gradient.Boosted Tree Classifier</figcaption></figure><p id="234e" class="pw-post-body-paragraph iy iz hi ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hb bi translated">我们将通过交叉验证使用超参数调整。这些参数用于减少运行时间。</p><p id="e9bb" class="pw-post-body-paragraph iy iz hi ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hb bi translated">让我们从性能最好的分类器开始，尝试用一组不同的超参数来优化它的性能。</p><figure class="in io ip iq fd ij er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es me"><img src="../Images/e1a5b1301e7eb95ca67ae52f071df4a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lJssavRzATvOnEfH4Qo91Q.png"/></div></div></figure><p id="87cd" class="pw-post-body-paragraph iy iz hi ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hb bi translated">在拟合交叉验证模型之后，我们再次使用其最佳模型来预测test_data。表演稍微好了一点。</p><figure class="in io ip iq fd ij er es paragraph-image"><div class="er es mf"><img src="../Images/51836fd770772acc77e393d44fa29a84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1206/format:webp/1*IfuZHnOUg1Lubm-JRWtPhg.png"/></div></figure><p id="fb17" class="pw-post-body-paragraph iy iz hi ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hb bi translated">超参数调整<br/>对第一轮中表现最好的分类器进行交叉验证后，结果是选择梯度。提升树分类器。<br/>可以假定，这种发展主要是由数据的小尺寸引起的。当使用交叉验证时，训练数据将被分成几个子集，用作训练具有不同超参数组合的几个模型的输入。<br/>因此，建议在最终选择预测用户流失的模型之前，在云中的更大数据集上重复超参数调优。</p></div><div class="ab cl ir is gp it" role="separator"><span class="iu bw bk iv iw ix"/><span class="iu bw bk iv iw ix"/><span class="iu bw bk iv iw"/></div><div class="hb hc hd he hf"><h2 id="4d3c" class="jx jy hi bd jz ka kb kc kd ke kf kg kh jj ki kj kk jn kl km kn jr ko kp kq kr bi translated">结论</h2><p id="c2a5" class="pw-post-body-paragraph iy iz hi ja b jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr kw jt ju jv hb bi translated">我们已经设法交付了良好的结果与梯度。Boosted树分类器和小数据集，但也有一些改进的空间:</p><ul class=""><li id="0a97" class="ll lm hi ja b jb jc jf jg jj ln jn lo jr lp jv lq lr ls lt bi translated">我们使用了小型数据集(128MB)，而不是Udacity提供的中型数据集(231MB)或完整数据集(12GB)。Spark最适合较大的数据集，为了实现其全部潜力，我们现在应该将我们的解决方案迁移到云中的Spark集群，并使用原始数据集运行它。我们还可以考虑对数据进行(向下)采样，以解决建模阶段已经存在的类别不平衡问题。</li><li id="d135" class="ll lm hi ja b jb lu jf lv jj lw jn lx jr ly jv lq lr ls lt bi translated">由于运行交叉验证需要大量的时间，我已经调优了超参数，但不是以最好的方式。</li><li id="2605" class="ll lm hi ja b jb lu jf lv jj lw jn lx jr ly jv lq lr ls lt bi translated">有些功能我还没有在项目中探索。</li><li id="f566" class="ll lm hi ja b jb lu jf lv jj lw jn lx jr ly jv lq lr ls lt bi translated">为了根据我们的数据集预测用户流失，我们可以在本地环境中使用Spark处理更小的数据子集。<br/>尤其是在将数据聚合成更小的功能集之后，数据可能不够大，不足以训练和评估企业的最终解决方案。</li><li id="dc77" class="ll lm hi ja b jb lu jf lv jj lw jn lx jr ly jv lq lr ls lt bi translated">一旦模型最终确定，我们可以通过运行A/B测试来验证它的业务影响。最后但同样重要的是，这种验证也与证明持续维护和改进模型的努力和成本是合理的相关。</li></ul></div></div>    
</body>
</html>