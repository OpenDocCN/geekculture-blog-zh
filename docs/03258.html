<html>
<head>
<title>Building And Deploying Your First Lambda Function With The AWS SAM Framework</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS SAM框架构建和部署您的第一个Lambda函数</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/building-and-deploying-your-first-lambda-function-with-the-aws-sam-framework-af02708ad0a9?source=collection_archive---------21-----------------------#2021-06-04">https://medium.com/geekculture/building-and-deploying-your-first-lambda-function-with-the-aws-sam-framework-af02708ad0a9?source=collection_archive---------21-----------------------#2021-06-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/345f981debac19a483f0feb0c8c0a7ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*DRKxCu0I9GaOe6xp"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Photo by <a class="ae iu" href="https://unsplash.com/@burntime?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Alex Kulikov</a> on <a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="2660" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">无服务器是软件工程行业最热门的新词。无服务器是什么意思？当我听到这个术语时，我对云架构非常缺乏经验，很容易认为后台真的没有服务器。事实并非如此。“无服务器”的好处是，作为开发人员，您不必管理服务器。为了在云中运行代码，我们需要一个虚拟机来运行它。对于AWS，最简单的构建模块是EC2。这为您提供了基于您的选择，一些容量的RAM和存储。在虚拟机上，我们能够运行代码。问题是，运行这个虚拟机有很多事情要做。我们必须决定多少内存，多少存储，安全组，访问控制列表。这些还只是冰山一角。想象一下，如果您获得太多流量，而您的虚拟机无法处理，那么现在我们需要某种方法来水平扩展虚拟机，并进行某种负载平衡。此外，灾难恢复怎么样，如果机器出现故障，我们需要确保它也能重新启动(这可以通过自动伸缩来处理)。作为云计算中的一个概念，无服务器解决了这个问题，它基本上是对客户说，把您的代码给我们，我们会在供应、运行和扩展方面完成剩下的工作。当然，您需要输入，例如要提供多少RAM等，以及许多其他参数，具体取决于您正在使用的服务，但您不需要管理所有细节，因为AWS会为您处理这些。</p><h1 id="367b" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">自动气象站λ</h1><p id="35fa" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">这就把我们带到了AWS Lambda，它作为一种服务，就像把代码分解成单独的功能。这些功能在执行时运行在云中。您只需在代码实际运行时付费。与虚拟机相比，无论代码是否运行，虚拟机都一直在运行(并耗费资金),这是一笔巨大的资金节省。如果你一周只调用你的函数100次，当你的代码运行时，你是在付费。此外，Lambda提供了一个慷慨的免费层，每月多达100万次调用和400，000 GB秒的计算时间。之后，您需要为每百万次请求支付0.20美元，为每GB秒的计算时间支付0.0000166667美元。这非常便宜，也是一些人喜欢lambda的原因之一。只是为了涵盖Lambda的一些高级限制。每个区域有一个1000的内置并发限制。这是一个软限制，您可以联系AWS提高此限制。此外，Lambda函数最多只能运行15分钟。如果您需要更多的时间，并且仍然想考虑无服务器解决方案，我会考虑运行Fargate任务。在语言支持方面，目前Lambda支持Java、Go、PowerShell、Node.js、C#、Python和Ruby代码，如果你想使用不同的语言，你可以通过定制的方式创建自己的运行时。</p><h1 id="d140" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">SAM框架入门</h1><p id="1aac" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">AWS SAM是AWS提供的一个无服务器框架，使其更容易使用无服务器资源。它使用了一种相似但不完全相同的云形成形式。您可以使用AWS SAM创建许多无服务器服务，例如DynamoDb表、Lambda函数、无服务器应用程序和API网关端点。对于本文，我们将重点关注安装AWS SAM框架，并创建我们可以在云中调用的第一个Lambda函数。如果您从未安装过SAM框架，请查看此处的链接<a class="ae iu" href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html" rel="noopener ugc nofollow" target="_blank">并为您的计算机选择正确的操作系统。不考虑你的操作系统，步骤如下:<br/> 1 .您必须创建一个AWS帐户。如果没有，您将需要这样做。</a></p><p id="d021" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">2.您必须能够拥有在AWS上执行操作的权限。最简单的方法是在控制台中生成凭证，并跟随这个<a class="ae iu" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-files.html" rel="noopener ugc nofollow" target="_blank">链接</a>。它将向您展示如何在计算机上的正确位置将凭据设置到正确的凭据文件中。</p><p id="b311" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">3.按照操作系统的说明实际下载SAM应用程序</p><p id="d374" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">4.你需要在你的系统上安装Docker。</p><p id="1812" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">完成这些步骤后，您就可以使用SAM了。为什么我们需要所有这些？请记住，当我们在后台通过SAM进行API调用时。当我们部署时，我们正在创建一个Cloudformation堆栈，它创建了我们在模板中指定的资源。为此，我们需要得到许可。为了确保正常工作，请确保运行以下命令不会返回错误。</p><figure class="kx ky kz la fd ij er es paragraph-image"><div class="er es kw"><img src="../Images/c61013ceaefa44858d0b4c9f66d43f49.png" data-original-src="https://miro.medium.com/v2/resize:fit:208/format:webp/1*Wic8H4MC4esEjrht6VJFiA.png"/></div><figcaption class="iq ir et er es is it bd b be z dx">Command To Ensure AWS SAM Is Installed On Your Machine, Screenshot By Author.</figcaption></figure><h1 id="a090" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">使用模板开始</h1><p id="7cbf" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">让我们从使用模板开始。这是绝对最简单的方法，在不真正知道发生了什么的情况下创建一个函数。此外，这也是一个很好的方法，可以让你有一个开始的地方，用开始的代码替换掉你的代码。我们将从运行<code class="du lb lc ld le b">sam init</code>开始。这从终端中的一组对话开始，在那里我们可以做出选择。首先，系统会提示我们是要使用<code class="du lb lc ld le b">AWS Quickstart Templates</code>还是<code class="du lb lc ld le b">Custom Template</code>。我们在这里看到，如果对提高开发效率有意义，您可以创建自己的模板。对于本演示，我们将选择选项1。然后我们得到一长串可供选择的语言。Lambda支持许多语言，正如我前面提到的，在Lambda中也有运行定制运行时的方法。对于本演示，我们将选择节点，即选项1。然后系统会提示我们输入应用程序名称，我会选择<code class="du lb lc ld le b">sam-demo</code>。这将克隆一些模板，我们将选择选项1，这是<code class="du lb lc ld le b">Hello World Template</code>。这将生成一个文件夹，其名称与您为应用程序命名的名称相同。让我们看看这个文件夹，并从您最喜欢的代码编辑器中的template.yml文件开始。</p><h1 id="3fee" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">了解基本SAM模板</h1><p id="7de1" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">这个模板中有很多内容，尤其是如果您是SAM框架的新手。首先要叫出来的是<code class="du lb lc ld le b">AWSTemplateFormatVersion</code>和<code class="du lb lc ld le b">Transform</code>属性。这些是该模板文件所必需的，并将出现在所有SAM模板文件中。下一个最重要的是<code class="du lb lc ld le b">Resources</code>部分。这也是一个必需的属性，理所当然。如果没有资源，那么SAM实际上能做什么。对我们来说，资源就是我们的Lambda函数。对于这个初学者模板，他们也正在创建一个API网关端点，我们将跳过这一步。事实上，你可以看到我已经删除了模板文件中的大部分项目，因为我只想专注于Lambda。</p><figure class="kx ky kz la fd ij"><div class="bz dy l di"><div class="lf lg l"/></div></figure><p id="7bc3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在你开始学习的时候，有哪些重要的东西需要学习？<code class="du lb lc ld le b">CodeUri</code>指向包含具有我们功能的文件的文件夹。在这种情况下，模板引擎为我们生成了一个<code class="du lb lc ld le b">hello-world</code>文件夹。<code class="du lb lc ld le b">Handler</code>指向我们想要调用的实际函数名，首先引用文件名。你可以在这个模板中看到，结合<code class="du lb lc ld le b">CodeUri</code>和<code class="du lb lc ld le b">Handler</code>，我们告诉SAM在<code class="du lb lc ld le b">hello-world</code>文件夹中查找并找到一个名为app的文件，(需要是一个. js文件，因为我们在Node中工作，这对于其他语言会有所不同)，在该文件中，它期望从这个名为<code class="du lb lc ld le b">lambdaHandler</code>的文件中导出一个函数。这三样东西都是可以改变的，只要你的模板做相应的调整。</p><h1 id="4795" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">调整处理器功能</h1><p id="5f9c" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">现在让我们看一下app.js文件。对于本教程，我们真的想获得运行在云中的最基本的Lambda函数，并知道如何使用SAM重复部署它。因此，我们也将清除该文件中的几乎所有内容。它被设置为充当API网关端点的Lambda代理，该端点最初是在template.yml文件中设置的。现在，我们不需要关心这个，让我们简化文件如下。</p><figure class="kx ky kz la fd ij"><div class="bz dy l di"><div class="lf lg l"/></div></figure><p id="4c84" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">基本的，但会完成工作。现在，我们必须将我们的功能部署到云中。我们首先通过运行以下命令，让SAM框架为我们构建包。</p><figure class="kx ky kz la fd ij er es paragraph-image"><div class="er es lh"><img src="../Images/62d865d9fd4a66707818a9352971563e.png" data-original-src="https://miro.medium.com/v2/resize:fit:370/format:webp/1*EwtI60PxIaJ9XwVQcynQlA.png"/></div><figcaption class="iq ir et er es is it bd b be z dx">Command To Build Application Bundle, Screenshot By Author.</figcaption></figure><p id="3ab1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这将把我们的功能构建成一个可部署的包。然后，我们可以通过执行以下命令来部署这个包。</p><figure class="kx ky kz la fd ij er es paragraph-image"><div class="er es li"><img src="../Images/2b68ae1077e66a1b63396a562f9f1f49.png" data-original-src="https://miro.medium.com/v2/resize:fit:282/format:webp/1*rJ3O1OEXpeRfCMwxsXfA3g.png"/></div><figcaption class="iq ir et er es is it bd b be z dx">Command To Deploy Application Bundle For First Time, Screenshot By Author.</figcaption></figure><p id="1fa0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">该命令的引导部分有助于引导我们完成部署参数。我通常只在第一次部署时这样做，SAM会问你是否要将这个配置保存到一个. toml文件中。如果选择此选项，下次部署时，您只需运行<code class="du lb lc ld le b">sam deploy</code>，SAM将使用此文件中的参数进行部署。这使得部署更快。当我们用<code class="du lb lc ld le b">guided</code>运行这个命令时，会得到一些提示来帮助我们。首先，你必须给你的栈命名，对于我的栈，我称它为<code class="du lb lc ld le b">lambda-demo</code>。然后你必须选择你的地区，无论哪个地区对你有意义，我都会选择使用us-east-1。然后我们需要决定，我们是否要在部署之前确认更改。当我们进行后续部署时，这意味着我们将会看到一个变更集，并在部署之前批准它。对于本演示，这不是必需的。我们还必须允许CLI为我们创建一个角色。如果我们手动创建一个角色并使用template.yml文件附加它，则不需要这样做。对于演示，我们将允许CLI为我们创建它，一般来说，这是一个不错的选择。最后，我们需要检查是否应该将这些设置保存在一个. toml文件中。我建议选择这种方法，因为它可以缩短以后的部署时间。一旦所有这些完成，你的模板被上传，你的栈被创建。</p><h1 id="3935" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">运行您的Lambda函数</h1><p id="436b" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">我们现在可以导航到我们的AWS帐户，首先，让我们从访问Cloudformation部分开始，我们可以看到SAM创建的堆栈。</p><figure class="kx ky kz la fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lj"><img src="../Images/3c33e828188b534265b238f08e24a839.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vwdrmcQPlMulehywOpdxLA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Cloudformation Showing Our Stack Has Been Created, Screenshot By Author.</figcaption></figure><p id="ccd9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果我们单击堆栈名称，就会看到关于堆栈的各种有用信息。我们关心的是<code class="du lb lc ld le b">Resources</code>标签。如果我们单击它，它会打开一个UI，显示该堆栈创建的所有资源。对我们来说，它既是Lambda函数，也是IAM角色。</p><figure class="kx ky kz la fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lk"><img src="../Images/1207c5a3eabd74572521123dc3aa226e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8sKfsyG3fpfze1C2EMOHQw.png"/></div></div></figure><p id="4c00" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们点击<code class="du lb lc ld le b">HelloWorldFunction</code>的物理Id。这将在Lambda函数的新窗口中打开Lambda，该函数是由我们的SAM模板创建的。您应该从<code class="du lb lc ld le b">Code</code>选项卡开始。让我们转而点击<code class="du lb lc ld le b">Test</code>选项卡。我们需要创建我们的第一个测试事件。Hello-world模板是默认填充的，我们可以继续使用它，给我们的测试用例命名为<code class="du lb lc ld le b">myfirstevent</code>。如果我们继续并点击橙色的<code class="du lb lc ld le b">Test </code>按钮，我们的函数将在测试事件中被称为passing。请注意，当它成功时，我们会得到一个漂亮的执行成功绿色框，我们可以打开它，看到我们调用的结果。</p><figure class="kx ky kz la fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ll"><img src="../Images/4327a935ed51dea3abf20bfb354f4923.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NoCXcVrgoKoHzqtusZtnYw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Showing Our Text Successfully Returned, Screenshot By Author.</figcaption></figure><h1 id="d66f" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">下一步是什么？</h1><p id="e54b" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">其实什么都行！现在，您可以返回并更新处理程序函数来做您想做的任何事情。因为我们正在使用Node，所以我们也能够使用npm安装包并在我们的代码中使用它们。Lambda函数是AWS服务的粘合剂，许多服务都与它们进行了本机集成。通过Cloudwatch，我们可以在cron调度上使用Lambda函数。例如，想象一下，你想每小时检查一次S3桶中上传的新图像，并将它们批量转换为缩略图，Lambda可以做到这一点。想象一下，你想在图片上传后马上这么做，S3与Lambda的直接集成可以做到这一点。有无限可能。假设您需要能够从web调用您的lambda，那么我们可以直接集成Lambda作为API网关端点的处理程序。</p><h1 id="a7dd" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">结论</h1><p id="15b4" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">本文是对SAM框架和Lambda的非常基本的介绍。说实话，对于你可以用这两个服务做的所有事情，我们仅仅触及了皮毛。现在你已经有了一个很好的入门，而摆弄代码和尝试新事物将是你学习的方式。尝试安装软件包并编写一个函数，它不仅仅返回文本。现在你对lambda有了更深的理解，也许可以回去再做一遍教程，但是这次留下API网关代码并部署它，理解如何使用Lambda来支持API。仅仅用Lambda做实验就是一种奇妙的学习方式。如果你不再需要它，最后要做的事情是清理我们的代码。删除这个Lambda函数的正确方法是删除栈本身。导航回云形成，并点击你的堆栈。在右上角的一组按钮中，有一个删除按钮，它将删除您的整个堆栈。这是我喜欢使用SAM框架的另一个原因，当定义您的无服务器资源集时，因为它是一个隐藏的Cloudformation堆栈，所有资源都可以通过单击删除。</p></div></div>    
</body>
</html>