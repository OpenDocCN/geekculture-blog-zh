<html>
<head>
<title>Schedule AWS Lambda Invocations With EventBridge and AWS CDK</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用EventBridge和AWS CDK调度AWS Lambda调用</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/schedule-aws-lambda-invocations-with-eventbridge-and-aws-cdk-fbd7e4e670bb?source=collection_archive---------2-----------------------#2021-09-08">https://medium.com/geekculture/schedule-aws-lambda-invocations-with-eventbridge-and-aws-cdk-fbd7e4e670bb?source=collection_archive---------2-----------------------#2021-09-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/760871f5b624a3330cbed45f642eae4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NSp_aUtXhaPa6xoW"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Photo by <a class="ae iu" href="https://unsplash.com/@sadswim?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">ian dooley</a> on <a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="a110" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">AWS Lambda非常适合运行不需要服务器全天候运行的作业。Lambda函数可以被事件、其他AWS服务、AWS CLI等等调用，这使得它非常灵活并且易于集成。</p><p id="f344" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Lambda的一个常见用例是需要每隔x段时间运行一次函数。例如，假设我们想要每24小时抓取一次网站的新内容，我们可以使用AWS EventBridge规则安排一个Lambda函数来完成这个任务。调度Lambdas可以运行任何常规的、周期性的工作负载。事实上，我就是这样为我的监控和警报服务<a class="ae iu" href="https://komonitor.com/" rel="noopener ugc nofollow" target="_blank"> Komonitor </a>实现网站正常运行时间监控器的。</p><p id="b2cb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在本教程中，我们将使用AWS CDK来定义一个简单的Lambda函数，该函数将由AWS EventBridge规则每5分钟调用一次。</p><p id="d7c5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="jt">本教程面向AWS/AWS CDK初学者/中间用户。</em></p><h2 id="8b86" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">先决条件</h2><ol class=""><li id="6ba6" class="kp kq hi ix b iy kr jc ks jg kt jk ku jo kv js kw kx ky kz bi translated">AWS帐户</li><li id="e802" class="kp kq hi ix b iy la jc lb jg lc jk ld jo le js kw kx ky kz bi translated">安装并配置AWS CDK CLI。遵循AWS 的这些设置说明</li><li id="28fd" class="kp kq hi ix b iy la jc lb jg lc jk ld jo le js kw kx ky kz bi translated">对CDK堆栈和结构的基本理解。</li></ol><h1 id="b073" class="lf jv hi bd jw lg lh li ka lj lk ll ke lm ln lo kh lp lq lr kk ls lt lu kn lv bi translated">项目设置+后续存储库</h1><p id="098c" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg lw ji jj jk lx jm jn jo ly jq jr js hb bi translated">首先，我们需要建立一个CDK项目。</p><pre class="lz ma mb mc fd md me mf mg aw mh bi"><span id="1c02" class="ju jv hi me b fi mi mj l mk ml">mkdir &lt;PROJECT_NAME&gt;</span><span id="5390" class="ju jv hi me b fi mm mj l mk ml">cd &lt;PROJECT_NAME&gt;</span><span id="7b7a" class="ju jv hi me b fi mm mj l mk ml">cdk init</span><span id="2975" class="ju jv hi me b fi mm mj l mk ml">npm install @aws-cdk/aws-events-targets @aws-cdk/aws-events @aws-cdk/aws-lambda</span><span id="6dab" class="ju jv hi me b fi mm mj l mk ml">rm -rf test/</span><span id="f719" class="ju jv hi me b fi mm mj l mk ml">mkdir lib/lambda-code &amp;&amp; touch lib/lambda-code/code.js</span><span id="07e4" class="ju jv hi me b fi mm mj l mk ml">mkdir lib/constructs &amp;&amp; cd lib/constructs &amp;&amp; touch lambda-construct.ts event-construct.ts</span></pre><p id="dc32" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">上述命令将在<code class="du mn mo mp me b">PROJECT_NAME</code>目录中初始化一个新的CDK项目，并添加一些我们将用来编写Lambda和事件构造以及Lambda代码的文件。</p><p id="d11c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我已经创建了一个公共的GitHub库，包含了我们将在这里编写的所有代码，这样你就可以克隆它或者跟随它。</p><p id="3cc8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://github.com/nramkissoon/AWS-CDK-Schedule-Lambda-Tutorial" rel="noopener ugc nofollow" target="_blank"> GitHub库</a></p><h1 id="dd60" class="lf jv hi bd jw lg lh li ka lj lk ll ke lm ln lo kh lp lq lr kk ls lt lu kn lv bi translated">创建简单的Lambda函数</h1><p id="5ad9" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg lw ji jj jk lx jm jn jo ly jq jr js hb bi translated">让我们在<code class="du mn mo mp me b">code.js</code>中定义我们的Lambda函数代码:</p><figure class="lz ma mb mc fd ij"><div class="bz dy l di"><div class="mq mr l"/></div></figure><p id="36f2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这个处理程序只是记录函数接收到的事件，然后返回一个“Hello World”消息。</p><p id="3d11" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，让我们定义将在<code class="du mn mo mp me b">lambda-construct.ts</code>中使用这段代码的Lambda函数。</p><figure class="lz ma mb mc fd ij"><div class="bz dy l di"><div class="mq mr l"/></div></figure><p id="7a11" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">上面的代码创建了一个新的包含Lambda函数的CDK构造。在类构造函数中，我们创建了一个新的Lambda函数，它在每次调用时简单地输出“Hello World”。<code class="du mn mo mp me b">SimpleLambdaConstruct</code>类在类变量<code class="du mn mo mp me b">this.lambda</code>中向外界公开了Lambda函数。</p><h1 id="c8c4" class="lf jv hi bd jw lg lh li ka lj lk ll ke lm ln lo kh lp lq lr kk ls lt lu kn lv bi translated">创建AWS EventBridge规则并集成Lambda</h1><p id="d48d" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg lw ji jj jk lx jm jn jo ly jq jr js hb bi translated">现在，让我们在<code class="du mn mo mp me b">event-rule.ts</code>中实现我们的事件规则构造。</p><figure class="lz ma mb mc fd ij"><div class="bz dy l di"><div class="mq mr l"/></div></figure><p id="b806" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">上面的代码定义了一个每5分钟触发一次事件的事件规则。然而，我们需要将这个事件发送给我们的Lambda函数，它目前并不知道我们的事件规则的存在。这是我们需要做的最后一步。</p><p id="d3eb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在<code class="du mn mo mp me b">lambda-schedule-stack.ts</code>中，我们实例化了我们的lambda和事件规则构造:</p><figure class="lz ma mb mc fd ij"><div class="bz dy l di"><div class="mq mr l"/></div></figure><p id="dce2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了让我们的事件规则发送事件并调用我们的Lambda，我们需要将Lambda函数作为<em class="jt">目标</em>添加到规则中。然后，我们给规则<em class="jt">权限</em>来调用Lambda函数。</p><h1 id="6f2c" class="lf jv hi bd jw lg lh li ka lj lk ll ke lm ln lo kh lp lq lr kk ls lt lu kn lv bi translated">CDK部署+验证一切正常</h1><p id="2c78" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg lw ji jj jk lx jm jn jo ly jq jr js hb bi translated">我们现在可以尝试将我们的CDK堆栈部署到AWS。</p><pre class="lz ma mb mc fd md me mf mg aw mh bi"><span id="c8e0" class="ju jv hi me b fi mi mj l mk ml">cdk synth<br/>cdk deploy</span></pre><p id="5721" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建并准备使用所有AWS资源需要几分钟时间。完成后，如果您没有看到错误，您就可以登录到您的AWS帐户并查看创建的资源，以验证一切正常。</p><p id="c073" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">首先，让我们检查EventBridge控制台，查看我们的新规则:</p><figure class="lz ma mb mc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ms"><img src="../Images/152a59dfa6c1b1748219ca20784a0eb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oIWfkhgdqbRegFR_wGN1fQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Event Rule</figcaption></figure><p id="909f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果我们转到lambda控制台，我们将看到我们的Lambda函数，以及我们的EventBridge触发器和处理程序代码:</p><figure class="lz ma mb mc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mt"><img src="../Images/31fed04119e3b28e22cb510b29f546b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HVXy2VQUk_T1SOUGTjaRcw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Lambda function</figcaption></figure><p id="c040" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最后，让我们看看我们的Lambda是否每5分钟被调用一次。如果你转到Lambda控制台中的<strong class="ix hj"> **Monitor** </strong>选项卡，你会看到指向CloudWatch日志的链接，以获取该函数的调用。当然，您必须等待至少5分钟才能在日志中显示任何内容，但是，一旦调用了该函数，日志将如下所示:</p><figure class="lz ma mb mc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mu"><img src="../Images/b2ef059269008f3f5c919a9362acc4e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5T_a8zVk5F7yJPCjkppdJA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Lambda invocation logs in CloudWatch</figcaption></figure><p id="2703" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们看到EventBridge每5分钟向函数发送一次“Hello Lambda”。成功！</p><h1 id="5088" class="lf jv hi bd jw lg lh li ka lj lk ll ke lm ln lo kh lp lq lr kk ls lt lu kn lv bi translated">清理+结论</h1><p id="c845" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg lw ji jj jk lx jm jn jo ly jq jr js hb bi translated">为了避免在我们的AWS帐户中留下未使用的资源，我们可以通过以下方式删除CDK堆栈和相关资源:</p><pre class="lz ma mb mc fd md me mf mg aw mh bi"><span id="8409" class="ju jv hi me b fi mi mj l mk ml">cdk destroy</span></pre><p id="87a3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">就是这样！现在您知道了如何使用AWS EventBridge规则在设定的时间表上运行任何Lambda函数。更好的是，您现在可以使用AWS CDK来定义您的资源，而不是在控制台中手动创建它们。</p></div></div>    
</body>
</html>