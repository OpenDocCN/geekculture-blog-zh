<html>
<head>
<title>Hosting your own Minecraft server without a public IP adress.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在没有公共IP地址的情况下托管自己的《我的世界》服务器。</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/hosting-your-own-minecraft-server-without-a-public-ip-adress-437560287a75?source=collection_archive---------9-----------------------#2021-08-18">https://medium.com/geekculture/hosting-your-own-minecraft-server-without-a-public-ip-adress-437560287a75?source=collection_archive---------9-----------------------#2021-08-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="3fe6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">免责声明</strong>:本教程要求在您托管服务器的PC上安装Linux(及其基础知识)。</p><p id="7d04" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">大约一年前，我和我的几个朋友决定创建一个小《我的世界》，在隔离期间玩。我们把钱凑在一起，从主机上买了一台服务器。随着服务器的增长，很明显我们需要更多的RAM和CPU内核，但是托管已经有点贵了。我可以把我们的服务器转移到另一个主机上，或者支付更贵的费用，但是我决定尝试自己托管服务器。这样，我可以分配我的计算机可以提供的任何数量的RAM，并使用我想要的任何数量的内核。同样在几周前，我了解到我们的ISP已经将我们的上传速度提高了一倍，达到了10Mbps，这对于一台《我的世界》服务器来说应该足够了，但是因为我们没有公共IP，并且在CGNAT之后，我不能仅仅从我们的路由器进行端口转发。另外，在我的ISP处，一个公共IP是每月25美元。当我发现我们的上传速度提高了一倍时，我就开始研究如何让它发挥作用。</p><p id="c6f0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们需要什么？<br/>首先，我们需要一台电脑或者一台服务器来托管《我的世界》的服务器。它必须有相当不错的规格。我不会推荐内存小于8GB或内核小于2的电脑。规格越高，服务器就越平滑。</p><p id="3d8b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">其次，稳定的网络连接。你可以用5Mbps的上传速度做到这一点，但我建议至少10Mbps。</p><p id="cfa3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，一台有公共IP地址的计算机。它可以是一个VPS服务器，这可能是最简单的解决方案。</p><p id="b648" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你没有VPS，但想在这个项目中使用，你可以通过使用我的<a class="ae jd" href="https://www.vultr.com/?ref=8798861" rel="noopener ugc nofollow" target="_blank">推荐链接</a>来帮助我。对于每个注册并添加至少10美元的用户，我将获得10美元的信用。</p><p id="dd22" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我假设我们已经设置好了Ubuntu VPS。</p><h1 id="296f" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">设置《我的世界》服务器</h1><p id="08f6" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">我将为我们的《我的世界》服务器使用一个Docker容器。它为你创造和设置一切。所有这些事情都将发生在我们的电脑上，它将托管服务器，现在还不需要VPS。<br/>先从安装Docker开始。</p><p id="9e75" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">更新包索引并安装一些先决条件:<br/> <code class="du kh ki kj kk b">sudo apt update<br/>sudo apt install apt-transport-https ca-certificates curl gnupg-agent software-properties-common</code> <br/>导入库的GPG键:<br/> <code class="du kh ki kj kk b">curl -fsSL <a class="ae jd" href="https://download.docker.com/linux/ubuntu/gpg" rel="noopener ugc nofollow" target="_blank">https://download.docker.com/linux/ubuntu/gpg</a> | sudo apt-key add -<br/></code>将repo添加到apt: <br/> <code class="du kh ki kj kk b">sudo add-apt-repository “deb [arch=amd64] <a class="ae jd" href="https://download.docker.com/linux/ubuntu" rel="noopener ugc nofollow" target="_blank">https://download.docker.com/linux/ubuntu</a> $(lsb_release -cs) stable”<br/></code>最后安装包:<br/> <code class="du kh ki kj kk b">sudo apt install docker-ce docker-ce-cli</code></p><p id="fb08" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们将创建一个容器并使用来自itzg 的<a class="ae jd" href="https://hub.docker.com/r/itzg/minecraft-server" rel="noopener ugc nofollow" target="_blank">图像，它已经为我们设置好了一切:</a></p><pre class="kl km kn ko fd kp kk kq kr aw ks bi"><span id="5ad8" class="kt jf hi kk b fi ku kv l kw kx">sudo docker run -d -it --restart unless-stopped -p 25565:25565 -e MEMORY=4G -e EULA=TRUE -e TYPE=AIRPLANE -e AIRPLANE_BUILD=lastSuccessfulBuild -e USE_AIKAR_FLAGS=true -v /your/data/folder:/data --name minecraft itzg/minecraft-server</span></pre><p id="09e3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以更改的一些变量:<br/> <code class="du kh ki kj kk b">MEMORY</code>:指定您想为服务器使用的RAM数量。<br/> <code class="du kh ki kj kk b">-v /your/data/folder:data</code>:将<code class="du kh ki kj kk b">/your/data/folder</code>改为您希望服务器所在的文件夹。例如/home/user/minecraft-server</p><p id="df1a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一些解释:<br/> <code class="du kh ki kj kk b">-e TYPE=AIRPLANE</code>:我们将使用一个非常优化的纸叉子，它本身就是一个优化的龙头叉子。<br/> <code class="du kh ki kj kk b">-e USE_AIKAR_FLAGS=true</code>:启用一些JVM标志，当更多用户连接时，这些标志会有所帮助</p><p id="9fcd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">指挥部会为你做好一切准备。<br/>使用<code class="du kh ki kj kk b">sudo docker ps</code>可以看到更多关于集装箱的信息。<br/>现在如果我想去控制台，我可以只做<code class="du kh ki kj kk b">sudo docker attach minecraft</code> <em class="ky">。这将使我能够直接在控制台上打字。要离开控制台，不要使用CTRL+C。这将停止服务器。不如使用转义序列。先按CTRL+P，再按CTRL+Q。</em></p><p id="7719" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了让它对用户更友好，我将安装portainer-ce。这是一个用于通过网站管理docker的UI。<br/>要安装portainer，请使用以下命令:</p><pre class="kl km kn ko fd kp kk kq kr aw ks bi"><span id="7082" class="kt jf hi kk b fi ku kv l kw kx">sudo docker run -d -p 9000:9000 --name=portainer --restart=always -v /var/run/docker.sock:/var/run/docker.sock -v /your/data/folder:/data portainer/portainer-ce</span></pre><p id="459a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您需要将<code class="du kh ki kj kk b">/your/data/folder</code>更改为一个文件夹，其中将存储与portainer相关的数据。<br/>然后去<em class="ky"> localhost:9000 </em>，创建账号，登录。我们将改变我们的《我的世界》服务器的网络工作方式，因此点击“本地”，然后“容器”，然后“Minecraft”。点击顶部的复制/编辑按钮。向下滚动到高级容器设置，并点击网络。现在将网络从网桥改为主机。这将禁用网络上的容器隔离，并使我们的LAN外部的连接可以访问它。现在点击“部署容器”。如果您想从图形界面查看控制台，只需单击日志即可查看控制台输出，并向控制台输入命令。</p><p id="b081" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们已经设置好了《我的世界》服务器。如果你使用localhost:25565作为IP，你可以从多人游戏菜单连接到它。您局域网中的其他人可以使用您的本地IP(使用命令<em class="ky"> ip a </em>并找到您正在使用的接口)连接到同一个端口25565。下一步是设置我们的VPS并创建一个Wireguard VPN。</p><h1 id="d880" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">设置VPS、Wireguard和路由</h1><p id="dd5e" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">我希望你能自己买VPS。最低层也可以，因为运行VPN和路由几个数据包不需要那么多资源。你也应该选择一个离你近的服务器，因为如果任何人想连接到服务器，他们将被连接到VPS，然后VPS将连接到你的PC。当你买了VPS之后。</p><p id="7c78" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我们将启用数据包路由。如果没有安装nano，使用<code class="du kh ki kj kk b">sudo apt install nano</code> <em class="ky">安装。</em>然后运行以下命令:<code class="du kh ki kj kk b">sudo nano /etc/sysctl.conf</code> <em class="ky"> </em>，用<code class="du kh ki kj kk b">net.ipv4.ip_forward = 1</code> <em class="ky">取消注释该行。</em>使用CTRL+X退出，然后Y，最后回车。这将启用来自VPS的ip转发。使用此命令使更改生效而无需重启:<code class="du kh ki kj kk b">sudo sysctl -p</code>。</p><p id="45b8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们用<code class="du kh ki kj kk b">sudo apt install ufw</code> <em class="ky">安装代表简单防火墙的ufw。然后让我们允许ssh，wireguard和我们的minecraft端口。</em></p><pre class="kl km kn ko fd kp kk kq kr aw ks bi"><span id="3821" class="kt jf hi kk b fi ku kv l kw kx">sudo ufw allow ssh<br/>sudo ufw allow 51820/udp<br/>sudo ufw allow 25565<br/>sudo ufw enable</span></pre><p id="9db5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您注意到重启后ufw不工作，请尝试使用<code class="du kh ki kj kk b">sudo systemctl enable ufw</code> <em class="ky">。</em></p><p id="2349" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们已经准备好设置铁丝网了。首先，让我们通过<em class="ky"> sudo来安装wireguard。把它也安装到你的电脑上。完成后，我们需要创建我们的密钥。在VPS和PC上运行这两个命令，并将公钥保存在某个地方。</em></p><pre class="kl km kn ko fd kp kk kq kr aw ks bi"><span id="a1cc" class="kt jf hi kk b fi ku kv l kw kx">(umask 077 &amp;&amp; printf "[Interface]\nPrivateKey = " | sudo tee /etc/wireguard/wg0.conf &gt; /dev/null)<br/>wg genkey | sudo tee -a /etc/wireguard/wg0.conf | wg pubkey | sudo tee /etc/wireguard/publickey</span></pre><p id="3b0c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们需要更改VPS上的Wireguards配置。先用<code class="du kh ki kj kk b">sudo nano /etc/wireguard/wg0.conf</code> <em class="ky">。然后像这样更改您的配置:</em></p><pre class="kl km kn ko fd kp kk kq kr aw ks bi"><span id="c2d0" class="kt jf hi kk b fi ku kv l kw kx">[Interface]<br/>PrivateKey = <strong class="kk hj"><em class="ky">(this will be filled in by the previous command, do not share this with anyone)</em></strong></span><span id="eaac" class="kt jf hi kk b fi kz kv l kw kx">PostUp = iptables -t nat -A PREROUTING -p tcp --dport 25565 -j DNAT --to-destination 10.20.4.2:25565<br/>PostUp = iptables -t nat -A POSTROUTING -o <strong class="kk hj"><em class="ky">if</em></strong> -j MASQUERADE</span><span id="f0e2" class="kt jf hi kk b fi kz kv l kw kx">PostDown = iptables -t nat -D PREROUTING -p tcp --dport 25565 -j DNAT --to-destination 10.20.4.2:25565<br/>PostDown = iptables -t nat -D POSTROUTING -o <strong class="kk hj"><em class="ky">if</em></strong> -j MASQUERADE</span><span id="68f9" class="kt jf hi kk b fi kz kv l kw kx">ListenPort = 51820<br/>Address = 10.20.4.1/24</span><span id="442e" class="kt jf hi kk b fi kz kv l kw kx">[Peer]<br/>PublicKey = <strong class="kk hj"><em class="ky">(put here the public key from your PC that the previous command generated)</em></strong><br/>AllowedIPs = 10.20.4.2/24</span></pre><p id="9bcd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在你要把<strong class="ih hj"> <em class="ky"> if </em> </strong>换成<strong class="ih hj"> <em class="ky"> </em> </strong>连接你上网的接口。您可以使用<code class="du kh ki kj kk b">route</code>命令检查哪个接口。你要的界面是<strong class="ih hj"> <em class="ky">默认目的地</em> </strong>。</p><figure class="kl km kn ko fd lb er es paragraph-image"><div class="er es la"><img src="../Images/e9392e404993b1b9ef957e4135344354.png" data-original-src="https://miro.medium.com/v2/resize:fit:1296/format:webp/1*eREvXrqgL8eqFK3ruQe4IQ.png"/></div><figcaption class="le lf et er es lg lh bd b be z dx">Output of the <strong class="bd jg"><em class="li">route</em></strong> command.</figcaption></figure><p id="f638" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如你所见，在我的例子中，接口是<em class="ky"> enp0s3 </em>。</p><p id="d878" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">PostUp和PostDown命令设置路由，以便将所有到达端口25565的传入流量重定向到我们的PC(在我们的VPN中为10.20.4.2)。正如您在地址条目中看到的，VPS的IP地址将是10.20.4.1。</p><p id="5443" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">提示</strong>:如果您需要进行端口映射或打开另一个端口，只需复制原始的iptables命令并更改ips即可。<code class="du kh ki kj kk b">--dport</code>是VPS上的端口，PC的端口在命令的<code class="du kh ki kj kk b">--<em class="ky">to-destination</em> </code>部分。不要忘记使用ufw来启用端口。例如，如果我想在我的电脑上打开ssh端口，我会添加<code class="du kh ki kj kk b">PostUp = iptables -t nat -A PREROUTING -p tcp --dport 555 -j DNAT --to-destination 10.20.4.2:22</code> <em class="ky"> </em>和PostDown命令，用-D代替-A，然后用<code class="du kh ki kj kk b">sudo ufw allow 555</code>启用端口。现在，您可以使用<code class="du kh ki kj kk b">ssh -p 555 (VPS’ public IP)@username</code>连接到家中的电脑。</p><p id="4c4c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们将设置PC的Wireguard。让我们打开配置，稍微修改一下。我们可以再用<code class="du kh ki kj kk b">sudo nano /etc/wireguard/wg0.conf</code> <em class="ky"> </em>来改变它。配置应该如下所示:</p><pre class="kl km kn ko fd kp kk kq kr aw ks bi"><span id="54a6" class="kt jf hi kk b fi ku kv l kw kx">[Interface]<br/>PrivateKey = <strong class="kk hj"><em class="ky">(this will be filled, do not share this with anyone)</em></strong><br/>Address = 10.20.4.2/24<br/>Table = 1</span><span id="5a40" class="kt jf hi kk b fi kz kv l kw kx">PostUp = ip rule add pref 500 from 10.20.4.2 lookup 1<br/>PostDown = ip rule del pref 500</span><span id="e9c3" class="kt jf hi kk b fi kz kv l kw kx">[Peer]<br/>PublicKey = <strong class="kk hj"><em class="ky">(put here the public key from the VPS)</em></strong><br/>AllowedIPs = 0.0.0.0/0<br/>Endpoint = <strong class="kk hj"><em class="ky">(VPS' public IP - the one used for ssh for example)</em></strong>:51820<br/>PersistentKeepalive = 25</span></pre><p id="8725" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">几乎是一样的，但是我们已经设置了路由来使用特定的表。当您设置AllowedIPs时，Wireguard将设置您的PC在向该IP发送流量时不应使用WAN，而是使用我们的VPN隧道<em class="ky"> wg0 </em>接口。我们将AllowedIPs设置为0.0.0.0/0，以允许来自所有IP的连接通过我们的VPN。如果我们不这样做，并将其设置为VPS的IP，我们将在日志中获得VPS的IP，而不是玩家的IP(我们还必须改变VPS的配置一点)。然而，当我们将其设置为0.0.0.0/0时，我们告诉Wireguard所有的IP应该通过<em class="ky"> wg0 </em>接口路由。这使得所有流量都将通过您的VPN路由到VPS，并从那里路由到互联网。如果你的VPS每月带宽有限(大多数VPS都是这样)，这可能不是你想要的。大多数VPS提供商的最低层提供至少1 TB的月带宽。因此，如果您想通过VPN路由所有流量，请删除<code class="du kh ki kj kk b">Table = 1</code>以及PostUp和PostDown。<code class="du kh ki kj kk b">ip rule add pref 500 from 10.20.4.2 lookup 1</code> <em class="ky"> </em>确保来自10.20.4.2(您电脑的VPN地址)的所有流量将使用表“1”来路由所有流量。我们使用PC的VPN IP，因为我们想要路由我们的PC创建的数据包。这意味着从VPN出来的数据通过VPN而不是WAN返回。</p><p id="1cde" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们需要做的就是用我们的配置启用Wireguard，一切<strong class="ih hj"> <em class="ky">应该</em> </strong>都可以工作了。</p><p id="b059" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要启用Wireguard，请使用以下命令通过systemctl在VPS和PC上启用它:<code class="du kh ki kj kk b">sudo systemctl enable wg-quick@wg0</code> <em class="ky"> <br/> </em>如果您需要快速重启VPN，请使用<code class="du kh ki kj kk b">sudo systemctl restart wg-quick@wg0</code> <em class="ky"> <br/> </em>您应该首先重启VPS的连接，然后重启PC的连接。<br/>你也可以使用<code class="du kh ki kj kk b">sudo wg</code> <em class="ky">来检查连接是否正常。如果你在握手，你是通过VPN连接的。</em></p><p id="5af9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果这对你不起作用，我会试着在评论中帮你。</p></div></div>    
</body>
</html>