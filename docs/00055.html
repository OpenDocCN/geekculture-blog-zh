<html>
<head>
<title>Connecting To Multiple Databases Dynamically with Django and Sqlalchemy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Django和Sqlalchemy动态连接多个数据库</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/connecting-to-multiple-databases-dynamically-with-django-and-sqlalchemy-1b0b7454eb3e?source=collection_archive---------0-----------------------#2020-01-12">https://medium.com/geekculture/connecting-to-multiple-databases-dynamically-with-django-and-sqlalchemy-1b0b7454eb3e?source=collection_archive---------0-----------------------#2020-01-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/5ff5f78e50ecfd5c190501387fe99049.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fzQTyO4aGCTzOPIyNDIjew.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Photo by <a class="ae iu" href="https://unsplash.com/@goshua13?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Joshua Aragon</a> on <a class="ae iu" href="https://unsplash.com/s/photos/code?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="a909" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当我们遇到某些问题时，我们可能需要一些非常规的技巧。在这里，我将讨论使用sqlalchemy作为django ORM的替代品，在同一个数据库服务器的多个数据库中连接和创建表。</p><h1 id="611b" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">问题是</h1><p id="047f" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">问题很简单，数据库架构是有一个mysql数据库服务器和多个数据库。</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="1317" class="lf ju hi lb b fi lg lh l li lj">mysql&gt; show databases;<br/>+--------------------+<br/>| Database           |<br/>+--------------------+<br/>| information_schema |<br/>| dummy              |<br/>| mysql              |<br/>| mytest             |<br/>| mytest1            |<br/>| mytest2            |<br/>| mytest3            |<br/>| performance_schema |<br/>| sys                |<br/>| test               |<br/>+--------------------+<br/>10 rows in set (0.00 sec)</span></pre><p id="6e22" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这里，我的测试，我的测试1，我的测试2，我的测试3是数据库。</p><p id="5b0c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在django中，你不能动态地连接多个数据库，因为你的连接在settings.py文件中。</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="acd4" class="lf ju hi lb b fi lg lh l li lj"># https://docs.djangoproject.com/en/2.0/ref/settings/#databases<br/><br/>DATABASES = {<br/>    'default': {<br/>        'ENGINE': 'django.db.backends.mysql',<br/>        'OPTIONS': {<br/>            'read_default_file': '/etc/mysql/my.cnf',<br/>        },<br/>    }<br/>}</span></pre><p id="dd17" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">my.cnf文件</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="9c33" class="lf ju hi lb b fi lg lh l li lj">[client]<br/>database = db_name<br/>user = db_user<br/>password = db_password<br/>default-character-set = utf8</span></pre><p id="731c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这里，我们只能连接到固定数量的数据库，它们是静态的。</p><p id="9bec" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">所以我们将通过使用一个流行的库sqlalchemy来解决这个问题。</p><p id="a42a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">首先安装sqlalchemy。</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="fd03" class="lf ju hi lb b fi lg lh l li lj">pip install sqlalchemy</span></pre><p id="f8c2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们使用sqlalchemy来连接数据库。创建connect inside views.py或创建新文件并将其导入视图。</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="4ac2" class="lf ju hi lb b fi lg lh l li lj">def connect(database_name):</span><span id="e7d8" class="lf ju hi lb b fi lk lh l li lj">    connection_string = "mysql://{}:    {}@{}/{}".format(db_user,db_password,db_url,database_name)</span><span id="a094" class="lf ju hi lb b fi lk lh l li lj">    engine = create_engine(connection_string,pool_recycle=3600)</span><span id="cab3" class="lf ju hi lb b fi lk lh l li lj">    connection = engine.connect()</span><span id="a56b" class="lf ju hi lb b fi lk lh l li lj">    return connection</span></pre><p id="9016" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">接下来，我创建了alchemymodel.py文件，它充当model.py</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="70e2" class="lf ju hi lb b fi lg lh l li lj">from sqlalchemy.ext.declarative import declarative_base</span><span id="68fd" class="lf ju hi lb b fi lk lh l li lj">from sqlalchemy import Column, Integer, String ,Text</span><span id="b2e8" class="lf ju hi lb b fi lk lh l li lj">Base = declarative_base()</span><span id="e7ca" class="lf ju hi lb b fi lk lh l li lj">class Post(Base):<br/></span><span id="c65c" class="lf ju hi lb b fi lk lh l li lj">    __tablename__ = 'post'</span><span id="9e55" class="lf ju hi lb b fi lk lh l li lj">    id = Column(Integer, primary_key=True)</span><span id="cc9b" class="lf ju hi lb b fi lk lh l li lj">    name = Column(String(30))</span><span id="cd15" class="lf ju hi lb b fi lk lh l li lj">    description = Column(Text())</span></pre><p id="36da" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在views.py中导入该文件</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="6ed3" class="lf ju hi lb b fi lg lh l li lj">from dash.alchemymodel import Base,Post</span><span id="47c4" class="lf ju hi lb b fi lk lh l li lj">from sqlalchemy.orm import sessionmaker</span><span id="7021" class="lf ju hi lb b fi lk lh l li lj">from rest_framework import status<br/></span><span id="133c" class="lf ju hi lb b fi lk lh l li lj">@api_view(['POST'])</span><span id="ba83" class="lf ju hi lb b fi lk lh l li lj">def PostView():<br/></span><span id="1221" class="lf ju hi lb b fi lk lh l li lj">    data = request.data</span><span id="c230" class="lf ju hi lb b fi lk lh l li lj">    engine = connect(req_data['database_name'])</span><span id="357a" class="lf ju hi lb b fi lk lh l li lj">    Base.metadata.create_all(engine)</span><span id="b0be" class="lf ju hi lb b fi lk lh l li lj">    Session = sessionmaker(bind=engine)</span><span id="e9d2" class="lf ju hi lb b fi lk lh l li lj">    session = Session()</span><span id="dafa" class="lf ju hi lb b fi lk lh l li lj">    if request.method == 'POST':</span><span id="e402" class="lf ju hi lb b fi lk lh l li lj">        post = Post(name = "My post" , description = "This is a   sample post")</span><span id="5b34" class="lf ju hi lb b fi lk lh l li lj">        session.add(post)</span><span id="9b74" class="lf ju hi lb b fi lk lh l li lj">        session.commit()</span><span id="2b3e" class="lf ju hi lb b fi lk lh l li lj">    Response({'status':'created'}, status = status.HTTP_200_OK)</span></pre><p id="ef44" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du ll lm ln lb b">Base.metadata.creat_all()</code>在每个数据库中创建表格。</p><p id="4d0a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以使用sqlalchemy ORM插入和查询数据。有关更多信息，请参见sqlalchemy的官方文档。</p><p id="83e2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://docs.sqlalchemy.org/en/13/orm/" rel="noopener ugc nofollow" target="_blank">https://docs.sqlalchemy.org/en/13/orm/</a></p><p id="6005" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我还使用了marshmallow来序列化和反序列化数据库对象，但是这里没有对它们进行解释。</p></div></div>    
</body>
</html>