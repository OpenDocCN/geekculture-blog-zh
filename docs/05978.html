<html>
<head>
<title>Jenkins automation I have been using lately</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">詹金斯自动化我最近一直在使用</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/jenkins-automation-i-have-been-using-lately-f5eab13ec65e?source=collection_archive---------39-----------------------#2021-08-03">https://medium.com/geekculture/jenkins-automation-i-have-been-using-lately-f5eab13ec65e?source=collection_archive---------39-----------------------#2021-08-03</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="aef1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我使用Jenkins实现自动化(在客户环境中)已经有一段时间了，使用案例如下:</p><ol class=""><li id="6548" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">持续部署</li><li id="1f0b" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">循环网络和API验证</li><li id="6180" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">API预热</li></ol><h1 id="34f3" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">持续部署</h1><p id="637f" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">这是主要的使用案例，旧的部署方式主要是手动工作，要避免所有的人为错误是很有挑战性的。</p><p id="4b31" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在部署中，可能有以下操作:</p><ol class=""><li id="b524" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">从存储库中获取源代码</li><li id="398f" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">编译和链接(对于某些编程语言)</li><li id="982f" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">存档原件</li><li id="344d" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">配置更改(取决于目的地或版本)</li><li id="3498" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">重新启动一些服务</li><li id="2d93" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi">…</li></ol><h2 id="af13" class="ku js hi bd jt kv kw kx jx ky kz la kb iq lb lc kf iu ld le kj iy lf lg kn lh bi translated">我为部署而设置的Jenkins项目</h2><p id="013f" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">首先，在常规部分，我设置了一些参数，例如:</p><ol class=""><li id="8900" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">选择的git标签</li><li id="d848" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">要使用的登录和目标服务器</li><li id="a80d" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">将文件部署到目标服务器的位置。</li><li id="4516" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi">…</li></ol><figure class="lj lk ll lm fd ln er es paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="er es li"><img src="../Images/2ad203943fa7cd264e05a7d152eaafd0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OtrfBLr_UrQAqwFly7Fr9Q.png"/></div></div></figure><p id="5104" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于源代码管理，我们将重用已定义的git标记参数(它将以下拉列表的形式呈现，用户可以从中进行选择)</p><figure class="lj lk ll lm fd ln er es paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="er es lu"><img src="../Images/907311b4ec7bf2f791fa2728e0a4f4bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BCpofqVvGei82Z4Iy4RPbA.png"/></div></div></figure><p id="7aeb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，主要步骤是运行一个脚本(它包含在源代码中，但是您也可以在这里直接编写脚本)</p><figure class="lj lk ll lm fd ln er es paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="er es lv"><img src="../Images/9c18ab4bc866d4cba28f9bf90d1a1b35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kG9EWnpq8OCy0qEGBglGnQ.png"/></div></div></figure><p id="8d3b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">部署脚本逻辑如下:</p><figure class="lj lk ll lm fd ln er es paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="er es lw"><img src="../Images/aaf46000b9e19f96d305b7369c2d216c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tjafPnTP1wi43E_WvyGf4g.png"/></div></div></figure><p id="7c5e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该脚本执行了几项任务:</p><ol class=""><li id="6b2b" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">管理目标服务器文件系统(创建文件夹)</li><li id="5a15" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">管理配置(使用secure-env加密。源文件中的环境文件)</li><li id="5db2" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">复制文件(当Jenkins准备源文件并在Jenkins服务器上运行脚本时，需要将文件复制到目标服务器)</li><li id="998f" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">复制后操作-使用PM2运行服务</li></ol><p id="943c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用参数运行此Jenkins项目:</p><figure class="lj lk ll lm fd ln er es paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="er es lx"><img src="../Images/a88da036cd7a4cc9e2faaa2eba9edd49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g8beus15oY9ppS8Y0EU2WA.png"/></div></div></figure><h2 id="1361" class="ku js hi bd jt kv kw kx jx ky kz la kb iq lb lc kf iu ld le kj iy lf lg kn lh bi translated">詹金斯管道项目简介</h2><p id="5621" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">假设上面定义的Jenkins项目是参数化的，那么如果有多个目标服务器，我们将需要选择不同的服务器再次运行相同的项目(这是另一个人为错误的来源)。</p><p id="bb4f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，我如何使用詹金斯自动化这是通过管道项目。</p><figure class="lj lk ll lm fd ln er es paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="er es ly"><img src="../Images/62e03bb5cfa933491d3331cf01038dda.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jk9-WBZZGcdSdfGdbmK9UQ.png"/></div></div><figcaption class="lz ma et er es mb mc bd b be z dx">Create a Jenkins pipeline project</figcaption></figure><p id="936f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在配置管道时，我们的重点是管道部分，该部分允许我们使用“管道脚本”来定义要做的事情。</p><figure class="lj lk ll lm fd ln er es paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="er es md"><img src="../Images/4cd6e35880e17543d2962f1ab406c2be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xkao4k76N8IxIajuEhdnNA.png"/></div></div></figure><p id="c74a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面有一个“管道语法”的链接，它允许我们生成必要的脚本。</p><figure class="lj lk ll lm fd ln er es paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="er es me"><img src="../Images/5a7b8c94c75cf863bd9915b0bccbb511.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NvjVRvShDgY90bCAdpAgXw.png"/></div></div></figure><figure class="lj lk ll lm fd ln er es paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="er es mf"><img src="../Images/106d7da85bcb12608859beb768d22150.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SjEIh0HIycb7SAcNYx46xg.png"/></div></div></figure><p id="83e0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">复制生成的脚本并粘贴到上一屏幕的管道部分。因此，我准备了多个具有不同参数(例如，目标服务器)的“构建作业”脚本</p><h1 id="ce6c" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">网络检查</h1><p id="4ed1" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">我的另一个用例是与网络团队一起检查服务器之间的网络连接。</p><p id="d090" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我定义了一个多行字符串参数如下:</p><figure class="lj lk ll lm fd ln er es paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="er es mg"><img src="../Images/d6f991f18540c35692f8956455e52c7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GGFQ9V5BkDJ_M448hZ01Ag.png"/></div></div><figcaption class="lz ma et er es mb mc bd b be z dx">The parameter is having pattern “label | hostname or IP | port”</figcaption></figure><p id="d5ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该脚本将执行:</p><ol class=""><li id="6204" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">在第一行设置+xe是为了不打印控制台结果中正在执行的行，并允许脚本继续运行，即使有错误</li><li id="3bd9" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">通过中断web_servers参数中定义的值(用逗号分隔)来构建服务器数组</li><li id="5164" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">将内部字段分隔符(IFS)更改为“\n ”,将多行参数拆分为行数组，然后恢复旧的IFS</li><li id="b544" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">对于每台web服务器，运行SSH命令进行telnet(从每条线路获取主机名/ip和端口)</li></ol><figure class="lj lk ll lm fd ln er es paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="er es mh"><img src="../Images/d92fe8cc0aebcf4c0db91c1c4d1d904d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eNC3xzJpO8bE-ZpeDM6JeA.png"/></div></div></figure><h1 id="de5b" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">API检查和预热</h1><p id="1f1d" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">API检查与此类似，但是我们使用curl，而不是在ssh命令中运行telnet。</p><p id="8d67" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一个问题是curl有时更能容忍标准开关(例如证书错误)和不同于编程语言库(例如axios)的结果。</p><p id="19e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于预热场景，我的用例是处理IIS空闲超时(20分钟),因此我将运行一个常规作业以卷曲到API端点，要在Jenkins中配置常规运行，我们可以在build triggers部分配置定期构建。</p><figure class="lj lk ll lm fd ln er es paragraph-image"><div class="er es mi"><img src="../Images/7fd66b10110704865347fc4955fa6361.png" data-original-src="https://miro.medium.com/v2/resize:fit:826/format:webp/1*odDSTVq1CaBHXVDE93pIAA.png"/></div><figcaption class="lz ma et er es mb mc bd b be z dx">The schedule follow cron scheduling pattern — try this to help you build the pattern: <a class="ae mj" href="https://crontab.guru/" rel="noopener ugc nofollow" target="_blank">https://crontab.guru/</a> or <a class="ae mj" href="https://freeformatter.com/cron-expression-generator-quartz.html" rel="noopener ugc nofollow" target="_blank">https://freeformatter.com/cron-expression-generator-quartz.html</a></figcaption></figure><h1 id="ad1f" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">结论</h1><p id="1e9b" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">Jenkins的用途比我最初预期的要多得多，但至少我觉得上面的用例涵盖了许多需要定期运行的部署和支持任务，尽管构建脚本和工作需要时间，但当我多次使用它时，它会得到很好的回报。</p></div></div>    
</body>
</html>