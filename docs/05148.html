<html>
<head>
<title>Log and Server Metrics Monitoring - WSO2 Micro Integrator 7.1.0</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">日志和服务器指标监控- WSO2 Micro Integrator 7.1.0</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/enabling-log-and-server-metrics-monitoring-to-wso2-micro-integrator-7-1-0-8f71bd9a55e0?source=collection_archive---------9-----------------------#2021-07-12">https://medium.com/geekculture/enabling-log-and-server-metrics-monitoring-to-wso2-micro-integrator-7-1-0-8f71bd9a55e0?source=collection_archive---------9-----------------------#2021-07-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="b7ed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">监控是部署的一个重要部分，它使支持和开发团队能够在运行时轻松地找到bug或问题。一个高效的日志记录和监控系统不仅应该支持发现问题，还必须不影响系统的性能。</p><p id="ab13" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">WSO2早些时候针对此用例推出了WSO2 EI Analytics，存在的问题是日志监控，尽管我们有监控API请求计数、代理服务请求计数等的工具。但是我们没有能力进行日志消息监控和跟踪。尽管围绕EI Analytics实现了一些插件，但是它们对WSO2微集成器有一些性能影响。</p><p id="d319" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于这些原因，推荐的处理方法是使用Prometheus、Fluent Bit、Loki、Jaeger和Grafana的组合。这些使用情形分别描述如下:</p><p id="234b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">普罗米修斯:</strong>这是用于服务器指标监控的</p><p id="7c04" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Fluent Bit: </strong>代理监听wso2日志并将它们发布到Loki。</p><p id="e6f4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Loki: </strong>存储日志，并在Grafana需要时进行处理。</p><p id="bd9e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Jaeger: </strong>用于启用消息追踪。有助于跟踪中介之间的微集成器流中的消息。</p><p id="60a4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Grafana: 连接洛基，普罗米修斯和耶格，并在可视化模式下显示统计数据。</p><p id="52e6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="jd">注意:在本文中我们不打算整合Jaeger将在我的下一篇博客中考虑这个概念。此外，设置是在Ubuntu 20.04.2 LTS上完成的，只需要最少的设置配置。</em>T13】</strong></p><p id="4f5e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下图突出显示了我们将要设置的内容以及它们之间的相互联系。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/32d015086fe995d95bd2efdd47e0ecc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MIQoAA7SF2IwoG5XccwlDg.png"/></div></div></figure><h2 id="af67" class="jq jr hi bd js jt ju jv jw jx jy jz ka iq kb kc kd iu ke kf kg iy kh ki kj kk bi translated">1.设置普罗米修斯</h2><p id="1af3" class="pw-post-body-paragraph if ig hi ih b ii kl ik il im km io ip iq kn is it iu ko iw ix iy kp ja jb jc hb bi translated">去https://prometheus.io/download/<a class="ae kq" href="https://prometheus.io/download/" rel="noopener ugc nofollow" target="_blank">下载普罗米修斯版本。在这里我下载了prometheus-2.28.1.linux-amd64。</a></p><p id="e098" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">打开prometheus.yml并更新以下内容:</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="kr ks l"/></div></figure><p id="7145" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里:<strong class="ih hj">localhost:9090</strong>—Prometheus运行主机，<strong class="ih hj"> localhost:9201 </strong>是微集成器主机和端口。</p><p id="fdee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">执行以下命令启动Prometheus服务器。</p><p id="70ee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">。/普罗米修斯</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="kr ks l"/></div></figure><h2 id="1ef5" class="jq jr hi bd js jt ju jv jw jx jy jz ka iq kb kc kd iu ke kf kg iy kh ki kj kk bi translated">2.设置洛基</h2><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="kr ks l"/></div></figure><p id="5b80" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦完成，我们需要设置配置文件。创建一个名为loki-local-config.yaml的文件，并插入以下内容。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="kr ks l"/></div></figure><p id="e035" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要启动Loki服务器，请执行以下操作:</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="kr ks l"/></div></figure><p id="04e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">成功启动后，您可以看到如下日志:</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="kr ks l"/></div></figure><h2 id="f13f" class="jq jr hi bd js jt ju jv jw jx jy jz ka iq kb kc kd iu ke kf kg iy kh ki kj kk bi translated">3.设置流畅位</h2><p id="e457" class="pw-post-body-paragraph if ig hi ih b ii kl ik il im km io ip iq kn is it iu ko iw ix iy kp ja jb jc hb bi translated">有两个选项来设置它。</p><ul class=""><li id="fb76" class="kt ku hi ih b ii ij im in iq kv iu kw iy kx jc ky kz la lb bi translated">我们可以使用链接<a class="ae kq" href="https://docs.fluentbit.io/manual/installation/linux/ubuntu" rel="noopener ugc nofollow" target="_blank">https://docs.fluentbit.io/manual/installation/linux/ubuntu</a>为Ubuntu安装一个包，这将是td-agent-bit，所以命令可以不同。</li><li id="ce53" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">对于我这里的用例，我使用的是来自https://fluentbit.io/releases/1.7/fluent-bit-1.7.4.tar.gz<a class="ae kq" href="https://fluentbit.io/releases/1.7/fluent-bit-1.7.4.tar.gz" rel="noopener ugc nofollow" target="_blank">的源代码分发版</a>，推荐它基于链接<a class="ae kq" href="https://docs.fluentbit.io/manual/installation/sources/download-source-code" rel="noopener ugc nofollow" target="_blank">https://docs . fluent bit . io/manual/installation/sources/download-Source-Code</a>获取源代码</li><li id="3f50" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">注意，如果您使用sudo snap install fluent-bit，那么在执行配置文件时可能会遇到权限问题，就像我遇到的那样。请记下这个。</li></ul><p id="e9f3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">解压缩后，转到主目录并执行以下命令。一些依赖关系也需要如下。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="kr ks l"/></div></figure><h2 id="53f4" class="jq jr hi bd js jt ju jv jw jx jy jz ka iq kb kc kd iu ke kf kg iy kh ki kj kk bi translated">4.设置Grafana</h2><p id="47cc" class="pw-post-body-paragraph if ig hi ih b ii kl ik il im km io ip iq kn is it iu ko iw ix iy kp ja jb jc hb bi translated">前往<a class="ae kq" href="https://grafana.com/grafana/download/7.1.1" rel="noopener ugc nofollow" target="_blank">https://grafana.com/grafana/download/7.1.1</a>下载产品。</p><p id="d9fa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">把它提取到一个地方。</p><p id="0bd5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">转到bin目录，使用。/grafana-server。成功启动后，您可以看到如下日志:</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="kr ks l"/></div></figure><h2 id="bda3" class="jq jr hi bd js jt ju jv jw jx jy jz ka iq kb kc kd iu ke kf kg iy kh ki kj kk bi translated">5.设置数据源和仪表板以进行可视化</h2><p id="70bc" class="pw-post-body-paragraph if ig hi ih b ii kl ik il im km io ip iq kn is it iu ko iw ix iy kp ja jb jc hb bi translated">转到<a class="ae kq" href="http://localhost:3000/" rel="noopener ugc nofollow" target="_blank"> http://localhost:3000/ </a></p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lh"><img src="../Images/6d4f17a86124589085e5089f64051c57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uWcMA0VL650MCIuU4m7G2A.png"/></div></div></figure><p id="3ee9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们需要设置数据源，我们的主要来源是洛基和普罗米修斯。</p><p id="15d4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">转到配置-&gt;数据源并配置Loki和Prometheus。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es li"><img src="../Images/e099d9cdb64e0a718d854ad51868973a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*da5fecRfPQKVkNKFftjyUQ.png"/></div></div></figure><p id="7b07" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们完成了数据源，我们需要上传WSO2仪表板。</p><p id="001b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">转到<a class="ae kq" href="https://grafana.com/orgs/wso2/dashboards" rel="noopener ugc nofollow" target="_blank">https://grafana.com/orgs/wso2/dashboards</a>，这里我只加载高亮显示的三个。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lj"><img src="../Images/fa9f7461473c12d8bbd9864b0097781a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TZ5FBBwak6geXUPHpxCYDA.png"/></div></div></figure><p id="89d6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">选择具体的JSON文件后下载。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lk"><img src="../Images/e93d0127ff5ac166af55f4d0598ac763.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ywmXCH1jwKUgu0m3KcYtzw.png"/></div></div></figure><p id="d741" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">像wise一样下载其他的。</p><p id="7ccc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在转到Grafana并加载JSON文件。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es ll"><img src="../Images/fa4f087e34ac11967880c6b21035e712.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rJ30mthByswtcDtkezcUQQ.png"/></div></div></figure><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lm"><img src="../Images/e255e9738e59c129a71636f5eb2a618c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O77NHdHpOVsA92mECQIP3A.png"/></div></div></figure><p id="5266" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面是其中一个控制面板，您可以看到日志部分仍然是空的。</p><p id="a612" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">还要注意，我们需要如下启动微集成器来体验上面的仪表板。</p><p id="5ff6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将以下内容添加到deployment.toml</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="kr ks l"/></div></figure><p id="52e4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">sh微积分器. sh -DenablePrometheusApi=true</p><h2 id="35f2" class="jq jr hi bd js jt ju jv jw jx jy jz ka iq kb kc kd iu ke kf kg iy kh ki kj kk bi translated">6.启用日志监控</h2><p id="24b6" class="pw-post-body-paragraph if ig hi ih b ii kl ik il im km io ip iq kn is it iu ko iw ix iy kp ja jb jc hb bi translated">要启用日志监控，需要将日志数据发送到Loki，因此Fluent Bit客户端将完成这一部分。</p><p id="9f5a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要为Loki设置Fluent Bit客户端，我们首先需要构建插件。去…</p><p id="2f9e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae kq" href="https://github.com/grafana/loki.git" rel="noopener ugc nofollow" target="_blank">https://github.com/grafana/loki.git</a>并克隆存储库。这里我用的是v1.6.1，如果你用的是最新版本，文件夹结构可能会不匹配，因为它已经在最新版本中更新了。</p><p id="5e11" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">转到loki主文件夹并执行:</p><p id="53c1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">制作流畅位插件</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="kr ks l"/></div></figure><p id="bdf2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">生成的插件将命名为out_loki.so。</p><p id="6349" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们需要创建一个配置文件来提取日志，并使用Fluent Bit将其推送到Loki。</p><p id="92a1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建一个名为parsers.conf的文件</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="kr ks l"/></div></figure><p id="e0fe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">注意:这里Time_Offset很重要，否则将数据从API发布到Loki时会出错。</em></p><p id="7b73" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建名为fluent-bit.conf的文件</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="kr ks l"/></div></figure><p id="b290" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，从我们在<strong class="ih hj">设置Fluent Bit </strong>步骤构建Fluent Bit的位置，使用下面的命令运行Fluent Bit代理。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="kr ks l"/></div></figure><p id="0a39" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">成功启动后:</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="kr ks l"/></div></figure><h2 id="bd40" class="jq jr hi bd js jt ju jv jw jx jy jz ka iq kb kc kd iu ke kf kg iy kh ki kj kk bi translated">7.验证日志监控</h2><p id="4f84" class="pw-post-body-paragraph if ig hi ih b ii kl ik il im km io ip iq kn is it iu ko iw ix iy kp ja jb jc hb bi translated">发送API请求并查看仪表板日志部分。</p><p id="067b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在Loki中，您可以看到如下日志:</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="kr ks l"/></div></figure><p id="952f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在仪表板中:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es ln"><img src="../Images/f5a6aeb257f4e0b3208a8116dac8e852.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n8PlAfGkxV_hSYEhQm4VGQ.png"/></div></div></figure><h2 id="bd20" class="jq jr hi bd js jt ju jv jw jx jy jz ka iq kb kc kd iu ke kf kg iy kh ki kj kk bi translated">8.参考</h2><p id="fba7" class="pw-post-body-paragraph if ig hi ih b ii kl ik il im km io ip iq kn is it iu ko iw ix iy kp ja jb jc hb bi translated">[1]<a class="ae kq" href="https://ei.docs.wso2.com/en/latest/micro-integrator/setup/observability/setting-up-minimum-basic-observability-deployment/#setting-up-prometheus" rel="noopener ugc nofollow" target="_blank">https://ei . docs . WSO 2 . com/en/latest/micro-integrator/setup/observability/setting-up-minimum-basic-observability-deployment/# setting-up-Prometheus</a></p><p id="1151" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">[2]<a class="ae kq" href="https://ei.docs.wso2.com/en/latest/micro-integrator/administer-and-observe/cloud-native-observability-dashboards/" rel="noopener ugc nofollow" target="_blank">https://ei . docs . WSO 2 . com/en/latest/micro-integrator/administer-and-observe/cloud-native-observability-dashboards/</a></p></div></div>    
</body>
</html>