<html>
<head>
<title>Really Understanding CSRF</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">真正了解CSRF</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/really-understanding-csrf-228398aeaed3?source=collection_archive---------4-----------------------#2022-05-10">https://medium.com/geekculture/really-understanding-csrf-228398aeaed3?source=collection_archive---------4-----------------------#2022-05-10</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ih ii ij ik er es paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="er es ig"><img src="../Images/d0fc6a4138f3e0cabb8ed2f0186f3032.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nV0-ixpQzNrzVGpa46ryUA.jpeg"/></div></div></figure><h1 id="f490" class="ir is hi bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo bi translated">快速介绍</h1><p id="8ff2" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">大多数软件工程师在某个时候听说过的最流行的攻击之一是CSRF或跨站点请求伪造(别担心，这个名字听起来比实际更复杂)。</p><p id="36df" class="pw-post-body-paragraph jp jq hi jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hb bi translated">读到这里，我发现人们如何找到巧妙的方法绕过安全措施真的很有趣。我认为讨论它是如何工作的，如何防止它，以及关于另一个类似的攻击会很有趣。</p><h1 id="baca" class="ir is hi bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo bi translated">饼干</h1><p id="a604" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">在我们了解什么是CSRF之前，我们需要了解什么是饼干。如果你已经知道什么是cookies，可以跳过这一部分。</p><p id="1003" class="pw-post-body-paragraph jp jq hi jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hb bi translated">简而言之，cookies是一种浏览器功能，通过它，web浏览器可以记住有关用户的某些细节，并将它们附加到它向特定服务器发出的每个请求中。</p><p id="3b1c" class="pw-post-body-paragraph jp jq hi jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hb bi translated">让我再澄清一下。假设你想从亚马逊购买一些东西。你登录亚马逊，进入商品页面。选择数量、型号等后，点击黄色大按钮“立即购买”。后端收到购买商品的请求，但是它如何验证您的身份呢？它怎么知道真的是你发送的请求呢？如果每次发送API请求都要输入密码，那真的很不方便。</p><p id="94c0" class="pw-post-body-paragraph jp jq hi jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hb bi translated">为了防止这种情况，当你登录亚马逊时，亚马逊会在你的浏览器中放置一些cookies来识别你的身份。这些cookies包含一些对您来说是唯一的随机字符串(或令牌)。</p><figure class="kt ku kv kw fd ik er es paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="er es ks"><img src="../Images/e3fc9f576184d25dfce8fa5f4ad4b6ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3NqxILF6l-U_myJz77B6Tw.png"/></div></div></figure><p id="125d" class="pw-post-body-paragraph jp jq hi jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hb bi translated">后端存储这些令牌，浏览器也存储它们。这些被称为会话令牌。浏览器会自动将存储会话令牌的cookies发送给它向Amazon.com发出的每个后端请求，例如，当您向购物车添加商品时。在后端，Amazon可以读取这些会话令牌，并使用它来验证您的身份。</p><figure class="kt ku kv kw fd ik er es paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="er es ks"><img src="../Images/b36980301ba907e2b9058e4dcf650605.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8KTUANN48DrbigYPM6-fxQ.png"/></div></div></figure><p id="3a34" class="pw-post-body-paragraph jp jq hi jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hb bi translated">这很好，因为现在你作为用户，不需要写密码，浏览器会为你处理每个API请求的认证。</p><p id="409f" class="pw-post-body-paragraph jp jq hi jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hb bi translated">要理解这与CSRF的关系，你需要理解浏览器会把它从Amazon.com得到的任何cookies发送给任何发往Amazon.com的<strong class="jr hj"><em class="kx"/></strong>。这意味着，如果你点击了任何其他网站上的链接<strong class="jr hj"> <em class="kx">以及</em> </strong>(例如，这个——<a class="ae ky" href="http://amazon.com" rel="noopener ugc nofollow" target="_blank">Amazon.com</a>)，任何存储在你的浏览器中的cookie，包括有你的凭证的cookie，都会被发送到Amazon.com。</p><p id="2822" class="pw-post-body-paragraph jp jq hi jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hb bi translated">尽管如此，这可能看起来还不错。Amazon.com的任何凭证cookies都会被发送到Amazon.com，所以一切看起来都很好。或者是？</p><h1 id="ceb5" class="ir is hi bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo bi translated">那么，CSRF的攻击是如何进行的呢？</h1><p id="fbad" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">我们用一个例子来理解这个。让我们假设你正在研究网飞的一个系列。显然，您已经登录到网飞，在登录过程中，网飞存储了一些cookiess，它将使用这些cookie对您进行身份验证，以满足将来的API请求。这些cookies保存在您的浏览器中。让我们假设它们看起来像这样，</p><pre class="kt ku kv kw fd kz la lb lc aw ld bi"><span id="0e3e" class="le is hi la b fi lf lg l lh li">{<br/>  "sessionToken": "593a1b76-c263-4daf-8f80-e4f67c2bdcf7"<br/>}</span></pre><p id="c21f" class="pw-post-body-paragraph jp jq hi jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hb bi translated">稍后会很重要的一点是你在网飞的“我的账户”页面上的按钮，这个按钮可以关闭你的账户。单击该按钮会向<code class="du lj lk ll la b">netflix.com/deactivate</code>发送POST请求。</p><figure class="kt ku kv kw fd ik"><div class="bz dy l di"><div class="lm ln l"/></div></figure><p id="40c7" class="pw-post-body-paragraph jp jq hi jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hb bi translated">请记住，包含您的会话令牌的cookies也会随此请求一起发送，因为它是发往netflix.com的。</p><p id="adfc" class="pw-post-body-paragraph jp jq hi jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hb bi translated">API将通过你的<code class="du lj lk ll la b">sessionToken</code>验证你的身份，如果它与数据库中的匹配，它将停用你的账户。</p><p id="d054" class="pw-post-body-paragraph jp jq hi jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hb bi translated">但是你不需要考虑按钮，因为你爱Netflix♥💕停用你的账户意味着你将无法访问你想看的精彩节目列表。</p><p id="719c" class="pw-post-body-paragraph jp jq hi jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hb bi translated">在网飞狂欢之后，你收到一封可疑的电子邮件，说如果你点击一个链接，就有机会赢得一百万美元。天真地，你点击链接，它会把你带到一个空页面。干得好，你的网飞帐户已被停用！</p><figure class="kt ku kv kw fd ik er es paragraph-image"><div class="er es lo"><img src="../Images/33c38129c2b17e2b3b1708b8663e7900.png" data-original-src="https://miro.medium.com/v2/resize:fit:988/0*cvpk0-DQT5Jrzbc2.gif"/></div></figure><h2 id="817b" class="le is hi bd it lp lq lr ix ls lt lu jb ka lv lw jf ke lx ly jj ki lz ma jn mb bi translated">好吧，到底发生了什么？</h2><p id="2afa" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">当你点击链接时，它向一个网站发出一个简单的HTTP请求，返回一个简单的空白页面。虽然页面看起来是空的，但实际上并不是空的。事实上，它包含了一些有趣的javascript。</p><figure class="kt ku kv kw fd ik"><div class="bz dy l di"><div class="lm ln l"/></div></figure><p id="627d" class="pw-post-body-paragraph jp jq hi jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hb bi translated">那么，这段代码做了什么呢？它向netflix.com/deactivate.发出请求，您的浏览器在请求中附加了它为netflix.com准备的会话令牌(请记住，浏览器会将来自网飞的cookies附加到向netflix.com发出的任何请求中，即使它来自不同的来源)。</p><figure class="kt ku kv kw fd ik er es paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="er es mc"><img src="../Images/d77a812b2c4ef8251f7d70aac9b63414.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VB3qrKYIJnTPWe2smbVQhg.png"/></div></div></figure><p id="3cb0" class="pw-post-body-paragraph jp jq hi jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hb bi translated">当网飞收到请求时，它会检查收到的会话令牌，并在确认后停用您的帐户。</p><h1 id="0a71" class="ir is hi bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo bi translated">如何保护我们的应用程序免受CSRF攻击？</h1><p id="d3af" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">保护我们的应用程序免受CSRF攻击的一个流行方法是在登录时在后端创建一个CSRF令牌，在前端存储这个CSRF令牌(不是在cookies中)，并在每次请求时手动发送这个令牌。</p><figure class="kt ku kv kw fd ik er es paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="er es ks"><img src="../Images/e5ff0268a170797193f3a1c621cf983a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*30ruo4zevkK-E6qAC-WQcA.png"/></div></div></figure><p id="7cb2" class="pw-post-body-paragraph jp jq hi jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hb bi translated">在验证请求时，后端可以验证CSRF令牌和会话令牌。</p><p id="8e9f" class="pw-post-body-paragraph jp jq hi jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hb bi translated">不同的前端将不能访问CSRF令牌，因为它没有被保存为cookie，因此不能从不同的web应用程序发送。</p><h1 id="0528" class="ir is hi bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo bi translated">为什么SOP不起作用</h1><p id="5785" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">您可能会想，既然我们从不同的来源发送请求，同源策略应该阻止这样的请求。但这不一定是真的。</p><p id="dd2c" class="pw-post-body-paragraph jp jq hi jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hb bi translated">如果你看看攻击者使用的代码，</p><figure class="kt ku kv kw fd ik"><div class="bz dy l di"><div class="lm ln l"/></div></figure><p id="0be8" class="pw-post-body-paragraph jp jq hi jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hb bi translated">这个请求其实是一个<em class="kx">简单的</em>请求。简单请求是浏览器不会发送预检请求的请求。什么是飞行前请求？当你发送一个请求到一个不同的源时，你的浏览器会发出一个预检请求，实质上就是浏览器询问服务器，你是否愿意接受这个请求。一个简单的请求需要满足一些条件，但是我们现在不要讨论这个问题。简而言之，我们的请求是一个简单的请求，所以浏览器不会发送奇怪的预检请求来阻止攻击。如果你感兴趣，这里有更多关于SOP的信息<a class="ae ky" href="https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy" rel="noopener ugc nofollow" target="_blank"/>。</p><h1 id="3434" class="ir is hi bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo bi translated">SSRF？</h1><figure class="kt ku kv kw fd ik er es paragraph-image"><div class="er es md"><img src="../Images/c569e79f8e2ddd39e5f81e992e2c7529.png" data-original-src="https://miro.medium.com/v2/resize:fit:866/0*jDJdm_j2rck5ZVOa.gif"/></div><figcaption class="me mf et er es mg mh bd b be z dx">For my friends who don’t speak Hindi, this means, “Story is not yet complete!”</figcaption></figure><p id="1e59" class="pw-post-body-paragraph jp jq hi jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hb bi translated">我读了一些关于不同安全漏洞的文章，发现人们如何找到如此有创意和聪明的黑客，以及这些攻击仍在被发现的事实真的很有趣。</p><p id="56d9" class="pw-post-body-paragraph jp jq hi jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hb bi translated">我会在下一篇文章中继续讨论另一个问题，SSRF或服务器端请求伪造。这是一种有趣的方式，攻击者可以通过它让服务器向源发送请求！</p><p id="c744" class="pw-post-body-paragraph jp jq hi jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hb bi translated">如果你也觉得这很有趣，请给我掌声或评论，让我知道！还有，跟着我不要错过我的故事。</p></div></div>    
</body>
</html>