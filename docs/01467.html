<html>
<head>
<title>Data Protection</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">数据保护</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/data-protection-80549698533?source=collection_archive---------11-----------------------#2021-04-11">https://medium.com/geekculture/data-protection-80549698533?source=collection_archive---------11-----------------------#2021-04-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="564b" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">使用Velero进行K8s备份和恢复</h2></div><p id="ffbb" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Velero是一个开源备份工具，用于保存和恢复Kubernetes集群状态。K8s集群状态(包括挂载的数据)保存在一个外部对象存储中，用于在意外丢失/删除的情况下在同一个集群中恢复它，或者在不同云中其他地方的新集群中恢复它。它使用云提供商的本机功能拍摄卷快照，并使用restic促进供应商中立的备份。</p><blockquote class="jt ju jv"><p id="fbbb" class="ix iy jw iz b ja jb ij jc jd je im jf jx jh ji jj jy jl jm jn jz jp jq jr js hb bi translated"><strong class="iz hj">背景:</strong>让我们看看如何利用Velero在运行于两个不同云上的K8s集群之间移动数据。这将使用restic集成，而不是本地云提供商快照功能。</p></blockquote><figure class="kb kc kd ke fd kf er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es ka"><img src="../Images/850f0bc15073acd4111fc13682e2408d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KPQ6NOxCKdK2yogPmTRVeA.jpeg"/></div></div></figure><blockquote class="jt ju jv"><p id="cbaf" class="ix iy jw iz b ja jb ij jc jd je im jf jx jh ji jj jy jl jm jn jz jp jq jr js hb bi translated"><strong class="iz hj">先决条件:</strong>在两个不同的云'/dcs '和外部预配置的S3兼容对象存储中运行K8s集群。</p></blockquote></div><div class="ab cl km kn gp ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="hb hc hd he hf"><blockquote class="jt ju jv"><p id="c289" class="ix iy jw iz b ja jb ij jc jd je im jf jx jh ji jj jy jl jm jn jz jp jq jr js hb bi translated"><strong class="iz hj"> Init: </strong>源是通过Tanzu Mission Control (TMC)在AWS上提供的Tanzu Kubernetes网格(TKG)集群，目标是本地GKE集群，Minio作为外部对象存储。</p></blockquote><p id="1288" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们在Postgres DB上安装一个具有外部状态依赖的Spring反应式r2dbc应用程序。Postgres存储作为PVC安装在EBS卷上。要部署到TKG集群的源代码和K8s资源清单可从这里获得<a class="ae kt" href="https://github.com/srinivasa-vasu/todo.git" rel="noopener ugc nofollow" target="_blank"/>。</p><blockquote class="jt ju jv"><p id="722c" class="ix iy jw iz b ja jb ij jc jd je im jf jx jh ji jj jy jl jm jn jz jp jq jr js hb bi translated"><strong class="iz hj">源操作</strong></p></blockquote><p id="018d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建一个新的名称空间<code class="du ku kv kw kx b">kubectl create ns todo</code>，将上面的repo克隆到本地文件系统，并使用ska fold-CLI/waypoint等工具将应用程序部署到这个名称空间。使用这些工具，构建和部署通过单个清单定义集成并完成。</p><blockquote class="jt ju jv"><p id="9ff8" class="ix iy jw iz b ja jb ij jc jd je im jf jx jh ji jj jy jl jm jn jz jp jq jr js hb bi translated">一个<strong class="iz hj">PP-展开</strong></p></blockquote><pre class="kb kc kd ke fd ky kx kz la aw lb bi"><span id="e1cc" class="lc ld hi kx b fi le lf l lg lh">skaffold run -n todo --tail</span></pre><p id="27b8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在克隆的源存储库中导航到目标k8s文件夹，并运行上面的命令来构建应用程序并将其部署到TKG。确保将部署和skaffold清单中的映像引用更新到您的注册表和repo引用中。</p><pre class="kb kc kd ke fd ky kx kz la aw lb bi"><span id="1ab4" class="lc ld hi kx b fi le lf l lg lh">╰─ <strong class="kx hj">kubectl -n todo get pods</strong><br/>NAME                             READY   STATUS    RESTARTS   AGE<br/>todo-79855b98fb-5vxj6            1/1     Running   0          41h<br/>todo-postgres-6dd5c84546-dj7kl   1/1     Running   0          41h</span><span id="64d3" class="lc ld hi kx b fi li lf l lg lh">╰─ <strong class="kx hj">kubectl -n todo get pvc</strong><br/>NAME                STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE<br/>todo-postgres-pvc   Bound    pvc-54ded26c-7451-4129-957a-fc4d949c57b5   5Gi        RWO            standard       41h</span><span id="9cd8" class="lc ld hi kx b fi li lf l lg lh">╰─ <strong class="kx hj">kubectl -n todo get svc</strong><br/>NAME            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE<br/>todo            ClusterIP   10.100.101.246   &lt;none&gt;        8080/TCP   41h<br/>todo-postgres   ClusterIP   10.103.2.225     &lt;none&gt;        5432/TCP   41h</span></pre><p id="6d19" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们向todo应用程序发送一些POST/PUT请求，以使用<a class="ae kt" href="https://httpie.io/" rel="noopener ugc nofollow" target="_blank"> httpie </a>或您选择的任何工具对后台Postgres持久性存储进行更改。</p><blockquote class="jt ju jv"><p id="5d27" class="ix iy jw iz b ja jb ij jc jd je im jf jx jh ji jj jy jl jm jn jz jp jq jr js hb bi translated">数据持久性</p></blockquote><pre class="kb kc kd ke fd ky kx kz la aw lb bi"><span id="6e4c" class="lc ld hi kx b fi le lf l lg lh">╰─ <strong class="kx hj">kubectl -n todo port-forward svc/todo 8080:8080</strong><br/>Forwarding from 127.0.0.1:8080 -&gt; 8080<br/>Forwarding from [::1]:8080 -&gt; 8080</span><span id="df0d" class="lc ld hi kx b fi li lf l lg lh">╰─ <strong class="kx hj">http :8080/todo</strong><br/>HTTP/1.1 200 OK<br/>Content-Type: application/json<br/>transfer-encoding: chunked</span><span id="d055" class="lc ld hi kx b fi li lf l lg lh">[<br/>    {<br/>        "id": "3fc179e3-353b-440b-8164-12f98df3a545",<br/>        "status": true,<br/>        "task": "My first todo"<br/>    }<br/>]</span><span id="8b18" class="lc ld hi kx b fi li lf l lg lh">╰─ <strong class="kx hj">http POST :8080/todo id="" task="Velero data protection"</strong><br/>HTTP/1.1 201 Created<br/>Content-Length: 92<br/>Content-Type: application/json</span><span id="26a6" class="lc ld hi kx b fi li lf l lg lh">{<br/>    "id": "fba98524-e830-4569-912f-3a4cdecee1dc",<br/>    "status": false,<br/>    "task": "Velero data protection"<br/>}</span><span id="6572" class="lc ld hi kx b fi li lf l lg lh">╰─ <strong class="kx hj">http POST :8080/todo id="" task="Velero data recovery" </strong>status=true<br/>HTTP/1.1 201 Created<br/>Content-Length: 89<br/>Content-Type: application/json</span><span id="b763" class="lc ld hi kx b fi li lf l lg lh">{<br/>    "id": "3724f8e5-e2ac-44e5-ae03-5b25c04191ef",<br/>    "status": true,<br/>    "task": "Velero data recovery"<br/>}</span><span id="70c8" class="lc ld hi kx b fi li lf l lg lh">╰─ <strong class="kx hj">http PUT :8080/todo id="fba98524-e830-4569-912f-3a4cdecee1dc" </strong>status="true" task="Velero data protection"<br/>HTTP/1.1 200 OK<br/>Content-Length: 91<br/>Content-Type: application/json</span><span id="afc5" class="lc ld hi kx b fi li lf l lg lh">{<br/>    "id": "fba98524-e830-4569-912f-3a4cdecee1dc",<br/>    "status": true,<br/>    "task": "Velero data protection"<br/>}</span></pre><p id="4a6c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">跳回以检查数据存储状态，</p><pre class="kb kc kd ke fd ky kx kz la aw lb bi"><span id="2759" class="lc ld hi kx b fi le lf l lg lh">╰─<strong class="kx hj"> http :8080/todo</strong><br/>HTTP/1.1 200 OK<br/>Content-Type: application/json<br/>transfer-encoding: chunked</span><span id="36a4" class="lc ld hi kx b fi li lf l lg lh">[<br/>    {<br/>        "id": "fba98524-e830-4569-912f-3a4cdecee1dc",<br/>        "status": true,<br/>        "task": "Velero data protection"<br/>    },<br/>    {<br/>        "id": "3fc179e3-353b-440b-8164-12f98df3a545",<br/>        "status": true,<br/>        "task": "My first todo"<br/>    },<br/>    {<br/>        "id": "3724f8e5-e2ac-44e5-ae03-5b25c04191ef",<br/>        "status": true,<br/>        "task": "Velero data recovery"<br/>    }<br/>]</span></pre><blockquote class="jt ju jv"><p id="9118" class="ix iy jw iz b ja jb ij jc jd je im jf jx jh ji jj jy jl jm jn jz jp jq jr js hb bi translated"><strong class="iz hj">初始化Velero </strong></p></blockquote><p id="09c0" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们使用CLI安装velero，</p><pre class="kb kc kd ke fd ky kx kz la aw lb bi"><span id="44d8" class="lc ld hi kx b fi le lf l lg lh">velero install --use-restic \<br/>    --default-volumes-to-restic \<br/>    --provider aws \<br/>    --plugins velero/velero-plugin-for-aws:v1.2.0 \<br/>    --bucket <strong class="kx hj">&lt;bucket_store_name&gt;</strong> \<br/>    --secret-file <strong class="kx hj">&lt;bucket_access_creds_file_path&gt;</strong> \<br/>    --backup-location-config region=minio,s3ForcePathStyle="true",s3Url=<strong class="kx hj">&lt;s3_endpoint_url&gt;</strong></span><span id="9bf7" class="lc ld hi kx b fi li lf l lg lh">default-volumes-to-restic <br/>- will enable the restic volume backup by default</span><span id="7259" class="lc ld hi kx b fi li lf l lg lh">secret-file<br/>- content of the file would be like,<br/><strong class="kx hj"><em class="jw">[default]<br/>aws_access_key_id=&lt;val&gt;<br/>aws_secret_access_key=&lt;val&gt;</em></strong></span><span id="2a89" class="lc ld hi kx b fi li lf l lg lh">backup-location-config<br/>- point it to the S3 minio endpoint and region location</span></pre><p id="79a9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">检查安装的状态，</p><pre class="kb kc kd ke fd ky kx kz la aw lb bi"><span id="50d8" class="lc ld hi kx b fi le lf l lg lh">╰─ <strong class="kx hj">velero backup-location get</strong><br/>NAME      PROVIDER   BUCKET/PREFIX   PHASE       LAST VALIDATED                  ACCESS MODE<br/>default   aws        oss-dp          Available   2021-04-10 21:02:24 +0530 IST   ReadWrite</span><span id="07be" class="lc ld hi kx b fi li lf l lg lh">╰─<strong class="kx hj"> kubectl -n velero get all</strong><br/>NAME                          READY   STATUS    RESTARTS   AGE<br/>pod/restic-lxl8g              1/1     Running   0          49s<br/>pod/restic-tlwx6              1/1     Running   0          49s<br/>pod/velero-65b78c9b54-z5nx2   1/1     Running   0          50s</span><span id="0880" class="lc ld hi kx b fi li lf l lg lh">NAME                    DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE<br/>daemonset.apps/restic   2         2         2       2            2           &lt;none&gt;          52s</span><span id="8f50" class="lc ld hi kx b fi li lf l lg lh">NAME                     READY   UP-TO-DATE   AVAILABLE   AGE<br/>deployment.apps/velero   1/1     1            1           54s</span></pre><blockquote class="jt ju jv"><p id="6c20" class="ix iy jw iz b ja jb ij jc jd je im jf jx jh ji jj jy jl jm jn jz jp jq jr js hb bi translated"><strong class="iz hj">初始化备份</strong></p></blockquote><p id="0b64" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为<code class="du ku kv kw kx b">todo</code>名称空间启动velero备份，</p><pre class="kb kc kd ke fd ky kx kz la aw lb bi"><span id="00aa" class="lc ld hi kx b fi le lf l lg lh">╰─ <strong class="kx hj">velero backup create todo-bkp --include-namespaces todo</strong><br/>Backup request "todo-bkp" submitted successfully.</span></pre><p id="1533" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">检查备份状态，</p><pre class="kb kc kd ke fd ky kx kz la aw lb bi"><span id="7952" class="lc ld hi kx b fi le lf l lg lh">╰─ <strong class="kx hj">velero backup describe todo-bkp</strong><br/>Name:         todo-bkp<br/>Namespace:    velero<br/>Labels:       velero.io/storage-location=default<br/>Annotations:  velero.io/source-cluster-k8s-gitversion=v1.19.4+vmware.2<br/>              velero.io/source-cluster-k8s-major-version=1<br/>              velero.io/source-cluster-k8s-minor-version=19</span><span id="c71d" class="lc ld hi kx b fi li lf l lg lh">Phase:  Completed</span><span id="b148" class="lc ld hi kx b fi li lf l lg lh">Errors:    0<br/>Warnings:  0</span></pre><p id="d212" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">S3 minio存储桶将为启动的备份创建包含工件的适当结构。</p><figure class="kb kc kd ke fd kf er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es lj"><img src="../Images/e90974730877a9930836082762e401d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V_zoZOL_XiG9lmB7oQKKfA.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx">minio object-store</figcaption></figure><blockquote class="jt ju jv"><p id="c1b6" class="ix iy jw iz b ja jb ij jc jd je im jf jx jh ji jj jy jl jm jn jz jp jq jr js hb bi translated"><strong class="iz hj">目标运营</strong></p></blockquote><p id="8857" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们将上下文切换到GKE目标集群，并使用CLI以与上面相同的方式安装velero。检查集群状态，</p><pre class="kb kc kd ke fd ky kx kz la aw lb bi"><span id="9dd4" class="lc ld hi kx b fi le lf l lg lh">velero install --use-restic \<br/>    --default-volumes-to-restic \<br/>    --provider aws \<br/>    --plugins velero/velero-plugin-for-aws:v1.2.0 \<br/>    --bucket <strong class="kx hj">&lt;bucket_store_name&gt;</strong> \<br/>    --secret-file <strong class="kx hj">&lt;bucket_access_creds_file_path&gt;</strong> \<br/>    --backup-location-config region=minio,s3ForcePathStyle="true",s3Url=<strong class="kx hj">&lt;s3_endpoint_url&gt;</strong></span><span id="dc37" class="lc ld hi kx b fi li lf l lg lh">- point the velero controller to the same external minio store.</span><span id="24fb" class="lc ld hi kx b fi li lf l lg lh">╰─ <strong class="kx hj">velero backup-location get</strong><br/>NAME      PROVIDER   BUCKET/PREFIX   PHASE       LAST VALIDATED                  ACCESS MODE<br/>default   aws        oss-dp          Available   2021-04-10 21:25:21 +0530 IST   ReadWrite</span><span id="18f5" class="lc ld hi kx b fi li lf l lg lh">╰─ <strong class="kx hj">k get ns</strong><br/>NAME              STATUS   AGE<br/>default           Active   5m57s<br/>kube-node-lease   Active   5m59s<br/>kube-public       Active   5m59s<br/>kube-system       Active   5m59s<br/>velero            Active   63s</span></pre><blockquote class="jt ju jv"><p id="e7de" class="ix iy jw iz b ja jb ij jc jd je im jf jx jh ji jj jy jl jm jn jz jp jq jr js hb bi translated"><strong class="iz hj">初始化恢复</strong></p></blockquote><p id="9c16" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">恢复该集群中的<code class="du ku kv kw kx b">todo</code>名称空间，</p><pre class="kb kc kd ke fd ky kx kz la aw lb bi"><span id="e684" class="lc ld hi kx b fi le lf l lg lh">╰─ <strong class="kx hj">velero backup get</strong><br/>NAME       STATUS      ERRORS   WARNINGS   CREATED                         EXPIRES   STORAGE LOCATION   SELECTOR<br/>todo-bkp   Completed   0        0          2021-04-10 21:05:23 +0530 IST   29d       default            &lt;none&gt;</span><span id="9018" class="lc ld hi kx b fi li lf l lg lh">╰─ <strong class="kx hj">velero restore create --from-backup=todo-bkp todo-restore</strong><br/>Restore request "todo-restore" submitted successfully.<br/>Run `velero restore describe todo-restore` or `velero restore logs todo-restore` for more details.</span></pre><p id="8d17" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">检查还原状态，</p><pre class="kb kc kd ke fd ky kx kz la aw lb bi"><span id="0096" class="lc ld hi kx b fi le lf l lg lh">╰─ <strong class="kx hj">velero restore describe todo-restore</strong><br/>Name:         todo-restore<br/>Namespace:    velero<br/>Labels:       &lt;none&gt;<br/>Annotations:  &lt;none&gt;</span><span id="bf82" class="lc ld hi kx b fi li lf l lg lh">Phase:  Completed</span><span id="7eab" class="lc ld hi kx b fi li lf l lg lh">╰─ <strong class="kx hj">kubectl get ns</strong><br/>NAME              STATUS   AGE<br/>default           Active   10m<br/>kube-node-lease   Active   10m<br/>kube-public       Active   10m<br/>kube-system       Active   10m<br/>todo              Active   2m2s<br/>velero            Active   5m53s</span><span id="dfa7" class="lc ld hi kx b fi li lf l lg lh">╰─ <strong class="kx hj">kubectl -n todo get pods</strong><br/>NAME                            READY   STATUS    RESTARTS   AGE<br/>todo-5b76c86c69-rvtgd           1/1     Running   1          3m39s<br/>todo-postgres-d95749c96-lx2bq   1/1     Running   0          3m39s</span><span id="eaaf" class="lc ld hi kx b fi li lf l lg lh">╰─ <strong class="kx hj">kubectl -n todo get pvc</strong><br/>NAME                STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE<br/>todo-postgres-pvc   Bound    pvc-d53829e5-a379-424c-af03-78dd796b251a   5Gi        RWO            standard       4m5s</span></pre><p id="f8da" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">检查数据存储状态，</p><pre class="kb kc kd ke fd ky kx kz la aw lb bi"><span id="1429" class="lc ld hi kx b fi le lf l lg lh">╰─ <strong class="kx hj">http :8080/todo</strong><br/>HTTP/1.1 200 OK<br/>Content-Type: application/json<br/>transfer-encoding: chunked</span><span id="4996" class="lc ld hi kx b fi li lf l lg lh">[<br/>    {<br/>        "id": "fba98524-e830-4569-912f-3a4cdecee1dc",<br/>        "status": true,<br/>        "task": "Velero data protection"<br/>    },<br/>    {<br/>        "id": "3fc179e3-353b-440b-8164-12f98df3a545",<br/>        "status": true,<br/>        "task": "My first todo"<br/>    },<br/>    {<br/>        "id": "3724f8e5-e2ac-44e5-ae03-5b25c04191ef",<br/>        "status": true,<br/>        "task": "Velero data recovery"<br/>    }<br/>]</span></pre><p id="2d33" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">恢复在目标群集中成功完成，状态与源相同。所有这些都发生在不对集群文件/定义进行任何更改的情况下。默认情况下，它使用restic作为安装期间指示的持久性。</p><p id="c11d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">清理名称空间<code class="du ku kv kw kx b">kubectl delete ns todo</code></p><blockquote class="jt ju jv"><p id="dcbf" class="ix iy jw iz b ja jb ij jc jd je im jf jx jh ji jj jy jl jm jn jz jp jq jr js hb bi translated"><strong class="iz hj">增量备份</strong></p></blockquote><p id="23a1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们将上下文切换到源TKG群集，并启动一个定时备份流程。Velero对创建的时间表进行增量备份。根据RTO/RPO要求创建Cron计划。在这种情况下，cron每5分钟运行一次，以备份指定的命名空间资源。</p><pre class="kb kc kd ke fd ky kx kz la aw lb bi"><span id="17d1" class="lc ld hi kx b fi le lf l lg lh">╰─ <strong class="kx hj">velero schedule create todo-incremental-bkp --schedule="*/5 * * * *" --include-namespaces=todo</strong><br/>Schedule "todo-incremental-bkp" created successfully.</span><span id="af39" class="lc ld hi kx b fi li lf l lg lh">╰─ <strong class="kx hj">velero schedule get</strong><br/>NAME                   STATUS    CREATED                         SCHEDULE      BACKUP TTL   LAST BACKUP   SELECTOR<br/>todo-incremental-bkp   Enabled   2021-04-10 21:44:33 +0530 IST   */5 * * * *   720h0m0s     44s ago       &lt;none&gt;</span></pre><p id="7a39" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们发布更多更新，</p><pre class="kb kc kd ke fd ky kx kz la aw lb bi"><span id="7fbc" class="lc ld hi kx b fi le lf l lg lh">╰─ <strong class="kx hj">http POST :8080/todo id="" task="Velero incremental backups" </strong>status=true<br/>HTTP/1.1 201 Created<br/>Content-Length: 95<br/>Content-Type: application/json</span><span id="a6c0" class="lc ld hi kx b fi li lf l lg lh">{<br/>    "id": "0bde3c1e-70b8-4545-b73e-f02ef9f6e2b1",<br/>    "status": true,<br/>    "task": "Velero incremental backups"<br/>}</span><span id="616b" class="lc ld hi kx b fi li lf l lg lh">╰─ <strong class="kx hj">http :8080/todo</strong><br/>HTTP/1.1 200 OK<br/>Content-Type: application/json<br/>transfer-encoding: chunked</span><span id="c020" class="lc ld hi kx b fi li lf l lg lh">[<br/>    {<br/>        "id": "fba98524-e830-4569-912f-3a4cdecee1dc",<br/>        "status": true,<br/>        "task": "Velero data protection"<br/>    },<br/>    {<br/>        "id": "3fc179e3-353b-440b-8164-12f98df3a545",<br/>        "status": true,<br/>        "task": "My first todo"<br/>    },<br/>    {<br/>        "id": "3724f8e5-e2ac-44e5-ae03-5b25c04191ef",<br/>        "status": true,<br/>        "task": "Velero data recovery"<br/>    },<br/>    {<br/>        "id": "0bde3c1e-70b8-4545-b73e-f02ef9f6e2b1",<br/>        "status": true,<br/>        "task": "Velero incremental backups"<br/>    }<br/>]</span></pre><p id="94e3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">跳到minio控制台，您会注意到增量备份更新。</p><figure class="kb kc kd ke fd kf er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es lo"><img src="../Images/bee16b4932f623458e3dd347ddd54cc1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IHYbuB7bAqhX4X5Wr5v1Mg.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx">scheduled incremental back-ups</figcaption></figure><blockquote class="jt ju jv"><p id="8c35" class="ix iy jw iz b ja jb ij jc jd je im jf jx jh ji jj jy jl jm jn jz jp jq jr js hb bi translated"><strong class="iz hj">再次初始化恢复</strong></p></blockquote><p id="37bc" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们将上下文切换回目标群集，以启动恢复过程。</p><pre class="kb kc kd ke fd ky kx kz la aw lb bi"><span id="e829" class="lc ld hi kx b fi le lf l lg lh">╰─ <strong class="kx hj">kubectl get ns</strong><br/>NAME              STATUS   AGE<br/>default           Active   38m<br/>kube-node-lease   Active   38m<br/>kube-public       Active   38m<br/>kube-system       Active   38m<br/>velero            Active   33m</span></pre><p id="c4ac" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在从增量备份中恢复<code class="du ku kv kw kx b">todo</code>命名空间数据，</p><pre class="kb kc kd ke fd ky kx kz la aw lb bi"><span id="01bf" class="lc ld hi kx b fi le lf l lg lh">╰─ <strong class="kx hj">velero restore create --from-schedule=todo-incremental-bkp todo-incremental-restore --include-namespaces=todo</strong><br/>Restore request "todo-incremental-bkp" submitted successfully.</span><span id="3108" class="lc ld hi kx b fi li lf l lg lh">╰─ <strong class="kx hj">velero restore describe todo-incremental-restore</strong><br/>Name:         todo-incremental-restore<br/>Namespace:    velero<br/>Labels:       &lt;none&gt;<br/>Annotations:  &lt;none&gt;</span><span id="da02" class="lc ld hi kx b fi li lf l lg lh">Phase:  Completed</span><span id="c1e5" class="lc ld hi kx b fi li lf l lg lh">Started:    2021-04-10 22:02:08 +0530 IST<br/>Completed:  2021-04-10 22:02:36 +0530 IST</span><span id="74e5" class="lc ld hi kx b fi li lf l lg lh">Backup:  todo-incremental-bkp-20210410163024</span></pre><p id="26b7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">检查还原状态，</p><pre class="kb kc kd ke fd ky kx kz la aw lb bi"><span id="9a31" class="lc ld hi kx b fi le lf l lg lh">╰─ <strong class="kx hj">kubectl get ns</strong><br/>NAME              STATUS   AGE<br/>default           Active   43m<br/>kube-node-lease   Active   43m<br/>kube-public       Active   43m<br/>kube-system       Active   43m<br/>todo              Active   79s<br/>velero            Active   38m</span><span id="8d42" class="lc ld hi kx b fi li lf l lg lh">╰─ <strong class="kx hj">kubectl -n todo get pods</strong><br/>NAME                            READY   STATUS    RESTARTS   AGE<br/>todo-5b76c86c69-rvtgd           1/1     Running   1          5m41s<br/>todo-postgres-d95749c96-lx2bq   1/1     Running   0          5m41s</span><span id="2302" class="lc ld hi kx b fi li lf l lg lh">╰─ <strong class="kx hj">kubectl -n todo get pvc</strong><br/>NAME                STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE<br/>todo-postgres-pvc   Bound    pvc-32a3329f-55d5-40d7-90bf-046b2960b6d6   5Gi        RWO            standard       6m38s</span></pre><p id="66ac" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">重新检查数据存储状态，</p><pre class="kb kc kd ke fd ky kx kz la aw lb bi"><span id="f800" class="lc ld hi kx b fi le lf l lg lh">╰─ <strong class="kx hj">http :8080/todo</strong><br/>HTTP/1.1 200 OK<br/>Content-Type: application/json<br/>transfer-encoding: chunked</span><span id="78eb" class="lc ld hi kx b fi li lf l lg lh">[<br/>    {<br/>        "id": "fba98524-e830-4569-912f-3a4cdecee1dc",<br/>        "status": true,<br/>        "task": "Velero data protection"<br/>    },<br/>    {<br/>        "id": "3fc179e3-353b-440b-8164-12f98df3a545",<br/>        "status": true,<br/>        "task": "My first todo"<br/>    },<br/>    {<br/>        "id": "3724f8e5-e2ac-44e5-ae03-5b25c04191ef",<br/>        "status": true,<br/>        "task": "Velero data recovery"<br/>    },<br/>    {<br/>        "id": "0bde3c1e-70b8-4545-b73e-f02ef9f6e2b1",<br/>        "status": true,<br/>        "task": "Velero incremental backups"<br/>    }<br/>]</span></pre><p id="694a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Velero已经完全恢复了名称空间状态，所有资源和数据都完好无损。这是一个常见的用例，其中Velero用于为灾难恢复安排K8s集群的常规备份。</p></div><div class="ab cl km kn gp ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="hb hc hd he hf"><blockquote class="jt ju jv"><p id="a4b8" class="ix iy jw iz b ja jb ij jc jd je im jf jx jh ji jj jy jl jm jn jz jp jq jr js hb bi translated"><strong class="iz hj"> <em class="hi">引用:<br/></em></strong>Velero<em class="hi"><br/></em><a class="ae kt" href="https://velero.io" rel="noopener ugc nofollow" target="_blank">https://Velero . io</a><a class="ae kt" href="https://velero.io/" rel="noopener ugc nofollow" target="_blank"><em class="hi"><br/></em></a><em class="hi">Velero源码<br/></em><a class="ae kt" href="https://github.com/vmware-tanzu/velero" rel="noopener ugc nofollow" target="_blank">https://github.com/vmware-tanzu/velero</a><em class="hi"><br/>Spring App源码<br/></em><a class="ae kt" href="https://github.com/srinivasa-vasu/todo.git" rel="noopener ugc nofollow" target="_blank">https://github.com/srinivasa-vasu/todo.git</a><strong class="iz hj"><em class="hi"><br/></em></strong><em class="hi">Velero-rest</em></p></blockquote></div></div>    
</body>
</html>