<html>
<head>
<title>Deploy a virtual machine in openstack using heat template with docker and rancher installed</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用安装了docker和rancher的heat模板在openstack中部署虚拟机</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/deploy-a-virtual-machine-in-openstack-then-install-docker-and-rancher-on-it-ea21d40da700?source=collection_archive---------42-----------------------#2021-06-07">https://medium.com/geekculture/deploy-a-virtual-machine-in-openstack-then-install-docker-and-rancher-on-it-ea21d40da700?source=collection_archive---------42-----------------------#2021-06-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/8e04a3309eb92b4713a3ee6a6a98c6b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iauu1wkJ4G1Fl-z1o4pYkg.png"/></div></div></figure><p id="c6e2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在本文中，我们将在Openstack中部署一个虚拟机，然后使用Heat Orchestration模板在其上安装docker和rancher。</p><p id="8044" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">原文:</p><div class="jo jp ez fb jq jr"><a href="https://blog.yassinemaachi.com/2021/06/how-to-lunch-rancher-using-docker-and.html" rel="noopener  ugc nofollow" target="_blank"><div class="js ab dw"><div class="jt ab ju cl cj jv"><h2 class="bd hj fi z dy jw ea eb jx ed ef hh bi translated">如何在openstack中使用docker和heat午餐牧场主</h2><div class="jy l"><h3 class="bd b fi z dy jw ea eb jx ed ef dx translated">在本文中，我们将在Openstack中部署一个虚拟机，然后使用Heat在其上安装docker和rancher</h3></div><div class="jz l"><p class="bd b fp z dy jw ea eb jx ed ef dx translated">blog.yassinemaachi.com</p></div></div></div></a></div><p id="5022" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您想使用openstack在家中部署私有云，请查看之前的文章:</p><div class="jo jp ez fb jq jr"><a href="https://yassinemaachi5.medium.com/how-to-create-a-personal-cloud-at-home-using-openstack-24061f991048" rel="noopener follow" target="_blank"><div class="js ab dw"><div class="jt ab ju cl cj jv"><h2 class="bd hj fi z dy jw ea eb jx ed ef hh bi translated">如何使用Openstack在家中创建个人云</h2><div class="jy l"><h3 class="bd b fi z dy jw ea eb jx ed ef dx translated">3台使用packstack的物理机</h3></div><div class="jz l"><p class="bd b fp z dy jw ea eb jx ed ef dx translated">yassinemaachi5.medium.com</p></div></div><div class="ka l"><div class="kb l kc kd ke ka kf io jr"/></div></div></a></div><p id="9725" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下面的模板来部署一个网络，其中路由器通过专用子网链接到带有Rancher的docker服务器实例。</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="b07d" class="kp kq hi kl b fi kr ks l kt ku">heat_template_version: 2015-04-30</span><span id="cbab" class="kp kq hi kl b fi kv ks l kt ku">description:  template to deploy a network with router linked to a docker server instance with Rancher.</span><span id="f247" class="kp kq hi kl b fi kv ks l kt ku">parameters:<br/>  public_net:<br/>    type: string<br/>    default: external_network<br/>    description: &gt;<br/>      ID or name of public network for which floating IP addresses will be allocated<br/>  dns_servers:<br/>    type: comma_delimited_list<br/>    default: 192.168.1.254,8.8.8.8,4.4.4.4<br/>    description: Comma separated list of DNS nameservers for the private network.<br/>  router_name:<br/>    type: string<br/>    default: dmz_router<br/>    description: Name of the router<br/>  dns_domain_name:<br/>    type: string<br/>    default: yassinemaachi.com<br/>    description: Name of the DNS Domain<br/>  private_net_name:<br/>    type: string<br/>    default: dmz-network<br/>    description: Name of private network to be created<br/>  private_subnet_name:<br/>    type: string<br/>    default: dmz-subnet<br/>    description: Name of private subnet to be created<br/>  private_net_cidr:<br/>    type: string<br/>    default: 172.16.10.0/24<br/>    description: Private network address (CIDR notation)<br/>  private_net_gateway:<br/>    type: string<br/>    default: 172.16.10.1<br/>    description: Private network gateway address<br/>  private_net_pool_start:<br/>    type: string<br/>    default: 172.16.10.100<br/>    description: Start of private network IP address allocation pool<br/>  private_net_pool_end:<br/>    type: string<br/>    default: 172.16.10.200<br/>    description: End of private network IP address allocation pool<br/>  key_name:<br/>    type: string<br/>    label: Key Name<br/>    default: rootATcompute01<br/>    description: Name of key-pair to be used for compute instance<br/>  image_name:<br/>    type: string<br/>    label: Image ID<br/>    default: CentOS-7-x86_64-GenericCloud<br/>    description: Image to be used for compute instance<br/>  docker_server_flavor_name:<br/>    type: string<br/>    default: m1.medium<br/>    description: Type of instance (flavor) to be used<br/>  docker_server_name:<br/>    type: string<br/>    default: docker-server<br/>    description: Name of the Instance.<br/>  docker_volume_size:<br/>    type: number<br/>    default: 50<br/>    description: Size of the Volume.<br/>  docker_volume_name:<br/>    type: string<br/>    default: docker_server_disk<br/>    description: Name of the Volume.<br/>  docker_secgroup:<br/>    type: string<br/>    default: docker-secgroup<br/>    description: Name of the docker server Security Group.<br/>  docker_private_ip:<br/>    type: string<br/>    default: 172.16.10.102<br/>    description: Fixed IP Address for docker server.<br/>  docker_floating_ip:<br/>    type: string<br/>    default: 192.168.1.124<br/>    description: IP address of the floating IP.</span><span id="96fe" class="kp kq hi kl b fi kv ks l kt ku">resources:</span><span id="e041" class="kp kq hi kl b fi kv ks l kt ku">  private_network:<br/>    type: OS::Neutron::Net<br/>    properties:<br/>      name: { get_param: private_net_name }</span><span id="a310" class="kp kq hi kl b fi kv ks l kt ku">  private_subnet:<br/>    type: OS::Neutron::Subnet<br/>    properties:<br/>      name: { get_param: private_subnet_name }<br/>      network_id: { get_resource: private_network }<br/>      cidr: { get_param: private_net_cidr }<br/>      gateway_ip: { get_param: private_net_gateway }<br/>      dns_nameservers: { get_param: dns_servers }<br/>      allocation_pools:<br/>        - start: { get_param: private_net_pool_start }<br/>          end: { get_param: private_net_pool_end }</span><span id="bfb4" class="kp kq hi kl b fi kv ks l kt ku">  router:<br/>    type: OS::Neutron::Router<br/>    properties:<br/>      name: { get_param: router_name }<br/>      external_gateway_info:<br/>        network: { get_param: public_net }<br/>        enable_snat: true</span><span id="4d9f" class="kp kq hi kl b fi kv ks l kt ku">  router_interface:<br/>    type: OS::Neutron::RouterInterface<br/>    properties:<br/>      router_id: { get_resource: router }<br/>      subnet_id: { get_resource: private_subnet }</span><span id="3f4f" class="kp kq hi kl b fi kv ks l kt ku">  docker_services_secgroup:<br/>    type: OS::Neutron::SecurityGroup<br/>    properties:<br/>      name:  { get_param: docker_secgroup }<br/>      description: SSH HTTP HTTPS<br/>      rules:<br/>        - protocol: tcp<br/>          remote_ip_prefix: 0.0.0.0/0<br/>          port_range_min: 22<br/>          port_range_max: 22<br/>        - protocol: tcp<br/>          remote_ip_prefix: 0.0.0.0/0<br/>          port_range_min: 80<br/>          port_range_max: 80<br/>        - protocol: tcp<br/>          remote_ip_prefix: 0.0.0.0/0<br/>          port_range_min: 443<br/>          port_range_max: 443</span><span id="7ab5" class="kp kq hi kl b fi kv ks l kt ku">  docker_server_port:<br/>    type: OS::Neutron::Port<br/>    properties:<br/>      network: { get_resource: private_network }<br/>      fixed_ips:<br/>        - ip_address: { get_param: docker_private_ip }<br/>      security_groups:<br/>      - { get_resource: docker_services_secgroup }</span><span id="9e82" class="kp kq hi kl b fi kv ks l kt ku">  docker_server_floating_ip:<br/>    type: OS::Neutron::FloatingIP<br/>    properties:<br/>      floating_network: { get_param: public_net }</span><span id="3ee5" class="kp kq hi kl b fi kv ks l kt ku">  docker_server_floating_asso:<br/>    type: OS::Neutron::FloatingIPAssociation<br/>    depends_on: docker_server_instance<br/>    properties:<br/>      floatingip_id: { get_resource: docker_server_floating_ip }<br/>      port_id: { get_resource: docker_server_port }</span><span id="07c5" class="kp kq hi kl b fi kv ks l kt ku">  docker_volume:<br/>    type: OS::Cinder::Volume<br/>    properties:<br/>      size: { get_param: docker_volume_size }<br/>      name: { get_param: docker_volume_name }</span><span id="053c" class="kp kq hi kl b fi kv ks l kt ku">  volume_attachment:<br/>    type: OS::Cinder::VolumeAttachment<br/>    properties:<br/>      volume_id: { get_resource: docker_volume }<br/>      instance_uuid: { get_resource: docker_server_instance }</span><span id="550e" class="kp kq hi kl b fi kv ks l kt ku">  docker_server_instance:<br/>    type: OS::Nova::Server<br/>    properties:<br/>      name: { get_param: docker_server_name }<br/>      key_name: { get_param: key_name }<br/>      image: { get_param: image_name }<br/>      flavor: { get_param: docker_server_flavor_name }<br/>      networks:<br/>      - port: { get_resource: docker_server_port }<br/>      user_data_format: SOFTWARE_CONFIG<br/>      user_data: {get_resource: docker_server_init}</span><span id="eb66" class="kp kq hi kl b fi kv ks l kt ku">  docker_server_init:<br/>    type: OS::Heat::MultipartMime<br/>    properties:<br/>      parts:<br/>      - config: {get_resource: install_docker}<br/>      - config: {get_resource: install_rancher}</span><span id="b31c" class="kp kq hi kl b fi kv ks l kt ku">  install_docker:<br/>      type: OS::Heat::SoftwareConfig<br/>      properties:<br/>        group: script<br/>        outputs:<br/>        - name: result<br/>        config: |<br/>          #!/bin/sh -x<br/>          sudo yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine<br/>          sudo yum install -y yum-utils<br/>          sudo yum-config-manager --add-repo <a class="ae kw" href="https://download.docker.com/linux/centos/docker-ce.repo" rel="noopener ugc nofollow" target="_blank">https://download.docker.com/linux/centos/docker-ce.repo</a><br/>          sudo yum -y install docker-ce docker-ce-cli containerd.io<br/>          sudo systemctl enable docker<br/>          sudo systemctl start docker<br/>          sudo  mkfs.ext4 /dev/vdb<br/>          sudo mount -o defaults /dev/vdb /data/<br/>          sudo echo '/dev/vdb /data ext4 defaults 0 0' &gt;&gt; /etc/fstab</span><span id="0e39" class="kp kq hi kl b fi kv ks l kt ku">  install_rancher:<br/>      type: OS::Heat::SoftwareConfig<br/>      properties:<br/>        group: script<br/>        outputs:<br/>        - name: result<br/>        config: |<br/>          #!/bin/sh -x<br/>          sudo mkdir -p /data/rancher-data<br/>          # Install Rancher on Openstack Instance<br/>          sudo docker run -d --restart=unless-stopped -v /data/rancher-data/:/var/lib/rancher --privileged --name=homelab-rancher -p 80:80 -p 443:443 rancher/rancher:v2.5.9-head</span><span id="3371" class="kp kq hi kl b fi kv ks l kt ku">outputs:<br/>  docker_server_name:<br/>    description: The hostname of the docker server instance<br/>    value:<br/>    - { get_attr: [ docker_server_instance, name ] }<br/>  docker_server_private_IP:<br/>    description: The private IP address of the docker server instance<br/>    value:<br/>    - { get_attr: [ docker_server_instance, first_address ] }<br/>  docker_server_public_IP:<br/>    description: The public IP address of the docker server instance<br/>    value:<br/>    - { get_attr: [ docker_server_floating_ip, floating_ip_address ] }<br/>  docker_site_addresse:<br/>    description: This is the url of the docker docker site.<br/>    value:<br/>      str_replace:<br/>        params:<br/>          site_ip: { get_attr: [ docker_server_floating_ip, floating_ip_address ] }<br/>        template: <a class="ae kw" href="http://site_ip" rel="noopener ugc nofollow" target="_blank">http://site_ip</a></span></pre><p id="25ea" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">连接到您的horizon dashboard，并转到流程编排部分下的堆栈页面:</p><figure class="kg kh ki kj fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kx"><img src="../Images/533a29e2274d04aa705b3c6aa3cbc114.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vRYVzOruqtq8EEfLl5lpjg.png"/></div></div></figure><p id="5dec" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">复制模板并点击午餐按钮运行新的堆栈。使用直接输入将代码粘贴到模板数据中:</p><figure class="kg kh ki kj fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ky"><img src="../Images/d9ebeface8a6d484073d18ca66909d8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2EP4x-doDUVeGu71NV49TQ.png"/></div></div></figure><p id="9ccf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后进入堆栈，等待终止，从堆栈输出中获取服务器的浮动ip:</p><figure class="kg kh ki kj fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kz"><img src="../Images/ff9bedf0123c3bf12e74a58bc2f34f3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FB52ywWrSW2tGa28yb6g5g.png"/></div></div></figure><p id="7991" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用此ip访问牧场主服务器:</p><figure class="kg kh ki kj fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es la"><img src="../Images/1709451bfced9c6ea7a96c376d6c86ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T7QvW5laPBzQJfHn3kFEWA.png"/></div></div></figure></div></div>    
</body>
</html>