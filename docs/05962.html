<html>
<head>
<title>When configuration becomes data</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">当配置变成数据时</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/when-configuration-becomes-data-9c8fd94ae4f2?source=collection_archive---------23-----------------------#2021-08-03">https://medium.com/geekculture/when-configuration-becomes-data-9c8fd94ae4f2?source=collection_archive---------23-----------------------#2021-08-03</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="98b9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">配置和数据实际上有什么区别？诚然，这是一个非常奇怪的话题，但我仍然经常被拉回到这个话题。</p><p id="aa7a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">而且，作为一个不断发展的公司中的一员，随着我们公司不断增加新的开发人员、用户和产品，这个问题似乎变得越来越重要。</p><p id="3aa5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在DevOps(以及软件工程)中，我们越来越多地使用<strong class="ih hj">基础设施作为代码</strong> ( <strong class="ih hj"> IaC </strong>)工具。Ansible、Puppet、Chef、Terraform、Kubernetes……允许您以声明方式<em class="jd"/>定义您的服务器和应用程序的工具列表在不断增长。</p><p id="c6ec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">文件格式因工具而异。有的用JSON，有的用YAML，有的不管什么原因自己做(hello <a class="ae je" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank"> Terraform </a>！).但总体来说都是<strong class="ih hj">配置文件</strong>。大多数工具，如Helm和Terraform，都内置了模板和某种级别的脚本来简化更大更复杂的配置。而且，随着我们的系统和公司的发展，这些配置变得越来越复杂，反过来产生了越来越复杂的a̶b̶o̶m̶i̶n̶a̶t̶i̶o̶n̶s̶工具来管理配置文件本身——比如<a class="ae je" href="https://jsonnet.org/" rel="noopener ugc nofollow" target="_blank"> JSONNET </a>。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es jf"><img src="../Images/fdb3c413d68410350b9946a5280843cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NYqQfmv0uweeauy4"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx">Photo by <a class="ae je" href="https://unsplash.com/@flowforfrank?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Ferenc Almasi</a> on <a class="ae je" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="b6a9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">配置管理，这个整个领域的总体名称，是一个有趣和令人兴奋的话题。只要你只是在学术上想一想。委婉地说，在实践中实现(更重要的是:维护)跨业务领域的基于覆盖的元配置<em class="jd"/>并不那么有趣。</p><p id="7a2c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是这篇文章不是关于配置管理的。或者说，是关于这样一个问题:<strong class="ih hj">配置在哪个点上就不再是配置，而简单地变成了枯燥的数据？</strong></p><h1 id="c337" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">配置和数据</h1><p id="071d" class="pw-post-body-paragraph if ig hi ih b ii kt ik il im ku io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">准确地说，配置只是数据的一个特定子集。因此，为了这篇文章的目的，让我们编造一些任意的定义:</p><ul class=""><li id="0a17" class="ky kz hi ih b ii ij im in iq la iu lb iy lc jc ld le lf lg bi translated">正如我们通常使用的术语，数据存储在数据库中，以编程方式访问，并且通常在系统运行时频繁更改。</li><li id="5124" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc ld le lf lg bi translated">另一方面，配置存储在上面提到的(人和机器可读的)文件格式中，被登记到您的<em class="jd"> git </em>存储库中，并且配置的改变通常需要代码审查、部署和/或重启。</li></ul><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es lm"><img src="../Images/bb410bda732dc67beed9baf211a827fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*bPyuG70R5v9EFdi3"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx">Photo by <a class="ae je" href="https://unsplash.com/@benjaminlehman?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">benjamin lehman</a> on <a class="ae je" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="671f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们(我说的“我们”是指所有与DevOps-y事物打交道的人)通常对配置和数据之间的差异有很好的直觉理解。</p><p id="efd1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">店铺上新买的</em>？很明显会进入数据库。<em class="jd">新AWS S3斗</em>？把它放到terraform配置文件中！</p><p id="a37e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是，随着我工作的公司规模的扩大，一些界限开始变得模糊。</p><h1 id="ba82" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">复杂性的增长？不，只是音量</h1><p id="df90" class="pw-post-body-paragraph if ig hi ih b ii kt ik il im ku io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">我们的每个开发人员都有他们自己的测试虚拟机，用来…嗯，可能是测试一些东西。可能是如何再次破坏我们的数据库——谁知道开发人员还做了什么。这些虚拟机是由IaC系统定义和管理的，因此要添加新的虚拟机，我们只需在配置文件中添加一个新条目。</p><p id="6b4e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">听起来很方便，对吧？当我们只有大约30名开发人员时，这很方便。十倍之多，行业典型的工程师波动，这种“简单”的解决方案导致越来越多的工作，因为每月有更多的人上车和下车。像所有的工程师一样，我们热爱自动化。因此，现在有了一个应用程序来代替这一手动步骤，它允许人们随时以自助方式创建新的虚拟机。</p><p id="a612" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">应用程序的工作方式非常简单:</strong>每当有人在票证中请求虚拟机时，应用程序会自动对我们的IaC配置报告进行更改，推送更改，CI部署新版本，从而创建新的虚拟机。</p><p id="71f4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是一个完全合理的解决方案，完全符合它的要求。它甚至重用CI管道等现有结构来部署新的基础设施。然而，我想得越久，就越觉得T2完全错了。</p><p id="d47d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在30名开发人员的参与下，我们认为每个测试虚拟机都是一个独立的实体，其中的变更<em class="jd">应该</em>经历JIRA问题、合并请求、代码审查和部署的重要过程。对于300名开发人员，我们很少关心新的测试虚拟机，甚至没有跟踪创建了多少个。至少在首席财务官红着脸、高声说话、拿着我们最新的AWS账单出现之前，我们至少再次开始跟踪虚拟机的数量。</p><h1 id="7e2e" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">当配置变成数据时，这很痛苦</h1><p id="475c" class="pw-post-body-paragraph if ig hi ih b ii kt ik il im ku io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">因此，我们在这里学到的经验是:在某个时候，当您的下一个sprint中的虚拟机数量超过故事点时，它们的管理不再是配置，而是数据。Kubernetes爱好者可能会说这是牛，而不是宠物。数据可能随时快速变化，无需JIRA问题、审查或更多的努力，只需点击一个按钮。数据不再属于一个配置文件，而应该存在于它的祖先——一个数据库中。</p><p id="38bc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过编写一个通过CI自动更新我们的Terraform设置的应用程序，我们实际上犯了软件工程的最大错误:<strong class="ih hj">我们使用文件作为数据库</strong>。上面几段我开了开发者搞砸数据库的玩笑，但是现在这个玩笑开到了我身上。我开始质疑一些长期以来的信念。也许那些财务人员是对的，Excel实际上是一个可以接受的数据库？也许SAP真的是软件开发的巅峰？</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es ln"><img src="../Images/baccde480cd46008f5f975e3a40096cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*HD08okhX2huyd9M9"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx">Photo by <a class="ae je" href="https://unsplash.com/@anthonytran?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Anthony Tran</a> on <a class="ae je" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="7b00" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">但是我不能离开光明太远。让我们将整个团队的注意力集中在如何改进虚拟机配置应用程序上。我们还能挽救它。如果用户请求一个新的虚拟机，我们将向数据库中写入一个条目。我们重新建模我们的应用程序，将数据库中的状态与现有虚拟机进行比较，并根据需要创建或删除它们。听起来有点类似于<a class="ae je" href="https://kubernetes.io/docs/concepts/overview/components/" rel="noopener ugc nofollow" target="_blank"> Kubernetes已经在用etcd </a>做的事情，但它可能有足够的不同来保证它的存在。我们甚至可以为您的用户构建一个更好的自我服务的web UI，让他们只需点击一下鼠标就可以配置一台机器！然后… <em class="jd">哦，该死的，我们又回到了IaC之前的地方。</em></em></p><h1 id="0949" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">在SE和SM中，界限非常重要</h1><p id="acb6" class="pw-post-body-paragraph if ig hi ih b ii kt ik il im ku io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">也许，仅仅是也许，没有一种管理应用程序和系统的方法在所有规模上都是“正确”的。</p><p id="3552" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">也许，尽管我不愿意承认，IaC和色彩丰富的<em class="jd">点击按钮做事</em>工具在现代科技公司中都有它们的位置。</p><p id="fe4a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">也许在配置成为数据的地方会有一个断点，在这个断点之后，我们缺乏对配置的严格控制就不如为用户提供简单的<strong class="ih hj">自助服务UX</strong>重要了。</p><p id="f862" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">也许我们只需要找出<strong class="ih hj">断点</strong>在哪里，这样我们就可以决定如何实现今天和明天的最佳解决方案。</p><p id="a7fa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">作为一名开发人员，我喜欢清晰的需求，就像喜欢自动化一样。因此，我花了太多的时间，试图定义精确的规则，让我能够从算法上决定一个实体应该被视为配置还是数据。所有这些努力，最终只得到一堆混乱的笔记，几乎不能称之为指南。他们在这里:</p><ul class=""><li id="2ad9" class="ky kz hi ih b ii ij im in iq la iu lb iy lc jc ld le lf lg bi translated">如果在同一个环境中有超过<strong class="ih hj"> 14 </strong>(现在指的是一个<a class="ae je" href="https://en.wikipedia.org/wiki/Baker%27s_dozen_(disambiguation)" rel="noopener ugc nofollow" target="_blank"> DevOps的十几个</a>)实际上相等的实体，那很可能就是数据</li><li id="ab6f" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc ld le lf lg bi translated">如果你能告诉你的首席技术官“老实说，我不知道有多少实体，可能很多”，而不惹恼他们，这可能就是数据</li><li id="031f" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc ld le lf lg bi translated">如果实体平均一个月创建/删除一次或者更频繁，那么它可能就是数据</li><li id="4f6e" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc ld le lf lg bi translated">如果只有一个人(或大公司中的一个团队)会注意或关心一个实体是否会突然消失一段时间，这可能就是数据</li><li id="f0dc" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc ld le lf lg bi translated">如果一个实体的变化，即使在最坏的情况下，也只会给你的公司带来和你的会议预算一样多的<strong class="ih hj">金钱损失</strong>，那么它可能就是数据</li><li id="0ce4" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc ld le lf lg bi translated">如果一个实体不仅仅是总体架构的一个子组件，而是实际上定义了架构的一个<strong class="ih hj">核心部分</strong>，<em class="jd">，那么它可能不是数据</em></li></ul><p id="ade4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">写出这些规则让我意识到我们当前存储在配置文件中的东西有多少<em class="jd">不属于那里</em>。我们在任何地方都使用<a class="ae je" href="https://www.vaultproject.io/" rel="noopener ugc nofollow" target="_blank"> Vault </a>来获取秘密，并且它很好地集成到了我们的IaC工作流中。也许使用Vault或类似的不关注秘密的东西来存储已经从配置提升到数据的东西可能是一个好主意🤔</p></div></div>    
</body>
</html>