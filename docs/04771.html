<html>
<head>
<title/>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1/>
<blockquote>原文：<a href="https://medium.com/geekculture/consuming-graphql-apis-in-ruby-without-additional-libraries-19e94ccafbbd?source=collection_archive---------10-----------------------#2021-07-03">https://medium.com/geekculture/consuming-graphql-apis-in-ruby-without-additional-libraries-19e94ccafbbd?source=collection_archive---------10-----------------------#2021-07-03</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><h2 id="8f65" class="hg hh hi bd hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie bi translated">在Ruby中使用GraphQL APIs，无需额外的库</h2><figure class="ig ih ii ij fd ik er es paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="er es if"><img src="../Images/24684cf4bb1a6e1397f6a2a9faae1dca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cHtWlWQQumnoQfzFOMXmrA.png"/></div></div></figure><p id="db8c" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb hs jc jd je hw jf jg jh ia ji jj jk jl hb bi translated">使用GraphQL，您可以查询单个端点，并准确地获得您需要的数据。不多不少。听起来不错吧？越来越好了！如果您目前使用的是常规的ol REST API，而他们恰好也有可用的GraphQL API，那么您可以大大减少请求的数据量，并提高应用程序的速度。我敢肯定，较低的数据使用量也将是一个受欢迎的变化，尤其是如果你正在为移动开发。</p><figure class="ig ih ii ij fd ik er es paragraph-image"><div class="er es jm"><img src="../Images/3f769cd9211e7e75ee879733d2c83029.png" data-original-src="https://miro.medium.com/v2/resize:fit:996/1*ttg9ZoWbDPCV74ESDvmOHw.gif"/></div></figure><p id="73d7" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb hs jc jd je hw jf jg jh ia ji jj jk jl hb bi translated">在我目前的项目中，我大量使用Yelp API。嗯，原来Yelp也提供了一个GraphQL API。在做了一些研究并看到使用GraphQL的好处后，我决定对我的项目做一点重构。我的目标是利用Yelp GraphQL API，并只返回我需要的信息，以实现更快、数据更少的应用程序。我想尽可能简单地完成这项工作，而不使用像<a class="ae jn" href="https://github.com/github/graphql-client" rel="noopener ugc nofollow" target="_blank"> graphql-client </a>这样的库。</p><p id="e81b" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb hs jc jd je hw jf jg jh ia ji jj jk jl hb bi translated"><strong class="it jo">让我们开始吧！</strong></p><p id="8e76" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb hs jc jd je hw jf jg jh ia ji jj jk jl hb bi translated">在我的应用程序中，我在Yelp API搜索端点上查询用户位置附近的餐馆。下面是一家餐馆的回应👇</p><pre class="ig ih ii ij fd jp jq jr js aw jt bi"><span id="6b33" class="hg hh hi jq b fi ju jv l jw jx">{"id"=&gt;"5XGfUuqGZXud1sHAhitOEA",<br/>    "alias"=&gt;"ellijay-coffeehouse-ellijay-3",<br/>    "name"=&gt;"Ellijay Coffeehouse",<br/>    "image_url"=&gt;"<a class="ae jn" href="https://s3-media4.fl.yelpcdn.com/bphoto/SLHqFW1C9abqp5gJNepnzQ/o.jpg" rel="noopener ugc nofollow" target="_blank">https://s3- media4.fl.yelpcdn.com/bphoto/SLHqFW1C9abqp5gJNepnzQ/o.jpg</a>",<br/>    "is_closed"=&gt;false,<br/>    "url"=&gt;"<a class="ae jn" href="https://www.yelp.com/biz/ellijay-coffeehouse-ellijay-3?adjust_creative=rkr10mVcIwdrPCTR1lAhwA&amp;utm_campaign=yelp_api_v3&amp;utm_medium=api_v3_business_search&amp;utm_source=rkr10mVcIwdrPCTR1lAhwA" rel="noopener ugc nofollow" target="_blank">https://www.yelp.com/biz/ellijay-coffeehouse-ellijay-3?adjust_creative=rkr10mVcIwdrPCTR1lAhwA&amp;utm_campaign=yelp_api_v3&amp;utm_medium=api_v3_business_search&amp;utm_source=rkr10mVcIwdrPCTR1lAhwA</a>",<br/>    "review_count"=&gt;137,<br/>    "categories"=&gt;<br/>     [{"alias"=&gt;"coffee", "title"=&gt;"Coffee &amp; Tea"},<br/>      {"alias"=&gt;"breakfast_brunch", "title"=&gt;"Breakfast &amp; Brunch"},<br/>      {"alias"=&gt;"juicebars", "title"=&gt;"Juice Bars &amp; Smoothies"}],<br/>    "rating"=&gt;4.5,<br/>    "coordinates"=&gt;{"latitude"=&gt;34.6961891549605, "longitude"=&gt;-84.4807845952454},<br/>    "transactions"=&gt;[],<br/>    "price"=&gt;"$$",<br/>    "location"=&gt;<br/>     {"address1"=&gt;"131 N Main St",<br/>      "address2"=&gt;"",<br/>      "address3"=&gt;"",<br/>      "city"=&gt;"Ellijay",<br/>      "zip_code"=&gt;"30540",<br/>      "country"=&gt;"US",<br/>      "state"=&gt;"GA",<br/>      "display_address"=&gt;["131 N Main St", "Ellijay, GA 30540"]},<br/>    "phone"=&gt;"+17066355565",<br/>    "display_phone"=&gt;"(706) 635-5565",<br/>    "distance"=&gt;2036.765952031534}<br/>}</span></pre><p id="12a5" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb hs jc jd je hw jf jg jh ia ji jj jk jl hb bi translated">很多有用的信息，但我并不真的需要所有这些信息。</p><figure class="ig ih ii ij fd ik er es paragraph-image"><div class="er es jy"><img src="../Images/7924c64df54a4480097e8cdae67a85af.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/1*6TG3c0-mhvk-ki2mXlRfkg.gif"/></div></figure><p id="1079" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb hs jc jd je hw jf jg jh ia ji jj jk jl hb bi translated">让我们来看看GraphQL。GraphQL查询如下所示。</p><pre class="ig ih ii ij fd jp jq jr js aw jt bi"><span id="6e8a" class="hg hh hi jq b fi ju jv l jw jx">{<br/>  search(location: "san francisco", limit: 1) {<br/>    business {<br/>      name<br/>    }<br/>  }<br/>}</span></pre><p id="1175" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb hs jc jd je hw jf jg jh ia ji jj jk jl hb bi translated">这个查询的响应…</p><pre class="ig ih ii ij fd jp jq jr js aw jt bi"><span id="506f" class="hg hh hi jq b fi ju jv l jw jx">{<br/>  "data": {<br/>    "search": {<br/>      "business": [<br/>        {<br/>          "name": "Bi-Rite Creamery"<br/>        }<br/>      ]<br/>    }<br/>  }<br/>}</span></pre><p id="a176" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb hs jc jd je hw jf jg jh ia ji jj jk jl hb bi translated">使用GraphQL，我们可以像使用REST API一样访问所有相同的信息，但是我们在查询中指定我们想要返回的内容，这正是我们得到的内容。在本例中，我们只是返回旧金山的一家企业的名称。如果你想得到50个甚至100个商家的名字怎么办？通过使用GraphQL并只返回名称，而不是整个业务对象，您消耗的数据明显更少！</p><p id="b121" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb hs jc jd je hw jf jg jh ia ji jj jk jl hb bi translated">那么，我们如何重构应用程序来进行GraphQL查询，而不是访问REST端点并返回那些巨大的餐馆对象呢？让我们看看应用程序的当前状态。</p><figure class="ig ih ii ij fd ik er es paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="er es jz"><img src="../Images/8dbd4de0668e007375849bbd07cbb33d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wOnLTC14-5NcDGj9cibqgQ.png"/></div></div></figure><p id="db9d" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb hs jc jd je hw jf jg jh ia ji jj jk jl hb bi translated"><strong class="it jo">注意:</strong>我使用<a class="ae jn" href="https://github.com/jnunemaker/httparty" rel="noopener ugc nofollow" target="_blank">http gem</a>来进行API调用。如果可能的话，我想用GraphQL来维护这个功能。</p><p id="f45b" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb hs jc jd je hw jf jg jh ia ji jj jk jl hb bi translated">好吧，那我们先来解决<code class="du ka kb kc jq b">location_restaurants</code>吧。GraphQL只使用一个端点，所以我想我们首先应该做的是改变<code class="du ka kb kc jq b">@search_url</code>。让我们把它变成一个类变量，因为从现在开始，我们将对所有的查询使用同一个端点。让我们也记下我们正在寻找的基于<code class="du ka kb kc jq b">@search_url</code>的信息。看起来我们希望该位置是用户的位置，类别应该是“餐馆”，限制是20，我们想按“最佳匹配”排序。我们将使用这些信息来构建我们的GraphQL查询。</p><figure class="ig ih ii ij fd ik er es paragraph-image"><div class="er es kd"><img src="../Images/e2f04797462a3f1cd9eb49dbdde9b941.png" data-original-src="https://miro.medium.com/v2/resize:fit:1020/format:webp/1*rAIF3NPxTlyFRE3zjNlBSQ.png"/></div></figure><p id="ff12" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb hs jc jd je hw jf jg jh ia ji jj jk jl hb bi translated">现在，让我们在标题中添加一个大陆类型，以确保API理解我们发送的是什么类型的信息。让我们继续移动方法内部的头，同时留下我们的<code class="du ka kb kc jq b">@@headers</code>类变量，这样我们就不会中断我们的API调用。当我们将其余的方法重构为使用GraphQL时，我们可以将头抽象回一个类变量。</p><figure class="ig ih ii ij fd ik er es paragraph-image"><div class="er es ke"><img src="../Images/7d6e220f7618bc6ebb2304e0fd10c35b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1056/format:webp/1*CdN5ew4tsRX5Q0CYsaVvuQ.png"/></div></figure><p id="eb37" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb hs jc jd je hw jf jg jh ia ji jj jk jl hb bi translated">现在，使用GraphQL，我们使用POST请求而不是GET请求，并且我们需要在请求体中声明查询。因此，让我们改变请求类型，决定我们需要什么信息并构建主体。</p><figure class="ig ih ii ij fd ik er es paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="er es kf"><img src="../Images/4ea62bc0319b01eab674c71f75e93dd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lN0D5SVyrTqjpx4DDMfvXw.png"/></div></div></figure><p id="7425" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb hs jc jd je hw jf jg jh ia ji jj jk jl hb bi translated">好的，所以我认为这里是使用<a class="ae jn" href="https://www.rubyguides.com/2018/11/ruby-heredoc/" rel="noopener ugc nofollow" target="_blank"> heredoc </a>的好地方。这样我们保留了格式，我们可以使用字符串插值来传递位置。从我们之前做的笔记中，我们知道我们的位置、类别、限制和sort_by将会是什么样子，并且基于我们在应用程序中使用的信息，看起来我们想要获取id、名称、价格、评级、地址、类别、电话号码、yelp url和评论计数。我们还想知道餐馆目前是否已经关门。</p><p id="2b3a" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb hs jc jd je hw jf jg jh ia ji jj jk jl hb bi translated"><strong class="it jo">注意:</strong>我们可以在<a class="ae jn" href="https://www.yelp.com/developers/graphql/objects/businesses" rel="noopener ugc nofollow" target="_blank"> Yelps GraphQL docs </a>中构建一个测试查询。然后，我们只需将工作查询复制并粘贴到heredoc中。</p><figure class="ig ih ii ij fd ik er es paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="er es kg"><img src="../Images/1382fb1babee1a1131d251ec236fd80f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C9n7UyKlVI4qkDc2iK8leQ.png"/></div></div></figure><p id="cc7a" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb hs jc jd je hw jf jg jh ia ji jj jk jl hb bi translated">有用！</p><p id="f1a8" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb hs jc jd je hw jf jg jh ia ji jj jk jl hb bi translated">我们现在正在查询Yelp GraphQL API，并准确地获得我们需要的信息！我们将在<code class="du ka kb kc jq b">katchup_restaurants</code>方法中做一个非常相似的查询，所以让我们稍微清理一下，使我们的查询可重用。我们将取出在其他方法中需要的块，并将其抽象成一个类变量。我们将使用另一个heredoc来维护格式。</p><figure class="ig ih ii ij fd ik er es paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="er es kh"><img src="../Images/ef8ee0a5939bba214c139f21ebd5dd00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wH6sjvpS8ru4h3r8tWr2mQ.png"/></div></div></figure><p id="d8a7" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb hs jc jd je hw jf jg jh ia ji jj jk jl hb bi translated">好多了！由于<code class="du ka kb kc jq b">single</code>正在获取一组不同的信息，并且稍后将被重构，我们将暂时不处理<code class="du ka kb kc jq b">@@headers</code>。</p><p id="9596" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb hs jc jd je hw jf jg jh ia ji jj jk jl hb bi translated">因此，在没有任何库的情况下，我们能够在Ruby中使用GraphQl API。我们现在得到的正是我们需要的信息。不多不少。我希望这篇文章内容丰富，并为您重构自己的API调用提供了一个良好的起点。开心快乐编码！</p></div></div>    
</body>
</html>