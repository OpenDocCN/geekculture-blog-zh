<html>
<head>
<title>JAMStack deployment with Azure DevOps Pipeline</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Azure DevOps管道进行JAMStack部署</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/jamstack-deployment-with-azure-devops-pipeline-cfaf5bb89fd?source=collection_archive---------21-----------------------#2021-07-19">https://medium.com/geekculture/jamstack-deployment-with-azure-devops-pipeline-cfaf5bb89fd?source=collection_archive---------21-----------------------#2021-07-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="7824" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">为Node.js应用程序到web托管服务的静态导出设置CI\CD管道。</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/6eb6b29985d16a17a888f8e6bd9a7683.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oiLsIstQNR0AapC926Y3BQ.jpeg"/></div></div></figure><p id="8503" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我经常为有自己服务器的客户做一些自由职业。这些服务器通常是你没有根权限的虚拟主机解决方案。只是Apache或Nginx运行并指向特定的文件夹，并提供PHP文件。经常有足够多的客户在Wordpress上运行网站。</p><p id="da29" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">在服务器中没有Node.js限制了web开发人员的能力，而现在我们中的很大一部分人都使用Node.js应用程序。我也是，我经常用JavaScript框架构建独立的前端应用程序，同时让一个无头CMS为站点提供内容。有了这个，我可以经常进行Jamstack构建。</p><p id="09f6" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">由于Jamstack要求每次内容改变时都要重新构建网站，所以我需要Node.js在服务器上运行。这是不可能的，所以我必须找到一种替代方法来构建前端应用程序，远离服务器。好消息是我可以访问<a class="ae kf" href="https://azure.microsoft.com/en-us/" rel="noopener ugc nofollow" target="_blank"> Azure </a>，这意味着我可以使用它的<a class="ae kf" href="https://azure.microsoft.com/en-us/services/devops/" rel="noopener ugc nofollow" target="_blank"> DevOps管道</a>，让它为我构建应用程序，并将静态输出部署到<a class="ae kf" href="https://azure.microsoft.com/en-us/services/storage/blobs/" rel="noopener ugc nofollow" target="_blank"> Blob存储</a>，然后将事件发送回服务器。然后，服务器会为我获取构建的网站，并提取它进行托管。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es kg"><img src="../Images/e8fb663fbfec8215d5b86f2e55ff60b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A5FkSPNHUk9HWd-ulzmxCA.png"/></div></div><figcaption class="kh ki et er es kj kk bd b be z dx">The full pipeline</figcaption></figure><p id="65be" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">问题是，我不确定是否能让来自Wordpress或Strapi等平台的外部事件触发构建。幸运的是，它可以，但是让我带你走一遍这个过程。</p><h1 id="8497" class="kl km hi bd kn ko kp kq kr ks kt ku kv io kw ip kx ir ky is kz iu la iv lb lc bi translated">要求</h1><p id="ab71" class="pw-post-body-paragraph jj jk hi jl b jm ld ij jo jp le im jr js lf ju jv jw lg jy jz ka lh kc kd ke hb bi translated">我会向你介绍我做了什么，并提供我阅读的资源(文件)的链接，以完成所有事情。我使用<a class="ae kf" href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli" rel="noopener ugc nofollow" target="_blank"> Azure CLI </a>来创建资源，因为对于本教程来说，它比提供门户截图要快得多，也更干净。</p><p id="d1ac" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">Azure提供了很多关于他们服务的文档，但是以我的经验来看，微软有一个习惯，就是到处乱放东西，所以你必须知道去哪里找。</p><p id="9fab" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">您需要以下东西来构建这个管道:</p><ul class=""><li id="c020" class="li lj hi jl b jm jn jp jq js lk jw ll ka lm ke ln lo lp lq bi translated">Azure订阅</li><li id="793d" class="li lj hi jl b jm lr jp ls js lt jw lu ka lv ke ln lo lp lq bi translated">一个代码库，可以与Azure DevOps集成</li><li id="a5e0" class="li lj hi jl b jm lr jp ls js lt jw lu ka lv ke ln lo lp lq bi translated">Azure DevOps组织</li><li id="4288" class="li lj hi jl b jm lr jp ls js lt jw lu ka lv ke ln lo lp lq bi translated"><a class="ae kf" href="https://docs.microsoft.com/en-us/azure/event-grid/custom-event-quickstart-portal#enable-event-grid-resource-provider" rel="noopener ugc nofollow" target="_blank">启用事件网格资源提供者</a></li><li id="21a1" class="li lj hi jl b jm lr jp ls js lt jw lu ka lv ke ln lo lp lq bi translated">存储帐户和容器</li><li id="b2f2" class="li lj hi jl b jm lr jp ls js lt jw lu ka lv ke ln lo lp lq bi translated">具有端点的API可以验证事件订阅，然后在Blob存储中创建Blob时接收事件。当Azure第一次调用端点时，我会让你参考这个<a class="ae kf" href="https://docs.microsoft.com/en-us/azure/event-grid/receive-events#endpoint-validation" rel="noopener ugc nofollow" target="_blank">如何自动验证你的订阅的指南</a>。</li></ul><p id="d8b9" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我假设您可以自己设置前四个，也是最后一个，让我们简单地看看如何设置存储帐户和管道。</p><h1 id="8cb6" class="kl km hi bd kn ko kp kq kr ks kt ku kv io kw ip kx ir ky is kz iu la iv lb lc bi translated">设置存储帐户</h1><p id="5867" class="pw-post-body-paragraph jj jk hi jl b jm ld ij jo jp le im jr js lf ju jv jw lg jy jz ka lh kc kd ke hb bi translated">我们需要建立一个存储帐户和一个容器来保存我们最终的构建。</p><ol class=""><li id="8eb0" class="li lj hi jl b jm jn jp jq js lk jw ll ka lm ke lw lo lp lq bi translated">使用Azure CLI创建存储帐户。</li></ol><pre class="iy iz ja jb fd lx ly lz ma aw mb bi"><span id="a40b" class="mc km hi ly b fi md me l mf mg">az storage account create --name &lt;storage-account-name&gt; --resource-group &lt;resource-group-name&gt;</span></pre><p id="6b75" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">您必须为您的存储帐户以及资源组创建一个唯一的名称。</p><p id="c18c" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">在CLI中从响应json中获取<code class="du mh mi mj ly b">id</code>属性值(全限定标识符),类似于<code class="du mh mi mj ly b">/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Storage/storageAccounts/{storageAccountName}</code></p><p id="c36f" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">2.<strong class="jl hj">创建一个容器</strong></p><pre class="iy iz ja jb fd lx ly lz ma aw mb bi"><span id="1fdc" class="mc km hi ly b fi md me l mf mg">az storage container create --name deployment --account-name &lt;storage-account-name&gt; --public-access blob</span></pre><p id="06d8" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">如果你希望更严格的安全措施，请考虑放下<code class="du mh mi mj ly b">--public-access</code>旗，走私人路线。</p><p id="ec23" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">3.<strong class="jl hj">创建事件订阅</strong></p><p id="dc47" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">在创建事件订阅之前，确保您的API端点能够订阅接收事件。</p><p id="1267" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">现在使用来自存储容器创建响应的<code class="du mh mi mj ly b">id</code>来创建事件订阅。</p><pre class="iy iz ja jb fd lx ly lz ma aw mb bi"><span id="9c4c" class="mc km hi ly b fi md me l mf mg">az eventgrid event-subscription create --source-resource-id &lt;storage-account-fully-qualified-identifier&gt; --name nodeAppDeployment --endpoint &lt;your-api-endpoint&gt; --included-event-types Microsoft.Storage.BlobCreated Microsoft.Storage.BlobCreate</span></pre><p id="1c6a" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">现在，每当一个文件被添加到容器中时，您的API应该接收一个包含文件URL和其他信息的事件有效负载。</p><h1 id="78ff" class="kl km hi bd kn ko kp kq kr ks kt ku kv io kw ip kx ir ky is kz iu la iv lb lc bi translated">DevOps</h1><p id="8610" class="pw-post-body-paragraph jj jk hi jl b jm ld ij jo jp le im jr js lf ju jv jw lg jy jz ka lh kc kd ke hb bi translated">在我们开始设置管道之前，我们首先必须访问DevOps门户中的<strong class="jl hj">项目设置</strong>，并设置一个<strong class="jl hj">服务连接</strong>(在管道部分下面。)创建一个新的服务连接，并添加<strong class="jl hj"> Incoming WebHook </strong>作为连接类型。添加WebHook名称和服务连接名称。复制这两个名称，因为我们需要在管道配置中使用它们。</p><p id="4dc7" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">完成后，我们可以创建一个管道。只需在<strong class="jl hj">管道</strong>仪表板上点击<strong class="jl hj">新管道</strong>，并添加您的存储库设置。选择一个基本的<strong class="jl hj"> Node.js </strong>类型任务，进入管道YAML配置页面后，将以下内容复制到那里:</p><pre class="iy iz ja jb fd lx ly lz ma aw mb bi"><span id="5a8c" class="mc km hi ly b fi md me l mf mg"># Use our Service Connection WebHook (change)<br/>resources:<br/>  webhooks:<br/>    - webhook: &lt;webhook-name&gt;<br/>      connection: &lt;service-connection-name&gt;<br/><br/># CI trigger<br/>trigger:<br/>- master<br/><br/>pool:<br/>  vmImage: ubuntu-latest<br/><br/>steps:<br/># Install Node.js<br/>- task: NodeTool@0<br/>  inputs:<br/>    versionSpec: '14.x'<br/>  displayName: 'Install Node.js'<br/><br/># Install packages and run build command<br/>- script: |<br/>    npm install<br/>    npm run build<br/>  displayName: 'npm install and build'<br/><br/># Archive the /out folder<br/>- task: ArchiveFiles@2<br/>  inputs:<br/>    rootFolderOrFile: '$(System.DefaultWorkingDirectory)/out'<br/>    includeRootFolder: false<br/>    archiveType: 'zip'<br/>    archiveFile: '$(Build.ArtifactStagingDirectory)/release.zip'<br/>    replaceExistingArchive: true<br/><br/># Upload the output zip to blob storage<br/>- task: AzureCLI@2<br/>  inputs:<br/>    azureSubscription: &lt;azure-subscription&gt;<br/>    scriptType: 'bash'<br/>    scriptLocation: 'inlineScript'<br/>    inlineScript: 'az storage blob upload --account-name &lt;storage-account-name&gt; -c &lt;container-name&gt; -f $(Build.ArtifactStagingDirectory)/release.zip -n release.zip'</span></pre><p id="de0b" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">YAML配置文件是注释的，但是让我在这里指出一些事情。</p><ul class=""><li id="814e" class="li lj hi jl b jm jn jp jq js lk jw ll ka lm ke ln lo lp lq bi translated">首先<strong class="jl hj">你需要在配置文件中设置你的webhook名和连接名</strong>。那是文件中最上面的块。</li><li id="85e7" class="li lj hi jl b jm lr jp ls js lt jw lu ka lv ke ln lo lp lq bi translated">这个例子中正在构建的应用是一个Next.js框架应用，所以<code class="du mh mi mj ly b">npm run build</code>执行<code class="du mh mi mj ly b">next build &amp;&amp; next export</code>，这就是为什么输出文件夹是<code class="du mh mi mj ly b">out</code>。您很可能需要调整此配置，因此将/out路径更改为输出文件夹所在的位置。</li><li id="af68" class="li lj hi jl b jm lr jp ls js lt jw lu ka lv ke ln lo lp lq bi translated">您需要授权DevOps使用您的Azure订阅，以便您可以在上传任务中使用它。您需要在<code class="du mh mi mj ly b">azureSubscription</code>字段中输入您的订阅名称。为了得到你的<code class="du mh mi mj ly b">azureSubscription</code>信息，你可以做我所做的，我只是抓取一个类似<code class="du mh mi mj ly b">Azure file copy</code>的任务，通过UI输入配置，并插入配置文件。从那里我得到了YAML文件的正确名称和ID。<em class="mk">(由于这是一个linux代理，我们必须使用Azure CLI来上传文件。</em> <code class="du mh mi mj ly b"><em class="mk">Azure file copy</em></code> <em class="mk">仅适用于PowerShell ie。Windows代理。)</em></li><li id="4729" class="li lj hi jl b jm lr jp ls js lt jw lu ka lv ke ln lo lp lq bi translated">这里我没有考虑任何环境变量。你将不得不自己处理这些。</li><li id="3821" class="li lj hi jl b jm lr jp ls js lt jw lu ka lv ke ln lo lp lq bi translated">记得填写存储名称和容器名称。</li></ul><h1 id="51df" class="kl km hi bd kn ko kp kq kr ks kt ku kv io kw ip kx ir ky is kz iu la iv lb lc bi translated">从外部服务触发管道</h1><p id="82c0" class="pw-post-body-paragraph jj jk hi jl b jm ld ij jo jp le im jr js lf ju jv jw lg jy jz ka lh kc kd ke hb bi translated">这很简单。您只需向以下URL发出发布请求:</p><pre class="iy iz ja jb fd lx ly lz ma aw mb bi"><span id="3da5" class="mc km hi ly b fi md me l mf mg">https://dev.azure.com/&lt;organization-name&gt;/_apis/public/distributedtask/webhooks/&lt;webhook-name&gt;?api-version=6.0-preview</span></pre><p id="2093" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><code class="du mh mi mj ly b">organization-name </code>是您的DevOps组织名称。这里的问题是，无论是谁发现了这个URL，都会对您造成伤害，并可能通过ping这个URL使您的管道持续运行。这就是为什么您可以在之前设置的服务连接中设置一个<strong class="jl hj"> Secret </strong>和一个<strong class="jl hj"> HTTP Header </strong>(您可能看到了这些字段)。</p><p id="c1ae" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">您可以为发送到此webhook地址的有效负载生成HMAC SHA1校验和(不确定是否支持其他消息摘要算法)，并将该校验和添加到指定的报头中。这个秘密当然是生成校验和的关键。</p><p id="cf6d" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">Azure将比较校验和，并阻止任何有效负载为空或校验和不匹配的请求。</p><h1 id="5a98" class="kl km hi bd kn ko kp kq kr ks kt ku kv io kw ip kx ir ky is kz iu la iv lb lc bi translated">包扎</h1><p id="f9b5" class="pw-post-body-paragraph jj jk hi jl b jm ld ij jo jp le im jr js lf ju jv jw lg jy jz ka lh kc kd ke hb bi translated">本教程没有告诉您如何处理API中的存档输出文件。你得自己想办法解决。我所做的只是从存储中复制文件(由BlobCreated事件有效负载提供的url)并将其提取到Apache托管的文件夹中。</p><p id="5712" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">和往常一样，除了Azure和任何类型的管道，还有其他替代方案。你可以使用像<a class="ae kf" href="https://vercel.com/" rel="noopener ugc nofollow" target="_blank"> Vercel </a>或<a class="ae kf" href="https://www.netlify.com/" rel="noopener ugc nofollow" target="_blank"> Netlify </a>这样的服务来部署和托管你的前端应用，并且你可以跳过构建任何管道。我相信它们都包含某种类型的webhook触发机制来启动重建。你也可以在Azure Storage中托管静态网站，并为其设置CDN。这可能比一些非基于云的虚拟机更便宜，并且更具可扩展性。</p><p id="f5f6" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">这种特殊方法的优点是，您不必在服务器上运行Git或Node.js来获取最新的代码更改或构建应用程序。您可以在一个隔离的容器中获取repo和安装包。如果作业失败，不会影响生产中的网站。</p><p id="9a9f" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">您也可以在同一管道中运行您的测试，以确保您没有破坏任何东西。使用TypeScript可以让您对编译更有信心。</p><h1 id="02e6" class="kl km hi bd kn ko kp kq kr ks kt ku kv io kw ip kx ir ky is kz iu la iv lb lc bi translated">资源</h1><p id="bbe9" class="pw-post-body-paragraph jj jk hi jl b jm ld ij jo jp le im jr js lf ju jv jw lg jy jz ka lh kc kd ke hb bi translated">下面是一些资源，帮助我找出需要什么。我最近一直在玩Azure DevOps，所以那次经历帮助我在一个小时内完成了这件事。</p><p id="8c9d" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">正在安装Azure CLI:<br/>T5】https://docs . Microsoft . com/en-us/CLI/Azure/install-Azure-CLI</p><p id="4b84" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">詹斯塔克:<br/><a class="ae kf" href="https://jamstack.org/" rel="noopener ugc nofollow" target="_blank">https://jamstack.org/</a></p><p id="7625" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">Azure CLI — az存储帐户:<br/><a class="ae kf" href="https://docs.microsoft.com/en-us/cli/azure/storage/account?view=azure-cli-latest" rel="noopener ugc nofollow" target="_blank">https://docs.microsoft.com/en-us/cli/azure/storage/account?view=azure-cli-latest </a></p><p id="e3d0" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">azure CLI-az event grid事件订阅:<br/><a class="ae kf" href="https://docs.microsoft.com/en-us/cli/azure/eventgrid/event-subscription?view=azure-cli-latest" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/CLI/azure/event grid/event-subscription？view=azure-cli-latest </a></p><p id="0c62" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">从Azure事件网格向HTTP端点接收事件:<a class="ae kf" href="https://docs.microsoft.com/en-us/azure/event-grid/receive-events#endpoint-validation" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/Azure/Event-Grid/receive-events # endpoint-validation</a></p><p id="0134" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">基于webhook的通用YAML管道触发器:<a class="ae kf" href="https://docs.microsoft.com/en-us/azure/devops/release-notes/2020/pipelines/sprint-172-update?WT.mc_id=DOP-MVP-21138#generic-webhook-based-triggers-for-yaml-pipelines" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/azure/devo PS/release-notes/2020/pipelines/sprint-172-update？wt . MC _ id = DOP-MVP-21138 # generic-web hook-based-triggers-for-YAML-pipelines</a></p><p id="90fb" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">启用事件网格资源提供者:<br/><a class="ae kf" href="https://docs.microsoft.com/en-us/azure/event-grid/custom-event-quickstart-portal#enable-event-grid-resource-provider" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/azure/Event-Grid/custom-Event-quick start-portal # enable-Event-Grid-resource-provider</a></p></div></div>    
</body>
</html>