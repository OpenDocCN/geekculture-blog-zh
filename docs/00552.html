<html>
<head>
<title>Setting a Private PyPI Server With NGINX</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用NGINX设置私有PyPI服务器</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/setting-a-private-pypi-server-with-nginx-acbb73c8516d?source=collection_archive---------1-----------------------#2021-03-02">https://medium.com/geekculture/setting-a-private-pypi-server-with-nginx-acbb73c8516d?source=collection_archive---------1-----------------------#2021-03-02</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="48bc" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">在本文中，我们将使用<a class="ae ix" href="https://hub.docker.com/r/pypiserver/pypiserver" rel="noopener ugc nofollow" target="_blank"> pypiserver Docker映像</a>建立一个私有的PyPI服务器，该映像将由<a class="ae ix" href="https://www.nginx.com/" rel="noopener ugc nofollow" target="_blank"> NGINX </a>包装，用于缓存和性能。</h2></div><figure class="iz ja jb jc fd jd er es paragraph-image"><div role="button" tabindex="0" class="je jf di jg bf jh"><div class="er es iy"><img src="../Images/421d7cba2af469c93337c9ed4d72bd1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i3RbkZ1bHadDHf2F7PfL8Q.jpeg"/></div></div><figcaption class="jk jl et er es jm jn bd b be z dx">Photo by <a class="ae ix" href="https://unsplash.com/@stjudd109" rel="noopener ugc nofollow" target="_blank">Spencer Judd</a> on <a class="ae ix" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure></div><div class="ab cl jo jp gp jq" role="separator"><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt"/></div><div class="hb hc hd he hf"><h2 id="685c" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated"><strong class="ak">PyPI是什么？</strong></h2><p id="fcf7" class="pw-post-body-paragraph kt ku hi kv b kw kx ij ky kz la im lb kg lc ld le kk lf lg lh ko li lj lk ll hb bi translated"><a class="ae ix" href="https://pypi.org/" rel="noopener ugc nofollow" target="_blank">正式文件</a>:</p><blockquote class="lm ln lo"><p id="ddda" class="kt ku lp kv b kw lq ij ky kz lr im lb ls lt ld le lu lv lg lh lw lx lj lk ll hb bi translated">Python包索引(PyPI)是Python编程语言的软件仓库。</p></blockquote><p id="2ec7" class="pw-post-body-paragraph kt ku hi kv b kw lq ij ky kz lr im lb kg lt ld le kk lv lg lh ko lx lj lk ll hb bi translated">PyPI是Python语言的官方第三方软件库。</p><p id="e598" class="pw-post-body-paragraph kt ku hi kv b kw lq ij ky kz lr im lb kg lt ld le kk lv lg lh ko lx lj lk ll hb bi translated">要从PyPI存储库中安装软件包，您需要一个软件包安装程序。最常见最推荐的是<a class="ae ix" href="https://pypi.org/project/pip/" rel="noopener ugc nofollow" target="_blank"> pip </a>。</p><p id="3cc5" class="pw-post-body-paragraph kt ku hi kv b kw lq ij ky kz lr im lb kg lt ld le kk lv lg lh ko lx lj lk ll hb bi translated">PyPI是公开的，任何人都可以访问它并下载上面列出的任何包。但是，有时您希望创建自己的私有存储库，这主要是出于安全原因。</p></div><div class="ab cl jo jp gp jq" role="separator"><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt"/></div><div class="hb hc hd he hf"><h2 id="6801" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">Docker设置</h2><p id="cd34" class="pw-post-body-paragraph kt ku hi kv b kw kx ij ky kz la im lb kg lc ld le kk lf lg lh ko li lj lk ll hb bi translated">要建立一个PyPI服务器，你需要一个服务器——它可以是你自己的机器，你朋友的，或者云中的机器(AWS，GCP等等)。在本教程中，我假设您已经有了一台服务器来托管您的私有存储库。</p><p id="cfcb" class="pw-post-body-paragraph kt ku hi kv b kw lq ij ky kz lr im lb kg lt ld le kk lv lg lh ko lx lj lk ll hb bi translated">因为我们将使用Docker来运行服务器，所以我们需要安装Docker:</p><figure class="iz ja jb jc fd jd"><div class="bz dy l di"><div class="ly lz l"/></div><figcaption class="jk jl et er es jm jn bd b be z dx">Docker installation</figcaption></figure><h2 id="ddd7" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">PyPI服务器安装</h2><p id="2dae" class="pw-post-body-paragraph kt ku hi kv b kw kx ij ky kz la im lb kg lc ld le kk lf lg lh ko li lj lk ll hb bi translated">让我们为我们的PyPI配置创建一个新目录。</p><pre class="iz ja jb jc fd ma mb mc md aw me bi"><span id="53b5" class="jv jw hi mb b fi mf mg l mh mi"># replace with your name<br/>mkdir /home/maroun/pypi-server</span></pre><p id="409d" class="pw-post-body-paragraph kt ku hi kv b kw lq ij ky kz lr im lb kg lt ld le kk lv lg lh ko lx lj lk ll hb bi translated">创建<code class="du mj mk ml mb b">docker-compose.yml</code>:</p><figure class="iz ja jb jc fd jd"><div class="bz dy l di"><div class="ly lz l"/></div></figure><p id="0248" class="pw-post-body-paragraph kt ku hi kv b kw lq ij ky kz lr im lb kg lt ld le kk lv lg lh ko lx lj lk ll hb bi translated">请注意，我们目前通过指定<code class="du mj mk ml mb b">-P . -a .</code>命令来允许未经授权的访问。</p><p id="1398" class="pw-post-body-paragraph kt ku hi kv b kw lq ij ky kz lr im lb kg lt ld le kk lv lg lh ko lx lj lk ll hb bi translated">现在，我们应该配置我们的NGINX服务器。在<code class="du mj mk ml mb b">pypi-server</code>中，创建以下目录:</p><pre class="iz ja jb jc fd ma mb mc md aw me bi"><span id="ba49" class="jv jw hi mb b fi mf mg l mh mi">mkdir nginx nginx_cache<br/>mkdir nginx/conf.d</span></pre><p id="1729" class="pw-post-body-paragraph kt ku hi kv b kw lq ij ky kz lr im lb kg lt ld le kk lv lg lh ko lx lj lk ll hb bi translated">现在，添加<code class="du mj mk ml mb b">pypi.conf</code>的<code class="du mj mk ml mb b">conf.d</code>，内容如下:l</p><figure class="iz ja jb jc fd jd"><div class="bz dy l di"><div class="ly lz l"/></div></figure><p id="47e7" class="pw-post-body-paragraph kt ku hi kv b kw lq ij ky kz lr im lb kg lt ld le kk lv lg lh ko lx lj lk ll hb bi translated">我们监听端口80(默认端口)，并将所有请求传递给“pypi-server:8080”，我们的pypi服务器在这里运行。</p><p id="5e81" class="pw-post-body-paragraph kt ku hi kv b kw lq ij ky kz lr im lb kg lt ld le kk lv lg lh ko lx lj lk ll hb bi translated">默认情况下，Compose为我们的应用程序建立了一个单独的<a class="ae ix" href="https://docs.docker.com/engine/reference/commandline/network_create/" rel="noopener ugc nofollow" target="_blank">网络</a>。服务的每个容器都加入默认网络，并且对于该网络上的其他容器都是<em class="lp">可到达的</em>，并且在与容器名称相同的主机名处被它们<em class="lp">发现</em>。这就是为什么我们可以在上面的配置中使用<code class="du mj mk ml mb b">pypi-server</code>主机。</p><p id="feb6" class="pw-post-body-paragraph kt ku hi kv b kw lq ij ky kz lr im lb kg lt ld le kk lv lg lh ko lx lj lk ll hb bi translated">最后，让我们在<code class="du mj mk ml mb b">nginx</code>目录中添加(默认)<code class="du mj mk ml mb b">nginx.conf</code>，它包括我们上面的自定义配置(第27行):</p><figure class="iz ja jb jc fd jd"><div class="bz dy l di"><div class="ly lz l"/></div><figcaption class="jk jl et er es jm jn bd b be z dx">nginx.conf</figcaption></figure></div><div class="ab cl jo jp gp jq" role="separator"><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt"/></div><div class="hb hc hd he hf"><h2 id="6226" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">启动服务器</h2><p id="8fde" class="pw-post-body-paragraph kt ku hi kv b kw kx ij ky kz la im lb kg lc ld le kk lf lg lh ko li lj lk ll hb bi translated">现在，我们应该能够从<code class="du mj mk ml mb b">pypi-server</code>目录运行以下内容:</p><pre class="iz ja jb jc fd ma mb mc md aw me bi"><span id="4f93" class="jv jw hi mb b fi mf mg l mh mi">docker-compose up -d</span></pre><p id="ed53" class="pw-post-body-paragraph kt ku hi kv b kw lq ij ky kz lr im lb kg lt ld le kk lv lg lh ko lx lj lk ll hb bi translated">从服务器访问本地路由:</p><pre class="iz ja jb jc fd ma mb mc md aw me bi"><span id="e06d" class="jv jw hi mb b fi mf mg l mh mi">$ curl localhost:8080<br/>&lt;!DOCTYPE html&gt;<br/>&lt;html lang="en"&gt;<br/>  &lt;head&gt;<br/>    &lt;meta charset="utf-8"&gt;<br/>    &lt;title&gt;Welcome to pypiserver!&lt;/title&gt;<br/>  &lt;/head&gt;<br/>  &lt;body&gt;<br/>    &lt;h1&gt;<br/>      Welcome to pypiserver!<br/>    &lt;/h1&gt;<br/>    &lt;p&gt;<br/>      This is a PyPI compatible package index serving 11 packages.<br/>    &lt;/p&gt;<br/>    &lt;p&gt;<br/>      To use this server with &lt;code&gt;pip&lt;/code&gt;, run the following command:<br/>      &lt;pre&gt;<br/>        &lt;code&gt;pip install --index-url <a class="ae ix" href="http://pypi-server:8080/simple/" rel="noopener ugc nofollow" target="_blank">http://pypi-server:8080/simple/</a> PACKAGE [PACKAGE2...]&lt;/code&gt;<br/>      &lt;/pre&gt;<br/>    &lt;/p&gt;<br/>    &lt;p&gt;<br/>      To use this server with &lt;code&gt;easy_install&lt;/code&gt;, run the following command:<br/>      &lt;pre&gt;<br/>        &lt;code&gt;easy_install --index-url <a class="ae ix" href="http://pypi-server:8080/simple/" rel="noopener ugc nofollow" target="_blank">http://pypi-server:8080/simple/</a> PACKAGE [PACKAGE2...]&lt;/code&gt;<br/>      &lt;/pre&gt;<br/>    &lt;/p&gt;<br/>    &lt;p&gt;<br/>      The complete list of all packages can be found &lt;a href="/packages/"&gt;here&lt;/a&gt; or via the &lt;a href="/simple/"&gt;simple&lt;/a&gt; index.<br/>    &lt;/p&gt;<br/>    &lt;p&gt;<br/>      This instance is running version 1.4.2 of the &lt;a href="<a class="ae ix" href="https://pypi.org/project/pypiserver/" rel="noopener ugc nofollow" target="_blank">https://pypi.org/project/pypiserver/</a>"&gt;pypiserver&lt;/a&gt; software.<br/>    &lt;/p&gt;<br/>  &lt;/body&gt;<br/>&lt;/html&gt;</span></pre></div><div class="ab cl jo jp gp jq" role="separator"><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt"/></div><div class="hb hc hd he hf"><h2 id="944e" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">下载包</h2><p id="adda" class="pw-post-body-paragraph kt ku hi kv b kw kx ij ky kz la im lb kg lc ld le kk lf lg lh ko li lj lk ll hb bi translated">使用<code class="du mj mk ml mb b">pip</code>，你现在可以从你自己的私有库下载包了！</p><pre class="iz ja jb jc fd ma mb mc md aw me bi"><span id="4cca" class="jv jw hi mb b fi mf mg l mh mi">pip install --index-url http://&lt;IP&gt;:8080 my_package --trusted-host &lt;IP&gt;</span></pre><p id="9178" class="pw-post-body-paragraph kt ku hi kv b kw lq ij ky kz lr im lb kg lt ld le kk lv lg lh ko lx lj lk ll hb bi translated">可以使用<a class="ae ix" href="https://twine.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank"> Twine </a>将包发布到我们新创建的服务器上。请继续查看它的文档以获得更多信息。</p></div><div class="ab cl jo jp gp jq" role="separator"><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt"/></div><div class="hb hc hd he hf"><h2 id="86e4" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">认证请求</h2><p id="4c1b" class="pw-post-body-paragraph kt ku hi kv b kw kx ij ky kz la im lb kg lc ld le kk lf lg lh ko li lj lk ll hb bi translated">当我们现在使用我们的私有存储库时，任何可以访问我们服务器的人都可以与存储库进行交互。为了保护它，我们可以使用<code class="du mj mk ml mb b"><a class="ae ix" href="https://github.com/pypiserver/pypiserver#apache-like-authentication-htpasswd" rel="noopener ugc nofollow" target="_blank">htpasswd</a></code>。安装<code class="du mj mk ml mb b">httpd-tools</code>:</p><pre class="iz ja jb jc fd ma mb mc md aw me bi"><span id="a961" class="jv jw hi mb b fi mf mg l mh mi">sudo yum install -y httpd-tools</span></pre><p id="325e" class="pw-post-body-paragraph kt ku hi kv b kw lq ij ky kz lr im lb kg lt ld le kk lv lg lh ko lx lj lk ll hb bi translated">现在，创建一个用于身份验证的文件夹:</p><pre class="iz ja jb jc fd ma mb mc md aw me bi"><span id="9a40" class="jv jw hi mb b fi mf mg l mh mi">mkdir authentication</span></pre><p id="3cd0" class="pw-post-body-paragraph kt ku hi kv b kw lq ij ky kz lr im lb kg lt ld le kk lv lg lh ko lx lj lk ll hb bi translated">并创建一个用户名:</p><pre class="iz ja jb jc fd ma mb mc md aw me bi"><span id="48d7" class="jv jw hi mb b fi mf mg l mh mi"># create .htpasswd file and force SHA encryption<br/>htpasswd -sc .htpasswd pypi-user</span></pre><p id="d43d" class="pw-post-body-paragraph kt ku hi kv b kw lq ij ky kz lr im lb kg lt ld le kk lv lg lh ko lx lj lk ll hb bi translated">系统将提示您插入密码。完成后，<code class="du mj mk ml mb b">.htpasswd</code>将为新用户创建一个条目，使用哈希密码:</p><pre class="iz ja jb jc fd ma mb mc md aw me bi"><span id="f7b9" class="jv jw hi mb b fi mf mg l mh mi">pypi-user:{SHA}s91+2DUySxI8K+YpcFDJPbI596c=</span></pre><p id="93c5" class="pw-post-body-paragraph kt ku hi kv b kw lq ij ky kz lr im lb kg lt ld le kk lv lg lh ko lx lj lk ll hb bi translated">接下来，我们应该更新Docker编写文件:</p><figure class="iz ja jb jc fd jd"><div class="bz dy l di"><div class="ly lz l"/></div><figcaption class="jk jl et er es jm jn bd b be z dx">Docker compose YML</figcaption></figure><p id="b73e" class="pw-post-body-paragraph kt ku hi kv b kw lq ij ky kz lr im lb kg lt ld le kk lv lg lh ko lx lj lk ll hb bi translated">注意，对于更新、下载和列表命令，我们将命令更改为<a class="ae ix" href="https://github.com/pypiserver/pypiserver#table-of-contents" rel="noopener ugc nofollow" target="_blank"> require authentication </a>。您可以查看<code class="du mj mk ml mb b">pypi-server</code>命令的手册:</p><pre class="iz ja jb jc fd ma mb mc md aw me bi"><span id="efd3" class="jv jw hi mb b fi mf mg l mh mi">pypi-server understands the following options:<br/><br/>  -p, --port PORT<br/>    Listen on port PORT (default: 8080).<br/><br/>  -i, --interface INTERFACE<br/>    Listen on interface INTERFACE (default: 0.0.0.0, any interface).<br/><br/>  -a, --authenticate (update|download|list), ...<br/>    Comma-separated list of (case-insensitive) actions to authenticate.<br/>    Requires to have set the password (-P option).<br/>    To password-protect package downloads (in addition to uploads) while<br/>    leaving listings public, use:<br/>      -P foo/htpasswd.txt -a update,download<br/>    To allow unauthorized access, use:<br/>      -P . -a .<br/>    Note that when uploads are not protected, the `register` command<br/>    is not necessary, but `~/.pypirc` still need username and password fields,<br/>    even if bogus.<br/>    By default, only 'update' is password-protected.</span></pre><p id="bd77" class="pw-post-body-paragraph kt ku hi kv b kw lq ij ky kz lr im lb kg lt ld le kk lv lg lh ko lx lj lk ll hb bi translated">访问PyPI服务器现在需要认证。</p></div><div class="ab cl jo jp gp jq" role="separator"><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt"/></div><div class="hb hc hd he hf"><h2 id="48d9" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">摘要</h2><p id="95ed" class="pw-post-body-paragraph kt ku hi kv b kw kx ij ky kz la im lb kg lc ld le kk lf lg lh ko li lj lk ll hb bi translated">有时你不想把你的包放在一个公共存储库中。创建一个定制的PyPI服务器是一个很好的主意，可以提高安全性，并且不会将您的包暴露给任何人。</p><p id="5435" class="pw-post-body-paragraph kt ku hi kv b kw lq ij ky kz lr im lb kg lt ld le kk lv lg lh ko lx lj lk ll hb bi translated">使用NGINX，我们引入了一种缓存机制，并且我们可以在需要时轻松地配置负载平衡器。</p></div></div>    
</body>
</html>