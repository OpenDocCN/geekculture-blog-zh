<html>
<head>
<title>Serving a Mix of Public and Private S3 Content Through AWS CloudFront</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过AWS CloudFront提供公共和私有S3内容</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/serving-a-mix-of-public-and-private-content-of-s3-through-aws-cloudfront-e158684f828a?source=collection_archive---------1-----------------------#2020-04-18">https://medium.com/geekculture/serving-a-mix-of-public-and-private-content-of-s3-through-aws-cloudfront-e158684f828a?source=collection_archive---------1-----------------------#2020-04-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/fa9eb71754f133e343316723dc31ca8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1362/format:webp/1*r6oWjjc5kS2PS7KswVvVsw.jpeg"/></div></figure><p id="c0e9" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">AWS CloudFront是一种CDN web服务，通过其边缘位置分发您的静态内容，以加速内容交付。许多公司要求从他们的S3桶中提供混合的私有和公共内容，但是我发现AWS指南在这一点上不是很清楚。我写这篇文章是为了分享我学到的一些技巧。</p></div><div class="ab cl jk jl gp jm" role="separator"><span class="jn bw bk jo jp jq"/><span class="jn bw bk jo jp jq"/><span class="jn bw bk jo jp"/></div><div class="hb hc hd he hf"><p id="f3c6" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">AWS通过签名的URL或签名的Cookie来保护私有内容。本文将集中讨论签名的URL，因为它更通用。无论如何，签名的Cookie与签名的URL非常相似。</p><p id="35d7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在深入技术细节之前，让我们先弄清楚URL签名。CloudFront支持一种向最终用户授予私有内容临时访问权的方式，即在内容URL上签署一个条件，通常是一个过期时间戳。因此，最终用户可以在有限的时间段内访问签名的内容URL。</p><p id="f995" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">要对文件URL进行签名，您需要一对签名密钥:一个用于应用程序签名文件URL的私钥和一个用于CloudFront验证签名的URL的公钥。</p><ul class=""><li id="b52c" class="jr js hi io b ip iq it iu ix jt jb ju jf jv jj jw jx jy jz bi translated"><strong class="io hj"> <em class="ka">只有AWS Root用户才能生成一对CloudFront签名密钥</em> </strong></li></ul><p id="d0c2" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果您不是root用户(大多数公司不会给开发人员Root证书)，您应该在开始之前询问一下。这可能是一个很高的要求，但CloudFront是一个跨所有地区的特殊AWS服务，这可能有安全原因。</p><p id="d400" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">可以在root用户帐户安全凭据页面中生成和下载密钥对。</p><figure class="kc kd ke kf fd ij er es paragraph-image"><div class="er es kb"><img src="../Images/8bff3b5cf109b092daa19205c4ca185e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1228/format:webp/1*a79IDwHEJy2hqVl3pQN6Vg.jpeg"/></div></figure></div><div class="ab cl jk jl gp jm" role="separator"><span class="jn bw bk jo jp jq"/><span class="jn bw bk jo jp jq"/><span class="jn bw bk jo jp"/></div><div class="hb hc hd he hf"><h2 id="7d2b" class="kg kh hi bd ki kj kk kl km kn ko kp kq ix kr ks kt jb ku kv kw jf kx ky kz la bi translated">创建一个S3桶</h2><p id="7eca" class="pw-post-body-paragraph im in hi io b ip lb ir is it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj hb bi translated">假设您的私人和公共内容都存在于S3存储桶中，您需要将这些内容分隔到不同的位置。如果公共和私人内容已经在不同的桶里，那也没关系，继续读下去。如果在S3桶中没有办法区分公共和私有文件，那么CloudFront可能也没有办法区分哪些文件是公共的，哪些是私有的。</p><ul class=""><li id="85f4" class="jr js hi io b ip iq it iu ix jt jb ju jf jv jj jw jx jy jz bi translated"><strong class="io hj"> <em class="ka">公共和私有文件应该在分开的S3位置</em> </strong></li></ul><p id="f747" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">但是为什么呢？CloudFront使用S3位置路径作为CDN URL的一部分。当CloudFront收到用户请求时，它不知道您对所请求文件的应用程序级权限。将公共文件放在一个公共文件夹中，允许CloudFront根据URL路径轻松识别它是一个公共文件，因此它可以只解除该文件夹上的签名URL策略。</p><figure class="kc kd ke kf fd ij er es paragraph-image"><div class="er es lg"><img src="../Images/e033eee1e54a60eb00718511eaee785a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1282/format:webp/1*LTVz3_Z4kO-midFN1Q3hMw.jpeg"/></div></figure><p id="5cd1" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在我上面的例子中，公共文件存在于一个公共文件夹中，其他的都是私有文件。您可以在您的S3桶中使用其他方式组织公共/私有文件，但是原则是它应该允许CloudFront容易地识别公共/私有路径。</p><ul class=""><li id="ccc8" class="jr js hi io b ip iq it iu ix jt jb ju jf jv jj jw jx jy jz bi translated"><strong class="io hj"> <em class="ka">阻止公众访问您的整个S3桶</em> </strong></li></ul><p id="bdbc" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们需要确保CloudFront可以从这个S3桶中读取数据，但是绝对不应该有公共访问这个桶的权限。这很重要，因为公共可访问S3存储桶允许最终用户绕过CloudFront直接访问受限文件。</p><p id="1240" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">转到您的S3存储桶的权限选项卡，阻止所有公共访问。(您可能需要允许您的应用程序写入这个桶)</p><p id="ebbf" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">CloudFront将使用一个特殊的特性，<strong class="io hj"> Origin Access Identity </strong>，来访问S3桶。</p><p id="31d6" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">下图说明了我们正在努力实现的目标</p><figure class="kc kd ke kf fd ij er es paragraph-image"><div class="er es lh"><img src="../Images/57690499217812ead01af3a97fb82794.png" data-original-src="https://miro.medium.com/v2/resize:fit:844/format:webp/0*vxE-NmB3M5kbwdB2.png"/></div></figure><ol class=""><li id="e187" class="jr js hi io b ip iq it iu ix jt jb ju jf jv jj li jx jy jz bi translated">限制访问文件缓存的签名URL</li><li id="28cd" class="jr js hi io b ip lj it lk ix ll jb lm jf ln jj li jx jy jz bi translated">仅限CloudFront访问您的S3存储桶中的对象</li></ol></div><div class="ab cl jk jl gp jm" role="separator"><span class="jn bw bk jo jp jq"/><span class="jn bw bk jo jp jq"/><span class="jn bw bk jo jp"/></div><div class="hb hc hd he hf"><h2 id="aae1" class="kg kh hi bd ki kj kk kl km kn ko kp kq ix kr ks kt jb ku kv kw jf kx ky kz la bi translated">创建CloudFront发行版</h2><p id="fd4e" class="pw-post-body-paragraph im in hi io b ip lb ir is it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj hb bi translated">转到AWS CloudFront页面，单击Create New Distribution。选择您的S3桶网址作为原始域名。确保您启用了限制存储桶访问，并且新的源访问身份已添加到存储桶策略中。</p><figure class="kc kd ke kf fd ij er es paragraph-image"><div class="er es lo"><img src="../Images/aa02969505316b2bb32e3e363ab477c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1150/format:webp/1*5-aUDJQkTgKulf8NvswQLw.jpeg"/></div></figure><p id="b430" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">必须启用限制查看者访问。如果您是Root用户，可信签名者应该是self。</p><figure class="kc kd ke kf fd ij er es paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="er es lp"><img src="../Images/5035951425a3764748ea12f3a5a78b6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*65yFEqlc4xqy1EqhWfqj7w.jpeg"/></div></div></figure><p id="36f5" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">您可以将所有rest选项保留为默认设置。在创建了一个发行版之后，如果您想要测试它，请等待发行版的状态就绪。这可能需要几分钟到半小时，具体取决于部署的位置。🙄</p></div><div class="ab cl jk jl gp jm" role="separator"><span class="jn bw bk jo jp jq"/><span class="jn bw bk jo jp jq"/><span class="jn bw bk jo jp"/></div><div class="hb hc hd he hf"><h2 id="f70f" class="kg kh hi bd ki kj kk kl km kn ko kp kq ix kr ks kt jb ku kv kw jf kx ky kz la bi translated">允许公共访问的新缓存行为</h2><p id="0767" class="pw-post-body-paragraph im in hi io b ip lb ir is it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj hb bi translated">现在我们已经限制了所有文件的URL签名。我们的公开档案呢？</p><p id="dd8e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">单击行为，创建新行为。确保它具有以下配置。</p><p id="5571" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">路径模式:</strong>/*<br/><strong class="io hj">限制查看者访问:</strong>否</p><p id="14ba" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这使得匹配模式<code class="du lu lv lw lx b">&lt;your CloudFront URL&gt;/public/*</code>的文件可以通过这个CloudFront发行版公开访问。</p><p id="a1ac" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果对公共文件使用另一个S3存储桶，而不是同一存储桶下的文件夹，则需要为该公共存储桶创建另一个源，并为该源创建一个缓存行为，仅用于禁用查看者访问。</p></div><div class="ab cl jk jl gp jm" role="separator"><span class="jn bw bk jo jp jq"/><span class="jn bw bk jo jp jq"/><span class="jn bw bk jo jp"/></div><div class="hb hc hd he hf"><h2 id="fff1" class="kg kh hi bd ki kj kk kl km kn ko kp kq ix kr ks kt jb ku kv kw jf kx ky kz la bi translated">签名文件URL</h2><p id="f8e3" class="pw-post-body-paragraph im in hi io b ip lb ir is it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj hb bi translated">签名算法只是标准的RSA SHA-1算法。您的应用程序可以对其进行签名，而无需AWS工具。</p><p id="4035" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">有两种签名方式，固定策略或自定义策略。如果您需要做的只是一次签署一个文件。就用罐头政策。自定义策略对于一次签署多个文件非常有用。</p><p id="8b12" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在<a class="ae ly" href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/PrivateCFSignatureCodeAndExamples.html" rel="noopener ugc nofollow" target="_blank"> AWS指南</a>中有代码示例来演示签名过程。</p><h2 id="94f0" class="kg kh hi bd ki kj kk kl km kn ko kp kq ix kr ks kt jb ku kv kw jf kx ky kz la bi translated">对多个文件重复使用签名</h2><p id="6314" class="pw-post-body-paragraph im in hi io b ip lb ir is it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj hb bi translated">当涉及到签署一堆文件时，例如，一个文件夹下的文件集合。如何高效正确地做这件事让我很困惑。AWS指南在提到“您可以为多个文件重用策略声明”时并不是很清楚。</p><ul class=""><li id="ab57" class="jr js hi io b ip iq it iu ix jt jb ju jf jv jj jw jx jy jz bi translated"><strong class="io hj"> <em class="ka">您可以使用自定义策略对所有允许的文件重复使用签名</em> </strong></li></ul><p id="0587" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果您在一个文件夹中有许多私有文件，并且您需要向用户提供所有这些文件，那么您应该使用自定义策略来授予对整个文件夹的访问权限，并对所有被授予权限的文件重复使用生成的签名。签名过程只对自定义策略本身进行签名，因此结果签名与所有文件完全相同。</p><p id="a1f0" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">自定义策略应该是这样的</p><pre class="kc kd ke kf fd lz lx ma mb aw mc bi"><span id="7456" class="kg kh hi lx b fi md me l mf mg">{<br/>  "Statement": [<br/>    {<br/>      "Resource":"http://d111111abcdef8.cloudfront.net/training/*",<br/>      "Condition":{"DateLessThan":{"AWS:EpochTime":1357034400}}<br/>    }<br/>  ]<br/>}</span></pre><p id="100c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">上述策略将生成一个签名，该签名可以附加到training文件夹中的所有文件URL。</p><h2 id="26f1" class="kg kh hi bd ki kj kk kl km kn ko kp kq ix kr ks kt jb ku kv kw jf kx ky kz la bi translated">向最终用户提供文件</h2><p id="2730" class="pw-post-body-paragraph im in hi io b ip lb ir is it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj hb bi translated">现在你差不多完成了。签名应该附加到CloudFront CDN URL，并提供给用户。完整的签名网址如下所示。</p><pre class="kc kd ke kf fd lz lx ma mb aw mc bi"><span id="95cf" class="kg kh hi lx b fi md me l mf mg">http://d111111abcdef8.cloudfront.net/training/image.jpg?Policy=&lt;base64 policy&gt;&amp;Signature=&lt;base64 policy&gt;&amp;Key-Pair-Id=&lt;key id&gt;</span></pre><p id="25b3" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">最后，您可能希望设置您的应用程序域来替换默认的随机CloudFront CDN URL，因为它看起来不太好。</p><p id="192a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">祝你好运，愿<code class="du lu lv lw lx b">git push --force</code>与你同在！</p></div></div>    
</body>
</html>