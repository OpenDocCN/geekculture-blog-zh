<html>
<head>
<title>Make GitHub Workflows run consecutively</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让GitHub工作流程连续运行</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/make-github-workflows-run-consecutively-4d98840ed600?source=collection_archive---------4-----------------------#2021-07-16">https://medium.com/geekculture/make-github-workflows-run-consecutively-4d98840ed600?source=collection_archive---------4-----------------------#2021-07-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="036d" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">TLDR:<a class="ae ix" href="https://github.com/marketplace/actions/consecutive-workflow-action" rel="noopener ugc nofollow" target="_blank">https://github . com/market place/actions/continuous-workflow-action</a></h2></div><figure class="iz ja jb jc fd jd er es paragraph-image"><div role="button" tabindex="0" class="je jf di jg bf jh"><div class="er es iy"><img src="../Images/c8ff1be0cab576591e6cc1ba5516fb33.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9ObExmkZHfK-ixN8vtjBSw.png"/></div></div></figure><p id="241e" class="pw-post-body-paragraph jk jl hi jm b jn jo ij jp jq jr im js jt ju jv jw jx jy jz ka kb kc kd ke kf hb bi translated"><strong class="jm hj">截至2022年，medium.com要求您拥有至少100名粉丝才有资格加入合作伙伴计划。在写这篇文章的时候，我有13个。所以如果你觉得这篇文章有帮助或者有趣，请考虑关注我。谢谢！</strong></p><p id="be15" class="pw-post-body-paragraph jk jl hi jm b jn jo ij jp jq jr im js jt ju jv jw jx jy jz ka kb kc kd ke kf hb bi translated"><em class="kg">本文假设你对GitHub动作/工作流有一些基本的经验。</em></p><p id="7025" class="pw-post-body-paragraph jk jl hi jm b jn jo ij jp jq jr im js jt ju jv jw jx jy jz ka kb kc kd ke kf hb bi translated">当您使用GitHub Actions时，您几乎拥有无限的灵活性，几乎可以做任何事情。但是有时候你必须有点创造力来实现你想要的。</p><p id="e785" class="pw-post-body-paragraph jk jl hi jm b jn jo ij jp jq jr im js jt ju jv jw jx jy jz ka kb kc kd ke kf hb bi translated">在工作流中，作业是并行执行的，但是您可以创建作业之间的依赖关系，以便它们连续运行。作业中的步骤总是一个接一个地运行。</p><p id="192f" class="pw-post-body-paragraph jk jl hi jm b jn jo ij jp jq jr im js jt ju jv jw jx jy jz ka kb kc kd ke kf hb bi translated">工作流本身总是彼此独立运行。您可以多次触发同一个工作流，将会有多个并行运行。在许多常见场景中，这完全没问题。当有两个新的拉请求几乎同时提交时，您的自动化测试可以同时为这两个拉请求运行。</p><p id="d84e" class="pw-post-body-paragraph jk jl hi jm b jn jo ij jp jq jr im js jt ju jv jw jx jy jz ka kb kc kd ke kf hb bi translated">但是在有些情况下这会导致问题。我喜欢让我的工作流不仅执行一些检查，而且更新存储库。自动修复代码格式问题就是一个很好的例子。</p><figure class="iz ja jb jc fd jd er es paragraph-image"><div role="button" tabindex="0" class="je jf di jg bf jh"><div class="er es kh"><img src="../Images/d94d2a34ae20c1cd3d20719ee2f5ee2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C1klcgz1yev9baYgTn8A5A.png"/></div></div><figcaption class="ki kj et er es kk kl bd b be z dx">Two parallel workflow runs.</figcaption></figure><p id="de33" class="pw-post-body-paragraph jk jl hi jm b jn jo ij jp jq jr im js jt ju jv jw jx jy jz ka kb kc kd ke kf hb bi translated">现在并行的问题当然是这样的:</p><pre class="iz ja jb jc fd km kn ko kp aw kq bi"><span id="a518" class="kr ks hi kn b fi kt ku l kv kw">Updates were rejected because the remote contains work that you do not have locally. This is usually caused by another repository pushing to the same ref. You may want to first integrate the remote changes (e.g., 'git pull ...') before pushing again.<br/>See the 'Note about fast-forwards' in 'git push --help' for details.</span></pre><p id="25ca" class="pw-post-body-paragraph jk jl hi jm b jn jo ij jp jq jr im js jt ju jv jw jx jy jz ka kb kc kd ke kf hb bi translated">几乎同时向同一个存储库推送的两个工作流运行很可能会失败。首先想到的是在推送之前拉取变更，但是这会导致合并冲突，而您的工作流无法自行解决。</p><p id="a94d" class="pw-post-body-paragraph jk jl hi jm b jn jo ij jp jq jr im js jt ju jv jw jx jy jz ka kb kc kd ke kf hb bi translated">因此，您需要确保一旦工作流运行A完成推送，工作流运行B只克隆存储库。它们需要连续运行。GitHub并没有提供现成的，而是提供了一个足够全面的API来自己实现它。我不会详细介绍<a class="ae ix" href="https://github.com/mktcode/consecutive-workflow-action/blob/main/index.js" rel="noopener ugc nofollow" target="_blank">实现</a>，但这是一个通用的、相当简单的想法:</p><p id="26d2" class="pw-post-body-paragraph jk jl hi jm b jn jo ij jp jq jr im js jt ju jv jw jx jy jz ka kb kc kd ke kf hb bi translated">正如我前面提到的，您可以在工作流中的作业之间创建依赖关系。因此，工作流的第一项工作就是查看它以前的运行，并等待它完成。我不关心它的结果，不管它是失败了还是成功了，我只想确保它不再运行了。只要不是这种情况，请稍等片刻，然后再次检查。因此，这里包含了一个很好的while循环，以确保我们工作流中的第一个作业阻塞其余的作业，直到上一次运行完成。</p><figure class="iz ja jb jc fd jd er es paragraph-image"><div role="button" tabindex="0" class="je jf di jg bf jh"><div class="er es kx"><img src="../Images/ddbe9e3e44db05df6033c6c7faf7629e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QS0rXEVaLMvJKfTiWOUmJg.png"/></div></div><figcaption class="ki kj et er es kk kl bd b be z dx">First job blocks workflow and checks previous run every 10 seconds.</figcaption></figure><p id="b4ff" class="pw-post-body-paragraph jk jl hi jm b jn jo ij jp jq jr im js jt ju jv jw jx jy jz ka kb kc kd ke kf hb bi translated">我<a class="ae ix" href="https://github.com/marketplace/actions/consecutive-workflow-action" rel="noopener ugc nofollow" target="_blank">将此作为GitHub动作</a>发布，这是超级容易使用的。</p><pre class="iz ja jb jc fd km kn ko kp aw kq bi"><span id="8ce8" class="kr ks hi kn b fi kt ku l kv kw">jobs:<br/>  consecutiveness:<br/>    runs-on: ubuntu-latest<br/>    steps:<br/>    - uses: mktcode/consecutive-workflow-action@v1<br/>      with:<br/>        token: ${{ secrets.GITHUB_TOKEN }}<br/><br/>  # your other jobs<br/>  something:<br/>    runs-on: ubuntu-latest<br/>    needs: [ consecutiveness ]<br/>    steps:<br/>    # ...</span></pre><p id="201e" class="pw-post-body-paragraph jk jl hi jm b jn jo ij jp jq jr im js jt ju jv jw jx jy jz ka kb kc kd ke kf hb bi translated">关于<code class="du ky kz la kn b">GITHUB_TOKEN</code>有一点需要说明……在执行API调用(检查之前的工作流运行)时，需要使用令牌来避免速率限制问题。确保你阅读了库的自述文件中的<a class="ae ix" href="https://github.com/mktcode/consecutive-workflow-action#security-note" rel="noopener ugc nofollow" target="_blank">安全说明</a>。</p><p id="490a" class="pw-post-body-paragraph jk jl hi jm b jn jo ij jp jq jr im js jt ju jv jw jx jy jz ka kb kc kd ke kf hb bi translated">就是这样！希望对一些人有用。如果你对我正在做的事情感兴趣，请在GitHub上关注我。谢谢！:)</p><p id="4a1b" class="pw-post-body-paragraph jk jl hi jm b jn jo ij jp jq jr im js jt ju jv jw jx jy jz ka kb kc kd ke kf hb bi translated"><em class="kg">如果你打算成为中等会员，可以使用我的推荐页面支持我:</em><a class="ae ix" href="https://markus-kottlaender.medium.com/membership" rel="noopener"><em class="kg">https://markus-kottlaender.medium.com/membership</em></a></p></div></div>    
</body>
</html>