<html>
<head>
<title>Minimal APIs in .NET 6 — A Complete Guide(Beginners + Advanced)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">中的最小API。NET 6 —完全指南(初学者+高级)</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/minimal-apis-in-net-6-a-complete-guide-beginners-advanced-fd64f4da07f5?source=collection_archive---------0-----------------------#2021-11-20">https://medium.com/geekculture/minimal-apis-in-net-6-a-complete-guide-beginners-advanced-fd64f4da07f5?source=collection_archive---------0-----------------------#2021-11-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="ee71" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">有了真实世界例子</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/704f9d49f7a224e2f7292dbe58c762cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wQNuKYhjaYspXE3IUdwZsw.jpeg"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Photo by <a class="ae jn" href="https://unsplash.com/@ffstop?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Fotis Fotopoulos</a> on <a class="ae jn" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="1346" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">。NET 6于上周发布，被誉为“最快的”。微软还没有推出“NET”。它带来了许多令人兴奋的新功能，<a class="ae jn" href="https://devblogs.microsoft.com/dotnet/welcome-to-csharp-10/" rel="noopener ugc nofollow" target="_blank">语言</a>和<a class="ae jn" href="https://devblogs.microsoft.com/dotnet/performance-improvements-in-net-6/" rel="noopener ugc nofollow" target="_blank">性能改进</a>。这是LTS自1998年以来的首次发布。NET Core 3.1，将支持三年。</p><p id="5a5d" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在本文中，我们将讨论以下主题:</p><ul class=""><li id="45aa" class="kk kl hi jq b jr js ju jv jx km kb kn kf ko kj kp kq kr ks bi translated">最低限度的API是什么？</li><li id="f067" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kp kq kr ks bi translated">创建真实世界的示例(使用SqlServer DB和EFCore)</li><li id="b0b5" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kp kq kr ks bi translated">如何使用Swagger添加OpenAPI规范</li><li id="00ca" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kp kq kr ks bi translated">如何使用JWT认证保护最小API</li></ul><h2 id="17a2" class="ky kz hi bd la lb lc ld le lf lg lh li jx lj lk ll kb lm ln lo kf lp lq lr ls bi translated">最低限度的API是什么？</h2><p id="dd65" class="pw-post-body-paragraph jo jp hi jq b jr lt ij jt ju lu im jw jx lv jz ka kb lw kd ke kf lx kh ki kj hb bi translated">. NET6使得编写具有最小依赖性的REST APIs变得极其简单。初看起来，极简API似乎是微软对提供极简API的NodeJS(带ExpressJS) HTTP server的回答。</p><p id="0ba5" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">考虑以下代码:</p><pre class="iy iz ja jb fd ly lz ma mb aw mc bi"><span id="d525" class="ky kz hi lz b fi md me l mf mg">var express = require("express");</span><span id="f003" class="ky kz hi lz b fi mh me l mf mg">var app = express();</span><span id="c71b" class="ky kz hi lz b fi mh me l mf mg"><br/>app.listen(3000, () =&gt; {</span><span id="9dae" class="ky kz hi lz b fi mh me l mf mg">console.log("Server running on port 3000");</span><span id="f7fa" class="ky kz hi lz b fi mh me l mf mg">});</span><span id="6fe9" class="ky kz hi lz b fi mh me l mf mg">app.get("/platforms", (req, res, next) =&gt; {</span><span id="8e41" class="ky kz hi lz b fi mh me l mf mg">res.json(["Windows", "Mac", "Linux", "Unix"]);</span><span id="c65d" class="ky kz hi lz b fi mh me l mf mg">});</span></pre><p id="b8aa" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这是一个非常标准的使用ExpressJS的API，它提供了一个GET端点来使用NodeJS服务器访问所有可用的平台。</p><p id="10b9" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在，让我们看看在。网络6</p><pre class="iy iz ja jb fd ly lz ma mb aw mc bi"><span id="db71" class="ky kz hi lz b fi md me l mf mg">var builder = WebApplication.CreateBuilder(args);</span><span id="42cf" class="ky kz hi lz b fi mh me l mf mg">var app = builder.Build();</span><span id="4a94" class="ky kz hi lz b fi mh me l mf mg">app.MapGet(“/platforms”, () =&gt; “Windows,Mac,Linux,Unix”);</span><span id="eca6" class="ky kz hi lz b fi mh me l mf mg">app.Run();</span></pre><p id="90c7" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">就是这样！这是极简主义的极致——不再有Startup.cs、API控制器、额外的依赖等等。您只需要这4行代码来生成以下输出:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es mi"><img src="../Images/52f29243d6464eddb91ef97bd410548a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1198/format:webp/1*2cL_dyBeZZdfOC8o2srERA.png"/></div><figcaption class="jj jk et er es jl jm bd b be z dx">.NET 6 Minimal APIs</figcaption></figure><p id="8903" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">不再赘述，让我们开始吧:</p><h2 id="d208" class="ky kz hi bd la lb lc ld le lf lg lh li jx lj lk ll kb lm ln lo kf lp lq lr ls bi translated">先决条件:</h2><ul class=""><li id="2ebc" class="kk kl hi jq b jr lt ju lu jx mj kb mk kf ml kj kp kq kr ks bi translated"><a class="ae jn" href="https://dotnet.microsoft.com/download/dotnet/6.0" rel="noopener ugc nofollow" target="_blank">下载。NET 6 SDK </a>和ASP.NET核心运行时(带有IIS托管包)</li><li id="e90b" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kp kq kr ks bi translated"><a class="ae jn" href="https://visualstudio.microsoft.com/vs/preview/" rel="noopener ugc nofollow" target="_blank"> Visual Studio 2022 </a>(可惜。Visual Studio 2019不支持NET 6)</li></ul><h2 id="f3b9" class="ky kz hi bd la lb lc ld le lf lg lh li jx lj lk ll kb lm ln lo kf lp lq lr ls bi translated">1.创建新项目</h2><p id="20a4" class="pw-post-body-paragraph jo jp hi jq b jr lt ij jt ju lu im jw jx lv jz ka kb lw kd ke kf lx kh ki kj hb bi translated">使用Visual Studio 2022创建一个新项目，并选择“ASP。NET Core Empty "项目模板。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mm"><img src="../Images/1bc259fea9d6b16a6dc835809d92bbf6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M_kP0S4eTbOU9ZejwmOAxA.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Visual Studio — Create a new project</figcaption></figure><p id="38ec" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">使用默认设置(确保框架设置为。NET 6.0)</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mn"><img src="../Images/5615f2fadb0581de849b9dbcb871bf17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4bXRVLnCVEYtx9H5bWqwZw.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Visual Studio — Create a new project</figcaption></figure><p id="05bc" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">您可以在ASP.NET核心项目中看到Program.cs文件，其中包含hello world API。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mo"><img src="../Images/3329ed576144a20089fd2aaebbe5588c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qRIYtQ4IhAy6C2RjHSn0HQ.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Minimal APIs — A Simple Hello World</figcaption></figure><p id="3a73" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">您可能想知道标准using语句发生了什么变化？</p><p id="5884" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这是的另一个伟大的新功能。NET 6 — " <strong class="jq hj">隐式全局using</strong>"自动生成不可见的using语句并全局声明它们，这样您就不必处理在每个文件中重复声明名称空间的混乱情况。</p><p id="b677" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">编辑您的。Csproj文件，您会注意到有一个新的ImplicitUsing条目，它被设置为true。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es mp"><img src="../Images/87c039c261bf1fb769e5bd36b5e2eada.png" data-original-src="https://miro.medium.com/v2/resize:fit:1324/format:webp/1*c3PVNQ1-CNWQumoOmC2-Kw.png"/></div><figcaption class="jj jk et er es jl jm bd b be z dx">Minimal APIs —Project Settings</figcaption></figure><p id="2977" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">您可以检查obj/Debug/net6.0文件夹，以查看隐藏的自动生成文件—[project name]. global using s . g . cs。您可以定义一个单独的类，将您的所有using语句保存在<a class="ae jn" href="https://github.com/csehammad/MinimalAPIDemo/blob/main/globalUsing.cs" rel="noopener ugc nofollow" target="_blank">的一个位置</a>。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mq"><img src="../Images/5fe274acfff66f8ba6ea139a0539dc0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZzaPKNj5i_8umC1_s_ukNg.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Minimal APIs — Global Using</figcaption></figure><p id="dfb2" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">如果您不想使用此功能，可以在中禁用该标志。csproj文件。</p><p id="3b1f" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">注意:如果您想在一个特定的端口上运行API，您可以在run方法中指定它。</p><pre class="iy iz ja jb fd ly lz ma mb aw mc bi"><span id="84e1" class="ky kz hi lz b fi md me l mf mg">app.Run(“http://localhost:3000");</span></pre><p id="cd53" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">您甚至可以在多个端口上运行您的API。</p><pre class="iy iz ja jb fd ly lz ma mb aw mc bi"><span id="c341" class="ky kz hi lz b fi md me l mf mg">app.MapGet(“/”, () =&gt; “Hello World!”);</span><span id="b262" class="ky kz hi lz b fi mh me l mf mg">app.Urls.Add(“http://localhost:3000");</span><span id="7548" class="ky kz hi lz b fi mh me l mf mg">app.Urls.Add(“http://localhost:4000");</span><span id="3967" class="ky kz hi lz b fi mh me l mf mg">app.Run();</span></pre><p id="b0d7" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在上面的例子中，app。MapGet方法正在使用一个<strong class="jq hj">内联lambda表达式</strong>。在许多情况下，您可能希望使用静态或实例方法。</p><pre class="iy iz ja jb fd ly lz ma mb aw mc bi"><span id="5438" class="ky kz hi lz b fi md me l mf mg">var builder = WebApplication.CreateBuilder(args);</span><span id="fc46" class="ky kz hi lz b fi mh me l mf mg">var app = builder.Build();</span><span id="6d23" class="ky kz hi lz b fi mh me l mf mg">app.MapGet(“/”, MyHandler.Hello);</span><span id="9ec2" class="ky kz hi lz b fi mh me l mf mg">app.Run();</span><span id="f7bc" class="ky kz hi lz b fi mh me l mf mg">class MyHandler</span><span id="474e" class="ky kz hi lz b fi mh me l mf mg">{</span><span id="ad90" class="ky kz hi lz b fi mh me l mf mg">public static string Hello()</span><span id="6dd6" class="ky kz hi lz b fi mh me l mf mg">{ return “Hello World!”; }</span><span id="82ae" class="ky kz hi lz b fi mh me l mf mg">}</span></pre><h2 id="b5c1" class="ky kz hi bd la lb lc ld le lf lg lh li jx lj lk ll kb lm ln lo kf lp lq lr ls bi translated">POST，PUT，Delete等呢？</h2><p id="67b6" class="pw-post-body-paragraph jo jp hi jq b jr lt ij jt ju lu im jw jx lv jz ka kb lw kd ke kf lx kh ki kj hb bi translated">Web application builder为这些请求提供了不同的方法。</p><ul class=""><li id="7058" class="kk kl hi jq b jr js ju jv jx km kb kn kf ko kj kp kq kr ks bi translated">app。地图发布()</li><li id="f931" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kp kq kr ks bi translated">app。地图输入()</li><li id="ac6c" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kp kq kr ks bi translated">app。映射删除()</li></ul><h2 id="5f4f" class="ky kz hi bd la lb lc ld le lf lg lh li jx lj lk ll kb lm ln lo kf lp lq lr ls bi translated">中的最小API。NET 6 —一个真实世界的例子</h2><p id="5d87" class="pw-post-body-paragraph jo jp hi jq b jr lt ij jt ju lu im jw jx lv jz ka kb lw kd ke kf lx kh ki kj hb bi translated">在以下示例中，我们将使用Azure SQL DB来连接我们的API，它将提供以下CRUD功能:</p><ul class=""><li id="0583" class="kk kl hi jq b jr js ju jv jx km kb kn kf ko kj kp kq kr ks bi translated">获取所有书籍</li><li id="2550" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kp kq kr ks bi translated">添加新书</li><li id="4de9" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kp kq kr ks bi translated">按关键字搜索图书</li><li id="763b" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kp kq kr ks bi translated">按ID更新书名</li></ul><p id="45ca" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">除此之外，我们还将学习如何添加openapi specification—SwaggerUI来创建文档，以及一些高级概念，如使用JWT令牌添加身份验证和授权。</p><ol class=""><li id="09bd" class="kk kl hi jq b jr js ju jv jx km kb kn kf ko kj mr kq kr ks bi translated"><strong class="jq hj">让我们创建一个简单的数据库，并定义保存书籍和作者信息的表。</strong></li></ol><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ms"><img src="../Images/3ddfd2896a35811660a8b0147ca5c735.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*20JWabQR-CHHAUqlyWL7Vw.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Minimal APIs — A Real World App Database</figcaption></figure><p id="5c8c" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">注意:您可以使用这个<a class="ae jn" href="https://github.com/csehammad/MinimalAPIDemo/blob/main/DB/AuthorsDB_Script.sql" rel="noopener ugc nofollow" target="_blank">脚本</a>来创建上面的表格，并用一些示例数据填充它们。</p><p id="ebea" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj"> 2。创建新项目</strong></p><p id="36a1" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">安装下列软件包:</p><pre class="iy iz ja jb fd ly lz ma mb aw mc bi"><span id="7abf" class="ky kz hi lz b fi md me l mf mg">Install-Package Azure.Extensions.AspNetCore.Configuration.Secrets -Version 1.2.1</span><span id="2b34" class="ky kz hi lz b fi mh me l mf mg">Install-Package Azure.Identity</span><span id="b819" class="ky kz hi lz b fi mh me l mf mg">install-package Microsoft.EntityFrameworkCore</span></pre><p id="b066" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在我们需要添加一些POCO类。让我们创建一个新的文件夹“模型”来放置我们项目中的所有模型类，比如<a class="ae jn" href="https://github.com/csehammad/MinimalAPIDemo/blob/main/Models/Book.cs" rel="noopener ugc nofollow" target="_blank"> Book.cs </a>，而不是将它添加到program.cs中</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mt"><img src="../Images/1f6972361e6e675fed8ba0a1ac165a72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w-UD-KpdbqSSBgc_PLiDsQ.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Minimal APIs — EF Core POCO Classes</figcaption></figure><p id="2c80" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在我们需要如下初始化DBContext:</p><pre class="iy iz ja jb fd ly lz ma mb aw mc bi"><span id="d47d" class="ky kz hi lz b fi md me l mf mg">builder.Services.AddDbContext&lt;BooksDB&gt;(options =&gt;{</span><span id="4c14" class="ky kz hi lz b fi mh me l mf mg">options.UseSqlServer(Environment.GetEnvironmentVariable(“AzureConnectionString”)); </span><span id="4b72" class="ky kz hi lz b fi mh me l mf mg">});</span></pre><p id="5c8b" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">. NET6通过引入WebApplicationBuilder简化了许多繁琐的任务，WebApplicationBuilder提供了对新的配置生成器、服务集合、环境、主机(IHostBuilder)、WebHost (IWebHostBuild)的访问，并提供了向DI容器注入依赖项的直接方法。</p><h2 id="3054" class="ky kz hi bd la lb lc ld le lf lg lh li jx lj lk ll kb lm ln lo kf lp lq lr ls bi translated">最小API示例# 1:从数据库中获取所有书籍</h2><p id="4f28" class="pw-post-body-paragraph jo jp hi jq b jr lt ij jt ju lu im jw jx lv jz ka kb lw kd ke kf lx kh ki kj hb bi translated">让我们编写第一个端点，从数据库中获取所有可用的书籍。</p><pre class="iy iz ja jb fd ly lz ma mb aw mc bi"><span id="a5b0" class="ky kz hi lz b fi md me l mf mg">app.MapGet(“/books”, async (BooksDB db) =&gt;</span><span id="0262" class="ky kz hi lz b fi mh me l mf mg">await db.Books.ToListAsync()</span><span id="bd39" class="ky kz hi lz b fi mh me l mf mg">);</span></pre><p id="2dee" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在上面的方法中，BooksDB是从服务中注入的，因此我们可以在我们的方法中使用它来执行各种DB操作。</p><p id="2805" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我们现在可以调用端点，并将响应视为一个JSON数组。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mu"><img src="../Images/3e04c868e7960d097a294d7051ad2a12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-PwA-JAfDAWGYefrkStFSg.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Minimal APIs — Get All Books Method Result</figcaption></figure><p id="438f" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在我们添加更多端点之前，让我们看看最小API是如何支持开放API规范的。</p><p id="e6bf" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">. NET6中的最小API支持使用Swashbuckle生成swagger文档。</p><p id="8f11" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">以下是步骤:</p><ol class=""><li id="34c3" class="kk kl hi jq b jr js ju jv jx km kb kn kf ko kj mr kq kr ks bi translated">安装ASP.NET核心的swashbuckler包</li></ol><pre class="iy iz ja jb fd ly lz ma mb aw mc bi"><span id="5b92" class="ky kz hi lz b fi md me l mf mg">install-package <!-- -->Swashbuckle.AspNetCore</span></pre><p id="c844" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">2.在您的web应用程序构建器中注入swagger服务。</p><pre class="iy iz ja jb fd ly lz ma mb aw mc bi"><span id="db91" class="ky kz hi lz b fi md me l mf mg">builder.Services.AddEndpointsApiExplorer();</span><span id="b772" class="ky kz hi lz b fi mh me l mf mg">builder.Services.AddSwaggerGen();</span></pre><p id="c260" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">3.通过添加中间件来呈现Swagger UI，在应用程序中使用Swagger。</p><pre class="iy iz ja jb fd ly lz ma mb aw mc bi"><span id="d516" class="ky kz hi lz b fi md me l mf mg">app.UseSwagger();</span><span id="1bf0" class="ky kz hi lz b fi mh me l mf mg">app.UseSwaggerUI();</span></pre><p id="cae8" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">构建并运行应用程序，您将能够在/swagger/index.html上看到swagger UI</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mv"><img src="../Images/deebf360eb35e5347c3a753760148735.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fERFdZFJmpHYnbC7kQnHiA.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Minimal APIs — Swagger UI</figcaption></figure><p id="4a06" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在，是时候通过注释API方法来记录API了。我们可以用老式的方法使用属性来实现。但是，在. NET6中，您可以使用最小API附带的扩展方法。</p><pre class="iy iz ja jb fd ly lz ma mb aw mc bi"><span id="e9d1" class="ky kz hi lz b fi md me l mf mg">app.MapGet(“/books”, async (BooksDB db) =&gt;</span><span id="c562" class="ky kz hi lz b fi mh me l mf mg">await db.Books.ToListAsync()</span><span id="fd73" class="ky kz hi lz b fi mh me l mf mg">)</span><span id="4dc5" class="ky kz hi lz b fi mh me l mf mg">.Produces&lt;List&lt;Book&gt;&gt;(StatusCodes.Status200OK)</span><span id="4c8d" class="ky kz hi lz b fi mh me l mf mg">.WithName(“GetAllBooks”).WithTags(“Getters”);</span></pre><ul class=""><li id="4e9a" class="kk kl hi jq b jr js ju jv jx km kb kn kf ko kj kp kq kr ks bi translated">产生→定义返回类型和预期状态。</li><li id="1086" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kp kq kr ks bi translated">with name→唯一标识端点。</li><li id="858a" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kp kq kr ks bi translated">WithTags →将所有相关端点分组。</li></ul><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mw"><img src="../Images/7bef238c810efc02957eabd10a731fbc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wxKpC61WUz6ThZBCLaaQdQ.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Minimal APIs — Generated using OpenAPI Specification</figcaption></figure><p id="ef43" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">如果您想从swagger描述中排除任何方法，您可以通过添加如下所示的<strong class="jq hj"> ExcludeFromDescription() </strong>扩展方法来实现:</p><pre class="iy iz ja jb fd ly lz ma mb aw mc bi"><span id="0586" class="ky kz hi lz b fi md me l mf mg">app.MapGet(“/”, () =&gt; “Hello! This is .NET 6 Minimal API Demo on Azure App Service”)<br/>.ExcludeFromDescription();</span></pre><p id="f8f5" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在我们已经完成了Swagger的工作，让我们把剩下的方法添加到我们的API中。</p><h2 id="1cba" class="ky kz hi bd la lb lc ld le lf lg lh li jx lj lk ll kb lm ln lo kf lp lq lr ls bi translated">最小API示例#2:向数据库添加新记录</h2><p id="987c" class="pw-post-body-paragraph jo jp hi jq b jr lt ij jt ju lu im jw jx lv jz ka kb lw kd ke kf lx kh ki kj hb bi translated">为了向数据库添加新条目，我们将使用MapPost方法和显式参数绑定。</p><pre class="iy iz ja jb fd ly lz ma mb aw mc bi"><span id="4481" class="ky kz hi lz b fi md me l mf mg">// Add new book to Sql Server DB</span><span id="e92d" class="ky kz hi lz b fi mh me l mf mg">app.MapPost(“/books”,</span><span id="62ae" class="ky kz hi lz b fi mh me l mf mg">async ([FromBody] Book addbook,[FromServices] BooksDB db, HttpResponse response) =&gt;</span><span id="468d" class="ky kz hi lz b fi mh me l mf mg">{</span><span id="c271" class="ky kz hi lz b fi mh me l mf mg">db.Books.Add(addbook);</span><span id="b48a" class="ky kz hi lz b fi mh me l mf mg">await db.SaveChangesAsync();</span><span id="855a" class="ky kz hi lz b fi mh me l mf mg">response.StatusCode = 200;</span><span id="884f" class="ky kz hi lz b fi mh me l mf mg">response.Headers.Location = $”books/{addbook.BookID}”;</span><span id="ccef" class="ky kz hi lz b fi mh me l mf mg">})</span><span id="7673" class="ky kz hi lz b fi mh me l mf mg">.Accepts&lt;Book&gt;(“application/json”)</span><span id="cefc" class="ky kz hi lz b fi mh me l mf mg">.Produces&lt;Book&gt;(StatusCodes.Status201Created)</span><span id="a7cc" class="ky kz hi lz b fi mh me l mf mg">.WithName(“AddNewBook”).WithTags(“Setters”);</span></pre><p id="9b28" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这里我们使用了两个属性来显式声明参数的绑定位置。</p><ul class=""><li id="5a0e" class="kk kl hi jq b jr js ju jv jx km kb kn kf ko kj kp kq kr ks bi translated">例如，<strong class="jq hj">【from body】</strong>属性用于指定JSON对象将作为参数传递给我们的ModelBinder。</li><li id="5c2f" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kp kq kr ks bi translated">[FromServices]用于指定该参数DB将从服务DI容器注入。</li></ul><p id="d3ff" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">因为这是一个POST方法，所以我们必须使用扩展方法对其进行注释——Accepts来指定请求体和内容类型。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mx"><img src="../Images/d05211fa12cc9bdda0e642d9f2868fec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XIAb0plGjU0MHW7dhHJVNg.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Minimal APIs — POST Method</figcaption></figure><h2 id="08c9" class="ky kz hi bd la lb lc ld le lf lg lh li jx lj lk ll kb lm ln lo kf lp lq lr ls bi translated">最小API示例#3:使用ID更新现有的书名</h2><p id="2914" class="pw-post-body-paragraph jo jp hi jq b jr lt ij jt ju lu im jw jx lv jz ka kb lw kd ke kf lx kh ki kj hb bi translated">要更新现有记录，我们将使用如下所示的MapPut方法:</p><pre class="iy iz ja jb fd ly lz ma mb aw mc bi"><span id="e34b" class="ky kz hi lz b fi md me l mf mg">app.MapPut("/books",</span><span id="0838" class="ky kz hi lz b fi mh me l mf mg">[AllowAnonymous] async (int bookID,string bookTitle, [FromServices] BooksDB db, HttpResponse response) =&gt;</span><span id="b811" class="ky kz hi lz b fi mh me l mf mg">{</span><span id="842f" class="ky kz hi lz b fi mh me l mf mg">var mybook = db.Books.SingleOrDefault(s =&gt; s.BookID == bookID);</span><span id="7770" class="ky kz hi lz b fi mh me l mf mg">if (mybook == null) return Results.NotFound();</span><span id="965e" class="ky kz hi lz b fi mh me l mf mg">mybook.Title = bookTitle;</span><span id="10d5" class="ky kz hi lz b fi mh me l mf mg">await db.SaveChangesAsync();</span><span id="ea4a" class="ky kz hi lz b fi mh me l mf mg">return Results.Created("/books",mybook);</span><span id="8071" class="ky kz hi lz b fi mh me l mf mg">})</span><span id="5acc" class="ky kz hi lz b fi mh me l mf mg">.Produces&lt;Book&gt;(StatusCodes.Status201Created).Produces(StatusCodes.Status404NotFound)</span><span id="c0ab" class="ky kz hi lz b fi mh me l mf mg">.WithName("UpdateBook").WithTags("Setters");</span></pre><p id="b104" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">可以看到，我们没有使用JSON对象，而是使用了两个参数bookID和Title(待更新)。在方法实现中，我们只是使用bookID获取记录，如果找到了记录，就会更新书名并将其返回给状态为201 Created的响应。</p><p id="33af" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我们使用多种扩展方法来表明，如果没有找到记录，也可以用404状态来响应。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es my"><img src="../Images/e98d073b4898973fe7f51fa20838483f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H0PJTlxMQNqcGH9PgXRlPQ.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Minimal APIs — PUT Method</figcaption></figure><p id="b946" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">让我们尝试一下，通过提供所需的值来执行请求，您将看到请求成功完成。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mz"><img src="../Images/605d0be475869e1b59b4383eb1de3595.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BidIkS5Dj7idN_SuxvVOdQ.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Minimal APIs — PUT Method Response</figcaption></figure><h2 id="5b5d" class="ky kz hi bd la lb lc ld le lf lg lh li jx lj lk ll kb lm ln lo kf lp lq lr ls bi translated">最小API示例#4:使用ID获取单个记录</h2><pre class="iy iz ja jb fd ly lz ma mb aw mc bi"><span id="8876" class="ky kz hi lz b fi md me l mf mg">app.MapGet("/books/{id}", async (BooksDB db, int id) =&gt;</span><span id="7a83" class="ky kz hi lz b fi mh me l mf mg">await db.Books.SingleOrDefaultAsync(s =&gt; s.BookID == id) is Book mybook ? Results.Ok(mybook) : Results.NotFound()</span><span id="6aa7" class="ky kz hi lz b fi mh me l mf mg">)</span><span id="033d" class="ky kz hi lz b fi mh me l mf mg">.Produces&lt;Book&gt;(StatusCodes.Status200OK)</span><span id="e4a0" class="ky kz hi lz b fi mh me l mf mg">.WithName("GetBookbyID").WithTags("Getters");</span></pre><p id="6743" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在上面的例子中，如果找到记录，我们只是返回JSON对象，否则将返回404。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mz"><img src="../Images/1f8dbb9f0a320060cbf87a2f77505aa3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SMlN5w559X0us9CO7fT_rg.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Minimal APIs — Fetch record by ID</figcaption></figure><h2 id="99e0" class="ky kz hi bd la lb lc ld le lf lg lh li jx lj lk ll kb lm ln lo kf lp lq lr ls bi translated">最小API示例#5:对给定的关键字执行搜索</h2><pre class="iy iz ja jb fd ly lz ma mb aw mc bi"><span id="801e" class="ky kz hi lz b fi md me l mf mg">app.MapGet(“/books/search/{query}”,</span><span id="6601" class="ky kz hi lz b fi mh me l mf mg">(string query, BooksDB db) =&gt;</span><span id="00a6" class="ky kz hi lz b fi mh me l mf mg">{</span><span id="c0bb" class="ky kz hi lz b fi mh me l mf mg">var _selectedBooks = db.Books.Where(x =&gt; x.Title.ToLower().Contains(query.ToLower())).ToList();</span><span id="d6cc" class="ky kz hi lz b fi mh me l mf mg">return _selectedBooks.Count&gt;0? Results.Ok(_selectedBooks): Results.NotFound(Array.Empty&lt;Book&gt;());</span><span id="dad4" class="ky kz hi lz b fi mh me l mf mg">})</span><span id="7ecb" class="ky kz hi lz b fi mh me l mf mg">.Produces&lt;List&lt;Book&gt;&gt;(StatusCodes.Status200OK)</span><span id="89ed" class="ky kz hi lz b fi mh me l mf mg">.WithName(“Search”).WithTags(“Getters”);</span></pre><p id="2335" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">如果书名与给定的关键字匹配，本示例返回图书列表。</p><h2 id="23f8" class="ky kz hi bd la lb lc ld le lf lg lh li jx lj lk ll kb lm ln lo kf lp lq lr ls bi translated">最小API示例#6:获取分页的结果集</h2><pre class="iy iz ja jb fd ly lz ma mb aw mc bi"><span id="f49c" class="ky kz hi lz b fi md me l mf mg">app.MapGet(“/books_by_page”, async (int pageNumber,int pageSize, BooksDB db) =&gt;</span><span id="f0e7" class="ky kz hi lz b fi mh me l mf mg">await db.Books</span><span id="19e6" class="ky kz hi lz b fi mh me l mf mg">.Skip((pageNumber — 1) * pageSize)</span><span id="ef7d" class="ky kz hi lz b fi mh me l mf mg">.Take(pageSize)</span><span id="7eaa" class="ky kz hi lz b fi mh me l mf mg">.ToListAsync()</span><span id="42dd" class="ky kz hi lz b fi mh me l mf mg">//await db.Books.ToListAsync()</span><span id="e3d5" class="ky kz hi lz b fi mh me l mf mg">)</span><span id="4eba" class="ky kz hi lz b fi mh me l mf mg">.Produces&lt;List&lt;Book&gt;&gt;(StatusCodes.Status200OK)</span><span id="2037" class="ky kz hi lz b fi mh me l mf mg">.WithName(“GetBooksByPage”).WithTags(“Getters”);</span></pre><p id="39e8" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">该方法采用两个参数——page number和pageSize，并从数据库返回分页的结果。</p><p id="1741" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">例如'/books_by_page？' pageNumber=2&amp;pageSize=5 '产生以下响应。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es na"><img src="../Images/4f32f03d8f6f033ae88c53f5af2dbc6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VLvmBQ9tD55ETmGv4046mg.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Minimal APIs — Paginated response</figcaption></figure><p id="48f1" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在下一节中，我们将看到如何在最小的API中使用JWT添加身份验证和授权。</p><h2 id="84f1" class="ky kz hi bd la lb lc ld le lf lg lh li jx lj lk ll kb lm ln lo kf lp lq lr ls bi translated">最小APIs使用JWT添加身份验证和授权</h2><p id="d62d" class="pw-post-body-paragraph jo jp hi jq b jr lt ij jt ju lu im jw jx lv jz ka kb lw kd ke kf lx kh ki kj hb bi translated">确保您安装了以下软件包。</p><pre class="iy iz ja jb fd ly lz ma mb aw mc bi"><span id="ca10" class="ky kz hi lz b fi md me l mf mg">Install-Package Microsoft.AspNetCore.Authentication.JwtBearer <br/>Install-Package Microsoft.IdentityModel.Tokens </span></pre><p id="81d9" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在让我们创建下面的类</p><pre class="iy iz ja jb fd ly lz ma mb aw mc bi"><span id="3bf5" class="ky kz hi lz b fi md me l mf mg">public record UserDto(string UserName, string Password);</span><span id="643a" class="ky kz hi lz b fi mh me l mf mg">public record UserModel</span><span id="9633" class="ky kz hi lz b fi mh me l mf mg">{</span><span id="13ab" class="ky kz hi lz b fi mh me l mf mg">[Required]</span><span id="b9cf" class="ky kz hi lz b fi mh me l mf mg">public string UserName { get; set; }</span><span id="ef85" class="ky kz hi lz b fi mh me l mf mg">[Required]</span><span id="d2d8" class="ky kz hi lz b fi mh me l mf mg">public string Password { get; set; }</span><span id="8264" class="ky kz hi lz b fi mh me l mf mg">}</span><span id="c0cd" class="ky kz hi lz b fi mh me l mf mg">public interface IUserRepositoryService</span><span id="55cf" class="ky kz hi lz b fi mh me l mf mg">{</span><span id="b402" class="ky kz hi lz b fi mh me l mf mg">UserDto GetUser(UserModel userModel);</span><span id="5549" class="ky kz hi lz b fi mh me l mf mg">}</span><span id="6365" class="ky kz hi lz b fi mh me l mf mg">public class UserRepositoryService : IUserRepositoryService</span><span id="d490" class="ky kz hi lz b fi mh me l mf mg">{</span><span id="340e" class="ky kz hi lz b fi mh me l mf mg">private List&lt;UserDto&gt; _users =&gt; new()</span><span id="7411" class="ky kz hi lz b fi mh me l mf mg">{</span><span id="7fe5" class="ky kz hi lz b fi mh me l mf mg">new(“admin”, “abc123”),</span><span id="7695" class="ky kz hi lz b fi mh me l mf mg">};</span><span id="ec67" class="ky kz hi lz b fi mh me l mf mg">public UserDto GetUser(UserModel userModel)</span><span id="183f" class="ky kz hi lz b fi mh me l mf mg">{</span><span id="54b1" class="ky kz hi lz b fi mh me l mf mg">return _users.FirstOrDefault(x =&gt; string.Equals(x.UserName, userModel.UserName) &amp;&amp; string.Equals(x.Password, userModel.Password));</span><span id="7513" class="ky kz hi lz b fi mh me l mf mg">}</span><span id="5874" class="ky kz hi lz b fi mh me l mf mg">}</span></pre><p id="afe1" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在上面的代码中，我们创建了UserDTO和model类来模拟内存中的用户存储，并创建了一个存储库方法来验证凭证。</p><p id="23b9" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">接下来，我们为JWT令牌的实现和生成创建类。</p><pre class="iy iz ja jb fd ly lz ma mb aw mc bi"><span id="5a60" class="ky kz hi lz b fi md me l mf mg">public interface ITokenService</span><span id="a46c" class="ky kz hi lz b fi mh me l mf mg">{</span><span id="a871" class="ky kz hi lz b fi mh me l mf mg">string BuildToken(string key, string issuer,string audience, UserDto user);</span><span id="7f0a" class="ky kz hi lz b fi mh me l mf mg">}</span><span id="f152" class="ky kz hi lz b fi mh me l mf mg">public class TokenService : ITokenService</span><span id="1944" class="ky kz hi lz b fi mh me l mf mg">{</span><span id="8675" class="ky kz hi lz b fi mh me l mf mg">private TimeSpan ExpiryDuration = new TimeSpan(0, 30, 0);</span><span id="8cff" class="ky kz hi lz b fi mh me l mf mg">public string BuildToken(string key, string issuer,string audience,  UserDto user)</span><span id="28e3" class="ky kz hi lz b fi mh me l mf mg">{</span><span id="f414" class="ky kz hi lz b fi mh me l mf mg">var claims = new[]</span><span id="12f2" class="ky kz hi lz b fi mh me l mf mg">{</span><span id="3a92" class="ky kz hi lz b fi mh me l mf mg">new Claim(ClaimTypes.Name, user.UserName),</span><span id="c67c" class="ky kz hi lz b fi mh me l mf mg">new Claim(ClaimTypes.NameIdentifier,</span><span id="a06a" class="ky kz hi lz b fi mh me l mf mg">Guid.NewGuid().ToString())</span><span id="581f" class="ky kz hi lz b fi mh me l mf mg">};</span><span id="d025" class="ky kz hi lz b fi mh me l mf mg">var securityKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(key));</span><span id="297a" class="ky kz hi lz b fi mh me l mf mg">var credentials = new SigningCredentials(securityKey, SecurityAlgorithms.HmacSha256Signature);</span><span id="41a9" class="ky kz hi lz b fi mh me l mf mg">var tokenDescriptor = new JwtSecurityToken(issuer, audience, claims,</span><span id="b094" class="ky kz hi lz b fi mh me l mf mg">expires: DateTime.Now.Add(ExpiryDuration), signingCredentials: credentials);</span><span id="58cd" class="ky kz hi lz b fi mh me l mf mg">return new JwtSecurityTokenHandler().WriteToken(tokenDescriptor);</span><span id="d1f4" class="ky kz hi lz b fi mh me l mf mg">}</span><span id="abd8" class="ky kz hi lz b fi mh me l mf mg">}</span></pre><p id="56f6" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">为了清晰起见，您可以将这些类添加到一个单独的文件夹中。</p><p id="99d2" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">是时候在WebApplicationBuilder服务中注入我们的依赖关系了</p><pre class="iy iz ja jb fd ly lz ma mb aw mc bi"><span id="8c7f" class="ky kz hi lz b fi md me l mf mg">builder.Services.AddSingleton&lt;TokenService&gt;(new TokenService());</span><span id="03c2" class="ky kz hi lz b fi mh me l mf mg">builder.Services.AddSingleton&lt;IUserRepositoryService&gt;(new UserRepositoryService());</span></pre><p id="0fa1" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在我们需要配置认证和授权服务。</p><pre class="iy iz ja jb fd ly lz ma mb aw mc bi"><span id="e445" class="ky kz hi lz b fi md me l mf mg">builder.Services.AddAuthorization();</span><span id="c3f0" class="ky kz hi lz b fi mh me l mf mg">builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme).AddJwtBearer(opt =&gt;</span><span id="df0f" class="ky kz hi lz b fi mh me l mf mg">{</span><span id="6dab" class="ky kz hi lz b fi mh me l mf mg">opt.TokenValidationParameters = new()</span><span id="9921" class="ky kz hi lz b fi mh me l mf mg">{</span><span id="e76d" class="ky kz hi lz b fi mh me l mf mg">ValidateIssuer = true,</span><span id="f566" class="ky kz hi lz b fi mh me l mf mg">ValidateAudience = true,</span><span id="ab71" class="ky kz hi lz b fi mh me l mf mg">ValidateLifetime = true,</span><span id="698b" class="ky kz hi lz b fi mh me l mf mg">ValidateIssuerSigningKey = true,</span><span id="8bcf" class="ky kz hi lz b fi mh me l mf mg">ValidIssuer = builder.Configuration[“Jwt:Issuer”],</span><span id="e1fc" class="ky kz hi lz b fi mh me l mf mg">ValidAudience = builder.Configuration[“Jwt:Audience”],</span><span id="510b" class="ky kz hi lz b fi mh me l mf mg">IssuerSigningKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(builder.Configuration[“Jwt:Key”]))</span><span id="9590" class="ky kz hi lz b fi mh me l mf mg">};</span><span id="ab28" class="ky kz hi lz b fi mh me l mf mg">});</span></pre><p id="7d0f" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">注意:确保您的appsettings.json包含以下键/值对</p><pre class="iy iz ja jb fd ly lz ma mb aw mc bi"><span id="dff3" class="ky kz hi lz b fi md me l mf mg">“Jwt”: {</span><span id="f371" class="ky kz hi lz b fi mh me l mf mg">“Key”: “your-secret-key”,</span><span id="320a" class="ky kz hi lz b fi mh me l mf mg">“Issuer”: "”,</span><span id="893a" class="ky kz hi lz b fi mh me l mf mg">“Audience”: “"</span><span id="e5f9" class="ky kz hi lz b fi mh me l mf mg">}</span></pre><p id="e332" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">最后，我们可以简单地添加用于认证和授权的中间件</p><pre class="iy iz ja jb fd ly lz ma mb aw mc bi"><span id="1073" class="ky kz hi lz b fi md me l mf mg">app.UseAuthentication();</span><span id="b708" class="ky kz hi lz b fi mh me l mf mg">app.UseAuthorization();</span></pre><p id="1edf" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在我们需要添加API方法，如<strong class="jq hj"> /login </strong>来验证用户的凭证并发布JWT令牌。</p><pre class="iy iz ja jb fd ly lz ma mb aw mc bi"><span id="e2cc" class="ky kz hi lz b fi md me l mf mg">app.MapPost("/login",   [AllowAnonymous] async ([FromBodyAttribute]UserModel userModel,  TokenService tokenService, IUserRepositoryService userRepositoryService, HttpResponse response) =&gt; {</span><span id="9667" class="ky kz hi lz b fi mh me l mf mg">var userDto = userRepositoryService.GetUser(userModel);<br/>if (userDto == null)<br/>{</span><span id="34dd" class="ky kz hi lz b fi mh me l mf mg">response.StatusCode = 401;</span><span id="8853" class="ky kz hi lz b fi mh me l mf mg">return;</span><span id="8d5e" class="ky kz hi lz b fi mh me l mf mg">}</span><span id="fc77" class="ky kz hi lz b fi mh me l mf mg">var token = tokenService.BuildToken(builder.Configuration["Jwt:Key"], builder.Configuration["Jwt:Issuer"], userDto);</span><span id="0bfc" class="ky kz hi lz b fi mh me l mf mg">await response.WriteAsJsonAsync(new { token = token });</span><span id="d2e9" class="ky kz hi lz b fi mh me l mf mg">return;</span><span id="9a92" class="ky kz hi lz b fi mh me l mf mg">}).Produces(StatusCodes.Status200OK)</span><span id="498e" class="ky kz hi lz b fi mh me l mf mg">.WithName("Login").WithTags("Accounts");</span></pre><p id="9212" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在这个方法中，我们简单地获取包含用户名和密码的UserModel类型的JSON对象，其他参数被隐式地传递给[from services]——它根据内存存储验证给定的凭证，并在成功验证后发布JWT令牌。我们还使用[AllowAnonymous]属性来确保这个端点在没有承载令牌的情况下是可访问的。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nb"><img src="../Images/b63d18387392803f7335165fb3111e6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uYGjv4m64bj3ltgLce9qbg.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Minimal APIs — JWT Security — Login method</figcaption></figure><p id="be0e" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">让我们创建一个受保护的资源，以确保它是否按预期工作</p><pre class="iy iz ja jb fd ly lz ma mb aw mc bi"><span id="bce8" class="ky kz hi lz b fi md me l mf mg">app.MapGet(“/AuthorizedResource”, (Func&lt;string&gt;)(</span><span id="2593" class="ky kz hi lz b fi mh me l mf mg">[Authorize] () =&gt; “Action Succeeded”)</span><span id="f2d7" class="ky kz hi lz b fi mh me l mf mg">).Produces(StatusCodes.Status200OK)</span><span id="d6d5" class="ky kz hi lz b fi mh me l mf mg">.WithName(“Authorized”).WithTags(“Accounts”).RequireAuthorization();</span></pre><p id="7c44" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">RequireAuthorization()扩展方法表明，如果不在请求标头中传递JWT承载令牌，就无法调用此方法。</p><p id="ec9a" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">因为我们使用Swagger UI来执行和测试我们的端点，所以我们需要添加一点调整，这样我们就可以在Swagger中存储我们的JWT令牌，然后继续执行受保护的端点，而不必处理请求头。</p><pre class="iy iz ja jb fd ly lz ma mb aw mc bi"><span id="0c8c" class="ky kz hi lz b fi md me l mf mg">builder.Services.AddSwaggerGen(c =&gt;</span><span id="93ff" class="ky kz hi lz b fi mh me l mf mg">{</span><span id="c695" class="ky kz hi lz b fi mh me l mf mg">var securityScheme = new OpenApiSecurityScheme</span><span id="80a4" class="ky kz hi lz b fi mh me l mf mg">{</span><span id="9be8" class="ky kz hi lz b fi mh me l mf mg">Name = “JWT Authentication”,</span><span id="cad0" class="ky kz hi lz b fi mh me l mf mg">Description = “Enter JWT Bearer token **_only_**”,</span><span id="17a1" class="ky kz hi lz b fi mh me l mf mg">In = ParameterLocation.Header,</span><span id="bb65" class="ky kz hi lz b fi mh me l mf mg">Type = SecuritySchemeType.Http,</span><span id="da7c" class="ky kz hi lz b fi mh me l mf mg">Scheme = “bearer”, // must be lower case</span><span id="5ed6" class="ky kz hi lz b fi mh me l mf mg">BearerFormat = “JWT”,</span><span id="c8e3" class="ky kz hi lz b fi mh me l mf mg">Reference = new OpenApiReference</span><span id="db7f" class="ky kz hi lz b fi mh me l mf mg">{</span><span id="340d" class="ky kz hi lz b fi mh me l mf mg">Id = JwtBearerDefaults.AuthenticationScheme,</span><span id="16f6" class="ky kz hi lz b fi mh me l mf mg">Type = ReferenceType.SecurityScheme</span><span id="0fda" class="ky kz hi lz b fi mh me l mf mg">}</span><span id="69fe" class="ky kz hi lz b fi mh me l mf mg">};</span><span id="b6f7" class="ky kz hi lz b fi mh me l mf mg">c.AddSecurityDefinition(securityScheme.Reference.Id, securityScheme);</span><span id="35b4" class="ky kz hi lz b fi mh me l mf mg">c.AddSecurityRequirement(new OpenApiSecurityRequirement</span><span id="893e" class="ky kz hi lz b fi mh me l mf mg">{</span><span id="c19b" class="ky kz hi lz b fi mh me l mf mg">{securityScheme, new string[] { }}</span><span id="726e" class="ky kz hi lz b fi mh me l mf mg">});</span><span id="5eb0" class="ky kz hi lz b fi mh me l mf mg">});</span></pre><p id="a5be" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">上面的代码将Authorize按钮添加到swagger UI中，该UI可以为后续请求存储JWT无记名令牌。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nc"><img src="../Images/acd9e4f29357f222efc09b7150de69e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w7zLMgXrIxjfOdgnPTUWVw.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Minimal APIs — Accounts endpoints</figcaption></figure><p id="23c2" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">执行登录端点并提供用户凭据(admin/abc123) —在Auth窗口中复制并粘贴令牌(如下所示)，然后单击Authorize。</p><div class="iy iz ja jb fd ab cb"><figure class="nd jc ne nf ng nh ni paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><img src="../Images/262693906e6df5b0850db868cda762ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1004/format:webp/1*Ao4jv2h-yZWR7__mSFDXTA.png"/></div></figure><figure class="nd jc nj nf ng nh ni paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><img src="../Images/1816e570dac7fe4e915ae5f546fb0afd.png" data-original-src="https://miro.medium.com/v2/resize:fit:998/format:webp/1*u0tG2Cdk3R4C27qL_vQ6uQ.png"/></div><figcaption class="jj jk et er es jl jm bd b be z dx nk di nl nm">Minimal APIs — Swagger Authorize Feature</figcaption></figure></div><p id="4039" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">您现在已经登录，将能够执行授权的端点(不记名令牌将由Swagger UI自动传递)</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nn"><img src="../Images/029724c07bddfda7457ca2cd54f42905.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eblmcVzVAm6H6H9hiSHQZA.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Minimal APIs — Accessing Protected Resources</figcaption></figure><h1 id="5d29" class="no kz hi bd la np nq nr le ns nt nu li io nv ip ll ir nw is lo iu nx iv lr ny bi translated">结论</h1><p id="e25b" class="pw-post-body-paragraph jo jp hi jq b jr lt ij jt ju lu im jw jx lv jz ka kb lw kd ke kf lx kh ki kj hb bi translated">在本文中，我们已经了解了。NET 6，还探索了如何执行各种CRUD和其他数据库操作，生成基于Swagger的文档，以及实现基于JWT的身份验证和授权。</p><p id="c2c0" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">你可以从<a class="ae jn" href="https://github.com/csehammad/MinimalAPIDemo/" rel="noopener ugc nofollow" target="_blank">这个回购</a>下载完整的源代码，也可以看到它<a class="ae jn" href="https://minimalapidemo.azurewebsites.net/swagger/index.html" rel="noopener ugc nofollow" target="_blank">在行动</a>。</p></div></div>    
</body>
</html>