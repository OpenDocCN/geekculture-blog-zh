<html>
<head>
<title>A Ready Reckoner To Upgrade From Python 2 to Python 3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从Python 2升级到Python 3的现成计算工具</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/a-ready-reckoner-to-upgrade-from-python-2-to-python-3-fab370515c70?source=collection_archive---------12-----------------------#2022-03-05">https://medium.com/geekculture/a-ready-reckoner-to-upgrade-from-python-2-to-python-3-fab370515c70?source=collection_archive---------12-----------------------#2022-03-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="bfe3" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">简要介绍如何将您的环境和服务代码库从Python 2迁移到Python 3。</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/073da6aaad2a49d474af14528e95835e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qnX6bzXeluvTXZVPDQawgA.jpeg"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Python 2 to Python 3</figcaption></figure><p id="6e8a" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">开发人员经常面临这样的情况，他们需要将他们的应用程序和相关环境升级到各自栈的较新版本。<br/>在这篇博客的第一条路径中，我将重点介绍如何升级运行python 2.7的ubuntu <code class="du kj kk kl km b">16.04</code>服务器，以使用python版本<code class="du kj kk kl km b">3.7</code>启动应用程序。在第二部分中，我将讨论如何将应用程序代码库从Python 2迁移到Python 3。</p><h1 id="71be" class="kn ko hi bd kp kq kr ks kt ku kv kw kx io ky ip kz ir la is lb iu lc iv ld le bi translated">迁移服务器</h1><p id="a3ad" class="pw-post-body-paragraph jn jo hi jp b jq lf ij js jt lg im jv jw lh jy jz ka li kc kd ke lj kg kh ki hb bi translated">这些是从基于Python 2的环境更新到Python 3环境时可以遵循的一般步骤。</p><p id="2f78" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">第一步是给机器加上<code class="du kj kk kl km b">deadsnakes</code> PPA。这包含了为Ubuntu打包的最新Python版本。</p><pre class="iy iz ja jb fd lk km ll lm aw ln bi"><span id="11c3" class="lo ko hi km b fi lp lq l lr ls">add-apt-repository ppa:deadsnakes/ppa </span></pre><p id="f968" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">接下来，安装所需的python版本——我将使用版本<code class="du kj kk kl km b">3.7</code>作为例子</p><pre class="iy iz ja jb fd lk km ll lm aw ln bi"><span id="d9f0" class="lo ko hi km b fi lp lq l lr ls">apt update<br/>apt install python3.7</span></pre><p id="38e0" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">在成功执行最后一步之后，创建一个python 3安装的符号链接，这不是系统默认完成的事情，如果您的应用程序依赖于使用<code class="du kj kk kl km b">python</code>命令，这将非常方便</p><blockquote class="lt lu lv"><p id="593f" class="jn jo lw jp b jq jr ij js jt ju im jv lx jx jy jz ly kb kc kd lz kf kg kh ki hb bi translated">如果需要多个python 3安装，这可能会派上用场。</p></blockquote><pre class="iy iz ja jb fd lk km ll lm aw ln bi"><span id="478c" class="lo ko hi km b fi lp lq l lr ls"># different versions can be specified here and priorities be set <br/>update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.7 2</span></pre><p id="100d" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">成功创建符号链接后，需要安装python 3 dev tools和python 3 pip来构建和管理包。</p><pre class="iy iz ja jb fd lk km ll lm aw ln bi"><span id="c984" class="lo ko hi km b fi lp lq l lr ls">apt-get install python3-pip python3-dev<br/>python3 -m pip install --upgrade pip</span></pre><p id="a98d" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">还可以安装更具体的python-dev工具，以建立与已安装python版本的直接兼容性，如下所示👇</p><pre class="iy iz ja jb fd lk km ll lm aw ln bi"><span id="a6db" class="lo ko hi km b fi lp lq l lr ls">apt-get install python3-pip python3.7-dev<br/>python3.7 -m pip install --upgrade pip</span></pre><p id="0dd1" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">最后一步，安装Python 3的虚拟环境。</p><pre class="iy iz ja jb fd lk km ll lm aw ln bi"><span id="a2c4" class="lo ko hi km b fi lp lq l lr ls">pip3 install virtualenv</span></pre><h1 id="97f7" class="kn ko hi bd kp kq kr ks kt ku kv kw kx io ky ip kz ir la is lb iu lc iv ld le bi translated">自动化</h1><p id="5e5c" class="pw-post-body-paragraph jn jo hi jp b jq lf ij js jt lg im jv jw lh jy jz ka li kc kd ke lj kg kh ki hb bi translated">上述步骤可以组合成一个shell脚本，并与应用程序执行集成在一起，或者可以在机器上手动执行。</p><pre class="iy iz ja jb fd lk km ll lm aw ln bi"><span id="16ab" class="lo ko hi km b fi lp lq l lr ls"><strong class="km hj">#!/usr/bin/env bash<br/><br/></strong>add-apt-repository ppa:deadsnakes/ppa -y<br/>if [ $? -eq 0 ]; then<br/>    echo "PPA installed correctly"<br/>else<br/>    echo "Failed to install PPA"<br/>fi<br/>apt update<br/>if [ $? -eq 0 ]; then<br/>    echo "Apt Update Passed"<br/>else<br/>    echo "Apt update failed"<br/>fi<br/>apt install python3.7 -y<br/>update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.7 2<br/>if [ $? -eq 0 ]; then<br/>    echo "Python version 3.7 installed. Use python3 --version to check that correct version is installed"<br/>else<br/>    echo "Failed to install python version 3.7"<br/>fi<br/>apt-get install -y python3-pip python3.7-dev<br/>python3.7 -m pip install --upgrade pip<br/>if [ $? -eq 0 ]; then<br/>    echo "Python 3.7 pip and dev tools installed"<br/>else<br/>    echo "Failed to install python 3.7 pip and dev tools"<br/>fi<br/>pip3 install virtualenv<br/>if [ $? -eq 0 ]; then<br/>    echo "Installied pip3 virtaul environment"<br/>else<br/>    echo "Failed to install pip3 virtual environment"<br/>fi<br/>pip3 install --ignore-installed PyYAML<br/>if [ $? -eq 0 ]; then<br/>    echo "Successfully upgraded to python3"<br/>else<br/>    echo "Failed to upgrade to python3"<br/>fi</span></pre><h1 id="9be5" class="kn ko hi bd kp kq kr ks kt ku kv kw kx io ky ip kz ir la is lb iu lc iv ld le bi translated">迁移应用程序代码库</h1><p id="a3c8" class="pw-post-body-paragraph jn jo hi jp b jq lf ij js jt lg im jv jw lh jy jz ka li kc kd ke lj kg kh ki hb bi translated">可能有许多工具可以帮助应用程序代码库的自动化迁移，其中之一是<code class="du kj kk kl km b">2to3</code>，它可以用来修改代码以与python 3兼容。</p><p id="240b" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">下面是如何使用这个工具修改代码以与python 3兼容。</p><pre class="iy iz ja jb fd lk km ll lm aw ln bi"><span id="b3b6" class="lo ko hi km b fi lp lq l lr ls">pip install 2to3<br/>cd &lt;your project directory&gt;<br/># first have a look at the modifications this will make<br/>2to3 .<br/># to modify in place<br/>2to3 -w .</span></pre><blockquote class="lt lu lv"><p id="e73a" class="jn jo lw jp b jq jr ij js jt ju im jv lx jx jy jz ly kb kc kd lz kf kg kh ki hb bi translated">注意:2to3将尝试纠正您的导入到python 3约定，这可能不总是正确的，因为它假设导入来自包。所以在应用之前检查一下2to3将要做的修改是很好的。关于这个实用程序的更多细节可以在<a class="ae ma" href="https://docs.python.org/3/library/2to3.html" rel="noopener ugc nofollow" target="_blank">这个</a>官方文档中找到。</p></blockquote><h2 id="26e5" class="lo ko hi bd kp mb mc md kt me mf mg kx jw mh mi kz ka mj mk lb ke ml mm ld mn bi translated">迁移到Python 3不可能这么简单，对吧..？</h2><p id="f4fe" class="pw-post-body-paragraph jn jo hi jp b jq lf ij js jt lg im jv jw lh jy jz ka li kc kd ke lj kg kh ki hb bi translated">上面的步骤将修改导入和通常的语句，比如python 3版本的<code class="du kj kk kl km b">print</code>，但是其他一些代码区域，比如错误处理、比较和字符串处理，可能仍然需要一些工作。</p><p id="d764" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">让我们更详细地看看这些。</p><h2 id="b9df" class="lo ko hi bd kp mb mc md kt me mf mg kx jw mh mi kz ka mj mk lb ke ml mm ld mn bi translated">整数比较</h2><p id="c5ed" class="pw-post-body-paragraph jn jo hi jp b jq lf ij js jt lg im jv jw lh jy jz ka li kc kd ke lj kg kh ki hb bi translated">所以python 2没有对类型进行硬检查来进行比较，所以类似下面这段代码的东西实际上会起作用</p><pre class="iy iz ja jb fd lk km ll lm aw ln bi"><span id="af59" class="lo ko hi km b fi lp lq l lr ls">a = "2"<br/>if a &gt;= 0:<br/>  print "True"<br/>else:<br/>  print "False"</span></pre><p id="5310" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">但是同样的方法在python 3中不起作用，所以您需要修改上面的代码，将字符串转换为整数，以便进行类似的比较。</p><pre class="iy iz ja jb fd lk km ll lm aw ln bi"><span id="e517" class="lo ko hi km b fi lp lq l lr ls">a = "2"<br/>if int(a) &gt;= 0:<br/>  print("True")<br/>else:<br/>  print("False")</span></pre><h2 id="7c79" class="lo ko hi bd kp mb mc md kt me mf mg kx jw mh mi kz ka mj mk lb ke ml mm ld mn bi translated">错误处理</h2><p id="bac0" class="pw-post-body-paragraph jn jo hi jp b jq lf ij js jt lg im jv jw lh jy jz ka li kc kd ke lj kg kh ki hb bi translated">关于Python 3中错误处理的细节可以从这里的文档<a class="ae ma" href="https://docs.python.org/3/tutorial/errors.html" rel="noopener ugc nofollow" target="_blank">中阅读。但是在一个非常简单的层面上，可能必须修改错误日志或传播。这方面的一个例子如下</a></p><pre class="iy iz ja jb fd lk km ll lm aw ln bi"><span id="f96d" class="lo ko hi km b fi lp lq l lr ls">Python 2</span><span id="f4f2" class="lo ko hi km b fi mo lq l lr ls">try:<br/>  &lt;code block&gt;<br/>except &lt;Error&gt; as exp:<br/>  print exp.message</span><span id="6281" class="lo ko hi km b fi mo lq l lr ls">Python 3<br/>try:<br/>  &lt;code block&gt;<br/>except &lt;Error&gt; as exp:<br/>  print(exp)</span></pre><h2 id="b746" class="lo ko hi bd kp mb mc md kt me mf mg kx jw mh mi kz ka mj mk lb ke ml mm ld mn bi translated">字符串和字节的区别</h2><p id="367c" class="pw-post-body-paragraph jn jo hi jp b jq lf ij js jt lg im jv jw lh jy jz ka li kc kd ke lj kg kh ki hb bi translated">在python 2中，字符串和字节之间的区别没有被很好地定义，但是到了python 3中，这种区别就很明显了，而且它们可能不能互相替代。</p><h2 id="97fc" class="lo ko hi bd kp mb mc md kt me mf mg kx jw mh mi kz ka mj mk lb ke ml mm ld mn bi translated">这会导致什么样的问题？</h2><p id="e423" class="pw-post-body-paragraph jn jo hi jp b jq lf ij js jt lg im jv jw lh jy jz ka li kc kd ke lj kg kh ki hb bi translated">这可能会导致许多问题，因为python 2允许自由使用字符串对象，而原本应该是一个字节，反之亦然。</p><p id="8795" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">例如，如果您以前以二进制模式打开一个文件，并试图用字符串填充它，它在python 2中可以工作，但在python 3中将停止工作。</p><pre class="iy iz ja jb fd lk km ll lm aw ln bi"><span id="e1f2" class="lo ko hi km b fi lp lq l lr ls">file = NamedTemporaryFile(mode="w+b", delete=False)<br/>file.write("some string")<br/>file.close()</span></pre><p id="3228" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">上面这段代码在python 2中运行良好，但在python 3中会出错。您可以对其进行如下修改，这样它就可以工作了</p><pre class="iy iz ja jb fd lk km ll lm aw ln bi"><span id="adfe" class="lo ko hi km b fi lp lq l lr ls">file = NamedTemporaryFile(mode="w+", delete=False)<br/>file.write("some string")<br/>file.close()</span></pre><p id="6e42" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">类似地，如果您将任何东西作为byte对象传递，而期望的是string，那么代码将会失败。</p><p id="3008" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">为了在python 3中正确处理这个问题，这样的修改应该会有所帮助</p><pre class="iy iz ja jb fd lk km ll lm aw ln bi"><span id="3f1f" class="lo ko hi km b fi lp lq l lr ls">try:<br/>  x = x.decode("utf-8")<br/>except (UnicodeDecodeError, AttributeError):<br/>  pass</span></pre><h2 id="4e2a" class="lo ko hi bd kp mb mc md kt me mf mg kx jw mh mi kz ka mj mk lb ke ml mm ld mn bi translated">还有什么需要注意的吗？</h2><p id="1e84" class="pw-post-body-paragraph jn jo hi jp b jq lf ij js jt lg im jv jw lh jy jz ka li kc kd ke lj kg kh ki hb bi translated">将任何代码库迁移到python 3时所面临的问题可能不仅限于上述场景，它们可能会基于所讨论的代码库收缩或扩展。但是上述场景确实涵盖了迁移过程中可能出现的大量问题。</p><p id="e6d0" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">此外，可能会出现一些与<code class="du kj kk kl km b">Method Order Resolution or (MRO)</code>相关的问题。当一个类派生自多个类时，这就开始起作用了，这也可能对从python 2到python 3的代码库迁移带来挑战。</p><h1 id="7e77" class="kn ko hi bd kp kq kr ks kt ku kv kw kx io ky ip kz ir la is lb iu lc iv ld le bi translated">尾注</h1><p id="9a30" class="pw-post-body-paragraph jn jo hi jp b jq lf ij js jt lg im jv jw lh jy jz ka li kc kd ke lj kg kh ki hb bi translated">通过处理这些场景，人们可以成功地将其代码迁移到Python 3。我在这里要提到的一件事是，拥有一个好的测试套件设置将真正有助于问题的早期检测和解决，也有助于获得对迁移健康状况的信心。</p></div></div>    
</body>
</html>