<html>
<head>
<title>Upload image to AWS S3 (Localstack) using Nest + Typescript.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Nest + Typescript将图像上传到AWS S3 (Localstack)。</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/upload-image-to-aws-s3-localstack-using-nest-typescript-1104bcb5d9ec?source=collection_archive---------4-----------------------#2021-07-26">https://medium.com/geekculture/upload-image-to-aws-s3-localstack-using-nest-typescript-1104bcb5d9ec?source=collection_archive---------4-----------------------#2021-07-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/8ed6d0250548ab4a568f26a14a094d85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NCuR5hFu47zr16tiTtkjzw.png"/></div></div></figure><p id="a05b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">作为一名开发人员，有时你很可能会遇到使用AWS S3桶作为上传文件的存储。这就是我们今天努力要实现的目标。我将带你通过整个流程，让你知道确切的设置/配置，我使用开始存储任何类型的文件在S3。我将在演示中使用Nest.js和Typescript。虽然您可以在S3存储桶中存储任何东西(文本文件、图像、视频、blobs)，但是我们将明确地处理图像，因为我们只想存储图像文件用于演示。</p><p id="a520" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">另外，我们不需要任何access/secret AWS配置密钥，因为我们将使用localstack作为开发环境。如果你不知道的话，Localstack已经基本上帮助我们避免了繁琐的前期工作，这些工作通常是在配置开发环境时进行的，我认为是非常耗时的。如果你真的想拥有访问/秘密密钥，你最好拥有它们。将它们包含在. env文件中，并确保在S3配置提供程序文件中将其提取出来。</p><p id="5220" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">此外，我正在使用<a class="ae jo" href="https://hub.docker.com/r/localstack/localstack" rel="noopener ugc nofollow" target="_blank"> localstack docker映像</a>，它将帮助我支持AWS云服务，如S3。如果您还没有localstack docker映像，那么请继续操作。一旦你安装了它，你就可以继续运行了。如果你在寻找能帮助你安装和配置localstack的指南，你可以访问他们的<a class="ae jo" href="https://github.com/localstack/localstack" rel="noopener ugc nofollow" target="_blank"> Github </a>。</p><h2 id="6541" class="jp jq hi bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">安装localstack的快速步骤</h2><ul class=""><li id="d372" class="kk kl hi is b it km ix kn jb ko jf kp jj kq jn kr ks kt ku bi translated">为您的系统下载Docker桌面。你可以在这里找到可下载的文件<a class="ae jo" href="https://www.docker.com/products/docker-desktop" rel="noopener ugc nofollow" target="_blank"/>。</li><li id="8428" class="kk kl hi is b it kv ix kw jb kx jf ky jj kz jn kr ks kt ku bi translated">从Docker Hub中提取localstack docker映像。你可以在这里找到图片<a class="ae jo" href="https://hub.docker.com/r/localstack/localstack" rel="noopener ugc nofollow" target="_blank">。</a></li></ul><h2 id="542b" class="jp jq hi bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">S3配置提供程序</h2><p id="bb4e" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb la jd je jf lb jh ji jj lc jl jm jn hb bi translated">我们有S3配置提供商，它可以完成我们开始所需的所有设置。因为我们实际上不需要任何真正的访问/秘密密钥，我们可以像这样硬编码密钥，或者如果您有密钥，请确保从。环境文件。我们现在有了具有所需配置的S3对象。我们有getS3()和getBucketName()方法来导出S3对象和存储桶的名称，以便在项目中的任何地方使用。</p><figure class="ld le lf lg fd ij"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="8186" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">另外，确保运行一次createBucket()方法，为您创建一个名为<strong class="is hj"> testBucket </strong>的bucket。您可以利用最后一行来创建一个存储桶。</p><h2 id="5384" class="jp jq hi bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">定义DTO</h2><p id="6edc" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb la jd je jf lb jh ji jj lc jl jm jn hb bi translated">让我们定义图像文件对象的DTO，以及将图像上传到S3后我们将收到的响应对象。</p><figure class="ld le lf lg fd ij"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="012e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们都准备好了DTO。现在，我们可以继续定义将在控制器中处理HTTP POST请求的唯一路由。</p><h2 id="07af" class="jp jq hi bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">控制器类别</h2><p id="ac20" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb la jd je jf lb jh ji jj lc jl jm jn hb bi translated">在控制器文件中，我们定义了路由或路径前缀<strong class="is hj"> /upload </strong>，负责将图像文件上传到S3。我们使用文件拦截器只拦截带有特定键的文件。下面的<strong class="is hj"> upload </strong>方法将通过调用服务文件内部的upload方法将剩余的操作委托给服务文件，该方法执行将映像上传到S3所需的逻辑。</p><figure class="ld le lf lg fd ij"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="9400" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">控制器的主要目标是处理对其端点之一的传入请求，并将响应返回给客户端。这里，我们最后返回一个响应成功/错误对象，通知图像是否上传。现在让我们编写逻辑，在服务类中将图像上传到S3。</p><h2 id="b189" class="jp jq hi bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">服务级别</h2><p id="5ba5" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb la jd je jf lb jh ji jj lc jl jm jn hb bi translated">服务类(ImageUploadService)负责将图像上传到S3，并设计为由UploadImageController使用。我们这里有一个基本的服务类。它创建了一个S3提供者的实例来获取实际的S3对象，以在其上执行上传操作。</p><p id="14b7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">服务类或提供者的本质是组织并与应用程序中的多个组件共享业务逻辑、数据或功能。</p><figure class="ld le lf lg fd ij"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="a69c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们最终根据操作是否成功返回一个带有resolve/reject对象的承诺。下一步是将控制器和服务文件捆绑在一起。模块通常用于将与应用程序相关的组件和服务组合在一起。让我们使用模块类来实现它。</p><h2 id="2302" class="jp jq hi bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">模块类</h2><p id="3fa3" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb la jd je jf lb jh ji jj lc jl jm jn hb bi translated"><strong class="is hj"> UploadImageModule </strong>类使用我们之前创建的控制器和提供者文件创建一个模块。我们在项目中创建的每个模块都可以共享。例如，如果我们有另一个模块导入了<strong class="is hj"> UploadImageModule </strong>，那么它将可以访问<strong class="is hj"> UploadImageService </strong>及其方法。</p><figure class="ld le lf lg fd ij"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="29c0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后一步是将这个模块(UploadImageModule)导入到根应用程序模块中。让我们就这样做最后一步。</p><figure class="ld le lf lg fd ij"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="4c7d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一旦我们将UploadImageModule导入到根AppModule，我们就可以测试应用程序了。我们将使用<a class="ae jo" href="https://www.thunderclient.io" rel="noopener ugc nofollow" target="_blank"> Thunder Client </a> VSCode扩展来测试端点。在启动Thunder客户端之前，确保使用以下命令运行Nest服务器和localstack:</p><figure class="ld le lf lg fd ij"><div class="bz dy l di"><div class="lh li l"/></div></figure><figure class="ld le lf lg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lj"><img src="../Images/522054ab8c7a3ede3d22fde95354563c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FIbjc-j4ImrnXHYg3CRLyg.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx">Thunder Client (Testing the `/upload` endpoint)</figcaption></figure><p id="7c86" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">从上面的图片中我们可以看到，我们收到了一个响应，返回的数据对象包含上传到S3的图片的链接(URL)。现在可以从URL访问该图像。好了，我们现在终于实现了一个将图像文件上传到S3桶的服务。</p><p id="57b1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">谢谢你留下来。</p><h2 id="3e5b" class="jp jq hi bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">参考</h2><ul class=""><li id="a139" class="kk kl hi is b it km ix kn jb ko jf kp jj kq jn kr ks kt ku bi translated"><a class="ae jo" href="https://docs.nestjs.com" rel="noopener ugc nofollow" target="_blank"> NestJS文档</a></li><li id="2b46" class="kk kl hi is b it kv ix kw jb kx jf ky jj kz jn kr ks kt ku bi translated"><a class="ae jo" href="https://localstack.cloud" rel="noopener ugc nofollow" target="_blank">本地堆栈</a></li><li id="3ee8" class="kk kl hi is b it kv ix kw jb kx jf ky jj kz jn kr ks kt ku bi translated"><a class="ae jo" href="https://www.onixnet.com/insights/aws-101-what-is-amazon-s3-and-why-should-i-use-it" rel="noopener ugc nofollow" target="_blank"> S3 101 </a>:什么是S3，我为什么要用它？</li><li id="55e8" class="kk kl hi is b it kv ix kw jb kx jf ky jj kz jn kr ks kt ku bi translated"><a class="ae jo" href="https://aws.amazon.com/s3/" rel="noopener ugc nofollow" target="_blank"> AWS S3 </a>官网</li></ul></div></div>    
</body>
</html>