<html>
<head>
<title>How to monitor Docker metrics using Prometheus &amp; Grafana?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Prometheus &amp; Grafana监控Docker指标？</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/how-to-monitor-docker-metrics-using-prometheus-grafana-707b970f1f06?source=collection_archive---------1-----------------------#2022-03-01">https://medium.com/geekculture/how-to-monitor-docker-metrics-using-prometheus-grafana-707b970f1f06?source=collection_archive---------1-----------------------#2022-03-01</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="4983" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">普罗米修斯是什么？<br/> </strong> Prometheus是一款开源监控工具，主要用于指标监控、事件监控、告警配置等。Prometheus设计用于监控目标、服务器、数据库、独立虚拟机等。Prometheus使用一种叫做<strong class="ih hj">“PromQL”的强大查询语言。</strong></p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/bcf02159b545b240d96abebafb7839d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/format:webp/0*bHDXSq1hu0P_1BIV.png"/></div><figcaption class="jl jm et er es jn jo bd b be z dx">Prometheus Logo</figcaption></figure><p id="a098" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">普罗米修斯配置文件和组件:</strong></p><ul class=""><li id="cc02" class="jp jq hi ih b ii ij im in iq jr iu js iy jt jc ju jv jw jx bi translated"><strong class="ih hj"> prometheus.yml:- </strong>这是prometheus的配置文件，我们可以在其中对Prometheus的配置进行所有更改。</li><li id="9dca" class="jp jq hi ih b ii jy im jz iq ka iu kb iy kc jc ju jv jw jx bi translated"><strong class="ih hj"> Promtool:- </strong>它是用于验证Prometheus配置的命令行实用工具。</li><li id="667b" class="jp jq hi ih b ii jy im jz iq ka iu kb iy kc jc ju jv jw jx bi translated"><strong class="ih hj"> PromQL:- </strong>它是Prometheus使用的强查询语言。</li></ul><p id="6743" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">Grafana是什么？Grafana是一个免费的开源可视化工具，它为特定的数据源提供了各种仪表板、图表、图形和警告。Grafana允许我们查询、可视化、探索指标并为数据源设置警报。我们还可以创建自己的动态仪表板进行可视化和监控。我们可以保存仪表板，并与其他成员共享。我们还可以导入外部仪表板。</strong></p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es kd"><img src="../Images/70b3d838c16cccc4af21df9edc4d1114.png" data-original-src="https://miro.medium.com/v2/resize:fit:630/format:webp/0*IEHOGoscNk4m0QTI.png"/></div><figcaption class="jl jm et er es jn jo bd b be z dx">Grafana Logo</figcaption></figure><p id="d3ef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本教程中，我们将使用<strong class="ih hj"> Prometheus </strong>和<strong class="ih hj"> Grafana </strong>监控各种docker指标</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es ke"><img src="../Images/cebfe1a9ec92a6905ddee82d67e671ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1324/format:webp/1*AgztDdk2vJNJzZ4RdrG36g.png"/></div><figcaption class="jl jm et er es jn jo bd b be z dx">Docker metrics monitoring with Prometheus &amp; Grafana</figcaption></figure><p id="3eda" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">先决条件:- </strong></p><ul class=""><li id="3053" class="jp jq hi ih b ii ij im in iq jr iu js iy jt jc ju jv jw jx bi translated"><strong class="ih hj">普罗米修斯</strong> &amp; <strong class="ih hj">格拉夫纳</strong>的基本概况</li><li id="89ca" class="jp jq hi ih b ii jy im jz iq ka iu kb iy kc jc ju jv jw jx bi translated">AWS帐户</li><li id="3b47" class="jp jq hi ih b ii jy im jz iq ka iu kb iy kc jc ju jv jw jx bi translated">一个安装了<strong class="ih hj"> Docker </strong>和一些<strong class="ih hj">容器</strong>的服务器</li></ul><p id="c5d8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，让我们开始配置项目。</p><p id="a677" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤1:-创建服务器</strong></p><ul class=""><li id="c362" class="jp jq hi ih b ii ij im in iq jr iu js iy jt jc ju jv jw jx bi translated">在本教程中，我已经创建了Ubuntu 20.04 AMI的服务器</li><li id="08e9" class="jp jq hi ih b ii jy im jz iq ka iu kb iy kc jc ju jv jw jx bi translated">在<strong class="ih hj"> AWS </strong>中创建<strong class="ih hj"> Ubuntu 20.04 </strong>服务器。在这个服务器中，我们将安装普罗米修斯</li><li id="3e44" class="jp jq hi ih b ii jy im jz iq ka iu kb iy kc jc ju jv jw jx bi translated">对于<strong class="ih hj"> Prometheus &amp; Grafana </strong>服务器，我们需要为SSH打开<strong class="ih hj">9090</strong>&amp;<strong class="ih hj">3000</strong>port&amp;port<strong class="ih hj">22</strong></li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es kf"><img src="../Images/0a5041de90a7ae737cba73f17290a493.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JyW0t80o_5ykVYUgFrnIAQ.jpeg"/></div></div><figcaption class="jl jm et er es jn jo bd b be z dx">Servers</figcaption></figure><p id="c092" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤2:-安装普罗米修斯</strong></p><ul class=""><li id="2cd8" class="jp jq hi ih b ii ij im in iq jr iu js iy jt jc ju jv jw jx bi translated">从这个<a class="ae kk" href="https://prometheus.io/download/#node_exporter" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">链接</strong>下载Prometheus并安装在服务器上。</a></li><li id="798c" class="jp jq hi ih b ii jy im jz iq ka iu kb iy kc jc ju jv jw jx bi translated">为了启动普罗米修斯，我们需要在普罗米修斯目录中运行<code class="du kl km kn ko b">./prometheus</code></li><li id="7b9e" class="jp jq hi ih b ii jy im jz iq ka iu kb iy kc jc ju jv jw jx bi translated">我们可以在<strong class="ih hj"> &lt;公共IP:9090 &gt; </strong>查看<strong class="ih hj">普罗米修斯</strong>的UI</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div class="ab fe cl kp"><img src="../Images/f04882f3fd6a5bc9bce602594858dfe6.png" data-original-src="https://miro.medium.com/v2/format:webp/0*85G63Q8jh-sTK3OY.jpeg"/></div><figcaption class="jl jm et er es jn jo bd b be z dx">Prometheus UI</figcaption></figure><p id="a03e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤3:-安装Grafana </strong></p><ul class=""><li id="b0e5" class="jp jq hi ih b ii ij im in iq jr iu js iy jt jc ju jv jw jx bi translated">从这个<a class="ae kk" href="https://prometheus.io/download/#node_exporter" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">链接</strong> </a>下载Grafana并安装在我们安装Prometheus的同一台服务器上</li><li id="92a3" class="jp jq hi ih b ii jy im jz iq ka iu kb iy kc jc ju jv jw jx bi translated">为了启动Grafana，我们需要从Grafana目录运行<code class="du kl km kn ko b">./bin/grafana-server</code>命令</li><li id="075c" class="jp jq hi ih b ii jy im jz iq ka iu kb iy kc jc ju jv jw jx bi translated">当你第一次打开Grafana的用户界面时，它会要求输入用户名和密码。默认用户名和密码是<strong class="ih hj"> admin。</strong>您可以稍后更改密码</li><li id="0a71" class="jp jq hi ih b ii jy im jz iq ka iu kb iy kc jc ju jv jw jx bi translated">我们可以在<strong class="ih hj"> &lt;公共IP: 3000 &gt; </strong>查看Grafana的UI</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es kq"><img src="../Images/1f40ec4a05259b7a46000783f0b38429.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*r0kBUyI0RciSDm0c.jpeg"/></div></div><figcaption class="jl jm et er es jn jo bd b be z dx">Grafana UI</figcaption></figure><p id="7a29" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤4:-修改daemon.json文件</strong></p><ul class=""><li id="c2e0" class="jp jq hi ih b ii ij im in iq jr iu js iy jt jc ju jv jw jx bi translated">为了让Prometheus收集docker的指标，我们需要在docker服务器的<code class="du kl km kn ko b">/etc/docker/daemon.json</code>文件中添加下面的节。</li></ul><pre class="je jf jg jh fd kr ko ks kt aw ku bi"><span id="cfb2" class="kv kw hi ko b fi kx ky l kz la">{<br/>  "metrics-addr" : "127.0.0.1:9323",<br/>  "experimental" : true<br/>}</span></pre><ul class=""><li id="a1c8" class="jp jq hi ih b ii ij im in iq jr iu js iy jt jc ju jv jw jx bi translated"><strong class="ih hj"> 9323 </strong>是普罗米修斯收集指标的端口</li><li id="ad47" class="jp jq hi ih b ii jy im jz iq ka iu kb iy kc jc ju jv jw jx bi translated">添加完上面的部分后，我们需要使用下面的命令重启docker</li></ul><pre class="je jf jg jh fd kr ko ks kt aw ku bi"><span id="8aa1" class="kv kw hi ko b fi kx ky l kz la">systemctl restart docker</span></pre><ul class=""><li id="5309" class="jp jq hi ih b ii ij im in iq jr iu js iy jt jc ju jv jw jx bi translated">我们可以在<strong class="ih hj"> &lt;公共IP:9393/metrics &gt; </strong>查看不同的指标</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es lb"><img src="../Images/3b06e63432d5ff26e174c1cec81ce559.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rzqXziFTBIFG0gjFnzfzow.png"/></div></div><figcaption class="jl jm et er es jn jo bd b be z dx">Metrics</figcaption></figure><ul class=""><li id="5ca4" class="jp jq hi ih b ii ij im in iq jr iu js iy jt jc ju jv jw jx bi translated">如果上面的设置不起作用，那么我们也可以在<code class="du kl km kn ko b">daemon.json</code>文件中添加下面的部分。</li></ul><pre class="je jf jg jh fd kr ko ks kt aw ku bi"><span id="22d5" class="kv kw hi ko b fi kx ky l kz la">{<br/>  "metrics-addr" : "0.0.0.1:9323",<br/>  "experimental" : true<br/>}</span></pre><p id="0bec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤5:-修改普罗米修斯的配置文件</strong></p><ul class=""><li id="0585" class="jp jq hi ih b ii ij im in iq jr iu js iy jt jc ju jv jw jx bi translated">Prometheus管理名为<strong class="ih hj"> prometheus.yml </strong>的配置文件，我们可以在其中定义各种配置，如<strong class="ih hj">警报、scrape_configs </strong>等。</li><li id="1ba2" class="jp jq hi ih b ii jy im jz iq ka iu kb iy kc jc ju jv jw jx bi translated">为了让Prometheus收集Docker节点的指标，我们需要在<strong class="ih hj"> scrape_configs </strong>节下的<strong class="ih hj"> prometheus.yml </strong>中定义以下代码</li></ul><pre class="je jf jg jh fd kr ko ks kt aw ku bi"><span id="fe98" class="kv kw hi ko b fi kx ky l kz la">- job_name: "Docker Job"<br/>  static_configs:<br/>    - targets: ["&lt;Public IP of Docker Node:9323"]</span></pre><ul class=""><li id="6cb2" class="jp jq hi ih b ii ij im in iq jr iu js iy jt jc ju jv jw jx bi translated">添加代码后，我们可以在Prometheus中将我们的节点作为目标进行检查。Prometheus需要一些时间来收集所有指标并显示节点到<strong class="ih hj"> Up </strong>的状态。</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es lb"><img src="../Images/ddb6c2ae9d1e095c6be575c0fb206c60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*36htebXfV6yRtHYu-sYlLw.png"/></div></div><figcaption class="jl jm et er es jn jo bd b be z dx">Targets</figcaption></figure><p id="ee50" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤6:-在Grafana中添加数据源</strong></p><ul class=""><li id="fda0" class="jp jq hi ih b ii ij im in iq jr iu js iy jt jc ju jv jw jx bi translated">现在，在Grafana中，我们需要添加Prometheus作为数据源</li><li id="ef50" class="jp jq hi ih b ii jy im jz iq ka iu kb iy kc jc ju jv jw jx bi translated">之后，在的URL部分我们需要输入Prometheus服务器的IP地址和<strong class="ih hj"> 9090 </strong>端口</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es kq"><img src="../Images/d8b07ad0e1d0d3bbf0c10fd6ee6a4bcd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*w6rYjyUhaivTIvHR.jpeg"/></div></div><figcaption class="jl jm et er es jn jo bd b be z dx">Data Sources</figcaption></figure><p id="d627" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第7步:-创建仪表板</strong></p><ul class=""><li id="2716" class="jp jq hi ih b ii ij im in iq jr iu js iy jt jc ju jv jw jx bi translated">在Grafana中，我们可以根据需要创建各种仪表板。</li><li id="adc4" class="jp jq hi ih b ii jy im jz iq ka iu kb iy kc jc ju jv jw jx bi translated">因此，在本教程中，我们将创建一个包含3个面板的仪表板。</li><li id="7a91" class="jp jq hi ih b ii jy im jz iq ka iu kb iy kc jc ju jv jw jx bi translated">第一个面板将显示<strong class="ih hj">运行容器</strong>的数量，第二个面板将显示<strong class="ih hj">暂停容器</strong>的数量，最后一个面板将显示<strong class="ih hj">停止容器</strong>的数量。</li><li id="af9a" class="jp jq hi ih b ii jy im jz iq ka iu kb iy kc jc ju jv jw jx bi translated">点击<strong class="ih hj">创建</strong> - &gt;添加<strong class="ih hj">面板</strong></li><li id="06a5" class="jp jq hi ih b ii jy im jz iq ka iu kb iy kc jc ju jv jw jx bi translated">在“指标浏览器”部分，在下面添加查询。以下查询将获取<strong class="ih hj">停止集装箱</strong>的数量。</li></ul><pre class="je jf jg jh fd kr ko ks kt aw ku bi"><span id="8c68" class="kv kw hi ko b fi kx ky l kz la">engine_daemon_container_states_containers{state="stopped"}</span></pre><ul class=""><li id="3de3" class="jp jq hi ih b ii ij im in iq jr iu js iy jt jc ju jv jw jx bi translated">您可以将可视化更改为<strong class="ih hj">状态</strong></li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es lb"><img src="../Images/731a14f72f54cc72e8600c227eb02259.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tK6yxUJrcOPMUOsVr7r7Jw.png"/></div></div><figcaption class="jl jm et er es jn jo bd b be z dx">Stopped Containers</figcaption></figure><ul class=""><li id="ace7" class="jp jq hi ih b ii ij im in iq jr iu js iy jt jc ju jv jw jx bi translated">点击<strong class="ih hj">添加面板</strong>添加第二个面板</li><li id="8f97" class="jp jq hi ih b ii jy im jz iq ka iu kb iy kc jc ju jv jw jx bi translated">在“指标浏览器”部分，在下面添加查询。以下查询将获取<strong class="ih hj">暂停集装箱</strong>的数量</li></ul><pre class="je jf jg jh fd kr ko ks kt aw ku bi"><span id="0c8f" class="kv kw hi ko b fi kx ky l kz la">engine_daemon_container_states_containers{state="paused"}</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es lb"><img src="../Images/6cf5c61b40091fab679a4bd295bcd2a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p5N66_BKN-ZAxyB7eEhWuA.png"/></div></div><figcaption class="jl jm et er es jn jo bd b be z dx">Paused containers</figcaption></figure><ul class=""><li id="9dd0" class="jp jq hi ih b ii ij im in iq jr iu js iy jt jc ju jv jw jx bi translated">点击<strong class="ih hj">添加面板</strong>添加第二个面板</li><li id="904f" class="jp jq hi ih b ii jy im jz iq ka iu kb iy kc jc ju jv jw jx bi translated">在“指标浏览器”部分，在下面添加查询。下面的查询将获取正在运行的容器<strong class="ih hj">的数量</strong></li></ul><pre class="je jf jg jh fd kr ko ks kt aw ku bi"><span id="e327" class="kv kw hi ko b fi kx ky l kz la">engine_daemon_container_states_containers{state="running"}</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es lb"><img src="../Images/6eb27ca71427856038009d5dc85fb81a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1TKxcIuK-Lf9IiGGuheMmQ.png"/></div></div><figcaption class="jl jm et er es jn jo bd b be z dx">Running Containers</figcaption></figure><ul class=""><li id="c492" class="jp jq hi ih b ii ij im in iq jr iu js iy jt jc ju jv jw jx bi translated">单击“保存仪表板”按钮保存仪表板，并为其选择一个名称</li><li id="79d0" class="jp jq hi ih b ii jy im jz iq ka iu kb iy kc jc ju jv jw jx bi translated">仪表板的最终结果将如下所示:</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es lb"><img src="../Images/edfcb4a34f62c05c58fd5020ab0fca64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XQ1px0TVKwa3BUKANAtJpA.png"/></div></div><figcaption class="jl jm et er es jn jo bd b be z dx">Dashboard</figcaption></figure><ul class=""><li id="d12b" class="jp jq hi ih b ii ij im in iq jr iu js iy jt jc ju jv jw jx bi translated">您可以更改仪表板自动加载的时间频率。在我的例子中，我将它设置为5m。</li></ul><p id="95a1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就是这样。您已经学习了如何使用<strong class="ih hj"> Prometheus </strong>和<strong class="ih hj"> Grafana </strong>监控Docker指标。</p><p id="2720" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以通过访问下面的网址来探索更多关于普罗米修斯和格拉夫纳的信息。</p><ul class=""><li id="e3c5" class="jp jq hi ih b ii ij im in iq jr iu js iy jt jc ju jv jw jx bi translated"><a class="ae kk" href="https://prometheus.io/docs/introduction/overview/" rel="noopener ugc nofollow" target="_blank">https://prometheus.io/docs/introduction/overview/</a></li><li id="de53" class="jp jq hi ih b ii jy im jz iq ka iu kb iy kc jc ju jv jw jx bi translated"><a class="ae kk" href="https://grafana.com/" rel="noopener ugc nofollow" target="_blank">https://grafana.com/</a></li></ul><p id="830c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您发现此指南有帮助，请点击👏按钮，也可以随意发表评论。</p><p id="df1b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">关注更多类似的故事😊</p></div></div>    
</body>
</html>