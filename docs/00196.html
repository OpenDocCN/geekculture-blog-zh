<html>
<head>
<title>Observability on K8s — Monitor Kubernetes Clusters with DataDog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">K8s上的可观测性——用DataDog监控Kubernetes星团</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/observability-on-k8s-monitor-kubernetes-clusters-with-datadog-14c597def537?source=collection_archive---------0-----------------------#2020-10-17">https://medium.com/geekculture/observability-on-k8s-monitor-kubernetes-clusters-with-datadog-14c597def537?source=collection_archive---------0-----------------------#2020-10-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/8c2908c543f8624ac80da361c173ff03.png" data-original-src="https://miro.medium.com/v2/resize:fit:924/format:webp/1*FmIQFcLv3DRxlxGmvunefA.jpeg"/></div><figcaption class="im in et er es io ip bd b be z dx">The screenshot has taken in the DataDog integrations console</figcaption></figure><p id="4a99" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当您为您的团队管理超过10个Kubernetes (EKS)集群，并且在这些集群上运行一些关键应用程序时，您将需要建立一个具有监控、日志记录和跟踪功能的可观察性堆栈。</p><p id="723e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这篇博客中，我将分享我们如何建立一个监控系统，设置一个仪表板，并使用DataDog监控我们的K8s基础设施。</p></div><div class="ab cl jo jp gp jq" role="separator"><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt"/></div><div class="hb hc hd he hf"><h1 id="d410" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">为什么是DataDog？</h1><p id="3e25" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn hb bi translated">有许多可观察性工具或平台，既有开源的也有订阅的，但我为我的博客选择了DataDog，因为我发现它广泛支持多种平台(AWS、Azure、GCP、on-premise等)。)和应用程序，以及它与Kubernetes或Prometheus metrics的兼容性。还有，主要是我是(数据)狗的粉丝。</p><p id="9178" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以查看<a class="ae ky" href="https://docs.datadoghq.com/integrations/" rel="noopener ugc nofollow" target="_blank"> DataDog内置集成</a>的列表，或者参考他们的<a class="ae ky" href="https://github.com/DataDog/integrations-core" rel="noopener ugc nofollow" target="_blank">集成-核心</a>并编写自己的脚本。</p><h1 id="8092" class="jv jw hi bd jx jy kz ka kb kc la ke kf kg lb ki kj kk lc km kn ko ld kq kr ks bi translated">要求</h1><ul class=""><li id="97ef" class="le lf hi is b it kt ix ku jb lg jf lh jj li jn lj lk ll lm bi translated">K8s，Docker，DataDog的基础知识。</li><li id="55ca" class="le lf hi is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm bi translated">正在运行的AWS EKS集群的管理员权限。你可以去https://eksworkshop.com学习如何设置。</li><li id="d57b" class="le lf hi is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm bi translated"><em class="ls"> kubectl </em>管理K8s集群(<a class="ae ky" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" rel="noopener ugc nofollow" target="_blank">https://kubernetes.io/docs/tasks/tools/install-kubectl/</a>)。</li><li id="8081" class="le lf hi is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm bi translated"><em class="ls">掌舵v2 </em>安装图表中的数据狗。</li></ul><p id="76ce" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">出于某种原因，在这篇博客中，我将使用来自稳定库和版本<strong class="is hj"> 1.39.9 </strong>的<a class="ae ky" href="https://github.com/helm/charts/tree/master/stable/datadog" rel="noopener ugc nofollow" target="_blank">数据狗头盔图。从版本<strong class="is hj"> 2.x.x </strong>开始，DataDog Helm Chart已经重构并移动到</a><a class="ae ky" href="https://github.com/DataDog/helm-charts" rel="noopener ugc nofollow" target="_blank">其官方回购</a>，但概念是相同的。</p><h1 id="c9d8" class="jv jw hi bd jx jy kz ka kb kc la ke kf kg lb ki kj kk lc km kn ko ld kq kr ks bi translated">部署</h1><p id="3b08" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn hb bi translated">我已经为DataDog部署生成了如下示例values.yaml:</p><figure class="lt lu lv lw fd ij"><div class="bz dy l di"><div class="lx ly l"/></div></figure><p id="2b81" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我在本教程中使用了EKS集群，因此您可以看到定义为<code class="du lz ma mb mc b">cloud:aws</code>和<code class="du lz ma mb mc b">distribution:eks</code>的标签，并按照以下约定将我的集群命名为<code class="du lz ma mb mc b">&lt;env&gt;-&lt;platform&gt;-&lt;category&gt;-xxx</code>，即<code class="du lz ma mb mc b">dev-eks-datadog-001</code>。</p><p id="349e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当您为核心基础架构设计和设置监控系统时，标签或标记非常重要，它将帮助您轻松地组织、分组、过滤或集中您的数据，以排除故障并了解您的环境。稍后，我将在仪表板和监视器部分分享更多示例。</p><p id="ec69" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用<em class="ls">舵</em>部署数据狗:</p><pre class="lt lu lv lw fd md mc me mf aw mg bi"><span id="cc27" class="mh jw hi mc b fi mi mj l mk ml">➜  ~ helm install --name datadog --namespace monitoring -f datadog-k8s-values.yaml --set datadog.apiKey=&lt;API_KEY&gt; --set datadog.appKey=&lt;APPLICATION_KEY&gt; --version=1.39.9 stable/datadog</span></pre><p id="8ea4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当<em class="ls">掌舵</em>命令完成后，你会看到一些类似如下的东西:</p><pre class="lt lu lv lw fd md mc me mf aw mg bi"><span id="04c6" class="mh jw hi mc b fi mi mj l mk ml">➜  ~ kubectl get pods -n monitoring --no-headers | grep datadog<br/>datadog-2tspw                                   1/1   Running   0     2m<br/>datadog-6bd328d579-tj8lp                        1/1   Running   0     2m33s<br/>datadog-cluster-agent-54hv37f8fb-cgp2f          1/1   Running   0     2m23s<br/>datadog-kube-state-metrics-56gre5ft89-lx8e9     1/1   Running   0     1m56s<br/>datadog-pvltl                                   1/1   Running   0     2m55s<br/>datadog-qtlh9                                   1/1   Running   0     3m12s<br/>➜  ~ kubectl get svc --no-headers | grep datadog<br/>datadog                             ClusterIP      172.20.6.24    &lt;none&gt;   8125/UDP     2m<br/>datadog-cluster-agent               ClusterIP      172.20.10.15   &lt;none&gt;   5005/TCP     2m<br/>datadog-cluster-agent-metrics-api   ClusterIP      172.20.12.27   &lt;none&gt;   443/TCP      2m<br/>datadog-kube-state-metrics          ClusterIP      172.20.24.17   &lt;none&gt;   8080/TCP     2m<br/>➜  ~ kubectl get deployments --no-headers | grep datadog<br/>datadog                             1/1   1     1     3m<br/>datadog-cluster-agent               1/1   1     1     3m<br/>datadog-kube-state-metrics          1/1   1     1     3m<br/>➜  ~ kubectl get daemonsets --no-headers | grep datadog<br/>datadog    3     3     3     3     3     &lt;none&gt;   3m</span></pre><p id="d011" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以看到DataDog部署了3个主要组件:</p><ul class=""><li id="9fea" class="le lf hi is b it iu ix iy jb mm jf mn jj mo jn lj lk ll lm bi translated">数据狗特工达蒙塞特。</li><li id="c8c8" class="le lf hi is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm bi translated">数据狗集群代理。</li><li id="70ad" class="le lf hi is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm bi translated">DataDog Kube-state-metrics (KSM):这是一个简单的服务，它侦听Kubernetes API服务器并生成关于对象状态的度量:节点状态、节点容量(CPU和内存)、每个部署所需/可用/不可用/更新的副本数量、pod状态(例如，等待、运行、就绪)等等。</li></ul><p id="474b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了理解数据狗代理和集群代理，让我解释一下旧的和当前的数据狗设计，这可以在<a class="ae ky" href="https://www.datadoghq.com/blog/datadog-cluster-agent/" rel="noopener ugc nofollow" target="_blank">他们的官方文件</a>中找到。</p><figure class="lt lu lv lw fd ij er es paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="er es mp"><img src="../Images/e9dadc5ec023c952c7e14bddc9d7a3b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dsXl8YRWon2AcrZ6dBOMCQ.jpeg"/></div></div><figcaption class="im in et er es io ip bd b be z dx">Without Cluster Agent diagram on <a class="ae ky" href="https://www.datadoghq.com/blog/datadog-cluster-agent/" rel="noopener ugc nofollow" target="_blank">DataDog</a></figcaption></figure><p id="b097" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以从上图中看到，在没有集群代理的情况下，集群中的每个工作节点都运行一个代理pod，它从两个主要来源收集数据:</p><ul class=""><li id="8577" class="le lf hi is b it iu ix iy jb mm jf mn jj mo jn lj lk ll lm bi translated">库伯莱:</li></ul><blockquote class="mu mv mw"><p id="1146" class="iq ir ls is b it iu iv iw ix iy iz ja mx jc jd je my jg jh ji mz jk jl jm jn hb bi translated">通过监视每个worker节点上的kubelet，Datadog代理可以让您深入了解容器的行为，并帮助您跟踪与调度相关的问题。代理还检索系统级数据，并且<a class="ae ky" href="https://www.datadoghq.com/blog/autodiscovery-docker-monitoring/" rel="noopener ugc nofollow" target="_blank">自动发现和监控节点上运行的应用</a>。</p></blockquote><ul class=""><li id="5a9b" class="le lf hi is b it iu ix iy jb mm jf mn jj mo jn lj lk ll lm bi translated"><em class="ls">集群的控制平面</em>，由API服务器、调度器、控制器管理器等组成。</li></ul><blockquote class="mu mv mw"><p id="da02" class="iq ir ls is b it iu iv iw ix iy iz ja mx jc jd je my jg jh ji mz jk jl jm jn hb bi translated">除了收集这些节点级别的指标之外，每个Datadog代理还单独查询主节点上的API服务器，以收集关于特定Kubernetes组件的行为的数据，以及收集关于整个集群的关键元数据。</p><p id="d865" class="iq ir ls is b it iu iv iw ix iy iz ja mx jc jd je my jg jh ji mz jk jl jm jn hb bi translated">每个代理还检索以该特定节点上调度的pod为目标的服务列表，使用该数据将相关的应用度量映射到服务，然后用适当的pod名称和服务标记每个度量。代理还可以被配置为选举一个领导者，该领导者定期查询API服务器以收集Kubernetes事件。</p></blockquote><p id="964f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">由于旧方法让您可以看到集群的所有层，当集群规模增加时，它会增加<em class="ls"> API服务器</em>和<em class="ls"> etcd </em>的负载。</p><p id="bcbe" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这就是DataDog开发和推出集群代理的原因，如下图所示:</p><figure class="lt lu lv lw fd ij er es paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="er es mp"><img src="../Images/dfaaf52d3f775e7a5d243834b4d6c0d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Fq1WoG1PG78jC9Ghwr2Edw.jpeg"/></div></div><figcaption class="im in et er es io ip bd b be z dx">With Cluster Agent diagram on <a class="ae ky" href="https://www.datadoghq.com/blog/datadog-cluster-agent/" rel="noopener ugc nofollow" target="_blank">DataDog</a></figcaption></figure><p id="4ec0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">DataDog集群代理的主要功能:</p><ul class=""><li id="4cbe" class="le lf hi is b it iu ix iy jb mm jf mn jj mo jn lj lk ll lm bi translated">提供一种简化的集中式方法来收集集群级监控数据。</li><li id="99cd" class="le lf hi is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm bi translated">通过充当API服务器和基于节点的代理之间的代理，集群代理有助于减轻服务器负载。</li><li id="65cf" class="le lf hi is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm bi translated">将集群级元数据中继到基于节点的代理，允许它们丰富本地收集的指标的元数据。</li></ul><p id="9000" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用Datadog集群代理，您可以:</p><ul class=""><li id="7193" class="le lf hi is b it iu ix iy jb mm jf mn jj mo jn lj lk ll lm bi translated">减轻代理对基础设施的影响。</li><li id="0ea1" class="le lf hi is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm bi translated">将基于节点的代理隔离到它们各自的节点，减少RBAC规则，只从kubelet读取度量和元数据。</li><li id="d232" class="le lf hi is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm bi translated">向节点代理提供只能在API服务器中找到的集群级元数据，以便它们丰富本地收集的度量的元数据。</li><li id="c9f9" class="le lf hi is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm bi translated">启用集群级数据的收集，例如服务或SPOF和事件的监控。</li><li id="cc73" class="le lf hi is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm bi translated">利用定制Kubernetes指标的水平pod自动扩展。</li></ul><p id="c288" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">通过这种设置，DataDog代理不需要选举leader pod，集群代理将进行K8s事件收集。</p><p id="af55" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">DataDog cluster-agent还提供了<a class="ae ky" href="https://www.datadoghq.com/blog/autoscale-kubernetes-datadog/" rel="noopener ugc nofollow" target="_blank">外部指标提供者</a>来根据DataDog指标定义HPA(不仅限于CPU/内存利用率)。</p><h1 id="19e0" class="jv jw hi bd jx jy kz ka kb kc la ke kf kg lb ki kj kk lc km kn ko ld kq kr ks bi translated">数据狗事件</h1><p id="c084" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn hb bi translated">在这个设置中，我通过将<em class="ls">data dog-K8s-values . YAML</em>文件中的<code class="du lz ma mb mc b">datadog.leaderElection</code>、<code class="du lz ma mb mc b">datadog.collectEvents</code>和<code class="du lz ma mb mc b">agents.rbac.create</code>选项设置为<code class="du lz ma mb mc b">true</code>，启用了<a class="ae ky" href="https://docs.datadoghq.com/agent/kubernetes/?tab=helm#event-collection" rel="noopener ugc nofollow" target="_blank"> K8s事件集合</a>。</p><p id="28aa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该功能告诉DataDog集群代理从控制平面收集K8s事件，并将它们转发给DataDog。您可以轻松地检查您的集群发生了什么，为什么pod不能被调度，或者排除<strong class="is hj">回退</strong>容器的故障，而不需要<code class="du lz ma mb mc b">kubectl get events</code>或<code class="du lz ma mb mc b">kubectl describe nodes|pods</code>。</p><figure class="lt lu lv lw fd ij er es paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="er es na"><img src="../Images/c9d85259aa5b532ae8c03b3ed9b01a30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*90XMDY0dDGJynrZT3IodNA.jpeg"/></div></div><figcaption class="im in et er es io ip bd b be z dx">K8s events — Backoff</figcaption></figure><p id="e941" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们可以轻松创建仪表板或监视器，以近乎实时的方式观察和通知任何K8s事件。</p><h1 id="fd1f" class="jv jw hi bd jx jy kz ka kb kc la ke kf kg lb ki kj kk lc km kn ko ld kq kr ks bi translated">仪表板</h1><p id="1275" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn hb bi translated">在这一节中，我将分享我自己为所有正在运行的Kubernetes集群(EKS)构建一个公共仪表板的经验。</p><p id="8c91" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我曾经将指标分解为不同的层，并按如下方式分组:</p><ul class=""><li id="1c1c" class="le lf hi is b it iu ix iy jb mm jf mn jj mo jn lj lk ll lm bi translated">云/集群基础设施指标:EC2、RDS、ElastiCache等。</li><li id="6c99" class="le lf hi is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm bi translated">系统指标:操作系统、CPU、内存、磁盘IOps、网络带宽等。</li><li id="434e" class="le lf hi is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm bi translated">编排(K8s)指标:节点状态、部署/副本集/状态集、pod(CPU/Mem)、PVC大小等。</li><li id="182d" class="le lf hi is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm bi translated">应用程序指标:HTTP响应时间、Kafka消费延迟、JVM堆、Logstash事件、Spark作业指标等。</li></ul><p id="cdba" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我创建的一个示例仪表板提供了我团队中所有正在运行的EKS集群的概览:</p><figure class="lt lu lv lw fd ij er es paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="er es nb"><img src="../Images/d84fbd8cab61e86cad11e63bd391a5a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c1SqXHHJNdecLHWBMZe7xA.jpeg"/></div></div><figcaption class="im in et er es io ip bd b be z dx">Cluster-metrics graphs — 1</figcaption></figure><figure class="lt lu lv lw fd ij er es paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="er es nc"><img src="../Images/6972eb9125f0fd772dcca35acb14be22.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7BuL0rx6fg2VVGi3osXddQ.jpeg"/></div></div><figcaption class="im in et er es io ip bd b be z dx">Cluster-metrics graphs — 2</figcaption></figure><p id="4d53" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">DataDog支持配置<em class="ls">模板变量</em>来快速过滤或查询特定标签或属性的指标，例如<code class="du lz ma mb mc b">subaccount</code> (AWS账户)<code class="du lz ma mb mc b">k8s_cluster</code> (K8s集群名称)<code class="du lz ma mb mc b">k8s_node</code> (EC2工作节点)<code class="du lz ma mb mc b">k8s_namespace</code><code class="du lz ma mb mc b">k8s_deployment</code><code class="du lz ma mb mc b">k8s_daemonset</code>等。</p><figure class="lt lu lv lw fd ij er es paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="er es nd"><img src="../Images/01da29f6197887990ad601c5b43af89e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E8a53RadSr_d5lOlxizXUA.jpeg"/></div></div><figcaption class="im in et er es io ip bd b be z dx">DataDog template variables</figcaption></figure><p id="3199" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你会注意到为什么我用两个不同的标签来过滤同一个东西，比如<code class="du lz ma mb mc b">k8s_namespace</code>和<code class="du lz ma mb mc b">k8s_state_namespace</code>。这是因为DataDog收集了<a class="ae ky" href="https://docs.datadoghq.com/agent/kubernetes/data_collected/" rel="noopener ugc nofollow" target="_blank"> 2组指标</a>,并且标记不同:</p><ul class=""><li id="f9f1" class="le lf hi is b it iu ix iy jb mm jf mn jj mo jn lj lk ll lm bi translated"><code class="du lz ma mb mc b">kubernetes.*</code>数据狗代理/集群代理收集指标。</li><li id="17cb" class="le lf hi is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm bi translated"><code class="du lz ma mb mc b">kubernetes_state.*</code>指标从<a class="ae ky" href="https://github.com/kubernetes/kube-state-metrics" rel="noopener ugc nofollow" target="_blank"><em class="ls">Kube-state-metrics</em></a>(KSM)API中收集。</li></ul><p id="bb9c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">除了集群图，我还将系统指标和K8s指标添加到仪表板中，如下所示:</p><figure class="lt lu lv lw fd ij er es paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="er es ne"><img src="../Images/f865ae9037c9f00d1c400f7fcbaef5aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*amfPyVe0QM0aBvbUk6cKLA.jpeg"/></div></div><figcaption class="im in et er es io ip bd b be z dx">System-metrics graphs — 1</figcaption></figure><figure class="lt lu lv lw fd ij er es paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="er es nf"><img src="../Images/905497f51e0c17faaebb08fe7fc15ac3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oYUiRUEdXT4FC_ckAitCvw.jpeg"/></div></div><figcaption class="im in et er es io ip bd b be z dx">K8s-metrics graphs — 1</figcaption></figure><figure class="lt lu lv lw fd ij er es paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="er es ng"><img src="../Images/e941bddeda3410321ce73fbe3f9831bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gnH-YrIZDsWbJ9rjxN6yLA.jpeg"/></div></div><figcaption class="im in et er es io ip bd b be z dx">K8s-metrics graphs — 2</figcaption></figure><p id="c660" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以向您的控制面板添加更多指标，以便对您的基础架构进行更多观察，但是我建议我们划分不同的层(集群/协调器/系统/应用程序/等等)。)到不同的仪表板中。这是因为当您查询巨大的指标子集或巨大的时间范围(1周或1个月)时，您的仪表板UI会变得滞后。</p><h1 id="9700" class="jv jw hi bd jx jy kz ka kb kc la ke kf kg lb ki kj kk lc km kn ko ld kq kr ks bi translated">监视器</h1><p id="a4c3" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn hb bi translated">在创建显示器之前，我通常会考虑一些基本信息:</p><ul class=""><li id="2cad" class="le lf hi is b it iu ix iy jb mm jf mn jj mo jn lj lk ll lm bi translated">当你挑选度量标准时，需要注意什么？(高CPU/Mem、事件丢失、错误率、HTTP响应缓慢、p95/p99等。)</li><li id="faeb" class="le lf hi is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm bi translated">计算指标并设置阈值(最小值/最大值、平均值/总和、前一周/前一天等。).</li><li id="c435" class="le lf hi is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm bi translated">度量标记/标签。</li><li id="3300" class="le lf hi is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm bi translated">故障排除步骤操作手册和日志链接。</li><li id="7865" class="le lf hi is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm bi translated">警报通知(松弛时间、寻呼负荷)。</li></ul><p id="8e49" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">正如我上面提到的，标签或标记很重要，尤其是当我们为核心基础架构设计和设置常见警报时。让我分享一个例子:创建关于名称空间上失败的pod的警报:</p><ul class=""><li id="68fa" class="le lf hi is b it iu ix iy jb mm jf mn jj mo jn lj lk ll lm bi translated">要检查的指标:<code class="du lz ma mb mc b">kubernetes_state.pod.status</code>和<code class="du lz ma mb mc b">phase:failed</code></li></ul><figure class="lt lu lv lw fd ij er es paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="er es nh"><img src="../Images/2b2962b26ee4f7bbc550d3263db193e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*waE_LOYqfWxffKeNYQPRqg.jpeg"/></div></div><figcaption class="im in et er es io ip bd b be z dx">Failed pods alert — 1</figcaption></figure><ul class=""><li id="3cca" class="le lf hi is b it iu ix iy jb mm jf mn jj mo jn lj lk ll lm bi translated"><code class="du lz ma mb mc b">sum by</code> : <code class="du lz ma mb mc b">kubernetes_cluster</code>、<code class="du lz ma mb mc b">cluster_env</code>和<code class="du lz ma mb mc b">namespace</code> —这是因为当集群中的一个名称空间有如此多的故障单元时，随叫随到的工程师需要快速调查根本原因。</li><li id="f495" class="le lf hi is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm bi translated">为监视器设置警报和警告阈值:</li></ul><figure class="lt lu lv lw fd ij er es paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="er es ni"><img src="../Images/758d6785985b7a37579575d673d7a2dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Fc3VE9R5YvQTRvTY9MPvgA.jpeg"/></div></div><figcaption class="im in et er es io ip bd b be z dx">Failed pods alert — 2</figcaption></figure><ul class=""><li id="2a7b" class="le lf hi is b it iu ix iy jb mm jf mn jj mo jn lj lk ll lm bi translated">度量标记/标签:如上所述，我已经在<code class="du lz ma mb mc b">sum by</code>中定义了一个标记列表，DataDog允许我们使用这些变量定义警报消息:</li></ul><figure class="lt lu lv lw fd ij er es paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="er es nj"><img src="../Images/114379a31d41df8f00de6542b53a5710.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rxx8CyXdyZrrOOQXXQ4SuQ.jpeg"/></div></div><figcaption class="im in et er es io ip bd b be z dx">Failed pods alert — 3</figcaption></figure><ul class=""><li id="58e7" class="le lf hi is b it iu ix iy jb mm jf mn jj mo jn lj lk ll lm bi translated">然后，您可以看到如下警告消息:</li></ul><figure class="lt lu lv lw fd ij er es paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="er es nj"><img src="../Images/6f8036c0af4402c215a206707efa8dd8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wEozh92jf6ZRKl5Idl8nuQ.jpeg"/></div></div><figcaption class="im in et er es io ip bd b be z dx">Failed pods alert — 4</figcaption></figure><p id="b220" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du lz ma mb mc b">@slack-k8s-{{cluster_env.name}}-alerts</code>:我们可以简单地将来自不同环境(dev、stage或prd)的警报分散到不同的Slack通道(<code class="du lz ma mb mc b">k8s-dev-alerts</code>或<code class="du lz ma mb mc b">k8s-stg-alerts</code>或<code class="du lz ma mb mc b">k8s-prd-alerts</code>)，并且仅在生产环境中发生故障时才触发针对oncall的page duty(<code class="du lz ma mb mc b">@pagerduty-de-infra</code>)。</p><p id="41de" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对时差的警告示例如下所示:</p><figure class="lt lu lv lw fd ij er es paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="er es nk"><img src="../Images/c3b5857fa19b06aee6dc5fcda3ae4a32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pqx2XGzM4Hpo2ZHRT3rIvA.jpeg"/></div></div><figcaption class="im in et er es io ip bd b be z dx">Failed pods alert — 5</figcaption></figure></div><div class="ab cl jo jp gp jq" role="separator"><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt"/></div><div class="hb hc hd he hf"><h1 id="5add" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">下一步是什么</h1><p id="f6f3" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn hb bi translated">这篇博客是基于我自己在现有的EKS系统上使用DataDog的经验。它在您现有的环境中可能有效，也可能无效。可以访问<a class="ae ky" href="https://docs.datadoghq.com/agent/kubernetes/?tab=helm" rel="noopener ugc nofollow" target="_blank"> DataDog的官方文档</a>了解更多信息。请随意留下评论或问题。</p><p id="d5b4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">希望你喜欢阅读我的博客。下一篇，我会分享一下<a class="ae ky" href="https://tunguyen9889.medium.com/observability-on-k8s-datadog-autodiscovery-and-dogstatsd-3404c605fcb7" rel="noopener"> DataDog自动发现和DogStatsD </a>。</p><div class="nl nm ez fb nn no"><a href="https://about.me/tunguyen9889" rel="noopener  ugc nofollow" target="_blank"><div class="np ab dw"><div class="nq ab nr cl cj ns"><h2 class="bd hj fi z dy nt ea eb nu ed ef hh bi translated">詹姆斯·nguyễn关于我</h2><div class="nv l"><h3 class="bd b fi z dy nt ea eb nu ed ef dx translated">我是新加坡的一名站点可靠性工程师和全职爸爸。看我的博客。</h3></div><div class="nw l"><p class="bd b fp z dy nt ea eb nu ed ef dx translated">关于我</p></div></div><div class="nx l"><div class="ny l nz oa ob nx oc ik no"/></div></div></a></div></div></div>    
</body>
</html>