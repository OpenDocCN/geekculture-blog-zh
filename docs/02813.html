<html>
<head>
<title>Deploy A Locally Trained ML Model In Cloud Using AWS SageMaker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS SageMaker在云中部署本地培训的ML模型</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/84af8989d065?source=collection_archive---------0-----------------------#2021-05-26">https://medium.com/geekculture/84af8989d065?source=collection_archive---------0-----------------------#2021-05-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="1aa2" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">一个初学者指南，一步一步的实践例子。</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/d22f6bb9fc301f4c81c9728393c9ba77.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4kqdFtxylSFstzdw"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Photo by <a class="ae jn" href="https://unsplash.com/@hudsoncrafted?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Debby Hudson</a> on <a class="ae jn" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="d237" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在本文中，我将分享一个例子，说明我们如何使用AWS SageMaker服务在云中部署本地训练的机器学习模型。所谓“本地培训”，我指的是在我们的笔记本电脑中本地培训的ML模型(即AWS云之外)。我将带您经历各个步骤，从训练模型开始，到在AWS云中部署模型，并从本地客户端调用部署以获得预测。</p><h1 id="3e70" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">介绍</h1><p id="6b39" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">如果我们在谷歌上搜索在AWS中部署ML模型的方法，我们会发现相当多的视频和文章谈论在Amazon EC2实例上部署ML模型。他们谈到推出AWS EC2实例来托管我们自己的Flask应用程序和ML模型；其中，客户端(浏览器)将用于将测试数据发送到托管在EC2上的flask服务器，该服务器又调用托管在相同EC2上的模型来获得预测，然后将预测结果发送到客户端。</p><p id="e62d" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">但是这种方法只是使用cloud VM ( EC2)来启动应用程序的另一个通用用例，与ML模型部署没有什么特别的关系。它不使用任何完全托管/无服务器的设施和好处，如AWS SageMaker端点可以为ML推断提供的按需可伸缩性(自动伸缩)。此外，EC2实例在资源使用费用和所涉及的管理工作方面也可能代价高昂。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es lh"><img src="../Images/1d9ca5350cc4ccf1bbfc9179fe198c92.png" data-original-src="https://miro.medium.com/v2/resize:fit:626/format:webp/1*ZejLfJ8KS3MpNZBUGsTYJw.png"/></div></figure><p id="8b48" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj"> AWS SageMaker </strong>通过推理管道、批量转换、多模型端点、生产变量的A/B测试、超参数调整、自动缩放等工具，提供了更好的方法来训练、测试和部署模型。</p><h1 id="0ca6" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">几个基本要素</h1><p id="a2ae" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">在进入即将讨论的部署示例之前，我将尝试给出一些关于所使用的AWS服务的基本细节，以便完全不熟悉AWS的读者可以在尝试本文中讨论的步骤和服务之前，根据需要对AWS本身做一些进一步的基础研究。</p><p id="75c3" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><a class="ae jn" href="https://aws.amazon.com/sagemaker/" rel="noopener ugc nofollow" target="_blank">T3】AWS SageMakerT5】</a></p><p id="a4d5" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">亚马逊SageMaker是一个完全托管的机器学习服务。它帮助数据科学家和开发人员快速准备、构建、训练和部署高质量的机器学习(ML)模型。它提供了一个集成的Jupyter创作笔记本实例，可以方便地访问您的数据源进行探索和分析。</p><p id="3edd" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><a class="ae jn" href="https://aws.amazon.com/s3/?did=ft_card&amp;trk=ft_card" rel="noopener ugc nofollow" target="_blank"> <strong class="jq hj">亚马逊S3 </strong> </a></p><p id="d5f6" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">亚马逊简单存储服务(亚马逊S3)是一种对象存储服务，提供行业领先的可扩展性、数据可用性、安全性和性能。我们可以使用S3来存储任何文件、模型、训练模型的输入数据等。</p><p id="63a9" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><a class="ae jn" href="https://aws.amazon.com/lambda/" rel="noopener ugc nofollow" target="_blank"><strong class="jq hj">λ</strong>T3】</a></p><p id="51ea" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">AWS Lambda是一种无服务器计算服务，让您无需配置或管理服务器即可运行代码。只需将您的代码上传为ZIP文件或容器图像，Lambda就会自动精确地分配计算执行能力，并根据传入的请求或事件运行您的代码，适用于任何规模的流量。</p><p id="fafb" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><a class="ae jn" href="https://aws.amazon.com/api-gateway/" rel="noopener ugc nofollow" target="_blank">T5】AWS API网关T7】</a></p><p id="6bb6" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">Amazon API Gateway是一个完全托管的服务，使开发人员可以轻松地创建、发布、维护、监控和保护任何规模的API。API充当应用程序从后端服务访问数据、业务逻辑或功能的“前门”。使用API Gateway，您可以创建支持实时双向通信应用程序的RESTful APIs和WebSocket APIs。</p><p id="23a8" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><a class="ae jn" href="https://boto3.amazonaws.com/v1/documentation/api/latest/index.html" rel="noopener ugc nofollow" target="_blank"><strong class="jq hj">boto 3<br/></strong></a><br/>用于Python的AWS SDK。您可以使用AWS SDK for Python (Boto3)来创建、配置和管理AWS服务，例如亚马逊弹性计算云(亚马逊EC2)和亚马逊简单存储服务(亚马逊S3)。SDK提供了面向对象的API以及对AWS服务的底层访问。</p><p id="9778" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><a class="ae jn" href="https://sagemaker.readthedocs.io/en/stable/index.html" rel="noopener ugc nofollow" target="_blank"> <strong class="jq hj">亚马逊SageMaker Python SDK </strong> </a></p><p id="dea9" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">SageMaker Python SDK为使用Amazon SageMaker提供了几个高级抽象。</p><h1 id="f387" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">在SageMaker中部署模型</h1><p id="2d53" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">简而言之，SageMaker是AWS提供的ML服务，用于在云上编码、训练和部署ML模型。如果我们通读一下<strong class="jq hj"> SageMaker开发者指南</strong>，我们可以了解服务框架是多么的庞大和多样，包括对许多流行算法的内置支持，从<strong class="jq hj">线性学习器、XGBoost、K-NN、K-Means等等。到深度学习框架，比如Tensorflow，MXNet </strong>等。</p><p id="a682" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">将焦点带回到我们当前在SageMaker上部署模型的主题，需要注意的是，在SageMaker中有各种各样的方法来训练和部署ML模型</p><ul class=""><li id="d965" class="li lj hi jq b jr js ju jv jx lk kb ll kf lm kj ln lo lp lq bi translated">在SageMaker内部培训和部署，都使用SageMaker自己的内置算法容器(请注意这些是AWS管理的容器)。</li><li id="483f" class="li lj hi jq b jr lr ju ls jx lt kb lu kf lv kj ln lo lp lq bi translated">在本地/在SageMaker外部训练我们的模型，然后使用SageMaker的内置算法容器来部署本地训练的模型(自带模型类型)。</li><li id="6bc9" class="li lj hi jq b jr lr ju ls jx lt kb lu kf lv kj ln lo lp lq bi translated">使用SageMaker的(AWS管理的)内置算法容器，但根据需要用我们自己的脚本定制培训(自带模型类型)。</li><li id="95a1" class="li lj hi jq b jr lr ju ls jx lt kb lu kf lv kj ln lo lp lq bi translated">在我们的本地容器(由我们构建和管理)中，以任何方法/或我们自己的算法训练我们的模型，然后将该容器带到SageMaker并部署使用(BYOC-自带容器)。</li></ul><p id="29fb" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">从上面列表的顶部到底部，ML工程师的灵活性增加了，但是所需的复杂性和工作量也增加了，例如，您需要为BYOC类型的部署投入更多的精力。</p><h1 id="693c" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">在AWS云上部署本地培训的模型</h1><p id="6428" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">在本文中，<strong class="jq hj">我们将尝试上面</strong>列表中的第二种方法。我特别感兴趣的是学习如何在我的笔记本电脑上获取我在本地训练的模型，并将其部署在AWS cloud上(而不必太担心如何使用SageMaker来训练模型)。</p><p id="a654" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">让我们开始练习吧！<br/> </strong>..<br/>由于我们在这里只关注部署，我们不打算在数据集EDA、数据准备、超参数调整、模型选择等方面花费时间。等等。因此，我们采取了简单的鸢尾花数据集！</p><p id="0f99" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">尝试练习的先决条件- </strong></p><p id="84d6" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">你需要有一个免费的AWS账户才能使用亚马逊的云服务，包括SageMaker，Lambda，S3等。以及<strong class="jq hj">熟悉在AWS控制台上启动这些服务</strong>。关于如何创建免费AWS帐户并尝试在AWS控制台上启动这些服务的详细信息，可以在网上轻松找到。</p><p id="4602" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">重要信息</strong> —请注意<strong class="jq hj"> </strong> SageMaker不是免费服务，根据您运行和使用笔记本实例等资源的时间长短，会产生一些费用。在您尝试这个部署练习之后，您必须正确地清理所有SageMaker资源、Lambda、S3桶等。我已经在本文末尾分享了如何清理的细节。</p><p id="17f6" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">简而言之，我们的练习步骤如下。</strong></p><ol class=""><li id="3b14" class="li lj hi jq b jr js ju jv jx lk kb ll kf lm kj lw lo lp lq bi translated">加载数据集并在本地笔记本电脑中训练模型，无需使用任何云库或SageMaker。</li></ol><p id="fadb" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">2.将训练好的模型文件上传到AWS SageMaker并在那里部署。部署包括将模型放在S3桶中，创建一个SageMaker模型对象，配置和创建端点，以及一些无服务器服务(API gateway和Lambda)来从外部触发端点。</p><p id="e682" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">3.使用一个本地客户机(我们使用Postman)将一个样本测试数据发送到云中部署的模型，并将预测返回给客户机。Restful htttp方法在这方面帮助了我们。</p><p id="c977" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">让我们来完成下面详细的分步练习。</p><h1 id="2fe9" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">训练模型</h1><ol class=""><li id="093a" class="li lj hi jq b jr lc ju ld jx lx kb ly kf lz kj lw lo lp lq bi translated">在本地笔记本电脑中，使用Jupyter笔记本，在流行的鸢尾花数据集上训练XGBoost分类模型。</li></ol><p id="4405" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj"> 2。测试模型，并使用joblib在本地保存模型文件。</strong></p><p id="2041" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">以上两个步骤请参考我的github <a class="ae jn" href="https://github.com/raja-surya/aws-deployment-1" rel="noopener ugc nofollow" target="_blank">资源库</a>中的<strong class="jq hj">iris-model-creation . ipynb</strong>笔记本。</p><p id="f81a" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">从<a class="ae jn" href="https://github.com/raja-surya/aws-deployment-1" rel="noopener ugc nofollow" target="_blank"> github </a>下载iris-model-creation.ipynb到你的笔记本电脑上，运行它来创建模型和test_point.csv文件。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ma"><img src="../Images/d6d4aee055dc82ed4708938eb59f89dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hUOHeXQYYkmjyAXUvl450g.jpeg"/></div></div></figure><p id="1850" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在iris-model-creation笔记本中，基本上我们下载iris flower数据集，在其上运行一个简单的XGBoost模型，对其进行测试，并使用joblib dump将模型保存为本地文件。出于测试目的，我们在test_point.csv中保存了一些样本花数据。</p><h1 id="9af7" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">在SageMaker中部署模型</h1><p id="cb48" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">接下来的两个步骤，请参考我的github <a class="ae jn" href="https://github.com/raja-surya/aws-deployment-1" rel="noopener ugc nofollow" target="_blank">资源库</a>中的<strong class="jq hj">iris-model-deployment . ipynb</strong>笔记本。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mb"><img src="../Images/b7c79d62824639beb0fbd717816671e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PkQm5w4kaP1-M4k8zEtpww.jpeg"/></div></div></figure><p id="6f63" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">我们必须在SageMaker中上传并运行此笔记本，而不是在本地。</strong></p><p id="cebe" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj"> 3。在AWS控制台中，创建一个SageMaker笔记本实例，并打开一个Jupyter笔记本。<br/> </strong> <br/>将本地训练好的模型、test_point.csv和iris-model-deployment.ipynb文件上传到sageMaker笔记本。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mc"><img src="../Images/8b05ec6642d141f515d52842d6a319f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fZ7w3cpqKcl1haPWv-wo6g.jpeg"/></div></div></figure><p id="be63" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj"> 4。在SageMaker中运行iris-model-deployment笔记本。</strong></p><p id="f5f1" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">重要-运行笔记本中的所有单元格，除了最后一个</strong>-<strong class="jq hj">‘删除端点’。</strong></p><p id="30d3" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">当你看到弹出“没有找到内核”时，选择并设置conda_python3为内核。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es md"><img src="../Images/5cd1a2f553a3f271f881a463d6519697.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h5K7EgHkQx8QHvXRWCaS3w.jpeg"/></div></div></figure><p id="c2c7" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">笔记本代码执行以下操作。</p><ul class=""><li id="8445" class="li lj hi jq b jr js ju jv jx lk kb ll kf lm kj ln lo lp lq bi translated">加载模型文件，打开并测试它，然后将它上传到S3存储桶(SageMaker将从那里获取模型工件)。</li><li id="8955" class="li lj hi jq b jr lr ju ls jx lt kb lu kf lv kj ln lo lp lq bi translated">从存储在S3的模型中创建一个SageMaker模型对象。为此，我们将使用SageMaker内置的XGBoost容器，因为该模型是用XGBoost算法在本地训练的。根据您用于建模的算法，您必须正确选择相应的内置容器，并处理与之相关的细微差别..SageMaker开发人员指南应该对此有所帮助。</li><li id="5972" class="li lj hi jq b jr lr ju ls jx lt kb lu kf lv kj ln lo lp lq bi translated">创建端点配置。端点是一个接口，外部世界可以通过它使用部署的模型进行预测。关于端点的更多细节可以在SageMaker文档中找到。</li><li id="b7d1" class="li lj hi jq b jr lr ju ls jx lt kb lu kf lv kj ln lo lp lq bi translated">为模型创建一个端点。</li><li id="dbaf" class="li lj hi jq b jr lr ju ls jx lt kb lu kf lv kj ln lo lp lq bi translated">从部署笔记本中调用端点，以确认端点和模型工作正常。</li></ul><p id="9795" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">运行笔记本到现在，您可以看到在AWS控制台的<br/>Sagemaker-&gt;Inference-&gt;Endpoints下创建的端点。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es me"><img src="../Images/d3aec2560199ed1536e49428bd264fc2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GhcWYAj6lWSuPCa0rOZfdg.png"/></div></div></figure><p id="014d" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">您必须记下显示的端点名称。这将在创建Lambda函数时使用(在下一节中描述)。</p><h1 id="0a1e" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">为端到端通信启动必要的AWS服务</h1><p id="3ed4" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">完成上述步骤后，我们将部署模型，并准备好从外部调用SageMaker端点，以从部署的模型中获得实时预测。</p><p id="9c2d" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">下图显示了如何使用无服务器AWS架构调用部署的模型。一个客户端脚本调用一个<a class="ae jn" href="https://aws.amazon.com/api-gateway" rel="noopener ugc nofollow" target="_blank">亚马逊API网关</a> API动作并传递参数值。API网关是向客户端提供API的层。API Gateway将参数值传递给Lambda函数。Lambda函数解析该值并调用SageMaker模型端点，将参数传递给相同的。模型执行预测任务，并将预测结果返回给Lambda。Lambda函数解析返回值并将其发送回API Gateway。API网关用该值响应客户端。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mf"><img src="../Images/ba4c9d3bdf95f39c06f2fb3b5f126033.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*xfeypVGtWWTQnaVSO7GzyA.gif"/></div></div></figure><p id="b055" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">我们将使用亚马逊的Rest API网关</strong>来实现我们的目的。我们将使用Postman app而不是web浏览器作为客户端，以保持简单(如果您想使用浏览器web界面，您需要将Flask打包在一个容器中，该容器需要放置在SageMaker中并在其中运行)。在我们的例子中，Postman将用于发送Restful POST方法来调用API网关并获得响应(预测)。</p><p id="3270" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">所以我们需要设置API网关和Lambda。让我们完成剩下的几个步骤。</p><p id="c92b" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj"> 5。创建一个包含以下策略的IAM角色，该策略赋予Lambda函数调用模型端点的权限。</strong></p><pre class="iy iz ja jb fd mg mh mi mj aw mk bi"><span id="a05b" class="ml kl hi mh b fi mm mn l mo mp">{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Sid": "VisualEditor0",<br/>            "Effect": "Allow",<br/>            "Action": "sagemaker:InvokeEndpoint",<br/>            "Resource": "*"<br/>        }<br/>    ]<br/>}</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mq"><img src="../Images/3e9f118f8aff1f410b13c66ce8c83b56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rbnvSvGffuXp8Z-mujU9_w.jpeg"/></div></div></figure><p id="fa62" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在创建角色并将策略附加到角色时，选择Lambda作为AWS服务中的用例。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mr"><img src="../Images/f1278e798b8929bd85e1341b62e7edf7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cGTP49nInW-ILW2TWoE3FQ.jpeg"/></div></div></figure><p id="dee6" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj"> 6。用下面提到的python代码创建一个Lambda函数，该函数调用SageMaker运行时invoke_endpoint并返回预测。</strong></p><pre class="iy iz ja jb fd mg mh mi mj aw mk bi"><span id="3c0a" class="ml kl hi mh b fi mm mn l mo mp">import os<br/>import boto3<br/>import json</span><span id="4525" class="ml kl hi mh b fi ms mn l mo mp"># grab environment variables<br/>ENDPOINT_NAME = os.environ['ENDPOINT_NAME']<br/>runtime= boto3.client('runtime.sagemaker')</span><span id="f6a0" class="ml kl hi mh b fi ms mn l mo mp">def lambda_handler(event, context):<br/>    print("Received event: " + json.dumps(event, indent=2))<br/>    <br/>    data = json.loads(json.dumps(event))<br/>    payload = data['data']<br/>    #print(payload)<br/>    <br/>    response = runtime.invoke_endpoint(EndpointName=ENDPOINT_NAME,<br/>                                       ContentType='text/csv',<br/>                                       Body=payload)</span><span id="4625" class="ml kl hi mh b fi ms mn l mo mp">    #print(response)</span><span id="786d" class="ml kl hi mh b fi ms mn l mo mp">    result = json.loads(response['Body'].read().decode())<br/>   <br/>    classes = ['Setosa', 'Versicolor', 'Virginica']<br/>    res_list =  [ float(i) for i in result]</span><span id="41be" class="ml kl hi mh b fi ms mn l mo mp">    return classes[res_list.index(max(res_list))]</span></pre><p id="de44" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">选择“从头开始创作”并给出一个函数名，选择运行时为Python 3.8，如下所示。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mt"><img src="../Images/39253f79fd11feebcf8fa99da17891d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ReY36tAH4ng1X-6XJC5kSw.jpeg"/></div></div></figure><p id="0227" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">选择“使用现有角色”</strong>并选择您在上一步中创建的角色。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mu"><img src="../Images/600924630f574704014a6842c01e77aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*55wceWUEeN-41GBNNdui4g.jpeg"/></div></div></figure><p id="fcfa" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在lambda的代码部分下，输入本步骤开始时给出的python代码。<strong class="jq hj">输入代码后，记得点击“部署”。</strong></p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mv"><img src="../Images/00d352f9be57d54ff9fefe5044489e5f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Oe-xfU5ZKguwYtlvpOQyYA.jpeg"/></div></div></figure><p id="77a7" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">转到Lambda函数的Configuration选项卡，添加一个环境变量“ENDPOINT_NAME ”,并将其值设置为在前面的步骤中创建的相同端点。注意，Lambda函数的代码中使用了这个环境变量。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mw"><img src="../Images/4abb5747b3082b6cf75115470cbd6bbd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UtRCxKPjVy7hNnoxEcZNAA.jpeg"/></div></div></figure><p id="3778" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我们已经完成了Lambda函数的设置。</p><p id="0efd" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj"> 7。创建一个REST API并集成Lambda函数</strong></p><p id="593b" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在AWS控制台上选择API网关服务，然后选择REST API。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mx"><img src="../Images/a2aa45ecf8984abb74fb922f84728cc9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X16GilqatVIPcRLn7wZCkw.jpeg"/></div></div></figure><p id="033f" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">点击Build并选择“New API”。在您看到的下一个窗口中，从Actions下拉菜单中选择“Create Resource ”,并输入一个资源名称。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es my"><img src="../Images/ab359be7b3d9c98f997de0232d091767.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NZzyP9MJBCsAmpgi5y7Vqw.jpeg"/></div></div></figure><p id="cace" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">记下您选择的资源名称。它将是该服务创建的URL的一部分，稍后我们测试Postman的部署时会用到。这里我们选择资源名为“irisprediction”。创建资源后，从操作下拉菜单中选择“创建方法”。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mz"><img src="../Images/87cbfda982914010b903c4c7ee7f0933.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DHB1EcNtkNqUpD7Pvz_Sww.jpeg"/></div></div></figure><p id="8335" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">选择POST方法和“Lambda函数”作为集成类型。输入您在前面步骤中创建的Lambda函数的名称。然后，从操作下拉菜单中选择“部署API”。选择部署阶段“新阶段”并给出某个阶段名称。我选择输入“测试”。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es na"><img src="../Images/eb980bef981200d975e74385cba79ffd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tY6AxQjph1oo1-k7OMCzGg.jpeg"/></div></div></figure><p id="ed87" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">然后，最后当你点击“部署”，你会得到一个“调用网址”，如下所示。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nb"><img src="../Images/302c27cab40b96bb24ab513eed30adb2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BAKT2JgZ84_zHUnkJbg0oQ.png"/></div></div></figure><p id="7467" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">请记下窗口上显示的URL为“调用URL”。</strong>它将在Postman中用于联系API网关，如下所述。</p><p id="82a1" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在，我们已经完成了端到端通信路径的部署和设置。</p><h1 id="6c01" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">从本地客户端测试最终部署</h1><p id="f9cb" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated"><strong class="jq hj"> 8。最后，使用笔记本电脑中的Postman应用程序，将Iris flower测试数据发布到API gateway，并从AWS cloud返回预测结果。</strong></p><p id="82b8" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">示例URL : ( <strong class="jq hj">记住用您在前面的步骤中创建API时获得的API URL替换，并在末尾附加资源名称。</strong>)</p><p id="921e" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">例如，如果您得到的调用URL是<br/>https://kmnia 554 df . execute-API . us-east-1 . Amazon AWS . com/test/</p><p id="1f9f" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">将资源名称附加到上面的URL，并在postman中使用。例如，在我们的例子中，它是“虹膜预测”。您可以看到下面给出的完整示例URL的屏幕截图。</p><p id="3108" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">使用方法:贴</p><p id="06cf" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在正文中，原始输入可以如下给出:</p><p id="92ba" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">{ " data ":" 5.099999999999999645 e+00，3.299999999999999822e+00，1.699999999999956 e+00，5.00000000000000 e-01 " }</p><p id="359c" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">样本数据可以参考test_point.csv。作为数据给出的四个数值参数只不过是一些鸢尾花数据点的样本萼片长度、萼片宽度、花瓣长度和花瓣宽度。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nc"><img src="../Images/b0d36d79cb04f6fde59807c05a20a96a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ccP67aRwuw5D4tebouGeWg.jpeg"/></div></div></figure><p id="773c" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">当我们发送数据时，我们成功地调用了已部署的模型端点，并接收回上面示例中的“Setosa”形式的花朵预测。</p><p id="206c" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">因此，我们已经使用SageMaker在AWS云上成功部署了一个本地训练的模型，并看到了它在实时推理方面的工作！</strong></p><p id="71d6" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在，最后也是最重要的一步是<strong class="jq hj">清理我们已经创建并启动的AWS资源</strong>，因为如果您让任何资源运行或占用空间，您将为该资源停留在那里的所有时间付费…</p><h2 id="c971" class="ml kl hi bd km nd ne nf kq ng nh ni ku jx nj nk kw kb nl nm ky kf nn no la np bi translated">重要-清理，否则你支付费用！</h2><ol class=""><li id="c667" class="li lj hi jq b jr lc ju ld jx lx kb ly kf lz kj lw lo lp lq bi translated">对于SageMaker，记得删除笔记本实例、端点、端点配置和模型。你可以按照这个<a class="ae jn" href="https://docs.aws.amazon.com/sagemaker/latest/dg/ex1-cleanup.html" rel="noopener ugc nofollow" target="_blank">链接</a>进行同样的操作。</li><li id="b081" class="li lj hi jq b jr lr ju ls jx lt kb lu kf lv kj lw lo lp lq bi translated">转到Lambda service并删除您创建的函数。</li><li id="d9b5" class="li lj hi jq b jr lr ju ls jx lt kb lu kf lv kj lw lo lp lq bi translated">转到Cloudwatch服务，选择“日志组”并删除您在那里找到的日志组。</li><li id="c4b1" class="li lj hi jq b jr lr ju ls jx lt kb lu kf lv kj lw lo lp lq bi translated">转到IAM服务，删除您在本练习中创建的角色和策略。</li><li id="67ae" class="li lj hi jq b jr lr ju ls jx lt kb lu kf lv kj lw lo lp lq bi translated">删除我们推出的API网关。</li></ol><p id="06f2" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">AWS SageMaker上的模型部署练习到此结束。</p><p id="e1b2" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">希望你喜欢并欣赏它…谢谢你的关注！！</p><h1 id="4914" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated"><strong class="ak">少量参考资料供进一步阅读:</strong></h1><p id="b99a" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated"><a class="ae jn" href="https://docs.aws.amazon.com/sagemaker/index.html" rel="noopener ugc nofollow" target="_blank">亚马逊SageMaker文档</a></p><p id="9441" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><a class="ae jn" href="https://github.com/aws/amazon-sagemaker-examples" rel="noopener ugc nofollow" target="_blank"> SageMaker示例笔记本</a></p><p id="6570" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><a class="ae jn" href="https://www.youtube.com/playlist?list=PLhr1KZpdzukcOr_6j_zmSrvYnLUtgqsZz" rel="noopener ugc nofollow" target="_blank">亚马逊SageMaker技术深潜系列</a></p></div></div>    
</body>
</html>