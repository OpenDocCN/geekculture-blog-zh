<html>
<head>
<title>How to use `eval` in a V3 chrome extension</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在V3 chrome扩展中使用“eval”</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/how-to-use-eval-in-a-v3-chrome-extension-f21ca8c2160c?source=collection_archive---------1-----------------------#2022-06-07">https://medium.com/geekculture/how-to-use-eval-in-a-v3-chrome-extension-f21ca8c2160c?source=collection_archive---------1-----------------------#2022-06-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="1451" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如今，Chrome扩展开发者正在慢慢地将他们的代码从V2迁移到V3，不幸的是，这并不总是一项简单的工作。</p><p id="bf50" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我看到开发人员面临的一个问题是他们应该如何迁移<code class="du jd je jf jg b">eval</code>。当我迁移我自己的扩展<a class="ae jh" href="https://github.com/scaljeri/oh-my-mock" rel="noopener ugc nofollow" target="_blank">时也是如此，我自己的扩展</a>到处都在使用<code class="du jd je jf jg b">eval</code>。这是V3中出现的错误</p><p id="b3b7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du jd je jf jg b">Error in event handler: EvalError: Refused to evaluate a string as JavaScript because 'unsafe-eval' is not an allowed source of script in the following Content Security Policy directive: "script-src 'self'".</code></p><p id="e7a9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在V2，你可以在任何地方使用<code class="du jd je jf jg b">eval</code>，但是在V3中，你不能在任何地方使用它。但是幸运的是，有一个解决这个问题的方法，在这里<a class="ae jh" href="https://developer.chrome.com/docs/extensions/mv3/sandboxingEval/" rel="noopener ugc nofollow" target="_blank">描述了这个方法</a></p><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="er es ji"><img src="../Images/9dc1217cb0dc23eea54d78f7997e996f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bMbiRMJmCWG7XnqnRgBOog.png"/></div></div><figcaption class="ju jv et er es jw jx bd b be z dx">V3 sandbox documentation</figcaption></figure><p id="2e38" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不幸的是，所描述的解决方案是直接从V2抄袭来的，开箱即用效果不佳。它描述了如何在后台脚本中使用iframe来保护你的<code class="du jd je jf jg b">eval</code>代码。在后台脚本中运行iframe解决方案在V2是一个完美的解决方案，但在V3中不再是了，因为后台脚本是一个服务工作者。它不能创建iframes。因此，解决方案很简单，只需在其他地方创建iframe(除了内容脚本)。在我的例子中，我使用了弹出的html文件，并添加了以下html代码</p><pre class="jj jk jl jm fd jy jg jz ka aw kb bi"><span id="8f39" class="kc kd hi jg b fi ke kf l kg kh">&lt;iframe src=”../sandbox.html” id=”sandbox” style=”display: none”&gt;&lt;/iframe&gt;</span></pre><p id="97df" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">其中<em class="ki">sandbox.html</em>包含执行<code class="du jd je jf jg b">eval</code>的代码</p><pre class="jj jk jl jm fd jy jg jz ka aw kb bi"><span id="b564" class="kc kd hi jg b fi ke kf l kg kh">&lt;html&gt;<br/>    &lt;script&gt;<br/>        window.addEventListener('message', async function (event) {<br/>            event.source.window.postMessage(eval(event.data), event.origin);<br/>        });<br/>    &lt;/script&gt;<br/>&lt;/html&gt;</span></pre><p id="323b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">别忘了将<code class="du jd je jf jg b">sandbox.html</code>配置为真正的沙箱</p><pre class="jj jk jl jm fd jy jg jz ka aw kb bi"><span id="13e3" class="kc kd hi jg b fi ke kf l kg kh">"sandbox": {<br/>    "pages": [<br/>      "sandbox.html"<br/>    ]<br/>  }</span></pre><p id="3c25" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这应该添加到<em class="ki"> manifest.json </em>文件中。</p><p id="e4eb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，与沙箱通信的代码</p><pre class="jj jk jl jm fd jy jg jz ka aw kb bi"><span id="1483" class="kc kd hi jg b fi ke kf l kg kh">const iframe = document.getElementById('sandbox');</span><span id="0260" class="kc kd hi jg b fi kj kf l kg kh">window.addEventListener('message', (event) =&gt; {<br/>   console.log('EVAL output', event.data);<br/>});</span><span id="4e6f" class="kc kd hi jg b fi kj kf l kg kh">iframe.contentWindow.postMessage('10 + 20', '*');</span></pre><p id="8e16" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就是这样。干杯</p></div></div>    
</body>
</html>