# 设计革命性的网络应用👊

> 原文：<https://medium.com/geekculture/designing-a-revolutionary-web-app-d602494c221?source=collection_archive---------2----------------------->

![](img/a26199f937b95fd2e620cf713b0410f4.png)

The landing page2

2021 年 10 月 25 日，苏丹军方在一次军事政变中控制了政府。在此之前，许多苏丹人死于抗议，在 50 度的高温下静坐数小时，希望有一个更好的政府。可悲的是，政变破坏了大部分工作。

我想做点什么来帮助他们，所以我开发了一个网络应用来保存苏丹革命艺术[https://sudan-art.com](https://sudan-art.com)。代码是开源的，现在还处于早期阶段，所以欢迎投稿🔥！

去年，我在缅甸的反政变抵抗运动中做了很多工作。我注意到抗议运动是如何迅速地淡出新闻，以及将革命艺术和材料存档是多么困难。然后我发现了一个叫做 https://threefingers.org[的神奇网站，那里收集了大量杰出的缅甸艺术品，所以我决定做一些类似的事情。](https://threefingers.org)

我认为这些是需要解决的重要问题。保持在新闻中的存在保持了对非法政府的国际压力。在我看来，将艺术存档有助于提醒人们一场革命确实发生了。苏丹许多描绘革命的壁画已经被抹去。许多缅甸革命者被逮捕或者更糟。

一路上，我学到了不少有趣的东西。我将把它们分成三篇不同的博文，按照编程领域和堆栈进行组织:

*Python & Django —第一部*

1.  如何通过减小图像的文件大小和剥离元数据来正确地预处理图像以便上传；
2.  如何接受上传图片 100%安全是不可能的，如何管理随之而来的风险；
3.  如何为处理图像上传的 Django 视图编写测试；

[*JavaScript/React —第二部分*](/geekculture/designing-a-revolutionary-web-app-part-ii-a9b9356143a6)

1.  如何避免布局偏移，并在页面完全加载后只显示一整页的图片；
2.  或者，如何显示图像的占位符，使它们在加载前看起来不错；
3.  如何设计一个简洁的图像标签组件；

[*devo PS/数字海洋—第三部分*](/geekculture/designing-a-revolutionary-web-app-part-iii-bb228d550897)

首先，如果你想花 100 美元试用数字海洋 60 天，点击[这个](https://m.do.co/c/914e910aa17b)链接。

1.  如何使用 docker compose 为 MVP 部署到数字海洋；
2.  如何在使用反向代理服务器的安全生产部署中服务 Django/React with NGINX；
3.  如何设置一个简单的 Github actions 工作流来自动化代码林挺、测试和部署的 CI/CD 管道。

# 第一部分

## 如何通过减小文件大小和剥离元数据来正确地预处理图像以便上传

在开发这个应用的时候，我很快意识到在后端正确地预处理图像是非常重要的。从前端开发人员的角度来看，图像占据了巨大的空间。

一张图片甚至可能花费你整个代码库甚至更多的下载时间。所以我认为尽可能减小文件大小是个好主意。

然而，图像被过度压缩后看起来并不太好。所以我也决定在我网站的数据库中保存一张高分辨率的图片，让用户下载，这是一个好主意。

我在这里遇到的最后一个问题是净化上传。默认设置下的现代 DSLR 的图像包含了惊人的元数据量。我觉得这一点特别重要，因为我网站上的大多数图片都是政治性和批判性的。

所以，我是这样解决这些问题的:

这里发生的事情还真不少！如果你看一下第 34 行的 save 函数，它覆盖了属于我的`Artwork`类继承的`models.Model`类的`save`方法。

这很方便，因为这意味着每当我将一些数据保存到视图中的数据库时，就会运行这段代码。因此，我在这里做了一些预处理，确保每张图片都经过了第 45 行定义的`reduce_image_size`函数。

该函数创建一个缩略图，并通过将图像读入字节流，然后再次保存到文件中来剥离所有图像元数据。它通过创建一个来自 django 核心库的新的`File`对象来做到这一点，因此它与我在`Artwork`类中定义的`ImageField`很好地配合。

到下一个…

## 如何接受上传图片 100%安全是不可能的，如何管理随之而来的风险

很难完美地保护图像。因为你的用户正在上传一个不同类型的大文件，这就有了一个巨大的攻击面。因此，很难用自己的测试套件真正正确地验证图像。

我知道有些人做的一件事是旋转一个容器，用杀毒产品扫描里面的文件，然后杀死这个容器。我认为这是一个好主意，但这是一个很大的工程开销…你可能会希望这是异步的，并需要想出一种方法来做芹菜任务或类似的事情。

我并不是说这是个坏主意，但对于这个更像是爱好的小型个人项目来说，这实在是太多的工作了。因此，我选择只依赖 Django 的`ImageField`内置验证，然后将图像存储在数字海洋空间中，与我的应用程序的其余部分分开。这一点很重要，因为这意味着攻击者无法从上传的图像转到运行我的 web 应用程序的环境中——相反，他们会被困在数字海洋空间中😜

所以，这就是你在上面第 21-30 行看到的。如果我在本地运行应用程序，那么`settings.DEBUG`将为真，所以我不需要这样做。但是如果我在生产中运行它，我已经在数字海洋中配置了使用 S3 桶的东西。

这利用了 Django storages，这里有一些关于数字海洋[配置的细节](https://django-storages.readthedocs.io/en/latest/backends/digital-ocean-spaces.html)。我用它在这里创建了存储类，这就是上面定义中的`PublicMediaStorage`所指的。

要做到这一点，你需要在你的应用程序的`settings.py`中配置一些其他的东西，但是这些在 Digital Ocean 的文档中有详细的描述。

因为我使用 Django Rest 框架为这个服务构建了一个后端 api，所以您需要在视图中做一些事情来确保您的图片上传实际上使用了 Django 的`ImageField`。这对于 rest 框架来说非常好。

如果你有一个这样的`views.py`:

然后，这将为您的模型使用一个序列化程序，您可以在`serializers.py`中这样定义:

## 如何为处理图像上传的 Django 视图编写测试

最后但并非最不重要的是，一旦这些都完成了，就该写一些测试了！但是对于涉及图片上传的 Django 视图，如何做到这一点呢？

像这个☺️:

我在这里做的第一件事是创建一个基类，我可以在编写其他测试时继承它。这只是使用我在测试文件夹中获得的样本图像向数据库添加一个对象，然后从`settings.MEDIA_ROOT`值中删除所有内容，该值是存储所有图像的文件夹。

一旦完成，上传图片并测试它是否被添加到数据库就变得非常简单了，因为 Django 实际上使用数据库进行测试，所以没有必要模仿所有的东西。

为了更容易运行测试，我喜欢做的一件事是为测试创建一个单独的`settings.py`,以便它们在内存 sql lite 数据库上运行。如果您在应用程序中使用大量 postgres 之类的语法，这可能不起作用，但如果起作用，那么这是很方便的，因为这意味着您不需要为运行标准 Django 测试套件设置任何类型的数据库。

看起来是这样的:

然后您可以用`python manage.py test --settings=<path to test_settings.py`调用测试。

现在你知道了！