<html>
<head>
<title>I Can’t Wait for Laravel Octane</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我等不及了</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/i-cant-wait-for-laravel-octane-6697d1d355c1?source=collection_archive---------5-----------------------#2021-03-29">https://medium.com/geekculture/i-cant-wait-for-laravel-octane-6697d1d355c1?source=collection_archive---------5-----------------------#2021-03-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/764b03f161cd8c00eaba9cc605e588ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CVWnCmdUDcFZ6Eqj6KqGSw.png"/></div></div></figure><p id="ec75" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">等不及Laravel Octane了，就开始玩Laravel和Roadrunner。</p><blockquote class="jo"><p id="8024" class="jp jq hi bd jr js jt ju jv jw jx jn dx translated">2021年4月6日，Laravel Octane Beta发布，因此本文已过时。我的建议是使用Laravel辛烷与Roadrunner。为此，你可以关注这个帖子:<a class="ae jy" href="https://robertodev.medium.com/laravel-octane-is-here-9ce026f6180e" rel="noopener">https://Roberto dev . medium . com/laravel-octane-is-here-9ce 026 f 6180 e</a></p></blockquote><p id="05d5" class="pw-post-body-paragraph iq ir hi is b it jz iv iw ix ka iz ja jb kb jd je jf kc jh ji jj kd jl jm jn hb bi translated">在拉拉康2021期间🎉🎉🎉，在Taylor的精彩的“Laravel Octane”演讲之后，我对使用一个有多个工作人员的应用服务器来服务Laravel应用程序感到非常兴奋。</p><p id="d78f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在引擎盖下，Laravel Octane可以与Roadrunner一起使用，所以我决定直接用Roadrunner玩一会儿。</p><p id="d17b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">什么是Roadrunner: Roadrunner是一个用Go编写的应用服务器，为PHP应用服务。</p><h1 id="a6d5" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">安装</h1><p id="2646" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">我们要做的是:</p><ul class=""><li id="54c3" class="lh li hi is b it iu ix iy jb lj jf lk jj ll jn lm ln lo lp bi translated">从头安装一个新的Laravel应用程序</li><li id="af45" class="lh li hi is b it lq ix lr jb ls jf lt jj lu jn lm ln lo lp bi translated">安装HTTP基准测试工具</li><li id="d5b1" class="lh li hi is b it lq ix lr jb ls jf lt jj lu jn lm ln lo lp bi translated">安装Roadrunner</li><li id="0a54" class="lh li hi is b it lq ix lr jb ls jf lt jj lu jn lm ln lo lp bi translated">安装Laravel“桥”,以便与Laravel框架一起使用Roadrunner</li><li id="7127" class="lh li hi is b it lq ix lr jb ls jf lt jj lu jn lm ln lo lp bi translated">配置Roadrunner</li><li id="86e4" class="lh li hi is b it lq ix lr jb ls jf lt jj lu jn lm ln lo lp bi translated">启动应用服务器</li><li id="d2af" class="lh li hi is b it lq ix lr jb ls jf lt jj lu jn lm ln lo lp bi translated">使用Nginx和Roadrunner执行比较基准测试</li><li id="2f98" class="lh li hi is b it lq ix lr jb ls jf lt jj lu jn lm ln lo lp bi translated">请考虑一下，因为使用应用服务器与使用Web服务器是不同的。</li></ul><h1 id="aa45" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">从头开始安装新的Laravel应用程序</h1><p id="a55c" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">我将从头开始创建一个新的Laravel应用程序。</p><p id="987a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">所以首先，我需要安装或更新“laravel”工具。这对于创建新的Laravel应用程序非常有用:</p><pre class="lv lw lx ly fd lz ma mb mc aw md bi"><span id="f77d" class="me kf hi ma b fi mf mg l mh mi">composer global require laravel/installer</span></pre><p id="3f1a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后我可以创建新的Laravel应用程序:</p><pre class="lv lw lx ly fd lz ma mb mc aw md bi"><span id="406d" class="me kf hi ma b fi mf mg l mh mi">laravel new laravel-turbo<br/>cd laravel-turbo</span></pre><p id="b3ac" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我建议在代客服务的目录中创建这个应用程序。所以你可以通过Nginx在你的浏览器中找到这个:<a class="ae jy" href="http://laravel-turbo.test" rel="noopener ugc nofollow" target="_blank">http://laravel-turbo . test</a></p><h1 id="b49f" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">安装HTTP基准测试工具</h1><p id="9b85" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">为了检索一些关于性能的见解，并在您的Laravel应用程序上模拟大量并发流量，我将使用“<em class="mj">Wrk</em>”<a class="ae jy" href="https://github.com/wg/wrk" rel="noopener ugc nofollow" target="_blank">https://github.com/wg/wrk</a>。</p><p id="08dd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你有一台macOS并且你使用的是Homebrew，你可以安装“<em class="mj"> Wrk </em>”:</p><pre class="lv lw lx ly fd lz ma mb mc aw md bi"><span id="97b0" class="me kf hi ma b fi mf mg l mh mi">brew install wrk</span></pre><p id="0afd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用<em class="mj"> Wrk </em>您可以在一段定义的时间内生成许多并发请求。稍后我将使用它来运行一些基准测试。在此之前，让我为Laravel安装应用服务器及其桥。</p><h1 id="557b" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">安装Roadrunner</h1><p id="3d56" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">现在我将安装应用服务器，稍后我将安装Laravel桥。</p><p id="2d47" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">应用服务器的GitHub库是:<a class="ae jy" href="https://github.com/spiral/roadrunner-binary" rel="noopener ugc nofollow" target="_blank">https://github.com/spiral/roadrunner-binary</a></p><p id="8a51" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要安装Roadrunner，您需要:</p><ul class=""><li id="b38a" class="lh li hi is b it iu ix iy jb lj jf lk jj ll jn lm ln lo lp bi translated">安装应用服务器的PHP包；</li><li id="42d0" class="lh li hi is b it lq ix lr jb ls jf lt jj lu jn lm ln lo lp bi translated">获取应用服务器的二进制文件(可执行文件)；</li><li id="c9de" class="lh li hi is b it lq ix lr jb ls jf lt jj lu jn lm ln lo lp bi translated">确保<em class="mj"> rr </em>二进制可执行(可执行权限)；</li><li id="1078" class="lh li hi is b it lq ix lr jb ls jf lt jj lu jn lm ln lo lp bi translated">通过<em class="mj"> .rr.yaml </em>文件配置应用服务器。</li></ul><pre class="lv lw lx ly fd lz ma mb mc aw md bi"><span id="786d" class="me kf hi ma b fi mf mg l mh mi">composer require spiral/roadrunner:v2.0 nyholm/psr7<br/>./vendor/bin/rr  get-binary<br/>chmod u+x rr</span></pre><h1 id="49c7" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">安装Roadrunner Laravel桥</h1><p id="06fd" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">为了让Laravel与应用服务器一起正常工作，您需要安装Roadrunner Laravel Bridge，然后发布Laravel Bridge的配置文件:</p><pre class="lv lw lx ly fd lz ma mb mc aw md bi"><span id="5728" class="me kf hi ma b fi mf mg l mh mi">composer require spiral/roadrunner-laravel "^4.0"<br/>php artisan vendor:publish --provider='Spiral\RoadRunnerLaravel\ServiceProvider' --tag=config</span></pre><h1 id="0da8" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">配置Roardrunner</h1><p id="9afe" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">应用服务器的配置在文件<em class="mj"> .rr.yaml </em>中。</p><p id="b9dc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们示例的基本配置可能是这样的:</p><pre class="lv lw lx ly fd lz ma mb mc aw md bi"><span id="b277" class="me kf hi ma b fi mf mg l mh mi">server:<br/>  # If you want to use Unix socket for internal communication:<br/>  #command: "php ./vendor/bin/rr-worker start --relay-dsn unix://rr-laravel-rpc.sock"<br/>  #relay: "unix://rr-laravel-rpc.sock"<br/>  # If you want to use TCP socket for internal communication:<br/>  command: "php ./vendor/bin/rr-worker start --relay-dsn tcp://127.0.0.1:7001"<br/>  relay: "tcp://127.0.0.1:7001"<br/>​<br/>http:<br/>  # The Web application is served via 8080 port<br/>  address: 0.0.0.0:8080<br/>  middleware: ["headers", "static", "gzip"]<br/>  pool:<br/>    num_workers: 4<br/>    max_jobs: 64<br/>    supervisor:<br/>      exec_ttl: 60s<br/>  headers:<br/>    response:<br/>      X-Powered-By: "RoadRunner"<br/>  static:<br/>    dir: "public"<br/>    forbid: [".php"]<br/>​</span></pre><h1 id="64de" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">启动应用服务器</h1><p id="0648" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">用刚刚下载的新的“<em class="mj"> rr </em>”可执行文件启动应用服务器:</p><pre class="lv lw lx ly fd lz ma mb mc aw md bi"><span id="30bf" class="me kf hi ma b fi mf mg l mh mi">./rr serve -c ./.rr.yaml</span></pre><p id="f945" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一旦应用服务器启动，根据配置(<em class="mj"> num_workers </em> ) 4个工作器被启动，准备好服务Laravel应用程序。</p><p id="17d0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">根据配置文件中的“<em class="mj">地址</em>”参数，Laravel应用暴露在8080端口上。</p><h1 id="9360" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">执行测试比较，Nginx与Roadrunner</h1><p id="bd37" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">为了执行测试，我将使用“<em class="mj"> wrk </em>”来生成流量和2个不同的URL，每个URL引用两个不同的服务:</p><ul class=""><li id="5e2c" class="lh li hi is b it iu ix iy jb lj jf lk jj ll jn lm ln lo lp bi translated"><a class="ae jy" href="http://laravel-turbo.test/" rel="noopener ugc nofollow" target="_blank">http://laravel-turbo.test/</a>:用本地地址127.0.0.1解析，并将回复Nginx Web服务器；</li><li id="2511" class="lh li hi is b it lq ix lr jb ls jf lt jj lu jn lm ln lo lp bi translated"><a class="ae jy" href="http://laravel-turbo.test:8080/" rel="noopener ugc nofollow" target="_blank">http://laravel-turbo.test:8080/</a>:用本地地址解析，端口8080被Roadrunner应用服务器绑定。</li></ul><p id="1047" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我将使用一些特定的选项:</p><ul class=""><li id="a753" class="lh li hi is b it iu ix iy jb lj jf lk jj ll jn lm ln lo lp bi translated">要使用的4个线程；</li><li id="bb70" class="lh li hi is b it lq ix lr jb ls jf lt jj lu jn lm ln lo lp bi translated">20个连接保持开放；</li><li id="5cdb" class="lh li hi is b it lq ix lr jb ls jf lt jj lu jn lm ln lo lp bi translated">测试持续时间为10秒。</li></ul><p id="5a20" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，为了测试Nginx:</p><pre class="lv lw lx ly fd lz ma mb mc aw md bi"><span id="b393" class="me kf hi ma b fi mf mg l mh mi">wrk -t4 -c20 -d10s <a class="ae jy" href="http://laravel-turbo.test" rel="noopener ugc nofollow" target="_blank">http://laravel-turbo.test</a></span></pre><p id="ace9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于测试Roadrunner:</p><pre class="lv lw lx ly fd lz ma mb mc aw md bi"><span id="349d" class="me kf hi ma b fi mf mg l mh mi">wrk -t4 -c20 -d10s <a class="ae jy" href="http://laravel-turbo.test:8080" rel="noopener ugc nofollow" target="_blank">http://laravel-turbo.test:8080</a></span></pre><p id="c0a7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">结果是不同。</p><p id="bbfc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于Nginx，我在10秒钟内收到了478个请求:</p><figure class="lv lw lx ly fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mk"><img src="../Images/47347e9a3a41e02d4aff5db5048637a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QOwSZl5gQ30UPq_nGm42SQ.png"/></div></div><figcaption class="ml mm et er es mn mo bd b be z dx">4 threads, 20 connections keep open, to Nginx</figcaption></figure><p id="de9a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于Roardrunner，我在10秒钟内收到了1728个请求</p><figure class="lv lw lx ly fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mp"><img src="../Images/73e34323764644678e339a90fafb7104.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C6lhMubxu-jqvXMf4JD-hw.png"/></div></div></figure><p id="84d8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">差别令人印象深刻。Roadrunner比Nginx快多了。</p><h1 id="6a4f" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">一些考虑</h1><p id="3d16" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">使用Roadrunner而不是传统的Web服务器为Laravel应用程序提供服务的主要区别在于:</p><ul class=""><li id="b3a5" class="lh li hi is b it iu ix iy jb lj jf lk jj ll jn lm ln lo lp bi translated">应用程序被引导一次，多个请求将共享相同的资源。</li><li id="e366" class="lh li hi is b it lq ix lr jb ls jf lt jj lu jn lm ln lo lp bi translated">控制器的构造被调用一次(当工人被实例化时)</li><li id="96cb" class="lh li hi is b it lq ix lr jb ls jf lt jj lu jn lm ln lo lp bi translated">想想“静态”类属性会发生什么</li></ul><p id="0974" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我来解释一个例子。</p><p id="b656" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在routes/web.php中创建2条路由:</p><pre class="lv lw lx ly fd lz ma mb mc aw md bi"><span id="ff5c" class="me kf hi ma b fi mf mg l mh mi">use App\Http\Controllers\MainController;</span><span id="f7f0" class="me kf hi ma b fi mq mg l mh mi">Route::get('/', [MainController::class, 'index']);</span><span id="1bb0" class="me kf hi ma b fi mq mg l mh mi">Route::get('/show', [MainController::class, 'show']);</span></pre><p id="c53e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在app/Http/Controllers目录中创建MainController.php，您可以:</p><ul class=""><li id="9171" class="lh li hi is b it iu ix iy jb lj jf lk jj ll jn lm ln lo lp bi translated">定义一个静态属性(数组)$ list</li><li id="820d" class="lh li hi is b it lq ix lr jb ls jf lt jj lu jn lm ln lo lp bi translated">定义index方法，将一个随机整数追加到self::$list数组中；</li><li id="249e" class="lh li hi is b it lq ix lr jb ls jf lt jj lu jn lm ln lo lp bi translated">定义show方法，在其中使用并显示self::$list数组</li></ul><pre class="lv lw lx ly fd lz ma mb mc aw md bi"><span id="a9c0" class="me kf hi ma b fi mf mg l mh mi">&lt;?php</span><span id="53e2" class="me kf hi ma b fi mq mg l mh mi">namespace App\Http\Controllers;</span><span id="532d" class="me kf hi ma b fi mq mg l mh mi">use Illuminate\Http\Request;</span><span id="ac28" class="me kf hi ma b fi mq mg l mh mi">class MainController extends Controller</span><span id="1aae" class="me kf hi ma b fi mq mg l mh mi">{</span><span id="c583" class="me kf hi ma b fi mq mg l mh mi">  public static $list = [];</span><span id="fc55" class="me kf hi ma b fi mq mg l mh mi">  public function index()</span><span id="76bb" class="me kf hi ma b fi mq mg l mh mi">  {</span><span id="0a2f" class="me kf hi ma b fi mq mg l mh mi">    self::$list[]= \random_int(1,6);</span><span id="f2d5" class="me kf hi ma b fi mq mg l mh mi">    return view('welcome');</span><span id="7ea8" class="me kf hi ma b fi mq mg l mh mi">  }</span><span id="ffe3" class="me kf hi ma b fi mq mg l mh mi">  public function show()</span><span id="41e2" class="me kf hi ma b fi mq mg l mh mi">  {</span><span id="b35d" class="me kf hi ma b fi mq mg l mh mi">    return view('show', ["list" =&gt; self::$list]);</span><span id="f5fa" class="me kf hi ma b fi mq mg l mh mi">  }</span><span id="266d" class="me kf hi ma b fi mq mg l mh mi">}</span></pre><p id="a586" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您调用多次http://laravel-turbo.test:8080/，它将被称为索引方法，所以一些整数将被添加到您的列表中。静态列表在同一个worker上的请求之间共享。因此，如果你试图调用<a class="ae jy" href="http://laravel-turbo.test:8080/show" rel="noopener ugc nofollow" target="_blank">http://laravel-turbo.test:8080/show</a>，它将被调用显示方法，其中将使用列表属性。</p><p id="69ee" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">所以我认为，对于PHP开发人员来说，在应用服务器环境中工作是一个巨大的变化，特别是考虑到请求的生命周期。PHP开发人员通常习惯于在每个请求中引用所有的框架。</p><p id="ba51" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">可能Laravel Octane将负责为每个请求向Laravel公开一个干净的状态，使PHP开发人员的生活更加轻松。</p><p id="c99f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你同意这些考虑吗？</p><p id="04b4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请随意发表一些评论和/或反馈。</p></div></div>    
</body>
</html>