<html>
<head>
<title>Email Templating with EJS (Node + Express + SendGrid)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用EJS的电子邮件模板(Node + Express + SendGrid)</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/email-templating-with-ejs-node-sendgrid-8f98dacef572?source=collection_archive---------0-----------------------#2019-12-26">https://medium.com/geekculture/email-templating-with-ejs-node-sendgrid-8f98dacef572?source=collection_archive---------0-----------------------#2019-12-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/ec06aa559e98db394cae28530cd72e36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MM2L7g1BEHa8ski3RCAM5A.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Photo by <a class="ae iu" href="https://unsplash.com/@mockaroon?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Mockaroon</a> on <a class="ae iu" href="https://unsplash.com/s/photos/template?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="49ac" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我一直在建立一个社交链接网站<a class="ae iu" href="https://www.8link.in/?ref=medium" rel="noopener ugc nofollow" target="_blank"> 8link </a>，这需要我与不同层次的用户互动。因此，我将与我的用户进行电子邮件交互的类型缩小到以下几类电子邮件:</p><ol class=""><li id="0ae4" class="jt ju hi ix b iy iz jc jd jg jv jk jw jo jx js jy jz ka kb bi translated">欢迎电子邮件(带验证链接)</li><li id="7e69" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">密码重置链接</li><li id="cb7e" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">对用户查询的自动响应</li><li id="fd77" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">对用户查询的实际响应</li><li id="d3c7" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">不定期的促销或时事通讯</li></ol><p id="6ca1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我一直在使用Node.js +Express后端，我想用同样的框架来实现它。所以我开始使用SendGrid <a class="ae iu" href="https://sendgrid.com/solutions/email-api/" rel="noopener ugc nofollow" target="_blank">电子邮件API </a>来实现这个目标。</p><blockquote class="kh ki kj"><p id="1391" class="iv iw kk ix b iy iz ja jb jc jd je jf kl jh ji jj km jl jm jn kn jp jq jr js hb bi translated">SendGrid已经有了一个模板服务，如果你有兴趣可以在这里查看<a class="ae iu" href="https://sendgrid.com/docs/ui/sending-email/how-to-send-an-email-with-dynamic-transactional-templates/" rel="noopener ugc nofollow" target="_blank">。</a></p></blockquote><p id="6e65" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">回到EJS模板，在这篇文章中，我们将看到如何用EJS创建可重用的HTML模板，然后用SendGrid交付它们。</p><p id="39dd" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们将首先创建一个简单的节点项目:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="26c0" class="kx ky hi kt b fi kz la l lb lc">npm init sendgrid-mailer</span></pre><p id="afe8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">安装下列依赖项，</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="71f8" class="kx ky hi kt b fi kz la l lb lc">npm i --save express cors ejs </span></pre><p id="5887" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们的Package.json应该是这样的:</p><figure class="ko kp kq kr fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ld"><img src="../Images/fb10f8d47d7b3b3704d98bdaa727b55f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4KnnrY1HX6LCh8S7djHtNw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">package.json file</figcaption></figure></div><div class="ab cl le lf gp lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="hb hc hd he hf"><p id="3119" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们创建一个简单的端点来服务我们的电子邮件“/hello”</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="199c" class="kx ky hi kt b fi kz la l lb lc">Notice //set express view engine to ejs<br/>app.set(“view engine”, “ejs”);</span></pre><figure class="ko kp kq kr fd ij"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="b80d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">它应该会给我们以下响应:</p><figure class="ko kp kq kr fd ij er es paragraph-image"><div class="er es ln"><img src="../Images/a882aea0faf336e7593a5e2227e748c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/format:webp/1*bX6CnP-NNwnBN1Rxuh6v2w.png"/></div><figcaption class="iq ir et er es is it bd b be z dx">/hello on localhost</figcaption></figure><p id="53a2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们已经完成了一半，现在在项目根目录的views (Template)文件夹中创建一个<em class="kk"> welcome-mail.ejs </em>文件。</p><figure class="ko kp kq kr fd ij er es paragraph-image"><div class="er es lo"><img src="../Images/d335eaaa2f2ceafe5dedaf262d02f59a.png" data-original-src="https://miro.medium.com/v2/resize:fit:798/format:webp/1*0dtPUAeab8tupUAwxjKfLg.png"/></div></figure><p id="a40c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在在这里添加一些HTML代码，它将作为我们欢迎邮件的底层模板:</p><figure class="ko kp kq kr fd ij"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="f375" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您将在这个HTML中看到以下语法，它用于在呈现数据之前接收数据。我们使用以下变量来处理数据:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="b635" class="kx ky hi kt b fi kz la l lb lc">//these are EJS expressions to dynamically receive and display data while rendering an HTML</span><span id="f247" class="kx ky hi kt b fi lp la l lb lc">&lt;%= user_firstname %&gt;<br/>&lt;%= confirm_link %&gt;</span></pre><p id="a562" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，我们需要对“/hello”端点进行更改</p><p id="51a0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们需要将以下内容导入到index.js文件中:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="ff87" class="kx ky hi kt b fi kz la l lb lc">//imports<br/>const path = require(“path”);<br/>const ejs = require(“ejs”);</span></pre><p id="c69f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们的“/hello”应用程序路线功能将变为:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="9fce" class="kx ky hi kt b fi kz la l lb lc">app.get(“/hello”, (<em class="kk">req</em>, <em class="kk">res</em>, <em class="kk">next</em>) =&gt; {<br/>let emailTemplate;<br/>let capitalizedFirstName = “John”;<br/>let userEmail = “John@example.com”;</span><span id="0262" class="kx ky hi kt b fi lp la l lb lc">ejs<br/>.renderFile(path.join(__dirname, “views/welcome-mail.ejs”), <br/>{<br/>  user_firstname: capitalizedFirstName,<br/>  confirm_link: “http://www.8link.in/confirm=" + userEmail<br/>})<br/>.then(<em class="kk">result</em> =&gt; {<br/>  emailTemplate = result;<br/>  res.send(emailTemplate);<br/>})<br/>.catch(<em class="kk">err</em> =&gt; {<br/>  res.status(400).json({<br/>      message: “Error Rendering emailTemplate”,<br/>      error: err<br/>     });<br/>  });</span><span id="57b1" class="kx ky hi kt b fi lp la l lb lc">});</span></pre><p id="484b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这里，<strong class="ix hj"> ejs.renderFile() </strong>取。ejs文件路径并指定值为<strong class="ix hj"><em class="kk">user _ first name</em></strong>和<strong class="ix hj"> <em class="kk"> confirm_link </em> </strong></p><p id="6c09" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，如果我们点击“/hello ”,就会得到:</p><figure class="ko kp kq kr fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lq"><img src="../Images/a1faed0b771b1d55379eb3b70e949931.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y5Gtffdna1ZO_N3J-X62xQ.png"/></div></div></figure><p id="71ad" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">呜呜..我们现在有了欢迎模板，现在只需通过电子邮件发送即可。</strong></p></div><div class="ab cl le lf gp lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="hb hc hd he hf"><h2 id="9a38" class="kx ky hi bd lr ls lt lu lv lw lx ly lz jg ma mb mc jk md me mf jo mg mh mi mj bi translated">现在让我们集成SendGrid:</h2><blockquote class="kh ki kj"><p id="d63a" class="iv iw kk ix b iy iz ja jb jc jd je jf kl jh ji jj km jl jm jn kn jp jq jr js hb bi translated">首先注册SendGrid邮件API，点击<a class="ae iu" href="https://sendgrid.com/docs/API_Reference/api_v3.html" rel="noopener ugc nofollow" target="_blank">这里</a>并获得API -KEY</p></blockquote><p id="40a1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在从npm获取@sendgrid/mail包。</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="0615" class="kx ky hi kt b fi kz la l lb lc">npm i --save @sendgrid/mail</span></pre><p id="fefd" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将以下内容导入<strong class="ix hj"> index.js </strong></p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="c230" class="kx ky hi kt b fi kz la l lb lc">const SGmail = require(“@sendgrid/mail”);</span></pre><p id="8622" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，在我们的代码中，首先注册SendGrid API密钥</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="f49a" class="kx ky hi kt b fi kz la l lb lc">SGmail.setApiKey(process.env.SendGrid_Key);</span><span id="fb77" class="kx ky hi kt b fi lp la l lb lc">//Note: store SendGrid_Key in your projects' config file</span></pre><p id="a23d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">并替换<strong class="ix hj">RES . send(email template)；</strong>用以下代码:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="8d67" class="kx ky hi kt b fi kz la l lb lc">const message = {<br/>  to: userEmail,<br/>  from: { email: “welcome@8link.in”, name: “8link” },<br/>  subject: “Welcome link”,<br/>  html: emailTemplate<br/>};</span><span id="e883" class="kx ky hi kt b fi lp la l lb lc">return SGmail.send(message).then(<em class="kk">sent</em> =&gt; {</span><span id="812d" class="kx ky hi kt b fi lp la l lb lc">// Awesome Logic to check if mail was sent</span><span id="a49a" class="kx ky hi kt b fi lp la l lb lc">   res.status(200).json({<br/>      message: “Welcome mail was sent”</span><span id="6ff0" class="kx ky hi kt b fi lp la l lb lc">      });</span><span id="8d37" class="kx ky hi kt b fi lp la l lb lc">}).catch(<em class="kk">err</em> =&gt; {</span><span id="c46c" class="kx ky hi kt b fi lp la l lb lc">      console.log(“Error sending mail”, err);<br/>      res.status(400).json({<br/>          message: “Welcome mail was not sent”,<br/>          error: err<br/>      });</span><span id="e7de" class="kx ky hi kt b fi lp la l lb lc">});</span></pre><p id="5028" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们最终的代码应该是这样的:</p><figure class="ko kp kq kr fd ij"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="c02e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果我再次点击“/hello”端点，我应该会看到邮件发送成功:</p><figure class="ko kp kq kr fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mk"><img src="../Images/bded64b80cfebeeede6d0bf3e22de477.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V4fQgNhZOtrM7FzSkOEcRQ.png"/></div></div></figure><blockquote class="kh ki kj"><p id="5ed1" class="iv iw kk ix b iy iz ja jb jc jd je jf kl jh ji jj km jl jm jn kn jp jq jr js hb bi translated">Github上的完整代码:<br/><a class="ae iu" href="https://github.com/far11ven/SendGrid-Mailer" rel="noopener ugc nofollow" target="_blank">https://github.com/far11ven/SendGrid-Mailer</a></p></blockquote></div><div class="ab cl le lf gp lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="hb hc hd he hf"><p id="64ba" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="kk">原载于2019年12月26日【https://kushalbhalaik.xyz/blog】<a class="ae iu" href="https://kushalbhalaik.xyz/blog/email-templating-with-ejs-node-express-sendgrid/" rel="noopener ugc nofollow" target="_blank"><em class="kk"/></a><em class="kk">。</em></em></p></div></div>    
</body>
</html>