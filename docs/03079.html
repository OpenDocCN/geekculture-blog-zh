<html>
<head>
<title>When pandas.json_normalize Doesn't Work</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">pandas.json_normalize不起作用时</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/when-pandas-json-normalize-doesnt-work-ff5f9a0abc7d?source=collection_archive---------8-----------------------#2021-05-31">https://medium.com/geekculture/when-pandas-json-normalize-doesnt-work-ff5f9a0abc7d?source=collection_archive---------8-----------------------#2021-05-31</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="0086" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用Jupyter-Notebook将嵌套的JSON文件展平为Pandas数据框架的另一种解决方案。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/2ecb08bbb478d28656098fc0ecbf14b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9T0AU3hiZSU3w_TJPeT6ow.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Photo by <a class="ae jt" href="https://boolxr.medium.com/" rel="noopener">Author</a></figcaption></figure><ul class=""><li id="6949" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">数据集属于<a class="ae jt" href="https://ev.caltech.edu/dataset" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> ACN-Data </strong> </a></li><li id="5a26" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">我的个人代码和JSON文件(<em class="ki"> acndata_sessions </em>)可以在我的<a class="ae jt" href="https://github.com/jguev/nested-dataframe" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> GitHub </strong> </a>上找到</li></ul><p id="8896" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">几个月前，我被指派从事一个机器学习项目，我发现了一个非常有趣的数据集。该数据集提供了对用户期望的洞察。它包括一系列可选的用户输入，提高了我可以训练的模型的质量。我被它的潜力所吸引，我把JSON文件添加到了我的Jupyter笔记本上。</p><p id="c282" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了感受前面繁琐道路的重量，我想快速描述一下什么是JSON文件。JSON (JavaScript Object Notation)文件是最常见的数据表示格式之一。它们是独立于语言的，遵循一种非常轻量级的直观结构，这种结构是为了方便人机之间交换数据而创建的。为了实现这一点，JSON文件必须遵循一些语法规则:</p><ol class=""><li id="490f" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc kj ka kb kc bi translated">在名称/值对中存储数据</li></ol><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/1ae4c13777c9f45b0f4d5b73c4953217.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mZFZeMO2idL7fxMF0OSeTA.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Photo by <a class="ae jt" href="https://boolxr.medium.com/" rel="noopener">Author</a></figcaption></figure><p id="9948" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.将数据存储在有序的值列表中</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/8215282b616ae7da0f7c482ab2081523.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V5HfTR_vOk-1ml130NpQCg.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Photo by <a class="ae jt" href="https://boolxr.medium.com/" rel="noopener">Author</a></figcaption></figure><p id="1e43" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我在项目中使用的JSON文件包含了这两个规则，总共持续了11，522个会话。当时，我对JSON文件的经验非常少，在将它应用到我的工作空间之前，我忽略了对它的检查。如果我仔细检查过，我会承认我的JSON文件是嵌套的，需要一点操作。</p><p id="dc23" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="ki"> acndata_sessions </em>文件有三个嵌套级别:</p><ol class=""><li id="7a3a" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc kj ka kb kc bi translated">" meta "，" items "</li><li id="4273" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc kj ka kb kc bi translated">" _id "、" clusterID "、" connectionTime "、" disconnectTime "、" doneChargingTime "、" kWhDelivered "、" sessionID "、" siteID "、" spaceID "、" stationID "、" timezone "、" userID "、" userInputs "</li><li id="ec6c" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc kj ka kb kc bi translated">" WhPerMile "，" kWhRequested "，" T12 "，" milesRequested "，" minutesAvailable "，" modifiedAt "，" paymentRequired "，" requestedDeparture "，" userID "</li></ol><p id="95ef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">考虑到这些键最终会在数据帧中采用列，如果不进行任何操作，该文件应该总共有23列。然而，在我的应用程序中，我决定省略元数据。我还决定更进一步，使用“_items”通过第一个嵌套层直接填充我的DataFrame。</p><pre class="je jf jg jh fd kk kl km kn aw ko bi"><span id="c8f8" class="kp kq hi kl b fi kr ks l kt ku">df = pd.DataFrame(data[‘_items’])</span></pre><p id="b5ca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这意味着我加载的数据将减少到21列。</p><ol class=""><li id="4660" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc kj ka kb kc bi translated">" _id "、" clusterID "、" connectionTime "、" disconnectTime "、" doneChargingTime "、" kWhDelivered "、" sessionID "、" siteID "、" spaceID "、" stationID "、" timezone "、" userID "、" userInputs "</li><li id="d37c" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc kj ka kb kc bi translated">" WhPerMile "，" kWhRequested "，" T13 "，" milesRequested "，" minutesAvailable "，" modifiedAt "，" paymentRequired "，" requestedDeparture "，" userID "</li></ol><p id="c0bd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不幸的是，事实并非如此，我的数据框架显示了11，522行13列。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/76626a241071224b98e8b70ea5a3a1e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QWKXFI_qu2_Py8E55OJO6A.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Photo by <a class="ae jt" href="https://boolxr.medium.com/" rel="noopener">Author</a></figcaption></figure></div><div class="ab cl kv kw gp kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="hb hc hd he hf"><h1 id="084d" class="lc kq hi bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">问题是</h1><p id="6960" class="pw-post-body-paragraph if ig hi ih b ii lz ik il im ma io ip iq mb is it iu mc iw ix iy md ja jb jc hb bi translated">我的DataFrame没有显示JSON文件表示的所有列。经过仔细检查，我注意到最后一列将丢失的钥匙存储为一个列表，而不是单独的列——于是开始了搜索。</p><p id="e872" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">幸运的是，JSON文件本质上是嵌套的，有很多方法可以解决这个问题。我决定参考pandas文档并应用内置解决方案<strong class="ih hj"> pandas.json_normalize </strong>。</p><pre class="je jf jg jh fd kk kl km kn aw ko bi"><span id="f513" class="kp kq hi kl b fi kr ks l kt ku">df = pd.json_normalize(data[‘_items’])</span></pre><p id="6bc7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">尽管使用了额外的命令，我的数据框显示了相同的结果。</p><h1 id="ae02" class="lc kq hi bd ld le me lg lh li mf lk ll lm mg lo lp lq mh ls lt lu mi lw lx ly bi translated">我的解决方案</h1><p id="af53" class="pw-post-body-paragraph if ig hi ih b ii lz ik il im ma io ip iq mb is it iu mc iw ix iy md ja jb jc hb bi translated"><em class="ki">我将把这作为任何厌恶硬编码价值观的程序员的先驱:你可以在这个时刻自由离开，或者通过这个迭代暂时接受环境，你已经被警告了。</em></p><p id="ee6f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我的方法是手动挖掘嵌套的第13列“userInputs”。</p><h2 id="db77" class="kp kq hi bd ld mj mk ml lh mm mn mo ll iq mp mq lp iu mr ms lt iy mt mu lx mv bi translated">步骤1:添加列名</h2><p id="6827" class="pw-post-body-paragraph if ig hi ih b ii lz ik il im ma io ip iq mb is it iu mc iw ix iy md ja jb jc hb bi translated">我分配了一个变量<strong class="ih hj"> column_names </strong>来存储嵌套在第13列中的未寻址列(“用户输入”)。这样做之后，我使用<a class="ae jt" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.reindex.html" rel="noopener ugc nofollow" target="_blank"> reindex </a>扩展了当前的DataFrame，并为<strong class="ih hj"> column_names </strong>中的每个值分配了一列。接下来，我用占位符0值填充每一行，这是我多年来采用的个人偏好。</p><pre class="je jf jg jh fd kk kl km kn aw ko bi"><span id="09a1" class="kp kq hi kl b fi kr ks l kt ku">column_names =[“WhPerMile”,”kWhRequested”,<br/> “milesRequested”,”minutesAvailable”,”modifiedAt”,”paymentRequired”,”requestedDeparture”,”userID”]</span><span id="a8c6" class="kp kq hi kl b fi mw ks l kt ku"># add hardcoded columns to the dataframe<br/>df = df.reindex(columns = df.columns.tolist() + column_names).fillna(0) <br/>df = pd.DataFrame(df)</span></pre><h2 id="3cbd" class="kp kq hi bd ld mj mk ml lh mm mn mo ll iq mp mq lp iu mr ms lt iy mt mu lx mv bi translated">步骤2:填充行</h2><p id="1a39" class="pw-post-body-paragraph if ig hi ih b ii lz ik il im ma io ip iq mb is it iu mc iw ix iy md ja jb jc hb bi translated">为了访问“userInputs”中的嵌套元素，我使用了直接遍历<strong class="ih hj">数据[' _ items '][I][' user inputs ']</strong>，其中的<strong class="ih hj"> i </strong>表示每个单独的会话。因为总共有11，522个会话，所以我使用了代码中前面声明的变量<strong class="ih hj"> bottom </strong>来建立我的for循环的范围。</p><p id="800f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">事后看来，我要感谢我执行了第一步，避免了一个我有幸为之做好准备的问题。正如我在本文开头提到的:</p><p id="a05a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">“它包括一系列可选的用户输入，提高了我可以训练的模型的质量。”</p><p id="1e8f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该关键字是可选的。在11，522个会话中，只有一些会话包含此可选数据。如果我之前没有用0填充我的行，我可能会遇到一些问题。</p><p id="5430" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">完整的逻辑是这样的:</p><pre class="je jf jg jh fd kk kl km kn aw ko bi"><span id="19a2" class="kp kq hi kl b fi kr ks l kt ku">column_names =[“WhPerMile”,”kWhRequested”,<br/> “milesRequested”,”minutesAvailable”,”modifiedAt”,”paymentRequired”,”requestedDeparture”,”userID”]</span><span id="2e88" class="kp kq hi kl b fi mw ks l kt ku"># add hardcoded columns to the dataframe<br/>df = df.reindex(columns = df.columns.tolist() + column_names).fillna(0) <br/>df = pd.DataFrame(df)</span><span id="f564" class="kp kq hi kl b fi mw ks l kt ku">for i in range(bottom):<br/> nested = data[‘_items’][i][‘userInputs’]<br/> if nested:<br/> for n in column_names:<br/> df.loc[i, n]=nested[0][n]<br/> # i — row indexer<br/> # i iterates through every row recorded in bottom<br/> # n — column indexer<br/> # n iterates through the hardcoded column_names</span></pre><h2 id="6d2e" class="kp kq hi bd ld mj mk ml lh mm mn mo ll iq mp mq lp iu mr ms lt iy mt mu lx mv bi translated">步骤3:删除不必要的行</h2><pre class="je jf jg jh fd kk kl km kn aw ko bi"><span id="9c99" class="kp kq hi kl b fi kr ks l kt ku">df = df.drop(columns=’userInputs’) <br/># this column was a reference to the columns we just flattened and therefore is no longer required</span></pre><h2 id="d9ac" class="kp kq hi bd ld mj mk ml lh mm mn mo ll iq mp mq lp iu mr ms lt iy mt mu lx mv bi translated">结果:</h2><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/78a221438cd7101cd63ef38ddc93f229.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V1LvxI739pmNImChMWqDjQ.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Photo by <a class="ae jt" href="https://boolxr.medium.com/" rel="noopener">Author</a></figcaption></figure></div><div class="ab cl kv kw gp kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="hb hc hd he hf"><p id="6487" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您想提交错误报告、问题或文档建议，请通过<a class="ae jt" href="https://github.com/jguev/nested-dataframe" rel="noopener ugc nofollow" target="_blank"> GitHub </a>提交问题。感谢阅读！</p></div></div>    
</body>
</html>