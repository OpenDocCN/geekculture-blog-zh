<html>
<head>
<title>Authenticate Go-GraphQL with JWT</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">向JWT认证Go-GraphQL</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/authenticate-go-graphql-with-jwt-436c74340d?source=collection_archive---------8-----------------------#2021-08-24">https://medium.com/geekculture/authenticate-go-graphql-with-jwt-436c74340d?source=collection_archive---------8-----------------------#2021-08-24</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/99795dcebee76a8da7935f81bb1394de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fHCalZHXSVLYARTikN0QDw.png"/></div></div></figure><div class=""/><div class=""><h2 id="9e6d" class="pw-subtitle-paragraph iq hs ht bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh dx translated">用JWT保护您的API</h2></div><p id="3ba5" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">当你开发一个web应用程序时，当然，认证和授权是应用于你的应用程序的正常事情；限制来宾访问您的资源的某些内容。<br/>一个web应用的认证和授权有几种方式，其中最著名的是<a class="ae ke" href="https://jwt.io/introduction" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu">【JWT】</strong></a>。</p><h1 id="25aa" class="kf kg ht bd kh ki kj kk kl km kn ko kp iz kq ja kr jc ks jd kt jf ku jg kv kw bi translated">什么是JWT？</h1><p id="0fdb" class="pw-post-body-paragraph ji jj ht jk b jl kx iu jn jo ky ix jq jr kz jt ju jv la jx jy jz lb kb kc kd hb bi translated">JWT (JSON Web Token)是使用JSON格式在各方之间安全传输信息的媒介。JWT可以用秘钥(<a class="ae ke" href="https://www.geeksforgeeks.org/hmac-algorithm-in-computer-network/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> HMAC </strong> </a>算法)或公钥(<a class="ae ke" href="https://www.geeksforgeeks.org/rsa-algorithm-cryptography/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> RSA </strong> </a>或<a class="ae ke" href="https://www.hypr.com/elliptic-curve-digital-signature-algorithm/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> ECDSA </strong> </a>)签名</p><p id="efa2" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">JWT结构分为三部分<code class="du lc ld le lf b">xxxxx.yyyyy.zzzzz</code>:</p><ul class=""><li id="f966" class="lg lh ht jk b jl jm jo jp jr li jv lj jz lk kd ll lm ln lo bi translated">页眉</li><li id="17e2" class="lg lh ht jk b jl lp jo lq jr lr jv ls jz lt kd ll lm ln lo bi translated">有效载荷</li><li id="9787" class="lg lh ht jk b jl lp jo lq jr lr jv ls jz lt kd ll lm ln lo bi translated">签名</li></ul><figure class="lv lw lx ly fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lu"><img src="../Images/dea2957ccab7e4ebe91bb05eaf7baac2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vw-_fTNB4OpmvPp60819nA.png"/></div></div><figcaption class="lz ma et er es mb mc bd b be z dx"><a class="ae ke" href="https://jwt.io" rel="noopener ugc nofollow" target="_blank">https://jwt.io</a></figcaption></figure><p id="c675" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu">头</strong>包含令牌使用的算法，以及“<em class="md"> JWT </em>”。<br/> <strong class="jk hu">有效载荷</strong>包含了关于数据的声明(信息)。<br/> <strong class="jk hu">签名</strong>包含哈希头的符号、有效载荷、秘密和算法，这部分用来验证JSON是否有效。</p><h1 id="84b4" class="kf kg ht bd kh ki kj kk kl km kn ko kp iz kq ja kr jc ks jd kt jf ku jg kv kw bi translated"><strong class="ak">要求</strong></h1><ul class=""><li id="4b3f" class="lg lh ht jk b jl kx jo ky jr me jv mf jz mg kd ll lm ln lo bi translated">github.com/99designs/gqlgen</li><li id="ee79" class="lg lh ht jk b jl lp jo lq jr lr jv ls jz lt kd ll lm ln lo bi translated">github.com/dgrijalva/jwt-go</li><li id="2fc4" class="lg lh ht jk b jl lp jo lq jr lr jv ls jz lt kd ll lm ln lo bi translated">gorm.io/gorm</li><li id="b746" class="lg lh ht jk b jl lp jo lq jr lr jv ls jz lt kd ll lm ln lo bi translated">github.com/gorilla/mux</li><li id="4751" class="lg lh ht jk b jl lp jo lq jr lr jv ls jz lt kd ll lm ln lo bi translated">github.com/google/uuid</li><li id="cd53" class="lg lh ht jk b jl lp jo lq jr lr jv ls jz lt kd ll lm ln lo bi translated">docker &amp; docker-compose(数据库/可选)</li></ul><p id="13f2" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">当然，还有一些go编程和GraphQL模式的基础知识。这样你们就能更好地理解我的工作了。</p><p id="3783" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">使用<a class="ae ke" href="https://gqlgen.com" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> gqlgen </strong> </a>，我们将生成我们的GraphQL服务器。对于数据库，我们将使用MySQL并使用<a class="ae ke" href="https://gorm.io" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> GORM </strong> </a>，<a class="ae ke" href="https://github.com/gorilla/mux" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> mux </strong> </a>连接到数据库，对于HTTP路由器，使用<a class="ae ke" href="https://github.com/dgrijalva/jwt-go" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> jwt-go </strong> </a>生成并验证jwt。</p><p id="7904" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">知识库:<a class="ae ke" href="https://github.com/david-yappeter/go-graphql-jwt" rel="noopener ugc nofollow" target="_blank">https://github.com/david-yappeter/go-graphql-jwt</a></p></div><div class="ab cl mh mi gp mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="hb hc hd he hf"><h1 id="1fe1" class="kf kg ht bd kh ki mo kk kl km mp ko kp iz mq ja kr jc mr jd kt jf ms jg kv kw bi translated"><strong class="ak"> Graphql服务器</strong></h1><p id="21e9" class="pw-post-body-paragraph ji jj ht jk b jl kx iu jn jo ky ix jq jr kz jt ju jv la jx jy jz lb kb kc kd hb bi translated">首先，我们将创建项目目录并初始化go模块:</p><pre class="lv lw lx ly fd mt lf mu mv aw mw bi"><span id="88ba" class="mx kg ht lf b fi my mz l na nb">$ mkdir go-graphql-jwt &amp;&amp; cd go-graphql-jwt &amp;&amp; go mod init myapp</span><span id="8a9c" class="mx kg ht lf b fi nc mz l na nb"># Init Graphql Server<br/>$ go get github.com/99designs/gqlgen<br/>$ go run github.com/99designs/gqlgen init</span></pre><p id="d469" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">项目目录应该如下所示</p><figure class="lv lw lx ly fd hk er es paragraph-image"><div class="er es nd"><img src="../Images/56448c4ff4e4ef655f12f172ff86a481.png" data-original-src="https://miro.medium.com/v2/resize:fit:654/format:webp/1*c6qOJytihIhhFkpjRN9WCg.png"/></div><figcaption class="lz ma et er es mb mc bd b be z dx">After gqlgen init</figcaption></figure><p id="bb0b" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">然后我们将在<code class="du lc ld le lf b">schema.graphqls</code>中创建我们的用户模型:</p><figure class="lv lw lx ly fd hk"><div class="bz dy l di"><div class="ne nf l"/></div></figure><p id="266d" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">为了帮助你更快地生成代码，试着把它写在你的<code class="du lc ld le lf b">graph/resolver.go</code>里</p><p id="11f8" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><code class="du lc ld le lf b">//go:generate go run github.com/99designs/gqlgen</code></p><figure class="lv lw lx ly fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ng"><img src="../Images/c5d5d1a3637d6b1ea312dd74f99c6eb0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_6CqzlqkSGYr2EK5V-1iyA.png"/></div></div></figure><p id="95da" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">然后，您将能够通过在您的终端上运行<code class="du lc ld le lf b">go generate ./...</code>来生成代码。</p><p id="f617" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">在生成你的代码之后，应该会有一些剩余的代码给你一个错误，只需要删除那部分。</p><figure class="lv lw lx ly fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es nh"><img src="../Images/a323ba2b44074d216fd2963573befe7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*sHjH6YyZWlej6xSiTyB85g.gif"/></div></div><figcaption class="lz ma et er es mb mc bd b be z dx">Remove leftover code</figcaption></figure><p id="9cce" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">然后我们将把我们的<code class="du lc ld le lf b">User</code>模型移到外面，以避免被生成器覆盖。</p><p id="976d" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">我们将向模型添加<code class="du lc ld le lf b">Password</code>属性，这样GORM就可以自动插入密码。</p><figure class="lv lw lx ly fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ni"><img src="../Images/5f80c2f8cee10f18764fe6d3ec838940.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*3OS52ptEUVBrbD99HXw_7w.gif"/></div></div></figure><p id="e12d" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">将<code class="du lc ld le lf b">gorm</code>标签添加到模型中，这将有助于我们稍后的表迁移。</p><figure class="lv lw lx ly fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es nj"><img src="../Images/a2623bb39fd3d7785838a125dc198e60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XUWMOkJ5Za3w2_-uUEGdMQ.png"/></div></div></figure></div><div class="ab cl mh mi gp mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="hb hc hd he hf"><h1 id="b912" class="kf kg ht bd kh ki mo kk kl km mp ko kp iz mq ja kr jc mr jd kt jf ms jg kv kw bi translated">数据库配置</h1><p id="4cb1" class="pw-post-body-paragraph ji jj ht jk b jl kx iu jn jo ky ix jq jr kz jt ju jv la jx jy jz lb kb kc kd hb bi translated">下一步是创建我们的数据库连接，我们将使用GORM，它是一种帮助我们更快开发和更好维护代码的形式。</p><p id="8d94" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><code class="du lc ld le lf b">config/database.go</code></p><figure class="lv lw lx ly fd hk"><div class="bz dy l di"><div class="ne nf l"/></div></figure><p id="e1fa" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">可选地，我们可以在我们的<code class="du lc ld le lf b">server.go</code>上添加数据库close</p><figure class="lv lw lx ly fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es nk"><img src="../Images/8627a1d42cc215e21634efaebcbe206c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lxfs0Q4LFgRpnR9a9ci3sg.png"/></div></div><figcaption class="lz ma et er es mb mc bd b be z dx">database defer close (optional)</figcaption></figure></div><div class="ab cl mh mi gp mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="hb hc hd he hf"><h1 id="1667" class="kf kg ht bd kh ki mo kk kl km mp ko kp iz mq ja kr jc mr jd kt jf ms jg kv kw bi translated"><strong class="ak">带有Docker &amp; Docker-Compose </strong>的MySQL数据库</h1><p id="233c" class="pw-post-body-paragraph ji jj ht jk b jl kx iu jn jo ky ix jq jr kz jt ju jv la jx jy jz lb kb kc kd hb bi translated">在根目录下添加一个<code class="du lc ld le lf b">docker-compose.yml</code>文件:</p><figure class="lv lw lx ly fd hk"><div class="bz dy l di"><div class="ne nf l"/></div></figure><p id="e2f2" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">并使用以下命令运行它:</p><p id="1c16" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><code class="du lc ld le lf b">docker-compose up -d</code></p><p id="6833" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">不要忘记在数据库配置的根目录中添加<code class="du lc ld le lf b">.env</code>，示例如下:</p><figure class="lv lw lx ly fd hk er es paragraph-image"><div class="er es nl"><img src="../Images/021ea79f269e3cd7a5f0afc478de7b5a.png" data-original-src="https://miro.medium.com/v2/resize:fit:704/format:webp/1*TVozNNN-ynYhoypEfKPEPg.png"/></div></figure><h1 id="6fe0" class="kf kg ht bd kh ki kj kk kl km kn ko kp iz kq ja kr jc ks jd kt jf ku jg kv kw bi translated"><strong class="ak"> JWT &amp;用户服务</strong></h1><p id="add2" class="pw-post-body-paragraph ji jj ht jk b jl kx iu jn jo ky ix jq jr kz jt ju jv la jx jy jz lb kb kc kd hb bi translated">我们将在<code class="du lc ld le lf b">service</code>目录中编写我们的JWT和用户服务。<br/> Jwt会有<code class="du lc ld le lf b">JwtGenerate</code>和<code class="du lc ld le lf b">JwtValidate</code>。<br/>用户将有<code class="du lc ld le lf b">UserCreate</code>、<code class="du lc ld le lf b">UserGetByID</code>、<code class="du lc ld le lf b">UserGetByEmail</code>、<br/>授权将有<code class="du lc ld le lf b">UserRegister</code>和<code class="du lc ld le lf b">UserLogin</code>。</p><p id="e5fc" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><code class="du lc ld le lf b">service/jwt.go</code></p><figure class="lv lw lx ly fd hk"><div class="bz dy l di"><div class="ne nf l"/></div></figure><p id="efaf" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">通过<code class="du lc ld le lf b">jwt.NewWithClaims</code>，它将创建一个带有我们的<em class="md">自定义声明</em>的令牌，我们传入第二个参数，在本例中为<code class="du lc ld le lf b">JwtCustomClaim</code>。创建令牌后，我们需要用我们的<code class="du lc ld le lf b">JWT_SECRET</code>值对令牌进行签名，以确保令牌的安全。</p><p id="be09" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">稍后，为了验证令牌，我们使用<code class="du lc ld le lf b">JwtValidate</code>,它将令牌作为参数，并返回<code class="du lc ld le lf b">*jwt.Token</code>作为返回值。<br/><code class="du lc ld le lf b">jwt.ParseWithClaims</code>回调是如何工作的，首先，我们检查令牌的签名方法，我们使用一个秘密<code class="du lc ld le lf b">HS256</code>来签名令牌，所以我们检查令牌的签名方法是否是<code class="du lc ld le lf b">*jwt.SigningMethodHMAC</code>，如果是，我们将返回秘密，所以如果‘秘密’有效，<code class="du lc ld le lf b">Jwt.ParseWithClaims</code>将返回&lt; nil &gt;错误。</p><p id="f25f" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">稍后，我们将从中间件部分的<code class="du lc ld le lf b">*Jwt.Token</code>中获取<code class="du lc ld le lf b">JwtCustomClaim</code>值。</p><p id="e332" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">在我们转向<code class="du lc ld le lf b">User</code>服务之前，我们将首先创建一个密码哈希工具。</p><p id="6dff" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><code class="du lc ld le lf b">tools/bcrypt.go</code></p><figure class="lv lw lx ly fd hk"><div class="bz dy l di"><div class="ne nf l"/></div><figcaption class="lz ma et er es mb mc bd b be z dx">Hash using Bcrypt</figcaption></figure><p id="b0d6" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">然后我们将创建我们的<code class="du lc ld le lf b">User</code>服务</p><p id="d1d0" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><code class="du lc ld le lf b">service/user.go</code></p><figure class="lv lw lx ly fd hk"><div class="bz dy l di"><div class="ne nf l"/></div></figure><p id="5d56" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">在我们创建用户之前，首先我们散列密码，然后给出由<code class="du lc ld le lf b">github.com/google/uuid</code>生成的随机<code class="du lc ld le lf b">uuid</code>。</p><p id="02e4" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">然后继续进行<code class="du lc ld le lf b">auth.go</code>维修。</p><p id="fc8e" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><code class="du lc ld le lf b">service/auth.go</code></p><figure class="lv lw lx ly fd hk"><div class="bz dy l di"><div class="ne nf l"/></div></figure><p id="f6e5" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">在<code class="du lc ld le lf b">UserRegister</code>中，我们会先找到用户。如果找不到用户，我们可以创建帐户并返回JWT。</p><p id="6284" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">对于<code class="du lc ld le lf b">UserLogin</code>，我们会找到用户。如果找到用户，我们返回JWT。</p><p id="0a4d" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">然后我们将该函数应用于<code class="du lc ld le lf b">schema.resolvers.go</code></p><p id="1b27" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><code class="du lc ld le lf b">graph/schema.resolvers.go</code></p><figure class="lv lw lx ly fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es nm"><img src="../Images/fc2c781d7fbea9049b97bf28fd3f4e4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qJIERl4p0SkYsgC5C8voaQ.png"/></div></div><figcaption class="lz ma et er es mb mc bd b be z dx">assign the function</figcaption></figure><h1 id="894c" class="kf kg ht bd kh ki kj kk kl km kn ko kp iz kq ja kr jc ks jd kt jf ku jg kv kw bi translated"><strong class="ak">添加数据库表迁移</strong></h1><p id="c50a" class="pw-post-body-paragraph ji jj ht jk b jl kx iu jn jo ky ix jq jr kz jt ju jv la jx jy jz lb kb kc kd hb bi translated">我们将在<code class="du lc ld le lf b">migration</code>目录下创建迁移。</p><p id="011a" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><code class="du lc ld le lf b">migration/migration.go</code></p><figure class="lv lw lx ly fd hk"><div class="bz dy l di"><div class="ne nf l"/></div></figure><p id="4ace" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">我们需要将它应用于<code class="du lc ld le lf b">server.go</code>:</p><figure class="lv lw lx ly fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es nn"><img src="../Images/f21a1ad791711c3334010f089a33e677.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J2AMffvbG9G1QwtUAiZd0w.png"/></div></div><figcaption class="lz ma et er es mb mc bd b be z dx">apply the migration to server.go</figcaption></figure><h1 id="8327" class="kf kg ht bd kh ki kj kk kl km kn ko kp iz kq ja kr jc ks jd kt jf ku jg kv kw bi translated"><strong class="ak">认证中间件&amp;指令</strong></h1><p id="8efd" class="pw-post-body-paragraph ji jj ht jk b jl kx iu jn jo ky ix jq jr kz jt ju jv la jx jy jz lb kb kc kd hb bi translated">对于中间件，我们将在<code class="du lc ld le lf b">middlewares</code>目录下创建它。</p><p id="ac7e" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><code class="du lc ld le lf b">middlewares/auth.go</code></p><figure class="lv lw lx ly fd hk"><div class="bz dy l di"><div class="ne nf l"/></div></figure><p id="b8b0" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><code class="du lc ld le lf b">AuthMiddleware</code>将被分配给<code class="du lc ld le lf b">mux</code>路由器，稍后，它将从头部获取<code class="du lc ld le lf b">Authorization</code>的值并验证令牌，然后将其分配给请求<code class="du lc ld le lf b">context</code>，稍后我们可以通过调用从<code class="du lc ld le lf b">context</code>获取CustomClaim的<code class="du lc ld le lf b">CtxValue</code>来使用该值。</p><p id="fa1c" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">在此之后，我们将创建<code class="du lc ld le lf b">Auth</code>指令，该指令将应用于GraphQL受保护的资源，我们将需要更改我们的<code class="du lc ld le lf b">graph/schema.graphqls</code></p><p id="ac9e" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><code class="du lc ld le lf b">graph/schema.graphqls</code></p><figure class="lv lw lx ly fd hk"><div class="bz dy l di"><div class="ne nf l"/></div></figure><p id="b173" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">然后再次生成我们的解析器。将在<code class="du lc ld le lf b">schema.resolvers.go</code>中添加“受保护”</p><figure class="lv lw lx ly fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es no"><img src="../Images/1b09ab34a24af9597cb0af9268aa79fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nURcVG2meQpDN0IKckelsQ.png"/></div></div></figure><p id="1490" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">添加一个简单的返回“成功”，nil。</p><p id="675d" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">我们需要做的最后一件事是，创建函数并将其应用到指令中</p><figure class="lv lw lx ly fd hk"><div class="bz dy l di"><div class="ne nf l"/></div></figure><p id="8016" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">通过复制该部分将其应用于<code class="du lc ld le lf b">server.go</code></p><figure class="lv lw lx ly fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es np"><img src="../Images/f52ab46ad26cdb784d243bdbdc766542.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c6pmuxyRjLsqXwETNlsceA.png"/></div></div><figcaption class="lz ma et er es mb mc bd b be z dx">Apply directives</figcaption></figure><p id="74b3" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">我们的中间件和指令部分已经完成</p></div><div class="ab cl mh mi gp mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="hb hc hd he hf"><h1 id="764c" class="kf kg ht bd kh ki mo kk kl km mp ko kp iz mq ja kr jc mr jd kt jf ms jg kv kw bi translated"><strong class="ak">应用中间件</strong></h1><p id="df87" class="pw-post-body-paragraph ji jj ht jk b jl kx iu jn jo ky ix jq jr kz jt ju jv la jx jy jz lb kb kc kd hb bi translated">我们将在<code class="du lc ld le lf b">server.go</code>创建新的<code class="du lc ld le lf b">mux</code>路由器</p><figure class="lv lw lx ly fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es nq"><img src="../Images/27d7dfaac9c255516bcf0a77fe45e221.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BOudOEHjxd13p4qN-CFZ_w.png"/></div></div><figcaption class="lz ma et er es mb mc bd b be z dx">Initialize router and apply middleware</figcaption></figure><p id="805d" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><code class="du lc ld le lf b">router.Use(middlewares.AuthMiddleware)</code>将完成认证工作，而<code class="du lc ld le lf b">Auth</code>指令将在GraphQL中处理授权。</p><h1 id="43be" class="kf kg ht bd kh ki kj kk kl km kn ko kp iz kq ja kr jc ks jd kt jf ku jg kv kw bi translated"><strong class="ak">测试</strong></h1><p id="8ed3" class="pw-post-body-paragraph ji jj ht jk b jl kx iu jn jo ky ix jq jr kz jt ju jv la jx jy jz lb kb kc kd hb bi translated">使用<code class="du lc ld le lf b">go run server.go</code>运行我们的代码。</p><figure class="lv lw lx ly fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lu"><img src="../Images/d5dc887e23148054652b9d0da5c3405b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iAxcP-sRULR58XIcOAWxfw.png"/></div></div><figcaption class="lz ma et er es mb mc bd b be z dx">Access Protected without JWT</figcaption></figure><p id="70ac" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">当我们试图在没有JWT的情况下访问<code class="du lc ld le lf b">Protected</code>时，它会返回我们从指令中得到的<code class="du lc ld le lf b">Access Denied</code>。</p><p id="88dc" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">所以让我们试着注册用户&amp;登录。</p><figure class="lv lw lx ly fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lu"><img src="../Images/55e000981dba970e479fd17e64ec1df1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UzR_HasB2rUIg-J0-s-LqQ.png"/></div></div><figcaption class="lz ma et er es mb mc bd b be z dx">Register User</figcaption></figure><figure class="lv lw lx ly fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lu"><img src="../Images/14b24d31c27e9be4eba8d68e5fcdd636.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FRbBxGhst3RPZk1k-IowgQ.png"/></div></div><figcaption class="lz ma et er es mb mc bd b be z dx">Log in</figcaption></figure><p id="a9f8" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">现在，我将尝试将令牌添加到标头<code class="du lc ld le lf b">Authorization</code></p><figure class="lv lw lx ly fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lu"><img src="../Images/254dc490298b90252744619a0fb780c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t12GCOuqZ2Psuy1eyJxBvA.png"/></div></div><figcaption class="lz ma et er es mb mc bd b be z dx">Access protected with token</figcaption></figure><p id="db5e" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">现在它不会返回任何错误。</p><p id="c745" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">这是Go-GraphQL JWT的文章的结尾。希望对你有帮助:)。</p></div></div>    
</body>
</html>