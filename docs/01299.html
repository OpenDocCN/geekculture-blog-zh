<html>
<head>
<title>Load Configuration Environment Variables into Angular Efficiently When Using SSR</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用SSR时，有效地将配置环境变量加载到Angular中</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/load-configuration-environment-variables-into-angular-efficiently-when-using-ssr-6474c34bb675?source=collection_archive---------6-----------------------#2021-04-05">https://medium.com/geekculture/load-configuration-environment-variables-into-angular-efficiently-when-using-ssr-6474c34bb675?source=collection_archive---------6-----------------------#2021-04-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/d38d821353204eb411575b676f347536.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WsmYf2gFfPbQyQBCp49fjg.png"/></div></div></figure><p id="2c73" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">通常，在不重新构建项目的情况下加载环境变量是很有用的，比如将同一个项目部署到具有不同配置的不同服务器(或docker实例)上。</p><p id="b5ad" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">目标是加载配置而不等待，并执行HTTP请求。这种技术避免了对第一个加载页面的负面影响(有人说是灯塔吗？).</p><p id="3fe9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，最佳策略是在运行服务器端渲染(SSR)节点进程时加载环境变量，并将它们存储到index.html文件中。<br/>看看怎么做:</p><ol class=""><li id="61d5" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">将环境变量放入一个json文件中，并作为env.json保存到assets文件夹中:</li></ol><pre class="jx jy jz ka fd kb kc kd ke aw kf bi"><span id="c07f" class="kg kh hi kc b fi ki kj l kk kl">env.json</span><span id="e381" class="kg kh hi kc b fi km kj l kk kl">{<br/> "apiUrl": "<a class="ae kn" href="https://example.com" rel="noopener ugc nofollow" target="_blank">https://example.com</a>",<br/> "version": "1.1",<br/> …<br/>}</span></pre><p id="cdad" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2.修改index.html放置一个占位符，便于替换变量:</p><pre class="jx jy jz ka fd kb kc kd ke aw kf bi"><span id="3f08" class="kg kh hi kc b fi ki kj l kk kl">index.html</span><span id="93db" class="kg kh hi kc b fi km kj l kk kl">&lt;html&gt;<br/> &lt;head&gt;<br/> &lt;!-- ENV BEGIN --&gt;<br/> &lt;!-- ENV END --&gt;<br/> …<br/> &lt;/head&gt;<br/>&lt;/html&gt;</span></pre><p id="9cd4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.运行节点SSR流程时，将变量加载并替换到index.html文件中:</p><pre class="jx jy jz ka fd kb kc kd ke aw kf bi"><span id="a86a" class="kg kh hi kc b fi ki kj l kk kl">server.ts</span><span id="1dd4" class="kg kh hi kc b fi km kj l kk kl">...<br/>const injectEnvInline = function (filename, envs) {<br/> let _template_index = fs.readFileSync(filename).toString();</span><span id="0b7b" class="kg kh hi kc b fi km kj l kk kl">// Find env script link<br/> const env_begin_position = _template_index.indexOf('&lt;!-- ENV BEGIN --&gt;');<br/> const env_end_position = _template_index.indexOf('&lt;!-- ENV END --&gt;');<br/> const env_link = _template_index.substring(env_begin_position, env_end_position);<br/> <br/> // Remove env script link and injecting inline environment variables_template_index = _template_index.replace(env_link, envs);<br/> fs.writeFileSync(filename , _template_index, {encoding: 'utf-8'});<br/>};</span><span id="1bea" class="kg kh hi kc b fi km kj l kk kl">// Read environment settings<br/>const settings = JSON.parse(fs.readFileSync('assets/env.json').toString());<br/>const env: any = [];<br/>let inline_env = '&lt;!-- ENV BEGIN --&gt;&lt;script&gt;window[\'_env\'] = []; ';<br/>for (const key in settings) {<br/> if (settings.hasOwnProperty(key)) {<br/> env[key] = settings[key];<br/> inline_env += 'window[\'_env\'].' + key + '= \'' + settings[key] + '\'; ';<br/> }<br/>}<br/>inline_env += '&lt;/script&gt;';</span><span id="ddaf" class="kg kh hi kc b fi km kj l kk kl">injectEnvInline('index.html', inline_env);</span></pre><p id="959e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4.只有当我们使用angular service worker (ngsw): <br/>由于我们修改了index.html文件，然后我们必须更新他的散列存储到ngsw.json文件。</p><pre class="jx jy jz ka fd kb kc kd ke aw kf bi"><span id="0bac" class="kg kh hi kc b fi ki kj l kk kl">server.ts</span><span id="4cde" class="kg kh hi kc b fi km kj l kk kl">...<br/>const changeIndexHtmlHash = function (filename, newHash: string) {<br/>  let _template_ngsw = fs.readFileSync(filename).toString();</span><span id="0ec6" class="kg kh hi kc b fi km kj l kk kl">// Find index.html hash row<br/>  const index_begin_position = template_ngsw.lastIndexOf('"/index.html": "');<br/>  const index_end_position = index_begin_position + 57;<br/>  const new_index_hash = _template_ngsw.substring(index_begin_position, index_end_position);</span><span id="1e8b" class="kg kh hi kc b fi km kj l kk kl">_template_ngsw = _template_ngsw.replace(new_index_hash, '"/index.html": "' + newHash + '"');<br/>  fs.writeFileSync(filename , _template_ngsw, {encoding: 'utf-8'});<br/>};</span><span id="67f4" class="kg kh hi kc b fi km kj l kk kl">// Change index.html hash into ngsw.json<br/>const shasum = crypto.createHash('sha1');<br/>const indexHtmlStream = fs.ReadStream('./index.html');<br/>indexHtmlStream.on('data', function(d) { shasum.update(d); });<br/>indexHtmlStream.on('end', function() {<br/>  const newHash = shasum.digest('hex');<br/>  changeIndexHtmlHash('ngsw.json', newHash);<br/>});</span></pre><p id="4193" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">5.当运行服务器端模式时，传递变量并将它们注入到相关服务中:</p><pre class="jx jy jz ka fd kb kc kd ke aw kf bi"><span id="92d7" class="kg kh hi kc b fi ki kj l kk kl">server.ts</span><span id="8c00" class="kg kh hi kc b fi km kj l kk kl">...<br/>app.get('*', function(req, res) {<br/> res.render('index', {<br/>  req, res, providers: [<br/>   { provide: 'envSettings', useValue: env }<br/>   ]<br/>  }<br/> });<br/>});</span></pre><p id="b265" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">6.创建环境服务文件:</p><pre class="jx jy jz ka fd kb kc kd ke aw kf bi"><span id="e520" class="kg kh hi kc b fi ki kj l kk kl">env.service.ts</span><span id="2a4f" class="kg kh hi kc b fi km kj l kk kl">import {Inject, Injectable, Optional} from '<a class="ae kn" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';</span><span id="026c" class="kg kh hi kc b fi km kj l kk kl">export interface IEnvService {<br/>  "apiUrl": string;<br/>  "version": string;<br/>}</span><span id="fcdf" class="kg kh hi kc b fi km kj l kk kl"><a class="ae kn" href="http://twitter.com/Injectable" rel="noopener ugc nofollow" target="_blank">@Injectable</a>({providedIn: 'root'})<br/>export class EnvService {<br/>  settings: IEnvService = {} as null;<br/>  constructor(<a class="ae kn" href="http://twitter.com/Inject" rel="noopener ugc nofollow" target="_blank">@Inject</a>('envSettings') <a class="ae kn" href="http://twitter.com/Optional" rel="noopener ugc nofollow" target="_blank">@Optional</a>() private envSettings?: any) {<br/>    if (envSettings) {<br/>      this.settings = envSettings;<br/>    }<br/>  }<br/>}</span></pre><p id="3e2e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">7.将env服务注入app.server.module.ts文件:</p><pre class="jx jy jz ka fd kb kc kd ke aw kf bi"><span id="8b55" class="kg kh hi kc b fi ki kj l kk kl">...<br/>providers: [EnvService]</span></pre><p id="50dd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">8.运行客户端模式时加载环境变量:<br/>(注意:我们在<strong class="is hj">开发</strong>模式下运行时加载env.json文件，在<strong class="is hj">生产</strong>模式下运行时读取窗口['_env']键)</p><pre class="jx jy jz ka fd kb kc kd ke aw kf bi"><span id="368d" class="kg kh hi kc b fi ki kj l kk kl">main.ts</span><span id="f015" class="kg kh hi kc b fi km kj l kk kl">...<br/>document.addEventListener('DOMContentLoaded', () =&gt; {</span><span id="9e66" class="kg kh hi kc b fi km kj l kk kl">const start = (settings) =&gt; {<br/>         // environment.settings = settings.settings;<br/>         platformBrowserDynamic([{provide: 'envSettings', useValue: settings}])<br/>   .bootstrapModule(AppModule, {preserveWhitespaces: true})<br/>           .catch(err =&gt; console.log(err));<br/>       };</span><span id="20ab" class="kg kh hi kc b fi km kj l kk kl">let _env: any = {};<br/>       // In <strong class="kc hj">production</strong> mode<br/>       if (window &amp;&amp; window['_env'] !== undefined) {<br/>         const browserWindow = window;<br/>         const browserWindowEnv = browserWindow['_env'] || {};</span><span id="4bb6" class="kg kh hi kc b fi km kj l kk kl">// Assign environment variables from browser window to env<br/>         for (const key in browserWindowEnv) {<br/>           if (browserWindowEnv.hasOwnProperty(key)) {<br/>             _env[key] = window['_env'][key];<br/>           }<br/>         }</span><span id="6d0a" class="kg kh hi kc b fi km kj l kk kl">start(_env);<br/>       }<br/>       // In <strong class="kc hj">development</strong> mode<br/>       else {<br/>         const xhttp = new XMLHttpRequest();<br/>         xhttp.onreadystatechange = function () {<br/>           if (this.readyState === 4 &amp;&amp; this.status === 200) {<br/>             const response: IEnvService = JSON.parse(xhttp.responseText);<br/>             _env = response;</span><span id="5695" class="kg kh hi kc b fi km kj l kk kl">start(_env);<br/>           }<br/>         };<br/>         xhttp.open('GET', 'assets/env.json', true);<br/>         xhttp.send();<br/>       }<br/>});</span></pre><p id="2268" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">9.随时使用环境服务:</p><pre class="jx jy jz ka fd kb kc kd ke aw kf bi"><span id="1878" class="kg kh hi kc b fi ki kj l kk kl">app.module.ts</span><span id="fb4b" class="kg kh hi kc b fi km kj l kk kl">import {EnvService} from './env.service';<br/>...<br/>constructor(private envService: EnvService) {}</span><span id="5dc2" class="kg kh hi kc b fi km kj l kk kl">foo() {<br/> console.log('version', this.envService.settings.version);<br/>}</span></pre><p id="0a9a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">通过这些简单的步骤，我们已经达到了加载环境变量的目标，无需重新构建项目，无需HTTP请求<br/>，并且在开发过程中使用相同的文件配置(env.json)。</p></div></div>    
</body>
</html>