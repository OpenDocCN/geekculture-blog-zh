<html>
<head>
<title>The Ruby Unbundled Series: Add Microservices to your Rails App in Minutes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Ruby Unbundled系列:在几分钟内为你的Rails应用添加微服务</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/the-ruby-unbundled-series-add-microservices-to-your-rails-app-in-minutes-8a939e4744af?source=collection_archive---------5-----------------------#2021-02-17">https://medium.com/geekculture/the-ruby-unbundled-series-add-microservices-to-your-rails-app-in-minutes-8a939e4744af?source=collection_archive---------5-----------------------#2021-02-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/b2c43a570a660c1c7b6a61e73af1f2bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QRS7GoRjtilurNTm1aRpQA.jpeg"/></div></div></figure><p id="4adf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Rails是让您的web应用程序快速启动并运行的出色框架。许多创业公司已经成功地用它来启动他们的网站。也就是说，如果你不小心的话，你也可能落入软件整体陷阱。在Rails项目存储库中，许多关注点可能会纠缠在一起。一旦确定了这个场景，重构就成了一两个sprint的焦点，但是随着其他业务优先级的出现，重构通常会失去动力。</p><p id="45c9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">本文研究了一种简单的技术，您可以用它来扩展Rails应用程序，并向面向服务的架构风格发展。使用Rails，您可以基于现有的代码库以最少的工作量托管微服务。这可以为企业带来快速的成功，并为整个应用程序的持续重构奠定基础。</p><p id="93c5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">正如古训所说，“罗马不是一天建成的。”目标是让你的应用在每次冲刺时都不那么庞大。</p><p id="78d4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当你已经在一段代码中工作时，重构是有好处的。它允许你在这个过程中交付价值，这反过来又激发了对更多重构的持续投资。涉及的环境转换较少，可以利用总体规模经济。</p><h1 id="acc3" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">扩展Ruby问答应用程序</h1><p id="9bf6" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated"><a class="ae kr" href="https://github.com/engineyard/ruby-quiz/tree/microservice" rel="noopener ugc nofollow" target="_blank">Ruby quick</a>是一个简单的Rails应用程序，向用户提出五个问题。它在每个问题后提供反馈，并在最后向用户显示他们的总分。问题存储在同名的数据库表中，结果记录在尝试表中。网页如下所示。</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ks"><img src="../Images/ae2af11933625fdd0d357253ec5c2cfb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YvrYTzvCDi5LtYy8"/></div></div></figure><p id="bf9c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">假设管理层希望查看参加测验的用户的指标。测验是太难还是太容易？平均分是多少？大多数用户都完成了整个测验吗？</p><p id="3e9e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">理想的架构是添加一个报告数据库和一个新的web前端，使经理能够执行这种分析。Rails可以用来快速启动一个新的报告web应用程序，但是建立一个报告数据库比一个sprint需要做更多的工作。</p><p id="f2f4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，决定添加新的报告服务来公开数据。基于服务的方法避免了新的web应用程序必须从同一个数据库中读取数据，从而避免了任何数据库争用。我们的目标架构如下所示。</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div class="er es kx"><img src="../Images/856c63cb5cb778d5feac484aab15e9f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1006/0*ifjTNBKWqolfvWVp"/></div></figure><h1 id="b409" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">几分钟内的微服务</h1><p id="73f7" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">我们希望快速添加查询数据库并从尝试表返回数据的REST服务。此表列出了参加测验的每个参与者的结果。理想情况下，新的reporting services将使用与我们当前的测验应用程序相同的尝试模型类。</p><p id="ebd7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们已经有了一个包含相关逻辑和代码的QuizController，但是我们希望为我们的服务提供一个单独的端点。将服务放在新的DNS条目之后，可以让我们更加灵活地向前发展。随着我们构建更大的报告能力，它为我们的未来做好了准备。</p><p id="dd85" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这就是Rails可以帮忙的地方。每个控制器动作方法本身就是一个逻辑服务端点。当我们向routes.rb文件中添加条目，并且相应的请求被发送到指定的控制器时，通常会发生这种情况。</p><p id="2b04" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然而，我们可以更进一步。控制器动作方法本质上是它们自己的<a class="ae kr" href="https://github.com/rack/rack" rel="noopener ugc nofollow" target="_blank">框架应用</a>来响应HTTP请求。Rack是位于Rails和web服务器之间的中间件。我们可以使用rackup文件来启动将端点直接连接到我们编写的控制器方法的过程。使用这种方法允许新的微服务利用现有的模型类以及CI/CD管道。</p><p id="beae" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这可能不是我们的长期做法，但这是朝着正确方向迈出的一步。这个微服务应该在不同的容器或应用程序中运行吗？代码应该移动到它自己的存储库中吗？也许吧，但是你可以推迟这些决定，直到你收集到更多的数据。继续构建您的目标架构的其余部分，并关注您的服务指标。</p><p id="47e4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们首先添加一个微服务，它返回参加测验的参与者列表。为了简单起见，一开始不需要任何参数。该服务只返回用户名列表。一个新的参与者方法被添加到QuizController中，如下所示。</p><pre class="kt ku kv kw fd ky kz la lb aw lc bi"><span id="04eb" class="ld jp hi kz b fi le lf l lg lh">class QuizController &lt; ApplicationController # Other controller methods omitted here<br/>def participants </span><span id="edd6" class="ld jp hi kz b fi li lf l lg lh"> # This is our new service method<br/> response = {} <br/> response[ "participants" ] = Attempt .all.map { | attempt | attempt.taker } <br/> render :json =&gt; JSON [response] <br/>end <br/>end</span></pre><p id="9a5b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">注意，我们甚至没有为这个方法添加路由。这是为什么呢？因为我们将域和端口绑定直接连接到控制器动作。rackup文件是奇迹发生的地方。除非指定，<a class="ae kr" href="https://github.com/puma/puma/blob/61c6213fbab/lib/puma/configuration.rb#L10" rel="noopener ugc nofollow" target="_blank"> Puma web服务器</a>寻找config.ru文件。该文件默认版本中的重要一行运行整个Rails应用程序。</p><pre class="kt ku kv kw fd ky kz la lb aw lc bi"><span id="9426" class="ld jp hi kz b fi le lf l lg lh">run Rails.application</span></pre><p id="7df3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于新的微服务，会创建一个单独的机架备份文件config_svc_participant.ru。现有的config.ru文件将被保留以供web应用程序使用。新的rackup文件告诉Rack基于控制器的participant方法运行应用程序。</p><pre class="kt ku kv kw fd ky kz la lb aw lc bi"><span id="4a18" class="ld jp hi kz b fi le lf l lg lh"># This file is used by Rack-based servers to start the application.<br/>require_relative 'config/environment' <br/>run QuizController .action(:participants)</span></pre><p id="3374" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">以下命令指定此rackup文件，并在端口8080上运行服务，以避免与默认的web app端口3000冲突。</p><pre class="kt ku kv kw fd ky kz la lb aw lc bi"><span id="78c9" class="ld jp hi kz b fi le lf l lg lh">bundle exec puma -b tcp://0.0.0.0:8080 config_svc_participant.ru</span></pre><p id="3f83" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了测试，假设我们让Darren、Alice和Bob参加测验。使用Postman调用API，我们得到如下结果，显示了我们的三个参与者。</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lj"><img src="../Images/984e70e50dbd8aa95769eb8ed8326a62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*KFY1OjGR6NhDpxUt"/></div></div></figure><p id="064f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">同样，我们可以添加一个汇总微服务来返回平均分和高分。这方面的代码如下。</p><pre class="kt ku kv kw fd ky kz la lb aw lc bi"><span id="4cda" class="ld jp hi kz b fi le lf l lg lh">def summary<br/> sum_of_correct_answers = 0 <br/> high_score = 0 <br/> attempts = Attempt .all <br/> attempts.each do | attempt | <br/># Maintain the sum so we can calculate the average later <br/> sum_of_correct_answers = sum_of_correct_answers + attempt.number_correct <br/># Check if this is the new high score <br/>if attempt.number_correct &gt; high_score <br/> high_score = attempt.number_correct <br/>end <br/>end </span><span id="692d" class="ld jp hi kz b fi li lf l lg lh"> response = {} <br/> response[ "number_of_participants" ] = attempts.size <br/> response[ "average_score" ] = (sum_of_correct_answers.to_f / attempts.size.to_f).round( 2 ) <br/> response[ "high_score" ] = high_score <br/> render :json =&gt; JSON [response] <br/>end</span></pre><p id="8bb3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们还为这个微服务创建了一个rackup文件，并在端口8081上运行它。如果三名参与者的分数分别为3、5和3，则服务返回以下数据。</p><pre class="kt ku kv kw fd ky kz la lb aw lc bi"><span id="1c2e" class="ld jp hi kz b fi le lf l lg lh">{<br/>"number_of_participants" : 3 , <br/>"average_score" : 3.67 , <br/>"high_score" : 5 <br/>} <br/>Hope you found this useful and let us know what micro-applications you are able to build on Rails.</span></pre><h1 id="99b7" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">利用容器实现可伸缩性</h1><p id="8392" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">使用容器作为部署机制有很多很好的理由。就本主题而言，可伸缩性是一个主要因素。我们只是添加了一些将由同一个应用程序提供的服务。从逻辑上讲，它们表现为不同的微服务，但我们使用相同的应用程序让它们快速启动并运行。</p><p id="d572" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在许多情况下，您的web应用程序和服务将有不同的伸缩需求。使用模式和资源利用率会有所不同。容器为这些不同的用例提供了一个灵活伸缩的好方法。</p><p id="55fb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们之前用来为每个服务运行应用程序的不同命令变成了Dockerfile的CMD语句。对于您部署的每个服务，只需要更改域/端口绑定和机架备份文件</p><p id="1e78" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我希望您发现这种模式很有用，并期待看到您构建的优秀服务！</p></div><div class="ab cl lk ll gp lm" role="separator"><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp"/></div><div class="hb hc hd he hf"><p id="ae46" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lr">最初发表于</em><a class="ae kr" href="https://blog.engineyard.com/ruby-unbundled-add-microservices-to-rails-app" rel="noopener ugc nofollow" target="_blank"><em class="lr">【https://blog.engineyard.com】</em></a><em class="lr">。</em></p></div></div>    
</body>
</html>