<html>
<head>
<title>Inventing Games. Game Loop in JavaScript.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">发明游戏。JavaScript中的游戏循环。</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/inventing-games-game-loop-in-javascript-1cb0a5fcc81b?source=collection_archive---------16-----------------------#2021-07-30">https://medium.com/geekculture/inventing-games-game-loop-in-javascript-1cb0a5fcc81b?source=collection_archive---------16-----------------------#2021-07-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="0b7b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<a class="ae jd" rel="noopener" href="/geekculture/inventing-games-game-loop-a53a66cf874b">之前的帖子</a>中，我以一个简单的控制台应用程序为例解释了什么是游戏循环，现在我将向你展示如何在没有任何第三方解决方案的情况下借助JavaScript构建游戏循环。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/a24c033d9bee1725726a482d16532083.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sHhg8JTkA3bjwBXIxANwPQ.jpeg"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx">Photo by <a class="ae jd" href="https://www.pexels.com/@pixabay?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">Pixabay</a> from <a class="ae jd" href="https://www.pexels.com/photo/turned-on-red-and-green-nintendo-switch-371924/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">Pexels</a></figcaption></figure><h1 id="27f2" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">JS中的循环。</h1><p id="e420" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">在JavasCript中有几种组织循环的可能性，最常见的有:</p><ul class=""><li id="14aa" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lc ld le lf bi translated">for语句</li><li id="7686" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">do … while语句</li><li id="de39" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">while语句</li></ul><p id="07c4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">他们都很有名，因此，我想，我不会在这里描述他们。我真正想指出的是，这些陈述并不完全符合游戏开发的需求。有很多东西应该围绕这些语句手动构建；其中最主要的是帧同步(关于同步的更多细节请参见计算机图形学文章)。</p><div class="ll lm ez fb ln lo"><a href="https://antarh.medium.com/computer-graphics-frame-rate-48967ec615d" rel="noopener follow" target="_blank"><div class="lp ab dw"><div class="lq ab lr cl cj ls"><h2 class="bd hj fi z dy lt ea eb lu ed ef hh bi translated">计算机图形学。帧速率。</h2><div class="lv l"><h3 class="bd b fi z dy lt ea eb lu ed ef dx translated">当你通过代码创建一个动画时，你可能会遇到跳帧或者画面闪烁的情况。这个故事旨在…</h3></div><div class="lw l"><p class="bd b fp z dy lt ea eb lu ed ef dx translated">antarh.medium.com</p></div></div><div class="lx l"><div class="ly l lz ma mb lx mc jo lo"/></div></div></a></div><p id="853c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果默认语言循环帮不了我们，我们该怎么办？答案是:使用setInterval和requestAnimationFrame函数。</p><h1 id="7216" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">setInterval函数。</h1><p id="30d0" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">关于这个函数我们应该了解什么？</p><blockquote class="md me mf"><p id="1494" class="if ig mg ih b ii ij ik il im in io ip mh ir is it mi iv iw ix mj iz ja jb jc hb bi translated">窗口和工作接口上提供的setInterval()方法重复调用一个函数或执行一段代码，每次调用之间有固定的时间延迟</p><p id="958f" class="if ig mg ih b ii ij ik il im in io ip mh ir is it mi iv iw ix mj iz ja jb jc hb bi translated"><strong class="ih hj"> — MDN网络文档。</strong></p></blockquote><p id="e2e3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du mk ml mm mn b">Fixed time delay between each call</code>听起来很神奇！这意味着我们可以设置帧速率，并确保每个调用将以相同的时间间隔重新绘制游戏状态。让我们看看如何在它的帮助下创建一个游戏循环:</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="mo mp l"/></div><figcaption class="jq jr et er es js jt bd b be z dx">Set Interval Example.</figcaption></figure><p id="f8a9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">酷，我们完成了！但是等等……让我想想，<code class="du mk ml mm mn b">1000 / 60 = 1.6666666666666666... ms</code>那不等于1/60秒。它将被舍入到某个最接近的值，但不相同。此外，如果您的代码需要完成的不止是<code class="du mk ml mm mn b">1.6666666666666666... ms</code>,那么前一个循环一完成，下一个循环就会运行。这样的话，帧率会受到影响。为了检查这种行为，我建议创建一个简单的html页面并添加以下内容。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="mo mp l"/></div><figcaption class="jq jr et er es js jt bd b be z dx">FPS Counter.</figcaption></figure><p id="eb8d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果一切正常，您应该会看到显示帧速率的随机数。如果你仔细观察，你会发现60 fps是罕见的情况，这意味着这种方法可能会导致flikers和帧跳过，正如上面提到的计算机图形文章中所讨论的那样。此外，我们需要考虑如何同步同一页面上的几个动画，每个动画都在自己的setInterval函数中运行。</p><p id="6bb4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">怎么处理？不行。因为不需要，JavaScript提供了另一个神奇的函数，叫做requestAnimationFrame。</p><h1 id="07de" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">requestAnimationFrame函数。</h1><blockquote class="md me mf"><p id="9163" class="if ig mg ih b ii ij ik il im in io ip mh ir is it mi iv iw ix mj iz ja jb jc hb bi translated">window.requestAnimationFrame()方法告诉浏览器您希望执行动画，并请求浏览器在下一次重画之前调用指定的函数来更新动画。</p><p id="0429" class="if ig mg ih b ii ij ik il im in io ip mh ir is it mi iv iw ix mj iz ja jb jc hb bi translated"><strong class="ih hj"> — MDN网络文档。</strong></p></blockquote><p id="2b90" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我反复阅读了这个定义几次，每次它的意思都消失了。为了更好地理解它，让我们在这里深入探讨一下。</p><p id="f561" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在浏览器中打开的每个页面都有一个与浏览上下文相关联的文档。每个文档都有一个动画帧回调列表和单个动画帧回调标识符。最初，列表是空的，标识符等于零。当我们在代码中定义requestAnimationFrame函数时，我们传递一个回调作为函数的参数。该回调被推送到动画帧回调列表。在定义中，这个过程被称为<code class="du mk ml mm mn b">tells the browser that you wish to perform an animation</code>。</p><p id="69e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">同时，浏览器定期安排一个<strong class="ih hj">单个</strong>任务，对浏览器环境中的所有动画进行采样。该任务循环遍历每个页面，并检查其可见性属性。如果一个页面是可见的，这些任务会查看动画帧回调列表，并并排调用它们。如果有许多回调或CPU负载过重，浏览器可以选择这样的帧速率，以便所有的动画可以尽可能平稳地运行。任务完成后，动画帧回调标识符加1。在定义中，这个过程被称为<code class="du mk ml mm mn b">the browser call a specified function to update an animation before the next repaint</code>。</p><p id="ca01" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你看到该功能提供的所有好处了吗？</p><ul class=""><li id="52ee" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lc ld le lf bi translated">我们不需要担心帧同步</li><li id="631b" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">所有动画将同时运行</li><li id="7297" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">如果我们的页面现在不是活动的，动画将不会运行</li></ul><p id="6c00" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们看看它是如何工作的。为此，我们需要删除setInterval函数，并重新编写我们的draw方法。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="mo mp l"/></div><figcaption class="jq jr et er es js jt bd b be z dx">Draw Function with <code class="du mk ml mm mn b">requestAnimationFrame Function</code></figcaption></figure><p id="0de4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">理想情况下，该示例在正常状态下应该显示60 FPS。但是，根据您的浏览器和CPU负载，结果可能会有所不同。</p><h1 id="6237" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">结论。</h1><p id="9eda" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">因此，正如我们所见，在JavaScript中组织游戏循环的最佳方式是利用requestAnimationFrame，如下面的代码片段所示:</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="mo mp l"/></div><figcaption class="jq jr et er es js jt bd b be z dx">Game Loop</figcaption></figure><p id="b1db" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">很简单，你不觉得吗？</p></div><div class="ab cl mq mr gp ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="hb hc hd he hf"><p id="1f00" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">感谢您的阅读。我希望你喜欢这个故事。你真诚的，亚历克斯。</p></div></div>    
</body>
</html>