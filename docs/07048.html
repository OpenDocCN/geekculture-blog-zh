<html>
<head>
<title>Database Testing with Cypress (Part 8)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Cypress测试数据库(第8部分)</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/database-testing-with-cypress-part-8-98bc8eff785d?source=collection_archive---------12-----------------------#2021-09-06">https://medium.com/geekculture/database-testing-with-cypress-part-8-98bc8eff785d?source=collection_archive---------12-----------------------#2021-09-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/a530f8e03b557b863d0dae16a92621d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Lw0n3sVRECHhKr4zk26Hlw.png"/></div></div></figure><p id="168e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你好，</p><p id="dad0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这个 Cypress框架中，我们做了一些cypress.io默认不提供的有用的补充。在本文中，我们将了解如何利用到SQL数据库的连接，并使用它来验证存储在数据库表中的值。</p><h2 id="08fe" class="jp jq hi bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">安装pg</h2><p id="9b7c" class="pw-post-body-paragraph iq ir hi is b it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj ko jl jm jn hb bi translated"><a class="ae jo" href="https://www.npmjs.com/package/pg" rel="noopener ugc nofollow" target="_blank"> pg </a>是Node.js .纯JavaScript和可选原生libpq绑定的非阻塞PostgreSQL客户端。我们将使用它作为JavaScript代码到SQL数据库的连接器。我们从执行以下命令开始:</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="0b25" class="jp jq hi ku b fi ky kz l la lb">npm install --save-dev pg</span></pre><p id="e73f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">pg应该在devDependencies末尾的<strong class="is hj"> <em class="lc"> package.json </em> </strong>文件中得到反映。</p><figure class="kp kq kr ks fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ld"><img src="../Images/f63a3358d1e0d87095a1407d815ba868.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yJ8Rs6-FL0NSWEezHTI6sQ.png"/></div></div><figcaption class="le lf et er es lg lh bd b be z dx">installing pg</figcaption></figure><h1 id="3fcf" class="li jq hi bd jr lj lk ll jv lm ln lo jz lp lq lr kc ls lt lu kf lv lw lx ki ly bi translated">连接到SQL数据库</h1><p id="f084" class="pw-post-body-paragraph iq ir hi is b it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj ko jl jm jn hb bi translated">为了连接到数据库，我们需要数据库的以下连接信息。我们将把这些信息添加到cypress.json文件末尾的“<strong class="is hj"> <em class="lc"> env </em> </strong>”对象中。</p><p id="0aed" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">cypress.json文件中的数据库连接详细信息:</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="c8cf" class="jp jq hi ku b fi ky kz l la lb">...  <br/>"env":{<br/>  "DB": {<br/>      "user": "myuser",<br/>      "host": "127.0.0.1",<br/>      "database": "pokemonDB",<br/>      "password": "pass",<br/>      "port": 32763<br/>  }<br/>}<br/>}</span></pre><p id="ae77" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在本文中，我们使用一个简单的"<strong class="is hj"><em class="lc">pokemon DB</em></strong>" DB，并将在一个" pokemon "表上执行我们的操作，该表包含以下与pokemon生物相关的信息:</p><figure class="kp kq kr ks fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lz"><img src="../Images/30643f09f198b455240dd32d8200f653.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L7BMSnReoOF7SbS7_if1Mw.png"/></div></div><figcaption class="le lf et er es lg lh bd b be z dx">pokemon Table data</figcaption></figure><p id="cb6e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们将从添加一个名为“数据库”的新Cypress任务开始。为此，我们将在cypress/plugins/index.js文件中添加一个新任务。这项任务接受两件主要的事情:</p><p id="d86b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">i) dbConfig —(这是使用Cypress.env() <br/>从cypress.json文件中检索的数据库连接信息)ii) sql —(这是我们需要执行的sql命令)</p><p id="0678" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"><em class="lc">cypress/plugins/index . js</em></strong>添加了一个名为<strong class="is hj">数据库</strong>的新任务后:</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="053b" class="jp jq hi ku b fi ky kz l la lb">/// &lt;reference types="cypress" /&gt;<br/>// ***********************************************************<br/>// This example plugins/index.js can be used to load plugins<br/>//<br/>// You can change the location of this file or turn off loading<br/>// the plugins file with the 'pluginsFile' configuration option.<br/>//<br/>// You can read more here:<br/>// https://on.cypress.io/plugins-guide<br/>// ***********************************************************<br/><br/>// This function is called when a project is opened or re-opened (e.g. due to<br/>// the project's config changing)<br/><br/>/**<br/> * @type {Cypress.PluginConfig}<br/> */<br/><br/> const fs = require('fs-extra');<br/> const pg = require("pg");<br/> const path = require('path');<br/> const cucumber = require('cypress-cucumber-preprocessor').default;<br/><br/>module.exports = (on, config) =&gt; {<br/>  on('file:preprocessor', cucumber());<br/>  // `on` is used to hook into various events Cypress emits<br/>  // `config` is the resolved Cypress config<br/><br/>  <br/> //Connects to an env db and fetches query result<br/> on("task", {<br/>  DATABASE ({ dbConfig, sql, values }) {<br/>    // const pool = new pg.Pool(config.db);<br/>    const pool = new pg.Pool(dbConfig);<br/>    try {<br/>        return pool.query(sql, values)<br/>    } catch (e) {<br/>    }<br/>  }<br/>});<br/>    <br/>  function getConfigurationByFile(env) {<br/>      const pathToConfigFile = path.resolve("cypress/config", `${env}.config.json`);<br/><br/>      return fs.readJson(pathToConfigFile);<br/>  }<br/>  //if no environment is provided, then QA env will be default<br/>  const env = config.env.configFile || "qa";  <br/><br/>  return getConfigurationByFile(env);<br/>};</span></pre><p id="35ff" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在为了执行一个简单的"<em class="lc">SELECT * FROM pokemon</em>" SQL查询，我们将创建一个名为<strong class="is hj"><em class="lc">DB _ test1 . feature</em></strong>file的示例特性文件</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="8209" class="jp jq hi ku b fi ky kz l la lb">@DB<br/>Feature: Test DB connection<br/>    @smoke @test<br/>    Scenario: Pokemon Table SQL query executions<br/>        Given I execute select all query on pokemon DB<br/>        When I execute selet query on pokemon DB, where name equals  "pikachu"</span></pre><p id="9ec2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">相应的JavaScript代码将如下所示。这里我们在“sql”参数下提供SQL查询部分。</p><p id="c348" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="lc"> dbSteps.js </em> </strong>文件:</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="1705" class="jp jq hi ku b fi ky kz l la lb">Given('I execute selet all query on pokemon DB',() =&gt; {<br/>    cy.task("DATABASE", {<br/>      dbConfig: Cypress.env("DB"),<br/>      sql: `<br/>      select * from pokemon    <br/>      `<br/>    }).then((result) =&gt; {<br/>      console.log(result.rows)<br/>    });<br/>  });</span></pre><p id="a9e2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后，在执行这个测试时，我们的代码将产生表中的所有记录，并将它们打印在控制台上。</p><h2 id="100c" class="jp jq hi bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">使用断言</h2><p id="9f5c" class="pw-post-body-paragraph iq ir hi is b it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj ko jl jm jn hb bi translated">为了对从DB中检索到的值进行断言，必须在我们获取“结果”对象的then块中完成。<br/> <strong class="is hj">对数据库查询结果进行断言的测试步骤代码:</strong></p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="80f7" class="jp jq hi ku b fi ky kz l la lb">When('I execute selet query on pokemon DB, where name equals {string}',(pokemonName) =&gt; {<br/>    cy.task("DATABASE", {<br/>      dbConfig: Cypress.env("DB"),<br/>      sql: `<br/>      select * from pokemon where Poke_Name = '${pokemonName}'   <br/>      `<br/>    }).then((result) =&gt; {<br/>      console.log(result.rows[0]);<br/>        expect(result.rows[0].Poke_Name).to.have.string(`${pokemonName}`);<br/>    });<br/>  });</span></pre><blockquote class="ma mb mc"><p id="ccb7" class="iq ir lc is b it iu iv iw ix iy iz ja md jc jd je me jg jh ji mf jk jl jm jn hb bi translated">Github代码:</p><p id="e483" class="iq ir lc is b it iu iv iw ix iy iz ja md jc jd je me jg jh ji mf jk jl jm jn hb bi translated"><a class="ae jo" href="https://github.com/far11ven/Cypress-TestFramework/tree/develop/Part%2008" rel="noopener ugc nofollow" target="_blank">https://github . com/far 11 ven/Cypress-test framework/tree/develop/Part 08</a></p></blockquote><p id="3f3f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lc">最初发布于</em><a class="ae jo" href="https://kushalbhalaik.xyz/blog/" rel="noopener ugc nofollow" target="_blank">https://kushalbhalaik . XYZ</a></p></div></div>    
</body>
</html>