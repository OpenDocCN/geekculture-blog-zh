<html>
<head>
<title>System Design Basics: WebSockets</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">系统设计基础:WebSockets</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/system-design-basics-websockets-80aa2b5d5e52?source=collection_archive---------5-----------------------#2021-11-20">https://medium.com/geekculture/system-design-basics-websockets-80aa2b5d5e52?source=collection_archive---------5-----------------------#2021-11-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="e831" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">什么是WebSockets？它们与传统网络协议有何不同？</h2></div><p id="dce6" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">概述</strong></p><p id="0c12" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">WebSocket协议为互联网上的通信创造了新的可能性，并为真正的实时网络打开了大门。</p><p id="0f89" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">WebSockets在2008年首次被描述，并从2010年左右开始享有广泛的浏览器支持。在WebSockets出现之前,“实时”web已经存在，但它很难实现，通常比较慢，并且是通过黑客攻击现有的web技术来实现的，这些技术不是为实时应用程序设计的。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es jt"><img src="../Images/6743792a6c893b6ee730ff670a0d5b69.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Lo9QHSK91CZNEIrDt5Bx_A.jpeg"/></div></div><figcaption class="kf kg et er es kh ki bd b be z dx">WebSocket</figcaption></figure><p id="c00f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">传统的网络交易是如何运作的？</strong></p><p id="c708" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">传统的网络调用(HTTP、REST等。)以如下方式发生。我们在客户端和服务器之间有一个连接。客户端向服务器发送请求，然后服务器向客户端发回响应。如果客户端想要向服务器发出多个请求，那么将会建立多个连接(串行或并行)。典型的请求-响应服务如下所示:</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div class="er es kj"><img src="../Images/e5d227d500f3256173374ea232eab813.png" data-original-src="https://miro.medium.com/v2/resize:fit:912/format:webp/1*fYRJUAuoKPgwsXvAbz4xxg.png"/></div><figcaption class="kf kg et er es kh ki bd b be z dx">HTTP Request</figcaption></figure><p id="bbef" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为每个请求创建一个单独的连接，该连接在设置响应时结束。</p></div><div class="ab cl kk kl gp km" role="separator"><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp"/></div><div class="hb hc hd he hf"><p id="3e5b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">什么是WebSockets？</strong></p><p id="eff8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">WebSocket是服务器和客户端之间通过单一TCP连接进行持久实时通信的协议。它提供了一个全双工通信信道，其中数据可以双向发送。</p><p id="1257" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">它提供了<strong class="iz hj"> wss </strong>(用于https)和<strong class="iz hj"> ws </strong>(用于http)协议来创建webSockets。wss协议通过加密的TLS连接建立WebSocket，而ws协议使用未加密的连接。此时，网络连接保持打开，可以用来双向发送WebSocket消息。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div class="er es ks"><img src="../Images/4fb9a58e2003b2a3a6264499f5f83746.png" data-original-src="https://miro.medium.com/v2/resize:fit:922/format:webp/1*I6ZuMVZGcDhpSDz0jb3qRw.png"/></div><figcaption class="kf kg et er es kh ki bd b be z dx">WebSocket Communication Protocol</figcaption></figure><p id="f820" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">WebSockets通常用于需要发送实时连续数据的应用中(股票价格跟踪、日志记录、实时流等)。)或需要双向流媒体时(视频通话、聊天应用等)。)</p></div><div class="ab cl kk kl gp km" role="separator"><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp"/></div><div class="hb hc hd he hf"><p id="7c91" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj"> WebSocket通信协议</strong></p><ul class=""><li id="42c2" class="kt ku hi iz b ja jb jd je jg kv jk kw jo kx js ky kz la lb bi translated"><strong class="iz hj"> <em class="kr">连接</em> </strong>:客户端与服务器在特定端口建立连接。我们可以利用单个端口来分离HTTP服务器和WebSocket服务器。一旦创建了HTTP服务器，我们就将WebSocket服务器绑定到HTTP端口。</li><li id="fed0" class="kt ku hi iz b ja lc jd ld jg le jk lf jo lg js ky kz la lb bi translated"><strong class="iz hj"> <em class="kr"> WebSocket握手</em> </strong>:客户端发送GET请求。它类似于普通的GET请求，但是在GET请求中添加了一个名为<strong class="iz hj"> <em class="kr">的升级头</em> </strong>的头。作为响应，服务器返回状态代码101，这是用于切换协议的代码。这将协议从HTTP切换到WebSocket。<br/>为了建立WebSocket连接，客户端发送WebSocket握手请求，服务器返回WebSocket握手响应。客户端请求(就像在HTTP中一样，每一行都以\r\n结尾，并且结尾必须有一个额外的空行):</li></ul><pre class="ju jv jw jx fd lh li lj lk aw ll bi"><span id="8295" class="lm ln hi li b fi lo lp l lq lr">GET <strong class="li hj">/webSocket</strong> <strong class="li hj">HTTP</strong>/1.1<br/>Host: server.example.com<br/>Upgrade: websocket<br/>Connection: Upgrade<br/>Sec-WebSocket-Key: x3JJHMbDL1EzLkh9GBhXDw==<br/>Sec-WebSocket-Protocol: chat, superchat<br/>Sec-WebSocket-Version: 13<br/>Origin: <a class="ae ls" href="http://example.com" rel="noopener ugc nofollow" target="_blank">http://example.com</a></span></pre><p id="afe5" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">服务器返回以下响应:</p><pre class="ju jv jw jx fd lh li lj lk aw ll bi"><span id="e3f9" class="lm ln hi li b fi lo lp l lq lr"><strong class="li hj">HTTP</strong>/1.1 101 <strong class="li hj">Switching Protocols</strong><br/>Upgrade: websocket<br/>Connection: Upgrade<br/>Sec-WebSocket-Accept: HSmrc0sMlYUkAGmm5OPpG2HaGWk=<br/>Sec-WebSocket-Protocol: chat</span></pre><figure class="ju jv jw jx fd jy er es paragraph-image"><div class="er es lt"><img src="../Images/5f3365436e25888025153c37689858ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:882/format:webp/1*Crp_johg0OiK5EzK7o-WTw.png"/></div><figcaption class="kf kg et er es kh ki bd b be z dx">WebSocket Handshake</figcaption></figure><ul class=""><li id="6b7b" class="kt ku hi iz b ja jb jd je jg kv jk kw jo kx js ky kz la lb bi translated"><strong class="iz hj"> <em class="kr">双向消息传递</em> </strong>:消息可以以任何顺序从服务器和客户端连续发送。</li><li id="b168" class="kt ku hi iz b ja lc jd ld jg le jk lf jo lg js ky kz la lb bi translated"><strong class="iz hj"> <em class="kr">关闭连接</em> </strong>:借助<strong class="iz hj"> onclose事件</strong>可以关闭连接。在onclose事件的帮助下标记通信结束后，服务器和客户端之间不能再传输任何消息。</li></ul></div><div class="ab cl kk kl gp km" role="separator"><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp"/></div><div class="hb hc hd he hf"><p id="ca02" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">利弊</strong></p><p id="9224" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用WebSockets的优点是:</p><ul class=""><li id="2dd7" class="kt ku hi iz b ja jb jd je jg kv jk kw jo kx js ky kz la lb bi translated"><strong class="iz hj"> <em class="kr">全双工</em></strong>:web sockets最大的优点是握手后保持连接。不需要轮询，因此服务器和客户端可以以最小的开销发送信息。</li><li id="1e11" class="kt ku hi iz b ja lc jd ld jg le jk lf jo lg js ky kz la lb bi translated"><strong class="iz hj"> <em class="kr">兼容HTTP</em></strong>:升级头使WebSockets兼容HTTP。这有助于设置代理&amp;,帮助基础设施理解WebSocket的存在。</li><li id="0b9e" class="kt ku hi iz b ja lc jd ld jg le jk lf jo lg js ky kz la lb bi translated"><strong class="iz hj"> <em class="kr">防火墙友好</em> </strong>:因为它使用与HTTP/HTTPS相同的端口，所以它是防火墙友好的，因为通信是通过单个端口维持的。</li></ul><p id="429c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然而，WebSockets带来了一些复杂性:</p><ul class=""><li id="8337" class="kt ku hi iz b ja jb jd je jg kv jk kw jo kx js ky kz la lb bi translated"><strong class="iz hj"> <em class="kr">代理</em> </strong> : WebSocket比较复杂。设置代理，尤其是第7层代理，变得非常复杂。这是因为代理破坏了TCP，因此需要另一个TCP连接来维持连接。</li><li id="0f88" class="kt ku hi iz b ja lc jd ld jg le jk lf jo lg js ky kz la lb bi translated"><strong class="iz hj"> <em class="kr">负载均衡</em> </strong>:由于WebSockets没有超时，所以不应该强行终止。如果服务器在缩减过程中关闭，连接将终止，信息不会丢失。数据库需要维护这里的状态，以便在服务器被终止的情况下可以重新建立连接。</li><li id="4da5" class="kt ku hi iz b ja lc jd ld jg le jk lf jo lg js ky kz la lb bi translated"><strong class="iz hj"> <em class="kr">可扩展性</em> </strong> : WebSockets是有状态的。这使得扩展变得非常复杂。在保持状态的同时水平扩展应用程序变得非常困难。</li></ul></div><div class="ab cl kk kl gp km" role="separator"><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp"/></div><div class="hb hc hd he hf"><p id="35d1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">亚马逊web socket API</strong></p><p id="f869" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">API Gateway中的WebSocket API是与后端HTTP端点、Lambda函数或其他AWS服务集成的WebSocket路由的集合。您可以使用API Gateway特性来帮助您处理API生命周期的所有方面，从创建到监控您的生产API。</p><p id="0d4e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">API Gateway WebSocket APIs为您提供了以下方式来将数据从后端服务发送到连接的客户端:</p><ul class=""><li id="79f2" class="kt ku hi iz b ja jb jd je jg kv jk kw jo kx js ky kz la lb bi translated">集成可以发送一个响应，该响应由您定义的路由响应返回给客户端。</li><li id="4c09" class="kt ku hi iz b ja lc jd ld jg le jk lf jo lg js ky kz la lb bi translated">您可以使用<code class="du lu lv lw li b">@connections</code> API来发送POST请求。</li></ul><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es lx"><img src="../Images/58db7651d8291e54c0845acf8386e3c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sdgqMhY46-cCcGEe3HS3Fw.png"/></div></div><figcaption class="kf kg et er es kh ki bd b be z dx">AWS WebSocket API based Chat Application</figcaption></figure></div><div class="ab cl kk kl gp km" role="separator"><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp"/></div><div class="hb hc hd he hf"><p id="3f8c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">结论</strong></p><p id="86a4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">WebSockets是在应用程序中实现实时功能的最有趣和最方便的方式之一。它为我们利用全双工通信提供了很大的灵活性。</p><p id="8196" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然而，它也有自己的一套复杂之处，应该只在优势大于劣势时使用。除非双向通信是绝对必要的，否则HTTP更可靠。</p></div><div class="ab cl kk kl gp km" role="separator"><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp"/></div><div class="hb hc hd he hf"><p id="de2b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="kr">祝贺你坚持到了最后！在</em> <a class="ae ls" href="https://twitter.com/bot_pragmatic" rel="noopener ugc nofollow" target="_blank"> <em class="kr"> Twitter </em> </a> <em class="kr">，</em><a class="ae ls" href="https://github.com/abinator-1308/abinator-1308" rel="noopener ugc nofollow" target="_blank"><em class="kr">GitHub</em></a><em class="kr">，</em><a class="ae ls" rel="noopener" href="/@abhinav.as1308"><em class="kr">Medium</em></a><em class="kr">，</em><a class="ae ls" href="https://www.linkedin.com/in/abinator-1308/" rel="noopener ugc nofollow" target="_blank"><em class="kr">LinkedIn</em></a><em class="kr">，或者</em><a class="ae ls" href="https://www.instagram.com/abinator_1308/" rel="noopener ugc nofollow" target="_blank"><em class="kr">insta gram</em></a><em class="kr">。</em></p><p id="67ee" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">感谢阅读！</p></div><div class="ab cl kk kl gp km" role="separator"><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp"/></div><div class="hb hc hd he hf"><h1 id="562f" class="ly ln hi bd lz ma mb mc md me mf mg mh io mi ip mj ir mk is ml iu mm iv mn mo bi translated">参考</h1><ul class=""><li id="f047" class="kt ku hi iz b ja mp jd mq jg mr jk ms jo mt js ky kz la lb bi translated"><a class="mu mv ge" href="https://medium.com/u/85b52c85aeb7?source=post_page-----80aa2b5d5e52--------------------------------" rel="noopener" target="_blank">技术入门</a>:<a class="ae ls" href="https://www.youtube.com/watch?v=i5OVcTdt_OU" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=i5OVcTdt_OU</a></li><li id="b38c" class="kt ku hi iz b ja lc jd ld jg le jk lf jo lg js ky kz la lb bi translated"><a class="mu mv ge" href="https://medium.com/u/e4cbe924ccb?source=post_page-----80aa2b5d5e52--------------------------------" rel="noopener" target="_blank">侯赛因·纳赛尔</a>:<a class="ae ls" href="https://www.youtube.com/watch?v=2Nt-ZrNP22A" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=2Nt-ZrNP22A</a></li><li id="06e3" class="kt ku hi iz b ja lc jd ld jg le jk lf jo lg js ky kz la lb bi translated"><a class="ae ls" href="https://blog.logrocket.com/websockets-tutorial-how-to-go-real-time-with-node-and-react-8e4693fbf843/" rel="noopener ugc nofollow" target="_blank">https://blog . log rocket . com/web sockets-tutorial-how-to-go-real-time-with-node-and-react-8e 4693 fbf 843/</a></li><li id="c369" class="kt ku hi iz b ja lc jd ld jg le jk lf jo lg js ky kz la lb bi translated"><a class="ae ls" href="https://en.wikipedia.org/wiki/WebSocket" rel="noopener ugc nofollow" target="_blank">https://en.wikipedia.org/wiki/WebSocket</a></li><li id="806b" class="kt ku hi iz b ja lc jd ld jg le jk lf jo lg js ky kz la lb bi translated"><a class="ae ls" href="https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-websocket-api.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/API gateway/latest/developer guide/API gateway-web socket-API . html</a></li></ul></div></div>    
</body>
</html>