<html>
<head>
<title>Protecting WordPress custom forms from CSRF attack</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">保护WordPress自定义表单免受CSRF攻击</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/protecting-wordpress-custom-forms-from-csrf-attack-a5528b91d0df?source=collection_archive---------5-----------------------#2021-10-18">https://medium.com/geekculture/protecting-wordpress-custom-forms-from-csrf-attack-a5528b91d0df?source=collection_archive---------5-----------------------#2021-10-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/3acae56ddaa510f3847c4542ab8b5bdc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*061XGE7ZfzWH555HquTp1Q.jpeg"/></div></div></figure><p id="e98f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你可能听说过WordPress是迄今为止被黑客攻击最多的CMS平台。尽管如此，世界上许多开发者或博客仍然在使用WordPress建立网站。这就是为什么我们应该尽可能在WordPress网站上应用安全措施。</p><p id="643d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">CSRF攻击已经存在了相当长的时间。如果您的站点没有受到保护，攻击者很容易劫持您的会话并在未经您同意的情况下对您的站点执行状态更改。我建议阅读<a class="ae jo" href="https://owasp.org/www-community/attacks/csrf" rel="noopener ugc nofollow" target="_blank">在OWASP </a>上的这篇文章，对CSRF袭击事件有一个全面的了解。</p><h1 id="c909" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">1.策划针对WordPress的CSRF攻击</h1><p id="3973" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">有时当表单插件不能满足你的定制需求时，你将不得不创建你自己的定制表单，例如通过插入一个定制的短代码。这个表单可能是一个登录表单、一个联系表单，甚至是更复杂的表单，允许用户在您的站点上输入帐户详细信息或进行订购。在下面的示例中，我将创建一个没有任何CSRF保护的简单的更改电子邮件表单，攻击者很容易利用该表单在第三方恶意站点上触发POST请求，将您的电子邮件更改为攻击者的电子邮件。</p><p id="6acf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">假设我们将<code class="du ks kt ku kv b">test-form</code>实现为一个短代码，显示在您站点的某个地方，如下所示:</p><pre class="kw kx ky kz fd la kv lb lc aw ld bi"><span id="80ab" class="le jq hi kv b fi lf lg l lh li">function test_form() {<br/>    ob_start();<br/>    ?&gt;<br/>        &lt;h2&gt;Change Email Form&lt;/h2&gt;<br/>        &lt;form method="POST" id="test-form"&gt;<br/>            &lt;div class="input-group"&gt;<br/>                &lt;label for="email" class="form-label"&gt;Your new email &lt;span style="color: red"&gt;*&lt;/span&gt;&lt;/label&gt;<br/>                &lt;input type="email" name="new_email" id="email"&gt;<br/>            &lt;/div&gt;<br/>            &lt;button type="submit"&gt;Submit&lt;/button&gt;<br/>        &lt;/form&gt;<br/>    &lt;?php<br/>    return ob_get_clean();<br/>}</span><span id="9978" class="le jq hi kv b fi lj lg l lh li">function test_form_shortcode() {<br/>    add_shortcode( 'test-form', __NAMESPACE__ . '\\test_form' );<br/>}<br/>add_action('init', __NAMESPACE__ . '\\test_form_shortcode');</span></pre><p id="f181" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在此之下，您还添加了代码来处理所述<code class="du ks kt ku kv b">test-form</code>的提交:</p><pre class="kw kx ky kz fd la kv lb lc aw ld bi"><span id="8a5b" class="le jq hi kv b fi lf lg l lh li">function process_test_form() {<br/>    if (isset($_POST['new_email']) &amp;&amp; is_user_logged_in()) {<br/>        // execute code to change user email to new email<br/>        ...</span><span id="ee60" class="le jq hi kv b fi lj lg l lh li">        wp_redirect( get_home_url() . '/change-email-success/' );<br/>        exit;<br/>    }<br/>}<br/>add_action( 'wp_loaded', __NAMESPACE__ . '\\process_test_form' );</span></pre><p id="6c62" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">假设您站点的用户Tom已经登录到您的站点。他偶然发现一个被利用的页面，该页面看起来绝对正常，但实际上隐藏着一个指向攻击者恶意页面的iframe，该页面在页面加载时向您的站点提交POST请求:</p><pre class="kw kx ky kz fd la kv lb lc aw ld bi"><span id="4735" class="le jq hi kv b fi lf lg l lh li">&lt;body onload='document.CSRF.submit()'&gt;<br/>    ...<br/>    &lt;form action="<a class="ae jo" href="http://tt-tutort.local/contact-us/" rel="noopener ugc nofollow" target="_blank">http://yoursite.com/change-email/</a>" method="POST" name="CSRF"&gt;<br/>        &lt;input type="hidden" name="new_email" id="email" value="<a class="ae jo" href="mailto:hacker@gmail.com" rel="noopener ugc nofollow" target="_blank">hacker@example.com</a>"&gt;<br/>    &lt;/form&gt;<br/>    ....<br/>&lt;/body&gt;</span></pre><p id="b857" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Tom不会注意到任何事情，因为iframe是隐藏的，而且在那个时候，Tom在你的WordPress站点上的电子邮件地址已经被改变了。现在，攻击者可能能够在您的网站上沿着忘记密码的路线，劫持Tom的帐户。稍后，Tom会发现他再也无法登录自己的帐户。</p><h1 id="dc45" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">2.修补CSRF漏洞</h1><p id="3fc9" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">幸运的是，这实际上很容易解决。一个简单的方法是在表单中包含一个WordPress随机数，然后在每次处理POST请求时验证这个随机数。</p><p id="6c5e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在表单顶部添加这一行:</p><pre class="kw kx ky kz fd la kv lb lc aw ld bi"><span id="5358" class="le jq hi kv b fi lf lg l lh li">&lt;form id="test-form" method="POST"&gt;<br/>    &lt;input name="form_nonce" type="hidden" value="&lt;?=wp_create_nonce('test-nonce')?&gt;" /&gt;<br/>    ....</span></pre><p id="accd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后，当您处理表单时，验证nonce以及您的原始检查:</p><pre class="kw kx ky kz fd la kv lb lc aw ld bi"><span id="e44b" class="le jq hi kv b fi lf lg l lh li">if (isset($_POST['form_nonce']) &amp;&amp; wp_verify_nonce($_POST['form_nonce'],'test-nonce') &amp;&amp; isset($_POST['new_email']) &amp;&amp; is_user_logged_in()) {</span></pre><p id="960f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在那之后，你已经安全了，不会受到CSRF的大部分攻击。从现在开始，要完成POST请求，攻击者必须知道nonce的正确值，这比完全没有保护要安全得多。然而，这并不能防止重放攻击，因为WordPress生成的随机数不会只使用一次。它们也不是只使用一次，而是有一个有限的“寿命”，在此之后它们就会过期。在此期间，将为给定上下文中的给定用户生成相同的随机数。”—<a class="ae jo" href="https://codex.wordpress.org/WordPress_Nonces" rel="noopener ugc nofollow" target="_blank">https://codex.wordpress.org/WordPress_Nonces</a></p><p id="f1ec" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你想让你的表单有一个额外的安全层，我建议在你的表单中添加Google reCaptcha。它不仅保护您的表单免受CSRF攻击，还保护您免受垃圾邮件机器人的攻击。</p></div></div>    
</body>
</html>