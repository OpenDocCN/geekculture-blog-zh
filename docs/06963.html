<html>
<head>
<title>How to run terraform script using GitLab CI/CD?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用GitLab CI/CD运行terraform脚本？</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/how-to-run-terraform-script-using-gitlab-ci-cd-b6f448ab0232?source=collection_archive---------0-----------------------#2021-09-03">https://medium.com/geekculture/how-to-run-terraform-script-using-gitlab-ci-cd-b6f448ab0232?source=collection_archive---------0-----------------------#2021-09-03</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="e389" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">什么是GitLab CI/CD？</h1><p id="7ed5" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><strong class="jf hj"> GitLab CI/CD </strong>是<strong class="jf hj">git lab</strong>的一部分，用于所有的<strong class="jf hj">连续方法(连续集成、交付和部署)</strong>。使用<strong class="jf hj"> GitLab CI/CD </strong>，您可以<strong class="jf hj">测试</strong>，<strong class="jf hj">构建</strong>，以及<strong class="jf hj">发布</strong>您的代码，无需第三方应用或集成。</p><p id="c4b6" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">点击 阅读更多关于<strong class="jf hj"> GitLab CI/CD </strong> <a class="ae kg" href="https://docs.gitlab.com/ee/ci/" rel="noopener ugc nofollow" target="_blank"> <strong class="jf hj">。</strong></a></p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/36bc925ddae227ba98db348014bdd2cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KpZOSdvsgRNN3zA4pXtn7Q.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx">GitLab CI/CD</figcaption></figure><h1 id="5dd3" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">什么是Terraform？</h1><p id="6e5e" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><strong class="jf hj"> Terraform </strong>是一个开源<strong class="jf hj">基础设施，作为一个代码(IAC) </strong>工具，允许创建、管理&amp;部署生产就绪环境。Terraform将云API编译成声明性的配置文件。Terraform可以管理现有的服务提供商和定制的内部解决方案。</p><p id="5ee5" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">从<a class="ae kg" href="https://www.terraform.io/intro/index.html" rel="noopener ugc nofollow" target="_blank"> <strong class="jf hj">这里</strong> </a> <strong class="jf hj">阅读更多关于<strong class="jf hj"> Terraform </strong>的内容。</strong></p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kx"><img src="../Images/cec0951ca498ac104d1ac34c3665a29b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*DE-OEHhfqhZc9RKJ.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx">Terraform</figcaption></figure><p id="d5a2" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">在本教程中，我将<strong class="jf hj"> Terraform </strong>与<strong class="jf hj"> GitLab CI/CD </strong>集成在一起，并在<strong class="jf hj"> AWS </strong>上创建了各种资源。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es ky"><img src="../Images/1884cfc161255261d282973f693c73ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/0*Chnns3B62101pTSI.png"/></div><figcaption class="kt ku et er es kv kw bd b be z dx">Terraform + GitLab CI/CD</figcaption></figure><h1 id="69f0" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">先决条件:</h1><ul class=""><li id="ef0c" class="kz la hi jf b jg jh jk jl jo lb js lc jw ld ka le lf lg lh bi translated"><strong class="jf hj"> AWS &amp; GitLab账户</strong></li><li id="f7e6" class="kz la hi jf b jg li jk lj jo lk js ll jw lm ka le lf lg lh bi translated"><a class="ae kg" href="https://docs.aws.amazon.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="jf hj"> AWS </strong> </a>，<a class="ae kg" href="https://www.terraform.io/intro/index.html" rel="noopener ugc nofollow" target="_blank"><strong class="jf hj">terra form</strong></a><strong class="jf hj">&amp;</strong><a class="ae kg" href="https://docs.gitlab.com/ee/ci/" rel="noopener ugc nofollow" target="_blank"><strong class="jf hj">git lab CI/CD</strong></a></li><li id="41d4" class="kz la hi jf b jg li jk lj jo lk js ll jw lm ka le lf lg lh bi translated">在<strong class="jf hj"> AWS </strong>中创建的<strong class="jf hj">访问密钥</strong> &amp; <strong class="jf hj">秘密密钥</strong></li></ul><p id="d51f" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">让我们从项目的配置开始</p><p id="c3de" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">步骤1:- </strong>创建一个<strong class="jf hj">存储库</strong></p><ul class=""><li id="791d" class="kz la hi jf b jg kb jk kc jo ln js lo jw lp ka le lf lg lh bi translated">在你的GitLab帐户中创建一个存储库，并给它起一个你自己选择的名字</li></ul><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es lq"><img src="../Images/a41359061d45842791aac6302017d0a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZIs8EO4gPod400IrjzG_uw.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx">GitLab Project</figcaption></figure><p id="4402" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">步骤2:- </strong>为资源创建创建一个<strong class="jf hj"> terraform </strong>文件</p><ul class=""><li id="9f04" class="kz la hi jf b jg kb jk kc jo ln js lo jw lp ka le lf lg lh bi translated">在根目录下创建一个<code class="du lr ls lt lu b">.tf</code>文件，并在其中添加下面的代码。</li></ul><pre class="ki kj kk kl fd lv lu lw lx aw ly bi"><span id="676e" class="lz ig hi lu b fi ma mb l mc md"># Configure and downloading plugins for aws<br/>provider "aws" {<br/>  region     = "${var.aws_region}"<br/>}<br/><br/># Creating VPC<br/>resource "aws_vpc" "demovpc" {<br/>  cidr_block       = "${var.vpc_cidr}"<br/>  instance_tenancy = "default"<br/><br/>  tags = {<br/>    Name = "Demo VPC"<br/>  }<br/>}<br/><br/># Creating Internet Gateway <br/>resource "aws_internet_gateway" "demogateway" {<br/>  vpc_id = "${aws_vpc.demovpc.id}"<br/>}<br/><br/># Grant the internet access to VPC by updating its main route table<br/>resource "aws_route" "internet_access" {<br/>  route_table_id         = "${aws_vpc.demovpc.main_route_table_id}"<br/>  destination_cidr_block = "0.0.0.0/0"<br/>  gateway_id             = "${aws_internet_gateway.demogateway.id}"<br/>}<br/><br/># Creating 1st subnet <br/>resource "aws_subnet" "demosubnet" {<br/>  vpc_id                  = "${aws_vpc.demovpc.id}"<br/>  cidr_block             = "${var.subnet_cidr}"<br/>  map_public_ip_on_launch = true<br/>  availability_zone = "us-east-1a"<br/><br/>  tags = {<br/>    Name = "Demo subnet"<br/>  }<br/>}<br/><br/># Creating 2nd subnet <br/>resource "aws_subnet" "demosubnet1" {<br/>  vpc_id                  = "${aws_vpc.demovpc.id}"<br/>  cidr_block             = "${var.subnet1_cidr}"<br/>  map_public_ip_on_launch = true<br/>  availability_zone = "us-east-1b"<br/><br/>  tags = {<br/>    Name = "Demo subnet 1"<br/>  }<br/>}<br/><br/># Creating Security Group<br/>resource "aws_security_group" "demosg" {<br/>  name        = "Demo Security Group"<br/>  description = "Demo Module"<br/>  vpc_id      = "${aws_vpc.demovpc.id}"<br/><br/>  # Inbound Rules<br/>  # HTTP access from anywhere<br/>  ingress {<br/>    from_port   = 80<br/>    to_port     = 80<br/>    protocol    = "tcp"<br/>    cidr_blocks = ["0.0.0.0/0"]<br/>  }<br/><br/>  # HTTPS access from anywhere<br/>  ingress {<br/>    from_port   = 443<br/>    to_port     = 443<br/>    protocol    = "tcp"<br/>    cidr_blocks = ["0.0.0.0/0"]<br/>  }<br/><br/>  # SSH access from anywhere<br/>  ingress {<br/>    from_port   = 22<br/>    to_port     = 22<br/>    protocol    = "tcp"<br/>    cidr_blocks = ["0.0.0.0/0"]<br/>  }<br/><br/>  # Splunk default port<br/>  ingress {<br/>    from_port   = 8000<br/>    to_port     = 8000<br/>    protocol    = "tcp"<br/>    cidr_blocks = ["0.0.0.0/0"]<br/>  }<br/>  <br/>  # Replication Port<br/>  ingress {<br/>    from_port   = 8089<br/>    to_port     = 8089<br/>    protocol    = "tcp"<br/>    cidr_blocks = ["0.0.0.0/0"]<br/>  }<br/><br/>  # Management Port<br/>  ingress {<br/>    from_port   = 4598<br/>    to_port     = 4598<br/>    protocol    = "tcp"<br/>    cidr_blocks = ["0.0.0.0/0"]<br/>  }<br/><br/>  # Ingestion Port<br/>  ingress {<br/>    from_port   = 9997<br/>    to_port     = 9997<br/>    protocol    = "tcp"<br/>    cidr_blocks = ["0.0.0.0/0"]<br/>  }<br/><br/>  # Outbound Rules<br/>  # Internet access to anywhere<br/>  egress {<br/>    from_port   = 0<br/>    to_port     = 0<br/>    protocol    = "-1"<br/>    cidr_blocks = ["0.0.0.0/0"]<br/>  }<br/>}<br/><br/># Creating key pair<br/>resource "aws_key_pair" "demokey" {<br/>  key_name   = "${var.key_name}"<br/>  public_key = "${file(var.public_key)}"<br/>}<br/>  <br/># Creating EC2 Instance<br/>resource "aws_instance" "demoinstance" {<br/><br/>  # AMI based on region <br/>  ami = "${lookup(var.ami, var.aws_region)}"<br/><br/>  # Launching instance into subnet <br/>  subnet_id = "${aws_subnet.demosubnet.id}"<br/><br/>  # Instance type <br/>  instance_type = "${var.instancetype}"<br/>  <br/>  # Count of instance<br/>  count= "${var.master_count}"<br/>  <br/>  # SSH key that we have generated above for connection<br/>  key_name = "${aws_key_pair.demokey.id}"<br/><br/>  # Attaching security group to our instance<br/>  vpc_security_group_ids = ["${aws_security_group.demosg.id}"]<br/><br/>  # Attaching Tag to Instance <br/>  tags = {<br/>    Name = "Search-Head-${count.index + 1}"<br/>  }<br/>  <br/>  # Root Block Storage<br/>  root_block_device {<br/>    volume_size = "40"<br/>    volume_type = "standard"<br/>  }<br/>  <br/>  #EBS Block Storage<br/>  ebs_block_device {<br/>    device_name = "/dev/sdb"<br/>    volume_size = "80"<br/>    volume_type = "standard"<br/>    delete_on_termination = false<br/>  }<br/>  <br/>  # SSH into instance <br/>  connection {<br/>    <br/>    # Host name<br/>    host = self.public_ip<br/>    # The default username for our AMI<br/>    user = "ec2-user"<br/>    # Private key for connection<br/>    private_key = "${file(var.private_key)}"<br/>    # Type of connection<br/>    type = "ssh"<br/>  }<br/>  <br/>  # Installing splunk on newly created instance<br/>  provisioner "remote-exec" {<br/>    inline = [<br/>      "sudo yum update -y",<br/>      "sudo amazon-linux-extras install docker -y",<br/>      "sudo service docker start",<br/>      "sudo usermod -a -G docker ec2-user",<br/>      "sudo chkconfig docker on",<br/>      "sudo yum install -y git",<br/>      "sudo chmod 666 /var/run/docker.sock",<br/>      "docker pull dhruvin30/dhsoniweb:v1",<br/>      "docker run -d -p 80:80 dhruvin30/dhsoniweb:latest"   <br/>  ]<br/> }<br/>}</span></pre><p id="dcc6" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">步骤3:- </strong>为变量创建<strong class="jf hj"> terraform </strong>文件</p><ul class=""><li id="790e" class="kz la hi jf b jg kb jk kc jo ln js lo jw lp ka le lf lg lh bi translated">在资源创建文件中，我使用了多个变量，因此我们需要创建一个包含变量定义的变量文件</li><li id="5eda" class="kz la hi jf b jg li jk lj jo lk js ll jw lm ka le lf lg lh bi translated">在根目录下创建一个<code class="du lr ls lt lu b">vars.tf</code>文件，并将下面的代码添加到其中</li><li id="83a5" class="kz la hi jf b jg li jk lj jo lk js ll jw lm ka le lf lg lh bi translated">下面的代码将在AWS上创建各种资源。如果你不能理解代码中的任何内容，你可以从<a class="ae kg" href="https://devopsquare.com/how-to-create-various-aws-resources-using-terraform-dd9ad2bc374b" rel="noopener ugc nofollow" target="_blank"> <strong class="jf hj">这里</strong> </a>更好地理解</li></ul><pre class="ki kj kk kl fd lv lu lw lx aw ly bi"><span id="d66b" class="lz ig hi lu b fi ma mb l mc md"># Defining Public Key<br/>variable "public_key" {<br/>  default = "tests.pub"<br/>}<br/><br/># Defining Private Key<br/>variable "private_key" {<br/>  default = "tests.pem"<br/>}<br/><br/># Definign Key Name for connection<br/>variable "key_name" {<br/>  default = "tests"<br/>  description = "Desired name of AWS key pair"<br/>}<br/><br/># Defining Region<br/>variable "aws_region" {<br/>  default = "us-east-1"<br/>}<br/><br/># Defining CIDR Block for VPC<br/>variable "vpc_cidr" {<br/>  default = "10.0.0.0/16"<br/>}<br/><br/># Defining CIDR Block for Subnet<br/>variable "subnet_cidr" {<br/>  default = "10.0.1.0/24"<br/>}<br/><br/># Defining CIDR Block for 2d Subnet<br/>variable "subnet1_cidr" {<br/>  default = "10.0.2.0/24"<br/>}<br/><br/># Defining AMI<br/>variable "ami" {<br/>  default = {<br/>    eu-west-1 = "ami-0ea3405d2d2522162"<br/>    us-east-1 = "ami-09d95fab7fff3776c"<br/>  }<br/>}<br/><br/># Defining Instace Type<br/>variable "instancetype" {<br/>  default = "t2.medium"<br/>}<br/><br/># Defining Master count <br/>variable "master_count" {<br/>  default = 1<br/>}</span></pre><p id="7852" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">步骤4:- </strong>存储<strong class="jf hj"> AWS </strong> <strong class="jf hj">密钥</strong></p><ul class=""><li id="0f38" class="kz la hi jf b jg kb jk kc jo ln js lo jw lp ka le lf lg lh bi translated">为了在AWS帐户中创建资源，我们必须需要拥有<strong class="jf hj"> AWS访问密钥</strong> &amp; <strong class="jf hj"> AWS秘密密钥</strong></li><li id="ed28" class="kz la hi jf b jg li jk lj jo lk js ll jw lm ka le lf lg lh bi translated">现在，我们需要将<strong class="jf hj"> AWS访问密钥</strong> &amp; <strong class="jf hj"> AWS秘密密钥</strong>存储在存储库的secrets部分</li><li id="97e3" class="kz la hi jf b jg li jk lj jo lk js ll jw lm ka le lf lg lh bi translated">转到变量部分下的<strong class="jf hj">设置</strong>-&gt;-<strong class="jf hj">CI/CD</strong>-&gt;创建以下变量并存储您的<strong class="jf hj"> AWS访问密钥</strong> &amp; <strong class="jf hj"> AWS秘密密钥</strong></li></ul><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es me"><img src="../Images/7229ffde597c765319d9d37ed67cdda0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XY_YVWeyztGN2gKl6L64uQ.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx">Environment Variable</figcaption></figure><p id="e759" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">第四步:- </strong>创建一个<strong class="jf hj">工作流</strong>文件</p><ul class=""><li id="1438" class="kz la hi jf b jg kb jk kc jo ln js lo jw lp ka le lf lg lh bi translated">现在为了自动创建terraform资源，我们需要创建一个工作流文件</li><li id="4fee" class="kz la hi jf b jg li jk lj jo lk js ll jw lm ka le lf lg lh bi translated">创建<code class="du lr ls lt lu b">.gitlab-ci.yml</code>文件，并将下面的代码添加到其中</li><li id="d4f4" class="kz la hi jf b jg li jk lj jo lk js ll jw lm ka le lf lg lh bi translated">以下作业将在主分支上发生的每个<strong class="jf hj">推</strong>和<strong class="jf hj">拉请求</strong>上运行。在构建部分，我已经在脚本部分指定了映像名称和命令。</li></ul><pre class="ki kj kk kl fd lv lu lw lx aw ly bi"><span id="f892" class="lz ig hi lu b fi ma mb l mc md">stages:<br/>  - validate<br/>  - plan<br/>  - apply</span><span id="543b" class="lz ig hi lu b fi mf mb l mc md">image:<br/>  name: hashicorp/terraform:light<br/>  entrypoint:<br/>    - '/usr/bin/env'<br/>    - 'PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'</span><span id="b0bb" class="lz ig hi lu b fi mf mb l mc md">before_script:<br/>  - export AWS_ACCESS_KEY=${AWS_ACCESS_KEY_ID}<br/>  - export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}<br/>  - rm -rf .terraform<br/>  - terraform --version<br/>  - terraform init</span><span id="a713" class="lz ig hi lu b fi mf mb l mc md">validate:<br/>  stage: validate<br/>  script:<br/>    - terraform validate</span><span id="2c2d" class="lz ig hi lu b fi mf mb l mc md">plan:<br/>  stage: plan<br/>  script:<br/>    - terraform plan -out "planfile"<br/>  dependencies:<br/>    - validate<br/>  artifacts:<br/>    paths:<br/>      - planfile</span><span id="8ae3" class="lz ig hi lu b fi mf mb l mc md">apply:<br/>  stage: apply<br/>  script:<br/>    - terraform apply -input=false "planfile"<br/>  dependencies:<br/>    - plan<br/>  when: manual</span></pre><p id="dcb6" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">我们来理解一下上面的代码。</p><ul class=""><li id="709f" class="kz la hi jf b jg kb jk kc jo ln js lo jw lp ka le lf lg lh bi translated">下面的代码用于声明阶段的名称</li></ul><pre class="ki kj kk kl fd lv lu lw lx aw ly bi"><span id="95c9" class="lz ig hi lu b fi ma mb l mc md">stages:<br/>  - validate<br/>  - plan<br/>  - apply</span></pre><ul class=""><li id="87f2" class="kz la hi jf b jg kb jk kc jo ln js lo jw lp ka le lf lg lh bi translated">我们使用<code class="du lr ls lt lu b">terraform</code>图像来运行地形脚本，并设置地形路径的<code class="du lr ls lt lu b">entrypoint</code></li></ul><pre class="ki kj kk kl fd lv lu lw lx aw ly bi"><span id="da9d" class="lz ig hi lu b fi ma mb l mc md">image:<br/>  name: hashicorp/terraform:light<br/>  entrypoint:<br/>    - '/usr/bin/env'<br/>    - 'PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'</span></pre><ul class=""><li id="95f1" class="kz la hi jf b jg kb jk kc jo ln js lo jw lp ka le lf lg lh bi translated">在<code class="du lr ls lt lu b">before_script</code>部分，我们导出AWS访问密钥&amp;秘密密钥，检查terraform的版本，做一些清理工作，并通过运行<code class="du lr ls lt lu b">terraform init</code>初始化工作目录</li></ul><pre class="ki kj kk kl fd lv lu lw lx aw ly bi"><span id="b6bc" class="lz ig hi lu b fi ma mb l mc md">before_script:<br/>  - export AWS_ACCESS_KEY=${AWS_ACCESS_KEY_ID}<br/>  - export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}<br/>  - rm -rf .terraform<br/>  - terraform --version<br/>  - terraform init</span></pre><ul class=""><li id="e37d" class="kz la hi jf b jg kb jk kc jo ln js lo jw lp ka le lf lg lh bi translated">在<code class="du lr ls lt lu b">validate</code>部分，我们正在验证地形脚本</li></ul><pre class="ki kj kk kl fd lv lu lw lx aw ly bi"><span id="8cb6" class="lz ig hi lu b fi ma mb l mc md">validate:<br/>  stage: validate<br/>  script:<br/>    - terraform validate</span></pre><ul class=""><li id="9540" class="kz la hi jf b jg kb jk kc jo ln js lo jw lp ka le lf lg lh bi translated">在<code class="du lr ls lt lu b">plan</code>部分，我们正在生成地形图并存储在工件中，以便我们可以在下一阶段使用它</li></ul><pre class="ki kj kk kl fd lv lu lw lx aw ly bi"><span id="82b6" class="lz ig hi lu b fi ma mb l mc md">plan:<br/>  stage: plan<br/>  script:<br/>    - terraform plan -out "planfile"<br/>  dependencies:<br/>    - validate<br/>  artifacts:<br/>    paths:<br/>      - planfile</span></pre><ul class=""><li id="4e8c" class="kz la hi jf b jg kb jk kc jo ln js lo jw lp ka le lf lg lh bi translated">在<code class="du lr ls lt lu b">apply</code>部分，我们正在运行<code class="du lr ls lt lu b">terraform apply</code>，以便terraform可以在AWS上创建资源</li><li id="846c" class="kz la hi jf b jg li jk lj jo lk js ll jw lm ka le lf lg lh bi translated"><code class="du lr ls lt lu b">dependencies</code>将确保<code class="du lr ls lt lu b">apply</code>阶段仅在<code class="du lr ls lt lu b">plan</code>阶段成功时运行</li><li id="5ec2" class="kz la hi jf b jg li jk lj jo lk js ll jw lm ka le lf lg lh bi translated"><code class="du lr ls lt lu b">when: manual</code>将确保我们需要手动触发这个阶段</li></ul><pre class="ki kj kk kl fd lv lu lw lx aw ly bi"><span id="fa72" class="lz ig hi lu b fi ma mb l mc md">apply:<br/>  stage: apply<br/>  script:<br/>    - terraform apply -input=false "planfile"<br/>  dependencies:<br/>    - plan<br/>  when: manual</span></pre><p id="dd19" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">步骤5:- </strong>检查<strong class="jf hj">输出</strong></p><ul class=""><li id="d6da" class="kz la hi jf b jg kb jk kc jo ln js lo jw lp ka le lf lg lh bi translated">现在，只要你提交你的工作流文件，GitLab就会触发这个动作，资源就会在AWS帐户上创建。</li></ul><blockquote class="mg mh mi"><p id="6b2e" class="jd je mj jf b jg kb ji jj jk kc jm jn mk kd jq jr ml ke ju jv mm kf jy jz ka hb bi translated"><code class="du lr ls lt lu b">validate</code>和<code class="du lr ls lt lu b">plan</code>作业将自动运行，但您需要手动触发<code class="du lr ls lt lu b">apply</code>作业</p></blockquote><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mn"><img src="../Images/1f089b8be0dd69f97303d77342a4d711.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GaB4LfpVVqUvGzZ3Bu07dA.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx">CI/CD Output</figcaption></figure><ul class=""><li id="0fc4" class="kz la hi jf b jg kb jk kc jo ln js lo jw lp ka le lf lg lh bi translated">运行作业后，您将看到所有步骤都运行良好，没有错误。因此，当每一步工作成功时，您将拥有用绿色书写的<code class="du lr ls lt lu b">passed</code>。</li></ul><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mn"><img src="../Images/48696361e08a8c881839040b9a7dbb24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bueDHrHtr-yqzCvSLCBRUw.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx">Jobs</figcaption></figure><ul class=""><li id="eac7" class="kz la hi jf b jg kb jk kc jo ln js lo jw lp ka le lf lg lh bi translated">您还可以通过单击来检查每个步骤的输出</li></ul><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mn"><img src="../Images/068fd009c8bb4f3de6282cef70444a6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O5HUVp1uACsyLUYh_WLgKw.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx">Output of Job</figcaption></figure><p id="ce88" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">步骤6:- </strong>检查<strong class="jf hj"> AWS上的资源</strong></p><ul class=""><li id="1b20" class="kz la hi jf b jg kb jk kc jo ln js lo jw lp ka le lf lg lh bi translated">一旦作业运行完成，您就可以导航到AWS并检查所有资源</li><li id="57e7" class="kz la hi jf b jg li jk lj jo lk js ll jw lm ka le lf lg lh bi translated">Terraform将创建以下资源</li></ul><ol class=""><li id="6ab7" class="kz la hi jf b jg kb jk kc jo ln js lo jw lp ka mo lf lg lh bi translated"><strong class="jf hj"> VPC </strong></li></ol><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mn"><img src="../Images/d5b89e5ff74c839042b68fd462ce5258.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*asedyRLvJWN8gn3NFOFixg.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx">VPC</figcaption></figure><p id="ac07" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj"> 2。子网</strong></p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mn"><img src="../Images/1e46515052a3838436dd7c92ba188b7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3_vivLx_BWB4YNtl1sT9bw.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx">Subnets</figcaption></figure><p id="361e" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj"> 3。互联网网关</strong></p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mn"><img src="../Images/c0c2b9872d60b15721a0f83d9adbaf4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G1DEhoC7mOrldY-6tsGEpg.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx">Internet Gateway</figcaption></figure><p id="4c09" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj"> 4。Rouet表</strong></p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mn"><img src="../Images/51988442848755f4dfcfb7f53d73da26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iU8V-f6YvWgCycE66ZnHJQ.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx">Route Table</figcaption></figure><p id="eb63" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj"> 5。安全组</strong></p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mp"><img src="../Images/fe6c0f89a65b59e09b17b0746eb54428.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Gre25hzHQA2_Ia4riCk3pQ.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx">Security Group</figcaption></figure><p id="99ea" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">6。密钥对</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mn"><img src="../Images/8e9acd2e943b274dabea7fbb4c936de6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-pbYC21DaMvPA8TdLXef2A.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx">Key Pair</figcaption></figure><p id="b739" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">7。EC2实例</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mn"><img src="../Images/223659661787f435c7ffbb61c1f5b151.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bkAbuFTFKfS0HwxEl3TFPw.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx">EC2 Instance</figcaption></figure><p id="9300" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">步骤7:- </strong>验证<strong class="jf hj">输出</strong></p><ul class=""><li id="4324" class="kz la hi jf b jg kb jk kc jo ln js lo jw lp ka le lf lg lh bi translated">在Terraform配置代码中，我们使用远程供应器安装docker，并在其上运行docker映像</li><li id="ab0e" class="kz la hi jf b jg li jk lj jo lk js ll jw lm ka le lf lg lh bi translated">为了检查输出，导航至<strong class="jf hj"> &lt; public-ip:80 &gt; </strong></li><li id="2733" class="kz la hi jf b jg li jk lj jo lk js ll jw lm ka le lf lg lh bi translated">您应该会看到如下所示的输出</li></ul><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mn"><img src="../Images/cc6f1b85058f3d8eca04a90132047640.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XLTsSEeSHMhVrmiOCzjo8w.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx">Output</figcaption></figure><p id="4156" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">现在就这样，你已经学会了如何将Terraform与GitLab CI/CD集成。您现在可以使用它并对其进行相应的修改。</p><p id="0777" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">你可以在我的<a class="ae kg" href="https://gitlab.com/dhruvinsoni30/gitlab-terraform" rel="noopener ugc nofollow" target="_blank"> <strong class="jf hj"> GitLab </strong> </a>账号找到完整的代码。也可以随意查看我的其他库。</p><p id="d169" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">如果您觉得本指南很有帮助，请点击👏按钮，也可以随意发表评论。</p><p id="d3ea" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">关注更多类似的故事😊</p></div></div>    
</body>
</html>