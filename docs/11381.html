<html>
<head>
<title>SQL mock tests with the Goyave framework</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Goyave框架进行SQL模拟测试</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/sql-mock-tests-with-the-goyave-framework-f3d598666b7e?source=collection_archive---------10-----------------------#2022-03-19">https://medium.com/geekculture/sql-mock-tests-with-the-goyave-framework-f3d598666b7e?source=collection_archive---------10-----------------------#2022-03-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/75c3c5b9ac688bf66fcb38be06980f73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ei6vnOcvX73EByRduzTJlQ.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Credits: <a class="ae iu" href="https://www.pexels.com/@cookiecutter?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"><strong class="bd iv">panumas nikhomkhai</strong></a><strong class="bd iv"> </strong>on Pexels</figcaption></figure><p id="9401" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated"><a class="ae iu" href="https://github.com/go-goyave/goyave" rel="noopener ugc nofollow" target="_blank"> <strong class="iy hj"> Goyave </strong> </a>是一个<strong class="iy hj"> Golang REST API框架</strong>，它尽力帮助你高效地开发应用。它的特性允许您关注真正重要的东西:应用程序的业务逻辑。</p><p id="488a" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">我们开门见山:今天我们就来说说<strong class="iy hj">测试</strong>。尽管框架已经提供了很好的测试工具，但是用真实的数据库进行测试并不总是可行的。当你写单元测试的时候，为一个简单而简短的函数建立一个数据库是非常麻烦的。这就是为什么在测试中模仿数据库非常流行的原因。但是你会怎么做呢？</p><p id="3ac9" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">实际上，在使用这个框架时，您并不直接管理DB连接。谢天谢地，它的设计没有牺牲灵活性。在最新发布的v4.1.0中，我们现在可以用一个mock手动替换数据库连接。让我们使用流行的<a class="ae iu" href="https://github.com/DATA-DOG/go-sqlmock" rel="noopener ugc nofollow" target="_blank"> go-sqlmock </a>。</p><p id="4f17" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">我们想要测试的代码非常简单:一个用户模型存储库和一个通过ID获取用户的函数。</p><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="jy jz l"/></div></figure></div><div class="ab cl ka kb gp kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hb hc hd he hf"><p id="8733" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">让我们从创建Goyave测试套件的扩展开始。这个扩展将创建一个模拟数据库，并使它可用于套件中的所有测试。在这个例子中，我们使用PostgreSQL。所以我们需要为这个引擎导入GORM驱动程序，从它创建一个<strong class="iy hj">拨号器</strong>，然后在Goyave中将它设置为活动连接。</p><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="jy jz l"/></div></figure><p id="0f8c" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">得益于<strong class="iy hj">组合，</strong>我们可以轻松地对多个套件使用相同的行为，而没有冗余。让我们创建新的测试套件。</p><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="jy jz l"/></div></figure><p id="1ee9" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">我们已经做好了实施测试的一切准备。那是无痛的！</p></div><div class="ab cl ka kb gp kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hb hc hd he hf"><p id="9902" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">为了让文章简短易懂，我们不会实现复杂完整的测试。我们将满足于测试请求用户访问我们的存储库返回正确的数据。</p><p id="c461" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">使用go-sqlmock进行测试的一般过程非常简单:</p><ul class=""><li id="922f" class="kh ki hi iy b iz ja jd je jh kj jl kk jp kl jt km kn ko kp bi translated">期待一个SQL查询。它可以包含参数。这里，这将是我们的用户ID。</li><li id="f715" class="kh ki hi iy b iz kq jd kr jh ks jl kt jp ku jt km kn ko kp bi translated">创建“假”行，并说我们预期的SQL查询将返回它们。</li><li id="7507" class="kh ki hi iy b iz kq jd kr jh ks jl kt jp ku jt km kn ko kp bi translated">执行我们测试过的代码和断言。</li></ul><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="jy jz l"/></div></figure><p id="f17d" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">让我们运行我们的测试，就像这样，没有任何数据库在后台运行。太好了，成功了！像这样的简单案例的测试将更容易编写，执行起来也更快！</p></div><div class="ab cl ka kb gp kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hb hc hd he hf"><p id="cd0d" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">在我们结束这篇文章之前，让我们来谈谈负面因素，因为没有什么是完美的。</p><ul class=""><li id="94b7" class="kh ki hi iy b iz ja jd je jh kj jl kk jp kl jt km kn ko kp bi translated">GORM可以生成一些复杂的查询。让它与预期的模拟查询完全匹配可能会很棘手。并且在启用调试时复制粘贴您在程序输出中得到的查询不是一个理想的解决方案。</li><li id="ea58" class="kh ki hi iy b iz kq jd kr jh ks jl kt jp ku jt km kn ko kp bi translated">在这个例子中，模型非常简单，只有四列。想象一下处理一个有十列或更多列的模型。在生成记录之前，您必须逐个手动复制列名。如果我们可以使用类似于<a class="ae iu" href="https://goyave.dev/guide/advanced/testing.html#using-factories" rel="noopener ugc nofollow" target="_blank">工厂</a>的东西，那就太好了，但是那样会生成go-sqlmock行。可悲的是，没有什么可以满足这种需求…至少现在是这样。</li></ul></div><div class="ab cl ka kb gp kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hb hc hd he hf"><p id="54eb" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">非常感谢您的阅读！如果你还不知道Goyave，可以在Github 和官方文档网站上看看<a class="ae iu" href="https://github.com/go-goyave/goyave" rel="noopener ugc nofollow" target="_blank">！</a></p></div></div>    
</body>
</html>