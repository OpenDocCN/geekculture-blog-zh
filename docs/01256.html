<html>
<head>
<title>Send a Cropped Image From React to Rails For Attachment and Storage.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将裁剪后的图像从React发送到Rails进行附件和存储。</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/send-a-cropped-image-from-react-to-rails-for-attachment-and-storage-f7d46d84abca?source=collection_archive---------13-----------------------#2021-04-03">https://medium.com/geekculture/send-a-cropped-image-from-react-to-rails-for-attachment-and-storage-f7d46d84abca?source=collection_archive---------13-----------------------#2021-04-03</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/21a7095b302a39c8b030aa258b88bad2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6q5JpUc5VG2K7AZM0yY77A.png"/></div></div></figure><p id="2dd5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">所以，你想保存一个修改过的图像以备后用。假设您希望允许用户上传照片，对其进行裁剪，并将裁剪后的图像保存为他们的头像。在这里，我将介绍一个我发现的解决方案，用于从React to Rails获取更改后的图像信息，并通过ActiveStorage将该信息附加给用户。我不会讲述如何上传照片，裁剪照片，或者如何设置动态存储。关于这些信息，我建议你查看下面的链接。</p><p id="43bb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">~ <a class="ae jo" href="https://betterprogramming.pub/how-to-upload-images-to-a-rails-api-and-get-them-back-again-b7b3e1106a13" rel="noopener ugc nofollow" target="_blank">上传/活动存储/云存储</a> ~ <a class="ae jo" href="https://www.npmjs.com/package/react-easy-crop" rel="noopener ugc nofollow" target="_blank">裁剪</a> ~</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jp"><img src="../Images/e1aa38f67c4b9277ab0e1c2e87dcab76.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*blXVEm8_4QNYdEriNG3qYg.png"/></div></div></figure><p id="79da" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在有趣的事情！我正在使用一个叫做react-easy-crop的便捷组件来裁剪我的图片(见上面的链接)。它带有回调onCropComplete，该回调被传递了两个参数croppedArea和croppedAreaPixels，并在用户停止移动媒体或停止缩放时被调用。这似乎是合理的起点。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div class="er es ju"><img src="../Images/08bb1f4ab7fb1c8bc085cd2d44cc7bae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1388/format:webp/1*482elDQjffFdCZNaUxuMMg.png"/></div></figure><p id="7728" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">基本上，我们这里要做的是获取裁剪后的图像，并将该信息设置为一个状态变量。很好很容易！要做到这一点，我们需要从图像的裁剪部分创建一个图像(我们将使用从onCropComplete获得的信息)，然后将该图像作为数据返回。cropImage组件就是为此而构建的。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jv"><img src="../Images/34252d4b0bedc6e66baa8c07ae5ccce5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7OzU5S35ODoQHwpE6ba2Hg.png"/></div></div></figure><p id="de60" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这里我们创建一个“画布”元素并使用。使用Context('2d ')在其上创建2d形状。我们使用从onCropComplete(croppedAreaPixles)传入的信息，在画布上仅绘制图像的裁剪部分。drawImage()。然后我们返回base64格式的画布。所有这些都是使用基于承诺的函数来暂停执行，直到返回的承诺被履行或拒绝。这是为了确保函数在继续之前有它们需要的信息。一旦我们从getCroppedImg接收到图像数据，我们将把该信息保存到一个状态变量中。现在，我们需要将这些信息传输到我们的Rails后端。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div class="er es ju"><img src="../Images/31287dc117c7efcbb791204e083a00d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1388/format:webp/1*uBNyMNv5NgP8b2w4zj2GSw.png"/></div></figure><p id="5e87" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">获取图像信息的一种方法是通过我们上传原始文件的现有表单。因此，在现有的表单中，我们将添加一个输入，其值等于包含更改图像信息的状态变量。这个输入的“名称”将非常重要。您可能希望输入的名称与ActiveStorage中的附件名称相同……我们将回到这个问题。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jw"><img src="../Images/02c9e5f988fc370d6aedf05dd2837caa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JKgyzNNdrP629zeCN7kpRg.png"/></div></div></figure><p id="942c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">提交处理程序非常简单。我们只是实例化一个新的FormData对象并传入我们的表单，然后在获取请求的主体中发送该信息。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jx"><img src="../Images/228ad05775691441acb4cb2e4c38cb7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HVOcARtJ2hXzZiKAs5wTaw.png"/></div></div></figure><p id="0af0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一旦信息到达我们的Rails API，我们需要将它附加到适当的用户。首先，让我们向ActiveStorage添加一些功能。让我们将<em class="jy">gem ' active _ storage _ base64 '</em>添加到我们的gem文件中。然后，我们将希望将<em class="jy">include ActiveStorageSupport::supportforbase 64</em>添加到application_record.rb。现在，我们可以将Base64映像附加到我们的用户！</p><figure class="jq jr js jt fd ij er es paragraph-image"><div class="er es jz"><img src="../Images/626c93742c7ca764aa61a47e4e4ada89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1208/format:webp/1*7sRDlkV_ntaDje4uZn5WGQ.png"/></div></figure><p id="2600" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要将图像附加到用户，只需添加<em class="jy"> has_one_base64_attched :foo即可。</em>确保在您的表单中存储图像数据的输入的名称与您的模型中的<em class="jy"> has_one_base64_attached </em>的名称相同！这是因为<em class="jy"> has_one_base64_attached </em>将寻找一个名为‘profile _ img’的参数来附加到用户。如果没有任何带有该名称的内容，那么它将不会附加任何内容。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jw"><img src="../Images/a064459bd191935bed755b3832acbe58.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KgiaCT8sB2PFVFznEAu9Ow.png"/></div></div></figure><p id="6976" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">取决于你如何设置ActiveRecord，就是这样！正在上传的图像和前端裁剪，现在被附加到适当的用户。编码快乐！</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ka"><img src="../Images/3364f1369b4f72004e59dd0bb53adcbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WMP75ZO8YK4WXA0aSkfWPw.png"/></div></div></figure></div></div>    
</body>
</html>