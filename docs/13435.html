<html>
<head>
<title>Common table expressions in ClickHouse</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ClickHouse中的常用表表达式</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/common-table-expressions-in-clickhouse-4b4556c296c1?source=collection_archive---------4-----------------------#2022-07-08">https://medium.com/geekculture/common-table-expressions-in-clickhouse-4b4556c296c1?source=collection_archive---------4-----------------------#2022-07-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><blockquote class="if ig ih"><p id="daff" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">通用表表达式或CTE(在SQL中)是一个临时命名的结果集，源自一个简单的查询，并在一个<code class="du jh ji jj jk b">SELECT</code>、<code class="du jh ji jj jk b">INSERT</code>、<code class="du jh ji jj jk b">UPDATE</code>或<code class="du jh ji jj jk b">DELETE</code>语句的执行范围内定义。<a class="ae jl" href="https://en.wikipedia.org/wiki/Hierarchical_and_recursive_queries_in_SQL" rel="noopener ugc nofollow" target="_blank">维基百科</a></p></blockquote><figure class="jn jo jp jq fd jr er es paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="er es jm"><img src="../Images/3410508c71a55fff7cbca1ebde7adc8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uTyl7gBJo1JbQSaK_8uczg.jpeg"/></div></div><figcaption class="jy jz et er es ka kb bd b be z dx">Photo by <a class="ae jl" href="https://unsplash.com/@killerfvith?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Alex wong</a> on <a class="ae jl" href="https://unsplash.com/s/photos/data-center?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="da0b" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">介绍</h1><p id="2c21" class="pw-post-body-paragraph ii ij hi il b im la io ip iq lb is it lc ld iw ix le lf ja jb lg lh je jf jg hb bi translated">在以下情况下使用CTE很方便:</p><ul class=""><li id="a9c3" class="li lj hi il b im in iq ir lc lk le ll lg lm jg ln lo lp lq bi translated">当一个请求可以获得数据，并且其大小适合内存空间时；</li><li id="3b3c" class="li lj hi il b im lr iq ls lc lt le lu lg lv jg ln lo lp lq bi translated">需要多次使用此查询的结果；</li><li id="3899" class="li lj hi il b im lr iq ls lc lt le lu lg lv jg ln lo lp lq bi translated">创建递归查询。</li></ul><p id="05a6" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it lc iv iw ix le iz ja jb lg jd je jf jg hb bi translated">额外的好处是提高了SQL查询的可读性。</p><p id="471c" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it lc iv iw ix le iz ja jb lg jd je jf jg hb bi translated">CTE与临时表和嵌套查询有什么区别？</p><ul class=""><li id="5cb2" class="li lj hi il b im in iq ir lc lk le ll lg lm jg ln lo lp lq bi translated">如果子查询与<a class="ae jl" href="https://en.wikipedia.org/wiki/Correlated_subquery" rel="noopener ugc nofollow" target="_blank">相关</a>，那么它的调用将在选择的每一行中重复，这大大增加了执行该查询的成本；</li><li id="5e4a" class="li lj hi il b im lr iq ls lc lt le lu lg lv jg ln lo lp lq bi translated">用大量数据填充临时表会给磁盘带来负载；</li><li id="cc2f" class="li lj hi il b im lr iq ls lc lt le lu lg lv jg ln lo lp lq bi translated">由于存储临时表的特性，使用它们执行查询会增加执行时间。</li></ul><h1 id="2e26" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">句法</h1><p id="7828" class="pw-post-body-paragraph ii ij hi il b im la io ip iq lb is it lc ld iw ix le lf ja jb lg lh je jf jg hb bi translated">ClickHouse既支持将&lt;表达式&gt;作为&lt;标识符&gt; 的<em class="ik">，也支持将&lt;标识符&gt;作为&lt;子查询表达式&gt; </em>的<em class="ik">语法。</em></p><ul class=""><li id="a6f4" class="li lj hi il b im in iq ir lc lk le ll lg lm jg ln lo lp lq bi translated">使用<em class="ik">启动CTE；</em></li><li id="3dff" class="li lj hi il b im lr iq ls lc lt le lu lg lv jg ln lo lp lq bi translated">为查询提供名称；</li><li id="adff" class="li lj hi il b im lr iq ls lc lt le lu lg lv jg ln lo lp lq bi translated">随后用<em class="ik">AS；</em></li><li id="e5f7" class="li lj hi il b im lr iq ls lc lt le lu lg lv jg ln lo lp lq bi translated">定义查询；</li><li id="c90a" class="li lj hi il b im lr iq ls lc lt le lu lg lv jg ln lo lp lq bi translated">如果需要多个cte，请用逗号分隔它们。</li></ul><figure class="jn jo jp jq fd jr"><div class="bz dy l di"><div class="lw lx l"/></div><figcaption class="jy jz et er es ka kb bd b be z dx">WITH &lt;identifier&gt; AS &lt;subquery expression&gt;</figcaption></figure><ul class=""><li id="31f8" class="li lj hi il b im in iq ir lc lk le ll lg lm jg ln lo lp lq bi translated">使用<em class="ik">启动CTE；</em></li><li id="013f" class="li lj hi il b im lr iq ls lc lt le lu lg lv jg ln lo lp lq bi translated">定义一个表达式；</li><li id="bb24" class="li lj hi il b im lr iq ls lc lt le lu lg lv jg ln lo lp lq bi translated">随后用<em class="ik">AS；</em></li><li id="c524" class="li lj hi il b im lr iq ls lc lt le lu lg lv jg ln lo lp lq bi translated">为表达式提供一个名称；</li><li id="0089" class="li lj hi il b im lr iq ls lc lt le lu lg lv jg ln lo lp lq bi translated">如果需要多个cte，请用逗号分隔它们。</li></ul><figure class="jn jo jp jq fd jr"><div class="bz dy l di"><div class="lw lx l"/></div><figcaption class="jy jz et er es ka kb bd b be z dx"><em class="ly">WITH &lt;expression&gt; AS &lt;identifier&gt;</em></figcaption></figure><h1 id="761e" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">例子</h1><p id="a645" class="pw-post-body-paragraph ii ij hi il b im la io ip iq lb is it lc ld iw ix le lf ja jb lg lh je jf jg hb bi translated">创建:</p><figure class="jn jo jp jq fd jr"><div class="bz dy l di"><div class="lw lx l"/></div></figure><p id="3bdf" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it lc iv iw ix le iz ja jb lg jd je jf jg hb bi translated">插入:</p><figure class="jn jo jp jq fd jr"><div class="bz dy l di"><div class="lw lx l"/></div></figure><p id="49f5" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it lc iv iw ix le iz ja jb lg jd je jf jg hb bi translated">选择:</p><figure class="jn jo jp jq fd jr"><div class="bz dy l di"><div class="lw lx l"/></div></figure><p id="8e80" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it lc iv iw ix le iz ja jb lg jd je jf jg hb bi translated">结果:</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="er es lz"><img src="../Images/b4ee775cf5d768bd045afe171f1a5e73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*49PCWLjHCh9cNmHfNVkodw.png"/></div></div></figure></div></div>    
</body>
</html>