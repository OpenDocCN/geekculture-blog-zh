<html>
<head>
<title>Terragrunt cheat sheet</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Terragrunt备忘单</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/terragrunt-cheat-sheet-bedafbf9d61f?source=collection_archive---------1-----------------------#2021-09-29">https://medium.com/geekculture/terragrunt-cheat-sheet-bedafbf9d61f?source=collection_archive---------1-----------------------#2021-09-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/0a7b4f205377eee08dcc63c980fbb0c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*oQHqgKB5NM1-0Alg"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">Photo by <a class="ae hv" href="https://unsplash.com/@abonyikevin?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Abonyi Kevin</a> on <a class="ae hv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><div class=""/><p id="da5d" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这是关于Terragrunt、Terraspace以及它们之间的最后一战的三集系列的第二篇文章。</p><blockquote class="jt ju jv"><p id="6f31" class="iv iw jw ix b iy iz ja jb jc jd je jf jx jh ji jj jy jl jm jn jz jp jq jr js hb bi translated">第一集:<a class="ae hv" rel="noopener" href="/geekculture/from-terralith-to-terraservice-with-terraform-acf990e65578">从Terralith到terra service with terra form</a><br/>第二集:Terrgrunt小抄(本文)<br/>第三集:<a class="ae hv" href="http://bit.ly/3o2DrMV" rel="noopener ugc nofollow" target="_blank"> Terraspace小抄</a></p></blockquote></div><div class="ab cl ka kb gp kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hb hc hd he hf"><p id="6af5" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">今天我将展示一个具有以下特征的Terragrunt项目:</p><ul class=""><li id="1529" class="kh ki hy ix b iy iz jc jd jg kj jk kk jo kl js km kn ko kp bi translated"><strong class="ix hz">多环境</strong>:测试&amp; QA</li><li id="5342" class="kh ki hy ix b iy kq jc kr jg ks jk kt jo ku js km kn ko kp bi translated"><strong class="ix hz">多账户</strong>:开发和测试的不同账户</li><li id="67f1" class="kh ki hy ix b iy kq jc kr jg ks jk kt jo ku js km kn ko kp bi translated"><strong class="ix hz">多地区</strong>:准备在不同地区之间拆分账户和项目</li></ul><p id="69a3" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">显然，最后，您应该能够根据您的需要相应地更改需求。</p><p id="19e8" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">本概述的范围是向您介绍Terragrunt背后的核心概念和结构。在我的公共存储库中，我已经添加了一些模块之间的依赖关系。目标是提供类似于真实用例的东西。</p><blockquote class="jt ju jv"><p id="e74e" class="iv iw jw ix b iy iz ja jb jc jd je jf jx jh ji jj jy jl jm jn jz jp jq jr js hb bi translated">资源库链接:<br/>T16】https://bit.ly/3maXDL0</p></blockquote><figure class="kw kx ky kz fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es kv"><img src="../Images/9fc50d72bdf9d095cd0c8cefd73c7f7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ixqIFlcBJCItbUWFae-F3Q.jpeg"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">[2]-[3]</figcaption></figure><h1 id="b339" class="la lb hy bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">什么是Terragrunt？</h1><p id="ac88" class="pw-post-body-paragraph iv iw hy ix b iy ly ja jb jc lz je jf jg ma ji jj jk mb jm jn jo mc jq jr js hb bi translated">Terragrunt是一个基于Terraform的框架，带有一些现成的新工具。感谢一些新文件<em class="jw"> *。hcl </em>和新的关键字，你可以非常容易地跨terraform模块共享变量。</p></div><div class="ab cl ka kb gp kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hb hc hd he hf"><h1 id="e24c" class="la lb hy bd lc ld md lf lg lh me lj lk ll mf ln lo lp mg lr ls lt mh lv lw lx bi translated">存储库结构:</h1><figure class="kw kx ky kz fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mi"><img src="../Images/c578c3dd4aee79dba02235275e592861.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6pdPsAFu16GDXqXk"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">Photo by <a class="ae hv" href="https://unsplash.com/@kyllik?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Külli Kittus</a> on <a class="ae hv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="1254" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这个项目中，我将使用以下代码创建一个VPC和一个EC2实例:</p><ul class=""><li id="e01b" class="kh ki hy ix b iy iz jc jd jg kj jk kk jo kl js km kn ko kp bi translated">两个有依赖关系的不同模块</li><li id="7d14" class="kh ki hy ix b iy kq jc kr jg ks jk kt jo ku js km kn ko kp bi translated">两个不同的账户</li><li id="4727" class="kh ki hy ix b iy kq jc kr jg ks jk kt jo ku js km kn ko kp bi translated">两种不同的环境</li></ul><p id="2f89" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一个makefile 来统治他们，一个makefile来寻找他们，一个makefile来带来他们，并在黑暗中绑定他们。</p><blockquote class="jt ju jv"><p id="e7b1" class="iv iw jw ix b iy iz ja jb jc jd je jf jx jh ji jj jy jl jm jn jz jp jq jr js hb bi translated">资源库链接:<br/>T23】https://bit.ly/3maXDL0</p></blockquote><pre class="kw kx ky kz fd mj mk ml mm aw mn bi"><span id="0bf3" class="mo lb hy mk b fi mp mq l mr ms">terragrunt<br/>├── Makefile<br/>├── modules<br/>│   ├── vpc<br/>│   │   ├── main.tf<br/>│   │   ├── output.tf<br/>│   │   ├── variables.tf<br/>│   │   └── versions.tf<br/>│   └── ec2<br/>│       ├── ec2.tf<br/>│       ├── iam.tf<br/>│       ├── output.tf<br/>│       ├── variables.tf<br/>│       └── versions.tf<br/>├── dev_account<br/>│   ├── account.hcl<br/>│   └── eu-central-1<br/>│       ├── test<br/>│       │   ├── vpc-service<br/>│       │   │   └── terragrunt.hcl<br/>│       │   ├── ec2-service<br/>│       │   │   └── terragrunt.hcl<br/>│       │   └── env.hcl<br/>│       └── region.hcl<br/>├── test_account<br/>│   ├── account.hcl<br/>│   └── eu-central-1<br/>│       ├── test<br/>│       │   ├── vpc-service<br/>│       │   │   └── terragrunt.hcl<br/>│       │   ├── ec2-service<br/>│       │   │   └── terragrunt.hcl<br/>│       │   └── env.hcl<br/>│       ├── qa<br/>│       │   ├── vpc-service<br/>│       │   │   └── terragrunt.hcl<br/>│       │   ├── ec2-service<br/>│       │   │   └── terragrunt.hcl<br/>│       │   └── env.hcl<br/>│       └── region.hcl<br/>└── config.hcl</span></pre><p id="7a48" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">第一个文件夹是“<em class="jw">模块”</em>，有两个子文件夹:</p><ul class=""><li id="d2dd" class="kh ki hy ix b iy iz jc jd jg kj jk kk jo kl js km kn ko kp bi translated">“vpc”:用于创建VPC的AWS模块</li><li id="fdec" class="kh ki hy ix b iy kq jc kr jg ks jk kt jo ku js km kn ko kp bi translated">“ec2”:用于创建EC2实例的模块</li></ul><p id="9dbb" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">对于每个帐户，您有这样的结构:</p><ul class=""><li id="e553" class="kh ki hy ix b iy iz jc jd jg kj jk kk jo kl js km kn ko kp bi translated">"<em class="jw"> dev_account" </em>:包含所有属于同一个账户的东西。</li><li id="4808" class="kh ki hy ix b iy kq jc kr jg ks jk kt jo ku js km kn ko kp bi translated">"<em class="jw"> eu-central-1" </em>:我们希望按服务部署一些模块的区域。</li><li id="95a0" class="kh ki hy ix b iy kq jc kr jg ks jk kt jo ku js km kn ko kp bi translated">"<em class="jw">测试</em>":在明确定义的区域中定义的环境。</li></ul><p id="1772" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">和两项服务:</p><ul class=""><li id="7ab9" class="kh ki hy ix b iy iz jc jd jg kj jk kk jo kl js km kn ko kp bi translated">"<em class="jw">VPC-service</em>":VPC模块。</li><li id="4f7e" class="kh ki hy ix b iy kq jc kr jg ks jk kt jo ku js km kn ko kp bi translated">"<em class="jw"> ec2-service </em>":指的是" ec2 "模块，它依赖于"<em class="jw"> vpc-service </em> " <em class="jw">。</em></li></ul><p id="88f0" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="jw">注:</em><em class="jw">test _ account】</em>中有相同的结构，有两个环境“test”和“qa”。</p><p id="30f8" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果您想要扩展文件夹树，您需要复制和粘贴或创建一个具有相同逻辑的新文件夹，并检查文件。</p><h2 id="66e1" class="mo lb hy bd lc mt mu mv lg mw mx my lk jg mz na lo jk nb nc ls jo nd ne lw nf bi translated">那<em class="ng"> *呢。hcl </em>文件？</h2><p id="4672" class="pw-post-body-paragraph iv iw hy ix b iy ly ja jb jc lz je jf jg ma ji jj jk mb jm jn jo mc jq jr js hb bi translated">它们的主要部分用于定义不同深度级别的变量。例如，如果你想为一个给定的区域创建一些特定的变量，你可以把它们添加到"<em class="jw"> region.hcl" </em>文件中，然后你就可以引用你的服务，作为被调用模块的输入变量。</p><p id="a169" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="jw"> *的简要描述。hcl" </em>文件:</p><ul class=""><li id="b334" class="kh ki hy ix b iy iz jc jd jg kj jk kk jo kl js km kn ko kp bi translated">config.hcl :它定义了必须如何创建TF后端和TFstate。该文件由多个帐户共享。</li><li id="b66f" class="kh ki hy ix b iy kq jc kr jg ks jk kt jo ku js km kn ko kp bi translated"><em class="jw"> account.hcl </em>:账户特定的变量。例如帐户id</li><li id="5c76" class="kh ki hy ix b iy kq jc kr jg ks jk kt jo ku js km kn ko kp bi translated"><em class="jw"> region.hcl </em>:区域特定的变量。例如，一些定制标签</li><li id="2da9" class="kh ki hy ix b iy kq jc kr jg ks jk kt jo ku js km kn ko kp bi translated"><em class="jw"> env.hcl </em>:环境的特定变量，例如我们希望所有服务都包含的ec2实例的类型</li></ul><p id="badb" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hz">那些<em class="jw"> *的范围</em></strong>。hcl" 文件只需<strong class="ix hz">写一次，就可以在不同的服务中重用</strong>。</p><p id="b74a" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了运行所有命令，GitHub repo中存在一个Makefile来简化管道中的采用。你可以很容易地扩展它，或者创建一个全新的bash脚本！</p><h1 id="f27e" class="la lb hy bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">利弊:</h1><figure class="kw kx ky kz fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es nh"><img src="../Images/e0508cf4a4cdf47cd926554e41ad143c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YOu1bnjUJUiW4dUe"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">Photo by <a class="ae hv" href="https://unsplash.com/@martinsanchez?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Martin Sanchez</a> on <a class="ae hv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="6f75" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hz"> ++强项:</strong></p><ul class=""><li id="612e" class="kh ki hy ix b iy iz jc jd jg kj jk kk jo kl js km kn ko kp bi translated">使用<em class="jw"> dependency </em>关键字在不同服务之间轻松共享变量(ec2-service使用vpc-service的输出变量)</li><li id="d8b6" class="kh ki hy ix b iy kq jc kr jg ks jk kt jo ku js km kn ko kp bi translated">您使用自定义关键字<em class="jw"> locals </em>共享和使用变量</li><li id="8cea" class="kh ki hy ix b iy kq jc kr jg ks jk kt jo ku js km kn ko kp bi translated">更有结构，我喜欢！</li><li id="0f43" class="kh ki hy ix b iy kq jc kr jg ks jk kt jo ku js km kn ko kp bi translated">自动为每个服务生成不同的TFState</li><li id="cd4c" class="kh ki hy ix b iy kq jc kr jg ks jk kt jo ku js km kn ko kp bi translated">多人能够在不同的环境中工作，而不会因为合并冲突而头疼</li></ul><p id="dee9" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hz"> — —弱点:</strong></p><ul class=""><li id="8f9f" class="kh ki hy ix b iy iz jc jd jg kj jk kk jo kl js km kn ko kp bi translated">对我来说最重要的是，你不能从一个服务中引用多个模块。相反，您需要创建一个新的模块，包含所有的资源和对其他模块的引用。对我来说，这个选择<strong class="ix hz">很有意义</strong>，因为它迫使你避免架构错误。</li><li id="ebc5" class="kh ki hy ix b iy kq jc kr jg ks jk kt jo ku js km kn ko kp bi translated">你重复多次<em class="jw"> *。hcl </em>文件，如果你需要添加更多的复杂性水平缩放(环境-区域-帐户)。</li><li id="b254" class="kh ki hy ix b iy kq jc kr jg ks jk kt jo ku js km kn ko kp bi translated">你结构很好，但也是<strong class="ix hz">要求</strong>。</li><li id="22d3" class="kh ki hy ix b iy kq jc kr jg ks jk kt jo ku js km kn ko kp bi translated">要计划/应用所有服务，您需要走在正确的道路上。如果您想要应用"<em class="jw"> eu-central-1" </em>中的所有服务，您只需在运行terragrunt命令之后，就可以移动到那里。</li></ul><blockquote class="jt ju jv"><p id="a10f" class="iv iw jw ix b iy iz ja jb jc jd je jf jx jh ji jj jy jl jm jn jz jp jq jr js hb bi translated">资源库链接:<br/>T38】https://bit.ly/3maXDL0</p></blockquote><p id="f1d0" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这个报告[1]中，你可以看到一个<strong class="ix hz">模块版本</strong>的例子。</p><figure class="kw kx ky kz fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ni"><img src="../Images/2451d710b8e7a4fdd78a10da477e1282.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*yT1xzI2VHJJ-CqKZ"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">Photo by <a class="ae hv" href="https://unsplash.com/@danielkcheung?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Daniel Cheung</a> on <a class="ae hv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="8c1f" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在下一集(<em class="jw">2021年10月第二周</em>)将会有与<strong class="ix hz"> Terraspace </strong>相同的项目，我也会发布他们之间的<strong class="ix hz">决战</strong>！</p></div><div class="ab cl ka kb gp kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hb hc hd he hf"><figure class="kw kx ky kz fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es nj"><img src="../Images/f70483376e306c4e160cc46f9ea9db26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EXlDZmTsPGsrqpGLGId81g.png"/></div></div></figure><blockquote class="nk"><p id="34d5" class="nl nm hy bd nn no np nq nr ns nt js dx translated"><a class="ae hv" href="https://pie-r.medium.com/" rel="noopener">关注我</a>和<a class="ae hv" href="https://pie-r.medium.com/subscribe" rel="noopener">订阅</a>来获取这个系列和下一个系列的更新！</p></blockquote></div><div class="ab cl ka kb gp kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hb hc hd he hf"><h1 id="02f2" class="la lb hy bd lc ld md lf lg lh me lj lk ll mf ln lo lp mg lr ls lt mh lv lw lx bi translated">参考资料:</h1><ul class=""><li id="12ee" class="kh ki hy ix b iy ly jc lz jg nu jk nv jo nw js km kn ko kp bi translated">[1]查看如何使用terragrunt管理版本化模块的示例:<br/><a class="ae hv" href="https://github.com/gruntwork-io/terragrunt-infrastructure-live-example" rel="noopener ugc nofollow" target="_blank">https://github . com/grunt work-io/terra grunt-infra structure-live-example</a></li><li id="fab7" class="kh ki hy ix b iy kq jc kr jg ks jk kt jo ku js km kn ko kp bi translated">[2]官方doc网站:<a class="ae hv" href="https://terragrunt.gruntwork.io/" rel="noopener ugc nofollow" target="_blank">https://terragrunt.gruntwork.io/</a></li><li id="deac" class="kh ki hy ix b iy kq jc kr jg ks jk kt jo ku js km kn ko kp bi translated">[3]特拉格朗特:<a class="ae hv" href="https://github.com/gruntwork-io/terragrunt" rel="noopener ugc nofollow" target="_blank">https://github.com/gruntwork-io/terragrunt</a></li></ul></div></div>    
</body>
</html>