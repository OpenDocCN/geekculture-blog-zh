<html>
<head>
<title>Capturing details and screenshots during a WebdrioverIO test</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在WebdrioverIO测试期间捕获详细信息和屏幕截图</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/capturing-details-and-screenshots-during-a-webdrioverio-test-2f4cc5879867?source=collection_archive---------12-----------------------#2022-05-29">https://medium.com/geekculture/capturing-details-and-screenshots-during-a-webdrioverio-test-2f4cc5879867?source=collection_archive---------12-----------------------#2022-05-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div class="er es hg"><img src="../Images/47511721fce1519ce20190367bb8d052.png" data-original-src="https://miro.medium.com/v2/resize:fit:334/format:webp/1*x9DQdFLCI-iFb31bji1DMg.png"/></div></figure><div class=""/><p id="d784" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hq">问题</strong></p><p id="c76b" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在您的项目中，您可能想要在一个文件中捕获每个已执行测试的指定操作。捕捉日期和时间以及名称将是识别每个测试用例的好方法，以便将来进行验证。此外，问题的一部分是，在执行时，如果测试失败，然后捕捉一个截图。</p><p id="54bd" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hq">一种解决方案</strong></p><p id="eb78" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">一种解决方案是在执行周期中触发定制动作。自动化工具通常支持这些特性。WDIO测试运行器允许在测试生命周期的特定时间触发挂钩。钩子是可以在执行周期的不同点运行的代码块。这允许自定义操作，比如在测试之前和之后捕获日期和时间以及名称。如果测试失败，可以使用相同的钩子来捕获屏幕截图。</p><p id="299d" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">解释从webdriverIO安装开始的解决方案的端到端流程的示例。</p></div><div class="ab cl jk jl gp jm" role="separator"><span class="jn bw bk jo jp jq"/><span class="jn bw bk jo jp jq"/><span class="jn bw bk jo jp"/></div><div class="hb hc hd he hf"><p id="c159" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">WebdriverIO提供了一个单行命令来创建一个新的WebdriverIO项目。可在macOS、Windows和Linux上运行。</p><pre class="jv jw jx jy fd jz ju ka kb aw kc bi"><span id="42de" class="kd ke hp ju b fi kf kg l kh ki">% npx create-wdio ./e2e</span></pre><p id="3560" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><code class="du jr js jt ju b">npx</code>是一个命令行界面(CLI)工具，用于安装和管理托管在节点程序包管理器(<code class="du jr js jt ju b">npm</code>)注册表中的依赖项。您将需要一个节点安装来成功运行<code class="du jr js jt ju b">npx</code>命令。</p><pre class="jv jw jx jy fd jz ju ka kb aw kc bi"><span id="39ab" class="kd ke hp ju b fi kf kg l kh ki">% which npx</span><span id="8f64" class="kd ke hp ju b fi kj kg l kh ki">% npx -v</span></pre><p id="c695" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">各种支持命令可用上面的命令将显示当前位置的位置和<code class="du jr js jt ju b">npx</code>命令的版本。</p><pre class="jv jw jx jy fd jz ju ka kb aw kc bi"><span id="fe3d" class="kd ke hp ju b fi kf kg l kh ki">% npm install -g npx</span></pre><p id="7574" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">默认情况下，安装<code class="du jr js jt ju b">npm</code>时会出现<code class="du jr js jt ju b">npx</code>命令，如果<code class="du jr js jt ju b">npx</code>不可用，安装命令就派上用场了。</p><p id="e50d" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">既然我们已经达成了共识<code class="du jr js jt ju b">npx</code>让我们前往<code class="du jr js jt ju b">create-wdio</code>指挥部。这个命令将执行一些任务，它将从创建一个<code class="du jr js jt ju b">package.json</code>文件开始。如果当前目录中不存在该JSON文件。<code class="du jr js jt ju b">package.json</code>是一个JSON文件，存在于JavaScript/TypeScript项目的根目录下。以最简单的形式，这个JSON文件保存了与管理项目依赖项相关的元数据。在下一阶段，将出现一个交互式向导，允许定制安装WebdriverIO软件包。</p><pre class="jv jw jx jy fd jz ju ka kb aw kc bi"><span id="e11b" class="kd ke hp ju b fi kf kg l kh ki">? Where is your automation backend located? On my local machine<br/>? Which framework <strong class="ju hq">do</strong> you want to use? mocha<br/>? Do you want to use a compiler? TypeScript (https://www.typescriptlang.org/)<br/>? Where are your test specs located? ./test/specs/**/*.ts<br/>? Do you want WebdriverIO to autogenerate some test files? Yes<br/>? Do you want to use page objects (https://martinfowler.com/bliki/PageObject.html)? Yes<br/>? Where are your page objects located? ./test/pageobjects/**/*.ts<br/>? Which reporter <strong class="ju hq">do</strong> you want to use? spec<br/>? Do you want to add a plugin to your test setup? <br/>? Do you want to add a service to your test setup? chromedriver<br/>? What is the base url? <a class="ae kk" href="http://localhost" rel="noopener ugc nofollow" target="_blank">http://localhost</a><br/>? Do you want me to run `npm install` (Y/n) Yes</span></pre><p id="53a0" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">通过交互式向导安装的wdio软件包有</p><ol class=""><li id="e182" class="kl km hp io b ip iq it iu ix kn jb ko jf kp jj kq kr ks kt bi translated"><em class="ku"> Local-runner </em> :-用最少的努力在本地环境中开始测试Local-runner是WebdriverIO解决方案。</li><li id="1687" class="kl km hp io b ip kv it kw ix kx jb ky jf kz jj kq kr ks kt bi translated"><em class="ku">Mocha-framework:</em>-web drivero提供对各种测试框架的支持。Mocha就是这样一个功能丰富的测试框架，运行在Node.js上和浏览器中，使得异步测试变得简单而有趣。</li><li id="ec82" class="kl km hp io b ip kv it kw ix kx jb ky jf kz jj kq kr ks kt bi translated">就像框架一样，WebdriverIO的强大之处在于支持各种报告工具。Spec-reporter是一个WebdriverIO插件，以可读的语句表示结果，即Spec风格。</li><li id="7ab6" class="kl km hp io b ip kv it kw ix kx jb ky jf kz jj kq kr ks kt bi translated"><em class="ku">Chromedriver-service</em>:-包装chrome driver，以便在使用WDIO测试运行器运行测试时无缝运行。这项服务不需要Selenium服务器，而是使用ChromeDriver直接与浏览器通信。因此也安装了ChromeDriver。谈到ChromeDriver，一个常见的问题是没有发现或者有时在chrome的支持版本和实际版本之间存在差异。这些错误消息中的大多数都是不言自明的。如果因为任何原因需要知道chrome的安装位置。项目的ChromeDriver二进制文件可以在位置<code class="du jr js jt ju b">/node_modules/chromedriver/lib/chromedriver/chromedriver</code>找到</li><li id="8bd4" class="kl km hp io b ip kv it kw ix kx jb ky jf kz jj kq kr ks kt bi translated"><em class="ku"> Ts-node </em> :-一个typescript执行引擎和Node.js的read-evaluate-print循环(REPL)，在这个过程中还会安装TypeScript。Ts-node just in time将TypeScript转换为JavaScript，支持在Node.js上直接执行TypeScript而无需预编译。在每个项目的基础上设置TypeScript可以让您拥有许多项目，这些项目具有许多不同版本的TypeScript。还更新了与支持TypeScript相关的包。</li></ol><p id="c3a1" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">根据交互式向导完成安装后，将创建配置文件并添加脚本。并且在控制台中出现WebdriverIO项目完成消息的设置。既然我们已经在<code class="du jr js jt ju b">e2e</code>里面建立了项目，wdio建议改变目录和命令来执行第一个测试。</p><p id="b0fd" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">由于我们已经选择了自动生成一些测试文件，我们可以通过指向刚刚创建的WebdriverIO配置来启动测试执行。配置文件指定了应该运行的测试文件。这些规范被定义为一组规范文件，并在同一个或单独的工作进程中运行。为了让一组规范文件在同一个工作进程中运行，只需将它们放在规范数组中的一个数组中。该模式与调用“wdio”的目录相关。</p><pre class="jv jw jx jy fd jz ju ka kb aw kc bi"><span id="0b61" class="kd ke hp ju b fi kf kg l kh ki">e2e % cd e2e <br/>e2e % npm run wdio</span></pre><p id="0546" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><code class="du jr js jt ju b">npm</code>，run wdio从软件包的<code class="du jr js jt ju b">scripts</code>对象运行任意命令。默认脚本将指向WebdriverIO配置。如果没有提供<code class="du jr js jt ju b">command</code>，它将列出可用的脚本。</p><pre class="jv jw jx jy fd jz ju ka kb aw kc bi"><span id="07ea" class="kd ke hp ju b fi kf kg l kh ki">​​”wdio”: “wdio run test/wdio.conf.ts”</span></pre><p id="5fb3" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果您试图在没有<code class="du jr js jt ju b">node_modules</code>目录的情况下运行一个脚本，并且命令失败，那么您将会得到对<code class="du jr js jt ju b">run npm install</code>的警告。</p><p id="53c1" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在我们已经看到了用一个强大的命令安装WebdriverIO是多么容易。让我们看看如何完成手头问题的解决方案。正如在解决方案部分已经提到的，WebdriverIO提供了几个钩子来干扰测试过程，以增强钩子的使用并围绕钩子构建服务。挂钩可以是一个函数，也可以是一组方法。挂钩具有特定于测试套件或测试生命周期的参数。<code class="du jr js jt ju b">wdio.conf.ts</code>是所有钩子都能找到的地方。尽管我们已经选择了设置wdio项目的所有选项，但当我们打开<code class="du jr js jt ju b">wdio.conf.ts</code>文件时，仍然有一个问题。这可以通过删除类型的import语句轻松解决。</p><pre class="jv jw jx jy fd jz ju ka kb aw kc bi"><span id="fa9b" class="kd ke hp ju b fi kf kg l kh ki">import type { Options } from ‘@wdio/types’</span></pre><p id="7337" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">由于删除了类型的导入语句，导出语句必须更新如下。</p><pre class="jv jw jx jy fd jz ju ka kb aw kc bi"><span id="396a" class="kd ke hp ju b fi kf kg l kh ki"><strong class="ju hq">export</strong> <strong class="ju hq">const</strong> config = {</span></pre><p id="7dd6" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">通过挂钩<code class="du jr js jt ju b">beforeTest</code>和<code class="du jr js jt ju b">afterTest</code>，可以轻松捕捉每次测试前后的姓名、日期和时间等细节。钩子<code class="du jr js jt ju b">afterTest</code>也可以被重用来捕获失败测试的截图。</p><p id="b872" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><em class="ku">测试前</em> <a class="ae kk" href="https://webdriver.io/docs/options/#beforetest" rel="noopener ugc nofollow" target="_blank"> </a></p><p id="3b74" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">是在测试前执行的功能，只能在摩卡/茉莉中使用。cucumber框架不能依赖这个函数。</p><pre class="jv jw jx jy fd jz ju ka kb aw kc bi"><span id="2010" class="kd ke hp ju b fi kf kg l kh ki">beforeTest: <strong class="ju hq">function</strong> (test, context) {<br/> displayDateAndTimeWithTitle(test, “Entry”);<br/> },</span></pre><p id="cc96" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><code class="du jr js jt ju b">displayDateAndTimeWithTitle()</code>是一个自定义函数，用于捕获文件中的测试细节。配置不变后，自定义函数放在<code class="du jr js jt ju b">wdio.conf.ts</code>文件中。将指定数据异步更新到外部文件由<code class="du jr js jt ju b">fsPromises.writeFile()</code>方法负责。默认情况下，如果文件存在，它将被替换。该方法接受三个参数，即文件名、将被写入文件的数据以及最后将影响输出的可选参数。这个方法返回一个承诺，WebdriverIO将等待，直到这个承诺得到解决，然后继续。函数<code class="du jr js jt ju b">beforeTest</code>的测试参数提供了当前执行测试的标题。从<code class="du jr js jt ju b">new Date()</code>中提取指定格式的日期和时间</p><pre class="jv jw jx jy fd jz ju ka kb aw kc bi"><span id="6c17" class="kd ke hp ju b fi kf kg l kh ki"><strong class="ju hq">const</strong> fsPromises = require(‘fs’).promises;<br/><strong class="ju hq">const</strong> RESULTS_FOLDER = “screenshots”;<br/><strong class="ju hq">function</strong> <strong class="ju hq">displayDateAndTimeWithTitle</strong>(test, stage) {<br/> <strong class="ju hq">const</strong> today = <strong class="ju hq">new</strong> Date();<br/> fsPromises.writeFile(<br/> `${RESULTS_FOLDER}/data.txt`,<br/> `${today.getDate()}-${today.getMonth() + 1}-${today.getFullYear().toString().slice(-2)} ${today.getHours()}:${today.getMinutes()}:${today.getSeconds()} ${stage}: ${test.title}\n`,<br/> { flag: “a+” }<br/> );<br/> }</span></pre><p id="4431" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><em class="ku">事后</em> <a class="ae kk" href="https://webdriver.io/docs/options/#aftertest" rel="noopener ugc nofollow" target="_blank"> </a></p><p id="c9b2" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在Mocha/Jasmine框架中测试结束后要执行的函数。除了捕获测试的细节，这个函数还检查执行结果，并在失败时捕获屏幕截图。</p><pre class="jv jw jx jy fd jz ju ka kb aw kc bi"><span id="eb99" class="kd ke hp ju b fi kf kg l kh ki">afterTest: <strong class="ju hq">function</strong> (<br/> test,<br/> context,<br/> { error, result, duration, passed, retries }<br/> ) {<br/> displayDateAndTimeWithTitle(test, “Exit”);<br/> <strong class="ju hq">const</strong> f = <strong class="ju hq">async</strong> () =&gt; {<br/> <strong class="ju hq">if</strong> (passed === <strong class="ju hq">false</strong>) {<br/> <strong class="ju hq">await</strong> browser.saveScreenshot(`${RESULTS_FOLDER}/${test.title}.png`);<br/> }<br/> };<br/> <strong class="ju hq">return</strong> f();<br/> },</span></pre><p id="cfcd" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">方法<code class="du jr js jt ju b">saveScreenshot()</code>保存当前浏览上下文的截图。在Firefox中使用Geckodriver时，<code class="du jr js jt ju b">saveScreenshot()</code>方法对整个文档进行截图。在Chromedriver和Chrome一起使用的情况下，它只捕获当前的视口。</p></div><div class="ab cl jk jl gp jm" role="separator"><span class="jn bw bk jo jp jq"/><span class="jn bw bk jo jp jq"/><span class="jn bw bk jo jp"/></div><div class="hb hc hd he hf"><p id="d580" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我打算突然停止听到，因为这已经成为一个长期的职位，因为我已经花了一些时间通过初始设置。下一次，我将把这篇文章作为参考文章，并写一些完成特定任务的短文。</p></div></div>    
</body>
</html>