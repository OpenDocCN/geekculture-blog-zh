<html>
<head>
<title>How to use macOS Specific API in macCatalyst Apps(and Vice Versa)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在macCatalyst应用中使用特定于macOS的API(反之亦然)</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/use-of-macos-specific-api-in-maccatalyst-apps-and-vice-versa-e7082a007b7c?source=collection_archive---------10-----------------------#2021-04-19">https://medium.com/geekculture/use-of-macos-specific-api-in-maccatalyst-apps-and-vice-versa-e7082a007b7c?source=collection_archive---------10-----------------------#2021-04-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="10af" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Mac Catalyst允许开发者快速将他们的iOS应用移植到macOS。但是在不添加任何mac特定功能的情况下迁移它们与运行iOS simulator没有什么不同。</p><h2 id="9e98" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">动机</h2><p id="6cc5" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">Home是苹果从iOS移植的首批应用之一。它可以让你从mac上控制homekit配件。当你尝试在你的macOS应用中使用HomeKit API会发生什么？</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es kd"><img src="../Images/b12086541514356eef9189b7d0006eea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FUnZTyeCzIoB5mHsm_PY2Q.png"/></div></div></figure><p id="ff0f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以想象一下，当你尝试使用<code class="du kp kq kr ks b">NSStatusItem</code>时，iOS中也会出现同样的情况。在本文中，我们将了解如何同时使用iOS特定的API和macOS特定的函数。(如果你不想遵循一步一步的过程，你可以在这篇文章的末尾找到完整的源代码。)</p><h1 id="bea8" class="kt je hi bd jf ku kv kw jj kx ky kz jn la lb lc jq ld le lf jt lg lh li jw lj bi translated">项目设置</h1><p id="dd29" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">首先，我们需要创建一个新的iOS应用程序项目。我们将使用以下设置:</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es lk"><img src="../Images/e12f7374552c2f43582c3579d676edd4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nSshn4FUvhxvXkhhAS-8NQ.png"/></div></div></figure><p id="ff95" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">并在项目设置的“常规”选项卡中的“部署信息”下启用mac支持。</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es ll"><img src="../Images/76dd4a82745424395644d53d8d021d3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VmGvdvKwJP9uyMzy44mUkA.png"/></div></div></figure><p id="8c55" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们需要做的第一件事是在应用程序启动时初始化macOS和iOS之间的通信。为此，我们将创建一个实现“UIApplicationDelegate”的新类，并在我们的主应用程序结构中声明它。</p><pre class="ke kf kg kh fd lm ks ln lo aw lp bi"><span id="0f5d" class="jd je hi ks b fi lq lr l ls lt"><strong class="ks hj">import</strong> SwiftUI<br/><strong class="ks hj">@main</strong></span><span id="b5ec" class="jd je hi ks b fi lu lr l ls lt"><strong class="ks hj">struct</strong> iOS2macApp: App {</span><span id="224a" class="jd je hi ks b fi lu lr l ls lt">   @UIApplicationDelegateAdaptor(AppDelegate.<strong class="ks hj">self</strong>) <strong class="ks hj">var</strong> appDelegate</span><span id="66c5" class="jd je hi ks b fi lu lr l ls lt"><strong class="ks hj">   var</strong> body: <strong class="ks hj">some</strong> Scene {<br/>      WindowGroup {<br/>        ContentView()<br/>      }<br/>   }<br/>}</span></pre><p id="07db" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在到了魔法发生的部分…</p></div><div class="ab cl lv lw gp lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="hb hc hd he hf"><h2 id="0018" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">macOS套装设置</h2><p id="4668" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">为了在我们的应用中运行macOS代码，我们需要创建一个新的目标——MAC OS Bundle。我将其命名为<code class="du kp kq kr ks b">macOSBridge</code>,但是你可以选择你喜欢的任何东西，并将其余的设置保留为默认设置。</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es mc"><img src="../Images/0e1d57ea87e4dc9ea3438ee0e7eb3e0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rTN8XLJwsy-IKwBGVMd93Q.png"/></div></div></figure><p id="4205" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将用你选择的名字创建一个新文件夹，在其中你只能找到一个<code class="du kp kq kr ks b">Info.plist</code>文件。这个文件的最后一行是这个包的主体类，所以让我们创建一个！在创建一个新类的时候，你会看到创建一个新的桥接头的选项，所以你一定要同意这样做。</p><p id="010d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我们定义了主类(<code class="du kp kq kr ks b">MacOSBridge</code>)之后，我们需要将它的名字添加到<code class="du kp kq kr ks b">Info.plist</code>的最后一行。我们的类名会这样定义<br/> <code class="du kp kq kr ks b">$(PRODUCT_MODULE_NAME).MacOSBridge</code></p><h1 id="82a1" class="kt je hi bd jf ku kv kw jj kx ky kz jn la lb lc jq ld le lf jt lg lh li jw lj bi translated">准备通信接口</h1><p id="05d5" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">在这个例子中，我们将通过创建<code class="du kp kq kr ks b">NSStatusItem</code>并在应用程序的iOS端对其点击做出反应来演示双向通信。为此，我们需要如下定义的两个接口。</p><pre class="ke kf kg kh fd lm ks ln lo aw lp bi"><span id="afde" class="jd je hi ks b fi lq lr l ls lt"><strong class="ks hj">@objc(iOS2Mac)<br/>public protocol</strong> iOS2Mac: NSObjectProtocol {<br/>   <strong class="ks hj">init</strong>()<br/>   <strong class="ks hj">var</strong> iosListener: mac2iOS? { <strong class="ks hj">get</strong> <strong class="ks hj">set</strong> }<br/>   <strong class="ks hj">func</strong> createBarItem()<br/>}</span><span id="9c5c" class="jd je hi ks b fi lu lr l ls lt"><strong class="ks hj">@objc(mac2iOS)<br/>public protocol</strong> mac2iOS: NSObjectProtocol {<br/>   <strong class="ks hj">func</strong> barItemClicked()<br/>}</span></pre><p id="4c42" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们的<code class="du kp kq kr ks b">MacOSBridge</code>类需要实现<code class="du kp kq kr ks b">iOS2Mac</code>协议。</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div class="er es md"><img src="../Images/3c36e968bd9b2f8a688983bb8be75509.png" data-original-src="https://miro.medium.com/v2/resize:fit:1052/format:webp/1*yT4rbEhqUB3yjhJIYhjUhA.png"/></div></figure><p id="1e50" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">确保在两个目标(mac Bundle和iOS App)中都有目标成员的文件中定义这两个接口。</p><h2 id="d1aa" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">从包中加载和使用代码</h2><p id="fe76" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">有必要加载包并实例化它的主体类。在本文中，我们将在<code class="du kp kq kr ks b">AppDelegate</code>中实现，但是您可以在任何适合您选择的架构的地方实现。app确实这样启动完looka后手动加载。我们保留了对iOS2Mac实现的引用，以便以后使用，并且我们将实现<code class="du kp kq kr ks b">mac2iOS</code>协议的<code class="du kp kq kr ks b">AppDelegate</code>类设置为macOS事件的监听器。</p><pre class="ke kf kg kh fd lm ks ln lo aw lp bi"><span id="b507" class="jd je hi ks b fi lq lr l ls lt"><strong class="ks hj">var</strong> ios2mac: iOS2Mac?</span><span id="a5b4" class="jd je hi ks b fi lu lr l ls lt"><strong class="ks hj">func</strong> application(<strong class="ks hj">_</strong> application: UIApplication,<br/>     didFinishLaunchingWithOptions<br/>     launchOptions: [UIApplication.LaunchOptionsKey : <strong class="ks hj">Any</strong>]? = <strong class="ks hj">nil<br/></strong>) -&gt; Bool {<br/>   loadPlugin()<br/>   <strong class="ks hj">return</strong> <strong class="ks hj">true<br/></strong>}</span><span id="380d" class="jd je hi ks b fi lu lr l ls lt"><strong class="ks hj">func</strong> loadPlugin() {<br/><strong class="ks hj">   let</strong> bundleFile = "macOSBridge.bundle"<br/>   <strong class="ks hj">guard</strong> <strong class="ks hj">let</strong> bundleURL = Bundle.main.builtInPlugInsURL?.appendingPathComponent(bundleFile),<br/>   <strong class="ks hj">let</strong> bundle = Bundle(url: bundleURL),<br/>   <strong class="ks hj">let</strong> pluginClass = bundle.principalClass <strong class="ks hj">as</strong>? iOS2Mac.Type <br/>   <strong class="ks hj">else</strong> { <strong class="ks hj">return</strong> }</span><span id="e4ad" class="jd je hi ks b fi lu lr l ls lt">   ios2mac = pluginClass.init()<br/>   ios2mac?.iosListener = <strong class="ks hj">self //respond to mac events<br/></strong>}</span></pre><h1 id="2d4c" class="kt je hi bd jf ku kv kw jj kx ky kz jn la lb lc jq ld le lf jt lg lh li jw lj bi translated">结束循环</h1><p id="83ee" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">在我们的例子中，我们将通过<code class="du kp kq kr ks b">SwiftUI</code>的<code class="du kp kq kr ks b">@EnvironmentObject</code>传递对<code class="du kp kq kr ks b">AppDelegate</code>的引用。(请记住，我们这样做是为了简化代码，以便进行指导。)我肯定你知道你想把你的<strong class="ih hj">电话放在什么地方。您可以在本文末尾找到带有完整代码的Github链接。点击按钮将触发<code class="du kp kq kr ks b">createBarItem()</code>,在我们的例子中是这样的:</strong></p><pre class="ke kf kg kh fd lm ks ln lo aw lp bi"><span id="fb42" class="jd je hi ks b fi lq lr l ls lt"><strong class="ks hj">let</strong> statusItem = NSStatusBar.system.statusItem(withLength:NSStatusItem.squareLength)</span><span id="f761" class="jd je hi ks b fi lu lr l ls lt"><strong class="ks hj">func</strong> createBarItem() {<br/><strong class="ks hj">  if</strong> <strong class="ks hj">let</strong> button = statusItem.button {<br/>    button.title = "🏠" //since we control home 🙂<br/>    button.target = <strong class="ks hj">self<br/>    </strong>button.action = <strong class="ks hj">#selector</strong>(MacOSBridge.statusItemClicked)<br/>  }<br/>}</span><span id="80b7" class="jd je hi ks b fi lu lr l ls lt"><strong class="ks hj">@objc</strong> <strong class="ks hj">func</strong> statusItemClicked() {<br/>  iosListener?.barItemClicked()<br/>}</span></pre><h2 id="7b81" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">最后的魔法</h2><p id="938d" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">正如开始时所承诺的，当点击<code class="du kp kq kr ks b">NSStatusItem</code>时，我们将通过控制HomeKit设备来关闭循环。所以让我们开始吧…</p><p id="0027" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将做一件非常简单的事情=打开列表中的第一个设备。让我们从在一个简单的阵列中存储具有功率控制特性的器件开始。</p><pre class="ke kf kg kh fd lm ks ln lo aw lp bi"><span id="3bc9" class="jd je hi ks b fi lq lr l ls lt"><strong class="ks hj">func</strong> setUpHomeManager() {<br/>  mgr = HMHomeManager()<br/>  mgr?.delegate = <strong class="ks hj">self<br/></strong>}</span><span id="12b8" class="jd je hi ks b fi lu lr l ls lt"><strong class="ks hj">func</strong> homeManagerDidUpdateHomes(<strong class="ks hj">_</strong> manager: HMHomeManager) {<br/>  <strong class="ks hj">var</strong> supportedAccessories:[HMAccessory] = []<br/>  <strong class="ks hj">for</strong> home <strong class="ks hj">in</strong> manager.homes {</span><span id="bb23" class="jd je hi ks b fi lu lr l ls lt"><strong class="ks hj">  let</strong> powerControls = home.accessories.filter {<br/>      $0.services.contains {<br/>          $0.characteristics.contains {<br/>             $0.characteristicType == HMCharacteristicTypePowerState<br/>          }<br/>       }<br/>    }<br/>    supportedAccessories.append(contentsOf: powerControls)<br/>  }<br/>  allPowerControllableAccessories = supportedAccessories<br/> }<br/>}</span></pre><p id="a041" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">拼图的最后一块是将值<code class="du kp kq kr ks b">1</code>写入列表中第一个附件的功率特性。我们在<code class="du kp kq kr ks b">HMAccessory</code>扩展中这样做:</p><pre class="ke kf kg kh fd lm ks ln lo aw lp bi"><span id="2082" class="jd je hi ks b fi lq lr l ls lt"><strong class="ks hj">extension</strong> HMAccessory {</span><span id="7bd8" class="jd je hi ks b fi lu lr l ls lt"><strong class="ks hj">func</strong> turnOn() {<br/>  <strong class="ks hj">_</strong> = <strong class="ks hj">self</strong>.services.map {<br/>    $0.characteristics.map {<br/>      <strong class="ks hj">if</strong> ($0.characteristicType == HMCharacteristicTypePowerState) {<br/>        $0.writeValue(1) { (e) <strong class="ks hj">in<br/>         </strong>print("error while turning on the device \(e?.localizedDescription ?? "")")<br/>        }<br/>      }<br/>    }<br/>  }<br/> }<br/>}</span></pre><h2 id="a24f" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">解决纷争</h2><p id="1923" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">沿途您可能会看到一些错误消息..</p><pre class="ke kf kg kh fd lm ks ln lo aw lp bi"><span id="ddd8" class="jd je hi ks b fi lq lr l ls lt"><strong class="ks hj">This app has crashed because it attempted to access privacy-sensitive data without a usage description.  The app's Info.plist must contain an NSHomeKitUsageDescription key with a string value explaining to the user how the app uses this data.</strong></span></pre><p id="b0b0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你知道该怎么做；)所以在iOS App里做<code class="du kp kq kr ks b">Info.plist</code></p><p id="dea7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您看到以下错误…</p><pre class="ke kf kg kh fd lm ks ln lo aw lp bi"><span id="86b4" class="jd je hi ks b fi lq lr l ls lt"><strong class="ks hj">Sync operation failed with error: Error Domain=NSCocoaErrorDomain Code=4097 "connection to service on pid 0 named com.apple.homed.xpc" UserInfo={NSDebugDescription=connection to service on pid 0 named com.apple.homed.xpc}</strong></span></pre><p id="1db8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">…您忘记将HomeKit功能添加到您的iOS目标或拒绝访问家庭数据的权限。</p></div><div class="ab cl lv lw gp lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="hb hc hd he hf"><h1 id="92d4" class="kt je hi bd jf ku me kw jj kx mf kz jn la mg lc jq ld mh lf jt lg mi li jw lj bi translated">包裹</h1><p id="3029" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">添加macOS特定的控件和功能会将移植的应用程序提升到另一个层次。但是有时存在API可用性悖论，比如HomeKit，它迫使您为项目使用不同的设置。我用这种方法建立了一个touchbar应用程序来控制我办公室的灯，并从我的本地网络外部控制我的配件，而不用iPad或HomePod作为家庭中枢。</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div class="er es mj"><img src="../Images/ad0a27055a922a2f8c8dec00bf89aa43.png" data-original-src="https://miro.medium.com/v2/resize:fit:1100/1*Nmt4viqSnJiwm8UQlY2taA.gif"/></div><figcaption class="mk ml et er es mm mn bd b be z dx">My ’Room8' app (lights are visible in reflection)</figcaption></figure><p id="b413" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我希望这种变通方法能帮助你实现你的想法。完整的源代码可在<a class="ae mo" href="https://github.com/erikhric/ios2mac" rel="noopener ugc nofollow" target="_blank">这里</a>获得。如果你觉得这篇文章有帮助，给我一个⭐️。<br/>祝你项目顺利:)</p></div></div>    
</body>
</html>