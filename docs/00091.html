<html>
<head>
<title>Unpack Cloud Native Buildpacks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">解包云原生构建包</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/unpack-cloud-native-buildpacks-9959b601424b?source=collection_archive---------0-----------------------#2020-04-29">https://medium.com/geekculture/unpack-cloud-native-buildpacks-9959b601424b?source=collection_archive---------0-----------------------#2020-04-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="f222" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">重构的构建包</h2></div><p id="7de3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi jt translated"><span class="l ju jv jw bm jx jy jz ka kb di">在</span>这篇博客中，我们来看看云原生构建包(CNB)的规格和最近宣布的CNB的开源实现——<strong class="iz hj">pake to-build packs</strong>。</p><h2 id="ca83" class="kc kd hi bd ke kf kg kh ki kj kk kl km jg kn ko kp jk kq kr ks jo kt ku kv kw bi translated">需要一个规范</h2><p id="b684" class="pw-post-body-paragraph ix iy hi iz b ja kx ij jc jd ky im jf jg kz ji jj jk la jm jn jo lb jq jr js hb bi translated">从源代码创建自包含的可运行工件的艺术并不新鲜。它始于Heroku，然后云铸造社区采用了它并将其带到企业中。当时buildpack技术的规范还没有完全定义，也没有明确提到底层平台。这导致了与底层平台紧密耦合的不同实现。快进到今天——容器技术空间和工具集的出现和成熟，使得Heroku和Pivotal的人员能够将两个世界的精华带到一个新的统一融合规范——云原生构建包(CNB) v3。</p><blockquote class="lc ld le"><p id="614f" class="ix iy lf iz b ja jb ij jc jd je im jf lg jh ji jj lh jl jm jn li jp jq jr js hb bi translated">根据官方文件，</p><p id="d81a" class="ix iy lf iz b ja jb ij jc jd je im jf lg jh ji jj lh jl jm jn li jp jq jr js hb bi translated">CNB定义了平台、生命周期、许多构建包和应用程序之间的交互</p><p id="ffa6" class="ix iy lf iz b ja jb ij jc jd je im jf lg jh ji jj lh jl jm jn li jp jq jr js hb bi translated">buildpack是将应用程序源代码部分或全部转换成可运行工件的软件。</p><p id="5526" class="ix iy lf iz b ja jb ij jc jd je im jf lg jh ji jj lh jl jm jn li jp jq jr js hb bi translated">生命周期是编排构建包并将结果工件转换成OCI映像的软件。</p><p id="a1c0" class="ix iy lf iz b ja jb ij jc jd je im jf lg jh ji jj lh jl jm jn li jp jq jr js hb bi translated">平台是编排生命周期的软件，使buildpack功能对最终用户(如应用程序开发人员)可用。</p></blockquote><figure class="lk ll lm ln fd lo er es paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="er es lj"><img src="../Images/7bff468ab0f8860cf27f60e06af904ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xl2i5k1vB9BxDuC9LY6Mhw.png"/></div></div><figcaption class="lv lw et er es lx ly bd b be z dx">CNB</figcaption></figure><p id="3bb2" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一个定义良好的规范将这项成熟的技术推向了开源社区。除了这个规范，CNB还提供了类似<code class="du lz ma mb mc b">pack</code>的基础设施命令行工具。pack-cli允许选择多个参考实现来本地测试这项技术，并模拟它在实际平台上的表现。</p></div><div class="ab cl md me gp mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="hb hc hd he hf"><p id="6eb3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj"> paketo-buildpacks </strong></p><p id="10e9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">paketo-buildpacks 是一个参考实现，它利用CNB规范为不同的语言运行时构建符合OCI规范的映像。在这篇博客中，让我们看看几个参与图像构建的模块层，以及我们如何定制这些层。</p><p id="0dcb" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">结果:</strong></p><ul class=""><li id="8c70" class="ml mm hi iz b ja jb jd je jg mn jk mo jo mp js mq mr ms mt bi translated">为java应用程序构建一个实验性的小型运行映像堆栈</li><li id="3087" class="ml mm hi iz b ja mu jd mv jg mw jk mx jo my js mq mr ms mt bi translated">通过将有贡献的模块化构建包放在一起，构建一个元java构建包</li><li id="a9bf" class="ml mm hi iz b ja mu jd mv jg mw jk mx jo my js mq mr ms mt bi translated">利用元构建包和微型堆栈构建一个定制的构建器</li><li id="bc5b" class="ml mm hi iz b ja mu jd mv jg mw jk mx jo my js mq mr ms mt bi translated">使用自定义构建器在本地和平台上构建来自源的标准OCI映像</li></ul><p id="7eb2" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">先决条件:</strong></p><ul class=""><li id="04b8" class="ml mm hi iz b ja jb jd je jg mn jk mo jo mp js mq mr ms mt bi translated"><a class="ae mk" href="https://github.com/buildpacks/pack" rel="noopener ugc nofollow" target="_blank"> pack-cli </a></li><li id="6808" class="ml mm hi iz b ja mu jd mv jg mw jk mx jo my js mq mr ms mt bi translated"><a class="ae mk" href="https://github.com/pivotal/kpack" rel="noopener ugc nofollow" target="_blank"> kpack </a></li></ul><p id="7688" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">组件:</strong></p><p id="7f61" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">build pack——是一种软件(OCI映像或自包含归档文件),它将应用程序源代码部分或全部转换为可运行的工件。</p><p id="7419" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">构建器——是一个软件(OCI映像),它利用生命周期来编排构建包，并将结果工件转换成OCI映像。</p><p id="b74a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">stack——是一种软件(OCI映像),提供在构建和发布阶段利用的构建和运行时环境。</p><p id="5d85" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">创建一个小堆栈:</strong></p><p id="e3cd" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们为java应用程序构建一个微小的run(distroles like)映像，以减小发行版映像的大小。paketo-buildpacks有多个栈，比如base、tiny和full，这取决于运行时所需的语言。</p><p id="10aa" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du lz ma mb mc b">build</code>基础映像由构建器在源代码编译期间使用。它可以包含更多编译源代码所需的包&amp;实用程序。<code class="du lz ma mb mc b">run</code>基础图像用于分发。我们不需要在<code class="du lz ma mb mc b">run</code>基础映像中打包构建时依赖项。这减少了最终图像的分布足迹。我们可以从paketo-buildpacks中获取一个现有的基础映像，并在它的基础上进行构建。或者我们可以基于<code class="du lz ma mb mc b">ubuntu:bionic</code>映像从头开始构建我们的基础、构建和运行映像。我们用后者吧。构建堆栈映像的完整源代码和脚本可以在，</p><blockquote class="lc ld le"><p id="3826" class="ix iy lf iz b ja jb ij jc jd je im jf lg jh ji jj lh jl jm jn li jp jq jr js hb bi translated"><a class="ae mk" href="https://github.com/srinivasa-vasu/cnb/tree/master/stacks" rel="noopener ugc nofollow" target="_blank">https://github.com/srinivasa-vasu/cnb/tree/master/stacks</a></p></blockquote><p id="4c1c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们来看看跑垒图像，</p><pre class="lk ll lm ln fd mz mc na nb aw nc bi"><span id="1668" class="kc kd hi mc b fi nd ne l nf ng">base_image=humourmind/cnb-base:${version}<br/>run_image=humourmind/cnb-run:${version}<br/><strong class="mc hj">run_base_image=gcr.io/distroless/base<br/></strong>build_image=humourmind/cnb-build:${version}<br/>stack_id="io.buildpacks.stacks.bionic"<br/>cnb_uid=1000<br/>cnb_gid=1000<br/>docker build -t "${base_image}" "$dir/base"<br/>docker build --build-arg "base_image=${base_image}" --build-arg "stack_id=${stack_id}" --build-arg "cnb_uid=${cnb_uid}" --build-arg "cnb_gid=${cnb_gid}" -t "${build_image}"  "$dir/build"<br/><strong class="mc hj">docker build --build-arg "base_image=${run_base_image}" --build-arg "stack_id=${stack_id}" --build-arg "cnb_uid=${cnb_uid}" --build-arg "cnb_gid=${cnb_gid}" -t "${run_image}" "$dir/run"</strong></span></pre><p id="dd8f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">它是用来自<strong class="iz hj">gcr.io/distroless/base.</strong>的发行版基础映像构建的。让我们看看docker构建文件，</p><pre class="lk ll lm ln fd mz mc na nb aw nc bi"><span id="4e9d" class="kc kd hi mc b fi nd ne l nf ng">FROM ${<em class="lf">base_image</em>} AS <em class="lf">tiny-source</em></span><span id="b753" class="kc kd hi mc b fi nh ne l nf ng">FROM ubuntu:bionic AS <em class="lf">builder<br/></em>COPY --from=<em class="lf">tiny-source </em>/ /tiny/<br/>RUN cp /bin/bash /tiny/bin/<br/><em class="lf">RUN cp /lib/x86_64-linux-gnu/libtinfo.so.5.9 /tiny/lib/x86_64-linux-gnu/<br/>RUN cp /lib/x86_64-linux-gnu/libtinfo.so.5 /tiny/lib/x86_64-linux-gnu/<br/>RUN cp /lib/x86_64-linux-gnu/libz.so.1 /tiny/lib/x86_64-linux-gnu/<br/>RUN cp /lib/x86_64-linux-gnu/libz.so.1.2.11 /tiny/lib/x86_64-linux-gnu/<br/>RUN cp /lib/x86_64-linux-gnu/libgcc_s.so.1 /tiny/lib/x86_64-linux-gnu/<br/>RUN cp /bin/cat /tiny/bin/<br/>RUN cp /usr/bin/nproc /tiny/usr/bin/<br/>RUN cp /usr/bin/tr /tiny/usr/bin/<br/></em>RUN echo "cnb:x:${<em class="lf">cnb_uid</em>}:${<em class="lf">cnb_gid</em>}:cnb:/home/cnb:/bin/bash" &gt;&gt; /tiny/etc/passwd \<br/>  &amp;&amp; echo "cnb:x:${<em class="lf">cnb_gid</em>}" &gt;&gt; /tiny/etc/group \<br/>  &amp;&amp; mkdir -p /tiny/home/cnb</span><span id="ac64" class="kc kd hi mc b fi nh ne l nf ng">FROM ${<em class="lf">base_image</em>}<br/>COPY --from=<em class="lf">builder </em>/tiny/ /<br/>ARG <em class="lf">stack_id<br/></em>USER ${<em class="lf">cnb_uid</em>}:${<em class="lf">cnb_gid</em>}<br/>LABEL io.buildpacks.stack.id="${<em class="lf">stack_id</em>}"</span></pre><p id="b263" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最终的发行版基础映像是用贡献的buildpack层所需的足够的实用程序/包制作的。这减小了最终分布图像的整体尺寸。这仍然是高度实验性的。</p><p id="b32b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">创建元构建包:</strong></p><p id="f60d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">java元构建包的完整源代码可以在，</p><blockquote class="lc ld le"><p id="0c4d" class="ix iy lf iz b ja jb ij jc jd je im jf lg jh ji jj lh jl jm jn li jp jq jr js hb bi translated"><a class="ae mk" href="https://github.com/srinivasa-vasu/paketo-buildpacks-java" rel="noopener ugc nofollow" target="_blank">https://github.com/srinivasa-vasu/paketo-buildpacks-java</a></p></blockquote><pre class="lk ll lm ln fd mz mc na nb aw nc bi"><span id="12b0" class="kc kd hi mc b fi nd ne l nf ng">api = "0.2"</span><span id="ca7f" class="kc kd hi mc b fi nh ne l nf ng">[buildpack]<br/>id       = "paketo-buildpacks/java"<br/>name     = "Paketo Java Buildpack"<br/>version  = "1.1.0"<br/>homepage = "https://github.com/srinivasa-vasu/paketo-buildpacks-java"</span><span id="1328" class="kc kd hi mc b fi nh ne l nf ng"># 1<br/>[[order]]<br/>[[order.group]]<br/>id = 'paketo-buildpacks/bellsoft-liberica'<br/>optional = true<br/>version = '2.3.1'</span><span id="2366" class="kc kd hi mc b fi nh ne l nf ng">[[order.group]]<br/>id = 'paketo-buildpacks/gradle'<br/>optional = true<br/>version = '1.1.1'</span><span id="9f7c" class="kc kd hi mc b fi nh ne l nf ng">[[order.group]]<br/>id = 'paketo-buildpacks/maven'<br/>optional = true<br/>version = '1.1.1'</span></pre><p id="2d5f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">java的定制元构建包是按照CNB规范定义的。<code class="du lz ma mb mc b">paketo-buildpacks/bellsoft-liberica</code>对JRE运行时层有贡献。以类似的方式，其他层相应地对最终的应用图像有所贡献。</p><p id="6957" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要打包此构建包进行分发，需要package.toml文件。按照规范，</p><pre class="lk ll lm ln fd mz mc na nb aw nc bi"><span id="bc2f" class="kc kd hi mc b fi nd ne l nf ng">[buildpack]<br/>uri = "./buildpacks/"</span><span id="6149" class="kc kd hi mc b fi nh ne l nf ng">dependencies = [<br/>  { image = "gcr.io/paketo-buildpacks/bellsoft-liberica:2.3.1" },<br/>  { image = "gcr.io/paketo-buildpacks/gradle:1.1.1" },<br/>  { image = "gcr.io/paketo-buildpacks/maven:1.1.1" },<br/>  { image = "gcr.io/paketo-buildpacks/sbt:1.1.1" },<br/>  { image = "gcr.io/paketo-buildpacks/executable-jar:1.2.1" },<br/>  { image = "gcr.io/paketo-buildpacks/apache-tomcat:1.1.1" },<br/>  { image = "gcr.io/paketo-buildpacks/dist-zip:1.2.1" },<br/>  { image = "gcr.io/paketo-buildpacks/procfile:1.3.1" },<br/>  { image = "gcr.io/paketo-buildpacks/azure-application-insights:1.1.1" },<br/>  { image = "gcr.io/paketo-buildpacks/debug:1.2.1" },<br/>  { image = "gcr.io/paketo-buildpacks/google-stackdriver:1.1.1" },<br/>  { image = "gcr.io/paketo-buildpacks/jmx:1.1.1" },<br/>  { image = "gcr.io/paketo-buildpacks/spring-boot:1.5.1" },<br/>  { image = "gcr.io/paketo-buildpacks/encrypt-at-rest:1.2.1" },<br/>  { image = "gcr.io/paketo-buildpacks/image-labels:1.0.1" }<br/>]</span></pre><p id="2f63" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这总结了元构建包的依赖性。每一个都是一个独立的buildpack发行版映像。使用pack-cli创建标准的OCI分布图，</p><blockquote class="lc ld le"><p id="312c" class="ix iy lf iz b ja jb ij jc jd je im jf lg jh ji jj lh jl jm jn li jp jq jr js hb bi translated">pack pack-build pack humourmind/paketo-build packs-Java:1 . 1 . 0-package-config package . toml-publish</p></blockquote><p id="c2b1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这将为元构建包创建构建包分发映像<code class="du lz ma mb mc b">humourmind/paketo-buildpacks-java:1.1.0</code>,并将其发布到注册表。</p><p id="b9ba" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">创建构建器:</strong></p><p id="2b5b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们利用前面创建的小堆栈和buildpack来构建我们自己的定制标准OCI构建器映像。完整的源代码可以在，</p><blockquote class="lc ld le"><p id="b485" class="ix iy lf iz b ja jb ij jc jd je im jf lg jh ji jj lh jl jm jn li jp jq jr js hb bi translated"><a class="ae mk" href="https://github.com/srinivasa-vasu/cnb/tree/master/paketo-buildpacks" rel="noopener ugc nofollow" target="_blank">https://github . com/srinivasa-vasu/cnb/tree/master/paketo-build packs</a></p></blockquote><p id="3056" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">按照规范，</p><pre class="lk ll lm ln fd mz mc na nb aw nc bi"><span id="7dab" class="kc kd hi mc b fi nd ne l nf ng">description = "Ubuntu bionic base image with paketo-buildpacks for Java"</span><span id="3f68" class="kc kd hi mc b fi nh ne l nf ng">[lifecycle]<br/>  version = "0.7.3"</span><span id="d7ad" class="kc kd hi mc b fi nh ne l nf ng">[[buildpacks]]<br/>  id = "paketo-buildpacks/java"<br/>  image = "humourmind/paketo-buildpacks-java@sha256:d1ed1afa05b2bffba43b3befb02a85496019032ba8694f3ad7f78e24079a7180"</span><span id="aee7" class="kc kd hi mc b fi nh ne l nf ng"># 1<br/>[[order]]<br/>group = [<br/>  { id = "paketo-buildpacks/bellsoft-liberica",          version="2.3.1", optional = true },<br/>  { id = "paketo-buildpacks/gradle",                     version="1.1.1", optional = true },<br/>  { id = "paketo-buildpacks/executable-jar",             version="1.2.1", optional = true },<br/>  { id = "paketo-buildpacks/apache-tomcat",              version="1.1.1", optional = true },<br/>  { id = "paketo-buildpacks/dist-zip",                   version="1.2.1", optional = true },<br/>  { id = "paketo-buildpacks/spring-boot",                version="1.5.1", optional = true }<br/>]</span><span id="fa88" class="kc kd hi mc b fi nh ne l nf ng"># 2<br/>[[order]]<br/>group = [<br/>  { id = "paketo-buildpacks/bellsoft-liberica",          version="2.3.1", optional = true },<br/>  { id = "paketo-buildpacks/maven",                      version="1.1.1", optional = true },<br/>  { id = "paketo-buildpacks/executable-jar",             version="1.2.1", optional = true },<br/>  { id = "paketo-buildpacks/apache-tomcat",              version="1.1.1", optional = true },<br/>  { id = "paketo-buildpacks/dist-zip",                   version="1.2.1", optional = true },<br/>  { id = "paketo-buildpacks/spring-boot",                version="1.5.1", optional = true }<br/>]</span><span id="bf6b" class="kc kd hi mc b fi nh ne l nf ng">[stack]<br/>  <em class="lf">id = "io.buildpacks.stacks.bionic"<br/>  build-image = "humourmind/cnb-build:tiny"<br/>  run-image = "humourmind/cnb-run:tiny"</em></span></pre><p id="4034" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这个构建器规范包含堆栈映像、生命周期，以将构建包产生的工件编排成OCI映像。定义的多个订单组参与决策周期，第一个匹配的订单将由生命周期层编排。整个构建生命周期都在先前创建的堆栈构建基础映像上运行。</p><p id="1622" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了建立OCI的形象，</p><blockquote class="lc ld le"><p id="a066" class="ix iy lf iz b ja jb ij jc jd je im jf lg jh ji jj lh jl jm jn li jp jq jr js hb bi translated">pack create-builder humourmind/paketo-Java-builder-tiny:0 . 7 . 3-builder-config builder . toml</p></blockquote><p id="67d3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这个构建器映像足以与pack-cli一起在本地机器上构建OCI应用程序映像。要在平台上使用它，需要定义和创建一个buildpackage分发层。使用同一个repo中打包的Dockerfile创建所需的分布层，并将其推送到注册中心。</p><p id="741c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要创建标准的OCI分发构建器映像，</p><blockquote class="lc ld le"><p id="dd8e" class="ix iy lf iz b ja jb ij jc jd je im jf lg jh ji jj lh jl jm jn li jp jq jr js hb bi translated">码头工人建造。-t humourmind/paketo-Java-builder-tiny:0 . 7 . 3-cn b-f docker file</p></blockquote><p id="88ff" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">并将其发布到注册表中。检查这个建造者来推理BOM和出处，</p><blockquote class="lc ld le"><p id="3b16" class="ix iy lf iz b ja jb ij jc jd je im jf lg jh ji jj lh jl jm jn li jp jq jr js hb bi translated">pack inspect-builder humour mind/paketo-Java-builder-tiny:0 . 7 . 3-cnb</p></blockquote><p id="c160" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">从源创建OCI应用程序映像:</strong></p><p id="823e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">与任何java项目一样，最好的起点是<a class="ae mk" href="https://start.spring.io" rel="noopener ugc nofollow" target="_blank"> start.spring.io </a>。让我们使用一个用Spring创建的示例应用程序。示例应用程序的源代码可以在，</p><blockquote class="lc ld le"><p id="f7fa" class="ix iy lf iz b ja jb ij jc jd je im jf lg jh ji jj lh jl jm jn li jp jq jr js hb bi translated"><a class="ae mk" href="https://github.com/srinivasa-vasu/spring-boot-k8s" rel="noopener ugc nofollow" target="_blank">https://github.com/srinivasa-vasu/spring-boot-k8s</a></p></blockquote><p id="aaac" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了利用定制构建器从源代码构建一个小的OCI图像，</p><pre class="lk ll lm ln fd mz mc na nb aw nc bi"><span id="520f" class="kc kd hi mc b fi nd ne l nf ng">pack build &lt;registry&gt;/&lt;repo&gt;/&lt;app_name&gt;:&lt;tag&gt; -B humourmind/paketo-java-builder-tiny@sha256:78d04ac5f05ee21a4bfd84d36573483fd04a2ac97c036db1ffd6065ef5e5e229</span></pre><p id="2d04" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这将创建最终的映像，它包含由适当的参与构建包贡献的层。使用<code class="du lz ma mb mc b">docker run</code>在本地测试这个应用。</p><p id="b7ef" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">将定制构建器重新定位到平台:</strong></p><p id="5109" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了在Kubernetes平台上测试这一点，可以利用开源的K8s本地<code class="du lz ma mb mc b">kpack</code>发行版或Tanzu build服务——它的商业发行版。我们用kpack吧。</p><p id="e025" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们为stack、store (buildpacks)和builder创建必要的k8s对象。完整的源代码可以在，</p><blockquote class="lc ld le"><p id="9f75" class="ix iy lf iz b ja jb ij jc jd je im jf lg jh ji jj lh jl jm jn li jp jq jr js hb bi translated"><a class="ae mk" href="https://github.com/srinivasa-vasu/cnb/tree/master/kpack/paketo" rel="noopener ugc nofollow" target="_blank">https://github . com/srinivasa-vasu/cnb/tree/master/k pack/pake to</a></p></blockquote><p id="4a52" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="lf">开店:</em></p><pre class="lk ll lm ln fd mz mc na nb aw nc bi"><span id="8913" class="kc kd hi mc b fi nd ne l nf ng">apiVersion: experimental.kpack.pivotal.io/v1alpha1<br/>kind: Store<br/>metadata:<br/>  name: paketocnb-java-store-tiny<br/>spec:<br/>  sources:<br/>  - image: humourmind/paketo-java-builder-tiny@sha256:78d04ac5f05ee21a4bfd84d36573483fd04a2ac97c036db1ffd6065ef5e5e229</span></pre><p id="8fc3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这创建了起作用的构建包层存储。Source提取前面创建的元构建包。</p><pre class="lk ll lm ln fd mz mc na nb aw nc bi"><span id="6136" class="kc kd hi mc b fi nd ne l nf ng"><strong class="mc hj">kubectl get store</strong></span><span id="f477" class="kc kd hi mc b fi nh ne l nf ng">NAME                        READY<br/>build-service-store         True<br/><strong class="mc hj">paketocnb-java-store-tiny   True</strong></span></pre><p id="e6e6" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="lf">创建堆栈:</em></p><pre class="lk ll lm ln fd mz mc na nb aw nc bi"><span id="e935" class="kc kd hi mc b fi nd ne l nf ng">apiVersion: experimental.kpack.pivotal.io/v1alpha1<br/>kind: Stack<br/>metadata:<br/>  name: paketocnb-java-stack-tiny<br/>spec:<br/>  id: "io.buildpacks.stacks.bionic"<br/>  buildImage:<br/>    image: "humourmind/cnb-build:tiny@sha256:17ed33b3cc4e926cd941fff3d375d01daef5887266c8e7eea5086a69b6d7d3d4"<br/>  runImage:<br/>    image: "humourmind/cnb-run:tiny@sha256:9e069f5c33818c2ddec99d16c7501a9775f005e5cb69072f8dc618d6120f5d46"</span></pre><p id="14d7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这将创建一个堆栈，该堆栈有助于使用之前创建的自定义堆栈来构建和运行基础映像。</p><pre class="lk ll lm ln fd mz mc na nb aw nc bi"><span id="6c1e" class="kc kd hi mc b fi nd ne l nf ng"><strong class="mc hj">kubectl get stack</strong></span><span id="7cd7" class="kc kd hi mc b fi nh ne l nf ng">NAME                        READY<br/>build-service-stack         True<br/><strong class="mc hj">paketocnb-java-stack-tiny   True</strong></span></pre><p id="6c6e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="lf">创建构建器:</em></p><pre class="lk ll lm ln fd mz mc na nb aw nc bi"><span id="4113" class="kc kd hi mc b fi nd ne l nf ng">apiVersion: experimental.kpack.pivotal.io/v1alpha1<br/>kind: CustomClusterBuilder<br/>metadata:<br/>  name: paketocnb-java-builder-tiny<br/>spec:<br/>  # to relocate the builder image<br/>  tag: &lt;registry&gt;/&lt;repo&gt;/&lt;builder&gt;:&lt;tag&gt;<br/>  stack: paketocnb-java-stack-tiny<br/>  store: paketocnb-java-store-tiny<br/>  order:<br/>  - group:<br/>    - id: paketo-buildpacks/bellsoft-liberica<br/>    - id: paketo-buildpacks/gradle<br/>    - id: paketo-buildpacks/executable-jar<br/>    - id: paketo-buildpacks/apache-tomcat<br/>    - id: paketo-buildpacks/dist-zip<br/>    - id: paketo-buildpacks/spring-boot<br/>  - group:<br/>    - id: paketo-buildpacks/bellsoft-liberica<br/>    - id: paketo-buildpacks/maven<br/>    - id: paketo-buildpacks/executable-jar<br/>    - id: paketo-buildpacks/apache-tomcat<br/>    - id: paketo-buildpacks/dist-zip<br/>    - id: paketo-buildpacks/spring-boot</span></pre><p id="bf56" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这就创建了利用存储和堆栈的定制构建器。</p><pre class="lk ll lm ln fd mz mc na nb aw nc bi"><span id="bf4c" class="kc kd hi mc b fi nd ne l nf ng"><strong class="mc hj">kubectl get CustomClusterBuilder</strong></span><span id="5dc4" class="kc kd hi mc b fi nh ne l nf ng">NAME                          LATESTIMAGE                                                                                                                                             READY<br/>default                       &lt;registry&gt;/&lt;repo&gt;/build-service/default-builder@sha256:9e97c76d205b3f78cecb3753f5039a2ac5af7a31ba681ae9d48be0cc68d35fe6                     True<br/><strong class="mc hj">paketocnb-java-builder-tiny   &lt;registry&gt;/&lt;repo&gt;/&lt;builder&gt;:&lt;tag&gt;   True</strong></span></pre><p id="ae2e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">按照kpack文档为容器注册中心创建适当的secret和service-account对象。</p><p id="d21f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="lf">创建图像规格:</em></p><pre class="lk ll lm ln fd mz mc na nb aw nc bi"><span id="fcd7" class="kc kd hi mc b fi nd ne l nf ng">apiVersion: build.pivotal.io/v1alpha1<br/>kind: Image<br/>metadata:<br/>  name: k8s-sb-image<br/>spec:<br/>  tag: &lt;registry&gt;/&lt;repo&gt;/&lt;app&gt;:&lt;tag&gt;<br/>  serviceAccount: &lt;sa&gt;<br/><strong class="mc hj">  builder:<br/>    name: paketocnb-java-builder-tiny<br/>    kind: CustomClusterBuilder<br/></strong>    cacheSize: "8Gi"<br/>  source:<br/>    git:<br/><strong class="mc hj">      url: https://github.com/srinivasa-vasu/spring-boot-k8s.git<br/></strong>      revision: master</span></pre><p id="e878" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这将触发利用paketo定制构建器从源代码创建最终的标准OCI映像。</p><pre class="lk ll lm ln fd mz mc na nb aw nc bi"><span id="3d46" class="kc kd hi mc b fi nd ne l nf ng">default/i-oud-native-v1-0-cfebbe85ecce1517a1e4dab2a1b8f537075-build-pod[prepare]: prepare:fetch.go:88: Successfully cloned "<a class="ae mk" href="https://github.com/srinivasa-vasu/spring-boot-k8s.git" rel="noopener ugc nofollow" target="_blank">https://github.com/srinivasa-vasu/spring-boot-k8s.git</a>" @ "8f63422d11859fa11a3c832ba5a7c07685b96f57" in path "/workspace"<br/>default/i-oud-native-v1-0-cfebbe85ecce1517a1e4dab2a1b8f537075-build-pod[analyze]: Restoring metadata for "paketo-buildpacks/bellsoft-liberica:jvmkill" from app image<br/>default/i-oud-native-v1-0-cfebbe85ecce1517a1e4dab2a1b8f537075-build-pod[analyze]: Restoring metadata for "paketo-buildpacks/bellsoft-liberica:link-local-dns" from app image<br/>default/i-oud-native-v1-0-cfebbe85ecce1517a1e4dab2a1b8f537075-build-pod[analyze]: Restoring metadata for "paketo-buildpacks/bellsoft-liberica:memory-calculator" from app image<br/>default/i-oud-native-v1-0-cfebbe85ecce1517a1e4dab2a1b8f537075-build-pod[analyze]: Restoring metadata for "paketo-buildpacks/bellsoft-liberica:security-providers-configurer" from app image<br/>default/i-oud-native-v1-0-cfebbe85ecce1517a1e4dab2a1b8f537075-build-pod[analyze]: Restoring metadata for "paketo-buildpacks/bellsoft-liberica:class-counter" from app image<br/>default/i-oud-native-v1-0-cfebbe85ecce1517a1e4dab2a1b8f537075-build-pod[analyze]: Restoring metadata for "paketo-buildpacks/bellsoft-liberica:java-security-properties" from app image<br/>default/i-oud-native-v1-0-cfebbe85ecce1517a1e4dab2a1b8f537075-build-pod[analyze]: Restoring metadata for "paketo-buildpacks/bellsoft-liberica:jre" from app image<br/>default/i-oud-native-v1-0-cfebbe85ecce1517a1e4dab2a1b8f537075-build-pod[analyze]: Restoring metadata for "paketo-buildpacks/bellsoft-liberica:jdk" from cache<br/>default/i-oud-native-v1-0-cfebbe85ecce1517a1e4dab2a1b8f537075-build-pod[analyze]: Restoring metadata for "paketo-buildpacks/maven:application" from cache<br/>default/i-oud-native-v1-0-cfebbe85ecce1517a1e4dab2a1b8f537075-build-pod[analyze]: Restoring metadata for "paketo-buildpacks/maven:cache" from cache<br/>default/i-oud-native-v1-0-cfebbe85ecce1517a1e4dab2a1b8f537075-build-pod[analyze]: Restoring metadata for "paketo-buildpacks/maven:maven" from cache<br/>default/i-oud-native-v1-0-cfebbe85ecce1517a1e4dab2a1b8f537075-build-pod[analyze]: Restoring metadata for "paketo-buildpacks/executable-jar:class-path" from app image<br/>default/i-oud-native-v1-0-cfebbe85ecce1517a1e4dab2a1b8f537075-build-pod[build]:<br/>default/i-oud-native-v1-0-cfebbe85ecce1517a1e4dab2a1b8f537075-build-pod[build]: Paketo BellSoft Liberica Buildpack 2.3.1<br/>default/i-oud-native-v1-0-cfebbe85ecce1517a1e4dab2a1b8f537075-build-pod[build]:     Set $BP_JAVA_VERSION to configure the Java version. Default 11.*.<br/>default/i-oud-native-v1-0-cfebbe85ecce1517a1e4dab2a1b8f537075-build-pod[build]:     Set $BPL_HEAD_ROOM to configure the headroom in memory calculation. Default 0.<br/>default/i-oud-native-v1-0-cfebbe85ecce1517a1e4dab2a1b8f537075-build-pod[build]:     Set $BPL_LOADED_CLASS_COUNT to configure the number of loaded classes in memory calculation. Default 35% of classes.<br/>default/i-oud-native-v1-0-cfebbe85ecce1517a1e4dab2a1b8f537075-build-pod[build]:     Set $BPL_THREAD_COUNT to configure the number of threads in memory calculation. Default 250.<br/>default/i-oud-native-v1-0-cfebbe85ecce1517a1e4dab2a1b8f537075-build-pod[build]:   BellSoft Liberica JDK 11.0.7: Reusing cached layer<br/>default/i-oud-native-v1-0-cfebbe85ecce1517a1e4dab2a1b8f537075-build-pod[build]:   BellSoft Liberica JRE 11.0.7: Reusing cached layer<br/>default/i-oud-native-v1-0-cfebbe85ecce1517a1e4dab2a1b8f537075-build-pod[build]:   JVMKill Agent 1.16.0: Reusing cached layer<br/>default/i-oud-native-v1-0-cfebbe85ecce1517a1e4dab2a1b8f537075-build-pod[build]:   Link-Local DNS: Reusing cached layer<br/>default/i-oud-native-v1-0-cfebbe85ecce1517a1e4dab2a1b8f537075-build-pod[build]:   Memory Calculator 4.0.0: Reusing cached layer<br/>default/i-oud-native-v1-0-cfebbe85ecce1517a1e4dab2a1b8f537075-build-pod[build]:   Class Counter: Reusing cached layer<br/>default/i-oud-native-v1-0-cfebbe85ecce1517a1e4dab2a1b8f537075-build-pod[build]:   Java Security Properties: Reusing cached layer<br/>default/i-oud-native-v1-0-cfebbe85ecce1517a1e4dab2a1b8f537075-build-pod[build]:   Security Providers Configurer: Reusing cached layer<br/>default/i-oud-native-v1-0-cfebbe85ecce1517a1e4dab2a1b8f537075-build-pod[build]:<br/>default/i-oud-native-v1-0-cfebbe85ecce1517a1e4dab2a1b8f537075-build-pod[build]: Paketo Maven Buildpack 1.1.1</span></pre><p id="22c2" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最后，在成功完成后，它将标准OCI映像推送到注册中心。</p><pre class="lk ll lm ln fd mz mc na nb aw nc bi"><span id="6c9f" class="kc kd hi mc b fi nd ne l nf ng">export Reusing layer 'paketo-buildpacks/bellsoft-liberica:security-providers-configurer'                                                                                                                                                 │<br/>│ export Adding layer 'paketo-buildpacks/executable-jar:class-path'                                                                                                                                                                        │<br/>│ export Adding 1/1 app layer(s)                                                                                                                                                                                                           │<br/>│ export Adding layer 'config'                                                                                                                                                                                                             │<br/>│ export *** Images (sha256:00e39d0a1cbda2a10f68a84b2f6f49ae68a5ba23733908bf614c5ea1a09338c1):                                                                                                                                             │<br/>│ export       &lt;registry&gt;/&lt;repo&gt;/spring-kloud-native:v1.0                                                                                                                                                                      │<br/>│ export       &lt;registry&gt;/&lt;repo&gt;/spring-kloud-native:v1.0-b4.20200428.110405</span></pre></div><div class="ab cl md me gp mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="hb hc hd he hf"><blockquote class="lc ld le"><p id="2298" class="ix iy lf iz b ja jb ij jc jd je im jf lg jh ji jj lh jl jm jn li jp jq jr js hb bi translated"><strong class="iz hj">参考资料:</strong><br/><strong class="iz hj">CNB</strong><br/>https://buildpacks.io/<br/><strong class="iz hj">paketo-build packs</strong><br/>https://paketo.io/<br/><strong class="iz hj">k pack</strong><br/>https://github.com/pivotal/kpack<br/><strong class="iz hj">pack-CLI</strong><br/>https://github.com/buildpacks/pack<br/><strong class="iz hj">来源</strong><br/>https://github.com/srinivasa-vasu/cnb<br/>https://github.com/srinivasa-vasu/paketo-buildpacks-java<br/>https://github.com/srinivasa-vasu/cnb/tree/master/stacks<br/>https://github . com/srinivasa-vasu</p></blockquote></div></div>    
</body>
</html>