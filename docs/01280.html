<html>
<head>
<title>Structuring Tensorflow Object Detection Project</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">构建Tensorflow对象检测项目</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/structuring-tensorflow-object-detection-project-590c9177d9e7?source=collection_archive---------14-----------------------#2021-04-04">https://medium.com/geekculture/structuring-tensorflow-object-detection-project-590c9177d9e7?source=collection_archive---------14-----------------------#2021-04-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="2d1d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇博客中，我将带您了解如何使用TensorFlow对象检测API高效地构建对象检测项目</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/28a827bff1e160256668b32fa6ddb538.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZeDQGWRoERxO9dW9Sqgc_w.jpeg"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Image credits: <a class="jt ju ge" href="https://medium.com/u/b1d410cb9700?source=post_page-----590c9177d9e7--------------------------------" rel="noopener" target="_blank">TensorFlow</a> team</figcaption></figure><p id="cc55" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">每一个曾经使用TensorFlow并遇到对象检测作为任务的数据科学家或机器学习工程师都经历过TensorFlow对象检测(TF-OD) API。这是一个建立在TensorFlow基础上的强大框架，可以轻松构建、训练和部署检测模型。</p><p id="015b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">老实说，我在不同的时间为不同的项目使用过TF-OD，但每次我都必须从头开始，然后要记住大量的配置，这使得这个过程非常漫长。</p><p id="6fbe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们通过设置来简化流程:</p><p id="d650" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第一步:准备Anaconda环境</strong></p><pre class="je jf jg jh fd jv jw jx jy aw jz bi"><span id="83f6" class="ka kb hi jw b fi kc kd l ke kf"># create new environment<br/>&gt;&gt; conda create --name object_detection_env python=3.6<br/><br/># activate your environment before installation or running your scripts <br/>&gt;&gt; conda activate object_detection_env</span><span id="a1ac" class="ka kb hi jw b fi kg kd l ke kf"># Installing tensorflow<br/>&gt;&gt; conda install tensorflow==2.3.0 tensorflow-gpu==2.3.0<br/><br/># installing cudatoolkit and cudnn<br/>&gt;&gt; conda install cudatoolkit==10.1.243=h74a9793_0 <br/>&gt;&gt; conda install cudnn==7.6.5=cuda10.1_0</span></pre><p id="a23e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤2:安装对象检测API框架</strong>及其依赖关系:</p><pre class="je jf jg jh fd jv jw jx jy aw jz bi"><span id="ec21" class="ka kb hi jw b fi kc kd l ke kf"># Cloning the repository<br/>&gt;&gt; git clone <a class="ae kh" href="https://github.com/tensorflow/models.git" rel="noopener ugc nofollow" target="_blank">https://github.com/tensorflow/models.git</a> </span></pre><p id="0ac5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过键入<code class="du ki kj kk jw b">protoc --version</code>确保你有<a class="ae kh" href="https://grpc.io/docs/protoc-installation/#install-using-a-package-manager" rel="noopener ugc nofollow" target="_blank"> protobuf编译器</a>版本&gt; = 3.0，或者通过键入<code class="du ki kj kk jw b">apt install protobuf-compiler</code>将其安装在Ubuntu上。<br/>然后按如下方式继续安装python包:</p><pre class="je jf jg jh fd jv jw jx jy aw jz bi"><span id="af81" class="ka kb hi jw b fi kc kd l ke kf"># remember to activate your python environment first<br/>&gt;&gt; cd models/research</span><span id="4ffa" class="ka kb hi jw b fi kg kd l ke kf"># compile protos:<br/>&gt;&gt; protoc object_detection/protos/*.proto --python_out=.</span><span id="5291" class="ka kb hi jw b fi kg kd l ke kf"># Install TensorFlow Object Detection API as a python package:<br/>&gt;&gt; cp object_detection/packages/tf2/setup.py .<br/>&gt;&gt; python -m pip install .</span><span id="bfed" class="ka kb hi jw b fi kg kd l ke kf"># Test the installation (If all installed then following will show all passed output)<br/>&gt;&gt; python object_detection/builders/model_builder_tf2_test.py</span><span id="4ca6" class="ka kb hi jw b fi kg kd l ke kf"># install OpenCV python package<br/>&gt;&gt; pip install opencv-python<br/>&gt;&gt; pip install opencv-contrib-python</span></pre><p id="7054" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第三步:文件夹结构:</strong>使用TFOD API的一种有效的文件夹结构方式是什么？下面是文件夹[1]，它将帮助你得到一个大致相同的概念。</p><pre class="je jf jg jh fd jv jw jx jy aw jz bi"><span id="1f4a" class="ka kb hi jw b fi kc kd l ke kf">training_demo/<br/>├─ annotations/<br/>├─ exported-models/<br/>├─ images/<br/>│  ├─ test/<br/>│  └─ train/<br/>├─ models/<br/>│  └─ <!-- -->my_ssd_mobilenet_v2<!-- -->/<br/>│      ├─ checkpoint/<br/>│      ├─ saved_model/<br/>│      └─ pipeline.config<br/>├─ pre-trained-models/<br/>│  ├─ ssd_resnet50_v1_fpn_640x640_coco17_tpu-8/<br/>│  │   ├─ checkpoint/<br/>│  │   ├─ saved_model/<br/>│  │   └─ pipeline.config<br/>│  └─ efficientdet_d1_coco17_tpu-32/<br/>│      ├─ checkpoint/<br/>│      ├─ saved_model/<br/>│      └─ pipeline.config</span></pre><p id="e55a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤4:准备用于训练的自定义数据集</strong>:<br/>创建pbtxt文件(这是目标标签的对象检测API所需要的)(<a class="ae kh" href="https://gist.github.com/maheshwariumang/d75f7e52e1996bb553da889eebe5088f#file-xml_to_csv-py" rel="noopener ugc nofollow" target="_blank">代码链接</a> ) <br/> <code class="du ki kj kk jw b">&gt;&gt; python generate_pbtxt.py csv train_labels.csv label_map.pbtxt</code> <br/>将训练图像添加到训练和测试图像文件夹，并运行<a class="ae kh" href="https://gist.github.com/maheshwariumang/d75f7e52e1996bb553da889eebe5088f#file-xml_to_csv-py" rel="noopener ugc nofollow" target="_blank">代码</a>来创建数据集CSV，它将包含文件名、边界框和目标<br/> <code class="du ki kj kk jw b">python xml_to_csv.py</code> <br/>。是时候创建TFRecord文件了:<br/> <code class="du ki kj kk jw b">&gt;&gt; python generate_tfreccords.py train_labels.csv annotations/label_map.pbtxt train train_tf_record.record</code></p><p id="0cab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du ki kj kk jw b">&gt;&gt; python generate_tfreccords.py test_labels.csv annotations/label_map.pbtxt test test_tf_record.record</code></p><p id="d9ac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤5:下载预先训练的模型权重</strong> : <br/>我们将使用带有MobileNetV2主干的SSD模型，因为它是用于演示目的的小型模型。你可以在<a class="ae kh" href="https://github.com/tensorflow/models/blob/master/research/object_detection/g3doc/tf2_detection_zoo.md" rel="noopener ugc nofollow" target="_blank">模型动物园</a>【2】中用COCO数据集检查另一个预训练模型。(如步骤3所示，您将把预训练模型保存在<em class="kl">预训练模型</em>文件夹下。</p><pre class="je jf jg jh fd jv jw jx jy aw jz bi"><span id="a76c" class="ka kb hi jw b fi kc kd l ke kf"># download the mobilenet_v2 model<br/>wget <a class="ae kh" href="http://download.tensorflow.org/models/object_detection/tf2/20200711/ssd_mobilenet_v2_320x320_coco17_tpu-8.tar.gz" rel="noopener ugc nofollow" target="_blank">http://download.tensorflow.org/models/object_detection/tf2/20200711/ssd_mobilenet_v2_320x320_coco17_tpu-8.tar.gz</a><br/># extract the downloaded file<br/>tar -xzvf ssd_mobilenet_v2_320x320_coco17_tpu-8.tar.gz<!-- --> </span></pre><p id="50aa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤6:配置管道配置:<br/> </strong>下载重量和配置文件后，您可以调整pipeline.config参数:</p><ul class=""><li id="da64" class="km kn hi ih b ii ij im in iq ko iu kp iy kq jc kr ks kt ku bi translated">使用<code class="du ki kj kk jw b">num_classes: 3</code>因为我们只有三个类(苹果、橘子、香蕉)，而不是coco数据集中的90个类。</li><li id="e58d" class="km kn hi ih b ii kv im kw iq kx iu ky iy kz jc kr ks kt ku bi translated">将<code class="du ki kj kk jw b">fine_tune_checkpoint_type: "classification"</code>更改为<code class="du ki kj kk jw b">fine_tune_checkpoint_type: "detection"</code>，因为我们使用预训练的检测模型作为初始化。</li><li id="b9a3" class="km kn hi ih b ii kv im kw iq kx iu ky iy kz jc kr ks kt ku bi translated">添加了预先训练好的模型在野外的路径，<code class="du ki kj kk jw b">fine_tune_checkpoint:</code>比如使用移动网v2模型，我添加了<code class="du ki kj kk jw b">fine_tune_checkpoint: "./models/ssd_mobilenet_v2_320x320_coco17_tpu-8/checkpoint/ckpt-0"</code></li><li id="205f" class="km kn hi ih b ii kv im kw iq kx iu ky iy kz jc kr ks kt ku bi translated">改了<code class="du ki kj kk jw b">batch_size: 512</code>，给我的GPU内存用了一个合理的数字。我有4GB的GPU内存，所以我用的是<code class="du ki kj kk jw b">batch_size: 8</code></li><li id="6551" class="km kn hi ih b ii kv im kw iq kx iu ky iy kz jc kr ks kt ku bi translated">在<code class="du ki kj kk jw b">num_steps:</code>中增加了最大训练迭代次数，在<code class="du ki kj kk jw b">total_steps:</code>中也使用了相同的次数</li><li id="43cc" class="km kn hi ih b ii kv im kw iq kx iu ky iy kz jc kr ks kt ku bi translated">根据我们的模型和批量调整学习率(最初他们使用更高的学习率，因为他们有更大的批量)。这个值需要一些测试和调整。</li><li id="060a" class="km kn hi ih b ii kv im kw iq kx iu ky iy kz jc kr ks kt ku bi translated"><code class="du ki kj kk jw b">label_map_path:</code>应该指向我们的标签映射文件(这里是浣熊标签映射)<code class="du ki kj kk jw b">label_map_path: "./annotations/labelmap.pbtxt"</code></li><li id="9137" class="km kn hi ih b ii kv im kw iq kx iu ky iy kz jc kr ks kt ku bi translated">您需要将<code class="du ki kj kk jw b">tf_record_input_reader</code>设置在<code class="du ki kj kk jw b">train_input_reader</code>和<code class="du ki kj kk jw b">eval_input_reader</code>下。这应该指向我们生成的TFRecord(一个用于训练，一个用于验证)。</li></ul><pre class="je jf jg jh fd jv jw jx jy aw jz bi"><span id="b4d4" class="ka kb hi jw b fi kc kd l ke kf">train_input_reader: {<br/>    label_map_path: "./annotations/labelmap.pbtxt"<br/>    tf_record_input_reader {<br/>        input_path: "../annotations/train.record"<br/>    }<br/>}</span></pre><p id="7964" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第七步:训练模型:<br/> </strong>现在是模型的训练和自定义数据集上的训练。您可以将文件<code class="du ki kj kk jw b">model_main_tf2.py</code>(从<a class="ae kh" href="https://github.com/tensorflow/models/tree/master/research/object_detection" rel="noopener ugc nofollow" target="_blank">链接</a>中)复制到<em class="kl"> training_demo </em>文件夹中</p><pre class="je jf jg jh fd jv jw jx jy aw jz bi"><span id="8481" class="ka kb hi jw b fi kc kd l ke kf">python model_main_tf2.py --model_dir=models/my_ssd_mobilenet_v2 \ <br/> -- pipeline_config_path=models/my_ssd_mobilenet_v2/pipeline.config \<br/> --alsologtostderr</span></pre><p id="1045" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第八步:检查训练进度:<br/> </strong>现在为了检查模型的进度。<br/> <code class="du ki kj kk jw b">&gt;&gt; tensorboard --logdir=models/my_ssd_mobilenet_v2</code> <br/>这将在您的浏览器上打开<code class="du ki kj kk jw b"><a class="ae kh" href="http://localhost:6006/" rel="noopener ugc nofollow" target="_blank">http://localhost:6006/</a></code>，出现如下仪表板:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es la"><img src="../Images/9c35776f1650bf53b1805ceaa888805f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pqYsV2t1PA1j3-ufJrBUhA.png"/></div></div></figure><p id="044f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第九步:导出训练好的模型:</strong></p><pre class="je jf jg jh fd jv jw jx jy aw jz bi"><span id="1260" class="ka kb hi jw b fi kc kd l ke kf">python exporter_main_v2.py --input_type="image_tensor" \<br/>                           --output_directory=streamlit_ui/exported_model \<br/>                           --pipeline_config_path=models/my_ssd_mobilenet_v2/pipeline.config \<br/>                           --trained_checkpoint_dir=models/my_ssd_mobilenet_v2/</span></pre><p id="1912" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">恭喜你，你已经训练出了你的第一个模型。既然您已经创建了一个项目结构，您可以很容易地遵循不同的模型。这里最好的部分是什么？你不会弄乱预先训练的文件和你训练的文件。</p><p id="5ea3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请让我知道对这篇文章的任何反馈。我很乐意听到他们的声音，并不断改进。</p><p id="7bbc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="kl">参考文献— <br/> </em> </strong> <em class="kl"> 1。</em><strong class="ih hj"><em class="kl"/></strong><a class="ae kh" href="https://tensorflow-object-detection-api-tutorial.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank"><em class="kl">https://tensor flow-object-detection-API-tutorial . readthedocs . io/en/latest/</em></a><em class="kl"><br/>2 .</em><a class="ae kh" href="https://github.com/tensorflow/models/tree/master/research/object_detection" rel="noopener ugc nofollow" target="_blank"><em class="kl">https://github . com/tensor flow/models/tree/master/research/object _ detection</em></a><em class="kl"><br/>3 .</em><a class="ae kh" href="https://github.com/tensorflow/models" rel="noopener ugc nofollow" target="_blank">https://github.com/tensorflow/models</a></p></div></div>    
</body>
</html>