<html>
<head>
<title>Bitwise Implementation on .Net 6</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">上的按位实现。网络6</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/bitwise-implementation-on-net-6-7704265fd40f?source=collection_archive---------2-----------------------#2022-06-06">https://medium.com/geekculture/bitwise-implementation-on-net-6-7704265fd40f?source=collection_archive---------2-----------------------#2022-06-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/24f89ee9ab18b802aac2775d502881fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fLCEZx6ZdeiakZ4SYATcbA.jpeg"/></div></div></figure><p id="83a3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">大家好，今天我们将讨论按位运算符和运算在现实生活中的优缺点。</p><p id="f9d9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">场景:</strong>我们将向经销商发送活动消息。而且这些经销商下面有很多用户。我们将尽力记录谁读了这条信息，谁没读。</p><h1 id="f723" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated"><span class="l km kn ko bm kp kq kr ks kt di"> C </span> lassic道</h1><p id="1d3d" class="pw-post-body-paragraph iq ir hi is b it ku iv iw ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn hb bi translated">这些是MsSqlDB表:“经销商”、“消息”关系表“用户消息”，当然还有“用户”表。</p><figure class="la lb lc ld fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kz"><img src="../Images/e67ee256f66baf5ec2e517141df69fed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hn1mH368xj_rdV_Wm-ElkQ.png"/></div></div><figcaption class="le lf et er es lg lh bd b be z dx">BitwiseDB’s Tables Schema</figcaption></figure><p id="bea8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在经典的方法中，我们在“UserMessage”表中保存谁读取了消息数据，该表被绿色矩形包围，如下所示。</p><figure class="la lb lc ld fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es li"><img src="../Images/bde2be73764e050c8878e7c4c8882ff5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sEp_RIM458cnWD7bXITfyA.png"/></div></div></figure><p id="3c0b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi lj translated"><span class="l km kn ko bm kp kq kr ks kt di"> 1 </span> <strong class="is hj"> -) </strong>让我们一起创造。Net 6.0 Web Api项目“BitwiseDealers”。并将DB类库项目添加到解决方案中。</p><figure class="la lb lc ld fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lk"><img src="../Images/75de3292e41710a72fee08c2411c7595.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Nm0wLKZdAZbSRiQN_QcLnw.png"/></div></div><figcaption class="le lf et er es lg lh bd b be z dx">Visual Studio 2022 .Net Project Template</figcaption></figure><p id="7a87" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi lj translated"><span class="l km kn ko bm kp kq kr ks kt di"> A </span>使用Nuget将下面的库添加到DB项目中。</p><figure class="la lb lc ld fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ll"><img src="../Images/a3853c7bf61e9098ee133122935188da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lY-nsDGBneroL6h6Th0BBw.png"/></div></div></figure><p id="7e97" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi lj translated">创建实体和数据库上下文</p><p id="76e3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">数据库已经存在，因此我们将在此解决方案中首先使用数据库。打开终端，用“<strong class="is hj"> <em class="lm"> cd DB </em> </strong>”命令移动到DB文件夹。下面我们称之为“<strong class="is hj">脚手架</strong>命令。所以我们会自动创建实体和BitwiseContext。</p><pre class="la lb lc ld fd ln lo lp lq aw lr bi"><span id="f26c" class="ls jp hi lo b fi lt lu l lv lw">dotnet ef dbcontext scaffold "Server=.;Database=BitwiseDB;Trusted_Connection=True;"<br/>Microsoft.EntityFrameworkCore.SqlServer -o Entities --context-dir "Entities\DbContexts"<br/>--no-pluralize -c BitwiseContext -f</span></pre><figure class="la lb lc ld fd ij er es paragraph-image"><div class="er es lx"><img src="../Images/030a95e4e8f0aaf8d6c21dca10caa3e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:812/format:webp/1*1IEvSQLylr2l5vzIwTbd1A.png"/></div><figcaption class="le lf et er es lg lh bd b be z dx">This is new DB Layer</figcaption></figure><p id="e701" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">bitwise dealers/appsettings.json:</strong>我们为WebApi服务在appsettings . JSON中添加了DB连接设置。</p><p id="b712" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> * </strong> <em class="lm">不要忘记加密发布版本的所有配置文本。</em></p><pre class="la lb lc ld fd ln lo lp lq aw lr bi"><span id="54b4" class="ls jp hi lo b fi lt lu l lv lw">"ConnectionStrings": {<br/>  "DefaultConnection": "Data Source=.;initial catalog=BitwiseDB;Trusted_Connection=True;"<br/>}</span></pre><p id="a870" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi lj translated"><span class="l km kn ko bm kp kq kr ks kt di"> 2 </span> <strong class="is hj"> -) </strong>创建服务层:创建“BitwiseService”类库项目。</p><p id="9c6c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">BitwiseService/iuser service:</strong>我们会得到，阅读具体消息的用户列表。</p><pre class="la lb lc ld fd ln lo lp lq aw lr bi"><span id="e736" class="ls jp hi lo b fi lt lu l lv lw">using Core.Model;<br/>using System;<br/>using System.Collections.Generic;<br/>using System.Linq;<br/>using System.Text;<br/>using System.Threading.Tasks;</span><span id="f994" class="ls jp hi lo b fi ly lu l lv lw">namespace BitwiseService<br/>{<br/>   public interface IUserService<br/>   { <br/>       List&lt;UserMessageViewModel&gt; GetUserListByMessageID(int messageID);<br/>   }<br/>}</span></pre><p id="1c24" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">BitwiseService/UserService:</strong>我们将从这个<em class="lm">GetUserListByMessageID()</em>方法中返回自定义的“<strong class="is hj"><em class="lm">UserMessageViewModel</em></strong>”。我们将获得用户全名，交易名称和读取状态。并将其返回给控制器。</p><pre class="la lb lc ld fd ln lo lp lq aw lr bi"><span id="6898" class="ls jp hi lo b fi lt lu l lv lw">using Core.Model;<br/>using DB.Entities;<br/>using DB.Entities.DbContexts;<br/>using System.Linq;</span><span id="8416" class="ls jp hi lo b fi ly lu l lv lw">namespace BitwiseService<br/>{<br/>   public class UserService : IUserService<br/>   {<br/>      BitwiseContext _context; <br/>      public UserService(BitwiseContext context)<br/>      {<br/>         _context = context;<br/>      }<br/>      <br/>      public List&lt;UserMessageViewModel&gt; GetUserListByMessageID(int messageID)<br/>      {<br/>         var data = (from um in _context.UserMessage<br/>         join u in _context.User on um.UserId equals u.Id into us<br/>         from u in us.DefaultIfEmpty()<br/>         <br/>         join d in _context.Dealar on <br/>                         um.DealerId equals d.Id into de<br/>         from d in de.DefaultIfEmpty()<br/>         <br/>         join m in _context.Message on <br/>                         um.MessageId equals m.Id into me<br/>         from m in me.DefaultIfEmpty()<br/>         <br/>         where um.MessageId == messageID<br/>         select new UserMessageViewModel<br/>         {<br/>            UserName = u.Name,<br/>            UserSurname = u.Surname,<br/>            DealerName = d.Name,Message = m.Text,<br/>            IsRead = (bool)um.IsRead<br/>         }).ToList();<br/>return data.Count &gt; 0 ? data : new List&lt;UserMessageViewModel&gt;();<br/>      }<br/>   }<br/>}</span></pre><p id="7752" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> Program.cs: </strong>不要忘记将userService添加到Program.cs中，如下所示。</p><pre class="la lb lc ld fd ln lo lp lq aw lr bi"><span id="390b" class="ls jp hi lo b fi lt lu l lv lw">builder.Services.AddTransient&lt;IUserService, UserService&gt;();</span></pre><p id="48d0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi lj translated"><span class="l km kn ko bm kp kq kr ks kt di"> 3 </span> <strong class="is hj"> -) </strong>创建核心类库项目并添加模型文件夹。</p><p id="6110" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">Core/Model/UserMessageViewModel</strong>:这是自定义的UserMessageViewModel</p><pre class="la lb lc ld fd ln lo lp lq aw lr bi"><span id="9380" class="ls jp hi lo b fi lt lu l lv lw">namespace Core.Model<br/>{<br/>   public class UserMessageViewModel<br/>   {<br/>      public string UserName { get; set; }<br/>      public string UserSurname { get; set; }<br/>      public string Message { get; set; }<br/>      public bool IsRead { get; set; }<br/>      public string DealerName { get; set; }<br/>   }<br/>}</span></pre><p id="0735" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi lj translated"><span class="l km kn ko bm kp kq kr ks kt di">4</span><strong class="is hj">-)BitwiseDealers/Controller/dealer Controller:</strong>我们将从bitwise dealers控制器获取用户列表。</p><pre class="la lb lc ld fd ln lo lp lq aw lr bi"><span id="9057" class="ls jp hi lo b fi lt lu l lv lw">using BitwiseService;<br/>using Core.Model;<br/>using Microsoft.AspNetCore.Mvc;</span><span id="fe43" class="ls jp hi lo b fi ly lu l lv lw">namespace BitwiseDealers.Controllers<br/>{<br/>   [ApiController]<br/>   [Route("[controller]")]<br/>   public class DealerController : ControllerBase<br/>   {<br/>      IUserService _userService;<br/>      public DealerController(IUserService userService) { _userService = userService; }</span><span id="f3d6" class="ls jp hi lo b fi ly lu l lv lw">      [HttpGet("GetUserListByMessageID/{messageID}")]<br/>      public IEnumerable&lt;UserMessageViewModel&gt; GetUserListByMessageID(int messageID)<br/>      {<br/>         return _userService.GetUserListByMessageID(messageID);<br/>      }<br/>   }<br/>}</span></pre><p id="cc92" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这样，我们必须为每个经销商逐一保存所有用户的记录。如果你有10K用户，每条信息你都要重复这个。所以到了月底，你必须为每条消息保留数百万行。这是我无法接受的:)</p><blockquote class="lz"><p id="6f92" class="ma mb hi bd mc md me mf mg mh mi jn dx translated">为了优化和提高性能，如何用少得多的行数保存相同的数据？</p></blockquote><figure class="mk ml mm mn mo ij er es paragraph-image"><div class="er es mj"><img src="../Images/bce3b28c7282e9cb07f3fc598174eb0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*lRx9IzJuW3bZ8MI8u-hqFA.jpeg"/></div></figure><h1 id="84e8" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated"><span class="l km kn ko bm kp kq kr ks kt di"> B </span> itwise Way</h1><p id="bf20" class="pw-post-body-paragraph iq ir hi is b it ku iv iw ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn hb bi lj translated"><span class="l km kn ko bm kp kq kr ks kt di"> 1 </span> <strong class="is hj"> -) </strong>首先，我们将在用户表中添加“<strong class="is hj"> <em class="lm"> BitwiseID </em> </strong>”列。我们将创建一个新的"<strong class="is hj"><em class="lm">UserMessageBitwase</em></strong>"表，如下所示。毕竟，我们将使用“<strong class="is hj"><em class="lm">user message bitwise</em></strong>”表来代替“<strong class="is hj"> <em class="lm"> UserMessage </em> </strong></p><figure class="la lb lc ld fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mp"><img src="../Images/1adedf5b4bbb347d07b6575fd40bd237.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WIIlFRHLhsHJxNyyd5n5vw.png"/></div></div></figure><p id="bbcc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> * </strong>别忘了再次调用<strong class="is hj">脚手架</strong>命令。因为更新后端DBContext和实体。我们将更新用户实体并添加UserMessageBitwise表。</p><p id="412b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">用户的BitwiseID将通过“<strong class="is hj"><em class="lm"/></strong>”公式增加+1。</p><p id="1270" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">例如:“1，2，4，8，16”。我们将通过DealerID为每个用户组设置“<strong class="is hj"><em class="lm">”BitwiseID</em></strong>”。如果DealerID发生变化，我们将从1重新启动BitwiseID，如下所示。</p><figure class="la lb lc ld fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mq"><img src="../Images/84e5ccfa0e7c46bfabbc2d8d145f35d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z8ZIpPeUMKKRW8GP4w5_Cg.png"/></div></div></figure><p id="538a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们将把新数据添加到“<strong class="is hj"><em class="lm">UserMessageBitwise</em></strong>”表中。</p><blockquote class="lz"><p id="6a55" class="ma mb hi bd mc md me mf mg mh mi jn dx translated">诀窍是我们将用户的“BitWiseID”相加，这些用户与DealarID在同一个组中阅读消息。</p></blockquote><p id="473e" class="pw-post-body-paragraph iq ir hi is b it mr iv iw ix ms iz ja jb mt jd je jf mu jh ji jj mv jl jm jn hb bi translated"><strong class="is hj">例如</strong>:如果您检查“用户消息表”中MessageID =1，并且在DealerID =1的情况下，组用户为“<strong class="is hj"> 1、2和4 </strong>”</p><figure class="la lb lc ld fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mw"><img src="../Images/0f3430106f91d2bd69492ff63d2e486c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x6Rwe5riQATGgBh3rGx84w.png"/></div></div><figcaption class="le lf et er es lg lh bd b be z dx"><strong class="bd jq">We will write only 1 row to the UserMessageBitwise Table instead of writing 3 rows to the UserMessage Table</strong></figcaption></figure><p id="fb1d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们将对DealerID=1且用户ID=1、2和4的用户的“BitWiseID”求和，如下所示。它是1 + 2 + 8= " <strong class="is hj"> 11 </strong>"，并将这个总数放入如上所示的"<strong class="is hj"> UserMessageBitwise </strong>"表的"<em class="lm"> TotalBitwiseId </em>"列中。<strong class="is hj"> <em class="lm">所以我们会写1行而不是3行。</em>T51】</strong></p><figure class="la lb lc ld fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mx"><img src="../Images/cbbd61d711b306eba9be5afedf200b1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Gq_m4V0WSTbQNg6iiPpPgA.png"/></div></div><figcaption class="le lf et er es lg lh bd b be z dx">Sum Spesific User’s BitwiseID</figcaption></figure><p id="37df" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi lj translated"><span class="l km kn ko bm kp kq kr ks kt di"> 2 </span></p><h2 id="0343" class="ls jp hi bd jq my mz na ju nb nc nd jy jb ne nf kc jf ng nh kg jj ni nj kk nk bi translated"><strong class="ak"> Redis实现</strong></h2><p id="47c7" class="pw-post-body-paragraph iq ir hi is b it ku iv iw ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn hb bi translated">首先，我们需要Redis从内存中获取每个经销商的所有用户"<strong class="is hj"> BitwiseId </strong>"回答数据，以提高性能。我们的主要目标是通过将SQL上的负载转移到Redise来提高性能。</p><figure class="la lb lc ld fd ij er es paragraph-image"><div class="er es nl"><img src="../Images/374d63967bec5237062072062c4915c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/format:webp/1*162ko7Xf8_GveIn_GDz-gg.png"/></div></figure><p id="9172" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在“核心”文件夹下创建“缓存”文件夹。并添加如下图所示的“<em class="lm"> RedisCacheService </em>”。</p><p id="d21c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">核心/缓存/IRedisCacheService: </strong></p><pre class="la lb lc ld fd ln lo lp lq aw lr bi"><span id="c0b1" class="ls jp hi lo b fi lt lu l lv lw">using System;<br/>using System.Collections.Generic;<br/>using System.Text;</span><span id="e754" class="ls jp hi lo b fi ly lu l lv lw">namespace Core.Caching<br/>{<br/>   public interface IRedisCacheService<br/>   {<br/>      T Get&lt;T&gt;(string key, long db = 0);<br/>      IList&lt;T&gt; GetAll&lt;T&gt;(string key, long db = 0);<br/>      void Set(string key, object data, long db = 0);<br/>      void Set(string key, object data, DateTime time, long db = 0);<br/>      void SetAll&lt;T&gt;(IDictionary&lt;string, T&gt; values, long db = 0);<br/>      void Remove(string key, long db = 0);<br/>   }</span><span id="edec" class="ls jp hi lo b fi ly lu l lv lw">}</span></pre><figure class="la lb lc ld fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nm"><img src="../Images/9f2bd52cde7becd8564dc36f9b4393df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EgOWkxR6DujeqUn3TlEYBA.png"/></div></div><figcaption class="le lf et er es lg lh bd b be z dx">Don’t Forget the Download “ServiceStack.Redis” Library for Core Project</figcaption></figure><p id="5f3a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">bitwise dealers/appsettings . JSON:</strong>将Redis config添加到appsetting.json中，不要忘记加密发布版本的所有配置文本。</p><pre class="la lb lc ld fd ln lo lp lq aw lr bi"><span id="9cb1" class="ls jp hi lo b fi lt lu l lv lw">.<br/>.<br/>"BitwiseConfig": {<br/>   "RedisEndPoint": "127.0.0.1",<br/>   "RedisPort": "6379",<br/>   "RedisPassword": "t@stPassword"<br/>},</span></pre><p id="bed5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">Core/Configuration/BitwiseConfig:</strong>我们将使用BitwiseConfig类，从appsettings.json获取配置。</p><pre class="la lb lc ld fd ln lo lp lq aw lr bi"><span id="a4be" class="ls jp hi lo b fi lt lu l lv lw">using System;<br/>using System.Collections.Generic;<br/>using System.Linq;<br/>using System.Text;<br/>using System.Threading.Tasks;</span><span id="c5b8" class="ls jp hi lo b fi ly lu l lv lw">namespace Core.Configuration<br/>{<br/>   public  class BitwiseConfig<br/>   {<br/>      #region Props<br/>        public string RedisEndPoint { get; set; }<br/>        public string RedisPort { get; set; }<br/>        public string RedisPassword { get; set; }<br/>      #endregion<br/>   }<br/>}</span></pre><p id="d438" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">bitwise dealer/Program.cs:</strong>别忘了给program . cs添加“BitwiseConfig”类，如下图所示。因此，我们将把“【appsettings.json/BitwiseConfig】”部分与BitwiseConfig类进行匹配。</p><pre class="la lb lc ld fd ln lo lp lq aw lr bi"><span id="890a" class="ls jp hi lo b fi lt lu l lv lw">.<br/>.<br/>builder.Services.Configure&lt;BitwiseConfig&gt;(builder.Configuration.GetSection("BitwiseConfig"));</span></pre><p id="0441" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">核心/缓存/RedisCacheService: </strong>这是一个基本的简单RedisCache服务。您可以通过使用该类来添加、获取和移除基本操作。</p><pre class="la lb lc ld fd ln lo lp lq aw lr bi"><span id="de48" class="ls jp hi lo b fi lt lu l lv lw">using Core.Configuration;<br/>using Microsoft.Extensions.Options;<br/>using Newtonsoft.Json;<br/>using ServiceStack.Redis;<br/>using System;<br/>using System.Collections.Generic;<br/>using System.Linq;<br/>using System.Text;<br/>using System.Threading.Tasks;</span><span id="72a0" class="ls jp hi lo b fi ly lu l lv lw">namespace Core.Caching<br/>{<br/>   public class RedisCacheService : IRedisCacheService<br/>   {<br/>      #region Fields<br/>      public readonly IOptions&lt;BitwiseConfig&gt; _bitwiseConfig;<br/>      private readonly RedisEndpoint conf = null;<br/>      #endregion</span><span id="6eb1" class="ls jp hi lo b fi ly lu l lv lw">      //config set requirepass fl@rp1$19C23public</span><span id="c4ef" class="ls jp hi lo b fi ly lu l lv lw">      RedisCacheService(IOptions&lt;BitwiseConfig&gt; bitwiseConfig)<br/>      {<br/>         _bitwiseConfig = bitwiseConfig;<br/>         conf = new RedisEndpoint { <br/>         Host = _bitwiseConfig.Value.RedisEndPoint, <br/>         Port = Convert.ToInt32(_bitwiseConfig.Value.RedisPort), <br/>         Password = _bitwiseConfig.Value.RedisPassword };<br/>      }<br/>      public T Get&lt;T&gt;(string key, long db = 0)<br/>      {<br/>         try<br/>         {<br/>            conf.Db = db;<br/>            using (IRedisClient client = new RedisClient(conf))<br/>            {<br/>               return client.Get&lt;T&gt;(key);<br/>            }<br/>         }<br/>         catch<br/>         {<br/>            throw new Exception("Redis Not Available");<br/>         }<br/>      }</span><span id="3151" class="ls jp hi lo b fi ly lu l lv lw">      public IList&lt;T&gt; GetAll&lt;T&gt;(string key, long db = 0)<br/>      {<br/>         try<br/>         {<br/>            conf.Db = db;<br/>            using (IRedisClient client = new RedisClient(conf))<br/>            {<br/>               var keys = client.SearchKeys(key);<br/>               if (keys.Any())<br/>               {<br/>                  IEnumerable&lt;T&gt; dataList = client.GetAll&lt;T&gt;(keys).Values;<br/>                  return dataList.ToList();<br/>               }<br/>               return new List&lt;T&gt;();<br/>             }<br/>         }<br/>         catch<br/>         {<br/>           throw new Exception("Redis Not Available");<br/>         }<br/>      }</span><span id="2dca" class="ls jp hi lo b fi ly lu l lv lw">      public void Set(string key, object data, long db = 0)<br/>      {<br/>         Set(key, data, DateTime.Now.AddMinutes(60), db);<br/>      }<br/>      public void Set(string key, object data, DateTime time, long db = 0)<br/>      {<br/>         try<br/>         {<br/>            conf.Db = db;<br/>            using (IRedisClient client = new RedisClient(conf))<br/>            {<br/>               var dataSerialize = JsonConvert.SerializeObject(data, Formatting.Indented, new JsonSerializerSettings{<br/>PreserveReferencesHandling = PreserveReferencesHandling.Objects<br/>});<br/>               client.Set(key, Encoding.UTF8.GetBytes(dataSerialize), time);<br/>            }<br/>         }<br/>         catch<br/>         {<br/>            throw new Exception("Redis Not Available");<br/>         }<br/>      }</span><span id="97c4" class="ls jp hi lo b fi ly lu l lv lw">      public void SetAll&lt;T&gt;(IDictionary&lt;string, T&gt; values, long db = 0)<br/>      { <br/>         try<br/>         {<br/>            conf.Db = db;<br/>            using (IRedisClient client = new RedisClient(conf))<br/>            {<br/>               client.SetAll(values);<br/>            }<br/>         }<br/>         catch<br/>         {<br/>            throw new Exception("Redis Not Available");<br/>         }<br/>      }</span><span id="bdaa" class="ls jp hi lo b fi ly lu l lv lw">      public void Remove(string key, long db = 0)<br/>      {<br/>         try<br/>         {<br/>            conf.Db = db;<br/>            using (IRedisClient client = new RedisClient(conf))<br/>            {<br/>               client.Remove(key);<br/>            }<br/>         }<br/>         catch<br/>         {<br/>            throw new Exception("Redis Not Available");<br/>         }<br/>      }<br/>   }<br/>}</span></pre><p id="b931" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">bitwise dealer/Program.cs:</strong>别忘了给program . cs添加“RedisServices”类，如下图所示。</p><pre class="la lb lc ld fd ln lo lp lq aw lr bi"><span id="e0ae" class="ls jp hi lo b fi lt lu l lv lw">builder.Services.AddTransient&lt;IRedisCacheService, RedisCacheService&gt;();</span></pre><p id="2071" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi lj translated"><span class="l km kn ko bm kp kq kr ks kt di"> 3 </span> <strong class="is hj"> -) </strong>接下来，我们将创建“UserRedisModel”作为模型保存在Redis中。我们将在Redis中使用该模型保存用户详细数据。</p><figure class="la lb lc ld fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nn"><img src="../Images/0725ae941f5e4ae37616de102f3a5eef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j8ZB0xrRs8H5NTdrwDPlcw.png"/></div></div><figcaption class="le lf et er es lg lh bd b be z dx"><strong class="bd jq">List of UserRedisModel Data for DealarID=1 on Redis</strong></figcaption></figure><p id="3776" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">核心/模型/用户再模型:</strong></p><pre class="la lb lc ld fd ln lo lp lq aw lr bi"><span id="cb7d" class="ls jp hi lo b fi lt lu l lv lw">using System;<br/>using System.Collections.Generic;<br/>using System.Linq;<br/>using System.Text;<br/>using System.Threading.Tasks;</span><span id="a129" class="ls jp hi lo b fi ly lu l lv lw">namespace Core.Model<br/>{<br/>   public class UserRedisModel<br/>   {<br/>      public int Id { get; set; }<br/>      public string? Name { get; set; }<br/>      public string? Surname { get; set; }<br/>      public long? BitwiseId { get; set; }<br/>      public int? DealarId { get; set; }<br/>      public string DealarName { get; set; }<br/>      public DateTime? CreatedDate { get; set; }<br/>   }<br/>}</span></pre><p id="93b2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们做好了一切准备。接下来，我们将把<strong class="is hj"> GetUserListMessageID()方法</strong>改为<strong class="is hj">逐位</strong>算法<strong class="is hj"> </strong>，如下所示</p><ul class=""><li id="54fa" class="no np hi is b it iu ix iy jb nq jf nr jj ns jn nt nu nv nw bi translated">在开始的时候，我们会获取所有阅读消息的人的数据，并设置“answerData”参数。</li><li id="f621" class="no np hi is b it nx ix ny jb nz jf oa jj ob jn nt nu nv nw bi translated">我们将通过“messageID”获取消息文本，并设置消息变量。</li></ul><figure class="la lb lc ld fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es oc"><img src="../Images/4a092f90a16f40676bab316b49d79a9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CKsynSS_5Kp8wVKpXQnvFA.png"/></div></div></figure><ul class=""><li id="1741" class="no np hi is b it iu ix iy jb nq jf nr jj ns jn nt nu nv nw bi translated">“resultList”是模型的返回列表。我们将在开始时创建一个空模型。我们将开始循环输入“answerData”。</li></ul><figure class="la lb lc ld fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es od"><img src="../Images/3c486e53627202d6e4fda32260ead947.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jXqBvDpJ75XiNR5TYMQE5w.png"/></div></div></figure><ul class=""><li id="7de3" class="no np hi is b it iu ix iy jb nq jf nr jj ns jn nt nu nv nw bi translated">我们将尝试从Redis中获取带有特定dealerID的用户数据。如果为null，将从SqlDB中获取所有数据。</li></ul><figure class="la lb lc ld fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es oe"><img src="../Images/3e98c793c70200dab730b57e8403d0dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GQckAv_BgBWTmQMJKVzXVg.png"/></div></div></figure><ul class=""><li id="f542" class="no np hi is b it iu ix iy jb nq jf nr jj ns jn nt nu nv nw bi translated">如果Redis为null，我们将使用LINQ从DB中获取用户数据，如下所示。我们将连接用户和经销商表，并返回UserRedisModel。最后，将该经销商的用户数据保存到Redis。</li></ul><figure class="la lb lc ld fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es of"><img src="../Images/74049a4eb64ad5fa25b788cef9f2bfba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2UC8JqCz_aIBLTZn-FJHKQ.png"/></div></div></figure><ul class=""><li id="ceae" class="no np hi is b it iu ix iy jb nq jf nr jj ns jn nt nu nv nw bi translated">*这是最重要的部分。在我们从Redis或SqlDB获得用户数据之后，我们将在UserList中循环。我们将检查<strong class="is hj">是否为<em class="lm">用户。BitwiseID </em>中的</strong>是总答<strong class="is hj">中的<em class="lm"> TotalUserBitwiseId </em>中的</strong>。它的意思是，这个用户是否阅读此消息。</li></ul><blockquote class="lz"><p id="d5ad" class="ma mb hi bd mc md og oh oi oj ok jn dx translated">用户。BitwiseID[4]=(TotalBitwiseID[8]&amp; user。BitwiseID[4]) = &gt;结果为“是”</p></blockquote><figure class="mk ml mm mn mo ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ol"><img src="../Images/2b0668744462d6744df72b1e37fa6a24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*KgOydXlSzQ-iX32gxiQUTQ.gif"/></div></div><figcaption class="le lf et er es lg lh bd b be z dx"><strong class="bd jq">Bitwise Operation Example</strong></figcaption></figure><ul class=""><li id="04df" class="no np hi is b it iu ix iy jb nq jf nr jj ns jn nt nu nv nw bi translated">如果为真，我们将把这个用户添加到“<em class="lm"> resultUserList </em>”中。最后还回来。</li></ul><figure class="la lb lc ld fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es om"><img src="../Images/1a3f5c6b9648a71f0e9d635326fef3fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EWbNf0AZZ1-89zu2vNNMkA.png"/></div></div><figcaption class="le lf et er es lg lh bd b be z dx">We Checked if Is User Read the Message or Not by Using <strong class="bd jq">Bitwise</strong></figcaption></figure><p id="2179" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> BitwiseService/UserService(版本2): </strong></p><figure class="la lb lc ld fd ij"><div class="bz dy l di"><div class="on oo l"/></div></figure><p id="ee60" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们得到了所有的用户，他们通过使用"<strong class="is hj"> <em class="lm">按位</em> " </strong>读取MessageID=1，如下所示。</p><figure class="la lb lc ld fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ol"><img src="../Images/6cf6b099fb2d714bd3dd42a9385517b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*4lPnwLMJopT3witF2m0hvA.gif"/></div></div><figcaption class="le lf et er es lg lh bd b be z dx">Which Users Did Read the MessageID =1 ?</figcaption></figure><p id="9576" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">结论:</strong></p><p id="8464" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以对许多父子场景使用逐位算法。例如树形菜单、州/城市或产品/子产品。您可以对最多63个子项目使用位元。因为处理器不能识别大于“<strong class="is hj"><em class="lm">”</em></strong>”的数字。但是我觉得大多数情况下63就够了。你可以在线写1行而不是63行。诀窍是在一个组中使用子类别。正如在本文中，我们将用户分组到经销商下面。所以对于不同的经销商，我们从1重新启动用户BitwiseID。我们为新经销商赢得了63个用户。</p><p id="bf97" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">不用担心循环所有用户来检查他们的BitwiseId是否在TotalBitwiseID中。因为按位检查是一个非常性能的操作。</p><p id="e4a8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下一篇文章再见。</p><figure class="la lb lc ld fd ij"><div class="bz dy l di"><div class="op oo l"/></div></figure><p id="ce1c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lm">“如果你读到现在，首先感谢你的耐心和支持。欢迎大家到我的博客</em><a class="ae oq" href="http://www.borakasmer.com/" rel="noopener ugc nofollow" target="_blank"><em class="lm"/><strong class="is hj"><em class="lm"/></strong></a><strong class="is hj"><em class="lm"/></strong><em class="lm">了解更多！”</em></p><p id="8e4f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">源代码</strong></p><ul class=""><li id="5c86" class="no np hi is b it iu ix iy jb nq jf nr jj ns jn nt nu nv nw bi translated"><strong class="is hj">Github:</strong><a class="ae oq" href="https://github.com/borakasmer/Bitwise" rel="noopener ugc nofollow" target="_blank"><strong class="is hj"><em class="lm">https://github.com/borakasmer/Bitwise</em></strong></a></li><li id="4a91" class="no np hi is b it nx ix ny jb nz jf oa jj ob jn nt nu nv nw bi translated"><strong class="is hj"> BitwiseDB脚本:</strong><a class="ae oq" href="https://borakasmer.com/projects/BitwiseScript.sql" rel="noopener ugc nofollow" target="_blank"><strong class="is hj"><em class="lm">https://borakasmer.com/projects/BitwiseScript.sql</em></strong></a></li></ul></div></div>    
</body>
</html>