<html>
<head>
<title>A Simple Glue job to write csv part files into a single csv file</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将csv零件文件写入单个csv文件的简单粘合作业</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/aws-glue-simple-job-to-write-part-csv-files-to-a-single-file-d805eddbe641?source=collection_archive---------1-----------------------#2022-08-16">https://medium.com/geekculture/aws-glue-simple-job-to-write-part-csv-files-to-a-single-file-d805eddbe641?source=collection_archive---------1-----------------------#2022-08-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="4cdf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">问题</strong></p><p id="d961" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有几个在s3位置生成的CSV零件文件，需要创建为具有相同命名约定的单个CSV文件。</p><p id="a28e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">解决方案</strong></p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="79ad" class="jm jn hi ji b fi jo jp l jq jr">import sys<br/>from awsglue.utils import getResolvedOptions<br/>from pyspark.context import SparkContext<br/>from awsglue.context import GlueContext<br/>from awsglue.job import Job<br/>from awsglue.transforms import *</span><span id="5a55" class="jm jn hi ji b fi js jp l jq jr">args = getResolvedOptions(sys.argv, ["JOB_NAME"])<br/>sc = SparkContext()<br/>glueContext = GlueContext(sc)<br/>spark = glueContext.spark_session<br/>job = Job(glueContext)</span><span id="e8e3" class="jm jn hi ji b fi js jp l jq jr"># Read CSV Part Files<br/>S3bucket_node1 = glueContext.create_dynamic_frame.from_options(<br/>    format_options={<br/>        "quoteChar": '"',<br/>        "withHeader": True,<br/>        "separator": ",",<br/>        "multiline": False,<br/>    },<br/>    connection_type="s3",<br/>    format="csv",<br/>    connection_options={<br/>        "paths": ["s3://bkt-part-files/val/20220708/"],<br/>    },<br/>    transformation_ctx="S3bucket_node1",<br/>)</span><span id="7ce4" class="jm jn hi ji b fi js jp l jq jr"># Repartition to collate the files as a single data frame</span><span id="0686" class="jm jn hi ji b fi js jp l jq jr">S3bucket_node2 = S3bucket_node1.toDF().repartition(1)</span><span id="ab08" class="jm jn hi ji b fi js jp l jq jr">#Be careful of the path location , the folder 'somefilename' gets overwritten</span><span id="125e" class="jm jn hi ji b fi js jp l jq jr">S3bucket_node2.write.mode('overwrite').csv('s3://bkt-part-files/output/somefilename',header = 'true')</span><span id="4753" class="jm jn hi ji b fi js jp l jq jr">#The above line of code writes a single part file</span><span id="ddba" class="jm jn hi ji b fi js jp l jq jr">import boto3<br/>client = boto3.client('s3')</span><span id="15ff" class="jm jn hi ji b fi js jp l jq jr">BUCKET_NAME= 'bkt-part-files'<br/>PREFIX ='output/somefilename/'<br/>response = client.list_objects(<br/>    Bucket=BUCKET_NAME, Prefix=PREFIX,)</span><span id="b5b0" class="jm jn hi ji b fi js jp l jq jr">#Helps to fetch the file name of the file created in this glue job<br/>name = response['Contents'][0]['Key']</span><span id="1098" class="jm jn hi ji b fi js jp l jq jr">client.copy_object(Bucket=BUCKET_NAME, </span><span id="4894" class="jm jn hi ji b fi js jp l jq jr">#The csv file generated can be renamed with a name as desired !</span><span id="fddb" class="jm jn hi ji b fi js jp l jq jr">CopySource=BUCKET_NAME+'/'+name, Key=PREFIX+'single_file.csv')<br/>client.delete_object(Bucket=BUCKET_NAME ,Key=name)</span><span id="a9bf" class="jm jn hi ji b fi js jp l jq jr">job.commit()</span></pre><figure class="jd je jf jg fd ju er es paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="er es jt"><img src="../Images/6ab70b074662a6e1dbceaa5b2458ee8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C6EKPizApi2cQN5XxrhXFA.png"/></div></div></figure></div></div>    
</body>
</html>