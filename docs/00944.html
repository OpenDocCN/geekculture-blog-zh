<html>
<head>
<title>Role-Based Access Control (RBAC) for NoSQL DB in Nodejs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Nodejs中NoSQL数据库的基于角色的访问控制(RBAC)</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/role-based-access-control-rbac-for-nosql-db-in-nodejs-e72924074d13?source=collection_archive---------2-----------------------#2021-03-21">https://medium.com/geekculture/role-based-access-control-rbac-for-nosql-db-in-nodejs-e72924074d13?source=collection_archive---------2-----------------------#2021-03-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><blockquote class="if ig ih"><p id="532b" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated"><em class="hi">许多RBAC(基于角色的访问控制)的实现各不相同，但其基础被广泛采用，因为它模拟了现实生活中的角色(工作)分配。— </em> <a class="ae jh" href="https://github.com/onury" rel="noopener ugc nofollow" target="_blank">奥努尔耶尔德勒姆</a>。</p></blockquote><p id="bd34" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">基于角色的访问控制(RBAC)是一种基于组织内单个用户或用户组的角色来修改访问和权限的方法。</p><p id="1460" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">RBAC允许组织成员只访问他们工作所需的资源，并限制或阻止对不属于他们的资源的无限特权。</p><figure class="jm jn jo jp fd jq er es paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="er es jl"><img src="../Images/cb146ab81619c85a26d6cfdabdfbb145.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6is2-qbYQGpHReHI"/></div></div></figure><h1 id="15cf" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">RBAC对ABAC</h1><p id="02ef" class="pw-post-body-paragraph ii ij hi il b im kv io ip iq kw is it ji kx iw ix jj ky ja jb jk kz je jf jg hb bi translated">基于角色的访问控制和基于属性的访问控制(ABAC)都是访问控制方法的类型，但是它们的方法不同。需要RBAC系统的一个用例是，我们打算根据用户的角色授予应用程序特权。</p><figure class="jm jn jo jp fd jq er es paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="er es la"><img src="../Images/b58dd39100cc093c091bacab72e41120.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*exep4-1OPE4b6fgC"/></div></div></figure><p id="54a4" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">而ABAC基于属性的组合，即用户属性、资源属性、与要访问的系统或应用程序相关联的属性、环境属性等，来授予访问权。例如，用户属性可能包括生物数据信息、唯一标识、角色、安全许可等。</p><figure class="jm jn jo jp fd jq er es paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="er es la"><img src="../Images/2dfe45e36947e5c9fef294ad6a4ceb67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*sNVfnzKsIHsjrFed"/></div></div></figure><h1 id="9d5d" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">背景故事</h1><p id="aad3" class="pw-post-body-paragraph ii ij hi il b im kv io ip iq kw is it ji kx iw ix jj ky ja jb jk kz je jf jg hb bi translated">在最近的一个项目中，我的团队负责使用mongoose ORM模式为MongoDB(NoSQL数据库)实现一个定制的基于角色的访问控制框架。在这个访问控制框架中，我们将考虑3个实体:</p><p id="5b2f" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated"><strong class="il hj">实现上下文</strong></p><ul class=""><li id="864d" class="lb lc hi il b im in iq ir ji ld jj le jk lf jg lg lh li lj bi translated">用户有一个角色</li><li id="1a20" class="lb lc hi il b im lk iq ll ji lm jj ln jk lo jg lg lh li lj bi translated">应用程序已经定义了资源，</li><li id="7b86" class="lb lc hi il b im lk iq ll ji lm jj ln jk lo jg lg lh li lj bi translated">该角色拥有资源的特权和权限</li></ul><p id="c0d9" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">让我们为我们的集合编写一些mongoose模式😄</p><h1 id="2bfb" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">(计划或理论的)纲要</h1><p id="bfe4" class="pw-post-body-paragraph ii ij hi il b im kv io ip iq kw is it ji kx iw ix jj ky ja jb jk kz je jf jg hb bi translated"><strong class="il hj"> resources.models.js </strong></p><pre class="jm jn jo jp fd lp lq lr ls aw lt bi"><span id="c82d" class="lu jy hi lq b fi lv lw l lx ly">/* RBAC - role-based access control<br/> first create roles; role =[ "user", "guest", "organization",  "superadmin" "globalsuperadmin"]<br/> next, create resouuce, add their roles_id and permmissions<br/> finally create users and indcate thier roles<br/>*/</span><span id="7712" class="lu jy hi lq b fi lz lw l lx ly">const mongooseClient = app.get('mongooseClient');<br/>    const { Schema } = mongooseClient;</span><span id="3322" class="lu jy hi lq b fi lz lw l lx ly">const resources = new Schema({<br/>      name: { type: String, required: true },<br/>      slug: { type: String, required: true },<br/>      resources_roles: [{<br/>        roles_id: { type: Schema.Types.ObjectId, ref : 'Roles' },<br/>        roles_name: { type:  String },<br/>        create: { type: Boolean },<br/>        delete: { type: Boolean },<br/>        update: { type: Boolean },<br/>        read: { type: Boolean },<br/>      }]<br/>    }, {<br/>      timestamps: true<br/>    });</span><span id="5caa" class="lu jy hi lq b fi lz lw l lx ly">return mongooseClient.model('resources', resources);</span></pre><p id="9bed" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated"><strong class="il hj"> roles.models.js </strong></p><pre class="jm jn jo jp fd lp lq lr ls aw lt bi"><span id="0db3" class="lu jy hi lq b fi lv lw l lx ly">const mongooseClient = app.get('mongooseClient');<br/>    const { Schema } = mongooseClient;</span><span id="8c29" class="lu jy hi lq b fi lz lw l lx ly">module.exports = function (app) {<br/>    const mongooseClient = app.get('mongooseClient');<br/>    const { Schema } = mongooseClient;<br/>    const roles = new Schema({<br/>      name: { type: String, required: true },<br/>      slug: { type: String, required: true },<br/>    }, {<br/>      timestamps: true<br/>    });</span><span id="5947" class="lu jy hi lq b fi lz lw l lx ly">return mongooseClient.model('roles', roles);<br/>  };</span></pre><p id="2c26" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated"><strong class="il hj"> users.models.js </strong></p><pre class="jm jn jo jp fd lp lq lr ls aw lt bi"><span id="4c2c" class="lu jy hi lq b fi lv lw l lx ly">const mongooseClient = app.get('mongooseClient');<br/>    const { Schema } = mongooseClient;</span><span id="7ab4" class="lu jy hi lq b fi lz lw l lx ly">module.exports = function (app) {<br/>    const mongooseClient = app.get('mongooseClient');<br/>    const { Schema } = mongooseClient<br/>    const users = new mongooseClient.Schema({<br/>      email: {type: String, unique: true, lowercase: true},<br/>      password: { type: String },<br/>      first_name: { type: String },<br/>      last_name: { type: String },<br/>      roles: { type: Schema.Types.ObjectId, ref : 'Roles' },</span><span id="e2dd" class="lu jy hi lq b fi lz lw l lx ly">}, {<br/>      timestamps: true<br/>    });</span><span id="d601" class="lu jy hi lq b fi lz lw l lx ly">return mongooseClient.model('users', users);<br/>  };</span></pre><p id="30fc" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">现在，当您需要某个角色对某个资源的权限时，您只需查找<code class="du ma mb mc lq b">role_id</code>和<code class="du ma mb mc lq b">resource_id</code>，并检查在<code class="du ma mb mc lq b">resources collection</code>中将哪些权限设置为<code class="du ma mb mc lq b">true</code>。</p><h1 id="f161" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">授权中间件</h1><p id="c6fe" class="pw-post-body-paragraph ii ij hi il b im kv io ip iq kw is it ji kx iw ix jj ky ja jb jk kz je jf jg hb bi translated"><code class="du ma mb mc lq b">users.post('/', getAuth, someMethod)</code></p><p id="3c74" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">假设您在请求上有一个某种令牌来标识发布帖子的用户，并将用户实例附加到请求对象，您可以这样做:</p><pre class="jm jn jo jp fd lp lq lr ls aw lt bi"><span id="8ea4" class="lu jy hi lq b fi lv lw l lx ly">// pseudo code<br/>getAuth = function (req, res, next) {<br/>  if(req.user) {</span><span id="be60" class="lu jy hi lq b fi lz lw l lx ly">// query to get the user role's  permissions for a resource<br/>    if(token){<br/>    // handle jwt token authenticity and decrypt payload</span><span id="07d3" class="lu jy hi lq b fi lz lw l lx ly">// get permission handler<br/>    db.getPerms({ role_id: req.user.role_id, resource_id: req.resource.id})<br/>    .then((perms) =&gt; {<br/>       var allow = false;<br/>       // mapping of methods to permissions<br/>       perms.forEach(function(perm){<br/>           if (req.method == "POST" &amp;&amp; perms.create) allow = true;<br/>           else if (req.method == "GET" &amp;&amp; perms.read) allow = true;<br/>           else if (req.method == "PUT" &amp;&amp; perms.write) allow = true;<br/>           else if (req.method == "DELETE" &amp;&amp; perm.delete) allow = true;</span><span id="2fd4" class="lu jy hi lq b fi lz lw l lx ly">})<br/>       if (allow) next();<br/>       else {<br/>            res.status(403).send({error: 'access denied'});<br/>        }<br/>    })<br/>    .catch((err)=&gt; {<br/>       //handle your reject and catch here<br/>    })<br/>} else{<br/>    res.status(400).send({error: 'invalid token'})<br/>}</span></pre><p id="7684" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">这是一些伪代码，展示了如何编写认证中间件。</p><p id="45b0" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">这不是实现RBAC的最佳框架，所以我期待您的反馈😄！！</p><p id="34b5" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">感谢观众，希望这篇文章对你有所帮助🤗。你可以随时在Github、T2、推特和T4的LinkedIn上联系我。一定要点赞、评论和分享😌。</p></div><div class="ab cl md me gp mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="hb hc hd he hf"><p id="0466" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated"><em class="ik">最初发布于</em><a class="ae jh" href="https://blog.nextwebb.tech/role-based-access-control-rbac-for-nosql-db-in-nodejs" rel="noopener ugc nofollow" target="_blank"><em class="ik">https://blog . next Webb . tech</em></a><em class="ik">。</em></p></div></div>    
</body>
</html>