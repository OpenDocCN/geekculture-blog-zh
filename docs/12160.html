<html>
<head>
<title>Angular,Node:Using Resource Timing API to get API timing information</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Angular，Node:使用资源计时API获取API计时信息</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/angular-node-using-resource-timing-api-to-get-api-timing-information-f460898f31d9?source=collection_archive---------5-----------------------#2022-04-29">https://medium.com/geekculture/angular-node-using-resource-timing-api-to-get-api-timing-information-f460898f31d9?source=collection_archive---------5-----------------------#2022-04-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="07a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在为我的工作项目编码的过程中，我遇到了这个非常有趣的<strong class="ih hj">资源计时API </strong>，它是通过<strong class="ih hj"> window.performance </strong>属性公开的。</p><p id="7bda" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用MDN文档的话说，资源计时API提供了一种方法来检索和分析关于应用程序的<em class="jd">资源</em>的加载的详细网络计时数据。</p><p id="ca65" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里的应用程序资源可以是以下任意一种:<code class="du je jf jg jh b"><a class="ae ji" href="https://xhr.spec.whatwg.org/#xmlhttprequest" rel="noopener ugc nofollow" target="_blank">XMLHttpRequest</a></code>对象[ <a class="ae ji" href="https://www.w3.org/TR/resource-timing-2/#bib-xhr" rel="noopener ugc nofollow" target="_blank"> XHR </a> ]，链接类型为<code class="du je jf jg jh b"><a class="ae ji" href="https://html.spec.whatwg.org/multipage/links.html#link-type-stylesheet" rel="noopener ugc nofollow" target="_blank">stylesheet</a></code>的HTML元素如<code class="du je jf jg jh b"><a class="ae ji" href="https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element" rel="noopener ugc nofollow" target="_blank">iframe</a></code>、<code class="du je jf jg jh b"><a class="ae ji" href="https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element" rel="noopener ugc nofollow" target="_blank">img</a></code>、<code class="du je jf jg jh b"><a class="ae ji" href="https://html.spec.whatwg.org/multipage/scripting.html#script" rel="noopener ugc nofollow" target="_blank">script</a></code>、<code class="du je jf jg jh b"><a class="ae ji" href="https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-object-element" rel="noopener ugc nofollow" target="_blank">object</a></code>、<code class="du je jf jg jh b"><a class="ae ji" href="https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-embed-element" rel="noopener ugc nofollow" target="_blank">embed</a></code>和<code class="du je jf jg jh b"><a class="ae ji" href="https://html.spec.whatwg.org/multipage/semantics.html#the-link-element" rel="noopener ugc nofollow" target="_blank">link</a></code>，SVG元素如<a class="ae ji" href="https://www.w3.org/TR/SVG11/struct.html#SVGElement" rel="noopener ugc nofollow" target="_blank"> svg </a>和<code class="du je jf jg jh b"><a class="ae ji" href="https://html.spec.whatwg.org/multipage/server-sent-events.html#eventsource" rel="noopener ugc nofollow" target="_blank">EventSource</a></code>。</p><p id="4534" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">结果与Chrome的开发者工具提供的计时信息非常接近或几乎相同。</p><p id="0632" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了测试这一点，我创建了一个简单的Angular项目，它对一个节点服务器进行两次API调用<strong class="ih hj"> /comments和/todos </strong>，以获取注释和todos数据。</p><p id="c829" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了捕获API调用的性能，我创建了一个拦截器来完成这项工作。</p><figure class="jj jk jl jm fd jn"><div class="bz dy l di"><div class="jo jp l"/></div></figure><p id="c3b0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦服务器发回响应，我们就调用<strong class="ih hj"> rxjs tap()中的<strong class="ih hj"> analysePerformance() </strong>。</strong></p><pre class="jj jk jl jm fd jq jh jr js aw jt bi"><span id="3801" class="ju jv hi jh b fi jw jx l jy jz">analyzePerformance() { </span><span id="ce08" class="ju jv hi jh b fi ka jx l jy jz">let resourceList = <strong class="jh hj">window.performance.getEntriesByType(‘resource’);</strong></span><span id="abb6" class="ju jv hi jh b fi ka jx l jy jz">let filteredResourceList = <strong class="jh hj">resourceList.filter( (resource:any) =&gt;{ <br/>return resource[‘initiatorType’].includes(‘xmlhttprequest’) } ); </strong></span><span id="b1ff" class="ju jv hi jh b fi ka jx l jy jz">filteredResourceList.forEach((entry:any)=&gt;{ <br/>console.log(entry); <br/>console.log( <strong class="jh hj">`Resource ${entry.name} loaded in ${entry.duration} ms and delivered data of size ${entry[“decodedBodySize”]} bytes`</strong> ); </span><span id="e2d1" class="ju jv hi jh b fi ka jx l jy jz">}) <br/>}</span></pre><p id="d92f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">windows . performance . getentriesbytype(<strong class="ih hj">resource</strong>’)将返回给定类型“resource”的<strong class="ih hj"> PerformanceEntry </strong>对象列表。</p><p id="dc21" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该列表是具有不同<strong class="ih hj"> initiatorType </strong>属性的对象的数组。<strong class="ih hj"> initiatorType </strong>属性让我们了解对象包含的资源类型。下面是属性可以包含的值列表。</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es kb"><img src="../Images/82550573ecc67e132d4201a1b5856869.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2IJQn7UsWONfpkw7OppRFw.png"/></div></div></figure><p id="a538" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本例中，当我们查看2个GET Http请求的计时信息时，我们对类型为<strong class="ih hj"> xmlhttprequest的resources/PerformanceEntry对象更感兴趣。</strong></p><pre class="jj jk jl jm fd jq jh jr js aw jt bi"><span id="7321" class="ju jv hi jh b fi jw jx l jy jz">let filteredResourceList = <strong class="jh hj">resourceList.filter( (resource:any) =&gt;{ <br/>return resource[‘initiatorType’].includes(‘xmlhttprequest’) } );</strong></span></pre><p id="05d1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，正如您在上面看到的，我们只为xmlhttprequest对象过滤PerformanceEntry列表。</p><pre class="jj jk jl jm fd jq jh jr js aw jt bi"><span id="e9c1" class="ju jv hi jh b fi jw jx l jy jz">filteredResourceList.forEach((entry:any)=&gt;{ <br/>console.log(entry); <br/>console.log( <strong class="jh hj">`Resource ${entry.name} loaded in ${entry.duration} ms and delivered data of size ${entry[“decodedBodySize”]} bytes`</strong> );</span><span id="7ad5" class="ju jv hi jh b fi ka jx l jy jz">})</span></pre><p id="9688" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我们遍历所需的列表，记录整个PerformanceEntry对象和一个字符串，该字符串包含资源名称、资源返回的数据大小以及资源完成其操作所用的时间，即API调用完成所用的时间。</p><p id="b08f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在跨源资源共享(CORS)请求的情况下，PerformanceEntry对象中的许多计时属性值返回为零。为了避免这种情况，提供资源的服务器必须发送带有一个值的<code class="du je jf jg jh b"><a class="ae ji" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Timing-Allow-Origin" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">Timing-Allow-Origin</strong></a></code> HTTP响应头，该值指定允许获取受限时间戳值的一个或多个源。</p><p id="4936" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是用于检索注释和待办事项数据的Nodejs Express路由器。请观察两个路由器文件中返回的响应头。</p><figure class="jj jk jl jm fd jn"><div class="bz dy l di"><div class="jo jp l"/></div></figure><figure class="jj jk jl jm fd jn"><div class="bz dy l di"><div class="jo jp l"/></div></figure><pre class="jj jk jl jm fd jq jh jr js aw jt bi"><span id="44e0" class="ju jv hi jh b fi jw jx l jy jz">res.setHeader(‘<strong class="jh hj">Timing-Allow-Origin</strong>’,cors.whiteListedOrigins);</span></pre><p id="4de0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们已经用从<strong class="ih hj"> cors.js </strong>文件中导出的<strong class="ih hj"> whiteListedOrigins </strong>属性的值设置了<strong class="ih hj"> Timing-Allow-Origin </strong>头。</p><p id="e460" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> cors.js </strong>文件如下所示。<strong class="ih hj">whiteliedorigins</strong>是一个数组，包含连接到节点服务器的白名单源列表。这意味着只有这些源可以连接到节点服务器以访问其资源，包括受限的定时信息。</p><p id="64ea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">cors白名单中的所有源不必都能访问受限定时属性。但是在这个例子中，我们这样做是为了简单。</p><figure class="jj jk jl jm fd jn"><div class="bz dy l di"><div class="jo jp l"/></div></figure><p id="5640" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，让我们看看Chrome开发者工具，将计时结果与资源计时API进行比较。</p><p id="d859" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在Chrome开发者工具中，<strong class="ih hj"> /todos API </strong>用了<strong class="ih hj"> 712.50 ms </strong>完成，<strong class="ih hj">/评论API </strong>用了<strong class="ih hj"> 837.50 ms </strong>完成。</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es ki"><img src="../Images/96911a5f4cfc61373bec12e63ff67c52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V0tKNGWvp5u4s_BK1p0kqg.png"/></div></div><figcaption class="kj kk et er es kl km bd b be z dx">todos API</figcaption></figure><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es kn"><img src="../Images/5511707292c7f4352d07c8fe14128e97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aiGb4giGITBij4kZPlSWLA.png"/></div></div><figcaption class="kj kk et er es kl km bd b be z dx">comments API</figcaption></figure><p id="8e4c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们在控制台中检查资源计时API结果。</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es ki"><img src="../Images/cfd3a32ab35cd020ddc3506e66088683.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2ucbMrSSM1IYPWktYynFWQ.png"/></div></div></figure><p id="d9d0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如你所见，我们得到了两个API完全相同的结果。下面是PerformanceEntry对象的截图。如果没有设置<strong class="ih hj"> Timing-Allow-Origin </strong>响应头，该对象中的许多属性将会取值为0。最终结果将是您将无法获得正确的时间信息。</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es ki"><img src="../Images/8afe4386ff884adbb97cb8c179133afe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NMINlKhhpa7UNqSGpMnRIg.png"/></div></div></figure></div></div>    
</body>
</html>