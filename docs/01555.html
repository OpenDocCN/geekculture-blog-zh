<html>
<head>
<title>Docker, .NET Core 5.0, Angular 11, Nginx and Postgres on the Google Cloud Platform — Pt 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">码头工人。谷歌云平台上的NET Core 5.0、Angular 11、Nginx和Postgres——Pt 2</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/docker-net-core-5-0-angular-11-nginx-and-postgres-on-the-google-cloud-platform-pt-2-a8b32167e183?source=collection_archive---------10-----------------------#2021-04-15">https://medium.com/geekculture/docker-net-core-5-0-angular-11-nginx-and-postgres-on-the-google-cloud-platform-pt-2-a8b32167e183?source=collection_archive---------10-----------------------#2021-04-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="f8d6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://stephen-adam.medium.com/docker-net-core-5-0-angular-11-nginx-and-postgres-on-the-google-cloud-platform-pt-1-363160e34439" rel="noopener">在第1部分</a>中，我们在本地构建并运行了我们的映像，涵盖了docker-compose文件和docker构建文件。现在是时候考虑将所有东西都迁移到云上，并让它免费运行了！</p><p id="a4a1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://github.com/Pastafarian/GcpBlog" rel="noopener ugc nofollow" target="_blank">这个例子的源代码可以在这里找到。</a></p><h1 id="61d3" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">推送Api Docker映像</h1><p id="117d" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">当我们迁移到云时，我们将依赖虚拟机上的docker compose实例来下载我们在第一步中创建的预构建Api映像。为了使我们的图像可以被访问，我们将把它放在Docker Hub上，一个Docker图像库；其他可用的存储库有<a class="ae jd" href="https://azure.microsoft.com/en-gb/services/container-registry/" rel="noopener ugc nofollow" target="_blank"> Azure Container Registry </a>和<a class="ae jd" href="https://cloud.google.com/container-registry" rel="noopener ugc nofollow" target="_blank"> Google的容器注册表</a>。</p><p id="0275" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先你需要<a class="ae jd" href="https://hub.docker.com/signup" rel="noopener ugc nofollow" target="_blank">注册</a>并创建一个Docker Hub账户，给自己一个Docker ID。</p><p id="715c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦您完成了这一步，就该使用下面的命令将我们的容器推到hub了。</p><p id="f573" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">输入您的Docker ID作为您的用户名，然后输入您的密码。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="c894" class="kq jf hi km b fi kr ks l kt ku">docker login</span></pre><p id="950e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，在docker-compose.yml文件所在的解决方案的根目录中打开powershell。</p><p id="d123" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将为我们的应用程序(包括Api)创建一个新的映像。</p><p id="0e1b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kv">注意，直接进入服务器目录并在那里运行docker构建会更快，但是我想尽可能简单地用最少的命令来解释</em>。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="6fd0" class="kq jf hi km b fi kr ks l kt ku">docker-compose build</span></pre><p id="2cf9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Docker images将向我们显示系统上的所有图像，包括Api图像。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="5083" class="kq jf hi km b fi kr ks l kt ku">docker images</span></pre><p id="e7c8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们应该得到类似这样的输出。</p><figure class="kh ki kj kk fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es kw"><img src="../Images/22b6c7ac3f8d76182112c9a2d115c734.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lRZ799BQDp7VwJHySv_-cg.png"/></div></div></figure><p id="d6ec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了将api映像推送到Docker Hub，我们需要给它一个标签，包括您之前给它的Docker ID。在我的情况下，它是我的名字'斯蒂芬达姆'</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="5dea" class="kq jf hi km b fi kr ks l kt ku">docker tag gcpblog_api stephenadam/gcpblog_api</span></pre><p id="b9de" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在把我们的形象推给Docker Hub。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="e7fb" class="kq jf hi km b fi kr ks l kt ku">docker push stephenadam/gcpblog_api</span></pre><p id="9570" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，默认情况下，该图像将对外部世界公开。Docker Hub允许您免费拥有一个私人图像，当您在自己的网站上工作时，请转到Docker Hub上的图像设置，并将其设置为私人。</p><h1 id="c029" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">设置云环境</h1><p id="f2d2" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">对于这一步，我们需要一个谷歌帐户来访问谷歌云平台，并访问他们提供的3个月/300美元的试用版。</p><p id="6fe8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">登录Google后，请访问以下URL创建一个免费的Google云平台帐户。</p><p id="cd9f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/free/" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/free/</a></p><p id="046e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，让我们进入云控制台并开始工作！</p><p id="dfdc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://console.cloud.google.com/" rel="noopener ugc nofollow" target="_blank">https://console.cloud.google.com/</a></p><p id="f5fc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我们需要创建一个虚拟机来运行我们的网站。在左侧菜单中找到“计算引擎”,然后转到虚拟机实例。虽然运行我们的代码有其他选择，但计算引擎虚拟机是最便宜的选择，并允许我们配置自己的环境。</p><p id="3688" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">谷歌提供了一个免费的虚拟机选项，我们将在这里使用。我们需要在以下位置之一调配f1-micro实例—美国西部1、美国中部1或美国东部1。</p><p id="f6eb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们以后需要支付的唯一选择是每月2.88美元的固定IP。对于一个在GCP的网站来说还不错！</p><figure class="kh ki kj kk fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es le"><img src="../Images/fa9abd60de90dc8cdeb0786fc32b51ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kPxDpj_X-sdhlSK1d9qOxg.png"/></div></div></figure><p id="758c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建一个实例。</p><figure class="kh ki kj kk fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es lf"><img src="../Images/5a4cdcce3c0fc3078f6375edb7fc1b7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JI4AuJ0vPFVZp3pnwCL_tg.png"/></div></div></figure><p id="c5da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们需要配置我们的虚拟机。在本例中，除了以下选项之外，我们将保留所有内容的默认设置:</p><p id="8c3e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">名字:</strong>挑合适的。我去了gcp博客。<br/> <strong class="ih hj">机器类型:</strong>E2-小型。这是一台低功率的机器，但它很便宜，很适合我们的目的。<br/> <strong class="ih hj">防火墙:</strong>这里确保我们允许HTTP和HTTPS访问。</p><figure class="kh ki kj kk fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es lg"><img src="../Images/20e131fb6691218ebf8139b304229033.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zuFVZMiN_2yR6N_CbAv9Dg.png"/></div></div></figure><p id="1b65" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们有高达30g的免费存储空间，因此请转到引导磁盘部分，然后单击“更改”。</p><figure class="kh ki kj kk fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es lh"><img src="../Images/ce248e926a94a77874c42de4b673011a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sjz4nbM0iwU5eWrOA9TZhw.png"/></div></div></figure><p id="1be6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在把磁盘空间增加到30g。</p><figure class="kh ki kj kk fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es li"><img src="../Images/76c62f30bb773c596c4929fae211bc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k9ugDwe-ugC8cI-pQ6uHRQ.png"/></div></div></figure><p id="05af" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您已经成功设置了机器，在设置虚拟机时，您应该会在屏幕右上角看到以下消息。</p><figure class="kh ki kj kk fd kx er es paragraph-image"><div class="er es lj"><img src="../Images/06c7cb99e1cb511f949c7502e3ff0359.png" data-original-src="https://miro.medium.com/v2/resize:fit:1330/format:webp/1*wTAaEc7GwbxLBJgQelcyHw.png"/></div></figure><p id="b04e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在只需点击“创建”按钮来创建您的虚拟机。</p><p id="3be3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">设置交换文件</strong></p><p id="0ae6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们使用的f1-micro只有614兆内存可用。我们可能会在这一点点工作内存上遇到麻烦，所以让我们通过建立一个交换文件来解决这个问题，以防用完。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="f1b4" class="kq jf hi km b fi kr ks l kt ku">sudo fallocate -l 1G /swapfile<br/>sudo chmod 600 /swapfile<br/>sudo mkswap /swapfile<br/>sudo swapon /swapfile<br/>echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab</span></pre><p id="0df4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">在虚拟机上安装Docker</strong></p><p id="bf39" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们已经创建了全新的虚拟机，我们需要在其上安装docker和docker-compose，以便运行我们的应用程序。在计算引擎的“VM instrances”部分，单击SSH选项以打开机器上的命令提示符。</p><figure class="kh ki kj kk fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es lk"><img src="../Images/b4c931abf6c299e6a4eacd88b2535bf6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E3zTKgs_8LP1o95_w6zqNw.png"/></div></div></figure><p id="88e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行以下命令。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="a72e" class="kq jf hi km b fi kr ks l kt ku">sudo apt-get update</span><span id="951e" class="kq jf hi km b fi ll ks l kt ku">sudo apt-get install apt-transport-https ca-certificates curl gnupg-agent software-properties-common</span><span id="3f03" class="kq jf hi km b fi ll ks l kt ku">sudo add-apt-repository “deb [arch=amd64] <a class="ae jd" href="https://download.docker.com/linux/debian" rel="noopener ugc nofollow" target="_blank">https://download.docker.com/linux/debian</a> $(lsb_release -cs) stable”</span><span id="e6be" class="kq jf hi km b fi ll ks l kt ku">sudo apt-get update</span><span id="9bf5" class="kq jf hi km b fi ll ks l kt ku">sudo apt-get install docker-ce docker-ce-cli containerd.io</span></pre><p id="5074" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行sudo 'apt-get update '时，您可能会得到以下错误。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="8274" class="kq jf hi km b fi kr ks l kt ku"><a class="ae jd" href="https://download.docker.com/linux/debian" rel="noopener ugc nofollow" target="_blank">https://download.docker.com/linux/debian</a> buster InRelease<br/> The following signatures couldn’t be verified because the public key is not available: NO_PUBKEY 7EA0A9C3F273FCD8</span></pre><blockquote class="lm ln lo"><p id="9bce" class="if ig kv ih b ii ij ik il im in io ip lp ir is it lq iv iw ix lr iz ja jb jc hb bi translated">apt打包系统有一组可信密钥，它们决定了一个包是否可以被认证，从而可以被信任地安装在系统上。有时系统没有它需要的所有键，并遇到这个问题。幸运的是，有一个快速解决方案。每一个被列为丢失的密钥都需要被添加到apt密钥管理器中，以便它能够认证包。</p></blockquote><p id="5546" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://chrisjean.com/fix-apt-get-update-the-following-signatures-couldnt-be-verified-because-the-public-key-is-not-available/" rel="noopener ugc nofollow" target="_blank">https://Chris jean . com/fix-apt-get-update-the-following-signatures-cannot-be-verified-as-the-public-key-is-not-available/</a></p><p id="126d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了解决这个问题，我们只需要用它抱怨的丢失的键运行下面的命令。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="6b8b" class="kq jf hi km b fi kr ks l kt ku">apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 7EA0A9C3F273FCD8</span></pre><p id="4c3f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">在虚拟机上安装Docker Compose</strong></p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="f746" class="kq jf hi km b fi kr ks l kt ku">sudo curl -L “https://github.com/docker/compose/releases/download/1.28.6/docker-compose-$(uname -s)-$(uname -m)” -o /usr/local/bin/docker-compose</span><span id="2037" class="kq jf hi km b fi ll ks l kt ku">sudo chmod +x /usr/local/bin/docker-compose</span></pre><h1 id="a0d9" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">将网站上传到谷歌的CDN</h1><p id="dac1" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">现在我们已经设置好了我们闪亮的新虚拟机，是时候把我们的网站转移到Google的CDN上了。从CDN存储和访问我们的数据要便宜得多。</p><p id="e20d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了让事情尽可能简单，我们将通过反向代理功能在我们的虚拟机上从NGINX服务器提供我们的CDN文件。</p><p id="15ea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kv">请注意，这在生产设置中远远不理想，因为我们将进行两次跳跃，并失去CDN的许多好处，如降低服务器负载和内容的地理位置。</em></p><p id="b5be" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，让我们在生产模式下构建站点。我们需要更新“GcpBlog \ client \ src \ environments environment . prod . ts”以指向正确的域。在这里，我将它设置为gcpblog.dev。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="e58f" class="kq jf hi km b fi kr ks l kt ku">export const environment = {<br/> production: true,<br/> baseUrl: ‘<a class="ae jd" href="https://gcpblog.dev/api/'" rel="noopener ugc nofollow" target="_blank">https://gcpblog.dev/api/'</a><br/>};</span></pre><p id="e2cb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，在powershell中打开客户端目录，并在生产模式下构建站点。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="18ee" class="kq jf hi km b fi kr ks l kt ku">ng build --prod</span></pre><p id="f647" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们在以下文件夹中有了生产就绪文件。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="7234" class="kq jf hi km b fi kr ks l kt ku">‘GcpBlog\client\dist\client’</span></pre><p id="400c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在进入谷歌云平台，进入左边菜单中的“云存储”。</p><p id="7157" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">单击“创建存储桶”并输入新存储桶的名称。稍后您将需要使用它来配置我们的NGINX服务器。</p><p id="48a0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">选择您的区域设置，然后为存储类别选择“标准”。访问控制应设置为统一，高级设置应保持默认状态。</p><p id="15f4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当出现新的bucket时，单击upload files，选择“GcpBlog\client\dist\client”目录中的所有文件，并将它们上传到我们的新bucket！</p><h2 id="884b" class="kq jf hi bd jg ls lt lu jk lv lw lx jo iq ly lz js iu ma mb jw iy mc md ka me bi translated">设置文件的公共权限</h2><p id="6a59" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">默认情况下，这些文件是私有的。最后一步是让外界看到它们。为此，请执行以下步骤。</p><p id="4855" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">选择页面顶部附近的权限选项卡。</p><ul class=""><li id="ea11" class="mf mg hi ih b ii ij im in iq mh iu mi iy mj jc mk ml mm mn bi translated">单击添加成员按钮。</li><li id="f264" class="mf mg hi ih b ii mo im mp iq mq iu mr iy ms jc mk ml mm mn bi translated">将出现“添加成员”对话框。</li><li id="2242" class="mf mg hi ih b ii mo im mp iq mq iu mr iy ms jc mk ml mm mn bi translated">在“新成员”字段中，输入allUsers。</li><li id="d1b0" class="mf mg hi ih b ii mo im mp iq mq iu mr iy ms jc mk ml mm mn bi translated">在选择角色下拉列表中，选择云存储子菜单，然后单击存储对象查看器选项。</li><li id="8edc" class="mf mg hi ih b ii mo im mp iq mq iu mr iy ms jc mk ml mm mn bi translated">单击保存。</li></ul><figure class="kh ki kj kk fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es mt"><img src="../Images/673f2fc2512efb1a9d920b2cca634e82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Zde2xxILieZme-ayQBk6eg.png"/></div></div></figure><h1 id="832c" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">保留静态IP地址</h1><p id="b294" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">默认情况下，分配给我们虚拟机的IP地址是短暂的，也就是说，它可以随时改变。当我们稍后将我们的域A记录指向VM时，我们将需要一个不会改变的IP地址。</p><p id="d390" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要获取我们的固定IP地址，请转到左侧菜单，从“网络”部分选择“VPC网络”。我们应该会看到我们虚拟机的当前外部端口以及一个“类型”下拉菜单。点击并选择“静态”并给IP地址起个名字。</p><figure class="kh ki kj kk fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es mu"><img src="../Images/70ef2e17bfdae8741ca9ce06a2629b3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*308JIxhzEd38s0D9CpPOfA.png"/></div></div></figure><p id="6848" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们现在应该看到相同的IP地址在列表页面上显示为静态的。</p><figure class="kh ki kj kk fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es mv"><img src="../Images/0d12621f0df13e462c32b636c6bf53e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y-Q2LN5p7XZ-2T3FRmU05A.png"/></div></div></figure><h1 id="f2bd" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">生产码头工人组成</h1><p id="5f2c" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">生产dock-compose文件非常类似于我们在第1部分中用来在本地运行应用程序的compose文件。在我们的解决方案中，可以在“vm-files”文件夹中找到这些文件以及服务器上的其他文件。</p><p id="bed6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里，在将我们的应用程序迁移到虚拟机之前，我将掩盖这些差异。</p><figure class="kh ki kj kk fd kx"><div class="bz dy l di"><div class="mw mx l"/></div></figure><p id="9896" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Postgres数据库</strong></p><p id="338c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行在数据库服务上的Postgres数据库除了volumes语句之外是相同的。当在本地运行我们的示例时，我们没有破坏我们的数据——一旦容器被关闭，对数据库的任何更改都会丢失。</p><p id="9e3c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Volumes选项允许我们在容器和我们正在运行的机器的文件系统之间创建一个链接，并持久化数据。在这里，我们在“database-data”卷和容器上的“var/lib/postgresql/data/”文件夹之间创建了一个链接。机器上数据的物理路径是“/var/lib/docker/volumes/username _ database-data”。</p><p id="fdf3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们可以重启数据库容器并部署更新，而不会丢失存储在其中的任何数据。</p><p id="ea2a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们在合成文件的底部定义了卷。</p><p id="0471" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">。NET Core Web Api </strong></p><p id="6c22" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">ASPNETCORE_ENVIRONMENT变量设置为“Production”而不是“LocalDocker”。这将加载appsettings。Production.json文件与生产数据库连接字符串，而不是本地。</p><p id="a42a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此外，我们不再发布端口，在本地示例中，Angular应用程序直接从我们的主机调用Api。在我们的产品示例中，我们使用NGINX反向代理来处理所有传入的请求，这意味着对api的调用将与我们的应用程序代码到达相同的URL和端口。这意味着我们不需要向外界公开Api的端口。稍后在NGINX部分会有更多的介绍！</p><p id="9649" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">再往下看，我们看到两个新的服务，certbot和nginx。这两者都值得一个适当的解释，并涵盖如下。</p><p id="b550" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里有一个提示，它是如何组合在一起的。</p><figure class="kh ki kj kk fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es my"><img src="../Images/461c502c1e0c818920f1325cc3fc46ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ks9W-E4-X1kQmHH1Dxn9bQ.png"/></div></div></figure><h1 id="6578" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">通过WinSCP访问虚拟机上的文件</h1><p id="85a6" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">这个过程的下一步需要我们在服务器上编辑文件，我们很快也需要上传文件，所以现在是设置WinSCP的好时机。</p><blockquote class="lm ln lo"><p id="2ea9" class="if ig kv ih b ii ij ik il im in io ip lp ir is it lq iv iw ix lr iz ja jb jc hb bi translated"><strong class="ih hj">WinSCP</strong>(<strong class="ih hj"><em class="hi">Win</em></strong><em class="hi">dows</em><strong class="ih hj"><em class="hi">S</em></strong><em class="hi">ecure</em><strong class="ih hj"><em class="hi">C</em></strong><em class="hi">o</em><strong class="ih hj"><em class="hi">p</em></strong><em class="hi">y</em>是一个<a class="ae jd" href="https://en.wikipedia.org/wiki/Free_and_open-source_software" rel="noopener ugc nofollow" target="_blank">免费开源的</a> <a class="ae jd" href="https://en.wikipedia.org/wiki/SSH_File_Transfer_Protocol" rel="noopener ugc nofollow" target="_blank"> SSH文件传输协议</a> (SFTP)、</p></blockquote><p id="3dab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">WinScp让我们在虚拟机上上传、下载和编辑文件。从这里下载并安装它。</p><div class="mz na ez fb nb nc"><a href="https://winscp.net/eng/download.php" rel="noopener  ugc nofollow" target="_blank"><div class="nd ab dw"><div class="ne ab nf cl cj ng"><h2 class="bd hj fi z dy nh ea eb ni ed ef hh bi translated">WinSCP::官方网站::下载</h2><div class="nj l"><h3 class="bd b fi z dy nh ea eb ni ed ef dx translated">WinSCP 5.17是一个重要的应用程序更新。新的特性和增强包括:对会话和…</h3></div><div class="nk l"><p class="bd b fp z dy nh ea eb ni ed ef dx translated">winscp.net</p></div></div><div class="nl l"><div class="nm l nn no np nl nq lc nc"/></div></div></a></div><p id="cb61" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们还需要生成一个公钥和一个私钥。PuTTYgen是一个很好的工具，所以让我们下载并安装它吧。</p><div class="mz na ez fb nb nc"><a href="https://www.ssh.com/academy/ssh/putty/windows/puttygen" rel="noopener  ugc nofollow" target="_blank"><div class="nd ab dw"><div class="ne ab nf cl cj ng"><h2 class="bd hj fi z dy nh ea eb ni ed ef hh bi translated">如何安装和使用puttygen来创建新的密钥对和更改密码。正在安装钥匙…</h2><div class="nj l"><h3 class="bd b fi z dy nh ea eb ni ed ef dx translated">这个页面是关于在Windows上安装PuTTYgen的。对于Linux版本，请参见。PuTTYgen是一个关键的生成器工具，用于创建…</h3></div><div class="nk l"><p class="bd b fp z dy nh ea eb ni ed ef dx translated">www.ssh.com</p></div></div><div class="nl l"><div class="nr l nn no np nl nq lc nc"/></div></div></a></div><p id="7cbb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先让我们创建ssh密钥对。打开PuTTYgen并点击generate。然后在关键评论字段中输入您的Google帐户名称。这与我们在终端上使用的SSH终端中显示的用户名相同。</p><figure class="kh ki kj kk fd kx er es paragraph-image"><div class="er es ns"><img src="../Images/c31fb50b74af270654b47223e4d949e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1162/format:webp/1*xamNDmU0fW1diuZPKP518w.png"/></div><figcaption class="nt nu et er es nv nw bd b be z dx">GCP Username</figcaption></figure><p id="9c76" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们需要保存两把钥匙。首先，将框顶部的公钥复制并粘贴到一个文本文件中，标题为“用于粘贴到OpenSSH authorised _ keys文件中的公钥”，并确保其安全。接下来单击保存私钥，将它保存在与上一步中的公钥相同的位置，并选择不使用密码保护它的选项。</p><figure class="kh ki kj kk fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es nx"><img src="../Images/3fdf542d693749499c8021bee913dd39.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Rj41iAuFZLFS2Z6ssjYf3A.png"/></div></div><figcaption class="nt nu et er es nv nw bd b be z dx">PuTTY Key Generator</figcaption></figure><p id="5e87" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们有了我们的密钥对，是时候把它放到谷歌云平台上公开了。从GCP左侧菜单的计算引擎部分选择元数据。</p><figure class="kh ki kj kk fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es ny"><img src="../Images/7e30135e5d6f7fb0c6dce81b39bd8482.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9UXI56NF8oQYdRHqu-is3g.png"/></div></div></figure><p id="18d3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在在顶部导航中选择SSH，并添加我们在上一步中刚刚保存的公钥。</p><figure class="kh ki kj kk fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es nz"><img src="../Images/e3f8c5d41b4546abecc603eae7a61b4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tUC2ZJAkcWKVxRunB2FQqA.png"/></div></div></figure><p id="21a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过在我们的计算实例上设置公共ssh密钥，我们现在可以使用WinSCP和私有密钥访问虚拟机上的文件。</p><p id="66b5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">打开WinSCP并选择“新会话”。单击新站点，输入名称，将虚拟机的IP地址添加到“主机名”部分，并在用户名字段中输入您的GCP用户名。</p><p id="1c6f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们使用私钥来访问我们的虚拟机，选择“高级”，然后从出现的窗口中选择“身份验证”。接下来，选择私钥文件并点击“确定”。</p><figure class="kh ki kj kk fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es oa"><img src="../Images/e13fa27390358ded01f6b00451b77eeb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SqlPfAyOZ553qoawiT4vnw.png"/></div></div></figure><p id="4399" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">设置完成。点击保存，然后在选择网站后点击登录，我们将能够访问和上传文件到服务器上！</p><h1 id="bb46" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">NGINX</h1><p id="9fee" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">NGINX是一个免费的速度极快的web服务器，我们将使用它来托管我们的应用程序并充当反向代理。上面docker-compose文件中的“命令”确保每6个小时重新加载一次可能已经被certbot更新的SSL证书。</p><p id="6d1b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">除了指向证书和挑战请求数据的卷之外，我们还指向运行应用程序的配置文件。现在让我们深入探讨一下。</p><figure class="kh ki kj kk fd kx"><div class="bz dy l di"><div class="mw mx l"/></div></figure><p id="49dd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">配置的第一部分是上游语句。这用于定义proxy_pass可以引用的服务器组。这里我们引用运行api的容器。在docker compose中运行的服务集内，我们可以使用它们的服务名来寻址它们，在本例中是在端口880上运行的“api”。我们在第二台服务器的底部使用它来代理进入我们的域的请求，将以下模式‘gcpblog . dev/api’匹配到我们的API应用程序。</p><p id="da69" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来我们有我们的第一个服务器块，这些类似于Apache的虚拟主机。这里我们列出了端口80上对gcpblog.dev的传入http请求。第一个位置块句柄返回加密所需的质询数据，以证明域的所有权。我们需要通过http提供这个，因为此时我们还没有设置SSL证书。</p><p id="53ed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下语句确保使用301代码将对站点http版本的任何其他请求重定向到站点的https版本。</p><p id="5b2d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面的服务器块处理从端口443传入的https请求。我们包括到ssl证书的路径，我们将在下一步中设置该证书以及其他相关的ssl配置。</p><p id="3120" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们为在前面的步骤中上传到gcp bucket的网站文件设置代理配置。我们的位置陈述越具体，优先级越高。</p><p id="aa29" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第一个语句使用了一个特殊的语法，这意味着任何直接进入gcpblog.dev域的请求都会被转发到我们的bucket上的index.html文件，并加载我们的angular应用程序。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="5201" class="kq jf hi km b fi kr ks l kt ku">location = / {     <br/>proxy_pass <a class="ae jd" href="https://storage.googleapis.com/gcpblog-bucket/index.html;" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/gcpblog-bucket/index.html;</a>    <br/>}</span></pre><p id="a38f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这条语句提供了我们需要的文件，映射了我们在bucket上托管的任何css、javascript和图像文件。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="e9a2" class="kq jf hi km b fi kr ks l kt ku">location / { <br/>proxy_pass <a class="ae jd" href="https://storage.googleapis.com/gcpblog-bucket/;" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/gcpblog-bucket/;</a> <br/>}</span></pre><p id="7b0d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们现在确实有一个路径问题，如果我们使用Angular在应用程序中导航到<a class="ae jd" href="https://www.gcpblog.dev/add-article" rel="noopener ugc nofollow" target="_blank">https://www.gcpblog.dev/add-article</a>页面，然后按F5刷新页面，那么GCP桶将不知道如何处理该路径，因为它在服务器上不存在。我们需要做的是将它和应用程序上的所有其他路由重定向到index.html文件，并让Angular处理路由。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="4dff" class="kq jf hi km b fi kr ks l kt ku">location /add-post { <br/>proxy_pass <a class="ae jd" href="https://storage.googleapis.com/gcpblog-bucket/index.html;" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/gcpblog-bucket/index.html;</a> }</span></pre><p id="afe1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你还记得第一篇文章，我们的文章有一个seo友好的url，标题变成了一个slug，用来标识它们，比如'【https://www.gcpblog.dev/】T2article/angular-11/'？</p><p id="e4f0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面一行匹配任何符合“/article/”后跟任何字符的模式的传入请求。然后，我们使用一个重写规则来获取该路径，并将其重写为/index.html，然后将其传递给proxy_pass指令。它用来停止处理并传递结果的最后一条语句。</p><p id="14ca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我们不采取这些步骤，那么域之后的路径的所有部分将通过代理传递指令传递到存储桶，我们将得到一个错误。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="0f35" class="kq jf hi km b fi kr ks l kt ku">location /article { <br/>rewrite ^/blog/(.*)$ /index.html last; <br/>proxy_pass <a class="ae jd" href="https://storage.googleapis.com/gcpblog-bucket/index.html;" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/gcpblog-bucket/index.html;</a> }</span></pre><p id="aae1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，最后一个location语句用于将任何请求传递给api，并将它们与路径的任何部分一起传递给我们的api，我们在前面的upstream指令中定义了该API。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="3ff3" class="kq jf hi km b fi kr ks l kt ku">location /api/ { <br/>   proxy_pass <a class="ae jd" href="http://web-api/;" rel="noopener ugc nofollow" target="_blank">http://web-api/;</a> <br/>}</span></pre><h1 id="ee24" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">让我们加密、认证和启用HTTPS</h1><p id="bb53" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">理想情况下，所有的网站都应该运行https，为了安全，seo和让你的用户安心。在这里，我们深入探讨如何为您的站点获得免费的SSL证书，并在当前证书过期时自动检索新证书。</p><p id="4232" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我想借此机会感谢<a class="ob oc ge" href="https://medium.com/u/524783b33278?source=post_page-----a8b32167e183--------------------------------" rel="noopener" target="_blank"> Philipp </a>就这个问题写了一篇精彩的文章，我用这篇文章弄清楚了这一切。当我浏览这个的时候，我强烈建议你通读一下他的文章，这篇文章很有深度，可以帮助你解决你可能遇到的任何问题。</p><div class="mz na ez fb nb nc"><a href="https://pentacent.medium.com/nginx-and-lets-encrypt-with-docker-in-less-than-5-minutes-b4b8a60d3a71" rel="noopener follow" target="_blank"><div class="nd ab dw"><div class="ne ab nf cl cj ng"><h2 class="bd hj fi z dy nh ea eb ni ed ef hh bi translated">Nginx和让我们用Docker加密不到5分钟</h2><div class="nj l"><h3 class="bd b fi z dy nh ea eb ni ed ef dx translated">让Nginx在docker-compose环境中运行Let's Encrypt比你想象的要复杂得多…</h3></div><div class="nk l"><p class="bd b fp z dy nh ea eb ni ed ef dx translated">pentacent.medium.com</p></div></div><div class="nl l"><div class="od l nn no np nl nq lc nc"/></div></div></a></div><p id="5030" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Let's Encrypt是一个免费的、自动化的、开放的认证机构。为了使用这项服务并自动化大部分流程，我们将使用certbot映像。</p><blockquote class="lm ln lo"><p id="e173" class="if ig kv ih b ii ij ik il im in io ip lp ir is it lq iv iw ix lr iz ja jb jc hb bi translated">Certbot是一个免费的开源软件工具，可以自动使用<a class="ae jd" href="https://letsencrypt.org/" rel="noopener ugc nofollow" target="_blank">手动管理的网站上的</a>证书来启用HTTPS。</p></blockquote><p id="2c7b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://certbot.eff.org/about/" rel="noopener ugc nofollow" target="_blank">https://certbot.eff.org/about/</a></p><p id="8300" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，让我们再次查看docker compose文件，看看我们需要添加什么来使它工作。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="6d8c" class="kq jf hi km b fi kr ks l kt ku">certbot:<br/>  image: certbot/certbot<br/>  restart: unless-stopped<br/>  volumes:<br/>    — ./data/certbot/conf:/etc/letsencrypt<br/>    — ./data/certbot/www:/var/www/certbot <br/>  entrypoint: “/bin/sh -c ‘trap exit TERM; while :; do certbot renew; sleep 12h &amp; wait $${!}; done;’”<br/> nginx:<br/>   image: nginx:1.15-alpine<br/>   restart: unless-stopped<br/>   volumes:<br/>     — ./data/nginx:/etc/nginx/conf.d<br/>     — ./data/certbot/conf:/etc/letsencrypt<br/>     — ./data/certbot/www:/var/www/certbot<br/>   ports:<br/>     — “80:80”<br/>     — “443:443”<br/>    command: ‘/bin/sh -c ‘’while :; do sleep 6h &amp; wait $${!}; nginx -s reload; done &amp; nginx -g “daemon off;”’’’</span></pre><p id="b504" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我们指定certbot服务映像，并确保在出错时重新启动它。接下来，我们创建两个由certbot和nginx使用的共享卷。</p><p id="3cff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了让“让我们加密”验证您对域的控制，它会发出一个挑战请求。这个挑战数据需要由certbot创建并由我们的NGINX服务器提供服务。我们还需要通过NGINX提供我们的SSL证书。这就是为什么我们让NGINX和certbot服务共享这两个卷。</p><p id="ca20" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下一行是certbot服务中的“入口点”。默认情况下，certbot服务不会自动续订我们的证书，该行通过每12小时检查我们的证书是否即将过期并在过期时进行续订来解决这个问题。</p><p id="096e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们确实有一个问题，但是我们需要创建一个伪证书。来自<a class="ob oc ge" href="https://medium.com/u/524783b33278?source=post_page-----a8b32167e183--------------------------------" rel="noopener" target="_blank">菲利普</a>的文章。</p><blockquote class="lm ln lo"><p id="6863" class="if ig kv ih b ii ij ik il im in io ip lp ir is it lq iv iw ix lr iz ja jb jc hb bi translated">现在是棘手的部分。我们需要nginx来执行Let's Encrypt验证，但是如果证书丢失，nginx将不会启动。</p><p id="dd03" class="if ig kv ih b ii ij ik il im in io ip lp ir is it lq iv iw ix lr iz ja jb jc hb bi translated">那我们该怎么办？创建一个伪证书，启动nginx，删除伪证书并请求真正的证书。<br/>幸运的是，你不必手动完成所有这些，我为此创建了一个方便的脚本。</p></blockquote><p id="00c7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">SSH到我们的虚拟机上，执行下面的语句来下载他的脚本。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="6068" class="kq jf hi km b fi kr ks l kt ku">curl -L <a class="ae jd" href="https://raw.githubusercontent.com/wmnnd/nginx-certbot/master/init-letsencrypt.sh" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/wmnnd/nginx-certbot/master/init-letsencrypt.sh</a> &gt; init-letsencrypt.sh</span></pre><h1 id="8734" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">直播！</h1><p id="d919" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">现在我们需要使用WinSCP来编辑服务器上的init-letsencrypt.sh shell脚本文件。</p><p id="4377" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在WinSCP中打开站点，右键单击“init-letsencrypt.sh”文件上的“编辑”。现在找到域名行，添加你的域名而不是example.com。比如说。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="f923" class="kq jf hi km b fi kr ks l kt ku">domains=(gcpblog.dev <a class="ae jd" href="http://www.example.org)" rel="noopener ugc nofollow" target="_blank">www.gcpblog.dev)</a></span></pre><p id="ffc1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，使用WinSCP将“vm-files”文件夹中的所有文件和数据文件夹上传到vm上的默认文件夹。</p><figure class="kh ki kj kk fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es oe"><img src="../Images/a2b5ad887c3adbc8dfdbb2839d598a4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H8otuwKv5QR8a9tv3Dp3kQ.png"/></div></div></figure><p id="172c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来编辑以下文件夹中的app.conf文件，并将server_name的两个实例更改为您正在使用的域。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="7e8f" class="kq jf hi km b fi kr ks l kt ku">GcpBlog\vm-files\data\nginx\app.conf</span></pre><p id="19ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后更新SSL证书路径以匹配域名。比如说。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="4cea" class="kq jf hi km b fi kr ks l kt ku">ssl_certificate /etc/letsencrypt/live/gcpblog.dev/fullchain.pem;<br/>ssl_certificate_key /etc/letsencrypt/live/gcpblog.dev/privkey.pem;</span></pre><p id="ffad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在将您的域指向服务器上的一条记录。</p><figure class="kh ki kj kk fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es of"><img src="../Images/39cf4a0484f6156add67fbbb2e4bad1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dw5QXpd5lqIXsQVhxWfBSA.png"/></div></div></figure><p id="9e86" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦我们等待了记录更新的传播，就到了获取SSL证书的时候了。</p><p id="6fe0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先登录虚拟机上的docker，这样我们就可以下载我们的api映像。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="e1da" class="kq jf hi km b fi kr ks l kt ku">docker login</span></pre><p id="7e1f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在设置脚本文件的执行权限。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="4b7d" class="kq jf hi km b fi kr ks l kt ku">chmod +x init-letsencrypt.sh.</span></pre><p id="421e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后通过运行以下命令获得我们的证书。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="6ce8" class="kq jf hi km b fi kr ks l kt ku">sudo ./init-letsencrypt.sh</span></pre><p id="c3cf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您现在应该会收到一条成功消息，说明已经为您的域正确生成了证书。</p><p id="3995" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们只需要通过Docker Compose打开我们的容器来启动站点。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="cd0e" class="kq jf hi km b fi kr ks l kt ku">docker-compose up</span></pre><p id="5364" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，当你导航到你的领域，你应该看到网站！</p><figure class="kh ki kj kk fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es og"><img src="../Images/6dc87c74614fa395ab65c7506a13d6d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P7F6achX8JOCzUwFPMdLBQ.png"/></div></div></figure><h1 id="87fb" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">参考资料和进一步阅读</h1><div class="mz na ez fb nb nc"><a href="https://chrisjean.com/fix-apt-get-update-the-following-signatures-couldnt-be-verified-because-the-public-key-is-not-available/" rel="noopener  ugc nofollow" target="_blank"><div class="nd ab dw"><div class="ne ab nf cl cj ng"><h2 class="bd hj fi z dy nh ea eb ni ed ef hh bi translated">修复apt-get更新“无法验证以下签名，因为公钥不是…</h2><div class="nj l"><h3 class="bd b fi z dy nh ea eb ni ed ef dx translated">apt打包系统有一组可信任的密钥，用于确定包是否可以被认证，因此…</h3></div><div class="nk l"><p class="bd b fp z dy nh ea eb ni ed ef dx translated">chrisjean.com</p></div></div></div></a></div><div class="mz na ez fb nb nc"><a href="https://pentacent.medium.com/nginx-and-lets-encrypt-with-docker-in-less-than-5-minutes-b4b8a60d3a71" rel="noopener follow" target="_blank"><div class="nd ab dw"><div class="ne ab nf cl cj ng"><h2 class="bd hj fi z dy nh ea eb ni ed ef hh bi translated">Nginx和让我们用Docker加密不到5分钟</h2><div class="nj l"><h3 class="bd b fi z dy nh ea eb ni ed ef dx translated">让Nginx在docker-compose环境中运行Let's Encrypt比你想象的要复杂得多…</h3></div><div class="nk l"><p class="bd b fp z dy nh ea eb ni ed ef dx translated">pentacent.medium.com</p></div></div><div class="nl l"><div class="od l nn no np nl nq lc nc"/></div></div></a></div><div class="mz na ez fb nb nc"><a rel="noopener follow" target="_blank" href="/@hbmy289/how-to-set-up-a-free-micro-vps-on-google-cloud-platform-bddee893ac09"><div class="nd ab dw"><div class="ne ab nf cl cj ng"><h2 class="bd hj fi z dy nh ea eb ni ed ef hh bi translated">如何在谷歌云平台上设置免费的micro VPS</h2><div class="nj l"><h3 class="bd b fi z dy nh ea eb ni ed ef dx translated">在谷歌云平台上配置“永远免费”的虚拟专用服务器(VPS)</h3></div><div class="nk l"><p class="bd b fp z dy nh ea eb ni ed ef dx translated">medium.com</p></div></div><div class="nl l"><div class="oh l nn no np nl nq lc nc"/></div></div></a></div><div class="mz na ez fb nb nc"><a href="https://redstapler.co/cost-of-hosting-wordpress-website-on-google-cloud/" rel="noopener  ugc nofollow" target="_blank"><div class="nd ab dw"><div class="ne ab nf cl cj ng"><h2 class="bd hj fi z dy nh ea eb ni ed ef hh bi translated">Google Cloud f1-micro Instance能处理多少流量|红色订书机</h2><div class="nj l"><h3 class="bd b fi z dy nh ea eb ni ed ef dx translated">因为谷歌已经提供了他们的“永远免费”层的改进版本，在他们的云上托管网站…</h3></div><div class="nk l"><p class="bd b fp z dy nh ea eb ni ed ef dx translated">redstapler.co</p></div></div><div class="nl l"><div class="oi l nn no np nl nq lc nc"/></div></div></a></div></div></div>    
</body>
</html>