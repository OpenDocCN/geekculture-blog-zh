<html>
<head>
<title>Part 18: How to write SQL Query to Find all those wines which contain specific aromas</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">第18部分:如何编写SQL查询来查找所有含有特定香味的葡萄酒</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/how-to-write-sql-query-to-find-all-those-wines-which-contain-specific-aromas-9cc4d8f87242?source=collection_archive---------8-----------------------#2022-11-11">https://medium.com/geekculture/how-to-write-sql-query-to-find-all-those-wines-which-contain-specific-aromas-9cc4d8f87242?source=collection_archive---------8-----------------------#2022-11-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="dad3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">数据科学家的角色非常广泛，这让候选人有些不知所措。SQL是任何有抱负的数据科学家的必备工具。为了以最有效的方式学习SQL，您必须练习如何解决查询。在本文中，我们将回答一个面试问题，并尝试使用多种方法来解决这个问题:<strong class="ih hj">找出所有生产具有李子、樱桃、玫瑰或榛子香味的葡萄酒的葡萄酒庄。</strong></p><p id="f163" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个SQL问题来自StrataScratch平台，该平台提供了基于产品的公司在数据科学角色面试中询问的多种编码和非编码问题。你可以在这里查看问题<a class="ae jd" href="https://platform.stratascratch.com/coding/10026-find-all-wineries-which-produce-wines-by-possessing-aromas-of-plum-cherry-rose-or-hazelnut?code_type=1" rel="noopener ugc nofollow" target="_blank">并跟着文章练习。Stratascratch上的每一个编码问题，在MySQL，和Postgres中都可以解决。</a></p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/4cc18f7a8d402bc2585b5d144c002a82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*t2DfOEHKGf8bBRVr.jpg"/></div></div></figure><p id="a45f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">我们来理解一下这个问题:</strong></p><p id="76c0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们被要求找出所有生产具有李子、樱桃、玫瑰或榛子香味的葡萄酒的酒厂。下表中的描述字段包含了葡萄酒香气的详细信息，因此，我们必须在描述字段中搜索相关的特定香气。我们必须只选择那些描述字段包含以下任何香味的葡萄酒厂名称:<strong class="ih hj">李子、樱桃、玫瑰或榛子。</strong></p><p id="56b7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您必须使用table: winemag_p1来解决这个问题。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es jq"><img src="../Images/c9b16024910f1998f8569c68473cb1e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:944/0*3uxHnAkCsuct93P8.JPG"/></div></div></figure><p id="a27b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">winepag_mg1表中几个字段的预览:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es jr"><img src="../Images/423bbf66b60e337256da0906c9bb7097.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Zt81qT454vLxm06k.JPG"/></div></div></figure><p id="03fc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">【LIKE和SIMILAR TO运算符的问题:</p><p id="3f70" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="js">这个问题看似直白。如果您熟悉一些基本的SQL概念，那么您会认为可以使用类似于</em>  <em class="js">运算符的</em><strong class="ih hj"><em class="js"/></strong><em class="js">或</em> <strong class="ih hj"> <em class="js">来解决这个问题。以下查询返回酒厂“carpenìMalvolti ”,因为描述字段“Prosecco”包含子字符串“rose”。% sign round %rose%搜索那些以玫瑰为前缀或后缀的任意数量的字符或空格的记录，因此，与酒厂的描述字段carpeníMalvolti '中的' Prosecco '匹配并返回它。</em></strong></p><pre class="jf jg jh ji fd jt ju jv jw aw jx bi"><span id="6d56" class="jy jz hi ju b fi ka kb l kc kd"><strong class="ju hj"><em class="js">select distinct winery<br/>from winemag_p1<br/>where lower(description) like ‘%plum%’or lower(description) like ‘%cherry%’ <br/> or lower(description) like ‘%rose%’or lower(description);</em></strong></span></pre><p id="975f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="js">类似于</em>  <em class="js">的</em> <strong class="ih hj"> <em class="js">运算符也没有提供正确的结果，并返回酒厂“carpenìMalvolti”，因为其描述字段包含“Prosecco”。</em></strong></p><pre class="jf jg jh ji fd jt ju jv jw aw jx bi"><span id="0d91" class="jy jz hi ju b fi ka kb l kc kd"><strong class="ju hj"><em class="js">select distinct winery<br/>from winemag_p1<br/>where lower(description) similar to ‘(%plum%|%cherry%|%rose%|%hazelnut%)’</em></strong><em class="js">;</em></span></pre><p id="590a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当香味与部分词语搭配时，问题就出现了，就像玫瑰与普罗塞克搭配一样。这个问题可以使用精确的全词匹配来解决，这可以通过在想要的香味周围创建词边界来完成。</p><p id="8a8d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="js">什么是字界？</em> </strong></p><p id="7506" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">单词边界匹配其中一侧是单词字符(通常是字母、数字或下划线，而另一侧不是单词字符(例如，它可能是标点符号或空格字符)的位置。当您想要单独匹配一系列字母(或数字)时，或者当您想要确保它们出现在一系列字符的开头或结尾时，单词边界非常有用。</p><p id="ff37" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">问题解答在下面的MySQL和Postgres中讨论。</p><p id="c9a0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> MySQL解决方案:</strong></p><p id="66fa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="js">MySQL中用于regex的单词边界可以使用元字符\\b形成。regex</em><strong class="ih hj"><em class="js">\ \ brose \ \ b</em></strong><em class="js">因此将与红玫瑰<em class="js">中的</em>玫瑰匹配，但不会在</em>散文、prosecco或rosette <em class="js">中匹配。当其中一个边界被移除时，</em><strong class="ih hj"><em class="js">\ \ brose</em></strong><em class="js">将匹配玫瑰图<em class="js">中的</em> rose，</em><strong class="ih hj"><em class="js">rose \ \ b</em></strong><em class="js">将匹配散文中的</em> rose，<em class="js">但不反之。然而，</em><strong class="ih hj"><em class="js">\ \ brose \ \ b</em></strong><em class="js">将不会匹配</em> rose in _roset或rose21 <em class="js">，因为下划线和字母之间或者字母和数字之间没有边界:这些都是regex定义为单词字符的一部分。</em></p><p id="62b0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="js">问题中给出了香气以单数形式出现，因此我们不需要检查香气的复数形式。因此，我们可以使用MySQL中的word boundary:</em>编写查询来匹配任何李子、樱桃、玫瑰或榛子的香味</p><pre class="jf jg jh ji fd jt ju jv jw aw jx bi"><span id="4d1d" class="jy jz hi ju b fi ka kb l kc kd"><strong class="ju hj"><em class="js">select distinct winery<br/>FROM winemag_p1<br/>where lower(description) REGEXP ‘\\b(plum|rose|cherry|hazelnut)\\b’;</em></strong></span></pre><p id="ab9b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="js">另一种创建自定义字边界的方法:</em> </strong></p><p id="6d2a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="js">我们可以通过限制模式来创建自定义的单词边界，使其不能以任何字母字符开头或结尾。我们可以在模式的开头和结尾使用正则表达式(^a-z)来指定这个条件，以便将指定的模式作为一个完整的单词来匹配:</em></p><pre class="jf jg jh ji fd jt ju jv jw aw jx bi"><span id="0c84" class="jy jz hi ju b fi ka kb l kc kd"><strong class="ju hj"><em class="js">select distinct winery<br/>FROM winemag_p1<br/>where lower(description) REGEXP ‘([^a-z])(plum|rose|cherry|hazelnut)([^a-z])’;</em></strong></span></pre><p id="aac5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Postgres解答:</strong></p><p id="7e63" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="js">在Postgres中，有两种方法可以解决问题。第一种方法是使用正则表达式解决问题，另一种方法是使用特定于Postgres的数据类型tsvector和tsquery。下面将详细讨论这两种方法:</em></p><p id="8817" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">方法1:使用POSIX正则表达式:</strong></p><p id="a633" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">POSIX正则表达式比LIKE、SIMILAR TO和ILIKE更强大。我们可以使用POSIX正则表达式进行精确的模式匹配。 <strong class="ih hj"> <em class="js">约束解除</em> </strong> <em class="js"> \y可用于在模式周围创建单词边界，以匹配Postgres中单词的开头或结尾。使用escape \y约束，下面的查询将不会返回与部分单词匹配的记录。我们可以使用波浪符号~来匹配以下任何一种使用正则表达式的香味:</em> <strong class="ih hj"> <em class="js">李子、樱桃、玫瑰或榛子。我们可以编写以下查询来获取酒厂名称:</em> </strong></p><pre class="jf jg jh ji fd jt ju jv jw aw jx bi"><span id="8f78" class="jy jz hi ju b fi ka kb l kc kd"><strong class="ju hj"><em class="js">SELECT DISTINCT winery<br/>FROM winemag_p1<br/>WHERE lower(description) ~ ‘\y(plum|cherry|rose|hazelnut)\y’;</em></strong></span></pre><p id="ff06" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="js">创建自定义字边界的另一种方式:</em> </strong></p><p id="6863" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="js">这是另一种创建自定义单词边界的方法，和MySQL一样，如果我们可以限制模式，使其不能以任何字母字符开头或结尾。我们可以在模式的开头和结尾使用正则表达式(^a-z)来指定这个条件，以将指定的模式作为一个完整的单词来精确匹配:</em></p><pre class="jf jg jh ji fd jt ju jv jw aw jx bi"><span id="ffa2" class="jy jz hi ju b fi ka kb l kc kd"><strong class="ju hj"><em class="js">select distinct winery<br/>FROM winemag_p1<br/>where lower(description) ~ ‘([^a-z])(plum|rose|cherry|hazelnut)([^a-z])’;</em></strong></span></pre><p id="79fa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">方法2:使用to_tsvector()和to_tsquery(): </strong></p><p id="8112" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="js"> PostgreSQL提供了两种支持全文搜索的数据类型:tsvector和tsquery。tsvector类型表示文本搜索优化格式的文档，而tsquery类型表示文本查询。要实现全文搜索，必须提供一个从文档生成tsvector和从用户查询生成tsquery的函数。</em></p><p id="6f5c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"><em class="js">Postgres中的to_tsvector()和to _ ts vector():</em></strong></p><p id="41dd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="js">为了将文档转换为tsvector数据类型，PostgreSQL提供了to tsvector函数。to_tsvector()函数将文本文档解析为标记，将标记转换为词位，并返回一个tsvector，其中包含词位列表及其在文档中的位置。to_tsquery()是“文本搜索查询”的缩写，它将查询字符串转换成“标记”进行匹配。这一步非常关键，因为我们需要“模糊匹配”关键词。例如，如果用户搜索“eggs”，并且一列包含值“egg”，我们可能仍然会返回一个匹配。</em></p><p id="c4a2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="js">当我们对description应用to_tsvector()并对' plum | cherry | rose |榛子'应用to_tsquery()时，我们得到tsvector和tsquery数据类型作为以下查询的输出。</em></p><pre class="jf jg jh ji fd jt ju jv jw aw jx bi"><span id="77ae" class="jy jz hi ju b fi ka kb l kc kd"><strong class="ju hj"><em class="js">select id,winery, to_tsvector(description), <br/>to_tsquery(‘plum|cherry|rose|hazelnut’) from winemag_p1;</em></strong></span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es ke"><img src="../Images/407a7db220cee2312134f9c400cefc1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Yl45Nc7byqwOiMYh.JPG"/></div></div></figure><p id="cad2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="js">对于全文搜索,@@符号代表“匹配”符号。它返回to_tsvector()和to_tsquery()结果之间的任何匹配。某些描述字段包含“/”，因此替换为空格。然后，我们将在description字段上使用to_tsvector()和在aromas </em> <strong class="ih hj"> <em class="js"> </em>上使用to_tsquery()来匹配以下查询中的任何一个，以查找所有的葡萄酒厂:</strong></p><pre class="jf jg jh ji fd jt ju jv jw aw jx bi"><span id="984c" class="jy jz hi ju b fi ka kb l kc kd"><strong class="ju hj"><em class="js">select winery from winemag_p1 <br/>where to_tsvector(replace(description, ‘/’, ‘ ‘) ) @@ <br/>to_tsquery(‘plum|cherry|rose|hazelnut’);</em></strong></span></pre><p id="2788" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="js"> to_tsvector()和to_tsquery()也可以搜索，即使香味</em> </strong> <em class="js">李子、樱桃、玫瑰或榛子以复数形式出现。</em></p><p id="9d7c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">最终输出预览:</strong></p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es kf"><img src="../Images/9d0a4b6e2487a8978747bc70e5879b4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1140/format:webp/1*2qvzrLDYtOKzX4C_TpgHBg.jpeg"/></div></figure><h1 id="5ae5" class="kg jz hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">结论:</h1><p id="7080" class="pw-post-body-paragraph if ig hi ih b ii ld ik il im le io ip iq lf is it iu lg iw ix iy lh ja jb jc hb bi translated">在这篇文章中，我们看到了几种数据提取工具解决同一个查询的各种方法。由于LIKE、ILIKE和SIMILAR TO操作符都有问题，所以我们不能使用它们来产生预期的结果。因此，为了获得想要的结果，我们使用了正则表达式。</p><p id="ee8a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这篇文章的要点如下:</p><p id="0c90" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">关键要点:</strong></p><p id="6da6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">1.对于模式匹配，正则表达式比LIKE、ILIKE和SIMILAR操作符更强大。</p><p id="4fcb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.在MySQL和Postgres的正则表达式中，可以使用单词边界元字符进行全词匹配。</p><p id="6d55" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.Postgres函数to_tsvector()和to_tsquery()使模式搜索比正则表达式更健壮、更快，因为它们在单个查询中搜索模式的多个变体。</p><p id="9b2e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正则表达式是一个强大的工具，可以在SQL函数中用来提取和匹配字段模式。它是强大的数据提取、清理和验证工具，尤其是在处理文本数据时。</p><p id="eb5a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你喜欢读这篇文章，请鼓掌，评论，并关注我的媒体，继续关注即将到来的文章。</p></div></div>    
</body>
</html>