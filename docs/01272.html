<html>
<head>
<title>Deploying a Vue and Node Application to AWS Elastic Beanstalk</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Vue和节点应用程序部署到AWS Elastic Beanstalk</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/deploying-a-vue-and-node-application-to-aws-elastic-beanstalk-954a11c4ab51?source=collection_archive---------6-----------------------#2021-04-04">https://medium.com/geekculture/deploying-a-vue-and-node-application-to-aws-elastic-beanstalk-954a11c4ab51?source=collection_archive---------6-----------------------#2021-04-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/215505281aa00ca43b057fa80eca6279.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5fJ6HQ4Vsg-fvZXXKok5HQ.png"/></div></div></figure><p id="cce2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">第一次在前端部署Vue.js，在后端部署Node.js的web应用程序可能是一项艰巨的任务。这需要阅读和理解AWS的一些细节来解决我在这个过程中遇到的一些问题。我采用了一种方法，将VueJS和NodeJS捆绑在一起，并直接上传到AWS Elastic Beanstalk，但是当我开始集成AWS Cloudfront时，这被证明是非常有限的。然后，我采用了另一种方法，这种方法似乎在生产中非常有效。我将在下面概述这两种方法。</p><p id="4b37" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">假设我们有一个名为testapp的项目目录。testapp目录有两个子目录</p><ol class=""><li id="e965" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">客户端— Vue.js前端代码</li><li id="f5cb" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">server-Nodejs后端代码</li></ol><figure class="kd ke kf kg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kc"><img src="../Images/864659c12be3c76533dca182813477ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9wYa6No5egLf93gWfVOIUw.png"/></div></div></figure><h1 id="1f54" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">第一种方法</h1><p id="3d5e" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">第一种部署方法是将Vuejs包和Nodejs一起打包，并上传到AWS Elastic Beanstalk。这里的步骤将是:</p><ol class=""><li id="daa6" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated"><strong class="is hj">在客户端目录下构建Vue.js项目</strong></li></ol><pre class="kd ke kf kg fd lk ll lm ln aw lo bi"><span id="2806" class="lp ki hi ll b fi lq lr l ls lt">npm run build. // this will generate a dist directory in the client</span></pre><p id="7caa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2.<strong class="is hj">将public目录下的dist目录粘贴到server文件夹</strong>中。</p><p id="c010" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.<strong class="is hj">确保您的nodejs服务器被配置为从公共目录中提供静态文件</strong>。在那里添加这些行应该可以做到:</p><figure class="kd ke kf kg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lu"><img src="../Images/586adc25f4ee1d614a82e0e721ebdfe2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VKXO1U6qf-Bl5iHdJBP7eQ.png"/></div></div></figure><p id="a3fe" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4.<strong class="is hj">启动节点服务器</strong>检查localhost:3000。你应该可以在localhost:3000上运行整个网站。</p><pre class="kd ke kf kg fd lk ll lm ln aw lo bi"><span id="12ca" class="lp ki hi ll b fi lq lr l ls lt">node app.js</span></pre><p id="ecb1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">5.<strong class="is hj">在AWS弹性豆茎上部署网站</strong>:</p><ul class=""><li id="a768" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn lv ju jv jw bi translated"><a class="ae lw" href="https://portal.aws.amazon.com/billing/signup?redirect_url=https%3A%2F%2Faws.amazon.com%2Fregistration-confirmation#/start" rel="noopener ugc nofollow" target="_blank">如果你还没有开发者账户的话，在AWS上注册一个。</a></li><li id="5cf2" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn lv ju jv jw bi translated"><a class="ae lw" rel="noopener" href="/@xoor/deploying-a-node-js-app-to-aws-elastic-beanstalk-681fa88bac53">这是了解如何将Node.js应用程序部署到Elastic Beanstalk的绝佳资源</a>。</li><li id="4279" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn lv ju jv jw bi translated">一旦完成，你应该有一个像testapp <a class="ae lw" href="http://enthire.us-east-2.elasticbeanstalk.com/" rel="noopener ugc nofollow" target="_blank">一样的弹性豆茎链接。us-east-1.elasticbeanstalk.co)</a>在那里你应该能够看到网站部署。</li><li id="3f77" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn lv ju jv jw bi translated">请注意，eb命令<strong class="is hj"> </strong> (eb init，eb deploy)需要在server文件夹中执行。</li></ul><p id="7421" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">6.<strong class="is hj">将DNS服务从您的域名提供商迁移到Route53 </strong></p><p id="ddc8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我有一个从GoDaddy购买的域名，希望我的网站出现在该域名上，而不是弹性的beanstalk URL上。为此，我决定将我的DNS服务从GoDaddy转移到AWS Route53。我将推荐<a class="ae lw" href="https://lobster1234.github.io/2017/05/10/migrating-a-domain-to-amazon-route53/" rel="noopener ugc nofollow" target="_blank">这篇一步一步走过这个过程的博客</a>。这里有一个警告。导入导出的区域文件不只是在Route53中有效。要解决这个问题:</p><ul class=""><li id="e343" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn lv ju jv jw bi translated">使用类似https://www.ipvoid.com/find-website-ip/<a class="ae lw" href="https://www.ipvoid.com/find-website-ip/" rel="noopener ugc nofollow" target="_blank">的网站找到弹性豆茎网址的IP地址</a></li><li id="297f" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn lv ju jv jw bi translated">用IP替换区域文件中的停放</li><li id="d568" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn lv ju jv jw bi translated">导入区域文件，它应该会成功导入。</li><li id="61de" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn lv ju jv jw bi translated">您可以将A记录更改为别名类型，并将其指向您的elastic beanstalk URL。</li></ul><p id="92ad" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">另一件对我不起作用的事情是当我试图在Godaddy中粘贴AWS名称服务器时。显然，如果您以句点结束名称服务器，Godaddy会显示一个意外错误。所以ns-1122.awsdns-11.org。没有工作，但粘贴ns-1122.awsdns-11.org工作。</p><p id="b384" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">7.<strong class="is hj">为你的应用配置SSL </strong></p><p id="7b3c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这包括从AWS Certificate Manager获取域名的证书，然后在Elastic Beanstalk上启用安全侦听器端口443。<a class="ae lw" rel="noopener" href="/@j_cunanan05/how-to-redirect-http-to-https-in-amazon-web-services-aws-elastic-beanstalk-67f309734e81">这篇文章</a>很好地描述了整个过程。</p><p id="80cc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">上面的方法工作得很好，除了我在我的网站前面添加AWS Cloudfront (CDN)以降低加载时间时遇到的问题。(<em class="lx">如果你们中有人发现了这一点，我很想知道！</em>)。没有加CDN，网站加载速度相当慢。这时，我想出了第二种方法，它也更加模块化和简洁。</p><h1 id="7493" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">第二种方法</h1><p id="676a" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">第二种方法包括在AWS S3中将客户端作为静态网站单独部署，在Elastic Beanstalk中将服务器单独部署。连续的步骤将是:</p><ol class=""><li id="982f" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated"><strong class="is hj">在客户端目录下构建Vue.js项目</strong></li></ol><pre class="kd ke kf kg fd lk ll lm ln aw lo bi"><span id="3a4a" class="lp ki hi ll b fi lq lr l ls lt">npm run build // this will generate a dist directory in the client</span></pre><p id="08bb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2.<strong class="is hj">按照第一种方法所述，将DNS服务</strong>从您的DNS提供商迁移到Route53。(仅当您希望在自己的自定义域中托管时才需要)</p><p id="7162" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.我们将<strong class="is hj">将dist目录作为静态网站</strong>部署到AWS S3存储桶。部署到S3，这是一个值得关注的伟大博客。你也可以添加Cloudfront并将HTTP重定向到HTTPS，就像博客中提到的那样。我创建了一个名为deploy.sh的部署脚本，内容如下:</p><pre class="kd ke kf kg fd lk ll lm ln aw lo bi"><span id="99e0" class="lp ki hi ll b fi lq lr l ls lt"># deploy.sh<br/>#!/bin/bash</span><span id="2441" class="lp ki hi ll b fi ly lr l ls lt">// Build Vue website<br/>npm run build</span><span id="5b02" class="lp ki hi ll b fi ly lr l ls lt">// Copy Files to S3<br/>aws --region &lt;aws_region&gt; --profile &lt;profile-name&gt; s3 sync ./dist s3://&lt;bucket_name&gt; --delete</span><span id="2a24" class="lp ki hi ll b fi ly lr l ls lt">// Invalidate Cloudfront<br/>aws configure set preview.cloudfront true &amp;&amp; aws cloudfront create-invalidation --distribution-id &lt;distribution_id&gt; --paths '/*'</span></pre><p id="c140" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后，我在package.json中添加一个条目来运行这个部署脚本</p><pre class="kd ke kf kg fd lk ll lm ln aw lo bi"><span id="22da" class="lp ki hi ll b fi lq lr l ls lt">// Execute deploy.sh using npm run deploy</span><span id="1c97" class="lp ki hi ll b fi ly lr l ls lt">"scripts": {</span><span id="d0f0" class="lp ki hi ll b fi ly lr l ls lt"> "deploy": "./deploy.sh",<br/> "dev": "webpack-dev-server --inline --progress --config build/webpack.dev.conf.js",<br/> "e2e": "node test/e2e/runner.js",<br/> "start": "npm run dev",<br/> "test": "npm run e2e"<br/>},</span></pre><p id="f6e1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一旦所有的步骤都完成了，你应该能够看到你的网站在<a class="ae lw" href="https://yourdomain.com" rel="noopener ugc nofollow" target="_blank">https://yourdomain.com</a>运行——没有一个服务器端的API会工作，但是静态页面应该都可以加载。</p><p id="932e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.然后<strong class="is hj">将nodejs服务器代码部署到Elastic Beanstalk </strong>。该方法与第一种方法中概述的步骤相似，但有以下区别:</p><ul class=""><li id="a148" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn lv ju jv jw bi translated">我们不会将dist文件夹复制到服务器目录中的public文件夹。我们只部署服务器代码。</li><li id="bb7b" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn lv ju jv jw bi translated">一旦您将nodejs代码部署到elastic beanstalk，您将获得Elastic Beanstalk环境url，使用它您可以访问API。</li><li id="95cf" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn lv ju jv jw bi translated">然后，我们希望将弹性豆茎服务移动到一个自定义域名，如api.yourdomain.com。为此，在Route53中添加一个CNAME记录，详细信息如下:</li></ul><blockquote class="lz ma mb"><p id="a2ed" class="iq ir lx is b it iu iv iw ix iy iz ja mc jc jd je md jg jh ji me jk jl jm jn hb bi translated">姓名:api.yourdomain.com<br/>类型:CNAME <br/>别名:否<br/>值:nodeapp.us-east-2.elasticbeanstalk.com//弹性豆茎网址</p></blockquote><ul class=""><li id="99ad" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn lv ju jv jw bi translated">一旦上述工作完成，客户端将托管在https://yourdomain.com，服务器将托管在http://api.yourdomain.com。您还可以按照第一种方法中的步骤7来配置服务器的SSL。然后你就可以在https://api.yourdomain.com访问你的服务器了。</li></ul><p id="7954" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4.指示你的Vue前端应用程序与生产中的<a class="ae lw" href="https://api.yourdomain.com" rel="noopener ugc nofollow" target="_blank">https://api.yourdomain.com</a>对话。为此，我在prod.env.js vue config中添加了一个环境变量，并在axios基本配置中使用它</p><pre class="kd ke kf kg fd lk ll lm ln aw lo bi"><span id="f98e" class="lp ki hi ll b fi lq lr l ls lt">// prod.env.js</span><span id="523e" class="lp ki hi ll b fi ly lr l ls lt">'use strict'<br/>module.exports = {<br/>  NODE_ENV: '"production"',<br/>  VUE_APP_API_URL: '"https://api.yourdomain.com"'<br/>}</span><span id="46ba" class="lp ki hi ll b fi ly lr l ls lt">// api.js<br/>const BASE_SERVER_URL = process.env.VUE_APP_API_URL</span></pre><p id="f1a3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">5.在服务器目录中使用<strong class="is hj"> <em class="lx"> eb deploy </em> </strong>部署服务器，在客户端目录中使用<strong class="is hj"> <em class="lx"> npm run deploy </em> </strong>部署客户端。</p><blockquote class="lz ma mb"><p id="10e6" class="iq ir lx is b it iu iv iw ix iy iz ja mc jc jd je md jg jh ji me jk jl jm jn hb bi translated"><strong class="is hj">添加缓存控制头</strong></p></blockquote><p id="3057" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在分析我在<a class="ae lw" href="https://developers.google.com/speed/pagespeed/insights/" rel="noopener ugc nofollow" target="_blank">Google page speed Insights</a>上的网站时，我发现其中一个问题是从S3返回的资源中没有缓存控制头，这导致浏览器没有缓存它们，因此一次又一次地获取资源。这给用户带来了更长的加载时间。为了解决这个问题，我在部署脚本中添加了以下代码行:</p><pre class="kd ke kf kg fd lk ll lm ln aw lo bi"><span id="94bd" class="lp ki hi ll b fi lq lr l ls lt"># deploy.sh<br/>#!/bin/bash</span><span id="32ed" class="lp ki hi ll b fi ly lr l ls lt"><br/>npm run build </span><span id="e175" class="lp ki hi ll b fi ly lr l ls lt">aws --region &lt;aws_region&gt; --profile &lt;profile_name&gt; s3 sync ./dist s3://&lt;bucket_name&gt; --delete</span><span id="b826" class="lp ki hi ll b fi ly lr l ls lt">aws s3 cp s3://&lt;bucket_name&gt;/ s3://&lt;bucket_name&gt;/ --recursive --metadata-directive REPLACE  --exclude '*' --include '*.css' --cache-control max-age=86400 --content-type text/css</span><span id="99d0" class="lp ki hi ll b fi ly lr l ls lt">aws s3 cp s3://&lt;bucket_name&gt;/ s3://&lt;bucket_name&gt;/ --recursive --metadata-directive REPLACE  --exclude '*' --include '*.js' --cache-control max-age=86400</span><span id="beee" class="lp ki hi ll b fi ly lr l ls lt">aws s3 cp s3://&lt;bucket_name&gt;/ s3://&lt;bucket_name&gt;/ --recursive --metadata-directive REPLACE  --exclude '*' --include "*.jpg" --include "*.svg" --include "*.png" --cache-control max-age=86400</span><span id="ac9e" class="lp ki hi ll b fi ly lr l ls lt">aws configure set preview.cloudfront true &amp;&amp; aws cloudfront create-invalidation --distribution-id &lt;distribution_id&gt; --paths '/*'</span></pre><p id="c288" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">唷！这最终完成了在AWS上基于Vue.js和Node.js构建的web-app的端到端工作部署。如果你觉得这很有用，或者知道什么可以让这个过程变得更好，请在评论中告诉我。</p></div></div>    
</body>
</html>