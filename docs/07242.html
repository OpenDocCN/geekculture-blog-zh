<html>
<head>
<title>Google Cloud Functions — A Brief Tutorial</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">谷歌云功能——简要教程</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/google-cloud-functions-a-brief-tutorial-de07d8945b01?source=collection_archive---------10-----------------------#2021-09-13">https://medium.com/geekculture/google-cloud-functions-a-brief-tutorial-de07d8945b01?source=collection_archive---------10-----------------------#2021-09-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="a32b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用云函数提取从云存储加载到BigQuery的数据</p><blockquote class="jd je jf"><p id="87d4" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><em class="hi">这篇文章的葡文版可以在这里阅读</em><a class="ae jk" rel="noopener" href="/@lucasdesa/criando-um-processo-de-etl-com-gcp-cloud-storage-e-cloud-functions-dfe0eb7179d8"/><em class="hi">。</em></p></blockquote><p id="2b53" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在许多情况下，我们需要存储数据以备将来使用。借助谷歌云平台，我们可以使用<a class="ae jk" href="https://cloud.google.com/storage/docs" rel="noopener ugc nofollow" target="_blank">谷歌云存储</a> (GCS)作为数据湖来存储和加载数据到<a class="ae jk" href="https://cloud.google.com/bigquery/docs/introduction" rel="noopener ugc nofollow" target="_blank"> BigQuery </a>，这是一个用于构建数据仓库的强大分析数据库，允许我们存储海量数据并进行快速SQL查询，而无需管理其基础设施。将数据从GCS自动导入BigQuery的一种方法是使用云函数作为下面描述的<a class="ae jk" href="https://en.wikipedia.org/wiki/Extract,_transform,_load" rel="noopener ugc nofollow" target="_blank"> ETL </a>过程的中间人:</p><figure class="jm jn jo jp fd jq er es paragraph-image"><div class="er es jl"><img src="../Images/462d4044c69cb1e7be2bd323939bb198.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*rio0VXqyfQ962zSq.png"/></div></figure><p id="c558" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本文的想法是通过在GCP内部构建一个数据管道来介绍Google Cloud函数，在这个管道中，文件被上传到GCS中的一个桶中，然后由一个Cloud函数读取和处理，这个Cloud函数会将这些数据加载到一个BigQuery表中。</p></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><h2 id="1ea8" class="ka kb hi bd kc kd ke kf kg kh ki kj kk iq kl km kn iu ko kp kq iy kr ks kt ku bi translated">但是谷歌云功能到底是什么呢？</h2><p id="8616" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">为了理解云计算的功能，我们首先需要知道不同的计算服务是什么。</p><figure class="jm jn jo jp fd jq er es paragraph-image"><div class="er es jl"><img src="../Images/7a3ec611913fb1d9a38a5cc4d12b2b64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*2CS6AjbQXCDXwc0u.png"/></div></figure><p id="f36d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上图显示了不同可用服务的范围，包括:基础设施即服务(IaaS)、容器即服务(CaaS)、平台即服务(PaaS)和功能即服务(FaaS)。请注意，尽管左侧的服务为it配置提供了更高级别的控制，但它们需要专业团队来维护it基础架构。在右边，尽管他们不提供太多的控制，但他们有更高的抽象级别，it的维护由服务提供商完成。</p><p id="dcae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">云函数就像FaaS一样在右边的光谱上。通常，这些服务执行开发人员编写的一段代码，作为对预定义事件的响应，具有时间执行限制，其可伸缩性由提供者管理。这种服务的体系结构被称为无服务器体系结构，其中定价是根据函数被调用的次数以及所使用的内存和CPU的数量来计算的。这种服务非常活跃，因为只需很少的努力，该功能就可以启动并运行，而不用担心管理服务器。</p><p id="3311" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下图显示了谷歌云平台提供的不同种类的计算服务，包括IaaS和FaaS。</p><figure class="jm jn jo jp fd jq er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es jl"><img src="../Images/c614b3f6a16326d3c4a7ff5ba0e0ea49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*jrgsmbywJys7mtjF.png"/></div></div></figure><p id="8086" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">总之，谷歌云功能是FaaS，在一个无服务器的执行环境中，代码在一个完全受管理的环境中运行，其中单一目的的功能由GCP的其他服务发出的预定义事件编写和触发。它的支付模型是基于总的函数调用和使用的计算资源。</p><h2 id="dafb" class="ka kb hi bd kc kd ke kf kg kh ki kj kk iq kl km kn iu ko kp kq iy kr ks kt ku bi translated">设置云功能</h2><p id="07a5" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">这个函数背后的思想是在将一个<em class="jg"> json </em>文件存储在云存储桶中的时候立即处理它，并将它的内容加载到BigQuery。</p><p id="7621" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面我们定义了存储文件的桶<em class="jg"> test_function </em></p><figure class="jm jn jo jp fd jq er es paragraph-image"><div class="er es le"><img src="../Images/4d67aa7f6c44214ead10e5b28cf91317.png" data-original-src="https://miro.medium.com/v2/resize:fit:958/format:webp/1*cumWjKnQUbZD-x1Xmm1lZw.png"/></div></figure><p id="d312" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们将定义一个BigQuery表，数据将被加载到这个表中。我们称之为<em class="jg"> my_table </em>，包含以下几列:</p><figure class="jm jn jo jp fd jq er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lf"><img src="../Images/c6b2ffe05c5196f0ade3d24b7b165771.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jIgkHdkP4h7aoNv6Gf4eRw.png"/></div></div></figure><p id="36e0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要设置云功能，我们必须转到云功能仪表盘，点击<em class="jg">创建功能</em>:</p><figure class="jm jn jo jp fd jq er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lg"><img src="../Images/9ec3b50841451c0a922bf5366a5b4a27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pZkcxoFtpDvcYkeGqYPUrg.png"/></div></div></figure><p id="5b1a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，我们将填充我们的功能配置。</p><figure class="jm jn jo jp fd jq er es paragraph-image"><div class="er es lh"><img src="../Images/56ed91275a0fe712534b68f59386219f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1080/format:webp/1*nUO7K7d2RBw4L4XkmVLRJg.png"/></div></figure><p id="49c2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我们需要填写函数的名称和区域。</p><p id="ea76" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<em class="jg">触发器</em>部分，我们将选择<em class="jg">云存储</em>选项。对于事件类型，我们将选择<em class="jg">完成/创建。</em>最后，我们将指定云存储中的<em class="jg">存储桶</em>，在该存储桶上创建的每个文件都将触发该函数。</p><p id="4e09" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<em class="jg">运行时，构建、连接和安全设置</em>可以配置其他设置。在<em class="jg">高级</em>中有两个强制配置:内存量和超时限制。</p><p id="7318" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这些配置的默认设置是256MB内存和60秒的超时时间，但是可以分配高达8GB的内存和540秒(9分钟)的超时时间。</p><figure class="jm jn jo jp fd jq er es paragraph-image"><div class="er es li"><img src="../Images/7fadefdc99b75d993518f32fe1a3d36d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1096/format:webp/1*U8pyWm-OgL7LZccaovRVkA.png"/></div></figure><p id="9d21" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">完成所有设置后，我们可以进入代码选项卡。有很多语言选项和方法来设置我们的代码。我们将选择Python 3.7，并使用Google自己的编辑器来编写代码。</p><p id="99b3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">还需要指定函数的<em class="jg">入口点</em>，这意味着我们需要定义在代码执行时将读取什么方法。也可以在<em class="jg"> requirements.txt </em>文件中指定使用哪些Python包。</p><figure class="jm jn jo jp fd jq er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lj"><img src="../Images/8cc714984c2d2ee4fc78bd9f4376cc64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YCAhUDH-LxbfrQiwDP7dFg.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx">Cloud Function Editor</figcaption></figure><p id="402a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是为此函数编写的代码:</p><figure class="jm jn jo jp fd jq"><div class="bz dy l di"><div class="lo lp l"/></div></figure><p id="800b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">需要注意的是，BigQuery只接受名为<em class="jg"> NDjson </em>的特定json文件格式，这是一个每行都有一个JSON对象的JSON文件，如下例所示:</p><pre class="jm jn jo jp fd lq lr ls lt aw lu bi"><span id="f496" class="ka kb hi lr b fi lv lw l lx ly">{"key": 1, "value": "my_value"}</span><span id="7c55" class="ka kb hi lr b fi lz lw l lx ly">{"key": 2, "value": "another value"}</span><span id="9882" class="ka kb hi lr b fi lz lw l lx ly">{"key": 3, "value": "this is NDJSON"}</span></pre><p id="5041" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一切就绪后，我们可以点击<em class="jg">部署</em>，看看神奇的事情发生了=)</p></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><h2 id="d643" class="ka kb hi bd kc kd ke kf kg kh ki kj kk iq kl km kn iu ko kp kq iy kr ks kt ku bi translated">运行云功能</h2><p id="6af9" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">现在我们终于可以使用我们的功能了！所有的功能日志都记录在GCP的<em class="jg">测井</em>工具中。每个功能还有一个<em class="jg">日志</em>标签。</p><p id="08ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了运行我们的函数，我们将上传一个<em class="jg"> NDJSON </em>文件到GCS中的<em class="jg">测试函数</em>桶。函数日志将在它执行后立即可用。</p><figure class="jm jn jo jp fd jq er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es ma"><img src="../Images/6da0d5832f64ac9d913615e43e863b49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LBysoElFQ6cfBzNEb9DLkA.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx">Function logs after uploading the <em class="mb">my_example.json file to GCS</em></figcaption></figure><p id="296a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们可以在BigQuery中查询数据了！</p><figure class="jm jn jo jp fd jq er es paragraph-image"><div class="er es mc"><img src="../Images/4d6d382ad0611383c7151a67fba22a0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:970/format:webp/1*DQS9H31fBEEOGkXS301KxA.png"/></div></figure><h2 id="f20c" class="ka kb hi bd kc kd ke kf kg kh ki kj kk iq kl km kn iu ko kp kq iy kr ks kt ku bi translated">结束语</h2><p id="6cbf" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">Google Cloud Funtions是一个很好的工具，可以轻松完成ETL工作，因为它在部署单一目的的面向事件的功能(如发布/订阅和云存储，以及HTTP调用)方面具有通用性和灵活性。</p><p id="a603" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">考虑它的局限性仍然很重要。9分钟的执行时间可能会使要求更高的作业变得不可行，从而限制了it对要求较低的工作负载(如微批处理)的使用。</p></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><h1 id="ab93" class="md kb hi bd kc me mf mg kg mh mi mj kk mk ml mm kn mn mo mp kq mq mr ms kt mt bi translated">参考</h1><blockquote class="jd je jf"><p id="a126" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><a class="ae jk" href="https://cloud.google.com/architecture/streaming-data-from-cloud-storage-into-bigquery-using-cloud-functions" rel="noopener ugc nofollow" target="_blank"> <em class="hi">使用云函数将数据从云存储流式传输到big query</em></a><em class="hi"><br/></em><a class="ae jk" href="https://cloud.google.com/functions/docs" rel="noopener ugc nofollow" target="_blank"><em class="hi">云函数文档</em> </a></p></blockquote></div></div>    
</body>
</html>