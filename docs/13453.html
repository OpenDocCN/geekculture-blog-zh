<html>
<head>
<title>Hyperledger Fabric Block Configuration And Modification</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Hyperledger结构块配置和修改</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/hyperledger-fabric-block-configuration-5cd6281f7215?source=collection_archive---------5-----------------------#2022-07-09">https://medium.com/geekculture/hyperledger-fabric-block-configuration-5cd6281f7215?source=collection_archive---------5-----------------------#2022-07-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/></div><div class="ab cl if ig gp ih" role="separator"><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik"/></div><div class="hb hc hd he hf"><figure class="in io ip iq fd ir er es paragraph-image"><div role="button" tabindex="0" class="is it di iu bf iv"><div class="er es im"><img src="../Images/2cfeeb0dc36790ce76a9e1ffb3186ba0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ct_H7XYmPIC1xqgy3X4KsQ.png"/></div></div><figcaption class="iy iz et er es ja jb bd b be z dx">HLF</figcaption></figure><h1 id="7a78" class="jc jd hi bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">介绍</h1><p id="c953" class="pw-post-body-paragraph ka kb hi kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx hb bi translated">在本文中，我将演示如何在正在运行的Hyperledger fabric网络中配置/修改块设置。</p><h1 id="6fb7" class="jc jd hi bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">观众</h1><p id="df50" class="pw-post-body-paragraph ka kb hi kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx hb bi translated">Hyperledger结构操作员，管理员。这是一篇修改运行中的区块链网络的实践操作文章。对于初学者，我想建议你，请通过一些Hyperledger织物的基本概念。请访问<a class="ae ky" rel="noopener" href="/geekculture/hyperledger-fabric-blockchain-setup-from-scratch-21890e26aac7">我以前的文章</a>，建立一个HLF网络。</p><blockquote class="kz la lb"><p id="7772" class="ka kb lc kc b kd ld kf kg kh le kj kk lf lg kn ko lh li kr ks lj lk kv kw kx hb bi translated"><em class="hi">注意:本文不建议HLF初学者阅读。</em></p></blockquote><h1 id="ced0" class="jc jd hi bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">先决条件</h1><ol class=""><li id="0af5" class="ll lm hi kc b kd ke kh ki kl ln kp lo kt lp kx lq lr ls lt bi translated">中级了解<strong class="kc hj"> Hyperledger Fabric区块链</strong>。</li><li id="f45a" class="ll lm hi kc b kd lu kh lv kl lw kp lx kt ly kx lq lr ls lt bi translated">基本了解HLF CA，CouchDB。</li><li id="cba8" class="ll lm hi kc b kd lu kh lv kl lw kp lx kt ly kx lq lr ls lt bi translated">基本的外壳命令、外壳脚本等。</li></ol><h1 id="200c" class="jc jd hi bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">系统需求</h1><ol class=""><li id="1843" class="ll lm hi kc b kd ke kh ki kl ln kp lo kt lp kx lq lr ls lt bi translated">Docker —版本17.06.2</li><li id="6760" class="ll lm hi kc b kd lu kh lv kl lw kp lx kt ly kx lq lr ls lt bi translated">Docker Compose —版本1.28.5或更高版本</li><li id="eb45" class="ll lm hi kc b kd lu kh lv kl lw kp lx kt ly kx lq lr ls lt bi translated">Golang —版本1.14</li><li id="8eb3" class="ll lm hi kc b kd lu kh lv kl lw kp lx kt ly kx lq lr ls lt bi translated">Nodejs —版本8</li><li id="f47d" class="ll lm hi kc b kd lu kh lv kl lw kp lx kt ly kx lq lr ls lt bi translated">Python 2.7</li></ol><h1 id="1feb" class="jc jd hi bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">网络安装程序</h1><ul class=""><li id="c1bf" class="ll lm hi kc b kd ke kh ki kl ln kp lo kt lp kx lz lr ls lt bi translated">具有org1和org2的HLF网络，每个都有2个对等体。</li><li id="7af9" class="ll lm hi kc b kd lu kh lv kl lw kp lx kt ly kx lz lr ls lt bi translated">订购者群集(3个订购服务节点)RAFT作为一致算法(订购者、订购者2、订购者3)</li><li id="1bd3" class="ll lm hi kc b kd lu kh lv kl lw kp lx kt ly kx lz lr ls lt bi translated">组织1、组织2和订购者的CA</li><li id="7a3d" class="ll lm hi kc b kd lu kh lv kl lw kp lx kt ly kx lz lr ls lt bi translated"><strong class="kc hj"> CouchDB </strong>作为世界状态<strong class="kc hj"> </strong>数据库。</li><li id="df0d" class="ll lm hi kc b kd lu kh lv kl lw kp lx kt ly kx lz lr ls lt bi translated">面料最新版本<strong class="kc hj"> 2.3 </strong></li></ul><h1 id="f1f2" class="jc jd hi bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">结构区块链设置</h1><p id="1232" class="pw-post-body-paragraph ka kb hi kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx hb bi translated">修改hyperledger结构网络非常复杂。如果结构网络已经在运行，则可以跳过这一步。</p><ul class=""><li id="518b" class="ll lm hi kc b kd ld kh le kl ma kp mb kt mc kx lz lr ls lt bi translated">让我们克隆回购协议</li></ul><pre class="in io ip iq fd md me mf mg aw mh bi"><span id="bac9" class="mi jd hi me b fi mj mk l ml mm"><strong class="me hj">git clone </strong><a class="ae ky" href="https://github.com/cmjagtap/Hyperledger-Fabric" rel="noopener ugc nofollow" target="_blank"><strong class="me hj">https://github.com/cmjagtap/Hyperledger-Fabric</strong></a></span></pre><ul class=""><li id="8ff6" class="ll lm hi kc b kd ld kh le kl ma kp mb kt mc kx lz lr ls lt bi translated">执行以下命令。</li></ul><pre class="in io ip iq fd md me mf mg aw mh bi"><span id="24ab" class="mi jd hi me b fi mj mk l ml mm"><strong class="me hj">export PATH=${PWD}/bin:$PATH<br/>sudo service docker start<br/> cd org1<br/>./1_enrollOrg1AdminAndUsers.sh<br/>./2_generateMSPOrg1.sh<em class="lc"> <br/> <br/> </em>cd ../org2<br/></strong>./<strong class="me hj">1_enrollOrg2AdminAndUsers.sh<br/></strong>./<strong class="me hj">2_generateMSPOrg2.sh <br/> <br/> cd ../orderer<br/></strong>./<strong class="me hj">1_enrollAdminAndMSP.sh<br/>./2_artifact.sh<br/> <br/> cd ../org1</strong><br/>.<strong class="me hj">/3_createChannel.sh<br/> <br/> cd ../org2</strong><br/>.<strong class="me hj">/3_joinChannel.sh</strong></span></pre><p id="4c1c" class="pw-post-body-paragraph ka kb hi kc b kd ld kf kg kh le kj kk kl lg kn ko kp li kr ks kt lk kv kw kx hb bi translated">Hyperledger fabric区块链2.3已准备就绪。</p><h1 id="7443" class="jc jd hi bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">块配置</h1><ul class=""><li id="3a85" class="ll lm hi kc b kd ke kh ki kl ln kp lo kt lp kx lz lr ls lt bi translated">批量大小和批量时间是超格织物获得高产量的重要因素。</li><li id="c307" class="ll lm hi kc b kd lu kh lv kl lw kp lx kt ly kx lz lr ls lt bi translated">这些因素决定了区块链网络的每秒交易量(TPS)。</li></ul><h2 id="ec8d" class="mi jd hi bd je mn mo mp ji mq mr ms jm kl mt mu jq kp mv mw ju kt mx my jy mz bi translated"><strong class="ak">块配置组件</strong></h2><ul class=""><li id="13c5" class="ll lm hi kc b kd ke kh ki kl ln kp lo kt lp kx lz lr ls lt bi translated"><strong class="kc hj">批量大小:- </strong>这些参数规定了块中交易的数量和大小。任何块都不会比<code class="du na nb nc me b">absolute_max_bytes</code>大，也不会有超过<code class="du na nb nc me b">max_message_count</code>个事务出现在块内。如果有可能在<code class="du na nb nc me b">preferred_max_bytes</code>下构造一个块，那么一个块会被过早的切割，大于这个大小的事务会出现在自己的块中。</li><li id="081a" class="ll lm hi kc b kd lu kh lv kl lw kp lx kt ly kx lz lr ls lt bi translated"><strong class="kc hj">批处理超时:- </strong>在第一个事务到达后，在切割一个块之前等待其他事务的时间。减小该值将会改善延迟，但是减小太多可能会降低吞吐量，因为它不允许块填满其最大容量。</li><li id="cf72" class="ll lm hi kc b kd lu kh lv kl lw kp lx kt ly kx lz lr ls lt bi translated"><strong class="kc hj">块验证</strong>。该策略指定了块被视为有效的签名要求。默认情况下，它需要来自订购组织的某个成员的签名。</li></ul><h2 id="5111" class="mi jd hi bd je mn mo mp ji mq mr ms jm kl mt mu jq kp mv mw ju kt mx my jy mz bi translated">块更新过程</h2><p id="ce55" class="pw-post-body-paragraph ka kb hi kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx hb bi translated">通常，我们使用对等配置和组织的管理员身份来更新通道。但是在这里，块配置是由订购者管理员控制的。因此，我们使用订购者的管理员身份来执行更新过程。</p><p id="77c3" class="pw-post-body-paragraph ka kb hi kc b kd ld kf kg kh le kj kk kl lg kn ko kp li kr ks kt lk kv kw kx hb bi translated">在上面的资源库<strong class="kc hj">block config</strong>/<strong class="kc hj">T3】block config . shT5】shell脚本中。shell脚本执行以下步骤。</strong></p><ol class=""><li id="2096" class="ll lm hi kc b kd ld kh le kl ma kp mb kt mc kx lq lr ls lt bi translated">我们需要导出环境变量，在我们的例子中，我们导出order 2 env变量，也可以导出其他orderer env变量。</li></ol><pre class="in io ip iq fd md me mf mg aw mh bi"><span id="c2a0" class="mi jd hi me b fi mj mk l ml mm">export FABRIC_LOGGING_SPEC=INFO<br/>export CORE_PEER_TLS_ENABLED=true</span><span id="cded" class="mi jd hi me b fi nd mk l ml mm">export ORDERER_CA=${PWD}/../orderer/crypto-config-ca/ordererOrganizations/example.com/orderers/orderer.example.com/tls/tlscacerts/tls-localhost-9054-ca-orderer.pem</span><span id="4fb6" class="mi jd hi me b fi nd mk l ml mm">export CORE_PEER_TLS_CERT_FILE=${PWD}/../orderer/crypto-config-ca/ordererOrganizations/example.com/orderers/orderer1/tls/server.crt</span><span id="f4ee" class="mi jd hi me b fi nd mk l ml mm">export CORE_PEER_TLS_KEY_FILE=${PWD}/../orderer/crypto-config-ca/ordererOrganizations/example.com/orderers/orderer1/tls/server.key</span><span id="47c9" class="mi jd hi me b fi nd mk l ml mm">export CORE_PEER_LOCALMSPID=OrdererMSP</span><span id="2ffd" class="mi jd hi me b fi nd mk l ml mm">export CORE_PEER_TLS_ROOTCERT_FILE=${PWD}/../orderer/crypto-config-ca/ordererOrganizations/example.com/orderers/orderer1/tls/ica.crt</span><span id="e512" class="mi jd hi me b fi nd mk l ml mm">export <a class="ae ky" href="mailto:CORE_PEER_MSPCONFIGPATH=${PWD}/../orderer/crypto-config-ca/ordererOrganizations/example.com/users/Admin@example.com" rel="noopener ugc nofollow" target="_blank">CORE_PEER_MSPCONFIGPATH=${PWD}/../orderer/crypto-config-ca/ordererOrganizations/example.com/users/Admin@example.com</a>/msp</span><span id="8a46" class="mi jd hi me b fi nd mk l ml mm">export CORE_PEER_ADDRESS=$domain:$port<br/></span></pre><p id="74e8" class="pw-post-body-paragraph ka kb hi kc b kd ld kf kg kh le kj kk kl lg kn ko kp li kr ks kt lk kv kw kx hb bi translated">2.从通道中获取最新的配置块。<strong class="kc hj"> getConfig() </strong>函数从订购服务中获取最新的配置块。</p><pre class="in io ip iq fd md me mf mg aw mh bi"><span id="2200" class="mi jd hi me b fi mj mk l ml mm">peer channel fetch config config_block.pb -o $domain:$port  -c $channel --tls --cafile $ORDERER_CA</span></pre><p id="a073" class="pw-post-body-paragraph ka kb hi kc b kd ld kf kg kh le kj kk kl lg kn ko kp li kr ks kt lk kv kw kx hb bi translated">3.将块从protobuff转换为JSON。<strong class="kc hj"> convertBlockToJSON() </strong>函数将照片buff解码为JSON。</p><pre class="in io ip iq fd md me mf mg aw mh bi"><span id="ccd7" class="mi jd hi me b fi mj mk l ml mm">configtxlator proto_decode --input config_block.pb --type common.Block | jq .data.data[0].payload.data.config &gt; config.json</span></pre><p id="9a34" class="pw-post-body-paragraph ka kb hi kc b kd ld kf kg kh le kj kk kl lg kn ko kp li kr ks kt lk kv kw kx hb bi translated">4.在这一步，我们可以修改<strong class="kc hj"> BatchTimeout、BatchSize和其他块</strong>配置参数<strong class="kc hj">。</strong></p><p id="f410" class="pw-post-body-paragraph ka kb hi kc b kd ld kf kg kh le kj kk kl lg kn ko kp li kr ks kt lk kv kw kx hb bi translated">4.1<strong class="kc hj">modifyBatchTimeout()</strong>函数根据环境变量中给定的<strong class="kc hj"><em class="lc">BatchTimeout</em></strong><em class="lc">修改batch time out。</em></p><pre class="in io ip iq fd md me mf mg aw mh bi"><span id="9e93" class="mi jd hi me b fi mj mk l ml mm">jq  ".channel_group.groups.Orderer.values.BatchTimeout.value.timeout = $batchTimeout " config.json &gt; modified_config.json</span></pre><blockquote class="kz la lb"><p id="0123" class="ka kb lc kc b kd ld kf kg kh le kj kk lf lg kn ko lh li kr ks lj lk kv kw kx hb bi translated">注意:目前有一些问题与JQ。命令，你可以跳过这个函数或者手动编辑modified_config.json文件中的<strong class="kc hj"> batchTimeout </strong>。</p></blockquote><p id="79da" class="pw-post-body-paragraph ka kb hi kc b kd ld kf kg kh le kj kk kl lg kn ko kp li kr ks kt lk kv kw kx hb bi translated">4.2 <strong class="kc hj"> modifyBatchSize() </strong>函数根据环境变量中给定的<strong class="kc hj"><em class="lc">BatchSize</em></strong><em class="lc">修改batchSize。这里我们修改了单个块中的最大事务限制。</em></p><pre class="in io ip iq fd md me mf mg aw mh bi"><span id="ab9e" class="mi jd hi me b fi mj mk l ml mm">jq ".channel_group.groups.Orderer.values.BatchSize.value.max_message_count = $batchMessageSize " config.json &gt; modified_config.json</span></pre><p id="514a" class="pw-post-body-paragraph ka kb hi kc b kd ld kf kg kh le kj kk kl lg kn ko kp li kr ks kt lk kv kw kx hb bi translated">5.之后，我们需要计算原始配置和新配置之间的差值。<strong class="kc hj"> computeDelta() </strong>函数计算增量。</p><pre class="in io ip iq fd md me mf mg aw mh bi"><span id="ef05" class="mi jd hi me b fi mj mk l ml mm">configtxlator proto_encode --input config.json --type common.Config --output config.pb</span><span id="5e06" class="mi jd hi me b fi nd mk l ml mm">configtxlator proto_encode --input modified_config.json --type common.Config --output modified_config.pb</span><span id="7b97" class="mi jd hi me b fi nd mk l ml mm">configtxlator compute_update --channel_id $channel --original config.pb --updated modified_config.pb --output config_update.pb</span></pre><ol class=""><li id="8a55" class="ll lm hi kc b kd ld kh le kl ma kp mb kt mc kx lq lr ls lt bi translated"><strong class="kc hj">convertconfigfdeltatojson()</strong>将现有的proto buff转换为JSON，然后创建其信封。</li></ol><pre class="in io ip iq fd md me mf mg aw mh bi"><span id="f60c" class="mi jd hi me b fi mj mk l ml mm">configtxlator proto_decode --input config_update.pb --type common.ConfigUpdate --output config_update.json</span><span id="fc98" class="mi jd hi me b fi nd mk l ml mm">echo '{"payload":{"header":{"channel_header":{"channel_id":"mychannel", "type":2}},"data":{"config_update":'$(cat config_update.json)'}}}' | jq . &gt; config_update_in_envelope.json</span><span id="9d5f" class="mi jd hi me b fi nd mk l ml mm">configtxlator proto_encode --input config_update_in_envelope.json --type common.Envelope --output config_update_in_envelope.pb</span></pre><ol class=""><li id="de11" class="ll lm hi kc b kd ld kh le kl ma kp mb kt mc kx lq lr ls lt bi translated"><strong class="kc hj"> signEnvolope() </strong>函数用身份给信封签名。根据您的政策，您可能需要在其他订购者的信封上签名。</li></ol><pre class="in io ip iq fd md me mf mg aw mh bi"><span id="5171" class="mi jd hi me b fi mj mk l ml mm">peer channel signconfigtx -f config_update_in_envelope.pb</span></pre><ol class=""><li id="e2fe" class="ll lm hi kc b kd ld kh le kl ma kp mb kt mc kx lq lr ls lt bi translated"><strong class="kc hj"> updateChannel() </strong>函数用符号包络更新通道配置。</li></ol><pre class="in io ip iq fd md me mf mg aw mh bi"><span id="cf84" class="mi jd hi me b fi mj mk l ml mm">peer channel update -f config_update_in_envelope.pb -c $channel -o $domain:$port  --tls --cafile $ORDERER_CA</span></pre><p id="bcb5" class="pw-post-body-paragraph ka kb hi kc b kd ld kf kg kh le kj kk kl lg kn ko kp li kr ks kt lk kv kw kx hb bi translated">在成功执行shell脚本后，我们应该会看到下面的输出。</p><figure class="in io ip iq fd ir er es paragraph-image"><div role="button" tabindex="0" class="is it di iu bf iv"><div class="er es ne"><img src="../Images/78fe41230707392dc986500c320035cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZBvRuTaHBrIti5iRJxaO5A.png"/></div></div><figcaption class="iy iz et er es ja jb bd b be z dx">Block Updation</figcaption></figure><h1 id="f928" class="jc jd hi bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">打扫</h1><p id="df91" class="pw-post-body-paragraph ka kb hi kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx hb bi translated">执行以下脚本来清理所有docker容器和加密证书。</p><pre class="in io ip iq fd md me mf mg aw mh bi"><span id="34a9" class="mi jd hi me b fi mj mk l ml mm">.<strong class="me hj">/clean.sh</strong></span></pre><h1 id="e69b" class="jc jd hi bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">摘要</h1><p id="df98" class="pw-post-body-paragraph ka kb hi kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx hb bi translated">我们已经看到，在运行hyperledger fabric区块链网络时，如何更新<strong class="kc hj"> BatchTimeout </strong>、<strong class="kc hj"> BatchSize </strong>来配置块设置。</p></div></div>    
</body>
</html>