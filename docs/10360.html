<html>
<head>
<title>How to run android automation scripts with docker environment.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用docker环境运行android自动化脚本？</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/how-to-run-android-automation-scripts-with-docker-environment-51f6207d52ed?source=collection_archive---------1-----------------------#2022-01-25">https://medium.com/geekculture/how-to-run-android-automation-scripts-with-docker-environment-51f6207d52ed?source=collection_archive---------1-----------------------#2022-01-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/49e33401e2e4634e96fcffcae5e81842.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Gbj2UYO0rPsi1xnu6x0rfA.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Photo by <a class="ae iu" href="https://unsplash.com/photos/4aDuXiPcfQI" rel="noopener ugc nofollow" target="_blank">Árpád Czapp</a></figcaption></figure><p id="3e12" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">测试过程是一个非常复杂和广泛的程序。测试过程本身有助于理解和识别开发过程中产生的缺陷、错误和失败。测试过程本身需要大量的时间和资源。但是最大的资源花费在Android或iOS的移动测试上。移动测试需要安装大量的依赖项。还需要有足够大的设备群(所谓的设备群)来执行手动和自动场景。</p><p id="f462" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用Docker容器化技术，我们可以为多个功能分支创建和运行自动化脚本，从而加快开发并提高生产率。</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es jt"><img src="../Images/5b76db5ad8fbaf25cc3a9f2336a30d89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1338/format:webp/1*q3bPaMzA_br8YAiJfgB-_w.jpeg"/></div></figure><p id="6066" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">假设您要建立测试自动化。完全由您的团队来构建和维护整个测试基础设施可能是痛苦的。虽然像Sauce Labs这样的一些云服务确实涵盖了DevOps，但由于公司的安全问题或预算问题，您可能会犹豫是否使用它们。Docker是设置和维护测试自动化服务器的一个很好的工具，尤其是如果您刚刚开始使用开源解决方案构建自动化测试基础设施的话。</p><p id="e9b3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在本文中，我们创建一个Android容器来隔离测试过程。</p></div><div class="ab cl jy jz gp ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hb hc hd he hf"><p id="4912" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">无论您使用哪种测试框架或测试库，在实现和执行测试时，您都需要考虑库版本、环境变量设置和其他依赖项。测试脚本是一个程序，它向服务器发送请求，以便在要测试的驱动程序上执行命令。为了使您团队中的任何人能够在任何平台上执行测试，您可以使用Docker将所有测试脚本和库打包成一个测试运行器容器。容器是一个独立的环境，包括所有的环境设置和库，所以测试脚本可以在任何平台上运行。下面是一个Docker文件的例子，用来制作一个简单的测试运行程序Docker映像。Dockerfile是一个文本文档，包含用户可以在命令行上调用的所有命令来组合一个图像。</p><p id="ff9c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi kf translated">开始一个码头集装箱。</p><p id="3ff1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们构建的图像是— <strong class="ix hj"> ubuntu:最新的</strong></p><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="ko kp l"/></div></figure><ul class=""><li id="c59c" class="kq kr hi ix b iy iz jc jd jg ks jk kt jo ku js kv kw kx ky bi translated">— <code class="du kz la lb lc b">it</code>:交互执行shell命令。</li><li id="fb64" class="kq kr hi ix b iy ld jc le jg lf jk lg jo lh js kv kw kx ky bi translated"><code class="du kz la lb lc b">— name "name-of-your-android-container”</code>:首选容器名。</li></ul><p id="3af2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">另外，要以非根用户身份运行docker，最简单的方法是将当前用户添加到组docker:</p><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="ko kp l"/></div></figure></div><div class="ab cl jy jz gp ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hb hc hd he hf"><p id="d046" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi kf translated">安装SDK和所有的包。</p><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="ko kp l"/></div></figure><p id="e4c7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi kf translated">G<span class="l kg kh ki bm kj kk kl km kn di">radle。</span></p><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="ko kp l"/></div></figure><p id="1ff1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建一个新的目录<code class="du kz la lb lc b">/opt/gradlew</code>，并在那里安装<code class="du kz la lb lc b">gradle-wrapper</code>。(目录名可以是任何名称，但是要将文件保存在容易找到的地方)</p><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="ko kp l"/></div></figure><p id="d91b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi kf translated">一个ndroid SDK。</p><p id="ea12" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="li">Android软件开发套件(SDK)包括不同的组件，包括SDK工具、构建工具和平台工具。SDK工具主要包括Android模拟器、层级查看器、SDK管理器和ProGuard。构建工具主要包括apt(一个用于创建的Android打包工具。APK)，dx(一个转换的Android工具。java文件到。dex文件)。平台工具包括Android调试外壳、sqlite3和Systrace。</em></p><p id="93ce" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你需要手动下载没有Android Studio捆绑的SDK，只使用SDK工具。</p><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="ko kp l"/></div></figure><p id="c64b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最重要的包是<code class="du kz la lb lc b">platform-tools</code>、<code class="du kz la lb lc b">tools</code>和<code class="du kz la lb lc b">emulator</code>。运行以下命令快速安装它们:</p><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="ko kp l"/></div></figure><ul class=""><li id="f85d" class="kq kr hi ix b iy iz jc jd jg ks jk kt jo ku js kv kw kx ky bi translated"><code class="du kz la lb lc b">platform-tools</code>包含<code class="du kz la lb lc b">adb</code></li><li id="82f1" class="kq kr hi ix b iy ld jc le jg lf jk lg jo lh js kv kw kx ky bi translated"><code class="du kz la lb lc b">tools</code>包含<code class="du kz la lb lc b">avdmanager</code>和<code class="du kz la lb lc b">sdkamanager</code></li><li id="d0a7" class="kq kr hi ix b iy ld jc le jg lf jk lg jo lh js kv kw kx ky bi translated"><code class="du kz la lb lc b">emulator</code>:运行仿真器</li><li id="85e2" class="kq kr hi ix b iy ld jc le jg lf jk lg jo lh js kv kw kx ky bi translated"><code class="du kz la lb lc b">system-images;android-<em class="li">29</em>;google_apis;x86</code>:用于创建<strong class="ix hj"> avd </strong></li></ul><p id="2c84" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">接受Android SDK的所有许可:</p><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="ko kp l"/></div></figure><p id="3727" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在创建一个<strong class="ix hj">avd</strong>T10】:</p><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="ko kp l"/></div></figure><p id="44c0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">检查一下是否有效！</p><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="ko kp l"/></div></figure></div><div class="ab cl jy jz gp ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hb hc hd he hf"><p id="dddd" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi kf translated">联合国模拟器。</p><p id="efa4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">以下是运行模拟器之前的一些小步骤:</p><ul class=""><li id="aa49" class="kq kr hi ix b iy iz jc jd jg ks jk kt jo ku js kv kw kx ky bi translated">用ADB停止任何正在运行的模拟器。</li><li id="509c" class="kq kr hi ix b iy ld jc le jg lf jk lg jo lh js kv kw kx ky bi translated">用标志<code class="du kz la lb lc b">-no-window</code>和<code class="du kz la lb lc b">-gpu off</code>在后台启动仿真器。</li><li id="7a3c" class="kq kr hi ix b iy ld jc le jg lf jk lg jo lh js kv kw kx ky bi translated">关闭动画以避免不稳定的测试。</li></ul><p id="73e4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一些测试用例将在一个小屏幕上不可见的视图上运行——所以我们将模拟器设置为高分辨率(1180x2220)</p><p id="91ce" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们经常需要在不同的操作系统上运行我们的自动化脚本。这通常是因为PC上的操作系统可以是Windows、Linux或Mac OS。CI系统通常运行在Linux上。有了这些多样性，我们需要一个简单的启动。我建议使用以下实现:</p><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="ko kp l"/></div></figure><p id="8c3a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">模拟器启动脚本可能如下所示:</p><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="ko kp l"/></div></figure><p id="ebaf" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">用<code class="du kz la lb lc b">sh create-emulator.sh</code>或<code class="du kz la lb lc b">./create-emulator.sh</code>启动仿真器，并等待直到<code class="du kz la lb lc b">Boot Status: 1</code>，这意味着设备已完全加载并准备好使用。</p><p id="0641" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">输入<code class="du kz la lb lc b"><strong class="ix hj">bg</strong></code>查看后台作业，再次检查。</p><p id="884b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi kf translated"><span class="l kg kh ki bm kj kk kl km kn di">在</span>类Unix操作系统上，<strong class="ix hj"> bg </strong>是作业控制命令。它在后台恢复暂停的作业，在作业运行时将用户返回到shell提示符。</p><h1 id="f510" class="lj lk hi bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">句法</h1><pre class="ju jv jw jx fd mh lc mi mj aw mk bi"><span id="bc86" class="ml lk hi lc b fi mm mn l mo mp">bg [<em class="li">job</em>]</span></pre><p id="c607" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> <em class="li">作业</em> </strong> <em class="li"> — </em>指定您想要在后台运行的作业。工号1称为<strong class="ix hj"> %1 </strong>，工号2称为<strong class="ix hj"> %2 </strong>，以此类推。；<strong class="ix hj"> % </strong>、<strong class="ix hj"> %+ </strong>或<strong class="ix hj"> %% </strong>指当前作业；<strong class="ix hj"> %- </strong>或—指以前的工作。</p><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="ko kp l"/></div></figure><p id="97de" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">另外，我建议创建shell脚本来从AVD管理器中删除模拟器:</p><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="ko kp l"/></div></figure><p id="cc48" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以使用以下命令检查模拟器的创建是否成功:</p><pre class="ju jv jw jx fd mh lc mi mj aw mk bi"><span id="2cd8" class="ml lk hi lc b fi mm mn l mo mp">$ adb devices</span></pre><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es mq"><img src="../Images/9bae4454e5b5c13dbb84dd1486106da2.png" data-original-src="https://miro.medium.com/v2/resize:fit:850/format:webp/1*vDqz6GNibRhgccKA5rb55A.png"/></div></figure><p id="766f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们已经成功地在容器中运行了一个Android模拟器！</p></div><div class="ab cl jy jz gp ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hb hc hd he hf"><p id="f0a6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi kf translated">建立一个码头工人的形象。</p><p id="b142" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">打开一个新的终端标签，停止<strong class="ix hj">name-of-your-Android-container</strong>并提交您的更改以创建一个新的Docker映像:</p><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="ko kp l"/></div></figure><p id="d99a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">再次测试:</p><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="ko kp l"/></div></figure><p id="4258" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了进一步使用，我们需要创建一个<code class="du kz la lb lc b">Dockerfile</code>:</p><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="ko kp l"/></div></figure><p id="d697" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了自动化为不同版本应用许可证的过程，您需要创建一个文件<strong class="ix hj"> license_accepter.sh </strong>，其内容如下:</p><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="ko kp l"/></div></figure><p id="2de8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi kf translated">构建项目并运行测试。</p><p id="a9ed" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">检查您的项目配置，并使用适当的参数构建docker映像:</p><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="ko kp l"/></div></figure><p id="2ad8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">进入项目目录的顶层并运行:</p><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="ko kp l"/></div></figure><ul class=""><li id="3e38" class="kq kr hi ix b iy iz jc jd jg ks jk kt jo ku js kv kw kx ky bi translated">-it:交互模式。</li><li id="0353" class="kq kr hi ix b iy ld jc le jg lf jk lg jo lh js kv kw kx ky bi translated">— rm:在该过程完成后删除卷。</li><li id="a4f6" class="kq kr hi ix b iy ld jc le jg lf jk lg jo lh js kv kw kx ky bi translated">-v <code class="du kz la lb lc b">$PWD:/project</code>:将你的目录挂载到容器:<code class="du kz la lb lc b">/project</code></li><li id="3659" class="kq kr hi ix b iy ld jc le jg lf jk lg jo lh js kv kw kx ky bi translated">“android-container”:您的容器的名称。</li><li id="7d0f" class="kq kr hi ix b iy ld jc le jg lf jk lg jo lh js kv kw kx ky bi translated">bash <code class="du kz la lb lc b">-c “ . /create-emulator.sh &amp;&amp; gradlew build -p /project”</code>:用项目创建模拟器和挂载文件夹。</li></ul></div><div class="ab cl jy jz gp ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hb hc hd he hf"><p id="7ed8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">结论</strong></p><p id="c1fe" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Docker不仅用于软件开发，还可以用于软件测试。它允许您为web UI或移动测试设置和扩展远程服务器。通过拥有一个隔离且稳定的环境，每个人都可以在一个容器内执行测试，以验证任何开发阶段的系统功能。这个基础设施中的所有容器都可以按需创建，并在测试完成时销毁。它使测试基础设施灵活，并最大限度地利用机器资源。尝试使用Docker为web UI和移动测试构建一个灵活的、一次性的测试基础设施。</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es mr"><img src="../Images/231a99b48e540fa32e0c24d269f4d4da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*rascrB_jyT057jep4YyOrw.png"/></div><figcaption class="iq ir et er es is it bd b be z dx"><a class="ae iu" href="https://test-engineer.site/" rel="noopener ugc nofollow" target="_blank">https://test-engineer.site/</a></figcaption></figure><h1 id="905d" class="lj lk hi bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">作者<a class="ae iu" href="https://www.linkedin.com/in/vaskocuturilo/" rel="noopener ugc nofollow" target="_blank">安东·斯米尔诺夫</a></h1></div></div>    
</body>
</html>