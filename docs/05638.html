<html>
<head>
<title>Building a Form with Ruby On Rails Using Multiple Instances of A Model (Reloaded)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用一个模型的多个实例(重载)用Ruby On Rails构建一个表单</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/building-a-form-with-ruby-on-rails-using-multiple-instances-of-a-model-reloaded-1c3a2f1be26b?source=collection_archive---------11-----------------------#2021-07-27">https://medium.com/geekculture/building-a-form-with-ruby-on-rails-using-multiple-instances-of-a-model-reloaded-1c3a2f1be26b?source=collection_archive---------11-----------------------#2021-07-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="cddb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在2018年，我发表了这篇文章，<a class="ae jd" href="https://tressa-sanders.medium.com/building-a-quiz-with-ruby-on-rails-using-multiple-instances-of-a-model-88e506832af9" rel="noopener">使用一个模型的多个实例用Ruby on Rails构建一个测验</a>，展示了我如何使用一个模型的多个实例用Ruby on Rails创建一个120个问题的测验。它在那个用例中工作得很好，但是当我试图使用代码的修改版本来创建一个包含多个文本字段的面试表单时，我无法让它工作！</p><p id="68fd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，我将向您展示如何创建一个包含面试问题的表单，作为这个特定用例的文本字段。试图让它工作的4天考验给了我更好地理解Ruby和Ruby on Rails的机会。</p><p id="ef5f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">用例:</strong>在我当前的项目中，他们需要一种方法来发布对目标受众的采访，并且需要一种表格来收集个人信息和每个问题的答案。该表单需要能够将个人信息提交到自己的表中，并将每个问题的答案提交到另一个表中。每个答案都需要与个人信息记录和一个问题相关联。</p><p id="563d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">所需结构:</strong></p><ol class=""><li id="c675" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">故事-个人信息</li><li id="e63a" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">故事问题—面试问题</li><li id="c83b" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">故事答案—每个问题的答案</li></ol><p id="e006" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">数据库结构(故事、故事_问题、故事_答案):</strong></p><p id="d621" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将根据你的工作内容而有所不同，但是我已经把它包括进来了，这样你就可以对新特性需要做什么有一个全面的了解。</p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="2d11" class="kb kc hi jx b fi kd ke l kf kg">create_table "stories", options: "ENGINE=InnoDB DEFAULT CHARSET=utf8mb4", force: :cascade do |t|<br/>    t.boolean "published"<br/>    t.boolean "agree"<br/>    t.string "first_name"<br/>    t.string "last_name"<br/>    t.string "slug"<br/>    t.string "email"<br/>    t.string "website"<br/>    t.string "twitter"<br/>    t.string "instagram"<br/>    t.text "bio"<br/>    t.string "photo"<br/>    t.datetime "created_at", precision: 6, null: false<br/>    t.datetime "updated_at", precision: 6, null: false<br/>  end</span><span id="6938" class="kb kc hi jx b fi kh ke l kf kg">create_table "story_questions", options: "ENGINE=InnoDB DEFAULT CHARSET=utf8mb4", force: :cascade do |t|<br/>    t.integer "sort"<br/>    t.boolean "active"<br/>    t.string "question"<br/>    t.datetime "created_at", precision: 6, null: false<br/>    t.datetime "updated_at", precision: 6, null: false<br/> end</span><span id="7d46" class="kb kc hi jx b fi kh ke l kf kg">create_table "story_answers", options: "ENGINE=InnoDB DEFAULT CHARSET=utf8mb4", force: :cascade do |t|<br/>    t.text "answer"<br/>    t.integer "story_question_id"<br/>    t.integer "story_id"<br/>    t.datetime "created_at", precision: 6, null: false<br/>    t.datetime "updated_at", precision: 6, null: false<br/>    t.index ["story_id"], name: "index_story_answers_on_story_id"<br/>    t.index ["story_question_id"], name: "index_story_answers_on_story_question_id"<br/>end</span></pre><p id="a2d2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">模特(story.rb，story_question.rb，story_answer.rb): </strong></p><p id="771c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这些模型包括特征的每个部分所需的关联。如果这个问题被删除了，我不是100%确定这个问题会删除答案，但是现在，还可以。</p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="042a" class="kb kc hi jx b fi kd ke l kf kg">class Story &lt; ApplicationRecord</span><span id="5e9b" class="kb kc hi jx b fi kh ke l kf kg">  has_many :story_answers, dependent: :destroy, :inverse_of =&gt; :story<br/>  accepts_nested_attributes_for :story_answers, :allow_destroy =&gt; true</span><span id="4fc9" class="kb kc hi jx b fi kh ke l kf kg">end</span><span id="53d9" class="kb kc hi jx b fi kh ke l kf kg">class StoryQuestion &lt; ApplicationRecord</span><span id="4890" class="kb kc hi jx b fi kh ke l kf kg">  has_many :story_answers, dependent: :destroy, :inverse_of =&gt; :story_question<br/>  accepts_nested_attributes_for :story_answers, :allow_destroy =&gt; true<br/>  <br/>  include RailsSortable::Model<br/>  set_sortable :sort, without_updating_timestamps: true</span><span id="d992" class="kb kc hi jx b fi kh ke l kf kg">end</span><span id="c375" class="kb kc hi jx b fi kh ke l kf kg">class StoryAnswer &lt; ApplicationRecord</span><span id="d6cf" class="kb kc hi jx b fi kh ke l kf kg"> belongs_to :story, :inverse_of =&gt; :story_answers<br/> accepts_nested_attributes_for :story</span><span id="609c" class="kb kc hi jx b fi kh ke l kf kg"> belongs_to :story_question, :inverse_of =&gt; :story_answers<br/> accepts_nested_attributes_for :story_question</span><span id="34b7" class="kb kc hi jx b fi kh ke l kf kg">end</span></pre><p id="d111" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">所需路线:</strong></p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="673d" class="kb kc hi jx b fi kd ke l kf kg">resources :stories, only: [:index, :show, :new, :create] do<br/> resources :story_answers, only: [:new, :create]<br/> end<br/> get ‘nature-story’ =&gt; ‘stories#new’<br/> post ‘nature-story’ =&gt; ‘stories#create’</span></pre><p id="88f6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">The stories _ controller . Rb:</strong></p><p id="0fa0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个控制器和表单就是神奇发生的地方。我不得不无奈地承认，我花了很长时间才弄明白如何让这个功能工作起来。为同一个模型创建多个文本字段并不难理解。显示每个空答案的每个问题并能够将问题id传递给答案需要一点时间。一旦我想通了，这是令人尴尬的容易。</p><p id="161f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在“新建”操作下，我们正在使用Story.new创建新故事。“新建”页面还在“信息”部分列出了所有问题，以便受访者可以在提交表单之前查看它们，因此我们为此目的向视图提供@story_questions，并在控制器中其下方的构建器块中使用。当我们使用rails builder为每个问题构建story_answer字段时，真正的奇迹出现了。我们用<em class="ki">@ story _ questions . each do | q | @ story . story _ answers . build end</em>。</p><p id="841d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我们需要将story_answers_attributes参数添加到控制器末尾的允许参数中。</p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="3456" class="kb kc hi jx b fi kd ke l kf kg">class StoriesController &lt; ApplicationController<br/>  before_action :set_story, only: %i[ show ]</span><span id="aa88" class="kb kc hi jx b fi kh ke l kf kg">def index<br/>    ...<br/>end</span><span id="1805" class="kb kc hi jx b fi kh ke l kf kg">def show<br/>    ...<br/>end</span><span id="1310" class="kb kc hi jx b fi kh ke l kf kg">def new<br/>   @story = Story.new<br/>   <a class="ae jd" href="http://twitter.com/story_questions" rel="noopener ugc nofollow" target="_blank">@story_questions</a> = StoryQuestion.order(:sort).all<br/>   <a class="ae jd" href="http://twitter.com/story_questions" rel="noopener ugc nofollow" target="_blank">@story_questions</a>.each do |q|<br/>     <a class="ae jd" href="http://twitter.com/story" rel="noopener ugc nofollow" target="_blank">@story</a>.story_answers.build<br/>   end<br/>end</span><span id="2463" class="kb kc hi jx b fi kh ke l kf kg">def create<br/>    <a class="ae jd" href="http://twitter.com/story" rel="noopener ugc nofollow" target="_blank">@story</a> = Story.new(story_params)<br/>    <a class="ae jd" href="http://twitter.com/story" rel="noopener ugc nofollow" target="_blank">@story</a>.published = 0<br/>    <a class="ae jd" href="http://twitter.com/story" rel="noopener ugc nofollow" target="_blank">@story</a>.save</span><span id="46fd" class="kb kc hi jx b fi kh ke l kf kg">respond_to do |format|<br/>      if <a class="ae jd" href="http://twitter.com/story" rel="noopener ugc nofollow" target="_blank">@story</a>.save<br/>        StoryMailer.new_story(<a class="ae jd" href="http://twitter.com/story" rel="noopener ugc nofollow" target="_blank">@story</a>).deliver_later<br/>        format.html { redirect_to new_story_path(anchor: 'interview'), notice: "Your nature story interview has been sent." }<br/>        format.json { render :show, status: :created, location: <a class="ae jd" href="http://twitter.com/story" rel="noopener ugc nofollow" target="_blank">@story</a> }<br/>      else<br/>        format.html { render :new, status: :unprocessable_entity }<br/>        format.json { render json: <a class="ae jd" href="http://twitter.com/story" rel="noopener ugc nofollow" target="_blank">@story</a>.errors, status: :unprocessable_entity }<br/>      end<br/>    end<br/>  end</span><span id="bce2" class="kb kc hi jx b fi kh ke l kf kg">private</span><span id="c06a" class="kb kc hi jx b fi kh ke l kf kg">def set_story<br/>      <a class="ae jd" href="http://twitter.com/story" rel="noopener ugc nofollow" target="_blank">@story</a> = Story.find_by_slug!(params[:id])<br/>    end</span><span id="2fc2" class="kb kc hi jx b fi kh ke l kf kg">def story_params<br/>      params.require(:story).permit(:published, :agree, :first_name, :last_name, :slug, :email, :website, :twitter, :instagram, :bio, :photo, story_answers_attributes: [:id, :answer, :story_question_id, :story_id])<br/>    end</span><span id="e3bb" class="kb kc hi jx b fi kh ke l kf kg">end</span></pre><figure class="js jt ju jv fd kk er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es kj"><img src="../Images/c63844c6ea401c968521e6b3e1ced836.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VVeArKkqp2ScKxa4ttiATQ.jpeg"/></div></div><figcaption class="kr ks et er es kt ku bd b be z dx">Stories Controller</figcaption></figure><p id="c23c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">新故事_ form.html.rb for】</strong></p><p id="2073" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个特性的下一个关键部分是获得正确的表单。您可能从我的上一篇文章中注意到，我使用了form_tag和fields_for。对于这个用例来说，这是不合适或者不需要的。我只需要simple_fields_for标记(我使用的是simple_form gem)。</p><p id="e155" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我在simple_fields_for代码中使用:story_answers，而不是@story_answers，因为我在这些字段中使用构建器。为了显示问题，我为一个故事问题设置了一个局部变量“q ”,其中问题的:sort字段等于story_answer的索引。我做了+ 1，所以索引从1开始，而不是0。在这种情况下，我并不完全熟悉使用索引，也不知道FormBuilder对象会自动让您访问索引，这样您就可以做一些类似于的事情，索引号就会被列出来。</p><p id="a195" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦我访问了问题，我就可以使用q列出答案文本字段的排序号和问题，然后将问题id作为q.id传递给隐藏字段，这样答案在保存时就会与正确的问题相关联。</p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="9b7a" class="kb kc hi jx b fi kd ke l kf kg">&lt;%= simple_form_for <a class="ae jd" href="http://twitter.com/story" rel="noopener ugc nofollow" target="_blank">@story</a>, :url =&gt; nature_story_path do |f| %&gt;</span><span id="47e0" class="kb kc hi jx b fi kh ke l kf kg">...<br/>  <br/>    &lt;div class="col-12 learts-mb-50"&gt;<br/>      &lt;span style="color:red;"&gt;Please try to answer all questions thoughtfully.&lt;/span&gt;<br/>      &lt;hr&gt;<br/>      &lt;br&gt;<br/>        &lt;%= f.simple_fields_for :story_answers do |r| %&gt;<br/>        &lt;% q = StoryQuestion.where(sort: r.index + 1).first %&gt;<br/>        &lt;strong&gt;&lt;%= q.sort %&gt;. &lt;%= q.question %&gt;&lt;/strong&gt;<br/>          &lt;%= r.input :answer, label: false %&gt;<br/>          &lt;%= r.input :story_question_id, :as =&gt; "hidden", :input_html =&gt; { :value =&gt; q.id }, label: false %&gt;<br/>        &lt;% end %&gt;</span><span id="29e9" class="kb kc hi jx b fi kh ke l kf kg">&lt;br&gt;<br/>    &lt;/div&gt;<br/>  <br/>  ...</span><span id="47e9" class="kb kc hi jx b fi kh ke l kf kg">&lt;div class="col-12 text-center learts-mb-50"&gt;<br/>      &lt;button type="submit" class="btn btn-dark btn-outline-hover-dark"&gt;Submit Interview&lt;/button&gt;<br/>    &lt;/div&gt;<br/>  &lt;/div&gt;</span><span id="fa1a" class="kb kc hi jx b fi kh ke l kf kg">&lt;/div&gt;</span><span id="2817" class="kb kc hi jx b fi kh ke l kf kg">&lt;% end %&gt;</span></pre><figure class="js jt ju jv fd kk er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es kv"><img src="../Images/fe5253e4451d6cd8e8015aa734bfcaa1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qD4ChvSoY0kVsncg512Dgw.jpeg"/></div></div><figcaption class="kr ks et er es kt ku bd b be z dx">Story Form</figcaption></figure><p id="2579" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">面试表格页面:</strong></p><p id="fa0f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是最后一页的样子。问题上方的字段用于创建“<em class="ki">故事</em>”的“<em class="ki">个人信息</em>，问题也将提交到它们自己的表格中。</p><blockquote class="kw kx ky"><p id="f934" class="if ig ki ih b ii ij ik il im in io ip kz ir is it la iv iw ix lb iz ja jb jc hb bi translated">总共有14个问题，所以图片中的表格被缩短了，只是为了让您了解发生了什么。</p></blockquote><figure class="js jt ju jv fd kk er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es lc"><img src="../Images/8c8fb1925dedbc6181a5ce28b3c5aa84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iuGgFmmgwhs8TtYk70BeQA.jpeg"/></div></div><figcaption class="kr ks et er es kt ku bd b be z dx">The Form Page</figcaption></figure><p id="1841" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就是这样！这比我的另一个解决方案稍微简单一点，并且很适合这种用例。另一个解决方案适用于具有多项选择题和单选字段的更复杂的表单。</p><p id="6bd1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Rails版本:6.0.3</p></div></div>    
</body>
</html>