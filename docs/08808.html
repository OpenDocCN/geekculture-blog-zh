<html>
<head>
<title>Unit Tests Coverage and Source Code Analysis for Spring Boot Microservices with SonarQube</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用SonarQube对Spring Boot微服务进行单元测试覆盖和源代码分析</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/unit-tests-coverage-and-source-code-analysis-for-spring-boot-microservices-with-sonarqube-464a0d730edc?source=collection_archive---------5-----------------------#2021-11-15">https://medium.com/geekculture/unit-tests-coverage-and-source-code-analysis-for-spring-boot-microservices-with-sonarqube-464a0d730edc?source=collection_archive---------5-----------------------#2021-11-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="2e22" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本文将解释我们如何通过Jenkins集成SonarQube来检查单元测试覆盖率和源代码分析。在这里，我们将创建一个Spring Boot微服务，并为我们的控制器编写单元测试，在使用gradle构建Jenkins的同时，将使用Gradle的“sonar cube”插件将数据推送到sonar cube，然后从SonarQube UI进行分析。</p><h2 id="a5d3" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">1.我们要设置什么</h2><figure class="jz ka kb kc fd kd er es paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="er es jy"><img src="../Images/c5df6a12b6d8212b5f210c2ec1ad7b7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZhqAweoPie8zQ-hyw15dGA.png"/></div></div></figure><h2 id="97b2" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">2.设置SonarQube</h2><p id="4e70" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">当我们取SonarQube时，它主要有两个部分。</p><ol class=""><li id="16a6" class="kp kq hi ih b ii ij im in iq kr iu ks iy kt jc ku kv kw kx bi translated">SonarQube服务器:包含计算引擎、搜索服务器和网络服务器。</li><li id="1cd4" class="kp kq hi ih b ii ky im kz iq la iu lb iy lc jc ku kv kw kx bi translated">sonar cube数据库:帮助存储sonar cube实例的配置和项目的质量快照。</li></ol><p id="4bba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个设置中，我将设置SonarQube服务器和PostgreSQL数据库。请注意，SonarQube也可以支持Microsoft SQL Server和Oracle。要了解更多支持的版本，请参考<a class="ae ld" href="https://docs3.sonarqube.org/latest/requirements/requirements/" rel="noopener ugc nofollow" target="_blank">本</a>。</p><p id="f1b8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">安装PostgreSQL </strong></p><figure class="jz ka kb kc fd kd"><div class="bz dy l di"><div class="le lf l"/></div></figure><p id="f646" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">按照以下步骤，为SonarQube启动并创建一个用户。</p><figure class="jz ka kb kc fd kd"><div class="bz dy l di"><div class="le lf l"/></div></figure><p id="8a0b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们需要为SonarQube设置数据库模式。为此，请遵循以下步骤并执行命令。</p><figure class="jz ka kb kc fd kd"><div class="bz dy l di"><div class="le lf l"/></div></figure><p id="88dc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">安装sonar cube</strong></p><p id="a1b9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下载最新版本。</p><figure class="jz ka kb kc fd kd"><div class="bz dy l di"><div class="le lf l"/></div></figure><p id="b688" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">提取并重命名文件夹。</p><figure class="jz ka kb kc fd kd"><div class="bz dy l di"><div class="le lf l"/></div></figure><p id="2349" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">添加一个用户和组，作为SonarQube的独立用户运行。</p><figure class="jz ka kb kc fd kd"><div class="bz dy l di"><div class="le lf l"/></div></figure><p id="ab98" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">将SonarQube连接到数据库</strong></p><p id="b621" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">前往sudo vim/home/ajanthan/applications/sonar cube/sonar cube/conf/sonar . properties</p><figure class="jz ka kb kc fd kd er es paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="er es lg"><img src="../Images/be20bd923b3cf19db498009cc1f2364c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LEmvYi7KYOs07gCbv26isA.png"/></div></div></figure><p id="861a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">转到sudo vim/home/ajanthan/applications/sonar cube/sonar cube/bin/Linux-x86–64/sonar . sh</p><figure class="jz ka kb kc fd kd er es paragraph-image"><div class="er es lh"><img src="../Images/c3881eec6e235c0b2af56036d326f328.png" data-original-src="https://miro.medium.com/v2/resize:fit:1370/format:webp/1*RdTnlzpwZJTHbFlfSK089w.png"/></div></figure><p id="0922" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要作为服务运行，</p><p id="b5db" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">转到sudo vim/etc/systemd/system/sonar . service并添加以下内容:</p><figure class="jz ka kb kc fd kd"><div class="bz dy l di"><div class="le lf l"/></div></figure><p id="6f02" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">开始执行下面的命令，有时如果你使用不同的java安装目录，那么你也需要更新下面的文件。</p><p id="af23" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">前往sudo vim/home/ajanthan/applications/sonar cube/sonar cube/conf/wrapper . conf</p><figure class="jz ka kb kc fd kd er es paragraph-image"><div class="er es li"><img src="../Images/05cb9b6b5bd1c5fe0fe38a5bbde7a8b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1318/format:webp/1*XzMj5MJKZF0r6zK3ozlWLg.png"/></div></figure><p id="b41a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">执行以下命令启动并检查状态。</p><figure class="jz ka kb kc fd kd"><div class="bz dy l di"><div class="le lf l"/></div></figure><p id="ac32" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">进入<a class="ae ld" href="http://localhost:9000" rel="noopener ugc nofollow" target="_blank"> http://localhost:9000 </a>然后你会被引导到登录页面，在输入默认的admin:admin之后你就可以进入控制台了。</p><figure class="jz ka kb kc fd kd er es paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="er es lj"><img src="../Images/6a695446e7bda2f44c9c6cd65e703fcc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bTgaocKXQ8OzBwWqlRLGCQ.png"/></div></div></figure><h2 id="69ca" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">3.设置微服务项目</h2><p id="9a22" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">Spring Boot本身编写单元测试的选择是基于spring-boot-starter-test依赖关系来编写。这包括我们在编写单元测试时使用的所有依赖库。如果我们需要除此之外的任何其他库，我们可以添加它们以及依赖项。</p><p id="4130" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">JUnit 5:</strong>Java应用程序单元测试的事实标准。</p><p id="93f3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">春季测试&amp; Spring Boot测试:</strong>Spring Boot应用的实用程序和集成测试支持。</p><p id="d8d8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> AssertJ: </strong>一个流畅的断言库。</p><p id="ff5c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Hamcrest: </strong>匹配器对象库(也称为约束或谓词)。</p><p id="e1dc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Mockito: </strong>一个Java嘲讽框架。</p><p id="7f72" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">JSON assert:JSON的断言库。</p><p id="9398" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">JSON path:</strong>JSON的XPath。</p><p id="2870" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">还要注意WebClient单元测试，之前我们使用Mockito库模拟WebClient调用，但是使用MockWebServer有更好的选择，这已经在这里讨论过<a class="ae ld" href="https://www.baeldung.com/spring-mocking-webclient" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="3377" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">build . gradle的配置</strong></p><p id="32ca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里主要使用了两个插件，jacoco用于生成sonar cube可以读取的代码覆盖报告，sonar cube插件用于推送代码分析配置。</p><figure class="jz ka kb kc fd kd"><div class="bz dy l di"><div class="le lf l"/></div></figure><figure class="jz ka kb kc fd kd"><div class="bz dy l di"><div class="le lf l"/></div></figure><p id="775d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将启用基于xml的报告，可以在构建目录下查看。</p><figure class="jz ka kb kc fd kd"><div class="bz dy l di"><div class="le lf l"/></div></figure><p id="7fbb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是为了说明在我们执行。/gradlew test调用jacocoTestReport任务来生成报告。</p><p id="8c25" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，将下面的配置传递给SonarQube，提到了报告的排除和路径。</p><figure class="jz ka kb kc fd kd"><div class="bz dy l di"><div class="le lf l"/></div></figure><h2 id="faa5" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated"><strong class="ak"> 4。设置Jenkins管道</strong></h2><p id="cff5" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">使用下面的管道脚本创建管道。</p><figure class="jz ka kb kc fd kd"><div class="bz dy l di"><div class="le lf l"/></div></figure><h2 id="546a" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">5.在SonarQube中验证</h2><p id="1c7d" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">现在登录SonarQube实例，查看项目并检查统计数据。</p><h2 id="225e" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">参考</h2><p id="322f" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">[1]<a class="ae ld" href="https://www.baeldung.com/spring-mocking-webclient" rel="noopener ugc nofollow" target="_blank">https://www.baeldung.com/spring-mocking-webclient</a></p><p id="245f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">[2]<a class="ae ld" href="https://docs.sonarqube.org/latest/architecture/architecture-integration/" rel="noopener ugc nofollow" target="_blank">https://docs . sonar qube . org/latest/architecture/architecture-integration/</a></p><p id="a49c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">[3]<a class="ae ld" href="https://blog.devgenius.io/spring-boot-deep-dive-on-unit-testing-92bbdf549594" rel="noopener ugc nofollow" target="_blank">https://blog . dev genius . io/spring-boot-deep-dive-on-unit-testing-92 bbdf 549594</a></p></div></div>    
</body>
</html>