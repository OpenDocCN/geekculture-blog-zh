<html>
<head>
<title>API Key and Usage Plan Integration with AWS API Gateway</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">API密钥和使用计划与AWS API网关集成</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/api-key-and-usage-plan-integration-with-aws-api-gateway-2d07bbb9a2a4?source=collection_archive---------8-----------------------#2021-05-23">https://medium.com/geekculture/api-key-and-usage-plan-integration-with-aws-api-gateway-2d07bbb9a2a4?source=collection_archive---------8-----------------------#2021-05-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="192c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">今天，我们将了解如何利用AWS API密钥和使用计划来验证和限制对AWS REST API的请求数量。</p><p id="fbc1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你会在这篇文章的结尾找到完整的代码和sam CLI部署脚本。要直接通过AWS控制台进行配置，请访问<a class="ae jd" href="https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-create-usage-plans.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/API gateway/latest/developer guide/API-gateway-create-usage-plans . html</a></p><h1 id="0b50" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">什么是使用计划和API密钥？</h1><p id="822e" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">一个<em class="kh">使用计划</em>指定谁可以访问一个或多个已部署的API阶段和方法——以及他们可以访问它们的数量和速度。该计划使用API密钥来识别API客户端，并计量每个密钥对相关API阶段的访问。它还允许您配置在单个客户端API密钥上实施的节流限制和配额限制。</p><p id="7093" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kh"> API密钥</em>是由字母数字组成的字符串值，您将其分发给应用程序开发人员客户，以授权他们访问您的API。您可以使用API密钥和<a class="ae jd" href="https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-api-usage-plans.html" rel="noopener ugc nofollow" target="_blank">使用计划</a>或<a class="ae jd" href="https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-use-lambda-authorizer.html" rel="noopener ugc nofollow" target="_blank"> Lambda授权器</a>来控制对您的API的访问。API Gateway可以代表您生成API密钥，或者您可以从一个<a class="ae jd" href="https://docs.aws.amazon.com/apigateway/latest/developerguide/api-key-file-format.html" rel="noopener ugc nofollow" target="_blank"> CSV文件</a>中导入它们。您可以在API Gateway中生成API密钥，或者从外部来源将其导入API Gateway。更多信息，参见<a class="ae jd" href="https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-setup-api-key-with-console.html" rel="noopener ugc nofollow" target="_blank">使用API网关控制台设置API密钥</a>。</p><p id="4713" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们看看集成的示例和步骤:</p><p id="a395" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">确保在template.yaml中的REST API代码中将API Auth添加为true，以使用使用计划和API密钥。您可以使用下面两行将auth设置为true。</p><pre class="ki kj kk kl fd km kn ko kp aw kq bi"><span id="fb7f" class="kr jf hi kn b fi ks kt l ku kv">Resources:<br/>  TestUsagePlanAPI:<br/>    Type: AWS::Serverless::Api<br/>    Properties:<br/>      StageName: !Ref deploymentEnvironment<br/>      Auth:<br/>        ApiKeyRequired: 'true'</span></pre><p id="a677" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过YAML模板创建API后，我们必须添加以下代码来通过YAML模板创建使用计划。这里的使用计划取决于将要创建和集成的API阶段，因此我们需要添加depends on属性，以便它应该等到API阶段创建完毕。</p><p id="96ea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">每月发送的请求数量和限制可以相应地修改。</p><pre class="ki kj kk kl fd km kn ko kp aw kq bi"><span id="e783" class="kr jf hi kn b fi ks kt l ku kv">TestAPIUsagePlan:<br/>    Type: 'AWS::ApiGateway::UsagePlan'<br/>    DependsOn:<br/>      - TestUsagePlanAPI<br/>    Properties:<br/>      ApiStages:<br/>        - ApiId: !Ref TestUsagePlanAPI<br/>          Stage: !Ref deploymentEnvironment<br/>      Description: To test usage plan and api key in REST API.<br/>      Quota:<br/>        Limit: 100<br/>        Period: MONTH<br/>      UsagePlanName: "test-usage-plan"</span></pre><p id="074b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦创建了使用计划，我们就必须创建API密匙。</p><pre class="ki kj kk kl fd km kn ko kp aw kq bi"><span id="b151" class="kr jf hi kn b fi ks kt l ku kv">TestApiAccessKey:<br/>    Type: 'AWS::ApiGateway::ApiKey'<br/>    DependsOn:<br/>      - TestUsagePlanAPI<br/>    Properties:<br/>      Name: "test-api-key"<br/>    Description: To test usage plan and api key in REST API.<br/>      Tags: <br/>       - Key: Mode<br/>         Value: Learning<br/>      Enabled: true<br/>      StageKeys:<br/>       - RestApiId: !Ref TestUsagePlanAPI<br/>         StageName: !Ref deploymentEnvironment</span></pre><p id="8efd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们必须将API密钥绑定到使用计划，为此我们将使用以下代码:</p><pre class="ki kj kk kl fd km kn ko kp aw kq bi"><span id="658d" class="kr jf hi kn b fi ks kt l ku kv">LinkUsagePlanApiKey:<br/>    Type: "AWS::ApiGateway::UsagePlanKey"<br/>    Properties:<br/>      KeyId: <br/>       Ref: TestApiAccessKey<br/>      KeyType: API_KEY<br/>      UsagePlanId: <br/>       Ref: TestAPIUsagePlan</span></pre><p id="08f7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">集成完成后，运行sam CLI脚本，在AWS控制台中部署API。现在，您将需要头中的x-api-key来运行api。如果x-api-key没有通过，那么它将抛出错误403 Forbidden。如果与我们在使用计划中设置的每月允许的API请求相比，对API的请求太多，那么它将抛出429个过多的请求。</p><p id="d074" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以从AWS控制台的API Key部分记下x-api-key，如下所示:</p><figure class="ki kj kk kl fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es kw"><img src="../Images/c357b4ec63a208cb7f03b3bfc12ff53e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0s56KmCBaCekHeqp4FkkYA.png"/></div></div></figure><p id="2051" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">点击API键中的<em class="kh"> show </em>，您将获得API键，该API键可在标题中用于调用相应的REST API。我们可以单击使用计划并相应地修改配置。</p><figure class="ki kj kk kl fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es le"><img src="../Images/40f4b4c85df7f0e403ae22a10207bee6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4G4xREMfRn2gMwX7Me0UCg.png"/></div></div></figure><p id="3aa3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我在AWS中创建了一个测试API，它使用理解服务来检测语言。让我们看看用x-api-key调用REST API的例子。</p><p id="e1f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我们调用部署的API而不传递x-api-key，它将给出以下错误:</p><figure class="ki kj kk kl fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es lf"><img src="../Images/dd9742206805819c6b7ee06f5ae343cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XD0TowzkNfSHQpu7M65MYA.png"/></div></div></figure><p id="7285" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">同样，当我们将头中的x-api-key传递给请求api时，我们将得到一个成功的响应。</p><figure class="ki kj kk kl fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es lg"><img src="../Images/99ea2c3dedc0449f7dc6b7f80d9813a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JLkeNeEjjkJw2BOOS8wcVA.png"/></div></div></figure><p id="1601" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我们每月超过API 100的请求数，正如我们在上面的使用计划中添加的那样，将会出现以下错误:</p><figure class="ki kj kk kl fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es lh"><img src="../Images/6a0b29b9aff2f33f0193d59ca9cf889f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ST5egqmXZf9tD69xFH-VeA.png"/></div></div></figure><p id="c375" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要使用postman自动测试具有多个测试用例的API，请阅读文章:<a class="ae jd" href="https://hemnanirohan.medium.com/effectively-use-postman-api-testing-in-simple-steps-with-dynamic-data-in-a-file-for-test-automation-115f1a36ded4" rel="noopener">https://hemnanirohan . medium . com/effectively-use-postman-API-testing-in-simple-steps-with-dynamic-data-in-a-file-for-test-automation-115 f1a 36 ded 4</a></p><p id="fb9c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我希望这篇文章在某种程度上对你有用。要获得完整的代码和部署脚本，请访问https://github.com/Rohan009/aws_api_key_usage_plan<a class="ae jd" href="https://github.com/Rohan009/aws_api_key_usage_plan" rel="noopener ugc nofollow" target="_blank"/></p></div></div>    
</body>
</html>