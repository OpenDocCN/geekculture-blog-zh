<html>
<head>
<title>How to keep SQL “GROUP BY” details/information for the purpose of tracking</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何保存SQL“GROUP BY”详细信息/信息以便跟踪</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/how-to-keep-sql-group-by-details-information-for-the-purpose-of-tracking-4a33fc443977?source=collection_archive---------11-----------------------#2022-03-05">https://medium.com/geekculture/how-to-keep-sql-group-by-details-information-for-the-purpose-of-tracking-4a33fc443977?source=collection_archive---------11-----------------------#2022-03-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="62fd" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">以MSSQL为例</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/0e135f7c09214ac34255bd2da359cd5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*HuLAN-ll7eE1zG82.jpg"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Photo from: <a class="ae jn" href="https://learnsql.com/blog/group-by-in-sql-explained/" rel="noopener ugc nofollow" target="_blank">https://learnsql.com/blog/group-by-in-sql-explained/</a></figcaption></figure><p id="6f3e" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">假设我们有表“<em class="kk"> ProductionWork </em>”，它记录了生产过程的制造元数据。</p><pre class="iy iz ja jb fd kl km kn ko aw kp bi"><span id="09f0" class="kq kr hi km b fi ks kt l ku kv">DECLARE <a class="ae jn" href="http://twitter.com/ProductionWork" rel="noopener ugc nofollow" target="_blank">@ProductionWork</a> TABLE<br/>(<br/>   WorkOrder varchar(20), -- store work order number<br/>   Material varchar(15),<br/>   Quantity smallint,<br/>   Multiplier smallint -- multiplier for the quantity<br/>);</span><span id="4c94" class="kq kr hi km b fi kw kt l ku kv">-- create some sample data<br/>INSERT INTO <a class="ae jn" href="http://twitter.com/ProductionWork" rel="noopener ugc nofollow" target="_blank">@ProductionWork</a> VALUES<br/>('WO#1', 'M1', 9, 2),<br/>('WO#1', 'M2', 11, 1),<br/>('WO#1', 'M3', 1, 2),<br/>('WO#2', 'M1', 2, 5),<br/>('WO#2', 'M3', 7, 1),<br/>('WO#3', 'M1', 6, 3),<br/>('WO#3', 'M5', 5, 2);</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es kx"><img src="../Images/abd82a40c3b79d3eb95409309e469b13.png" data-original-src="https://miro.medium.com/v2/resize:fit:690/format:webp/1*-YNHq7bAAADNNhJ98h2HYw.png"/></div></figure><blockquote class="ky kz la"><p id="88dd" class="jo jp kk jq b jr js ij jt ju jv im jw lb jy jz ka lc kc kd ke ld kg kh ki kj hb bi translated">根据上表，我们可能知道完成整个制造流程的WO#1应消耗的材料:M1: 18 (9 x 2)、M2: 11 (11 x 1)和M3: 2 (1 x 2)。</p></blockquote><p id="e807" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">然后我们有另外一个表“<em class="kk">materialsinventoryonhan”和</em>，保存每种材料的最新库存数量。</p><pre class="iy iz ja jb fd kl km kn ko aw kp bi"><span id="f847" class="kq kr hi km b fi ks kt l ku kv">DECLARE <a class="ae jn" href="http://twitter.com/MaterialInventoryOnH" rel="noopener ugc nofollow" target="_blank">@MaterialInventoryOnH</a>and TABLE<br/>(<br/>   Material varchar(15),<br/>   Quantity smallint  -- quantity on hand<br/>);</span><span id="b0b9" class="kq kr hi km b fi kw kt l ku kv">-- create some sample data on hand<br/>INSERT INTO <a class="ae jn" href="http://twitter.com/MaterialInventoryOnH" rel="noopener ugc nofollow" target="_blank">@MaterialInventoryOnH</a>and VALUES<br/>('M1', 100),<br/>('M2', 10),<br/>('M3', 10),<br/>('M4', 1),<br/>('M5', 25);</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es le"><img src="../Images/584c08a6c06f98a60294e337d90aa485.png" data-original-src="https://miro.medium.com/v2/resize:fit:366/format:webp/1*kMLWibCno3eLCDCN_AEIuw.png"/></div></figure><p id="aad8" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">下一步，我们需要统计和计算目前的生产量，以决定我们是否能生产出没有任何问题的最终产品？以下脚本总结了制造数据的材料，但也通过动作记录了<strong class="jq hj">组中的工单编号。</strong></p><pre class="iy iz ja jb fd kl km kn ko aw kp bi"><span id="c8dd" class="kq kr hi km b fi ks kt l ku kv">;WITH Sum_Material_Qty_CTE AS<br/>(<br/>  SELECT<br/>    Material,<br/>    STUFF((<br/>            SELECT ',' + WorkOrder<br/>   FROM  <a class="ae jn" href="http://twitter.com/ProductionWork" rel="noopener ugc nofollow" target="_blank">@ProductionWork</a> AS S<br/>   WHERE O.Material = S.Material  <br/>            FOR XML PATH('') <br/>         ), 1, 1, '') AS WO_SEQ,<br/>    SUM(O.ComsumeQty) as TotalConsumeQtyPerMaterial<br/>   FROM<br/>   (<br/>       SELECT<br/>         WorkOrder,<br/>         Material,<br/>         Quantity * Multiplier AS [ComsumeQty]<br/>       FROM <a class="ae jn" href="http://twitter.com/ProductionWork" rel="noopener ugc nofollow" target="_blank">@ProductionWork</a><br/>   ) AS O<br/>   GROUP BY Material<br/>)</span><span id="d7fe" class="kq kr hi km b fi kw kt l ku kv">SELECT<br/>   S.Material,<br/>   WO_SEQ,<br/>   TotalConsumeQtyPerMaterial,<br/>   H.Quantity AS OnInvHandQty<br/>FROM Sum_Material_Qty_CTE AS S<br/>-- join back with on hand qty<br/>LEFT JOIN <a class="ae jn" href="http://twitter.com/MaterialInventoryOnH" rel="noopener ugc nofollow" target="_blank">@MaterialInventoryOnH</a>and AS H <br/>ON S.Material = H.Material</span></pre><blockquote class="ky kz la"><p id="fd47" class="jo jp kk jq b jr js ij jt ju jv im jw lb jy jz ka lc kc kd ke ld kg kh ki kj hb bi translated">这里的关键点是<strong class="jq hj"> STUFF </strong>函数与<strong class="jq hj"> FOR XML PATH </strong>函数<strong class="jq hj"> </strong>相匹配，这有助于我们在GROUP BY中跟踪每个WO# merge。</p></blockquote><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es lf"><img src="../Images/0e371af844de6221ecfda4759402786b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1146/format:webp/1*-iY9d9nxdW_nPeS4N7eTOg.png"/></div><figcaption class="jj jk et er es jl jm bd b be z dx">Sum_Material_Qty_CTE</figcaption></figure><p id="a84d" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">所以根据上面的结果。我们发现工单:<strong class="jq hj"> <em class="kk"> WO#1 </em> </strong>可能由于<strong class="jq hj"><em class="kk">【M2】</em></strong>的现有库存不足而无法完成。</p><p id="e6c4" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">您也可以使用WO#作为关键字，通过以下方式连接回表Sum_Material_Qty_CTE:</p><pre class="iy iz ja jb fd kl km kn ko aw kp bi"><span id="ff31" class="kq kr hi km b fi ks kt l ku kv">-- caution for the performance for using full wildcard<br/>✍️WO_SEQ LIKE '%,' + WorkOrder + ',%' </span><span id="242e" class="kq kr hi km b fi kw kt l ku kv">✍️WO_SEQ LIKE '%,' + WorkOrder</span><span id="e977" class="kq kr hi km b fi kw kt l ku kv">✍️WO_SEQ LIKE WorkOrder + ',%'</span><span id="9ce2" class="kq kr hi km b fi kw kt l ku kv">✍️WO_SEQ = WorkOrder</span></pre><h1 id="ad82" class="lg kr hi bd lh li lj lk ll lm ln lo lp io lq ip lr ir ls is lt iu lu iv lv lw bi translated">参考</h1><ul class=""><li id="76a7" class="lx ly hi jq b jr lz ju ma jx mb kb mc kf md kj me mf mg mh bi translated"><a class="ae jn" href="https://stackoverflow.com/questions/47689303/how-can-i-sum-strings-in-one-column-into-one-row-in-microsoft-sql-group-by-does/47690995" rel="noopener ugc nofollow" target="_blank">https://stack overflow . com/questions/47689303/how-can-I-sum-strings-in-one-column-into-one-row-in-Microsoft-SQL-group-by-does/47690995</a></li><li id="714b" class="lx ly hi jq b jr mi ju mj jx mk kb ml kf mm kj me mf mg mh bi translated"><a class="ae jn" href="https://docs.microsoft.com/zh-tw/sql/t-sql/functions/stuff-transact-sql?view=sql-server-ver15" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/zh-tw/SQL/t-SQL/functions/stuff-transact-SQL？view=sql-server-ver15 </a></li></ul></div></div>    
</body>
</html>