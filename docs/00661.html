<html>
<head>
<title>WireMock | Create your first Integration tests with WireMock and Kotlin</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">WireMock |使用WireMock和Kotlin创建您的第一个集成测试</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/wiremock-create-your-first-integration-tests-with-wiremock-and-kotlin-8814d5d00bb8?source=collection_archive---------8-----------------------#2021-03-09">https://medium.com/geekculture/wiremock-create-your-first-integration-tests-with-wiremock-and-kotlin-8814d5d00bb8?source=collection_archive---------8-----------------------#2021-03-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/247ab58d6ceae63f9030aa272734974a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*0EvWfJC8YpmTwiGY"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Photo by <a class="ae iu" href="https://unsplash.com/@steve_j?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Steve Johnson</a> on <a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="9a8f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在本文中，我想谈谈用Wiremock模拟服务器响应。如何测试一个使用http请求获取数据并处理数据的函数或整个类？您需要一个实际的测试服务器，上面有实际的数据来测试它。该数据不应再更改，因为测试将依赖于它。这将是一个非常糟糕的解决方案，因为您需要为每个测试配置一个新的数据集，最终得到一个无用的服务器，上面有更多无用的数据。你能做什么？</p><h1 id="d4cd" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">WireMock就是答案。</h1><ul class=""><li id="168c" class="kr ks hi ix b iy kt jc ku jg kv jk kw jo kx js ky kz la lb bi translated">如果您想用不同的输出测试不同的http请求，该怎么办呢？</li><li id="c70a" class="kr ks hi ix b iy lc jc ld jg le jk lf jo lg js ky kz la lb bi translated">如果您想测试相同的url，但每次测试都有不同的输出，该怎么办？</li><li id="f89f" class="kr ks hi ix b iy lc jc ld jg le jk lf jo lg js ky kz la lb bi translated">如果您想指定一个url在所有测试中被全局调用时的行为，该怎么办呢？</li></ul><p id="0eac" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">WireMock是所有这些问题的答案。</p><h1 id="ac05" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">依赖关系</h1><p id="c739" class="pw-post-body-paragraph iv iw hi ix b iy kt ja jb jc ku je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">这些是我们在测试中需要的梯度依赖关系。注意到我还加了<a class="ae iu" href="https://assertj.github.io/doc/" rel="noopener ugc nofollow" target="_blank"> assertJ </a>和<a class="ae iu" href="https://khttp.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank"> khttp </a>？这在测试时会很有用。</p><figure class="lk ll lm ln fd ij"><div class="bz dy l di"><div class="lo lp l"/></div></figure><h1 id="5c7d" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">要测试的代码</h1><p id="c2e2" class="pw-post-body-paragraph iv iw hi ix b iy kt ja jb jc ku je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">这是要测试的代码。</p><figure class="lk ll lm ln fd ij"><div class="bz dy l di"><div class="lo lp l"/></div></figure><ol class=""><li id="af43" class="kr ks hi ix b iy iz jc jd jg lq jk lr jo ls js lt kz la lb bi translated">在这个类中，我们有两个方法，第二个方法从Jenkins REST API接收包含HTML文本的响应并返回它。它将khttp用于get请求。</li><li id="d12f" class="kr ks hi ix b iy lc jc ld jg le jk lf jo lg js lt kz la lb bi translated">第一种方法使用参数，并将分支双重编码为branchName。这是因为在Jenkins中斜线需要被编码。</li><li id="a1d4" class="kr ks hi ix b iy lc jc ld jg le jk lf jo lg js lt kz la lb bi translated">该方法调用receiveResponse()函数。</li><li id="98be" class="kr ks hi ix b iy lc jc ld jg le jk lf jo lg js lt kz la lb bi translated">如果statusCode正好是200，它将返回修订标记后的字符串，这是一个git散列。</li><li id="ee9f" class="kr ks hi ix b iy lc jc ld jg le jk lf jo lg js lt kz la lb bi translated">如果不是这样，它会打印出一个响应并抛出一个自定义异常。</li></ol><p id="058c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">测试整个类而不是其中一部分的唯一方法是使用WireMock进行集成测试。</p><h1 id="8682" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">整合测试</h1><figure class="lk ll lm ln fd ij"><div class="bz dy l di"><div class="lo lp l"/></div></figure><ol class=""><li id="8b51" class="kr ks hi ix b iy iz jc jd jg lq jk lr jo ls js lt kz la lb bi translated">首先，我们需要创建一个带有TestInstance注释的新测试类。</li><li id="348f" class="kr ks hi ix b iy lc jc ld jg le jk lf jo lg js lt kz la lb bi translated">创建带有动态端口的WireMock服务器。</li><li id="e2aa" class="kr ks hi ix b iy lc jc ld jg le jk lf jo lg js lt kz la lb bi translated">创建Jenkins类的对象</li><li id="acc7" class="kr ks hi ix b iy lc jc ld jg le jk lf jo lg js lt kz la lb bi translated">启动服务器，并为本地主机和BeforeAll注释内的端口进行配置。</li><li id="268c" class="kr ks hi ix b iy lc jc ld jg le jk lf jo lg js lt kz la lb bi translated">为要测试get请求的url创建一个stub。此url需要没有基本URL ( <a class="ae iu" href="http://localhost." rel="noopener ugc nofollow" target="_blank"> http://localhost </a>)。</li><li id="5d16" class="kr ks hi ix b iy lc jc ld jg le jk lf jo lg js lt kz la lb bi translated">它将返回状态为200的响应</li><li id="044e" class="kr ks hi ix b iy lc jc ld jg le jk lf jo lg js lt kz la lb bi translated">它的主体包含一个HTML文本，在我们的例子中，该文本在Revision子句后包含一个git散列。</li><li id="e738" class="kr ks hi ix b iy lc jc ld jg le jk lf jo lg js lt kz la lb bi translated">我们调用我们的方法来测试并将结果保存到val散列中。</li><li id="9b13" class="kr ks hi ix b iy lc jc ld jg le jk lf jo lg js lt kz la lb bi translated">最后一部分是断言散列等于特定的git散列。</li></ol><p id="c4ac" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这个测试中，我们将WireMock服务器配置为只在特定的测试中进行响应。我们还可以将stubFor放入BeforeAll注释中，并在每个测试中重用它。这将是一个例子…</p><figure class="lk ll lm ln fd ij"><div class="bz dy l di"><div class="lo lp l"/></div></figure><p id="9751" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">有了这个工具，可能性几乎是无限的。</p><h1 id="5b8e" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">反射</h1><h2 id="a166" class="lu ju hi bd jv lv lw lx jz ly lz ma kd jg mb mc kh jk md me kl jo mf mg kp mh bi translated">下次我还会这样做吗？</h2><p id="3e0d" class="pw-post-body-paragraph iv iw hi ix b iy kt ja jb jc ku je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">是的，大部分是。我肯定会选择同样的嘲讽工具，但是像大多数情况下一样，我会多读一点它的文档。这将节省我一些时间来尝试让它工作。</p><h2 id="4e33" class="lu ju hi bd jv lv lw lx jz ly lz ma kd jg mb mc kh jk md me kl jo mf mg kp mh bi translated">什么进展顺利？</h2><p id="c4f5" class="pw-post-body-paragraph iv iw hi ix b iy kt ja jb jc ku je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">带有动态端口的WireMock服务器的创建比预期的要好。这真的很简单直接。</p><h2 id="806a" class="lu ju hi bd jv lv lw lx jz ly lz ma kd jg mb mc kh jk md me kl jo mf mg kp mh bi translated">有哪些需要改进的地方？</h2><p id="7814" class="pw-post-body-paragraph iv iw hi ix b iy kt ja jb jc ku je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">下一次，我会在文档中读到更多关于我的特定用例的内容。大多数文章都是关于带有Spring框架的WireMock，它提供了一些我无法使用的额外注释。我对stubFor get()的定义有问题。我认为我需要使用前面带有<a class="ae iu" href="http://localhost" rel="noopener ugc nofollow" target="_blank"> http://localhost </a>的整个链接，但是我没有。我费了很大劲才找到这个错误，但最终这个错误出现在了<a class="ae iu" href="http://wiremock.org/docs/getting-started/#writing-a-test-with-junit-4x" rel="noopener ugc nofollow" target="_blank">文档</a>中。</p><p id="fcec" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我希望这篇文章对你有用，感谢阅读😊</p></div></div>    
</body>
</html>