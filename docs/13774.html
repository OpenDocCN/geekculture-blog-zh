<html>
<head>
<title>Money operations with Node.js and PostgreSQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Node.js和PostgreSQL进行货币操作</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/money-operations-with-node-js-and-postgresql-91d1f06ff263?source=collection_archive---------5-----------------------#2022-07-28">https://medium.com/geekculture/money-operations-with-node-js-and-postgresql-91d1f06ff263?source=collection_archive---------5-----------------------#2022-07-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/8b028e752c1673c4144e159ad0084e98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DzJW9yRYW64TQaTP-9-OYw.jpeg"/></div></div></figure><p id="bd23" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你在做一个商业项目，你必须和钱打交道。你可能会问“那么，有什么问题呢？钱只是数字”。嗯，没那么简单。许多开发人员会犯常见的错误和/或没有考虑Node.js的特性。</p><h1 id="5b3f" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">Node.js中的数字</h1><p id="6c63" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">先说基础的，Node.js中的数字是什么？强类型语言为开发人员提供了几种数字类型:</p><ul class=""><li id="7a51" class="kr ks hi is b it iu ix iy jb kt jf ku jj kv jn kw kx ky kz bi translated">整数:<code class="du la lb lc ld b">byte</code>、<code class="du la lb lc ld b">int16</code>、<code class="du la lb lc ld b">int32</code>、<code class="du la lb lc ld b">int64</code>和无符号类型</li><li id="2ed1" class="kr ks hi is b it le ix lf jb lg jf lh jj li jn kw kx ky kz bi translated">浮点:<code class="du la lb lc ld b">float32</code>、<code class="du la lb lc ld b">float64</code> / <code class="du la lb lc ld b">double</code></li><li id="0f35" class="kr ks hi is b it le ix lf jb lg jf lh jj li jn kw kx ky kz bi translated">定点/小数。有些语言提供了开箱即用，有些则没有</li></ul><p id="a25c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在Node.js/TypeScript，只有一种存储数字的类型<code class="du la lb lc ld b">number</code>，而且只是一种<code class="du la lb lc ld b">float64</code>类型。意味着您可以安全地对从<em class="lj"> -9007199254740991 </em>到<em class="lj"> 9007199254740991 </em>的整数进行加减乘除。但是有了除法和非整数，就没那么简单了。下面是关于浮点类型最常见的笑话:</p><pre class="lk ll lm ln fd lo ld lp lq aw lr bi"><span id="94a7" class="ls jp hi ld b fi lt lu l lv lw">&gt; 0.1 + 0.2<br/>0.30000000000000004</span></pre><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lx"><img src="../Images/036171cf300f554662c606b6d74e8fb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ryYtW6YKVlgqeCBTSHGOEg.jpeg"/></div></div></figure><p id="8812" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">任何小数点后有数字的运算都是不精确的。大多数情况下你可能不会考虑到它。但是诸如账单、会计、税收等等。，这很关键。</p><p id="1304" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lj">*其实我在撒谎，Node.js v10推出了一个新类型</em> <code class="du la lb lc ld b"><em class="lj">BigInt</em></code> <em class="lj">，不过我们今天就不说了。</em></p><h1 id="5394" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">怎么解决？</h1><p id="dc37" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">想法很简单:如果非整数不能保证精度，那就用整数吧。首先，我们需要在小数点后多少位数上达成一致。如果我们谈论的是钱，最有可能的答案是存储美分的2位数。我们可以将一个数字存储为<em class="lj"> 1999 </em>，而不是存储为<em class="lj"> 19.99 </em>，记住最后两位数字代表美分。这一招可以让你安全地加，减，乘钱而不损失精度。分呢？</p><p id="e22f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">例如，我们希望获得净价为<em class="lj"> $19.99 </em>，增值税率为20%。</p><pre class="lk ll lm ln fd lo ld lp lq aw lr bi"><span id="aed1" class="ls jp hi ld b fi lt lu l lv lw">netPrice = totalPrice / (1 + vatRate / 100)</span><span id="7026" class="ls jp hi ld b fi ly lu l lv lw">// with vatRate 20%<br/>netPrice = totalPrice / 1.2</span></pre><p id="0bbb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">它给出了常规数字:</p><pre class="lk ll lm ln fd lo ld lp lq aw lr bi"><span id="f51e" class="ls jp hi ld b fi lt lu l lv lw">&gt; 19.99 / 1.2<br/>16.65833333333333</span></pre><p id="ae46" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用整数技术，我们需要做的就是在除法之后调用<code class="du la lb lc ld b">Math.round</code>:</p><pre class="lk ll lm ln fd lo ld lp lq aw lr bi"><span id="8d8e" class="ls jp hi ld b fi lt lu l lv lw">&gt; Math.round(1999 / 1.2)<br/>1666</span></pre><p id="7e65" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">以人类可读的格式，它给出了16.66美元。0.00166666666666687036我们已经输了<em class="lj">了，但是对于金融操作来说，这是预期行为。</em></p><p id="c594" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当然，你不需要自己处理这些事情，<a class="ae lz" href="https://currency.js.org/" rel="noopener ugc nofollow" target="_blank"> Currency.js </a>的作者已经实现了所有必要的功能。这个库非常简单、轻量级，并且与浏览器兼容。</p><h1 id="f734" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">存储在PostgreSQL中</h1><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ma"><img src="../Images/08ab0650599e341b69a7b33526e8f466.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R8mxfmPSSnT2YQ5W8R2GIg.jpeg"/></div></div></figure><p id="679f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">好了，现在Node.js里可以用钱操作了，但是DB呢？让我们看看PostgreSQL能提供什么。</p><h2 id="e435" class="ls jp hi bd jq mb mc md ju me mf mg jy jb mh mi kc jf mj mk kg jj ml mm kk mn bi translated">打字钱</h2><p id="b570" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">PostgreSQL已经有了一个存储货币的类型。默认情况下，它在小数点后存储2位数字，并返回格式为<code class="du la lb lc ld b">$19.99</code>的字符串。如果您想改变这种行为，您需要覆盖PostgreSQL配置中的<code class="du la lb lc ld b">lc_monetary</code>设置。<code class="du la lb lc ld b">money</code> type还是挺有用的，货币字符前缀很烦人，但是Currency.js可以轻松解析。TypeORM示例:</p><figure class="lk ll lm ln fd ij"><div class="bz dy l di"><div class="mo mp l"/></div></figure><p id="3b39" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当您需要支持多种货币时，问题就出现了。<code class="du la lb lc ld b">money</code> type只支持一种货币设置。例如，科威特第纳尔小数点后有3位，与欧元和美元放在一起不方便。而<code class="du la lb lc ld b">money</code>型不能处理加密货币。</p><p id="32e0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一般来说，如果你的项目只使用一种货币，<code class="du la lb lc ld b">money</code> type是一个容易的选择。但如果你有在全球扩张并支持加密货币的伟大计划，你需要选择另一种方法。</p><h2 id="ee72" class="ls jp hi bd jq mb mc md ju me mf mg jy jb mh mi kc jf mj mk kg jj ml mm kk mn bi translated">键入十进制和数字</h2><p id="4d4b" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">PostgreSQL中的<code class="du la lb lc ld b">decimal</code>和<code class="du la lb lc ld b">numeric</code>类型是一样的，最多可以存储点后<em class="lj"> 16383 </em>位和点前<em class="lj"> 131072 </em>位。储存任何货币都绰绰有余。基本上，<code class="du la lb lc ld b">money</code>类型是<code class="du la lb lc ld b">decimal/numeric</code>类型的子类型，具有预设的配置和格式。对我来说，这些类型的主要头痛是选择精度和规模，这将适合所有可能的值。你的服务价格可能不会很高，但如果你需要做年度报告，总收入可能会很高。所以，要让<code class="du la lb lc ld b">decimal/numeric</code>存储所有可能的值，需要设置最大可能值，比如说100亿，就是小数点前10位。如果你必须支持BTC，那就是小数点后8位数。我们一起得到<code class="du la lb lc ld b">numeric(8, 18)</code>，它消耗了5个字节。</p><p id="828c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du la lb lc ld b">decimal/numeric</code> type是为高精度的数字运算而创建的，它很好地实现了自己的目的。不知道补充什么:)</p><h2 id="4e59" class="ls jp hi bd jq mb mc md ju me mf mg jy jb mh mi kc jf mj mk kg jj ml mm kk mn bi translated">bigint类型</h2><p id="1d54" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">整数类型也可以用于PostgreSQL端的货币操作。我们只需要像在Node.js中那样以分为单位存储值，因为PostgreSQL是强类型的，所以您不必关心舍入:<code class="du la lb lc ld b">SELECT 100/3</code>返回<code class="du la lb lc ld b">33</code>。首先，我们需要创建一个包含货币列表的表，其中包含字段<code class="du la lb lc ld b">id</code>、<code class="du la lb lc ld b">symbol</code>和<code class="du la lb lc ld b">scale</code>。将<code class="du la lb lc ld b">currency_id</code>列和外键添加到包含货币的表中，并在选择查询中连接货币表。在Node.js端，使用选项<code class="du la lb lc ld b">fromCents:true</code>和<code class="du la lb lc ld b">precision</code>将其映射到Currency.js。</p><p id="3bba" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">与上面的类型相比，使用整数类型可能看起来过于复杂，但是使用整数类型的操作比使用<code class="du la lb lc ld b">decimal/numeric</code>要快50%以上。感谢<a class="ae lz" href="http://twitter.com/jasonlv_87745" rel="noopener ugc nofollow" target="_blank"> @jasonlv_87745 </a>做了一篇关于性能测量的文章<a class="ae lz" href="https://blog.xendit.engineer/benchmarking-pg-numeric-integer-9c593d7af67e" rel="noopener ugc nofollow" target="_blank">https://blog . Xen dit . engineer/benchmark-pg-numeric-integer-9c 593 D7 af 67 e</a></p><h1 id="f71a" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">序列化</h1><p id="b643" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">现在我们知道了如何在PostgreSQL中存储钱，以及如何在Node.js端用它进行操作。但是如何在HTTP响应中返回它呢？您可以使用整数方法，返回美分金额和小数点后的位数。或者你可以用Currency.js把它字符串化，选择哪种方式？这完全取决于你的团队。我个人比较喜欢用字符串，因为懒得多加一个字段:)</p><h1 id="a49d" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">几个音符</h1><p id="0838" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">只是一些值得一提的提示</p><ul class=""><li id="08d1" class="kr ks hi is b it iu ix iy jb kt jf ku jj kv jn kw kx ky kz bi translated">尽量在DB端进行金钱操作。PostgreSQL和其他数据库已经证明了自己是货币操作的高性能和健壮的解决方案，只要利用这个优势。</li><li id="0570" class="kr ks hi is b it le ix lf jb lg jf lh jj li jn kw kx ky kz bi translated">最后分。我经常看到类似于<code class="du la lb lc ld b">Currency(price).divide(100).multiply(percentage)</code>的计算，如果价格是<em class="lj"> 0.49 </em>，百分比是<em class="lj"> 20 </em>与Currency.js，你将得到<em class="lj"> 0、</em>，因为<em class="lj"> 0.49 / 100 </em>小于1美分。一个简单的修复<code class="du la lb lc ld b">Currency(price).multiply(percentage).divide(100)</code>解决了这个问题。</li><li id="3674" class="kr ks hi is b it le ix lf jb lg jf lh jj li jn kw kx ky kz bi translated">不要映射到<code class="du la lb lc ld b">Number</code>。<code class="du la lb lc ld b">pg</code>库自动将<code class="du la lb lc ld b">bigint</code>、<code class="du la lb lc ld b">decimal/numeric</code>、<code class="du la lb lc ld b">money</code>和<code class="du la lb lc ld b">float</code>的值映射到Node.js中的字符串，不要用<code class="du la lb lc ld b">Number(...)</code>包装或者调用<code class="du la lb lc ld b">parseInt</code>和<code class="du la lb lc ld b">parseFloat</code>。值作为字符串返回，以避免丢失精度。如果你需要用它们做smth，就用Currency.js。这个建议不适用于<code class="du la lb lc ld b">integer</code>和<code class="du la lb lc ld b">smallint</code>类型，它们被映射到数字，因为它是安全的。</li><li id="fe9a" class="kr ks hi is b it le ix lf jb lg jf lh jj li jn kw kx ky kz bi translated">不要使用<code class="du la lb lc ld b">.toFixed</code>方法。<code class="du la lb lc ld b">.toFixed</code>将一个值舍入到精度，并以字符串形式返回。但是你可能会面临一些奇怪的情况，比如</li></ul><pre class="lk ll lm ln fd lo ld lp lq aw lr bi"><span id="c5d9" class="ls jp hi ld b fi lt lu l lv lw">&gt; 1.055.toFixed(2)<br/>'1.05' // but it must return '1.06'</span></pre><h1 id="308c" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">结论</h1><p id="e3bb" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">今天到此为止。希望这篇文章对你有用。如果没有，好吧，对你有好处，你已经知道关于金钱操作的一切:)欢迎在评论中提问。</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mq"><img src="../Images/85f7d3b529658de41147b4a1afa60090.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*J2EYHWIzmKqrLm1x.jpg"/></div></div></figure><p id="a0ea" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lj">下次见！Servus！</em></p></div></div>    
</body>
</html>