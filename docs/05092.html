<html>
<head>
<title>Uploading a JSON File using API — Cypress.io [shorts]</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用API上传JSON文件— Cypress.io [shorts]</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/uploading-a-json-file-using-api-cypress-io-shorts-578dade376d2?source=collection_archive---------16-----------------------#2021-07-09">https://medium.com/geekculture/uploading-a-json-file-using-api-cypress-io-shorts-578dade376d2?source=collection_archive---------16-----------------------#2021-07-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><blockquote class="if ig ih"><p id="4cba" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">在这个名为<a class="ae jh" href="https://kushalbhalaik.xyz/tag/shorts/" rel="noopener ugc nofollow" target="_blank"> #shorts </a>的新闻系列中，我将挖掘一些小而特殊的问题及其解决方案。你好！</p></blockquote><p id="4534" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们都知道cypress.io是一个非常酷的自动化工具，可以很容易地自动化web应用程序的API和UI部分。Cypress为其成功提供了一切，因为它提供了大部分开箱即用的东西；除了少数几件事之外，一个人必须处理的事情并不容易。</p><p id="8aeb" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">在这篇#short中，我们将探索如何使用cypress自定义命令来处理一个简单的JSON文件上传。</p><p id="d79a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">问题:我们正在解决的问题是上传一个JSON文件，通过多部分/表单数据请求将表单数据传递给API端点。</p><p id="8b4a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">解决方案:我们将从在<strong class="il hj">/cypress/support/command . js</strong>中编写一个名为“<strong class="il hj"> uploadFile() </strong>的自定义cypress命令开始</p><blockquote class="if ig ih"><p id="815f" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated"><strong class="il hj"> uploadFile() </strong>接受2个参数；</p><p id="f6ab" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">url =我们必须上传文件的端点，formData =我们必须传递给端点的表单数据对象</p></blockquote><p id="152b" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">使用Cypress别名创建和检索用户的示例API代码:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="a342" class="ju jv hi jq b fi jw jx l jy jz">/**<br/> * This Command uploads a file to a given POST endpoint<br/> * <br/> * @param {String} url - full URL of the upload endpoint<br/> * @param {String} formData - formaData to be passed as body to endpoint<br/> */<br/>Cypress.Commands.add("uploadFile", (url, formData) =&gt; {<br/>    return cy.server().route("POST", url).as("uploadFileRequest").window().then(window =&gt; {<br/>        var xhr = new window.XMLHttpRequest();<br/>        xhr.open("POST", url);<br/>        xhr.send(formData);<br/>    }).wait("<a class="ae jh" href="http://twitter.com/uploadFileRequest" rel="noopener ugc nofollow" target="_blank">@uploadFileRequest</a>");<br/>});</span></pre><p id="b560" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">上面的命令是使用<a class="ae jh" href="https://docs.cypress.io/api/commands/server" rel="noopener ugc nofollow" target="_blank"> <strong class="il hj"> cy.server() </strong> </a>实现的(在撰写本文时，cypress v.7.7.0现已弃用，将在以后的版本中移到插件中)。在这个命令中，我们使用Javascript窗口方法<a class="ae jh" href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest" rel="noopener ugc nofollow" target="_blank"> XMLHttpRequest() </a>上传这个文件。</p><p id="4b6d" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们可以重复使用这个命令任意次，而不用一次又一次地重复这个代码。</p><p id="597b" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">编写代码:在下面的代码中，我们从fixtures中的user.json获取用户数据。</p><p id="c48d" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">一旦我们有了用户数据，我们就使用<a class="ae jh" href="https://docs.cypress.io/api/utilities/blob#Usage" rel="noopener ugc nofollow" target="_blank">cypress . blob</a><strong class="il hj"><em class="ik">base64 stringtoblob()</em></strong>方法将其转换为blob(将base64字符串转换为blob)。然后，我们使用这个创建的blob，通过使用新的file()创建一个新的File对象来构造一个文件。</p><p id="e5bd" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">之后，只需创建一个简单的表单数据对象，并将这个新形成的文件对象传递到“<strong class="il hj">内容</strong>”表单数据参数中。</p><p id="f57e" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">最后就是调用<em class="ik"> cy.uploadFile() </em>并传递requestURL和form-data。对此请求的响应存储在“@ <strong class="il hj"> createANewUser </strong>”别名中。</p><p id="a91a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">编写创建表单数据的代码并将其传递给<strong class="il hj"> cy.uploadFile() </strong></p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="388f" class="ju jv hi jq b fi jw jx l jy jz">cy.fixture('/test/requestPayloads/user.json', "binary").then(data =&gt; {<br/>            const fileName = "user.json";<br/>            const blob = Cypress.Blob.base64StringToBlob(btoa(JSON.stringify(data)), 'application/json');<br/>            const file = new File([blob], fileName);<br/>            const formData = new FormData();<br/>            formData.set('name', "John");<br/>            formData.set('description', "A new User named John");<br/>            formData.set('id', generateRandomUUID());<br/>            formData.set('citizenship', country.toUpperCase());<br/>            formData.set('content', file);<br/>            <!-- -->cy.uploadFile('/api/v2/user', formData).as('createANewUser');<br/>  });</span></pre><figure class="jl jm jn jo fd kb er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es ka"><img src="../Images/abff98b943fa6c7b6d824b6f422b4dbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ko18gdgjoqgyuuqPb_F-Mg.jpeg"/></div></div></figure><blockquote class="if ig ih"><p id="d7ef" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">注意:<br/><strong class="il hj">btoa(JSON . stringify(data))</strong>需要先将二进制<strong class="il hj"> user.json </strong>数据串转换为base64编码。查看<a class="ae jh" href="https://www.digitalocean.com/community/tutorials/how-to-encode-and-decode-strings-with-base64-in-javascript" rel="noopener ugc nofollow" target="_blank"> <strong class="il hj">此链接</strong> </a>了解有关base64编码/解码的更多信息。</p></blockquote><p id="5283" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated"><strong class="il hj">编辑【2022】:</strong></p><p id="a03a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">在上面的文章中，我们使用现在已经废弃的<strong class="il hj"> cy.server() </strong>和<strong class="il hj"> cy.route() </strong>命令上传JSON文件；尽管他们将来会继续在cypress中作为一个插件工作，直到我们在Cypress控制台中看到一个反对的消息。</p><p id="dc21" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">所以有一个<strong class="il hj"> cy.uploadFile() </strong>命令的替代实现:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="4c27" class="ju jv hi jq b fi jw jx l jy jz">/**<br/> * This Command uploads a file to a given POST endpoint<br/> *<br/> * @param {String} url - full URL of the upload endpoint<br/> * @param {String} formData - formaData to be passed as body to endpoint<br/> */<br/> Cypress.Commands.add("uploadFile", (url, formData) =&gt; {<br/>	return cy.request({<br/>	   method: 'POST',<br/>	   url: url,<br/>	   headers: {<br/>		 'Content-Type': 'application/json'  <br/>	   },<br/>	   body: formData<br/>	 }).as('uploadFileRequest')<br/>	 <br/>})</span></pre><p id="631a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">现在，有时我们从这个注释中得到的响应可能不是普通的JSON，也就是说，它可能包含<a class="ae jh" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer" rel="noopener ugc nofollow" target="_blank"><strong class="il hj">Buffer</strong></a><strong class="il hj"/>对象。</p><p id="0a41" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">因此，我们可以使用下面的代码对此进行清理:<br/> <strong class="il hj">将Javascript ArrayBuffer转换为JSON对象</strong></p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="9f4e" class="ju jv hi jq b fi jw jx l jy jz">cy.get('@uploadFileRequest').then(async (res) =&gt; {<br/>   <br/>   //convert res.body ArrayBuffer to JSON object<br/>   var jsonResponse = JSON.parse(String.fromCharCode.apply(null, new Uint8Array(res.body)))<br/>   return jsonResponse;</span><span id="4059" class="ju jv hi jq b fi ki jx l jy jz">});</span></pre><p id="e260" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">那都是乡亲们！！</p><p id="0257" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated"><em class="ik">原帖</em><a class="ae jh" href="https://kushalbhalaik.xyz/blog/uploading-a-json-file-using-api-cypress-io/" rel="noopener ugc nofollow" target="_blank"><em class="ik">https:kushalbhalaik . XYZ/blog</em></a></p></div></div>    
</body>
</html>