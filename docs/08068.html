<html>
<head>
<title>Fixing SimpleCov Inaccurate Test Coverage Outputs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">修复SimpleCov不准确的测试覆盖输出</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/how-to-fix-inaccurate-test-coverage-outputs-from-simplecov-f4db553e7bee?source=collection_archive---------7-----------------------#2021-10-13">https://medium.com/geekculture/how-to-fix-inaccurate-test-coverage-outputs-from-simplecov-f4db553e7bee?source=collection_archive---------7-----------------------#2021-10-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/ac38041ec5228478f9b8d4bf72bc6cda.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*O-e8vPAKg9XNjSI4"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">Photo by <a class="ae hv" href="https://unsplash.com/@charlfolscher?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Charl Folscher</a> on <a class="ae hv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a> — I wish I was doing this kind of testing…</figcaption></figure><div class=""/><div class=""><h2 id="a09b" class="pw-subtitle-paragraph iv hx hy bd b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm dx translated">不幸的旅程(在Rails 6和Ruby 3中)</h2></div><p id="284e" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">我喜欢Ruby on Rails。通常，有一个宝石存在，你安装它，一切就像魔法一样工作。不幸的是，这不是我在SimpleCov上的经历，simple cov是我为<a class="ae hv" href="https://write-draft.com" rel="noopener ugc nofollow" target="_blank">https://write-draft.com</a>建立的一个测试覆盖宝石。当我按照<code class="du kj kk kl km b">simplecov</code>的说明进行设置时，我的输出报告显示了零覆盖率，尽管我已经写了很多测试。这个数字超过了0。</p><figure class="ko kp kq kr fd hk er es paragraph-image"><div class="er es kn"><img src="../Images/55a8aa8b0ca8e26787391f6859a5c05d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1098/format:webp/1*OG66Nr7yAEW9eL6zwXCiNg.png"/></div><figcaption class="hr hs et er es ht hu bd b be z dx">Screenshot of inaccurate test coverage report</figcaption></figure><p id="0107" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">下面是我找出如何让它工作的旅程。作为参考，下面是我的环境设置:</p><pre class="ko kp kq kr fd ks km kt ku aw kv bi"><span id="2881" class="kw kx hy km b fi ky kz l la lb">MacBook Pro (13-inch, M1, 2020)<br/>ruby 3.0.2p107<br/>rails 6.1.4.1<br/>simplecov 0.21.2</span></pre><p id="d163" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">为了不被那些不幸的食谱网站(只要给我看他妈的食谱！)，下面是解决方案。</p><h2 id="6030" class="kw kx hy bd lc ld le lf lg lh li lj lk jw ll lm ln ka lo lp lq ke lr ls lt lu bi translated">解决办法</h2><ul class=""><li id="986c" class="lv lw hy jp b jq lx jt ly jw lz ka ma ke mb ki mc md me mf bi translated">将<code class="du kj kk kl km b">simplecov</code>宝石添加到<code class="du kj kk kl km b">:test</code>组的宝石档案中。运行<code class="du kj kk kl km b">bundle install</code></li><li id="5e4f" class="lv lw hy jp b jq mg jt mh jw mi ka mj ke mk ki mc md me mf bi translated">在<code class="du kj kk kl km b">environments/test.rb</code>中设置<code class="du kj kk kl km b">config.eager_load = true</code></li><li id="8948" class="lv lw hy jp b jq mg jt mh jw mi ka mj ke mk ki mc md me mf bi translated">将此添加到顶部的<code class="du kj kk kl km b">spec_helper.rb</code>或<code class="du kj kk kl km b">test_helper.rb</code></li></ul><pre class="ko kp kq kr fd ks km kt ku aw kv bi"><span id="372b" class="kw kx hy km b fi ky kz l la lb">require ‘simplecov’<br/>SimpleCov.start ‘rails’</span></pre><ul class=""><li id="9433" class="lv lw hy jp b jq jr jt ju jw ml ka mm ke mn ki mc md me mf bi translated">运行<code class="du kj kk kl km b">rails t</code></li></ul><p id="2731" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">我不想每次都生成这个报告，所以我做了一些改进。</p><h2 id="bb84" class="kw kx hy bd lc ld le lf lg lh li lj lk jw ll lm ln ka lo lp lq ke lr ls lt lu bi translated">改进的解决方案</h2><ul class=""><li id="1b55" class="lv lw hy jp b jq lx jt ly jw lz ka ma ke mb ki mc md me mf bi translated">将<code class="du kj kk kl km b">simplecov</code>宝石添加到<code class="du kj kk kl km b">:test</code>组的宝石文件中。运行<code class="du kj kk kl km b">bundle install</code></li><li id="02c9" class="lv lw hy jp b jq mg jt mh jw mi ka mj ke mk ki mc md me mf bi translated">在<code class="du kj kk kl km b">environments/test.rb</code>中设置<code class="du kj kk kl km b">config.eager_load = true</code></li><li id="d366" class="lv lw hy jp b jq mg jt mh jw mi ka mj ke mk ki mc md me mf bi translated">使用这个漂亮的耙子任务(添加到<code class="du kj kk kl km b">lib/tasks</code>)。使用<code class="du kj kk kl km b">rails test:coverage</code>运行</li></ul><figure class="ko kp kq kr fd hk"><div class="bz dy l di"><div class="mo mp l"/></div><figcaption class="hr hs et er es ht hu bd b be z dx">Rake task for running tests with coverage</figcaption></figure><p id="726b" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">有了这个解决方案，如果您运行<code class="du kj kk kl km b">rails t</code>，您的测试将在没有覆盖的情况下运行。如果您想要生成您的覆盖率输出，运行<code class="du kj kk kl km b">rails test:coverage</code>。这种方式对我来说更有意义，因为我不想每次运行测试时都生成一个覆盖报告(例如，在我的CI管道中)。如果我不打算每次都这样做，最好只在需要使用<code class="du kj kk kl km b">simplecov</code>时才要求。</p><h1 id="a222" class="mq kx hy bd lc mr ms mt lg mu mv mw lk je mx jf ln jh my ji lq jk mz jl lt na bi translated">旅程</h1><p id="447a" class="pw-post-body-paragraph jn jo hy jp b jq lx iz js jt ly jc jv jw nb jy jz ka nc kc kd ke nd kg kh ki hb bi translated">我首先按照安装说明进行操作:</p><ul class=""><li id="900d" class="lv lw hy jp b jq jr jt ju jw ml ka mm ke mn ki mc md me mf bi translated">将<code class="du kj kk kl km b">simplecov</code>宝石添加到<code class="du kj kk kl km b">:test</code>组的宝石文件中。跑<code class="du kj kk kl km b">bundle install</code></li><li id="e093" class="lv lw hy jp b jq mg jt mh jw mi ka mj ke mk ki mc md me mf bi translated">向<code class="du kj kk kl km b">test_helper.rb</code>添加代码(我使用minitest)</li><li id="9fca" class="lv lw hy jp b jq mg jt mh jw mi ka mj ke mk ki mc md me mf bi translated">运行<code class="du kj kk kl km b">rails test</code></li></ul><figure class="ko kp kq kr fd hk er es paragraph-image"><div class="er es kn"><img src="../Images/55a8aa8b0ca8e26787391f6859a5c05d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1098/format:webp/1*OG66Nr7yAEW9eL6zwXCiNg.png"/></div></figure><p id="8985" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">WTF？我知道我的测试不怎么样，但它们确实存在。</p><h2 id="127d" class="kw kx hy bd lc ld le lf lg lh li lj lk jw ll lm ln ka lo lp lq ke lr ls lt lu bi translated">跟随不同解决方案的互联网兔径</h2><p id="920d" class="pw-post-body-paragraph jn jo hy jp b jq lx iz js jt ly jc jv jw nb jy jz ka nc kc kd ke nd kg kh ki hb bi translated">首先，我尝试了<strong class="jp hz">在弹簧禁用的情况下运行</strong> ( <code class="du kj kk kl km b">DISABLE_SPRING=1 rails t</code>)。没有骰子。仍然是0%的覆盖率，但是我确实学会了如何禁用spring。</p><p id="5b2d" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">其他人建议<strong class="jp hz">将</strong> <code class="du kj kk kl km b"><strong class="jp hz"> require ‘simplecov'</strong></code> <strong class="jp hz">和</strong> <code class="du kj kk kl km b"><strong class="jp hz">SimpleCov.start</strong></code> <strong class="jp hz">添加到</strong> <code class="du kj kk kl km b"><strong class="jp hz">bin/rails</strong></code> <strong class="jp hz">文件</strong>的开头，以确保它在测试运行之前启动。这感觉很可疑，但我绝望了，所以我还是试了试。什么都没变。</p><p id="36c5" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">第三个人指出我需要<strong class="jp hz">将</strong> <code class="du kj kk kl km b"><strong class="jp hz">config.eager_load</strong></code> <strong class="jp hz">设置为true </strong>用于我的测试环境。成功了！🎉</p><figure class="ko kp kq kr fd hk er es paragraph-image"><div class="er es ne"><img src="../Images/348bc22d844a3324cbf80bbe7cebb9a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1106/format:webp/1*GkrG2hnzc_DzsUtCZcQ9Ig.png"/></div><figcaption class="hr hs et er es ht hu bd b be z dx">Screenshot of accurate test coverage report</figcaption></figure><p id="6ec3" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">现在，我必须弄清楚这些东西的哪种组合是必要的。我开始排除，直到事情不再起作用。原来，设置<code class="du kj kk kl km b">config.eager_load = true</code>是我唯一需要的。我回去清理了我的<code class="du kj kk kl km b">bin/rails</code>改变，我停止了用<code class="du kj kk kl km b">DISABLE_SPRING=1</code>运行。</p><p id="b79a" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">经过一个多小时的旅程后，最终的修复其实非常简单。一般都是这样的吧？</p><p id="034d" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">在完成<code class="du kj kk kl km b">simplecov</code>的正常安装说明后，设置<code class="du kj kk kl km b">config.eager_load = true</code>。就是这样。希望这为您节省了一点时间:)</p><h2 id="b8e1" class="kw kx hy bd lc ld le lf lg lh li lj lk jw ll lm ln ka lo lp lq ke lr ls lt lu bi translated">但是我真的想每次都产生覆盖率吗？</h2><p id="4d0f" class="pw-post-body-paragraph jn jo hy jp b jq lx iz js jt ly jc jv jw nb jy jz ka nc kc kd ke nd kg kh ki hb bi translated">我决定我没有。也许你感觉不一样。那很好。我还想尝试创建自己的rake任务，所以我把所有东西都移到了rake任务中:</p><figure class="ko kp kq kr fd hk"><div class="bz dy l di"><div class="mo mp l"/></div><figcaption class="hr hs et er es ht hu bd b be z dx">Rake task for running tests with coverage</figcaption></figure><p id="1dd6" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">在做这件事的时候，我学到了一些东西:</p><h2 id="5f34" class="kw kx hy bd lc ld le lf lg lh li lj lk jw ll lm ln ka lo lp lq ke lr ls lt lu bi translated">扩展rake名称空间是可能的</h2><p id="fe83" class="pw-post-body-paragraph jn jo hy jp b jq lx iz js jt ly jc jv jw nb jy jz ka nc kc kd ke nd kg kh ki hb bi translated">我在这里用<code class="du kj kk kl km b">:test</code>名称空间做这件事。我可以添加任务<code class="du kj kk kl km b">test:coverage</code>而不改变默认<code class="du kj kk kl km b">:test</code>名称空间中的任何其他任务。很可爱。</p><h2 id="3b85" class="kw kx hy bd lc ld le lf lg lh li lj lk jw ll lm ln ka lo lp lq ke lr ls lt lu bi translated">如果我的耙子任务需要宝石，我可以在那里要</h2><p id="2ea3" class="pw-post-body-paragraph jn jo hy jp b jq lx iz js jt ly jc jv jw nb jy jz ka nc kc kd ke nd kg kh ki hb bi translated">也许对于更有经验的rails开发人员来说这是显而易见的，但是我仍然在学习事情的来龙去脉。在这种情况下，当我运行这个任务时，我只需要<code class="du kj kk kl km b">simplecov</code>，所以我可以从我的<code class="du kj kk kl km b">test_helper.rb</code>中删除它，把它包含在这里，一切都很好！</p></div><div class="ab cl nf ng gp nh" role="separator"><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk"/></div><div class="hb hc hd he hf"><p id="d35b" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">这就是了。我不幸的漫长求职之旅已经结束了。这是令人沮丧的，但我学到了一些东西。现在，当我想知道我是否应该对我的测试覆盖率感到糟糕时，我可以有一个数字告诉我，而不是一个模糊的直觉😄。</p><p id="f010" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">希望分享这篇文章能让下一个走这条路的人少一点痛苦。:)</p></div></div>    
</body>
</html>