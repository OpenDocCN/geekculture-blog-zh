<html>
<head>
<title>Automation — WordPress Deployment on Kubernetes Multi-Node Cluster launched over AWS using Ansible</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">自动化——使用Ansible通过AWS在Kubernetes多节点集群上部署WordPress</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/automation-wordpress-deployment-on-kubernetes-multi-node-cluster-launched-over-aws-using-ansible-cb6707906af2?source=collection_archive---------10-----------------------#2021-04-30">https://medium.com/geekculture/automation-wordpress-deployment-on-kubernetes-multi-node-cluster-launched-over-aws-using-ansible-cb6707906af2?source=collection_archive---------10-----------------------#2021-04-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/56351b406426c9cd3ff2a6a36a184c04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*onQ7cw00_rMf0DI-GudH1g.gif"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">Created by Akanksha</figcaption></figure><div class=""/><div class=""><h2 id="d68f" class="pw-subtitle-paragraph iu hw hx bd b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl dx translated">使用WordPress部署网站是一项简单的任务，但当涉及到高可用性和快速部署以及编排和自动供应设施时，我们指的是基于云的MNA。</h2></div><p id="2b37" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">著名的网站和博客构建工具WordPress，我们将使用Ansible的Automation在Kubernetes上部署。问题来了，我们为什么需要这种部署，创建POD的必要性是什么？</p><p id="604e" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">豆荚是Kubernetes管理周期的最小单位。如果我们看到官方定义——<strong class="jo hy">吊舱</strong>是<strong class="jo hy"> Kubernetes </strong>中最小、最基本的可展开物体。一个<strong class="jo hy"> Pod </strong>代表集群中正在运行的进程的一个实例。<strong class="jo hy">pod</strong>包含一个或多个容器，例如码头集装箱。当一个<strong class="jo hy"> Pod </strong>运行多个容器时，这些容器作为单个实体进行管理，并共享<strong class="jo hy"> Pod的</strong>资源。</p><p id="9e86" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">当我们在我们的容器上部署我们的WordPress来启动一个网站时，使用WordPress部署网站是一项简单的任务，但当涉及到高可用性和快速部署以及编排和自动供应设施时，我们指的是基于自动化的云的MNA，以实现出色的敏捷设置，只需几秒钟即可完成部署和端点分发。</p><p id="dcc6" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">让我带你去看看这些技术和它们的需求，几天前我写了一篇关于<strong class="jo hy">“使用ANSIBLE在AWS上自动化KUBERNETES集群”</strong>的博客。</p><div class="hh hi ez fb hj ki"><a href="https://akanksha77.medium.com/automate-kubernetes-cluster-over-aws-using-ansible-3a1b3f78cfee" rel="noopener follow" target="_blank"><div class="kj ab dw"><div class="kk ab kl cl cj km"><h2 class="bd hy fi z dy kn ea eb ko ed ef hw bi translated">使用ANSIBLE在AWS上自动化KUBERNETES集群</h2><div class="kp l"><h3 class="bd b fi z dy kn ea eb ko ed ef dx translated">🤔KUBERNETES集群！！这是什么！？Kubernetes是一个编排工具，它可以帮助管理服务容器…</h3></div><div class="kq l"><p class="bd b fp z dy kn ea eb ko ed ef dx translated">akanksha77.medium.com</p></div></div><div class="kr l"><div class="ks l kt ku kv kr kw hp ki"/></div></div></a></div><h1 id="3e70" class="kx ky hx bd kz la lb lc ld le lf lg lh jd li je lj jg lk jh ll jj lm jk ln lo bi translated">Kubernetes:</h1><p id="bf2d" class="pw-post-body-paragraph jm jn hx jo b jp lp iy jr js lq jb ju jv lr jx jy jz ls kb kc kd lt kf kg kh hb bi translated">Kubernetes是一个监控和管理容器的编排工具。它是由谷歌在2014年设计的，是一个开源工具。Kubernetes是为容器的部署、维护和扩展而建立的，以维护特定的状态，并通过各种功能为环境提供持续支持，这些功能包括pod、标签、选择器、控制器、复制控制器、部署控制器、副本集和服务。Kubernetes使用声明性方法进行编排，因此使用声明性语言，即YAML或…..(<a class="ae lu" rel="noopener" href="/linuxworld-informatics-pvt-ltd/in-this-article-i-will-explain-that-how-industries-use-orchestration-tool-to-minimize-server-a3fb7c88cf72">参考我之前在Kubernetes上的博客</a>)</p><div class="hh hi ez fb hj ki"><a rel="noopener follow" target="_blank" href="/linuxworld-informatics-pvt-ltd/in-this-article-i-will-explain-that-how-industries-use-orchestration-tool-to-minimize-server-a3fb7c88cf72"><div class="kj ab dw"><div class="kk ab kl cl cj km"><h2 class="bd hy fi z dy kn ea eb ko ed ef hw bi translated">在本文中，我将解释行业如何使用编排工具来最小化服务器…</h2><div class="kp l"><h3 class="bd b fi z dy kn ea eb ko ed ef dx translated">slack——聊天机器人、群组消息和广播频道的应用程序也使用Kubernetes进行事件通知…</h3></div><div class="kq l"><p class="bd b fp z dy kn ea eb ko ed ef dx translated">medium.com</p></div></div><div class="kr l"><div class="lv l kt ku kv kr kw hp ki"/></div></div></a></div><h1 id="ecc0" class="kx ky hx bd kz la lb lc ld le lf lg lh jd li je lj jg lk jh ll jj lm jk ln lo bi translated">Ansible:</h1><p id="cd82" class="pw-post-body-paragraph jm jn hx jo b jp lp iy jr js lq jb ju jv lr jx jy jz ls kb kc kd lt kf kg kh hb bi translated">自动化在IT领域已经存在了几十年，但Ansible主要是为“配置管理”而设计的，该工具以高度可伸缩性和启动业务的能力进入市场，无需向员工支付高额工资，只需编写脚本来继续配置由负载平衡器启动的每个节点。现在问题来了，Ansible作为自动化提供了什么，我们能依赖它来完成配置管理的所有步骤吗？……( <a class="ae lu" href="https://akanksha77.medium.com/this-article-will-give-you-an-idea-that-how-advancement-and-automation-made-the-configuration-of-62b15ad680ea" rel="noopener">参考我之前在Ansible </a>上的博客)</p><div class="hh hi ez fb hj ki"><a href="https://akanksha77.medium.com/this-article-will-give-you-an-idea-that-how-advancement-and-automation-made-the-configuration-of-62b15ad680ea" rel="noopener follow" target="_blank"><div class="kj ab dw"><div class="kk ab kl cl cj km"><h2 class="bd hy fi z dy kn ea eb ko ed ef hw bi translated">本文将让您了解进步和自动化是如何使配置…</h2><div class="kp l"><h3 class="bd b fi z dy kn ea eb ko ed ef dx translated">自动化在IT领域已经存在几十年了，但Ansible主要是为“配置管理”而设计的。</h3></div><div class="kq l"><p class="bd b fp z dy kn ea eb ko ed ef dx translated">akanksha77.medium.com</p></div></div><div class="kr l"><div class="lw l kt ku kv kr kw hp ki"/></div></div></a></div><h1 id="aec8" class="kx ky hx bd kz la lb lc ld le lf lg lh jd li je lj jg lk jh ll jj lm jk ln lo bi translated">AWS:</h1><p id="d3de" class="pw-post-body-paragraph jm jn hx jo b jp lp iy jr js lq jb ju jv lr jx jy jz ls kb kc kd lt kf kg kh hb bi translated">AWS (Amazon Web Services)提供高水平的服务，因此它是世界上最受欢迎的公共云。根据最近的Gartner报告，AWS在提供最具可用性和安全性的资源和服务方面排名世界第一。AWS提供了一组完全托管的服务，您可以使用它们来构建和运行无服务器应用程序。无服务器应用不需要为后端组件(如计算、数据库、存储、流处理、消息排队等)提供、维护和管理服务器。(<a class="ae lu" href="https://www.linkedin.com/pulse/serverless-computing-cola-company-case-study-akanksha-singh/" rel="noopener ugc nofollow" target="_blank">参考我在AWS上的博客)</a></p><div class="hh hi ez fb hj ki"><a href="https://akanksha77.medium.com/this-article-will-give-you-an-idea-that-how-advancement-and-automation-made-the-configuration-of-62b15ad680ea" rel="noopener follow" target="_blank"><div class="kj ab dw"><div class="kk ab kl cl cj km"><h2 class="bd hy fi z dy kn ea eb ko ed ef hw bi translated">本文将让您了解技术进步和自动化是如何使…</h2><div class="kp l"><h3 class="bd b fi z dy kn ea eb ko ed ef dx translated">自动化在IT领域已经存在几十年了，但Ansible主要是为“配置管理”而设计的。</h3></div><div class="kq l"><p class="bd b fp z dy kn ea eb ko ed ef dx translated">akanksha77.medium.com</p></div></div><div class="kr l"><div class="lw l kt ku kv kr kw hp ki"/></div></div></a></div><h1 id="6ef1" class="kx ky hx bd kz la lb lc ld le lf lg lh jd li je lj jg lk jh ll jj lm jk ln lo bi translated">WordPress:</h1><p id="56fb" class="pw-post-body-paragraph jm jn hx jo b jp lp iy jr js lq jb ju jv lr jx jy jz ls kb kc kd lt kf kg kh hb bi translated">WordPress (WP)是一个用PHP编写的免费开源内容管理系统(CMS ),配有MySQL或MariaDB数据库。它非常灵活，有数以千计的主题、插件和网站开发支持选项，让<a class="ae lu" href="https://www.wp101.com/tutorial/what-is-wordpress/" rel="noopener ugc nofollow" target="_blank">了解更多关于WordPress的信息！！</a></p></div><div class="ab cl lx ly gp lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="hb hc hd he hf"><h1 id="7422" class="kx ky hx bd kz la me lc ld le mf lg lh jd mg je lj jg mh jh ll jj mi jk ln lo bi translated">在继续进行之前，让我们简要介绍一下我们的计划:</h1><ol class=""><li id="f7c2" class="mj mk hx jo b jp lp js lq jv ml jz mm kd mn kh mo mp mq mr bi translated">我们总共有四个EC2实例和一个本地系统，它是一个控制器节点(*RHEL操作系统位于基础操作系统)，我们将从这里运行角色，只需点击一下鼠标就可以设置好一切。</li><li id="983b" class="mj mk hx jo b jp ms js mt jv mu jz mv kd mw kh mo mp mq mr bi translated">实例将由“EC2角色”提供</li><li id="358d" class="mj mk hx jo b jp ms js mt jv mu jz mv kd mw kh mo mp mq mr bi translated">主节点设置是将通过运行“K8s_master”发生的下一个任务</li><li id="9083" class="mj mk hx jo b jp ms js mt jv mu jz mv kd mw kh mo mp mq mr bi translated">下一步是使用“K8s_slave”部署和配置从节点并向主节点注册</li><li id="f018" class="mj mk hx jo b jp ms js mt jv mu jz mv kd mw kh mo mp mq mr bi translated">接下来，NFS服务器将开始提供目录。</li><li id="57e1" class="mj mk hx jo b jp ms js mt jv mu jz mv kd mw kh mo mp mq mr bi translated">然后是用于Wordpress pod设置和PVC声明的kube_wordpress角色。</li><li id="9f53" class="mj mk hx jo b jp ms js mt jv mu jz mv kd mw kh mo mp mq mr bi translated">最后是运行所有角色的设置文件。</li></ol><p id="a97a" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated"><strong class="jo hy"> <em class="mx">第一步:创建可行的配置文件:</em> </strong></p><p id="b2d9" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">Ansible是一个无代理的自动化工具，它需要控制器节点上的清单文件，我已经提到这是我们的本地系统。清单文件可以在路径(/etc/ansible/ansible.cfg)中的控制器节点内全局创建，也可以在我们将要运行剧本/角色的工作区中创建。</p><p id="89e9" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated"><em class="mx">为此项目创建工作区:</em></p><pre class="my mz na nb fd nc nd ne nf aw ng bi"><span id="a59d" class="nh ky hx nd b fi ni nj l nk nl"><strong class="nd hy"># mkdir kube-ansible<br/># cd kube-ansible<br/># mkdir roles<br/># vim ansible.cfg</strong></span></pre><figure class="my mz na nb fd hk"><div class="bz dy l di"><div class="nm nn l"/></div><figcaption class="hr hs et er es ht hu bd b be z dx">ansible.cfg</figcaption></figure><p id="8f9e" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated"><a class="ae lu" href="https://docs.ansible.com/ansible/latest/reference_appendices/config.html#ansible-configuration-settings-locations" rel="noopener ugc nofollow" target="_blank">有关上述文件的解释，请访问！</a></p><p id="9dde" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated"><strong class="jo hy"> <em class="mx">步骤2:为AWS登录和验证实例创建两个文件:</em> </strong></p><ol class=""><li id="fb5b" class="mj mk hx jo b jp jq js jt jv no jz np kd nq kh mo mp mq mr bi translated">一个名为<code class="du nr ns nt nd b">cred.yml</code>的安全库文件，包含IAM访问权限和用于验证您的AWS帐户的密钥。在您的目录“my-ws”中使用<code class="du nr ns nt nd b">ansible-vault create cred.yml</code>创建(给出密码)</li></ol><pre class="my mz na nb fd nc nd ne nf aw ng bi"><span id="3c6d" class="nh ky hx nd b fi ni nj l nk nl"><em class="mx">file format:<br/></em>access_key: GUJGWDUYGUEWVVFEWGVFUYV <br/>secret_key: huadub7635897^%&amp;hdfqt57gvhg</span></pre><p id="01b5" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">2.创建名为<code class="du nr ns nt nd b">ansible.pem</code>的文件，这是我们用来通过AWS帐户远程创建ec2实例的密钥对。</p><h1 id="3ed4" class="kx ky hx bd kz la lb lc ld le lf lg lh jd li je lj jg lk jh ll jj lm jk ln lo bi translated">步骤:</h1><blockquote class="nu nv nw"><p id="1922" class="jm jn mx jo b jp jq iy jr js jt jb ju nx jw jx jy ny ka kb kc nz ke kf kg kh hb bi translated"><em class="hx"> 1。转到AWS管理控制台</em></p><p id="f11e" class="jm jn mx jo b jp jq iy jr js jt jb ju nx jw jx jy ny ka kb kc nz ke kf kg kh hb bi translated"><em class="hx"> 2。EC2仪表板</em></p><p id="c286" class="jm jn mx jo b jp jq iy jr js jt jb ju nx jw jx jy ny ka kb kc nz ke kf kg kh hb bi translated"><em class="hx"> 3。成对钥匙</em></p><p id="2b54" class="jm jn mx jo b jp jq iy jr js jt jb ju nx jw jx jy ny ka kb kc nz ke kf kg kh hb bi translated"><em class="hx"> 4。创建新的密钥对</em></p><p id="9700" class="jm jn mx jo b jp jq iy jr js jt jb ju nx jw jx jy ny ka kb kc nz ke kf kg kh hb bi translated"><em class="hx"> 5。赐名为</em> <code class="du nr ns nt nd b"><em class="hx">ansible</em></code></p><p id="b0ac" class="jm jn mx jo b jp jq iy jr js jt jb ju nx jw jx jy ny ka kb kc nz ke kf kg kh hb bi translated">6。选择。“PEM”文件格式</p><p id="bd53" class="jm jn mx jo b jp jq iy jr js jt jb ju nx jw jx jy ny ka kb kc nz ke kf kg kh hb bi translated">7。将密钥下载到您的本地系统</p><p id="258a" class="jm jn mx jo b jp jq iy jr js jt jb ju nx jw jx jy ny ka kb kc nz ke kf kg kh hb bi translated"><em class="hx"> 8。将密钥转移到您的角色为</em> <code class="du nr ns nt nd b"><em class="hx">kube-ansible</em></code>的同一目录下的责任控制器节点</p></blockquote><p id="e8f8" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated"><strong class="jo hy"> <em class="mx">第三步:创建职责角色:</em> </strong></p><p id="f485" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">接下来，我们将为自动化创建五个主要角色，首先我们将创建NFS服务器，然后是其余四个EC2实例，包括一个主服务器、两个从服务器和一个客户端Kubernetes设置。</p><pre class="my mz na nb fd nc nd ne nf aw ng bi"><span id="fc7f" class="nh ky hx nd b fi ni nj l nk nl"><strong class="nd hy"># mkdir role<br/># cd role<br/># ansible-galaxy init ec2<br/># ansible-galaxy init k8s_master<br/># ansible-galaxy init k8s_slave<br/># ansible-galaxy init k8s_client<br/># ansible-galaxy init nfs-server</strong></span></pre><p id="cb93" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">现在我们已经有了所有的任务、模板、变量文件<em class="mx">和其他基于已知文件结构</em>的可解析工件，它们都被预嵌入到角色中，我们只需要通过包含模块和jinja属性注释来编写我们所需要的所有东西的声明/描述(用YAML语言)。</p><p id="1d12" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">要了解更多角色信息，请访问！</p><p id="4400" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated"><strong class="jo hy"> <em class="mx">步骤4:为存储类设置编写NFS-服务器角色:</em> </strong></p><figure class="my mz na nb fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es oa"><img src="../Images/3d8dac3749fdce5989a1e319aa0f7d57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uhVzk2ZN-JIyzesmmcutDw.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">NFS-Server Setup</figcaption></figure><p id="0123" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">在我们的Kubernetes多节点设置中，此服务器的主要用途是用于存储类，因为PV是注册的，PVC批准仅在此存储中完成。我们已将EBS卷分配给此服务器，进一步的卷分配由网络文件系统完成。该角色本身表明它意味着将存储共享为目录，并在以后在PVC上挂载共享文件夹(永久卷声明)。</p><p id="0bb6" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">🤔<strong class="jo hy">PVC有什么用？</strong> <br/>我们的WordPress依赖于SQL存储，因为它为客户端登录WordPress提供数据库。此外，当我们保证没有停机设置时，我们必须有一个持久的数据存储，以便由于任何种类的POD或节点SPOF，我们的数据不能丢失，客户端不能因此而存活。现在问题来了，它是如何工作的？我们如何将同一个PVC连接到另一个POD？ —答案是我们在Kubernetes中有标记的概念，通过它我们可以链接到我们的资源和服务。我们需要给出的是资源种类，以及由etcd(内部Kubernetes数据库)管理和存储的元数据。PVC是指客户请求批准并从本地或外部(网络)存储中提供所请求存储。</p><pre class="my mz na nb fd nc nd ne nf aw ng bi"><span id="8bcf" class="nh ky hx nd b fi ni nj l nk nl"><strong class="nd hy"># cd role/nfs-server/tasks<br/># vim main.yml</strong></span></pre><figure class="my mz na nb fd hk"><div class="bz dy l di"><div class="nm nn l"/></div><figcaption class="hr hs et er es ht hu bd b be z dx">task.yml</figcaption></figure><p id="da0a" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">我们有变量文件，它包含在角色执行时将被直接调用/替换的值。它包括“共享目录”变量。分别为WordPress和MySQL Pods命名为“/wp”和“/mysql”的两个目录。</p><pre class="my mz na nb fd nc nd ne nf aw ng bi"><span id="9ce2" class="nh ky hx nd b fi ni nj l nk nl"><strong class="nd hy"># cd role/nfs-server/vars<br/># vim main.yml</strong></span></pre><figure class="my mz na nb fd hk"><div class="bz dy l di"><div class="nm nn l"/></div><figcaption class="hr hs et er es ht hu bd b be z dx">var.yml</figcaption></figure><figure class="my mz na nb fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es oa"><img src="../Images/543446914ad8b1e54dd37a33163f81b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GwJPfaef_Ve0NWAlIQ4FuQ.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">ec2-ansible-role</figcaption></figure><p id="8545" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated"><strong class="jo hy"> <em class="mx">第五步:为设置编写EC2角色:</em> </strong></p><p id="b15c" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">为了在AWS EC2中启动实例，我们有以下aws-ec2角色。为此，我们需要一些登录aws帐户的凭证。然后我们将看到角色是如何编写的:</p><pre class="my mz na nb fd nc nd ne nf aw ng bi"><span id="346e" class="nh ky hx nd b fi ni nj l nk nl"><strong class="nd hy"># cd role/ec2/tasks<br/># vim main.yml</strong></span></pre><figure class="my mz na nb fd hk"><div class="bz dy l di"><div class="nm nn l"/></div><figcaption class="hr hs et er es ht hu bd b be z dx">task.yml</figcaption></figure><p id="9a74" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">我们在这个ec2角色中运行八个任务，一个是安装boto3 for AWS API以进行连接，然后是安全组，之后是EC2实例创建，然后使用ansible add_host模块创建动态清单。最后，切换到与所有实例的ssh连接。</p><p id="730d" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">我们有变量文件，它包含在角色执行时将被直接调用/替换的值。我们有四个<strong class="jo hy"> instance_tags </strong>，两个<strong class="jo hy"> python_pkgs </strong>变量和<strong class="jo hy"> sg_name </strong>，<strong class="jo hy"> region_name </strong>，<strong class="jo hy"> subnet_name </strong>，<strong class="jo hy"> ami_id </strong>，<strong class="jo hy"> keypair </strong>，I<strong class="jo hy">instance _ flavor</strong>，并根据您的帐户ARN(亚马逊资源名称)或亚马逊id给出值。</p><pre class="my mz na nb fd nc nd ne nf aw ng bi"><span id="1b2f" class="nh ky hx nd b fi ni nj l nk nl"><strong class="nd hy"># cd role/ec2/vars<br/># vim main.yml</strong></span></pre><figure class="my mz na nb fd hk"><div class="bz dy l di"><div class="nm nn l"/></div><figcaption class="hr hs et er es ht hu bd b be z dx">var.yml</figcaption></figure><figure class="my mz na nb fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es oa"><img src="../Images/d9c7d8707184e8b4d7138363c1dfb52d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NbNKykXBLIpd-Ty-osM7Kg.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">k8s-master-role</figcaption></figure><p id="c749" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated"><strong class="jo hy"> <em class="mx">第五步:编写k8s_master角色:<br/> </em> </strong>对于Kubernetes主节点设置角色描述如何在kube_master角色的tasks文件夹中进行配置。vars文件夹也包含一些变量值:</p><pre class="my mz na nb fd nc nd ne nf aw ng bi"><span id="d028" class="nh ky hx nd b fi ni nj l nk nl"><strong class="nd hy"># cd role/k8s_master/tasks<br/># vim main.yml</strong></span></pre><figure class="my mz na nb fd hk"><div class="bz dy l di"><div class="nm nn l"/></div><figcaption class="hr hs et er es ht hu bd b be z dx">task.yml</figcaption></figure><p id="985b" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">我们在这里有11个任务，包括安装<strong class="jo hy"> kubeadm </strong>、<strong class="jo hy"> kubelet </strong>和<strong class="jo hy"> kubectl </strong>命令，然后从<strong class="jo hy"> dockerhu </strong> b中提取所有管理映像，随后是它们的pod创建和网络覆盖，以及<strong class="jo hy">守护程序驱动程序设置</strong>，最后我们使用flunnel CNI为从节点连接创建一个注册密钥。</p><p id="3f7c" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">我们有变量文件，它包含在角色执行时将被直接调用/替换的值。它包括名为service_name变量，并包含以下值:</p><p id="6402" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">Docker:容器引擎程序，帮助启动容器，然后POD通过标记和标签选择方法管理容器。Docker需要安装在主节点和从节点上，因为后台的kubelet程序连接到docker引擎并启动容器。</p><p id="0d43" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">kube let:<strong class="jo hy">kube let</strong>是运行在每个节点上的主要“节点代理”,它管理运行在单个节点上的容器。</p><pre class="my mz na nb fd nc nd ne nf aw ng bi"><span id="6728" class="nh ky hx nd b fi ni nj l nk nl"><strong class="nd hy"># cd role/k8s_master/vars<br/># vim main.yml</strong></span></pre><figure class="my mz na nb fd hk"><div class="bz dy l di"><div class="nm nn l"/></div></figure><figure class="my mz na nb fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es oa"><img src="../Images/7ccd13810902c8fe16fb9f623499a05b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gnTi6sgzVry19hmPZUVzbA.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">k8s-slave-role</figcaption></figure><p id="3c74" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated"><strong class="jo hy"> <em class="mx">第六步:编写k8s_slave角色:</em> </strong></p><p id="78e3" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">现在让我们在tasks文件夹中为kube_slave角色编写剧本，然后在vars文件夹中提到变量值。与Kubernetes主机相同，从机的先决条件是三个软件，即Docker、Kubeadm和ip-tables。我们必须更新在slave中使用了/etc/sysctl.d/k8s.conf文件的ip表。</p><p id="71f2" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">从节点向主节点的注册/加入只能通过主节点在整个设置和初始化之后提供的密钥来完成。我们需要在从节点中复制密钥。为此，我们在这里使用了令牌。</p><pre class="my mz na nb fd nc nd ne nf aw ng bi"><span id="9654" class="nh ky hx nd b fi ni nj l nk nl"><strong class="nd hy"># cd role/k8s_slave/tasks<br/># vim main.yml</strong></span></pre><figure class="my mz na nb fd hk"><div class="bz dy l di"><div class="nm nn l"/></div><figcaption class="hr hs et er es ht hu bd b be z dx">task.yml</figcaption></figure><pre class="my mz na nb fd nc nd ne nf aw ng bi"><span id="7564" class="nh ky hx nd b fi ni nj l nk nl"><strong class="nd hy"># cd role/k8s_master/vars<br/># vim main.yml</strong></span></pre><figure class="my mz na nb fd hk"><div class="bz dy l di"><div class="nm nn l"/></div><figcaption class="hr hs et er es ht hu bd b be z dx">var.yml</figcaption></figure><figure class="my mz na nb fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es oa"><img src="../Images/56a99a6793be9613eb6369a5b07a14d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9_2BpaIVPx8HD-npq-uNzg.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">kube-wordpress-role</figcaption></figure><p id="b002" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated"><strong class="jo hy"> <em class="mx">第七步:编写kube_wordpress角色:</em> </strong></p><p id="2495" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">这里我们复制了pod /服务设置的YAML代码，因此我们需要角色的三个组成部分，即任务、文件和模板(jinja2格式代码文件)。</p><pre class="my mz na nb fd nc nd ne nf aw ng bi"><span id="8735" class="nh ky hx nd b fi ni nj l nk nl"><strong class="nd hy"># cd role/kube_wordpress/tasks<br/># vim main.yml</strong></span></pre><figure class="my mz na nb fd hk"><div class="bz dy l di"><div class="nm nn l"/></div><figcaption class="hr hs et er es ht hu bd b be z dx">task.yml</figcaption></figure><p id="1607" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">我们有这个模板文件，用于在处理后将Jinja2文件复制到我们的从节点，以便为我们的WordPress和MySQL节点请求和安装PV:</p><pre class="my mz na nb fd nc nd ne nf aw ng bi"><span id="3813" class="nh ky hx nd b fi ni nj l nk nl"><strong class="nd hy"># cd role/k8s_master/vars<br/># vim storage.yml.j2</strong></span></pre><figure class="my mz na nb fd hk"><div class="bz dy l di"><div class="nm nn l"/></div><figcaption class="hr hs et er es ht hu bd b be z dx">storage.yml.j2</figcaption></figure><p id="e8e4" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">我们也有这个角色的文件，其中4个文件命名为“<a class="ae lu" href="https://github.com/akankshaS77/WordPress-on-Kubernetes-AWS-Ansible/blob/main/kube-ansible/roles/kube-wordpress/files/K8s-WordPress/kustomization.yml" rel="noopener ugc nofollow" target="_blank"> kustomization.yml </a>”、“<a class="ae lu" href="https://github.com/akankshaS77/WordPress-on-Kubernetes-AWS-Ansible/blob/main/kube-ansible/roles/kube-wordpress/files/K8s-WordPress/mysql-deploy.yml" rel="noopener ugc nofollow" target="_blank"> mysql-deploy.yml </a>”、“<a class="ae lu" href="https://github.com/akankshaS77/WordPress-on-Kubernetes-AWS-Ansible/blob/main/kube-ansible/roles/kube-wordpress/files/K8s-WordPress/secret.yml" rel="noopener ugc nofollow" target="_blank"> secret.yml </a>”、“<a class="ae lu" href="https://github.com/akankshaS77/WordPress-on-Kubernetes-AWS-Ansible/blob/main/kube-ansible/roles/kube-wordpress/files/K8s-WordPress/wordpress-deploy.yml" rel="noopener ugc nofollow" target="_blank"> wordpress-deploy.yml </a>”，它们将创建pods。</p><p id="5230" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">以下是所有的四个文件，YAML代码创建的基本概念与Kubernetes的reources，kind，apiVersion关键字编写:</p><pre class="my mz na nb fd nc nd ne nf aw ng bi"><span id="5132" class="nh ky hx nd b fi ni nj l nk nl"><strong class="nd hy"># cd role/kube_wordpress/files<br/># vim kustomization.yml<br/># vim mysql-deploy.yml<br/># vim secret.yml<br/># vim wordpress-deploy.yml</strong></span></pre><figure class="my mz na nb fd hk"><div class="bz dy l di"><div class="nm nn l"/></div><figcaption class="hr hs et er es ht hu bd b be z dx">Kustomization.yml</figcaption></figure><figure class="my mz na nb fd hk"><div class="bz dy l di"><div class="nm nn l"/></div><figcaption class="hr hs et er es ht hu bd b be z dx">mysql-deploy.yml</figcaption></figure><figure class="my mz na nb fd hk"><div class="bz dy l di"><div class="nm nn l"/></div><figcaption class="hr hs et er es ht hu bd b be z dx">secret.yml</figcaption></figure><figure class="my mz na nb fd hk"><div class="bz dy l di"><div class="nm nn l"/></div><figcaption class="hr hs et er es ht hu bd b be z dx">wordpress-deploy.yml</figcaption></figure><p id="f4b5" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated"><strong class="jo hy"> <em class="mx">步骤8:创建设置行动手册以运行所有角色并创建AWS集群:</em> </strong></p><p id="b667" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">最后，编写我们的Setup.yml文件，通过调用这些角色来自动完成所有的任务。我们需要在主工作区内创建文件，即kube_ansible:</p><pre class="my mz na nb fd nc nd ne nf aw ng bi"><span id="1d8b" class="nh ky hx nd b fi ni nj l nk nl"><strong class="nd hy"># cd kube_ansible/<br/># vim setup.yml</strong></span></pre><figure class="my mz na nb fd hk"><div class="bz dy l di"><div class="nm nn l"/></div><figcaption class="hr hs et er es ht hu bd b be z dx">setup.yml</figcaption></figure><p id="6eaf" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated"><strong class="jo hy">步骤9:运行剧本Setup.yml </strong></p><p id="39c4" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">使用ansible-playbook命令运行剧本，并提供vault密码以验证和登录AWS帐户。</p><pre class="my mz na nb fd nc nd ne nf aw ng bi"><span id="bc44" class="nh ky hx nd b fi ni nj l nk nl"><strong class="nd hy"># ansible-playbook setup.yml -ask-vault-pass</strong></span></pre><p id="92d6" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">因此我们已经实现了我们的目标“自动化——使用Ansible在AWS上启动的Kubernetes多节点集群上的WordPress部署”。</p><p id="1797" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">你可以在我的GitHub上找到这个项目，只要fork和let使这个项目对客户来说更加系统独立和可靠。</p><div class="hh hi ez fb hj ki"><a href="https://github.com/akankshaS77/WordPress-on-Kubernetes-AWS-Ansible.git" rel="noopener  ugc nofollow" target="_blank"><div class="kj ab dw"><div class="kk ab kl cl cj km"><h2 class="bd hy fi z dy kn ea eb ko ed ef hw bi translated">akankshas 77/WordPress-on-Kubernetes-AWS-ansi ble</h2><div class="kp l"><h3 class="bd b fi z dy kn ea eb ko ed ef dx translated">使用Ansible Automation在AWS EC2实例上提供Kubernetes多节点集群，并在…上部署Wordpress</h3></div><div class="kq l"><p class="bd b fp z dy kn ea eb ko ed ef dx translated">github.com</p></div></div><div class="kr l"><div class="ob l kt ku kv kr kw hp ki"/></div></div></a></div><p id="e4f6" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">如果您想为这个项目做出贡献，或者有进一步的疑问或意见，您可以通过LinkedIN联系我:</p><div class="hh hi ez fb hj ki"><a href="https://www.linkedin.com/in/akanksha-singh-as/" rel="noopener  ugc nofollow" target="_blank"><div class="kj ab dw"><div class="kk ab kl cl cj km"><h2 class="bd hy fi z dy kn ea eb ko ed ef hw bi translated">阿康沙·辛格-成功负责人@ ARTH -技术学院- LinuxWorld Informatics Pvt有限公司…</h2><div class="kp l"><h3 class="bd b fi z dy kn ea eb ko ed ef dx translated">在全球最大的职业社区LinkedIn上查看阿康沙·辛格的个人资料。阿康沙有3个工作列在…</h3></div><div class="kq l"><p class="bd b fp z dy kn ea eb ko ed ef dx translated">www.linkedin.com</p></div></div><div class="kr l"><div class="oc l kt ku kv kr kw hp ki"/></div></div></a></div><h2 id="480c" class="nh ky hx bd kz od oe of ld og oh oi lh jv oj ok lj jz ol om ll kd on oo ln op bi translated">感谢阅读。希望这个博客给你一些有价值的输入！！</h2></div></div>    
</body>
</html>