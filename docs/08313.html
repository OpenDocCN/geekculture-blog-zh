<html>
<head>
<title>Mocking Third-Party Services in Integration Testing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在集成测试中模仿第三方服务</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/mocking-third-party-services-in-integration-testing-7ded9ac1fe83?source=collection_archive---------6-----------------------#2021-10-25">https://medium.com/geekculture/mocking-third-party-services-in-integration-testing-7ded9ac1fe83?source=collection_archive---------6-----------------------#2021-10-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/56bb588b6141f938228334f59565f253.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4YpiS1gwGLOiy61Q"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Photo by <a class="ae iu" href="https://unsplash.com/@glencarrie?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Glen Carrie</a> on <a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="d4c6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">由于各种原因，当前的应用程序开发越来越多地使用第三方服务，以加快开发过程，依赖一些健壮和可靠的解决方案以及许多其他合理的原因。</p><p id="2057" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然而，我们需要一种有效的方法，能够在隔离的环境中为我们的应用程序编写和执行自动化测试，因为，永远记住…</p><blockquote class="jt"><p id="8d66" class="ju jv hi bd jw jx jy jz ka kb kc js dx translated">无法测试的代码是有缺陷的。</p></blockquote><p id="7630" class="pw-post-body-paragraph iv iw hi ix b iy kd ja jb jc ke je jf jg kf ji jj jk kg jm jn jo kh jq jr js hb bi translated">在本文中，我将解释我发现的在进行集成测试时使用名为<a class="ae iu" href="https://www.mock-server.com/" rel="noopener ugc nofollow" target="_blank"> MockServer </a>的工具模拟外部服务的有效策略。</p><p id="3499" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">假设您正在处理一个应用程序，它需要在不同的场景中验证一个<a class="ae iu" href="https://it.wikipedia.org/wiki/International_Bank_Account_Number" rel="noopener ugc nofollow" target="_blank"> IBAN </a>，例如，在创建一个新用户的时候。为此，可以采用不同的方法，从仅仅验证IBAN格式<em class="ki">(弱检查)</em>，到与第三方服务交互的实时验证，如<a class="ae iu" href="https://www.iban.com/validation-api" rel="noopener ugc nofollow" target="_blank">这个</a>。</p><p id="a06b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">所以，首先，让我们给出一些关于这个工具的细节。</p></div><div class="ab cl kj kk gp kl" role="separator"><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko"/></div><div class="hb hc hd he hf"><h1 id="c1ef" class="kq kr hi bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">模拟服务器</h1><p id="0bc7" class="pw-post-body-paragraph iv iw hi ix b iy lo ja jb jc lp je jf jg lq ji jj jk lr jm jn jo ls jq jr js hb bi translated">我不久前发现了这个伟大的工具，它是❤的一见钟情</p><p id="da68" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">该工具可用作:</p><ul class=""><li id="e850" class="lt lu hi ix b iy iz jc jd jg lv jk lw jo lx js ly lz ma mb bi translated">一个被配置为针对不同请求返回特定响应的mock。</li><li id="7fa4" class="lt lu hi ix b iy mc jc md jg me jk mf jo mg js ly lz ma mb bi translated">代理记录并有选择地修改请求和响应。</li><li id="85dd" class="lt lu hi ix b iy mc jc md jg me jk mf jo mg js ly lz ma mb bi translated">既是某些请求的代理，同时又是其他请求的模拟。</li></ul><p id="4594" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当MockServer接收到请求时，它将该请求与已配置的活动<strong class="ix hj">期望</strong>进行匹配，如果没有找到匹配，它将在适当时代理该请求，否则返回404。</p><p id="5520" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一个<strong class="ix hj">期望</strong>定义了被采取的<strong class="ix hj">动作</strong>，例如，一个响应可能被返回。</p><figure class="mi mj mk ml fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mh"><img src="../Images/b04a8bfb606f23fd3d4ac1378d6c9306.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*yREPLNumM3Zbe1IW.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Example of mocking with MockServer</figcaption></figure><p id="d88c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">可以通过多种方式使用这个工具，但是我更喜欢使用官方Docker图片，在我写这篇文章的时候，这个图片已经被点击了5000多万次。</p></div><div class="ab cl kj kk gp kl" role="separator"><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko"/></div><div class="hb hc hd he hf"><h1 id="fb67" class="kq kr hi bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">它是如何工作的？</h1><p id="64b7" class="pw-post-body-paragraph iv iw hi ix b iy lo ja jb jc lp je jf jg lq ji jj jk lr jm jn jo ls jq jr js hb bi translated">简单解释一下，可以通过定义期望来配置MockServer，期望是请求-响应的块。</p><p id="17da" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我喜欢例子，我认为它们是让人们理解概念的最好方式，所以让我们回到需要验证IBAN的应用程序。</p><p id="19a8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们可能会执行一个类似下面的HTTPs请求</p><pre class="mi mj mk ml fd mm mn mo mp aw mq bi"><span id="7591" class="mr kr hi mn b fi ms mt l mu mv">GET <a class="ae iu" href="https://iban-validator-service.com" rel="noopener ugc nofollow" target="_blank">https://iban-validator-service.com</a>/api/v1/validate?iban=NL95RABO9809158653</span><span id="25b1" class="mr kr hi mn b fi mw mt l mu mv">Authorization: Bearer api-key</span></pre><p id="676f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">所以，我们需要像这样定义一个期望</p><pre class="mi mj mk ml fd mm mn mo mp aw mq bi"><span id="e366" class="mr kr hi mn b fi ms mt l mu mv">{<br/>        "httpRequest": {<br/>            "method": "GET",<br/>            "path": "/api/v1/validate",<br/>            "queryStringParameters": {<br/>                "iban": [ "NL95RABO9809158653" ]<br/>            },<br/>            "headers": {<br/>                "Authorization": [<br/>                    "Bearer api-key"<br/>                ]<br/>            },<br/>        },<br/>        "httpResponse": {<br/>            "statusCode": 200,<br/>            "body": {<br/>                "bank_data": {<br/>                    "bic": "RABONL2UXXX",<br/>                    "branch": null,<br/>                    "bank": "RABOBANK NEDERLAND",<br/>                    "address": "CROESELAAN 18",<br/>                    "city": "UTRECHT",<br/>                    "state": null,<br/>                    "zip": "3500 HG",<br/>                    "phone": null,<br/>                    "fax": null,<br/>                    "www": null,<br/>                    "email": null,<br/>                    "country": "Netherlands",<br/>                    "country_iso": "NL",<br/>                    "account": "9809158653",<br/>                    "bank_code": "RABO",<br/>                    "branch_code": ""<br/>                },<br/>                "sepa_data": {<br/>                    "SCT": "YES",<br/>                    "SDD": "YES",<br/>                    "COR1": "YES",<br/>                    "B2B": "YES",<br/>                    "SCC": "NO"<br/>                },<br/>                "validations": {<br/>                    "chars": {<br/>                        "code": "006",<br/>                        "message": "IBAN does not contain illegal characters"<br/>                    },<br/>                    "account": {<br/>                        "code": "002",<br/>                        "message": "Account Number check digit is correct"<br/>                    },<br/>                    "iban": {<br/>                        "code": "001",<br/>                        "message": "IBAN Check digit is correct"<br/>                    },<br/>                    "structure": {<br/>                        "code": "005",<br/>                        "message": "IBAN structure is correct"<br/>                    },<br/>                    "length": {<br/>                        "code": "003",<br/>                        "message": "IBAN Length is correct"<br/>                    },<br/>                    "country_support": {<br/>                        "code": "007",<br/>                        "message": "Country supports IBAN standard"<br/>                    }<br/>                },<br/>                "errors": []<br/>            }<br/>        }<br/>    }</span></pre><p id="7a5a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">定义了这个期望后，模拟服务器将会像我们与真实服务交互一样进行回复。</p><p id="f719" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">显然，这是一个非常简单的例子，只是为了展示这个工具使用背后的主要思想。更多期望示例可在<a class="ae iu" href="https://www.mock-server.com/mock_server/creating_expectations.html" rel="noopener ugc nofollow" target="_blank">官方文档页面</a>上找到。</p></div><div class="ab cl kj kk gp kl" role="separator"><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko"/></div><div class="hb hc hd he hf"><h1 id="2211" class="kq kr hi bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">怎么用？</h1><p id="1ec7" class="pw-post-body-paragraph iv iw hi ix b iy lo ja jb jc lp je jf jg lq ji jj jk lr jm jn jo ls jq jr js hb bi translated">如前所述，MockServer有不同的形式，但我更喜欢通过官方Docker镜像。</p><p id="ff86" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">假设我们有一个PHP应用程序，在<em class="ki"> docker-compose.yml </em>上定义了一个<a class="ae iu" href="https://docs.docker.com/compose/" rel="noopener ugc nofollow" target="_blank"> Docker Compose </a>集群，如下所示</p><pre class="mi mj mk ml fd mm mn mo mp aw mq bi"><span id="3fa6" class="mr kr hi mn b fi ms mt l mu mv">version: '3.8'<br/># --------- #<br/># Services  #<br/># --------- #<br/>services:<br/>  nginx:<br/>    ...<br/>  php-fpm:<br/>    networks:<br/>      internal:<br/>        aliases:<br/>          - php-fpm.internal<br/>    ...<br/># --------- #<br/># Networks  #<br/># --------- #<br/>networks:<br/>  internal:</span></pre><p id="6ce6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后我们要做的是为IBAN验证器服务添加一个MockServer实例，将配置转换成这个实例</p><pre class="mi mj mk ml fd mm mn mo mp aw mq bi"><span id="48ae" class="mr kr hi mn b fi ms mt l mu mv">version: '3.8'<br/># --------- #<br/># Services  #<br/># --------- #<br/>services:<br/>  nginx:<br/>    ...<br/>  php-fpm:<br/>    networks:<br/>      internal:<br/>        aliases:<br/>          - php-fpm.internal<br/>    ...<br/>  mock-iban-validator:<br/>    image: mockserver/mockserver<br/>    networks:<br/>      internal:<br/>        aliases:<br/>          - mock-iban-validator.internal<br/>    volumes:<br/>      - $PWD/docker/mock-server/iban-checker/:/config/<br/>    environment:<br/>      SERVER_PORT: 1080<br/>      MOCKSERVER_INITIALIZATION_JSON_PATH: /config/expectations.json<br/># --------- #<br/># Networks  #<br/># --------- #<br/>networks:<br/>  internal:</span></pre><p id="81ea" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">注意，在<em class="ki">$ PWD/docker/mock-server/iban-checker</em>文件夹中，存储了一个名为<em class="ki"> expectations.json </em>的文件，其中包含了所有需要的期望。</p><p id="b35c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">有了这个配置，<em class="ki"> php-fpm </em>服务就能够ping通<em class="ki"> mock-iban-validator </em>服务，除此之外，还能够做如下事情</p><pre class="mi mj mk ml fd mm mn mo mp aw mq bi"><span id="a983" class="mr kr hi mn b fi ms mt l mu mv">$ curl mock-iban-validator.internal:1080/api/v1/validate?iban=NL95RABO9809158653 -H "Authorization: Bearer api-key"</span></pre><p id="37bb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">获得预期的响应。</p></div><div class="ab cl kj kk gp kl" role="separator"><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko"/></div><div class="hb hc hd he hf"><h1 id="1e8c" class="kq kr hi bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">最后的想法</h1><p id="ca0b" class="pw-post-body-paragraph iv iw hi ix b iy lo ja jb jc lp je jf jg lq ji jj jk lr jm jn jo ls jq jr js hb bi translated">我希望这篇文章能够帮助你们中的一些人理解这个工具对于创建集成测试的潜力！</p><p id="bc89" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">感谢您的阅读，并随时添加关于您的体验的评论:)</p></div></div>    
</body>
</html>