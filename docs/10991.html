<html>
<head>
<title>Use Raspberry Pi and TP-link Kasa to automate your devices</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Raspberry Pi和TP-link Kasa来自动化您的设备</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/use-raspberry-pi-and-tp-link-kasa-to-automate-your-devices-9f936a6243c1?source=collection_archive---------0-----------------------#2022-02-26">https://medium.com/geekculture/use-raspberry-pi-and-tp-link-kasa-to-automate-your-devices-9f936a6243c1?source=collection_archive---------0-----------------------#2022-02-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="ad29" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">~ ~不是赞助帖~~ </em></p><p id="5be7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在是2022年，现在有许多智能家居设备和生态系统。TP-link 系统的<a class="ae je" href="https://www.kasasmart.com/us/products" rel="noopener ugc nofollow" target="_blank"> Kasa已经有一段时间了；这是我最喜欢的，因为有一个python SDK，他们制作了带有能源监控的智能插头，这是相当独特的。当你将Kasa组合与Raspberry Pi(或任何Linux /Windows服务器)结合时，可能性是无穷的。下面是一些你可以做的事情。</a></p><ul class=""><li id="905f" class="jf jg hi ih b ii ij im in iq jh iu ji iy jj jc jk jl jm jn bi translated">[在这篇博文中显示]你可以使用复杂的时间表运行设备，例如“脉冲模式”——它在一小时内以固定的时间间隔打开和关闭。例如，插入智能输出的水泵在一天的特定时间每隔15分钟启动并运行5分钟。我有一个Taco Hot-link水泵的设置，它插在Kasa智能插座上。</li></ul><figure class="jp jq jr js fd jt er es paragraph-image"><div role="button" tabindex="0" class="ju jv di jw bf jx"><div class="er es jo"><img src="../Images/b18d41fc64d101494668db7cd6f7a712.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zy1ic5BbdLibkae1U3RTSg.png"/></div></div><figcaption class="ka kb et er es kc kd bd b be z dx">Automating a pump: Linux → Smart plug → Device</figcaption></figure><ul class=""><li id="e65c" class="jf jg hi ih b ii ij im in iq jh iu ji iy jj jc jk jl jm jn bi translated">[显示在这篇博文中]通过cron控制所有调度设备。Kasa应用程序虽然很棒，但目前每台设备只能有31个日程安排。与任何GUI界面一样，设置一个复杂的时间表需要多次“点击/触摸”。</li><li id="99dc" class="jf jg hi ih b ii ke im kf iq kg iu kh iy ki jc jk jl jm jn bi translated">[即将在未来的博客中发布]根据外部事件控制设备。例如，根据股票市场或密码今天的表现、天气或推文情绪来调整led颜色。</li></ul><p id="0625" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果这种自动化听起来让你兴奋，请继续读下去。对于前两个，我们将使用Cron作业来完成。对于第三个问题，我们需要编写一个程序来轮询网站或API，然后适当地控制设备。我将在以后的博客文章中讨论这个场景。</p><ol class=""><li id="761c" class="jf jg hi ih b ii ij im in iq jh iu ji iy jj jc kj jl jm jn bi translated"><strong class="ih hj">安装python-kasa: </strong></li></ol><p id="a014" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Python-kasa是围绕TP-link Kasa使用的API的Python包装器。截至2022年，这是一个相当活跃的项目，你可以在这里查看/贡献:<a class="ae je" href="https://github.com/python-kasa/python-kasa" rel="noopener ugc nofollow" target="_blank">https://github.com/python-kasa/python-kasa</a>。</p><p id="1c62" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以通过运行下面的命令来安装它。</p><pre class="jp jq jr js fd kk kl km kn aw ko bi"><span id="1a59" class="kp kq hi kl b fi kr ks l kt ku"><strong class="kl hj">pip3 install python-kasa</strong></span></pre><p id="23f4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">命令完成后，启动一个新的终端会话，或者从现有会话注销/登录，然后运行命令<strong class="ih hj"> kasa </strong>。如果一切顺利，您应该能够运行命令kasa来发现您网络中的设备(注意:您可能会得到一些发现错误—大多数情况下这可能会被忽略)。</p><p id="f040" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你运行命令<strong class="ih hj">kasa</strong>，它会显示python程序的安装位置，在我的例子中是<strong class="ih hj"> /home/pi/。local/bin/kasa </strong>，已经在我的PATH变量里了。</p><p id="8019" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，使用您的设备别名运行一个更具体的命令，以确保您可以看到它的状态。在下面的命令中，我的设备名称是“水泵”，请适当替换。</p><pre class="jp jq jr js fd kk kl km kn aw ko bi"><span id="bad2" class="kp kq hi kl b fi kr ks l kt ku">kasa --type plug --alias "water pump"</span></pre><p id="a742" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行命令<code class="du kv kw kx kl b">kasa --help</code>查看其他选项。例如，如果你想调整一个灯泡的颜色，你可以像这样运行一个命令(下一篇博文会详细介绍)</p><pre class="jp jq jr js fd kk kl km kn aw ko bi"><span id="2a14" class="kp kq hi kl b fi kr ks l kt ku">kasa --type bulb --alias "color lamp" hsv 118 100 73</span></pre><p id="888c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 2。写一个控制器脚本:</strong></p><p id="6946" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们只需要写一个简单的脚本来打开或关闭设备。你可以使用下面的脚本。保存这个文件，并给它适当的权限，如下所示。</p><pre class="jp jq jr js fd kk kl km kn aw ko bi"><span id="ec59" class="kp kq hi kl b fi kr ks l kt ku"># Write file<br/>echo &lt;&lt;EOF&gt;kasa-pump.sh<br/>#!/bin/bash</span><span id="8a31" class="kp kq hi kl b fi ky ks l kt ku">if [[ ! -z $1 ]]; then<br/>  operation=$1<br/>else<br/>  operation=state<br/>fi</span><span id="3fed" class="kp kq hi kl b fi ky ks l kt ku">export PATH=/home/pi/.local/bin:$PATH<br/>kasa --type plug --alias "water pump" ${operation}<br/>EOF</span><span id="8c42" class="kp kq hi kl b fi ky ks l kt ku"># Adjust permissions<br/>sudo cp kasa-pump.sh /usr/local/bin/kasa-pump.sh<br/>sudo chown pi:pi /usr/local/bin/kasa-pump.sh<br/>sudo chmod +x /usr/local/bin/kasa-pump.sh</span></pre><p id="42f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过运行如下命令来测试脚本。您应该会看到设备打开/关闭。</p><pre class="jp jq jr js fd kk kl km kn aw ko bi"><span id="735a" class="kp kq hi kl b fi kr ks l kt ku">kasa-pump.sh on<br/>kasa-pump.sh off</span></pre><p id="8b8c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 3。写一个cron job: </strong></p><p id="2cc6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Cron job是OG Linux的特性之一，有很多关于它的教程。我将在这里提供一个片段，说明我如何设置cron为脉冲模式，即5分钟打开，10分钟关闭。</p><pre class="jp jq jr js fd kk kl km kn aw ko bi"><span id="f8c1" class="kp kq hi kl b fi kr ks l kt ku"># Use this command to write/update a cron schedule<br/>crontab -e</span><span id="abc6" class="kp kq hi kl b fi ky ks l kt ku"># Pump pulse mode.<br/>*/15 5,6,7,10,11,12,13,16,17,20,21,22 * * * /usr/local/bin/kasa-pump.sh on<br/>5,20,35,50 5,6,7,10,11,12,13,16,17,20,21,22 * * * /usr/local/bin/kasa-pump.sh off</span></pre><p id="a271" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面的表达式在选定的时间段内，每隔15分钟在上运行命令<strong class="ih hj"> kasa-pump.sh。</strong></p><p id="19e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd"> */15 5，6，7，10，11，12，13，16，17，20，21，22 * * */usr/local/bin/kasa-pump . sh on</em></p><p id="7e39" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">和下面的表达式，在每小时的第5、20、35和50分钟运行命令kasa-pump.sh off。</p><p id="473c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd"> 5，20，35，50 5，6，7，10，11，12，13，16，17，20，21，22 * * */usr/local/bin/kasa-pump . sh off</em></p><p id="1cc8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当然，我希望你会选择一个完全定制的时间表。与使用Kasa应用程序相比，使用Cron可以获得更多的粒度。</p><p id="b498" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">剩下要做的就是确保cron作业成功运行。请使用下面的命令检查cron的输出</p><pre class="jp jq jr js fd kk kl km kn aw ko bi"><span id="ae70" class="kp kq hi kl b fi kr ks l kt ku"># Ensure that the Cron service is running properly<br/>sudo systemctl status cron.service</span><span id="742f" class="kp kq hi kl b fi ky ks l kt ku"># cat /var/mail/pi | grep -i pump</span></pre><p id="434b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">结论</strong></p><p id="b653" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇文章中，我们看到了如何使用Raspberry Pi中的cron作业来自动化一个名为“pump”的设备。随着你获得更多的设备，以这种方式设置日程安排比应用程序更容易，这将需要你多次“触摸/点击”。</p><p id="4d2a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在下一篇博文中，我们将看到一些更有趣的东西，比如根据外部事件调整颜色。</p></div></div>    
</body>
</html>