<html>
<head>
<title>TiDB Operator Source Code Reading (I): Overview</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">TiDB操作符源代码阅读(一):概述</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/tidb-operator-source-code-reading-i-overview-cf1891f1fd90?source=collection_archive---------28-----------------------#2021-05-28">https://medium.com/geekculture/tidb-operator-source-code-reading-i-overview-cf1891f1fd90?source=collection_archive---------28-----------------------#2021-05-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/b4256b9afd9cc363a9e517ab44c01df4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*nlZVUIc36_cfcVDq.jpeg"/></div></div></figure><p id="1746" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">作者:</strong> <a class="ae jo" href="https://github.com/handlerww" rel="noopener ugc nofollow" target="_blank">陈一文</a>(TiDB运营商委托人)</p><p id="1286" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> Transcreator: </strong> <a class="ae jo" href="https://github.com/ran-huang" rel="noopener ugc nofollow" target="_blank">黄然</a>；编辑:汤姆·万德</p><p id="e316" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae jo" href="https://docs.pingcap.com/tidb-in-kubernetes/stable" rel="noopener ugc nofollow" target="_blank"> TiDB Operator </a>是Kubernetes的TiDB自动操作系统。作为一个为TiDB定制的Kubernetes操作器，它被TiDB用户广泛用于在整个生命周期中管理他们的集群，因此拥有一个活跃的开发人员社区。</p><p id="8a14" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然而，Kubernetes和TiDB Operator都相当复杂，因此对其开发做出贡献需要一些努力和准备。为了帮助我们的社区掌握这一基本知识，我们正在创建一系列文章，带您浏览TiDB操作符源代码。本系列不仅可以帮助新手开始使用TiDB Operator，也可以作为更有经验的开发人员的参考。</p><p id="3df2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">第一篇文章向您介绍了TiDB Operator的架构、其核心组件以及它的用途。这篇文章是所有其他文章的基础。我们希望这篇文章对你有所帮助，并激励你把自己的创意带到社区中来。</p><h1 id="15d0" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">TiDB操作符概述</h1><p id="48d2" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">在这一节中，我将讨论两个问题:TiDB操作符是如何工作的，以及它对您有什么帮助。弄清楚这两个问题，你就能更好地理解TiDB操作者的该做和不该做。</p><h2 id="900a" class="ks jq hi bd jr kt ku kv jv kw kx ky jz jb kz la kd jf lb lc kh jj ld le kl lf bi translated">TiDB操作员如何工作</h2><p id="c7a1" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">当TiDB Operator维护您的TiDB集群时，它的组件与定制资源(CRs)紧密协作。</p><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lg"><img src="../Images/aa617e15c437724f636fdc380e0a9992.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*QBp1SzT3mWLMWPMA.png"/></div></div><figcaption class="ll lm et er es ln lo bd b be z dx"><em class="lp">TiDB Operator v1.1 architecture</em></figcaption></figure><p id="7ce5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">由<a class="ae jo" href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/#customresourcedefinitions" rel="noopener ugc nofollow" target="_blank">自定义资源定义</a> (CRD)，<a class="ae jo" href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/#custom-resources" rel="noopener ugc nofollow" target="_blank">自定义资源</a>定义描述您的TiDB集群的期望状态:</p><ul class=""><li id="7307" class="lq lr hi is b it iu ix iy jb ls jf lt jj lu jn lv lw lx ly bi translated"><code class="du lz ma mb mc b">TidbCluster</code>描述TiDB集群的期望状态。</li><li id="0f7d" class="lq lr hi is b it md ix me jb mf jf mg jj mh jn lv lw lx ly bi translated"><code class="du lz ma mb mc b">TidbMonitor</code>描述TiDB集群的监控组件。</li><li id="df79" class="lq lr hi is b it md ix me jb mf jf mg jj mh jn lv lw lx ly bi translated"><code class="du lz ma mb mc b">TidbInitializer</code>描述所需的初始化作业。</li><li id="737d" class="lq lr hi is b it md ix me jb mf jf mg jj mh jn lv lw lx ly bi translated"><code class="du lz ma mb mc b">Backup</code>描述所需的备份作业。</li><li id="93ac" class="lq lr hi is b it md ix me jb mf jf mg jj mh jn lv lw lx ly bi translated"><code class="du lz ma mb mc b">Restore</code>描述所需的还原作业。</li><li id="293c" class="lq lr hi is b it md ix me jb mf jf mg jj mh jn lv lw lx ly bi translated"><code class="du lz ma mb mc b">BackupSchedule</code>描述计划的备份作业。</li><li id="0e85" class="lq lr hi is b it md ix me jb mf jf mg jj mh jn lv lw lx ly bi translated"><code class="du lz ma mb mc b">TidbClusterAutoScaler</code>描述自动缩放规则。</li><li id="0ff2" class="lq lr hi is b it md ix me jb mf jf mg jj mh jn lv lw lx ly bi translated"><code class="du lz ma mb mc b">DMCluster</code>描述与<a class="ae jo" href="https://docs.pingcap.com/tidb-data-migration/stable" rel="noopener ugc nofollow" target="_blank"> TiDB数据迁移</a>相关的配置。</li></ul><p id="0463" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">TiDB运算符包括以下组件:</p><ul class=""><li id="4578" class="lq lr hi is b it iu ix iy jb ls jf lt jj lu jn lv lw lx ly bi translated"><code class="du lz ma mb mc b">tidb-controller-manager</code>是Kubernetes中的一组自定义控制器。这些控制器不断地将记录在<code class="du lz ma mb mc b">TidbCluster</code>对象中的期望状态与TiDB集群的实际状态进行比较。他们调整Kubernetes中的资源，使TiDB集群满足您的期望状态，并根据其他Cr完成相应的控制逻辑。</li><li id="1433" class="lq lr hi is b it md ix me jb mf jf mg jj mh jn lv lw lx ly bi translated"><code class="du lz ma mb mc b">tidb-scheduler</code>是一个Kubernetes调度程序扩展，它将TiDB特定的调度策略注入到Kubernetes调度程序中。</li><li id="7fdf" class="lq lr hi is b it md ix me jb mf jf mg jj mh jn lv lw lx ly bi translated"><code class="du lz ma mb mc b">tidb-admission-webhook</code>是Kubernetes中的一个动态接纳控制器，完成对Pod、StatefulSet和其他相关资源的修改、验证、操作和维护。</li></ul><p id="1333" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当TiDB在Kubernetes中运行时，TiDB Operator使用本机资源(部署、StatefulSet、服务、PVC、ConfigMap等。)并协调它们来维护TiDB集群。</p><h2 id="fec9" class="ks jq hi bd jr kt ku kv jv kw kx ky jz jb kz la kd jf lb lc kh jj ld le kl lf bi translated">TiDB操作员如何帮助您</h2><p id="c6f2" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">简而言之，TiDB Operator将您从烦人的日常维护工作中解放出来。您唯一的任务是创建指定TiDB集群所需状态的YAML语句。TiDB Operator使用这些信息来调度Kubernetes资源，以将集群推向所需的状态，并向外部提供服务。</p><p id="e160" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我举两个例子来说明TiDB操作符是如何简化一切的。假设您想要三个<a class="ae jo" href="https://docs.pingcap.com/tidb/stable/tidb-architecture#placement-driver-pd-server" rel="noopener ugc nofollow" target="_blank">布局驱动</a> (PD)实例。您需要初始化第一个实例，然后将另外两个加入到第一个实例中。要实现这一点，您可以通过指定<code class="du lz ma mb mc b">--initial-cluster</code>和两个<code class="du lz ma mb mc b">--join</code>参数来手动完成，或者您可以告诉TiDB Operator为您生成配置。显然，后者更容易。</p><p id="d928" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">另一个例子是执行PD的滚动升级。当PD正在运行时，升级它可能会影响联机服务。在手动升级中，您需要使用StatefulSets的<code class="du lz ma mb mc b">UpdateStrategy.Partition</code>选项来控制滚动升级进度，并在监控PD服务的同时逐个升级PD实例。但是TiDB运营商的情况就不同了。它可以使用PD API通过转移Leader并检查更新的PD实例是否按预期工作来自动执行滚动升级。</p><p id="3f3d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了实现上述功能，TiDB操作员需要与Kubernetes和TiDB一起工作。一方面，它需要与Kubernetes互动，使其资源和运营符合TiDB的要求。另一方面，它与TiDB组件的API进行交互，从PD获取集群状态，并反馈给Kubernetes资源管理。此外，它根据您的规范维护TiDB集群。</p><p id="12f0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您想将TiDB维护功能与您的Kubernetes系统集成，TiDB Operator还将从TiDB的角度为您提供与这两个系统进行交互的能力。</p><h1 id="a994" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">这个系列带给你的</h1><p id="769c" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">TiDB操作符源代码阅读系列文章将涉及以下主题:</p><ul class=""><li id="8e09" class="lq lr hi is b it iu ix iy jb ls jf lt jj lu jn lv lw lx ly bi translated">入门:TiDB操作符基础及其试图解决的问题。</li><li id="474c" class="lq lr hi is b it md ix me jb mf jf mg jj mh jn lv lw lx ly bi translated">操作符模式:入口点、程序逻辑及其协调循环的触发器。</li><li id="9971" class="lq lr hi is b it md ix me jb mf jf mg jj mh jn lv lw lx ly bi translated">调和循环设计:一般设计及其如何扩展。</li><li id="9aa6" class="lq lr hi is b it md ix me jb mf jf mg jj mh jn lv lw lx ly bi translated">功能设计:备份和恢复、自动伸缩、webhook、高级StatefulSet、tidb-scheduler和监控。</li><li id="a3e9" class="lq lr hi is b it md ix me jb mf jf mg jj mh jn lv lw lx ly bi translated">质量管理:我们如何通过单元测试、端到端测试和稳定性测试来确保TiDB Operator的代码质量。</li></ul><p id="e354" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这些深入的文章将帮助您充分利用TiDB操作符。如果您决定将它集成到您的基于Kubernetes的系统中，您将有我们的最佳实践来指导您。更重要的是，这些文章将为您提供为TiDB Operator做出贡献所需的知识，并使产品变得更好。</p><p id="3793" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这个博客系列也将有益于你的Kubernetes学习。当您研究Kubernetes的操作符模式时，TiDB操作符是一个很好的榜样。现在在Kubernetes社区里，有<a class="ae jo" href="https://github.com/kubernetes-sigs/kubebuilder" rel="noopener ugc nofollow" target="_blank"> Kubebuilder </a>和<a class="ae jo" href="https://github.com/operator-framework/operator-sdk" rel="noopener ugc nofollow" target="_blank"> Operator SDK </a>这样的运营商框架，也有<a class="ae jo" href="https://github.com/kubernetes-sigs/controller-runtime" rel="noopener ugc nofollow" target="_blank"> controller-runtime </a>这样的库。它们是利用Kubernetes模块封装复杂程序逻辑的各种实现。通过理解TiDB Operator，您将掌握如何基于Kubernetes设计强大而优雅的资源管理系统。</p><h1 id="8c35" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">总结</h1><p id="60d4" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">在本文中，我们讨论了TiDB操作符的基础知识以及它所解决的问题。随着我们系列的继续，我们将深入研究TiDB操作符代码，并分享我们开发这个Kubernetes操作符的经验。</p><p id="9720" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您有任何问题或想了解更多，请随时加入我们的Slack频道<a class="ae jo" href="https://slack.tidb.io/invite?team=tidb-community&amp;channel=sig-k8s&amp;ref=pingcap-blog" rel="noopener ugc nofollow" target="_blank"> #sig-k8s </a>或在<a class="ae jo" href="https://github.com/pingcap/tidb-operator" rel="noopener ugc nofollow" target="_blank"> pingcap/tidb-operator </a>开题。敬请期待！</p></div><div class="ab cl mi mj gp mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="hb hc hd he hf"><p id="739f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="mp">原载于www.pingcap.com</em><a class="ae jo" href="https://pingcap.com/blog/tidb-operator-source-code-reading-1-overview" rel="noopener ugc nofollow" target="_blank"><em class="mp"/></a><em class="mp">2021年3月23日</em></p></div></div>    
</body>
</html>