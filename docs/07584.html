<html>
<head>
<title>Elastic Search Geo Point and Geo Shape Queries Explained</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">解释了弹性搜索地理点和地理形状查询</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/elastic-search-geo-point-and-geo-shape-queries-explained-df69ec157527?source=collection_archive---------1-----------------------#2021-09-23">https://medium.com/geekculture/elastic-search-geo-point-and-geo-shape-queries-explained-df69ec157527?source=collection_archive---------1-----------------------#2021-09-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="0b65" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本文主要关注地理空间数据操作，类似于PostgreSQL、Mongo DB和Redis的Postgis扩展。在本文中，我们将了解Elasticsearch的地理查询，如何设置映射和索引，并提供一些如何查询数据的示例。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/bf57eeb53d6a6a4663c44b9e28162832.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qJvXaZylOes-1niZJDkVpQ.png"/></div></div></figure><h1 id="9326" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">弹性搜索中的地理数据</h1><p id="55a9" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">Elasticsearch允许您以两种方式表示地理数据，<strong class="ih hj"> <em class="ks"> geo_shape，</em> </strong>和<strong class="ih hj"> <em class="ks"> geo_point。</em>T15】</strong></p><p id="95c4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae kt" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-point.html" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj"><em class="ks">Geo Point</em></strong></a>允许您将数据存储为经纬度坐标对。当您要根据点之间的距离过滤数据、在边界框内搜索或使用聚合时，请使用此字段类型。有许多您可以指定的特性和选项超出了本文的范围。我们将在这里讨论几个，但是您可以在Elasticsearch的文档中查看<em class="ks">地理边界框</em>、<em class="ks">地理距离</em>和<em class="ks">地理聚合</em>的选项。</p><p id="f256" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当您有表示形状的地理数据时，或者当您想要查询形状内的点时，请使用<a class="ae kt" href="https://www.elastic.co/guide/en/elasticsearch/guide/2.x/geo-shapes.html" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj"><em class="ks">Geo-Shape</em></strong></a>。<code class="du ku kv kw kx b">geo_shape</code>数据必须以GeoJSON格式编码，该格式被转换成代表<a class="ae kt" href="https://www.elastic.co/guide/en/elasticsearch/guide/2.x/geohashes.html" rel="noopener ugc nofollow" target="_blank"> Geohash </a>单元网格上的经度/纬度坐标对的字符串。由于Elasticsearch将形状作为术语进行索引，因此它可以很容易地确定形状之间的关系，可以使用<code class="du ku kv kw kx b">intersects</code>、<code class="du ku kv kw kx b">disjoint</code>、<code class="du ku kv kw kx b">contains</code>或<code class="du ku kv kw kx b">within</code>查询空间关系运算符进行查询。</p><p id="53d4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不幸的是，<em class="ks">地理点</em>和<em class="ks">地理形状</em>不能一起查询。例如，如果您想要获取指定多边形内的所有城市，您不能使用通过<em class="ks">地理点</em>索引的城市。它们必须使用GeoJSON中的<code class="du ku kv kw kx b">"type": "Point"</code>进行索引，并且索引为<code class="du ku kv kw kx b">geo-shape</code>。</p><h1 id="d67f" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">地理点字段类型</h1><p id="996b" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">类型为<code class="du ku kv kw kx b">geo_point</code>的字段接受纬度-经度对，可以使用</p><ul class=""><li id="fe95" class="ky kz hi ih b ii ij im in iq la iu lb iy lc jc ld le lf lg bi translated">在<a class="ae kt" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-geo-bounding-box-query.html" rel="noopener ugc nofollow" target="_blank">边界框</a>内，在中心点的某个<a class="ae kt" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-geo-distance-query.html" rel="noopener ugc nofollow" target="_blank">距离</a>内，或者在<a class="ae kt" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-geo-polygon-query.html" rel="noopener ugc nofollow" target="_blank">多边形</a>内，或者在<code class="du ku kv kw kx b"><a class="ae kt" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-geo-shape-query.html" rel="noopener ugc nofollow" target="_blank">geo_shape</a></code> <a class="ae kt" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-geo-shape-query.html" rel="noopener ugc nofollow" target="_blank">查询</a>内寻找地理点。</li><li id="3361" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc ld le lf lg bi translated">按地理位置或距中心点<a class="ae kt" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-geodistance-aggregation.html" rel="noopener ugc nofollow" target="_blank">距离</a>聚集文档<a class="ae kt" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-geohashgrid-aggregation.html" rel="noopener ugc nofollow" target="_blank">。</a></li><li id="74f2" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc ld le lf lg bi translated">将距离整合到文档的<a class="ae kt" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html" rel="noopener ugc nofollow" target="_blank">相关性分数</a>中。</li><li id="6c45" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc ld le lf lg bi translated">按距离对文件进行分类。</li></ul><p id="d652" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以用五种不同的方式存储地理点</p><p id="b1ba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">绘制地理点</strong></p><pre class="je jf jg jh fd lm kx ln lo aw lp bi"><span id="7063" class="lq jq hi kx b fi lr ls l lt lu">PUT location_index<br/>{<br/>  "mappings": {<br/>    "properties": {<br/>      "text" : {<br/>        "type" : "text"<br/>      },<br/>      "location": {<br/>        "type": "geo_point"<br/>      }<br/>    }<br/>  }<br/>}</span></pre><p id="764b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="ks"> Geo点为对象:</em> </strong> <em class="ks">一个对象可以用属性为</em><code class="du ku kv kw kx b"><em class="ks">lat</em></code><em class="ks"/><code class="du ku kv kw kx b"><em class="ks">lon</em></code><em class="ks">的。</em></p><pre class="je jf jg jh fd lm kx ln lo aw lp bi"><span id="c186" class="lq jq hi kx b fi lr ls l lt lu">PUT location_index/_doc/1<br/>{<br/>  "text": "Geopoint as an object",<br/>  <strong class="kx hj">"location": { <br/>    "lat": 41.12,<br/>    "lon": -71.34<br/>  }</strong><br/>}</span></pre><p id="ccec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"><em class="ks">Geo Point as String:</em></strong>普通字符串可以用“，”分隔，格式为<code class="du ku kv kw kx b">lat, lon</code>。</p><pre class="je jf jg jh fd lm kx ln lo aw lp bi"><span id="26ae" class="lq jq hi kx b fi lr ls l lt lu">PUT location_index/_doc/1<br/>{<br/>  "text": "Geopoint as a string",<br/>  <strong class="kx hj">"location": "41.12,-71.34" </strong><br/>}</span></pre><p id="b867" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="ks"> Geo Point为</em></strong><a class="ae kt" href="https://en.wikipedia.org/wiki/Geohash'" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj"><em class="ks">Geo Hash</em></strong></a><strong class="ih hj"><em class="ks">:</em></strong>一个Hash值用来表示<code class="du ku kv kw kx b">lat</code>和<code class="du ku kv kw kx b">lon</code>。有一个在线<a class="ae kt" href="https://www.movable-type.co.uk/scripts/geohash.html" rel="noopener ugc nofollow" target="_blank">网站</a>可以这么做。</p><pre class="je jf jg jh fd lm kx ln lo aw lp bi"><span id="de43" class="lq jq hi kx b fi lr ls l lt lu">PUT location_index/_doc/3<br/>{<br/>  "text": "Geopoint as a geohash",<br/>  <strong class="kx hj">"location": "drm3btev3e86" </strong><br/>}</span></pre><p id="5b0c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="ks"> Geo点为数组:</em> </strong>坐标可以用数组<code class="du ku kv kw kx b">[lon, lat]</code>的形式表示，取值为<code class="du ku kv kw kx b">double</code>。</p><pre class="je jf jg jh fd lm kx ln lo aw lp bi"><span id="77d7" class="lq jq hi kx b fi lr ls l lt lu">PUT location_index/_doc/4<br/>{<br/>  "text": "Geopoint as an array",<br/>  <strong class="kx hj">"location": [ -71.34, 41.12 ] </strong><br/>}</span></pre><p id="4d8d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="ks"> Geo点为</em></strong><a class="ae kt" href="https://en.wikipedia.org/wiki/Well-known_text_representation_of_geometry" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj"><em class="ks">WKT</em></strong></a><strong class="ih hj"><em class="ks">点:</em> </strong>坐标可以用函数的形式表示<code class="du ku kv kw kx b">POINT(lon lat)</code>。</p><pre class="je jf jg jh fd lm kx ln lo aw lp bi"><span id="9256" class="lq jq hi kx b fi lr ls l lt lu">PUT location_index/_doc/5<br/>{<br/>  "text": "Geopoint as a WKT POINT primitive",<br/>  <strong class="kx hj">"location" : "POINT (-71.34 41.12)" </strong><br/>}</span></pre><blockquote class="lv lw lx"><p id="2baf" class="if ig ks ih b ii ij ik il im in io ip ly ir is it lz iv iw ix ma iz ja jb jc hb bi translated">无论地理点以何种格式保存，我们也可以查询其他格式。但是要注意正确定义格式。不要用<code class="du ku kv kw kx b">lat</code>和<code class="du ku kv kw kx b">lon</code>值替换。可以给出前所未有的价值。</p></blockquote><h1 id="ce2e" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">地理形状字段类型</h1><p id="c8f9" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated"><code class="du ku kv kw kx b">geo_shape</code>数据类型便于索引和搜索任意地理形状，如矩形和多边形。当被索引的数据或被执行的查询包含形状而不仅仅是点时，应该使用它。</p><p id="6312" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以使用<code class="du ku kv kw kx b"><a class="ae kt" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-geo-shape-query.html" rel="noopener ugc nofollow" target="_blank">geo_shape</a></code> <a class="ae kt" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-geo-shape-query.html" rel="noopener ugc nofollow" target="_blank">查询</a>使用这种类型查询文档。</p><p id="3f19" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">映射文件</strong></p><pre class="je jf jg jh fd lm kx ln lo aw lp bi"><span id="2581" class="lq jq hi kx b fi lr ls l lt lu">PUT /example<br/>{<br/>  "mappings": {<br/>    "properties": {<br/>      "location": {<br/>        "type": "geo_shape"<br/>      }<br/>    }<br/>  }<br/>}</span></pre><p id="fc40" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="ks"> Geo Json类型点:</em> </strong>单个地理坐标。注意:Elasticsearch仅使用WGS-84坐标。</p><pre class="je jf jg jh fd lm kx ln lo aw lp bi"><span id="0f22" class="lq jq hi kx b fi lr ls l lt lu">POST /example/_doc<br/>{<br/>  "location" : {<br/>    "type" : "point",<br/>    "coordinates" : [-77.03653, 38.897676]<br/>  }<br/>}</span></pre><p id="c4f4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"><em class="ks">Geo Json Type LINESTRING</em></strong>:给定两点或多点的任意直线。</p><pre class="je jf jg jh fd lm kx ln lo aw lp bi"><span id="97b8" class="lq jq hi kx b fi lr ls l lt lu">POST /example/_doc<br/>{<br/>  "location" : {<br/>    "type" : "linestring",<br/>    "coordinates" : [[-77.03653, 38.897676], [-77.009051, 38.889939]]<br/>  }<br/>}</span></pre><p id="dd06" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="ks"> Geo Json类型多边形:</em> </strong>一个<em class="ks">闭合的</em>多边形，其第一个点和最后一个点必须匹配，因此需要<code class="du ku kv kw kx b">n + 1</code>顶点创建一个<code class="du ku kv kw kx b">n</code>边的多边形和最少<code class="du ku kv kw kx b">4</code>个顶点。</p><pre class="je jf jg jh fd lm kx ln lo aw lp bi"><span id="67d0" class="lq jq hi kx b fi lr ls l lt lu">POST /example/_doc<br/>{<br/>  "location" : {<br/>    "type" : "polygon",<br/>    "coordinates" : [<br/>      [ [-77.03653, 38.897676], [-77.03653, 37.897676], [-76.03653, 38.897676], [-77.03653, 38.997676], [-77.03653, 38.897676] ]<br/>    ]<br/>  }<br/>}</span></pre><p id="aa94" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="ks"> Geo Json类型多多边形:</em> </strong>单独多边形的数组。</p><pre class="je jf jg jh fd lm kx ln lo aw lp bi"><span id="0b2f" class="lq jq hi kx b fi lr ls l lt lu">POST /example/_doc<br/>{<br/>  "location" : {<br/>    "type" : "multipolygon",<br/>    "coordinates" : [<br/>      [ [[-80.0, 40.0], [-79.0, 40.0], [-79.0, 39.0], [-80.0, 39.0], [-80.0, 40]] ],<br/>      [ [ [-78.0, 38.0], [-79.0, 38.0], [-79.0, 39.0], [-78.0, 39.0], [-78.0, 38.0] ],<br/>      [ [-78.2, 38.2], [-78.8, 38.2], [-78.2, 38.8], [-78.8, 38.8], [-78.2, 38.2] ] ]<br/>    ]<br/>  }<br/>}</span></pre><p id="c516" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="ks"> Geo Json类型多点:</em> </strong>不相连但可能相关的点的数组。</p><pre class="je jf jg jh fd lm kx ln lo aw lp bi"><span id="170b" class="lq jq hi kx b fi lr ls l lt lu">POST /example/_doc<br/>{<br/>  "location" : {<br/>    "type" : "multipoint",<br/>    "coordinates" : [<br/>      [-78.0, 38.0], [-79.0, 38.0]<br/>    ]<br/>  }<br/>}</span></pre><p id="e0b6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Geo Json类型多行字符串:</strong>单独行字符串的数组。</p><pre class="je jf jg jh fd lm kx ln lo aw lp bi"><span id="e7cf" class="lq jq hi kx b fi lr ls l lt lu">POST /example/_doc<br/>{<br/>  "location" : {<br/>    "type" : "multilinestring",<br/>    "coordinates" : [<br/>      [ [-77.03, 38.89], [-78.03, 38.89], [-78.03, 39.89], [-78.03, 39.89] ],<br/>      [ [-76.03, 36.89], [-77.03, 36.89], [-77.03, 37.89], [-76.03, 37.89] ],<br/>      [ [-76.23, 36.69], [-76.03, 36.89], [-76.23, 36.89], [-76.23, 36.09] ]<br/>    ]<br/>  }<br/>}</span></pre><p id="8f3d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="ks"> Geo Json类型geometry collection:</em></strong>Geo Json形状类似于<code class="du ku kv kw kx b">multi*</code>形状，只是多种类型可以共存(例如，点和线串)。</p><pre class="je jf jg jh fd lm kx ln lo aw lp bi"><span id="45b0" class="lq jq hi kx b fi lr ls l lt lu">POST /example/_doc<br/>{<br/>  "location" : {<br/>    "type": "geometrycollection",<br/>    "geometries": [<br/>      {<br/>        "type": "point",<br/>        "coordinates" : [-77.03653, 38.897676]<br/>      },<br/>      {<br/>        "type": "linestring",<br/>        "coordinates" : [[-77.03653, 38.897676], [-77.009051, 38.889939]]<br/>      }<br/>    ]<br/>  }<br/>}</span></pre><p id="a679" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="ks"> Geo Json Type BBOX(弹性搜索中的信封):</em> </strong>一个边框，或信封，通过只指定左上角和右下角的点来指定。</p><pre class="je jf jg jh fd lm kx ln lo aw lp bi"><span id="e1ef" class="lq jq hi kx b fi lr ls l lt lu">POST /example/_doc<br/>{<br/>  "location" : {<br/>    "type" : "envelope",<br/>    "coordinates" : [ [-77.03653, 38.897676], [-76.03653, 37.897676] ]<br/>  }<br/>}</span></pre><blockquote class="lv lw lx"><p id="36ce" class="if ig ks ih b ii ij ik il im in io ip ly ir is it lz iv iw ix ma iz ja jb jc hb bi translated">通过使用<code class="du ku kv kw kx b">geo_point</code>或<code class="du ku kv kw kx b">geo_shape</code>，Elasticsearch会自动找到坐标，根据需要的格式验证它们，并索引它们。</p></blockquote><h1 id="334d" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">将数据加载到弹性搜索</h1><p id="819a" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">我们将在本演练中使用的数据来自<a class="ae kt" href="http://www.wsdot.wa.gov/mapsdata/geodatacatalog/default.htm#admin" rel="noopener ugc nofollow" target="_blank">华盛顿州运输部(WSDOT) </a>地理数据目录。下载“城市点”和“WSDOT区域24k”的形状文件。City Points将为我们提供华盛顿的城市，而WSDOT Regions将为我们提供由WSDOT指定的区域。您可以点击下载链接旁边的<strong class="ih hj">查看</strong>在下载前查看数据。我已经将shapefiles转换为<strong class="ih hj"> <em class="ks"> GeoJSON </em> </strong>格式。</p><p id="a69c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我创建了一个node js应用程序来创建索引和加载数据。请按照<a class="ae kt" href="https://github.com/ereshzealous/node_playground/tree/master/elastic-geo-spatial" rel="noopener ugc nofollow" target="_blank"> Github </a>链接中的步骤，并按照自述文件加载数据。</p><h1 id="0e3c" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">地理点查询</h1><p id="1524" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">Elasticsearch使用术语查询和过滤器。查询依赖于“评分”，或者文档是否与查询匹配以及匹配程度如何。另一方面，过滤是“不计分的”,并且确定文档是否匹配查询。根据Elasticsearch的研究，从2.x开始，查询和过滤已经成为同义词，因为你可以同时拥有评分和非评分查询。使用评分或非评分查询有各种性能优势和缺点，但经验法则是当相关性分数很重要时使用评分查询，而对于其他所有情况使用非评分查询。</p><blockquote class="lv lw lx"><p id="44d3" class="if ig ks ih b ii ij ik il im in io ip ly ir is it lz iv iw ix ma iz ja jb jc hb bi translated">因为我们的索引中有一些数据，所以是时候开始查询了。我们将查看一些可以用于<code class="du ku kv kw kx b">geo_point</code>和<code class="du ku kv kw kx b">geo_shape</code>的基本查询。</p></blockquote><p id="ba56" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">与地理点的距离</strong></p><p id="25b2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了获得任意两点之间的距离，我们的数据必须使用<code class="du ku kv kw kx b">geo_point</code>类型存储。<a class="ae kt" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-geo-distance-query.html" rel="noopener ugc nofollow" target="_blank">文档</a>提供了各种数据格式作为示例。匹配地理点给定距离内的<code class="du ku kv kw kx b"><a class="ae kt" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-point.html" rel="noopener ugc nofollow" target="_blank">geo_point</a></code>和<code class="du ku kv kw kx b"><a class="ae kt" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-shape.html" rel="noopener ugc nofollow" target="_blank">geo_shape</a></code>值。以下查询列出了距离<em class="ks"> 10英里的位置。</em></p><pre class="je jf jg jh fd lm kx ln lo aw lp bi"><span id="0676" class="lq jq hi kx b fi lr ls l lt lu">GET geo_cities_point/_search<br/>{<br/>  "query": {<br/>    "bool": {<br/>      "must": {<br/>        "match_all": {}<br/>      },<br/>      "filter": {<br/>        "geo_distance": {<br/>          "distance": "10mi",<br/>          "location": [<br/>            -122.3375,<br/>            47.6112<br/>          ]<br/>        }<br/>      }<br/>    }<br/>  }<br/>}</span></pre><h2 id="1dc9" class="lq jq hi bd jr mb mc md jv me mf mg jz iq mh mi kd iu mj mk kh iy ml mm kl mn bi translated">地理距离范围查询</h2><blockquote class="lv lw lx"><p id="dfc0" class="if ig ks ih b ii ij ik il im in io ip ly ir is it lz iv iw ix ma iz ja jb jc hb bi translated"><code class="du ku kv kw kx b">geo_distance_range</code>查询已被删除。相反，根据您的需要，使用带分页的<a class="ae kt" href="https://www.elastic.co/guide/en/elasticsearch/reference/6.8/query-dsl-geo-distance-query.html" rel="noopener ugc nofollow" target="_blank">地理距离查询</a>或<a class="ae kt" href="https://www.elastic.co/guide/en/elasticsearch/reference/6.8/search-aggregations-bucket-geodistance-aggregation.html" rel="noopener ugc nofollow" target="_blank">地理距离聚合</a>。</p></blockquote><h2 id="1458" class="lq jq hi bd jr mb mc md jv me mf mg jz iq mh mi kd iu mj mk kh iy ml mm kl mn bi translated"><strong class="ak">地理距离聚合</strong></h2><blockquote class="lv lw lx"><p id="8816" class="if ig ks ih b ii ij ik il im in io ip ly ir is it lz iv iw ix ma iz ja jb jc hb bi translated">对<code class="du ku kv kw kx b">geo_point</code>字段起作用的多桶聚合，在概念上与<a class="ae kt" href="https://www.elastic.co/guide/en/elasticsearch/reference/6.8/search-aggregations-bucket-range-aggregation.html" rel="noopener ugc nofollow" target="_blank">范围</a>聚合非常相似。用户可以定义一个原点和一组距离范围桶。聚合计算每个文档值与原点的距离，并根据范围确定其所属的存储桶(如果文档与原点之间的距离在存储桶的距离范围内，则该文档属于该存储桶)。</p></blockquote><p id="a7ee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有时我们需要知道一个范围内的坐标数。这是一个聚合函数，用于列出结果。现在我们将尝试从<code class="du ku kv kw kx b">50 MI to 100 MI</code>和<code class="du ku kv kw kx b">from 100 MI</code>中找到坐标<code class="du ku kv kw kx b">till 10 MI</code>、<code class="du ku kv kw kx b">from 10 MI to 50 MI</code>。这将返回该范围内匹配的文档数量。</p><pre class="je jf jg jh fd lm kx ln lo aw lp bi"><span id="fcac" class="lq jq hi kx b fi lr ls l lt lu">GET geo_cities_point/_search?size=0<br/>{<br/>    "aggs" : {<br/>        "data_around_city" : {<br/>            "geo_distance" : {<br/>                "unit": "mi", <br/>                "field" : "location",<br/>                "origin" : "47.6112, -122.3375",<br/>                <strong class="kx hj">"ranges" : [<br/>                    { "to" : 10 },<br/>                    {"from" : 10, "to" : 50},<br/>                    {"from" : 50, "to" : 100},<br/>                    {"from" : 100}<br/>                ]</strong><br/>            }<br/>        }<br/>    }<br/>}</span></pre><p id="f312" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">答案应该是</strong></p><pre class="je jf jg jh fd lm kx ln lo aw lp bi"><span id="aa08" class="lq jq hi kx b fi lr ls l lt lu">{<br/>"aggregations" : {<br/>    "rings_around_amsterdam" : {<br/>      "buckets" : [<br/>        {<br/>          "key" : "*-10.0",<br/>          "from" : 0.0,<br/>          "to" : 10.0,<br/>         <strong class="kx hj"><em class="ks"> "doc_count" : 12</em></strong><br/>        },<br/>        {<br/>          "key" : "10.0-50.0",<br/>          "from" : 10.0,<br/>          "to" : 50.0,<br/>          <strong class="kx hj"><em class="ks">"doc_count" : 77</em></strong><br/>        },<br/>        {<br/>          "key" : "50.0-100.0",<br/>          "from" : 50.0,<br/>          "to" : 100.0,<br/>          <strong class="kx hj"><em class="ks">"doc_count" : 57</em></strong><br/>        },<br/>        {<br/>          "key" : "100.0-*",<br/>          "from" : 100.0,<br/>          <strong class="kx hj"><em class="ks">"doc_count" : 135</em></strong><br/>        }<br/>      ]<br/>    }<br/>  }<br/>}</span></pre><p id="3ba2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">带地理点的地理多边形</strong></p><p id="8b1f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">返回仅落在多边形点内的命中结果的查询。</p><pre class="je jf jg jh fd lm kx ln lo aw lp bi"><span id="e889" class="lq jq hi kx b fi lr ls l lt lu">GET geo_cities_point/_search<br/>{<br/>  "query": {<br/>    "bool": {<br/>      "must": {<br/>        "match_all": {}<br/>      },<br/>      "filter": {<br/>        "<strong class="kx hj"><em class="ks">geo_polygon</em></strong>": {<br/>          "location": {<br/>            "points": [<br/>              [<br/>                -122.35610961914062,<br/>                47.70514099299205<br/>              ],<br/>              [<br/>                -122.48519897460936,<br/>                47.5626274374099<br/>              ],<br/>              [<br/>                -122.28744506835938,<br/>                47.44852243794931<br/>              ],<br/>              [<br/>                -122.15972900390624,<br/>                47.558920607496525<br/>              ],<br/>              [<br/>                -122.2283935546875,<br/>                47.719001413201916<br/>              ],<br/>              [<br/>                -122.35610961914062,<br/>                47.70514099299205<br/>              ]<br/>            ]<br/>          }<br/>        }<br/>      }<br/>    }<br/>  }<br/>}</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mo"><img src="../Images/6d8e487a9cdab363411ed119e4bf536d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B9hiqE6jpqQihFanUpE-aw.png"/></div></div></figure><p id="c082" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">带有地理点的地理边界框</strong></p><p id="dccb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">匹配与边界框相交的<code class="du ku kv kw kx b"><a class="ae kt" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-point.html" rel="noopener ugc nofollow" target="_blank">geo_point</a></code>和<code class="du ku kv kw kx b"><a class="ae kt" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-shape.html" rel="noopener ugc nofollow" target="_blank">geo_shape</a></code>值。当GeoHashes用于指定边界框边缘的边界时，GeoHashes被视为矩形。边界框的定义方式是，其左上角对应于在<code class="du ku kv kw kx b">top_left</code>参数中指定的GeoHash的左上角，其右下角定义为在<code class="du ku kv kw kx b">bottom_right</code>参数中指定的GeoHash的右下角。</p><blockquote class="lv lw lx"><p id="73c7" class="if ig ks ih b ii ij ik il im in io ip ly ir is it lz iv iw ix ma iz ja jb jc hb bi translated">地理点的精度有限，并且在索引时总是向下舍入。在查询期间，边界框的上边界被向下舍入，而下边界被向上舍入。因此，由于舍入误差，下边界(边界框的底部和左侧边缘)上的点可能不会进入边界框。同时，沿着上边界(顶部和右侧边缘)的点可能被查询选择，即使它们位于边缘的稍外侧。舍入误差在纬度上应小于4.20e-8度，在经度上应小于8.39e-8度，这意味着即使在赤道上误差也小于1厘米。</p></blockquote><pre class="je jf jg jh fd lm kx ln lo aw lp bi"><span id="7d5a" class="lq jq hi kx b fi lr ls l lt lu">GET geo_cities_point/_search<br/>{<br/>  "query": {<br/>    "bool": {<br/>      "must": {<br/>        "match_all": {}<br/>      },<br/>      "filter": {<br/>        "geo_bounding_box": {<br/>          "location": {<br/>            "top_left": {<br/>              "lat": 47.7328,<br/>              "lon": -122.448<br/>            },<br/>            "bottom_right": {<br/>              "lat": 47.468,<br/>              "lon": -122.0924<br/>            }<br/>          }<br/>        }<br/>      }<br/>    }<br/>  }<br/>}</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mp"><img src="../Images/162dfcb15563f4ad48a9a1f865708278.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IS6syaU1q9iOugt-r4m5qg.png"/></div></div></figure><h1 id="cbc1" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">地理形状查询</h1><p id="40cc" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">所有的<em class="ks"> geo-shape </em>查询都需要使用<code class="du ku kv kw kx b">geo_shape</code>映射来映射您的数据。使用<em class="ks">地理形状</em>我们可以找到与查询形状相交的文档。</p><p id="07ea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">地理形状查询</strong></p><p id="b420" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">过滤使用<code class="du ku kv kw kx b">geo_shape</code>或<code class="du ku kv kw kx b">geo_point</code>类型索引的文档。需要<code class="du ku kv kw kx b"><a class="ae kt" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-shape.html" rel="noopener ugc nofollow" target="_blank">geo_shape</a></code>映射<a class="ae kt" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-shape.html" rel="noopener ugc nofollow" target="_blank">或者<code class="du ku kv kw kx b"><a class="ae kt" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-point.html" rel="noopener ugc nofollow" target="_blank">geo_point</a></code>映射</a><a class="ae kt" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-point.html" rel="noopener ugc nofollow" target="_blank">映射</a>。</p><p id="867b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du ku kv kw kx b">geo_shape</code>查询使用与<code class="du ku kv kw kx b">geo_shape</code>映射相同的网格正方形表示来查找具有与查询形状相交的形状的文档。它还将使用为字段映射定义的相同前缀树配置。该查询支持两种定义查询形状的方法，一种是提供完整的形状定义，另一种是引用另一个索引中预索引的形状的名称。这两种格式都在下面用例子进行了定义。</p><h2 id="3339" class="lq jq hi bd jr mb mc md jv me mf mg jz iq mh mi kd iu mj mk kh iy ml mm kl mn bi translated">空间关系</h2><p id="8e22" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated"><a class="ae kt" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-shape.html#spatial-strategy" rel="noopener ugc nofollow" target="_blank"> geo_shape策略</a>映射参数决定了在搜索时可以使用哪些空间关系运算符。</p><p id="98d7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是搜索geo字段时可用的空间关系运算符的完整列表:</p><ul class=""><li id="e563" class="ky kz hi ih b ii ij im in iq la iu lb iy lc jc ld le lf lg bi translated"><code class="du ku kv kw kx b">INTERSECTS</code> -(默认)返回其<code class="du ku kv kw kx b">geo_shape</code>或<code class="du ku kv kw kx b">geo_point</code>字段与查询几何相交的所有文档。</li><li id="d981" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc ld le lf lg bi translated"><code class="du ku kv kw kx b">DISJOINT</code> -返回其<code class="du ku kv kw kx b">geo_shape</code>或<code class="du ku kv kw kx b">geo_point</code>字段与查询几何没有任何共同之处的所有文档。</li><li id="fcc3" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc ld le lf lg bi translated"><code class="du ku kv kw kx b">WITHIN</code> -返回其<code class="du ku kv kw kx b">geo_shape</code>或<code class="du ku kv kw kx b">geo_point</code>字段在查询几何内的所有文档。不支持线几何。</li><li id="d410" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc ld le lf lg bi translated"><code class="du ku kv kw kx b">CONTAINS</code> -返回其<code class="du ku kv kw kx b">geo_shape</code>或<code class="du ku kv kw kx b">geo_point</code>字段包含查询几何的所有文档。</li></ul><pre class="je jf jg jh fd lm kx ln lo aw lp bi"><span id="74be" class="lq jq hi kx b fi lr ls l lt lu">GET geo_cities_shapes/_search<br/>{<br/>  "query": {<br/>    "bool": {<br/>      "must": {<br/>        "match_all": {}<br/>      },<br/>      "filter": {<br/>        "geo_shape": {<br/>          "location": {<br/>            "shape": {<br/>              "type": "envelope",<br/>              "coordinates": [ [ -122.35610961914062, 47.70514099299205 ], [ -122.2283935546875, 47.019001413201916 ] ]<br/>            },<br/>            "relation": "disjoint"<br/>          }<br/>        }<br/>      }<br/>    }<br/>  }<br/>}</span></pre><h1 id="f750" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">预索引形状</h1><p id="ebea" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">该查询还支持使用已经在另一个索引中编入索引的形状。当您有一个预定义的形状列表，并且您想使用一个逻辑名称(例如<em class="ks">新西兰</em>)来引用该列表，而不是每次都必须提供坐标时，这尤其有用。在这种情况下，只需提供:</p><ul class=""><li id="4e15" class="ky kz hi ih b ii ij im in iq la iu lb iy lc jc ld le lf lg bi translated"><code class="du ku kv kw kx b">id</code> -包含预索引形状的文档的ID。</li><li id="9357" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc ld le lf lg bi translated"><code class="du ku kv kw kx b">index</code> -索引前形状所在的索引的名称。默认为<em class="ks">形状</em>。</li><li id="8e4a" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc ld le lf lg bi translated"><code class="du ku kv kw kx b">path</code> -该字段被指定为包含预索引形状的路径。默认为<em class="ks">形状</em>。</li><li id="81e0" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc ld le lf lg bi translated"><code class="du ku kv kw kx b">routing</code> -如有需要，形状文件的传送。</li></ul><pre class="je jf jg jh fd lm kx ln lo aw lp bi"><span id="5113" class="lq jq hi kx b fi lr ls l lt lu">PUT shapes<br/>{<br/>  "mappings": {<br/>    "properties": {<br/>      "geometry": {<br/>        "type": "geo_shape"<br/>      }<br/>    }<br/>  }<br/>}</span><span id="637f" class="lq jq hi kx b fi mq ls l lt lu">PUT shapes/_doc/test<br/>{<br/>  "location": {<br/>    "type": "envelope",<br/>    "coordinates" : [[ -122.35610961914062, 47.70514099299205 ], [ -122.2283935546875, 47.019001413201916 ]]<br/>  }<br/>}</span><span id="607a" class="lq jq hi kx b fi mq ls l lt lu">GET geo_cities_shapes/_search<br/>{<br/>  "query": {<br/>    "bool": {<br/>      "filter": {<br/>        "geo_shape": {<br/>          "location": {<br/>            "indexed_shape": {<br/>              "index": "shapes",<br/>              "id": "test",<br/>              "path": "location"<br/>            }<br/>          }<br/>        }<br/>      }<br/>    }<br/>  }<br/>}</span></pre></div></div>    
</body>
</html>