<html>
<head>
<title>Building a SaaS Project Week Three: Authentication With Auth0 and Next.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">构建SaaS项目第三周:使用Auth0和Next.js进行身份验证</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/authentication-with-auth0-and-next-js-bd20da2a257d?source=collection_archive---------13-----------------------#2021-04-29">https://medium.com/geekculture/authentication-with-auth0-and-next-js-bd20da2a257d?source=collection_archive---------13-----------------------#2021-04-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="72de" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">本周我们将学习认证以及Auth0有多棒！我们使用他们的nextjs-auth0库来包装我们的Next.js应用程序，这使我们能够访问一些非常好的auth helper函数。这真的有助于抽象身份验证的复杂性，并让我们专注于构建一个真正好的产品——我们的用户付钱给我们是为了什么！</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/d2f46d27676ec141a28d64caf5e989aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g-UHHm3mQoiG5xJWMEsVYA.png"/></div></div></figure><p id="c39a" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><a class="ae kf" href="https://github.com/dijonmusters/courses" rel="noopener ugc nofollow" target="_blank">项目回购</a></p><p id="5537" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">本周的主题是用户和认证！我们SaaS项目的重点是提供可以单独购买的课程，或者提供可以访问所有内容的定期订阅。为了做到这一点，我们需要了解一些关于用户的事情！</p><h2 id="5251" class="kg kh hi bd ki kj kk kl km kn ko kp kq js kr ks kt jw ku kv kw ka kx ky kz la bi translated">Auth0</h2><p id="fa88" class="pw-post-body-paragraph jj jk hi jl b jm lb ij jo jp lc im jr js ld ju jv jw le jy jz ka lf kc kd ke hb bi translated">鉴于我对复杂身份验证解决方案的有限经验，我希望尽可能依赖第三方服务。理想情况下，我希望所有的复杂性都被抽象出来，这样我就可以专注于构建真正好的内容——我实际销售的产品！</p><p id="3900" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">与Gatsby或自定义React应用程序相比，Next.js的一大优势是我们可以在运行时访问服务器。这意味着我们可以验证用户是谁，他们应该看到什么——这是我们在客户端上无法真正信任的事情。</p><p id="1a81" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">有许多与Next.js兼容的auth选项，在您需要编写的代码量上有很大的不同。我的主要要求是:</p><ul class=""><li id="edbc" class="lg lh hi jl b jm jn jp jq js li jw lj ka lk ke ll lm ln lo bi translated">社交登录— GitHub</li><li id="43a6" class="lg lh hi jl b jm lp jp lq js lr jw ls ka lt ke ll lm ln lo bi translated">不需要编写会话cookie逻辑</li><li id="fffe" class="lg lh hi jl b jm lp jp lq js lr jw ls ka lt ke ll lm ln lo bi translated">锁定页面和API路径的便捷功能</li></ul><p id="b1fd" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">本质上，我只是想问图书馆“我应该展示这个东西吗？”它给了我一个我可以信任答案！</p><p id="d329" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">Auth0专门为Next.js开发了一个惊人的库，非常有创意地叫做<a class="ae kf" href="https://github.com/auth0/nextjs-auth0" rel="noopener ugc nofollow" target="_blank"> nextjs-auth0 </a>。这允许您使用Auth0的能力来管理帐户创建、登录和注销、会话cookies等，并提供了一组简单的功能，您可以使用这些功能来创建门控内容。</p><p id="be7b" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我们需要做的第一件事是创建一个免费的auth0帐户和一个租户，它可以用来将共享一个用户数据库的应用程序组合在一起。<a class="ae kf" href="https://auth0.com/docs/get-started/learn-the-basics" rel="noopener ugc nofollow" target="_blank">这里有一个很好的指导</a>来得到这个设置。</p><p id="0b1e" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">接下来我们需要在我们的项目中安装和配置<a class="ae kf" href="https://github.com/auth0/nextjs-auth0" rel="noopener ugc nofollow" target="_blank"> @auth0/nextjs-auth0 </a>。<a class="ae kf" href="https://github.com/auth0/nextjs-auth0/blob/main/README.md" rel="noopener ugc nofollow" target="_blank">自述文件</a>详细介绍了我们需要做些什么来实现这一目标！</p><blockquote class="lu lv lw"><p id="fc88" class="jj jk lx jl b jm jn ij jo jp jq im jr ly jt ju jv lz jx jy jz ma kb kc kd ke hb bi translated">记得按照相同的步骤从<a class="ae kf" href="https://jonmeyers.io/blog/build-a-saas-platform-with-stripe/hosting-on-vercel-automatic-deploys-with-github-and-configuring-custom-domains" rel="noopener ugc nofollow" target="_blank">托管在Vercel上，自动部署与GitHub和配置自定义域</a>添加所有这些Auth0秘密到Vercel-没有这我们的托管应用将无法工作。</p></blockquote><p id="a734" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">这给了我们一些超级棒的助手功能，其中我最喜欢的是:</p><h2 id="b670" class="kg kh hi bd ki kj kk kl km kn ko kp kq js kr ks kt jw ku kv kw ka kx ky kz la bi translated">withPageAuthRequired</h2><p id="b80d" class="pw-post-body-paragraph jj jk hi jl b jm lb ij jo jp lc im jr js ld ju jv jw le jy jz ka lf kc kd ke hb bi translated">这是一个客户端功能，我们可以使用它来包装受保护的页面，我们只希望用户能够在登录后访问这些页面。如果他们没有登录，将被重定向到auth0登录页面。简单地将页面级组件包装在这个函数中，如下所示。</p><pre class="iy iz ja jb fd mb mc md me aw mf bi"><span id="014b" class="kg kh hi mc b fi mg mh l mi mj">// pages/dashboard.js<br/><br/>import { withPageAuthRequired } from '@auth0/nextjs-auth0';<br/><br/>const Dashboard = withPageAuthRequired(({ user }) =&gt; {<br/>  return &lt;p&gt;Welcome {user.name}&lt;/p&gt;<br/>})<br/><br/>export default Dashboard</span></pre><h2 id="87fa" class="kg kh hi bd ki kj kk kl km kn ko kp kq js kr ks kt jw ku kv kw ka kx ky kz la bi translated">使用用户</h2><p id="aa1a" class="pw-post-body-paragraph jj jk hi jl b jm lb ij jo jp lc im jr js ld ju jv jw le jy jz ka lf kc kd ke hb bi translated">这是一个客户端React钩子，我们可以用它在任何组件的任何地方获取用户对象。</p><pre class="iy iz ja jb fd mb mc md me aw mf bi"><span id="d833" class="kg kh hi mc b fi mg mh l mi mj">// pages/index.js<br/><br/>import { useUser } from '@auth0/nextjs-auth0';<br/><br/>const Home = () =&gt; {<br/>  const { user, error, isLoading } = useUser();<br/><br/>  if (isLoading) return &lt;div&gt;Loading...&lt;/div&gt;;<br/>  if (error) return &lt;div&gt;{error.message}&lt;/div&gt;;<br/><br/>  if (user) {<br/>    return (<br/>      &lt;div&gt;<br/>        Welcome {user.name}! &lt;a href="/api/auth/logout"&gt;Logout&lt;/a&gt;<br/>      &lt;/div&gt;<br/>    );<br/>  }<br/>  return &lt;a href="/api/auth/login"&gt;Login&lt;/a&gt;;<br/>};<br/><br/>export default Home</span></pre><h2 id="7851" class="kg kh hi bd ki kj kk kl km kn ko kp kq js kr ks kt jw ku kv kw ka kx ky kz la bi translated">withPageAuthRequired</h2><p id="f115" class="pw-post-body-paragraph jj jk hi jl b jm lb ij jo jp lc im jr js ld ju jv jw le jy jz ka lf kc kd ke hb bi translated">这是一个服务器端函数，我们可以将它包装在Next.js的getServerSideProps中，以确保用户在登录之前无法访问页面。</p><pre class="iy iz ja jb fd mb mc md me aw mf bi"><span id="9193" class="kg kh hi mc b fi mg mh l mi mj">// pages/dashboard.js<br/><br/>import { withPageAuthRequired } from '@auth0/nextjs-auth0';<br/><br/>const Dashboard = ({ user }) =&gt; {<br/>  return &lt;div&gt;Hello {user.name}&lt;/div&gt;;<br/>}<br/><br/>export const getServerSideProps = withPageAuthRequired();<br/><br/>export default Dashboard</span></pre><h2 id="c4c3" class="kg kh hi bd ki kj kk kl km kn ko kp kq js kr ks kt jw ku kv kw ka kx ky kz la bi translated">withApiAuthRequired</h2><p id="fc1b" class="pw-post-body-paragraph jj jk hi jl b jm lb ij jo jp lc im jr js ld ju jv jw le jy jz ka lf kc kd ke hb bi translated">这是一个服务器端函数，我们可以包装我们的API路由，以确保只有经过身份验证的用户才能向它发送请求。</p><pre class="iy iz ja jb fd mb mc md me aw mf bi"><span id="b20f" class="kg kh hi mc b fi mg mh l mi mj">// pages/api/courses.js<br/><br/>import { withApiAuthRequired, getSession } from '@auth0/nextjs-auth0';<br/><br/>module.exports = withApiAuthRequired(async (req, res) =&gt; {<br/>  const { user } = getSession(req, res)<br/>  <br/>  // validate user can view courses<br/>  <br/>  res.send(courses)<br/>})</span></pre><h2 id="d41a" class="kg kh hi bd ki kj kk kl km kn ko kp kq js kr ks kt jw ku kv kw ka kx ky kz la bi translated">用户模式</h2><p id="db89" class="pw-post-body-paragraph jj jk hi jl b jm lb ij jo jp lc im jr js ld ju jv jw le jy jz ka lf kc kd ke hb bi translated">Auth0非常适合登录用户并验证他们的会话是否有效，但是，如果我们想跟踪其他信息，例如购买的课程，我们需要在Prisma db中创建一个用户。</p><p id="9691" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">让我们通过添加一个用户模型来扩展我们的模式。</p><pre class="iy iz ja jb fd mb mc md me aw mf bi"><span id="9caa" class="kg kh hi mc b fi mg mh l mi mj">// prisma/schema.prisma<br/><br/>model User {<br/>  id           Int           @id @default(autoincrement())<br/>  email        String        @unique<br/>  courses      Course[]<br/>  createdAt    DateTime      @default(now())<br/>}</span></pre><p id="bc33" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我们将使用来自Auth0的电子邮件来确定我们的用户是谁，因此，它需要是唯一的。</p><p id="2182" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我们还将为每个课程添加一个用户列表。</p><pre class="iy iz ja jb fd mb mc md me aw mf bi"><span id="a23d" class="kg kh hi mc b fi mg mh l mi mj">// prisma/schema.prisma<br/><br/>model Course {<br/>  id        Int      @id @default(autoincrement())<br/>  title     String   @unique<br/>  description     String<br/>  lessons   Lesson[]<br/>  users     User[]<br/>  createdAt DateTime @default(now())<br/>}</span></pre><p id="8974" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">接下来，我们将使用Prisma的迁移API来捕获数据库结构的变化。</p><pre class="iy iz ja jb fd mb mc md me aw mf bi"><span id="7a8d" class="kg kh hi mc b fi mg mh l mi mj">npx prisma migrate dev --name create-user-schema --preview-feature</span></pre><blockquote class="lu lv lw"><p id="37bc" class="jj jk lx jl b jm jn ij jo jp jq im jr ly jt ju jv lz jx jy jz ma kb kc kd ke hb bi translated">这将创建一个名为“create-user-schema”的新迁移，我们需要添加“— preview-feature”，因为这仍然是实验性的。</p></blockquote><p id="8dc5" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">这可能会提示您一些关于覆盖现有数据的问题。选择是。</p><p id="03ad" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">如果它不能应用迁移，您可以尝试重置您的数据库——这将删除整个数据库，因此请确保您不要在没有考虑以后运行它！</p><pre class="iy iz ja jb fd mb mc md me aw mf bi"><span id="7301" class="kg kh hi mc b fi mg mh l mi mj">npx prisma migrate reset --preview-feature</span></pre><p id="c08c" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">接下来，让我们将价格和URL添加到我们的课程模式中。</p><pre class="iy iz ja jb fd mb mc md me aw mf bi"><span id="d7cf" class="kg kh hi mc b fi mg mh l mi mj">// prisma/schema.prisma<br/><br/>model Course {<br/>  id        Int      @id @default(autoincrement())<br/>  title     String   @unique<br/>  description     String<br/>  lessons   Lesson[]<br/>  users     User[]<br/>  price     Int<br/>  slug      String  @unique<br/>  createdAt DateTime @default(now())<br/>}</span></pre><p id="3ee2" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">也是我们课程的一个补充。</p><pre class="iy iz ja jb fd mb mc md me aw mf bi"><span id="1c6b" class="kg kh hi mc b fi mg mh l mi mj">// prisma/schema.prisma<br/><br/>model Lesson {<br/>  id        Int      @id @default(autoincrement())<br/>  title     String   @unique<br/>  description     String<br/>  courseId  Int<br/>  course    Course   @relation(fields: [courseId], references: [id])<br/>  videoUrl  String<br/>  slug      String  @unique<br/>  createdAt DateTime @default(now())<br/>}</span></pre><p id="abb6" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">整个文件应该是这样的。</p><pre class="iy iz ja jb fd mb mc md me aw mf bi"><span id="84a8" class="kg kh hi mc b fi mg mh l mi mj">// prisma/schema.prisma<br/><br/>generator client {<br/>  provider = "prisma-client-js"<br/>}<br/><br/>datasource db {<br/>  provider = "postgresql"<br/>  url      = env("DATABASE_URL")<br/>}<br/><br/>model User {<br/>  id           Int           @id @default(autoincrement())<br/>  email        String        @unique<br/>  courses      Course[]<br/>  createdAt    DateTime      @default(now())<br/>}<br/><br/>model Course {<br/>  id        Int      @id @default(autoincrement())<br/>  title     String   @unique<br/>  description     String<br/>  lessons   Lesson[]<br/>  users     User[]<br/>  price     Int<br/>  slug      String  @unique<br/>  createdAt DateTime @default(now())<br/>}<br/><br/>model Lesson {<br/>  id        Int      @id @default(autoincrement())<br/>  title     String   @unique<br/>  description     String<br/>  courseId  Int<br/>  course    Course   @relation(fields: [courseId], references: [id])<br/>  videoUrl  String<br/>  slug      String  @unique<br/>  createdAt DateTime @default(now())<br/>}</span></pre><p id="04e9" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">让我们再次运行migration命令来快照这些更改并更新我们的数据库。</p><pre class="iy iz ja jb fd mb mc md me aw mf bi"><span id="5daf" class="kg kh hi mc b fi mg mh l mi mj">npx prisma migrate dev --name add-slugs --preview-feature</span></pre><p id="cc5b" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">厉害！现在，我们的应用程序使用Auth0进行身份验证，保护我们受保护的内容，并且我们的数据库模式已经准备就绪！</p><h2 id="540a" class="kg kh hi bd ki kj kk kl km kn ko kp kq js kr ks kt jw ku kv kw ka kx ky kz la bi translated">跟我来</h2><p id="dae7" class="pw-post-body-paragraph jj jk hi jl b jm lb ij jo jp lc im jr js ld ju jv jw le jy jz ka lf kc kd ke hb bi translated"><a class="ae kf" href="https://jonmeyers.io/" rel="noopener ugc nofollow" target="_blank">网站</a></p><p id="5e8e" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><a class="ae kf" href="https://twitter.com/_dijonmusters" rel="noopener ugc nofollow" target="_blank">推特</a></p><p id="0fc1" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><a class="ae kf" href="https://www.youtube.com/channel/UCPitAIwktfCfcMR4kDWebDQ" rel="noopener ugc nofollow" target="_blank"> YouTube </a></p><h2 id="df70" class="kg kh hi bd ki kj kk kl km kn ko kp kq js kr ks kt jw ku kv kw ka kx ky kz la bi translated">下星期</h2><p id="2d73" class="pw-post-body-paragraph jj jk hi jl b jm lb ij jo jp lc im jr js ld ju jv jw le jy jz ka lf kc kd ke hb bi translated"><a class="ae kf" href="https://jonmeyers.io/blog/build-a-saas-platform-with-stripe/social-login-with-github-and-auth0-rules" rel="noopener ugc nofollow" target="_blank">使用GitHub和Auth0规则进行社交登录</a></p></div></div>    
</body>
</html>