<html>
<head>
<title>Web Scraping Google Finance Markets in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Python抓取谷歌金融市场</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/web-scraping-google-finance-markets-in-python-a657da42a7d?source=collection_archive---------4-----------------------#2022-08-02">https://medium.com/geekculture/web-scraping-google-finance-markets-in-python-a657da42a7d?source=collection_archive---------4-----------------------#2022-08-02</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><ul class=""><li id="712d" class="if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw bi translated"><a class="ae ix" href="#ee1e" rel="noopener ugc nofollow">会刮什么</a></li><li id="b860" class="if ig hi ih b ii iy ik iz im ja io jb iq jc is it iu iv iw bi translated"><a class="ae ix" href="#aec9" rel="noopener ugc nofollow">全码</a></li><li id="ac09" class="if ig hi ih b ii iy ik iz im ja io jb iq jc is it iu iv iw bi translated"><a class="ae ix" href="#2979" rel="noopener ugc nofollow">先决条件</a></li><li id="f017" class="if ig hi ih b ii iy ik iz im ja io jb iq jc is it iu iv iw bi translated"><a class="ae ix" href="#53ae" rel="noopener ugc nofollow">代码解释</a></li><li id="5490" class="if ig hi ih b ii iy ik iz im ja io jb iq jc is it iu iv iw bi translated"><a class="ae ix" href="#f7ce" rel="noopener ugc nofollow">谷歌金融市场应用编程接口</a></li><li id="1179" class="if ig hi ih b ii iy ik iz im ja io jb iq jc is it iu iv iw bi translated"><a class="ae ix" href="#8471" rel="noopener ugc nofollow">链接</a></li></ul><h1 id="ee1e" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">会刮什么</h1><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es kb"><img src="../Images/d2ff1572a16c30c43eefb20756600aa1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*6hYecEC4Umbti-WL.png"/></div></div></figure><h1 id="aec9" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">完整代码</h1><figure class="kc kd ke kf fd kg"><div class="bz dy l di"><div class="kn ko l"/></div></figure><h1 id="2979" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">先决条件</h1><p id="9b55" class="pw-post-body-paragraph kp kq hi ih b ii kr ks kt ik ku kv kw im kx ky kz io la lb lc iq ld le lf is hb bi translated"><strong class="ih hj">安装库</strong>:</p><pre class="kc kd ke kf fd lg lh li lj aw lk bi"><span id="5f1e" class="ll je hi lh b fi lm ln l lo lp">pip install requests parsel</span></pre><p id="6114" class="pw-post-body-paragraph kp kq hi ih b ii ij ks kt ik il kv kw im lq ky kz io lr lb lc iq ls le lf is hb bi translated"><strong class="ih hj">CSS选择器基础知识抓取</strong></p><p id="cbe0" class="pw-post-body-paragraph kp kq hi ih b ii ij ks kt ik il kv kw im lq ky kz io lr lb lc iq ls le lf is hb bi translated">CSS选择器声明样式应用于标记的哪一部分，从而允许从匹配的标签和属性中提取数据。</p><p id="5980" class="pw-post-body-paragraph kp kq hi ih b ii ij ks kt ik il kv kw im lq ky kz io lr lb lc iq ls le lf is hb bi translated">如果你还没有使用CSS选择器，我有一篇关于如何在抓取网页时使用CSS选择器的博文,内容包括它是什么，优缺点，以及为什么从抓取网页的角度来看它们很重要。</p><p id="90be" class="pw-post-body-paragraph kp kq hi ih b ii ij ks kt ik il kv kw im lq ky kz io lr lb lc iq ls le lf is hb bi translated"><strong class="ih hj">独立的虚拟环境</strong></p><p id="24ad" class="pw-post-body-paragraph kp kq hi ih b ii ij ks kt ik il kv kw im lq ky kz io lr lb lc iq ls le lf is hb bi translated">简而言之，它创建了一组独立的已安装库，包括不同的Python版本，这些版本可以在同一系统中共存，从而防止库或Python版本冲突。</p><p id="ddbf" class="pw-post-body-paragraph kp kq hi ih b ii ij ks kt ik il kv kw im lq ky kz io lr lb lc iq ls le lf is hb bi translated">如果你以前没有使用过虚拟环境，看看我的博客文章<br/>专用的<a class="ae ix" href="https://serpapi.com/blog/python-virtual-environments-using-virtualenv-and-poetry/" rel="noopener ugc nofollow" target="_blank"> Python虚拟环境教程(使用Virtualenv和poems</a>)会更熟悉一些。</p><p id="a3ca" class="pw-post-body-paragraph kp kq hi ih b ii ij ks kt ik il kv kw im lq ky kz io lr lb lc iq ls le lf is hb bi translated">📌注意:这不是这个博客的严格要求。</p><p id="d057" class="pw-post-body-paragraph kp kq hi ih b ii ij ks kt ik il kv kw im lq ky kz io lr lb lc iq ls le lf is hb bi translated"><strong class="ih hj">降低被屏蔽的几率</strong></p><p id="b6b8" class="pw-post-body-paragraph kp kq hi ih b ii ij ks kt ik il kv kw im lq ky kz io lr lb lc iq ls le lf is hb bi translated">请求有可能被阻止。看看<a class="ae ix" href="https://serpapi.com/blog/how-to-reduce-chance-of-being-blocked-while-web/" rel="noopener ugc nofollow" target="_blank">如何降低抓取网页时被屏蔽的几率</a>，有11种方法可以绕过大多数网站的屏蔽。</p><h1 id="53ae" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">代码解释</h1><p id="f92a" class="pw-post-body-paragraph kp kq hi ih b ii kr ks kt ik ku kv kw im kx ky kz io la lb lc iq ld le lf is hb bi translated">导入库:</p><pre class="kc kd ke kf fd lg lh li lj aw lk bi"><span id="cdda" class="ll je hi lh b fi lm ln l lo lp">import requests<br/>import json<br/>import re<br/>import argparse<br/>from parsel import Selector</span></pre><ul class=""><li id="ada9" class="if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw bi translated"><code class="du lt lu lv lh b"><a class="ae ix" href="https://requests.readthedocs.io/en/latest/user/quickstart/" rel="noopener ugc nofollow" target="_blank">requests</a></code>向网站提出请求。</li><li id="6a5c" class="if ig hi ih b ii iy ik iz im ja io jb iq jc is it iu iv iw bi translated"><code class="du lt lu lv lh b"><a class="ae ix" href="https://docs.python.org/3/library/json.html" rel="noopener ugc nofollow" target="_blank">json</a></code>将提取的数据转换成JSON对象。</li><li id="107e" class="if ig hi ih b ii iy ik iz im ja io jb iq jc is it iu iv iw bi translated"><code class="du lt lu lv lh b"><a class="ae ix" href="https://docs.python.org/3/library/re.html" rel="noopener ugc nofollow" target="_blank">re</a></code>通过正则表达式提取部分数据。</li><li id="8c64" class="if ig hi ih b ii iy ik iz im ja io jb iq jc is it iu iv iw bi translated"><code class="du lt lu lv lh b"><a class="ae ix" href="https://docs.python.org/3/library/argparse.html" rel="noopener ugc nofollow" target="_blank">argparse</a></code>通过正则表达式提取部分数据。</li><li id="c569" class="if ig hi ih b ii iy ik iz im ja io jb iq jc is it iu iv iw bi translated"><code class="du lt lu lv lh b"><a class="ae ix" href="https://parsel.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank">parsel</a></code>解析HTML/XML文档中的数据。类似于<code class="du lt lu lv lh b">BeautifulSoup</code>，但是支持XPath。</li></ul><p id="0498" class="pw-post-body-paragraph kp kq hi ih b ii ij ks kt ik il kv kw im lq ky kz io lr lb lc iq ls le lf is hb bi translated">首先，如果我们需要通过键入命令行参数来解析数据，而不需要激活代码中的某些功能来提取特定类型的结果，例如，加密、获益者或失败者，我们可以通过创建命令行参数使用<code class="du lt lu lv lh b">argparse</code>内置库来完成:</p><pre class="kc kd ke kf fd lg lh li lj aw lk bi"><span id="4689" class="ll je hi lh b fi lm ln l lo lp">parser = argparse.ArgumentParser(prog="Google Finance Markets Options")<br/>parser.add_argument('-i','--indexes', action="store_true")<br/>parser.add_argument('-ma','--most-active', action="store_true")<br/>parser.add_argument('-g','--gainers', action="store_true")<br/>parser.add_argument('-l','--losers', action="store_true")<br/>parser.add_argument('-cl','--climate-leaders', action="store_true")<br/>parser.add_argument('-cc','--crypto', action="store_true")<br/>parser.add_argument('-c','--currency', action="store_true")</span><span id="6b0a" class="ll je hi lh b fi lw ln l lo lp">args = parser.parse_args()</span></pre><p id="7081" class="pw-post-body-paragraph kp kq hi ih b ii ij ks kt ik il kv kw im lq ky kz io lr lb lc iq ls le lf is hb bi translated">然后我们可以像这样运行脚本:</p><pre class="kc kd ke kf fd lg lh li lj aw lk bi"><span id="c726" class="ll je hi lh b fi lm ln l lo lp">$ python main.py -cc # will parse crypto results</span></pre><p id="abdb" class="pw-post-body-paragraph kp kq hi ih b ii ij ks kt ik il kv kw im lq ky kz io lr lb lc iq ls le lf is hb bi translated">注意如果不使用<code class="du lt lu lv lh b">action="store_true"</code>，结果将是一个错误:</p><pre class="kc kd ke kf fd lg lh li lj aw lk bi"><span id="ba8c" class="ll je hi lh b fi lm ln l lo lp">$ python main.py -cc</span><span id="76c1" class="ll je hi lh b fi lw ln l lo lp">Google Finance Markets Options: error: argument -cc/--crypto: expected one argument</span></pre><p id="5ac2" class="pw-post-body-paragraph kp kq hi ih b ii ij ks kt ik il kv kw im lq ky kz io lr lb lc iq ls le lf is hb bi translated">设置为<code class="du lt lu lv lh b">store_true</code>的<code class="du lt lu lv lh b">action</code>将参数存储为<code class="du lt lu lv lh b">True</code>，如果存在的话。所以如果参数存在，它将返回一些输出。</p><p id="7c4d" class="pw-post-body-paragraph kp kq hi ih b ii ij ks kt ik il kv kw im lq ky kz io lr lb lc iq ls le lf is hb bi translated">我们也可以将参数设为<code class="du lt lu lv lh b"><a class="ae ix" href="https://docs.python.org/3/library/argparse.html#required" rel="noopener ugc nofollow" target="_blank">requried</a></code>，这意味着某个参数是<em class="lx">需要</em>在使用文件时使用。</p><ul class=""><li id="62a5" class="if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw bi translated"><code class="du lt lu lv lh b"><a class="ae ix" href="https://docs.python.org/3/library/argparse.html#the-add-argument-method" rel="noopener ugc nofollow" target="_blank">add_argument</a></code>定义如何解析一个命令行参数。</li><li id="dc75" class="if ig hi ih b ii iy ik iz im ja io jb iq jc is it iu iv iw bi translated"><code class="du lt lu lv lh b"><a class="ae ix" href="https://docs.python.org/3/library/argparse.html#argparse.ArgumentParser.parse_args" rel="noopener ugc nofollow" target="_blank">parse_args</a></code>决定<code class="du lt lu lv lh b">add_argument</code>创建什么对象以及如何分配它们。返回填充的命名空间。</li></ul><p id="61fc" class="pw-post-body-paragraph kp kq hi ih b ii ij ks kt ik il kv kw im lq ky kz io lr lb lc iq ls le lf is hb bi translated">下一步是用所有命令行逻辑创建函数。您可以使用点符号访问命令行参数:</p><pre class="kc kd ke kf fd lg lh li lj aw lk bi"><span id="f6d8" class="ll je hi lh b fi lm ln l lo lp">def main():</span><span id="bcac" class="ll je hi lh b fi lw ln l lo lp">    # https://docs.python-requests.org/en/master/user/quickstart/#custom-headers<br/>    # https://www.whatismybrowser.com/detect/what-is-my-user-agent<br/>    headers = {<br/>        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.5060.134 Safari/537.36"<br/>    }</span><span id="f586" class="ll je hi lh b fi lw ln l lo lp">    if args.indexes:<br/>        html = requests.get("https://www.google.com/finance/markets/indexes", headers=headers, timeout=30)<br/>        return parser(html=html)</span><span id="961c" class="ll je hi lh b fi lw ln l lo lp">    # ... other arguments logic</span></pre><ul class=""><li id="c96f" class="if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw bi translated"><code class="du lt lu lv lh b"><a class="ae ix" href="https://developer.mozilla.org/en-US/docs/Glossary/User_agent" rel="noopener ugc nofollow" target="_blank">user-agent</a></code>作为来自浏览器的“真实”用户请求，将其传递给<a class="ae ix" href="https://docs.python-requests.org/en/master/user/quickstart/#custom-headers" rel="noopener ugc nofollow" target="_blank">请求头</a>。这是用来绕过谷歌的屏蔽，因为默认情况下<code class="du lt lu lv lh b">requests</code>用户代理是<code class="du lt lu lv lh b"><a class="ae ix" href="https://github.com/psf/requests/blob/main/requests/utils.py#L884-L890" rel="noopener ugc nofollow" target="_blank">python-requests</a></code>，网站知道它是一个发送请求的机器人，可能会阻止它。<a class="ae ix" href="https://www.whatismybrowser.com/detect/what-is-my-user-agent" rel="noopener ugc nofollow" target="_blank">检查你的</a>是什么<code class="du lt lu lv lh b"><a class="ae ix" href="https://www.whatismybrowser.com/detect/what-is-my-user-agent" rel="noopener ugc nofollow" target="_blank">user-agent</a></code>。</li><li id="5abd" class="if ig hi ih b ii iy ik iz im ja io jb iq jc is it iu iv iw bi translated"><code class="du lt lu lv lh b">if args.indexes</code>将检查某个命令行参数是否被传递。</li><li id="0656" class="if ig hi ih b ii iy ik iz im ja io jb iq jc is it iu iv iw bi translated"><code class="du lt lu lv lh b"><a class="ae ix" href="https://requests.readthedocs.io/en/latest/user/quickstart/#timeouts" rel="noopener ugc nofollow" target="_blank">timeout=30</a></code>告诉<code class="du lt lu lv lh b">requests</code>30秒后停止等待响应。</li><li id="4208" class="if ig hi ih b ii iy ik iz im ja io jb iq jc is it iu iv iw bi translated"><code class="du lt lu lv lh b">return parser(html=html)</code>从<code class="du lt lu lv lh b">parser()</code>函数返回数据，以减少代码大小，因为每个选择器提取的数据都是相同的。</li></ul><p id="384b" class="pw-post-body-paragraph kp kq hi ih b ii ij ks kt ik il kv kw im lq ky kz io lr lb lc iq ls le lf is hb bi translated">下一步是创建一个解析器函数，从页面中提取所有需要的数据。该函数需要将传递给<code class="du lt lu lv lh b">parsel</code>的<code class="du lt lu lv lh b">html</code>参数，然后我们需要创建<code class="du lt lu lv lh b">data</code>解析后的结构:</p><pre class="kc kd ke kf fd lg lh li lj aw lk bi"><span id="d4bc" class="ll je hi lh b fi lm ln l lo lp">def parser(html):<br/>    selector = Selector(text=html.text)<br/>    stock_topic = selector.css(".Mrksgc::text").get().split("on ")[1].replace(" ", "_")</span><span id="3503" class="ll je hi lh b fi lw ln l lo lp">    data = {<br/>        f"{stock_topic}_trends": [],<br/>        f"{stock_topic}_discover_more": [],<br/>        f"{stock_topic}_news": []<br/>    }</span></pre><ul class=""><li id="a4ef" class="if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw bi translated"><code class="du lt lu lv lh b">Selector(text=html.text)</code>响应中传递的HTML将由<code class="du lt lu lv lh b">parsel</code>处理。</li><li id="7b3c" class="if ig hi ih b ii iy ik iz im ja io jb iq jc is it iu iv iw bi translated"><code class="du lt lu lv lh b">text=</code>是一个<code class="du lt lu lv lh b"><a class="ae ix" href="https://github.com/scrapy/parsel/blob/52b1db6f1c0e9768334d9c33627773e0e687a60d/parsel/selector.py#L230" rel="noopener ugc nofollow" target="_blank">parsel</a></code> <a class="ae ix" href="https://github.com/scrapy/parsel/blob/52b1db6f1c0e9768334d9c33627773e0e687a60d/parsel/selector.py#L230" rel="noopener ugc nofollow" target="_blank">参数，它接受将从中提取HTML节点的</a> <code class="du lt lu lv lh b"><a class="ae ix" href="https://github.com/scrapy/parsel/blob/52b1db6f1c0e9768334d9c33627773e0e687a60d/parsel/selector.py#L230" rel="noopener ugc nofollow" target="_blank">str</a></code> <a class="ae ix" href="https://github.com/scrapy/parsel/blob/52b1db6f1c0e9768334d9c33627773e0e687a60d/parsel/selector.py#L230" rel="noopener ugc nofollow" target="_blank">对象</a>。</li><li id="102c" class="if ig hi ih b ii iy ik iz im ja io jb iq jc is it iu iv iw bi translated"><code class="du lt lu lv lh b"><a class="ae ix" href="https://github.com/scrapy/parsel/blob/90397dcd0b2c1cbb91e44f65c50f9e11628ba028/parsel/selector.py#L351-L362" rel="noopener ugc nofollow" target="_blank">css()</a></code>从传递的CSS选择器中解析数据。每个<a class="ae ix" href="https://github.com/scrapy/parsel/blob/90397dcd0b2c1cbb91e44f65c50f9e11628ba028/parsel/selector.py#L357-L358" rel="noopener ugc nofollow" target="_blank"> CSS查询都使用</a> <code class="du lt lu lv lh b"><a class="ae ix" href="https://github.com/scrapy/parsel/blob/90397dcd0b2c1cbb91e44f65c50f9e11628ba028/parsel/selector.py#L357-L358" rel="noopener ugc nofollow" target="_blank">csselect</a></code> <a class="ae ix" href="https://github.com/scrapy/parsel/blob/90397dcd0b2c1cbb91e44f65c50f9e11628ba028/parsel/selector.py#L357-L358" rel="noopener ugc nofollow" target="_blank">包</a>转换成XPath。</li><li id="ee6a" class="if ig hi ih b ii iy ik iz im ja io jb iq jc is it iu iv iw bi translated"><code class="du lt lu lv lh b"><a class="ae ix" href="https://github.com/scrapy/parsel/blob/90397dcd0b2c1cbb91e44f65c50f9e11628ba028/parsel/csstranslator.py#L48-L51" rel="noopener ugc nofollow" target="_blank">::text</a></code> <a class="ae ix" href="https://github.com/scrapy/parsel/blob/90397dcd0b2c1cbb91e44f65c50f9e11628ba028/parsel/csstranslator.py#L48-L51" rel="noopener ugc nofollow" target="_blank">或</a> <code class="du lt lu lv lh b"><a class="ae ix" href="https://github.com/scrapy/parsel/blob/90397dcd0b2c1cbb91e44f65c50f9e11628ba028/parsel/csstranslator.py#L48-L51" rel="noopener ugc nofollow" target="_blank">::attr(&lt;attribute&gt;)</a></code>从节点中提取文本或属性数据。</li><li id="95d9" class="if ig hi ih b ii iy ik iz im ja io jb iq jc is it iu iv iw bi translated"><code class="du lt lu lv lh b"><a class="ae ix" href="https://github.com/scrapy/parsel/blob/90397dcd0b2c1cbb91e44f65c50f9e11628ba028/parsel/selector.py#L197-L204" rel="noopener ugc nofollow" target="_blank">get()</a></code>获取从<code class="du lt lu lv lh b">parsel</code>返回的实际数据</li><li id="71ad" class="if ig hi ih b ii iy ik iz im ja io jb iq jc is it iu iv iw bi translated"><code class="du lt lu lv lh b"><a class="ae ix" href="https://www.w3schools.com/python/ref_string_split.asp" rel="noopener ugc nofollow" target="_blank">split()</a></code>将一个字符串拆分成一个列表，其中每个单词都是一个列表项</li><li id="2419" class="if ig hi ih b ii iy ik iz im ja io jb iq jc is it iu iv iw bi translated">用一串新的东西代替旧的东西。</li></ul><p id="e1fb" class="pw-post-body-paragraph kp kq hi ih b ii ij ks kt ik il kv kw im lq ky kz io lr lb lc iq ls le lf is hb bi translated">在创建了一个空的字典结构后，我们需要通过<code class="du lt lu lv lh b">appending</code> it用新闻、股票和其他数据填充它，在本例中作为一个<code class="du lt lu lv lh b">dict</code>:</p><pre class="kc kd ke kf fd lg lh li lj aw lk bi"><span id="23cd" class="ll je hi lh b fi lm ln l lo lp"># news ressults<br/>for index, news_results in enumerate(selector.css(".yY3Lee"), start=1):<br/>    data[f"{stock_topic}_news"].append({<br/>        "position": index,<br/>        "title": news_results.css(".mRjSYb::text").get(),<br/>        "source": news_results.css(".sfyJob::text").get(),<br/>        "date": news_results.css(".Adak::text").get(),<br/>        "image": news_results.css("img::attr(src)").get(),<br/>    })</span><span id="1940" class="ll je hi lh b fi lw ln l lo lp"># stocks table<br/>for index, stock_results in enumerate(selector.css("li a"), start=1):<br/>    current_percent_change_raw_value = stock_results.css("[jsname=Fe7oBc]::attr(aria-label)").get()<br/>    current_percent_change = re.search(r"<!-- -->\d+\.\d+%<!-- -->", stock_results.css("[jsname=Fe7oBc]::attr(aria-label)").get()).group()</span><span id="e94e" class="ll je hi lh b fi lw ln l lo lp">    # ./quote/SNAP:NASDAQ -&gt; SNAP:NASDAQ<br/>    quote = stock_results.attrib["href"].replace("./quote/", "")</span><span id="1323" class="ll je hi lh b fi lw ln l lo lp">    data[f"{stock_topic}_trends"].append({<br/>        "position": index,<br/>        "title": stock_results.css(".ZvmM7::text").get(),<br/>        "quote": stock_results.css(".COaKTb::text").get(),<br/>        # "https://www.google.com/finance/MSFT:NASDAQ"<br/>        "quote_link": f"https://www.google.com/finance/{quote}",<br/>        "price_change": stock_results.css(".SEGxAb .P2Luy::text").get(),<br/>        "percent_price_change": f"+{current_percent_change}" if "Up" in current_percent_change_raw_value else f"-{current_percent_change}"<br/>    })</span><span id="2695" class="ll je hi lh b fi lw ln l lo lp"># "you may be interested in" at the bottom of the page<br/>for index, interested_bottom in enumerate(selector.css(".HDXgAf .tOzDHb"), start=1):<br/>    current_percent_change_raw_value = interested_bottom.css("[jsname=Fe7oBc]::attr(aria-label)").get()<br/>    current_percent_change = re.search(r"<!-- -->\d+\.\d+%<!-- -->", interested_bottom.css("[jsname=Fe7oBc]::attr(aria-label)").get()).group()</span><span id="8ca3" class="ll je hi lh b fi lw ln l lo lp">    # ./quote/SNAP:NASDAQ -&gt; SNAP:NASDAQ<br/>    quote = stock_results.attrib["href"].replace("./quote/", "")</span><span id="f6de" class="ll je hi lh b fi lw ln l lo lp">    data[f"{stock_topic}_discover_more"].append({<br/>        "position": index,<br/>        "quote": interested_bottom.css(".COaKTb::text").get(),<br/>        "quote_link": f"https://www.google.com/finance{quote}",<br/>        "title": interested_bottom.css(".RwFyvf::text").get(),<br/>        "price": interested_bottom.css(".YMlKec::text").get(),<br/>        "percent_price_change": f"+{current_percent_change}" if "Up" in current_percent_change_raw_value else f"-{current_percent_change}"<br/>    })</span></pre><ul class=""><li id="b342" class="if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw bi translated"><code class="du lt lu lv lh b"><a class="ae ix" href="https://docs.python.org/3/library/functions.html#enumerate" rel="noopener ugc nofollow" target="_blank">enumerate()</a></code> <a class="ae ix" href="https://www.programiz.com/python-programming/methods/built-in/enumerate" rel="noopener ugc nofollow" target="_blank">给一个iterable添加一个计数器并返回它</a>。</li><li id="2f3e" class="if ig hi ih b ii iy ik iz im ja io jb iq jc is it iu iv iw bi translated"><code class="du lt lu lv lh b">start=1</code>将从1开始计数，而不是从默认值0开始计数。</li><li id="646f" class="if ig hi ih b ii iy ik iz im ja io jb iq jc is it iu iv iw bi translated"><code class="du lt lu lv lh b"><a class="ae ix" href="https://github.com/scrapy/parsel/blob/90397dcd0b2c1cbb91e44f65c50f9e11628ba028/parsel/csstranslator.py#L48-L51" rel="noopener ugc nofollow" target="_blank">::text</a></code> <a class="ae ix" href="https://github.com/scrapy/parsel/blob/90397dcd0b2c1cbb91e44f65c50f9e11628ba028/parsel/csstranslator.py#L48-L51" rel="noopener ugc nofollow" target="_blank">或</a> <code class="du lt lu lv lh b"><a class="ae ix" href="https://github.com/scrapy/parsel/blob/90397dcd0b2c1cbb91e44f65c50f9e11628ba028/parsel/csstranslator.py#L48-L51" rel="noopener ugc nofollow" target="_blank">::attr(&lt;attribute&gt;)</a></code>从节点中提取文本或属性数据。</li><li id="f2f0" class="if ig hi ih b ii iy ik iz im ja io jb iq jc is it iu iv iw bi translated"><code class="du lt lu lv lh b">data[f"{stock_topic}_news"]</code>动态地将数据作为<code class="du lt lu lv lh b">dict</code>附加到由<code class="du lt lu lv lh b">stock_topic</code>变量提取的任何值上。</li><li id="3563" class="if ig hi ih b ii iy ik iz im ja io jb iq jc is it iu iv iw bi translated"><code class="du lt lu lv lh b"><a class="ae ix" href="https://docs.python.org/3/tutorial/datastructures.html" rel="noopener ugc nofollow" target="_blank">append()</a></code>将提取的数据追加到<code class="du lt lu lv lh b">list</code>作为字典。</li><li id="a997" class="if ig hi ih b ii iy ik iz im ja io jb iq jc is it iu iv iw bi translated"><code class="du lt lu lv lh b"><a class="ae ix" href="https://github.com/scrapy/parsel/blob/90397dcd0b2c1cbb91e44f65c50f9e11628ba028/parsel/selector.py#L351-L362" rel="noopener ugc nofollow" target="_blank">css()</a></code>从传递的CSS选择器中解析数据。每一个<a class="ae ix" href="https://github.com/scrapy/parsel/blob/90397dcd0b2c1cbb91e44f65c50f9e11628ba028/parsel/selector.py#L357-L358" rel="noopener ugc nofollow" target="_blank"> CSS查询都使用</a> <code class="du lt lu lv lh b"><a class="ae ix" href="https://github.com/scrapy/parsel/blob/90397dcd0b2c1cbb91e44f65c50f9e11628ba028/parsel/selector.py#L357-L358" rel="noopener ugc nofollow" target="_blank">csselect</a></code> <a class="ae ix" href="https://github.com/scrapy/parsel/blob/90397dcd0b2c1cbb91e44f65c50f9e11628ba028/parsel/selector.py#L357-L358" rel="noopener ugc nofollow" target="_blank">包</a>转换成XPath。</li><li id="83a9" class="if ig hi ih b ii iy ik iz im ja io jb iq jc is it iu iv iw bi translated"><code class="du lt lu lv lh b"><a class="ae ix" href="https://serpapi.com/blog/scrape-google-finance-markets-in-python/(https://github.com/scrapy/parsel/blob/90397dcd0b2c1cbb91e44f65c50f9e11628ba028/parsel/selector.py#L197-L204)" rel="noopener ugc nofollow" target="_blank">get()</a></code>获取实际数据。</li><li id="52cc" class="if ig hi ih b ii iy ik iz im ja io jb iq jc is it iu iv iw bi translated"><code class="du lt lu lv lh b"><a class="ae ix" href="https://github.com/scrapy/parsel/blob/90397dcd0b2c1cbb91e44f65c50f9e11628ba028/parsel/selector.py#L180-L185" rel="noopener ugc nofollow" target="_blank">getall()</a></code>获得全部一场<code class="du lt lu lv lh b">list</code>的比赛。</li><li id="548b" class="if ig hi ih b ii iy ik iz im ja io jb iq jc is it iu iv iw bi translated"><code class="du lt lu lv lh b">[jsname=Fe7oBc]</code>是一个<a class="ae ix" href="https://www.w3schools.com/cssref/sel_attribute_value.asp" rel="noopener ugc nofollow" target="_blank"> CSS选择器，用于选择具有指定属性和值</a>的元素，如<code class="du lt lu lv lh b">[attribute=value]</code>。</li><li id="6378" class="if ig hi ih b ii iy ik iz im ja io jb iq jc is it iu iv iw bi translated"><code class="du lt lu lv lh b"><a class="ae ix" href="https://github.com/scrapy/parsel/blob/52b1db6f1c0e9768334d9c33627773e0e687a60d/parsel/selector.py#L209" rel="noopener ugc nofollow" target="_blank">attrib["href"]</a></code>是访问节点属性的<code class="du lt lu lv lh b">parsel</code>方法。它为第一个匹配的元素返回<code class="du lt lu lv lh b">dict</code>。<code class="du lt lu lv lh b">None</code>如果字典为空。</li><li id="46e9" class="if ig hi ih b ii iy ik iz im ja io jb iq jc is it iu iv iw bi translated"><code class="du lt lu lv lh b"><a class="ae ix" href="https://docs.python.org/3/library/stdtypes.html#str.replace" rel="noopener ugc nofollow" target="_blank">replace("&lt;something&gt;", "&lt;with_something&gt;")</a></code>用一串新的东西代替旧的东西。</li><li id="5e36" class="if ig hi ih b ii iy ik iz im ja io jb iq jc is it iu iv iw bi translated"><code class="du lt lu lv lh b"><a class="ae ix" href="https://docs.python.org/3/library/re.html#re.search" rel="noopener ugc nofollow" target="_blank">re.search()</a></code>匹配部分字符串，只抓取数字值。</li><li id="e937" class="if ig hi ih b ii iy ik iz im ja io jb iq jc is it iu iv iw bi translated"><code class="du lt lu lv lh b"><a class="ae ix" href="https://docs.python.org/3/howto/regex.html#grouping" rel="noopener ugc nofollow" target="_blank">group()</a></code>通过正则表达式返回匹配的字符串。</li></ul><p id="1dcd" class="pw-post-body-paragraph kp kq hi ih b ii ij ks kt ik il kv kw im lq ky kz io lr lb lc iq ls le lf is hb bi translated">返回数据:</p><pre class="kc kd ke kf fd lg lh li lj aw lk bi"><span id="905a" class="ll je hi lh b fi lm ln l lo lp"># data = {<br/>#     f"{stock_topic}_trends": [],<br/>#     f"{stock_topic}_discover_more": [],<br/>#     f"{stock_topic}_news": []<br/># }</span><span id="fd63" class="ll je hi lh b fi lw ln l lo lp"># extraction code...</span><span id="5167" class="ll je hi lh b fi lw ln l lo lp">return data</span></pre><p id="b74e" class="pw-post-body-paragraph kp kq hi ih b ii ij ks kt ik il kv kw im lq ky kz io lr lb lc iq ls le lf is hb bi translated">最后，我们需要为代码读者指定这是一个<a class="ae ix" href="https://www.youtube.com/watch?v=g_wlZ9IhbTs" rel="noopener ugc nofollow" target="_blank">可运行脚本</a>:</p><pre class="kc kd ke kf fd lg lh li lj aw lk bi"><span id="db9b" class="ll je hi lh b fi lm ln l lo lp">if __name__ == "__main__":<br/>    print(json.dumps(main(), indent=2, ensure_ascii=False))</span></pre><p id="d222" class="pw-post-body-paragraph kp kq hi ih b ii ij ks kt ik il kv kw im lq ky kz io lr lb lc iq ls le lf is hb bi translated">现在，您可以从命令行运行您的脚本:</p><pre class="kc kd ke kf fd lg lh li lj aw lk bi"><span id="06f7" class="ll je hi lh b fi lm ln l lo lp">$ python main.py -ma # most-active</span></pre><p id="8d84" class="pw-post-body-paragraph kp kq hi ih b ii ij ks kt ik il kv kw im lq ky kz io lr lb lc iq ls le lf is hb bi translated">您还可以访问help命令<code class="du lt lu lv lh b">-h</code>来查看可用的参数，如下所示:</p><pre class="kc kd ke kf fd lg lh li lj aw lk bi"><span id="3375" class="ll je hi lh b fi lm ln l lo lp">$ python main.py -h<br/>usage: Google Finance Markets Options [-h] [-i] [-ma] [-g] [-l]<br/>                                      [-cl] [-cc] [-c]</span><span id="fbe2" class="ll je hi lh b fi lw ln l lo lp">optional arguments:<br/>  -h, --help            show this help message and exit<br/>  -i, --indexes<br/>  -ma, --most-active<br/>  -g, --gainers<br/>  -l, --losers<br/>  -cl, --climate-leaders<br/>  -cc, --crypto<br/>  -c, --currency</span></pre><p id="de03" class="pw-post-body-paragraph kp kq hi ih b ii ij ks kt ik il kv kw im lq ky kz io lr lb lc iq ls le lf is hb bi translated">全输出:</p><pre class="kc kd ke kf fd lg lh li lj aw lk bi"><span id="a22e" class="ll je hi lh b fi lm ln l lo lp">{<br/>  "most_active_trends": [<br/>    {<br/>      "position": 1,<br/>      "title": "Advanced Micro Devices, Inc.",<br/>      "quote": "AMD",<br/>      "quote_link": "https://www.google.com/finance/AMD:NASDAQ",<br/>      "price_change": "+$3.04",<br/>      "percent_price_change": "+3.22%"<br/>    }, ... other results<br/>    {<br/>      "position": 50,<br/>      "title": "Freeport-McMoRan Inc",<br/>      "quote": "FCX",<br/>      "quote_link": "https://www.google.com/finance/FCX:NYSE",<br/>      "price_change": "-$1.15",<br/>      "percent_price_change": "-3.66%"<br/>    }<br/>  ],<br/>  "most_active_discover_more": [<br/>    {<br/>      "position": 1,<br/>      "quote": "Index",<br/>      "quote_link": "https://www.google.com/financeFCX:NYSE",<br/>      "title": "Dow Jones Industrial Average",<br/>      "price": "32,772.36",<br/>      "percent_price_change": "-0.22%"<br/>    }, ... other results<br/>    {<br/>      "position": 18,<br/>      "quote": "NFLX",<br/>      "quote_link": "https://www.google.com/financeFCX:NYSE",<br/>      "title": "Netflix Inc",<br/>      "price": "$226.14",<br/>      "percent_price_change": "+0.55%"<br/>    }<br/>  ],<br/>  "most_active_news": [<br/>    {<br/>      "position": 1,<br/>      "title": "Alibaba says will work to keep trading in U.S., Hong Kong after being added \nto SEC delisting risk list",<br/>      "source": "CNBC",<br/>      "date": "7 hours ago",<br/>      "image": "https://encrypted-tbn3.gstatic.com/images?q=tbn:ANd9GcRMBjVDpAgK8AJP6gxfd89Kb5rz7th_s3ntTLA_WYWnVWT3Q05aQJTWpMpjcOg"<br/>    }, ... other news results<br/>    {<br/>      "position": 6,<br/>      "title": "Intel CEO: 'This is a time for a bit of austerity'",<br/>      "source": "Yahoo Finance",<br/>      "date": "4 hours ago",<br/>      "image": "https://encrypted-tbn2.gstatic.com/images?q=tbn:ANd9GcTxkwNmmHmcXqkF3-pa2Bl0SsCzdIJyB0jPdutL0vw9pV4sRkgy8BKemYIkEeg"<br/>    }<br/>  ]<br/>}</span></pre><h1 id="f7ce" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">谷歌金融市场API</h1><p id="439c" class="pw-post-body-paragraph kp kq hi ih b ii kr ks kt ik ku kv kw im kx ky kz io la lb lc iq ld le lf is hb bi translated">在SerpApi，我们最近发布了第一个支持从Google Finance提取数据的Api。本节将向您展示如何使用这个API以及它与DIY解决方案的不同之处。</p><p id="e74a" class="pw-post-body-paragraph kp kq hi ih b ii ij ks kt ik il kv kw im lq ky kz io lr lb lc iq ls le lf is hb bi translated">API从<code class="du lt lu lv lh b">google.com/finance/markets/indexes</code>中提取一切。从<a class="ae ix" href="https://serpapi.com/playground?engine=google_finance_markets&amp;trend=indexes" rel="noopener ugc nofollow" target="_blank">互动游乐场快速浏览</a>:</p><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es ly"><img src="../Images/5595f44daef8e63b2a5cf829eb5924fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3PJZYcUWE--tI6WQ.gif"/></div></div></figure><p id="c9c7" class="pw-post-body-paragraph kp kq hi ih b ii ij ks kt ik il kv kw im lq ky kz io lr lb lc iq ls le lf is hb bi translated">这些差异旨在解决不断变化的CSS选择器或HTML其他部分的问题，因此不需要维护解析器。</p><p id="e1c9" class="pw-post-body-paragraph kp kq hi ih b ii ij ks kt ik il kv kw im lq ky kz io lr lb lc iq ls le lf is hb bi translated">除此之外，也没有必要弄清楚如何绕过块，即率IP限制，验证码，或其他类似的东西，要么绕过块或维护解析器。</p><p id="e0a3" class="pw-post-body-paragraph kp kq hi ih b ii ij ks kt ik il kv kw im lq ky kz io lr lb lc iq ls le lf is hb bi translated">在进入用法部分之前，下面是如何用PyPi安装它:</p><pre class="kc kd ke kf fd lg lh lz bn ma mb bi"><span id="334a" class="mc je hi lh b be md me l mf lp">$ pip install google-search-results</span></pre><p id="dd49" class="pw-post-body-paragraph kp kq hi ih b ii ij ks kt ik il kv kw im lq ky kz io lr lb lc iq ls le lf is hb bi translated">提取“美洲”股票的用法示例:</p><pre class="kc kd ke kf fd lg lh lz bn ma mb bi"><span id="ebd1" class="mc je hi lh b be md me l mf lp">from serpapi import GoogleSearch<br/>import json<br/><br/># search parameters<br/>params = {<br/>  "api_key": "&lt;your-serpapi-api-key&gt;", <br/>  "device": "desktop",                  # device used for the search. Could be mobile or tablet also<br/>  "engine": "google_finance_markets",   # serpapi parser engine<br/>  "trend": "indexes"                    # market trend category<br/>}<br/>search = GoogleSearch(params)           # where data extraction happens on the SerpApi backend    <br/>results = search.get_dict()             # JSON -&gt; Python dict<br/><br/>americas_stocks = []<br/><br/>for result in results['market_trends']:<br/>    if 'americas' in result['title'].lower():<br/>        americas_stocks.append(result['results']) # list of stocks<br/>print(json.dumps(americas_stock, indent=2))</span></pre><p id="9c52" class="pw-post-body-paragraph kp kq hi ih b ii ij ks kt ik il kv kw im lq ky kz io lr lb lc iq ls le lf is hb bi translated">JSON输出:</p><pre class="kc kd ke kf fd lg lh lz bn ma mb bi"><span id="77c9" class="mc je hi lh b be md me l mf lp">[<br/>  [<br/>    {<br/>      "stock": ".INX:INDEXSP",<br/>      "link": "https://www.google.com/finance/quote/.INX:INDEXSP",<br/>      "name": "S&amp;P 500",<br/>      "price": "4,080.11",<br/>      "extracted_price": 4080.11,<br/>      "price_movement": {<br/>        "percentage": 3.09,<br/>        "value": 122.48,<br/>        "movement": "Up"<br/>      }<br/>    },<br/>    {<br/>      "stock": ".DJI:INDEXDJX",<br/>      "link": "https://www.google.com/finance/quote/.DJI:INDEXDJX",<br/>      "name": "Dow Jones Industrial Average",<br/>      "price": "34,589.77",<br/>      "extracted_price": 34589.77,<br/>      "price_movement": {<br/>        "percentage": 2.18,<br/>        "value": 737.24,<br/>        "movement": "Up"<br/>      }<br/>    },<br/>    {<br/>      "stock": ".IXIC:INDEXNASDAQ",<br/>      "link": "https://www.google.com/finance/quote/.IXIC:INDEXNASDAQ",<br/>      "name": "Nasdaq Composite",<br/>      "price": "11,468.00",<br/>      "extracted_price": 11468.0,<br/>      "price_movement": {<br/>        "percentage": 4.41,<br/>        "value": 484.22,<br/>        "movement": "Up"<br/>      }<br/>    },<br/>    {<br/>      "stock": "RUT:INDEXRUSSELL",<br/>      "link": "https://www.google.com/finance/quote/RUT:INDEXRUSSELL",<br/>      "name": "Russell 2000 Index",<br/>      "price": "1,886.58",<br/>      "extracted_price": 1886.58,<br/>      "price_movement": {<br/>        "percentage": 2.72,<br/>        "value": 50.03,<br/>        "movement": "Up"<br/>      }<br/>    },<br/>    {<br/>      "stock": "OSPTX:INDEXTSI",<br/>      "link": "https://www.google.com/finance/quote/OSPTX:INDEXTSI",<br/>      "name": "S&amp;P/TSX Composite Index",<br/>      "price": "20,453.26",<br/>      "extracted_price": 20453.26,<br/>      "price_movement": {<br/>        "percentage": 0.87,<br/>        "value": 175.85,<br/>        "movement": "Up"<br/>      }<br/>    },<br/>    {<br/>      "stock": "IBOV:INDEXBVMF",<br/>      "link": "https://www.google.com/finance/quote/IBOV:INDEXBVMF",<br/>      "name": "IBOVESPA",<br/>      "price": "112,486.01",<br/>      "extracted_price": 112486.01,<br/>      "price_movement": {<br/>        "percentage": 1.42,<br/>        "value": 1576.4,<br/>        "movement": "Up"<br/>      }<br/>    }<br/>  ]<br/>]</span></pre><h1 id="7781" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">链接</h1><ul class=""><li id="71ff" class="if ig hi ih b ii kr ik ku im mg io mh iq mi is it iu iv iw bi translated"><a class="ae ix" href="https://replit.com/@DimitryZub1/Scrape-Google-Finance-Markets-in-Python#main.py" rel="noopener ugc nofollow" target="_blank">在线IDE中的代码</a></li><li id="4fcf" class="if ig hi ih b ii iy ik iz im ja io jb iq jc is it iu iv iw bi translated"><a class="ae ix" href="https://github.com/dimitryzub/google-finance-py" rel="noopener ugc nofollow" target="_blank"> GitHub资源库</a></li><li id="f655" class="if ig hi ih b ii iy ik iz im ja io jb iq jc is it iu iv iw bi translated"><a class="ae ix" href="https://serpapi.com/google-finance-markets" rel="noopener ugc nofollow" target="_blank">谷歌金融市场应用编程接口</a></li></ul><p id="f884" class="pw-post-body-paragraph kp kq hi ih b ii ij ks kt ik il kv kw im lq ky kz io lr lb lc iq ls le lf is hb bi translated">加入我们的推特<a class="ae ix" href="https://twitter.com/serp_api" rel="noopener ugc nofollow" target="_blank"/>|<a class="ae ix" href="https://www.youtube.com/channel/UCUgIHlYBOD3yA3yDIRhg_mg" rel="noopener ugc nofollow" target="_blank">YouTube</a></p><p id="7555" class="pw-post-body-paragraph kp kq hi ih b ii ij ks kt ik il kv kw im lq ky kz io lr lb lc iq ls le lf is hb bi translated">添加一个<a class="ae ix" href="https://github.com/serpapi/public-roadmap/issues" rel="noopener ugc nofollow" target="_blank">特征请求</a>💫还是一个<a class="ae ix" href="https://github.com/serpapi/public-roadmap/issues" rel="noopener ugc nofollow" target="_blank"> Bug </a>🐞</p><p id="77f4" class="pw-post-body-paragraph kp kq hi ih b ii ij ks kt ik il kv kw im lq ky kz io lr lb lc iq ls le lf is hb bi translated">最初发布于ser papi:<a class="ae ix" href="https://serpapi.com/blog/scrape-google-finance-markets-in-python/#full-code" rel="noopener ugc nofollow" target="_blank">https://ser papi . com/blog/scrape-Google-finance-markets-in-python/</a></p></div></div>    
</body>
</html>