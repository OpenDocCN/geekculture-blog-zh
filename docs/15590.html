<html>
<head>
<title>How To Perform The pg_repack?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何执行pg_repack？</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/how-to-perform-the-pg-repack-8934970ca67d?source=collection_archive---------14-----------------------#2022-11-09">https://medium.com/geekculture/how-to-perform-the-pg-repack-8934970ca67d?source=collection_archive---------14-----------------------#2022-11-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="548a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这里，我们将看到执行pg_rpack的一步一步</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/a4e7bd39ff9855bb0973f1f20190c1a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*45c7bPMXy7CnT5kHNRPljw.png"/></div></div></figure><p id="0788" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">S-1:</p><p id="df19" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们连接服务器，为此活动创建示例数据库</p><pre class="je jf jg jh fd jp jq jr js aw jt bi"><span id="a1b8" class="ju jv hi jq b fi jw jx l jy jz">[ec2-user@ip-172-31-34-18 ~]$ psql -h database-1.cdb6vnednjo5.ap-south-1.rds.amazonaws.com -U postgres -d postgres<br/>Password for user postgres:<br/>psql (12.12, server 12.7)<br/>SSL connection (protocol: TLSv1.2, cipher: ECDHE-RSA-AES256-GCM-SHA384, bits: 256, compression: off)<br/>Type "help" for help.</span><span id="9b0f" class="ju jv hi jq b fi ka jx l jy jz">postgres=&gt; create database mynotesoracledba;<br/>CREATE DATABASE<br/></span></pre><p id="63c4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">S-2:</p><p id="08c2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在数据库中创建扩展，我们将在这里执行pg_repack。</p><pre class="je jf jg jh fd jp jq jr js aw jt bi"><span id="54d3" class="ju jv hi jq b fi jw jx l jy jz">create extension pg_repack;</span></pre><p id="9c2c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">S-3:</p><p id="6662" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">验证安装的扩展</p><pre class="je jf jg jh fd jp jq jr js aw jt bi"><span id="1539" class="ju jv hi jq b fi jw jx l jy jz">mynotesoracledba=&gt; \dx<br/>                                  List of installed extensions<br/>   Name    | Version |   Schema   |                         Description<br/>-----------+---------+------------+--------------------------------------------------------------<br/> pg_repack | 1.4.5   | public     | Reorganize tables in PostgreSQL databases with minimal locks<br/> plpgsql   | 1.0     | pg_catalog | PL/pgSQL procedural language</span></pre><p id="e6ca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">S-4:</p><p id="e4b6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建示例表对象</p><pre class="je jf jg jh fd jp jq jr js aw jt bi"><span id="2c99" class="ju jv hi jq b fi jw jx l jy jz">CREATE TABLE burritos (<br/>id SERIAL UNIQUE NOT NULL primary key,<br/>title VARCHAR(10) NOT NULL,<br/>toppings TEXT NOT NULL,<br/>thoughts TEXT,<br/>code VARCHAR(4) NOT NULL,<br/>UNIQUE (title, toppings)<br/>);</span></pre><p id="4de8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">禁用此表的自动真空设置</p><pre class="je jf jg jh fd jp jq jr js aw jt bi"><span id="1b2a" class="ju jv hi jq b fi jw jx l jy jz">ALTER TABLE burritos SET (autovacuum_enabled = false, toast.autovacuum_enabled = false);</span></pre><p id="8a54" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">S-5:</p><p id="a71f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们对表执行更新</p><pre class="je jf jg jh fd jp jq jr js aw jt bi"><span id="440c" class="ju jv hi jq b fi jw jx l jy jz">UPDATE burritos SET thoughts = md5(random()::text) where id &lt; 10000;<br/>UPDATE burritos SET thoughts = md5(random()::text) WHERE id between 10000 and 20000;<br/>UPDATE burritos SET thoughts = md5(random()::text) WHERE id between 800000 and 900000;<br/>UPDATE burritos SET toppings = md5(random()::text) WHERE id between 600000 and 700000;</span></pre><p id="7b1e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">S-6:</p><p id="7c58" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过<strong class="ih hj"> pg_stat_user_tables </strong>验证死元组百分比</p><pre class="je jf jg jh fd jp jq jr js aw jt bi"><span id="ae3c" class="ju jv hi jq b fi jw jx l jy jz">SELECT relname, n_dead_tup, n_live_tup, 100*n_dead_tup/n_live_tup AS percent, left(last_vacuum::text,16) AS last_vacuum, left(last_autovacuum::text,16) AS last_autovacuum, last_analyze, left(last_autoanalyze::text,16) AS last_autoanalyze, now() FROM pg_stat_user_tables ;</span></pre><p id="3a81" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意:这里的百分比列显示死元组百分比的结果</p><p id="da05" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">S-7:</p><p id="af1b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">验证pg_repack安装的版本</p><pre class="je jf jg jh fd jp jq jr js aw jt bi"><span id="350a" class="ju jv hi jq b fi jw jx l jy jz">[ec2-user@ip-172-31-34-18 ~]$ cd pg_repack-1.4.5<br/>[ec2-user@ip-172-31-34-18 pg_repack-1.4.5]$ cd bin<br/>[ec2-user@ip-172-31-34-18 bin]$ ./pg_repack --version<br/>pg_repack 1.4.5</span></pre><p id="8336" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">S-7:</p><p id="237b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">pg_repack有很多选项，可以随意查看，但我要开始排练了</p><pre class="je jf jg jh fd jp jq jr js aw jt bi"><span id="d0e8" class="ju jv hi jq b fi jw jx l jy jz">./pg_repack -h database-1.cdb6vnednjo5.ap-south-1.rds.amazonaws.com -U postgres -d mynotesoracledba --dry-run --table burritos<br/>INFO: Dry run enabled, not executing repack<br/>Password:<br/>ERROR: pg_repack failed with error: You must be a superuser to use pg_repack</span></pre><p id="a7bb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在上面的例子中，我们得到的错误是由于超级用户权限不足，为了避免这个错误，我们必须使用-k选项</p><pre class="je jf jg jh fd jp jq jr js aw jt bi"><span id="9927" class="ju jv hi jq b fi jw jx l jy jz">[ec2-user@ip-172-31-34-18 bin]$ <strong class="jq hj">./pg_repack -h database-1.cdb6vnednjo5.ap-south-1.rds.amazonaws.com -U postgres -d mynotesoracledba --dry-run --table burritos -k</strong><br/>INFO: Dry run enabled, not executing repack<br/>Password:<br/>INFO: repacking table "public.burritos"</span></pre><p id="dabc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果排练没有出现任何错误，那么我们就可以继续表演</p><p id="cd24" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">S-8:</p><p id="fb42" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以开始pg_repack了</p><pre class="je jf jg jh fd jp jq jr js aw jt bi"><span id="cb8a" class="ju jv hi jq b fi jw jx l jy jz">[ec2-user@ip-172-31-34-18 bin]$<strong class="jq hj"> ./pg_repack -h database-1.cdb6vnednjo5.ap-south-1.rds.amazonaws.com -U postgres -d mynotesoracledba  --table burritos -k</strong><br/>Password:<br/>INFO: repacking table "public.burritos"</span></pre><p id="6959" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">S-9:</p><p id="757c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要监控pg_repack会话，请使用<strong class="ih hj"> pg_stat_activity </strong>视图或Performance Insights控制台。</p><pre class="je jf jg jh fd jp jq jr js aw jt bi"><span id="1e2f" class="ju jv hi jq b fi jw jx l jy jz"><br/> <br/>select * from pg_stat_activity where application_name='pg_repack'</span></pre></div></div>    
</body>
</html>