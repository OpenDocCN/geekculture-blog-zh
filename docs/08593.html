<html>
<head>
<title>Creating Kubernetes Controllers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">创建Kubernetes控制器</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/kubernetes-custom-controller-6bb29a859dc?source=collection_archive---------13-----------------------#2021-11-07">https://medium.com/geekculture/kubernetes-custom-controller-6bb29a859dc?source=collection_archive---------13-----------------------#2021-11-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/a5057f44ac69a4921055dbc9863b3f06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lP2eWmqe9_hPiqM7UUln-Q.jpeg"/></div></div></figure><p id="4e2d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Kubernetes被广泛用于构建云原生应用，并在云环境中工作。由于kubernetes是开源的，健壮工具背后用于编排正在运行的微服务容器的架构可以在您自己的项目中扩展。</p><p id="22a2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用云或构建自己的云的行业使用kubernetes。我们可以通过查看所有提供kubernetes的云提供商服务来了解kubernetes的重要性，这些服务旨在创建供客户使用的多集群环境。我不会深入讨论什么是kubernetes以及它是如何工作的，请阅读kubernetes在<a class="ae jo" href="http://kubernetes.io" rel="noopener ugc nofollow" target="_blank"> kubernetes.io </a>上的文档以了解更多关于它的使用。</p><div class="jp jq ez fb jr js"><a href="https://kubernetes.io/docs/home/" rel="noopener  ugc nofollow" target="_blank"><div class="jt ab dw"><div class="ju ab jv cl cj jw"><h2 class="bd hj fi z dy jx ea eb jy ed ef hh bi translated">Kubernetes文档</h2><div class="jz l"><h3 class="bd b fi z dy jx ea eb jy ed ef dx translated">2021 Kubernetes作者|根据4.0分发的文档版权所有2021 Linux基金会。所有…</h3></div><div class="ka l"><p class="bd b fp z dy jx ea eb jy ed ef dx translated">kubernetes.io</p></div></div><div class="kb l"><div class="kc l kd ke kf kb kg io js"/></div></div></a></div></div><div class="ab cl kh ki gp kj" role="separator"><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km"/></div><div class="hb hc hd he hf"><p id="b324" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">kubernetes提供了一种方法来构建您自己的自定义Kubernetes资源，称为Kubernetes自定义资源，以便根据您的需求扩展其功能。举例来说，您可以使用kubernetes模式创建自己的自定义对象。</p><p id="d2ae" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Kubernetes作为云开发的一部分已经有很长时间了，并且有开源库可以将其与我们的项目集成。Kubernetes <code class="du ko kp kq kr b">operators</code>提供了管理您的Kubernetes资源的最佳方式，并且易于实施。引用自<a class="ae jo" href="http://kubernetes.io" rel="noopener ugc nofollow" target="_blank"> kubernetes.io </a>博客:-</p><blockquote class="ks kt ku"><p id="2e2a" class="iq ir kv is b it iu iv iw ix iy iz ja kw jc jd je kx jg jh ji ky jk jl jm jn hb bi translated"><a class="ae jo" href="https://kubernetes.io/docs/concepts/extend-kubernetes/operator/" rel="noopener ugc nofollow" target="_blank">操作符</a>被证明是在Kubernetes中运行有状态分布式应用程序的优秀解决方案。像<a class="ae jo" href="https://sdk.operatorframework.io/" rel="noopener ugc nofollow" target="_blank"> Operator SDK </a>这样的开源工具提供了构建可靠且可维护的操作符的方法，使得扩展Kubernetes和实现定制调度更加容易</p></blockquote><p id="6d87" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">控制器是用来管理kubernetes资源的控制回路。</p><p id="fa65" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="kv">在Kubernetes中，控制器是控制循环，它监视您的</em> <a class="ae jo" href="https://kubernetes.io/docs/reference/glossary/?all=true#term-cluster" rel="noopener ugc nofollow" target="_blank"> <em class="kv">集群</em> </a> <em class="kv">的状态，然后在需要的地方做出或请求改变。每个控制器都试图将当前的群集状态移至更接近所需的状态。</em></p></div><div class="ab cl kh ki gp kj" role="separator"><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km"/></div><div class="hb hc hd he hf"><p id="2127" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们首先创建一个控制器来监视kubernetes pod中的更新，然后向它添加一个标签。为了编写控制器，我们将使用operator sdk，它将创建一个引导代码。如果您在本地环境中安装了minikube或任何其他本地工具(如k3d ),我们可以使用以下工具开始创建pod</p><pre class="kz la lb lc fd ld kr le lf aw lg bi"><span id="a004" class="lh li hi kr b fi lj lk l ll lm">$ kubectl run --image=nginx my-nginx</span></pre><p id="ea64" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">安装operator-sdk以创建引导控制器:-</p><div class="jp jq ez fb jr js"><a href="https://sdk.operatorframework.io/docs/installation/" rel="noopener  ugc nofollow" target="_blank"><div class="jt ab dw"><div class="ju ab jv cl cj jw"><h2 class="bd hj fi z dy jx ea eb jy ed ef hh bi translated">装置</h2><div class="jz l"><h3 class="bd b fi z dy jx ea eb jy ed ef dx translated">安装Operator SDK CLI如果您使用的是Homebrew，可以使用以下命令安装SDK CLI工具…</h3></div><div class="ka l"><p class="bd b fp z dy jx ea eb jy ed ef dx translated">sdk.operatorframework.io</p></div></div></div></a></div><p id="bfce" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">安装完成后，我们可以验证operator-sdk的版本，以确保它与kubernetes的更新版本相匹配。</p><pre class="kz la lb lc fd ld kr le lf aw lg bi"><span id="a5b1" class="lh li hi kr b fi lj lk l ll lm">$ operator-sdk version</span></pre><p id="7b4e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下一步将是创建一个目录，初始化操作员，该操作员将处理pod资源的控制器，最后我们创建一个设置为pod的控制器。</p><pre class="kz la lb lc fd ld kr le lf aw lg bi"><span id="069a" class="lh li hi kr b fi lj lk l ll lm">$ mkdir custom-controller &amp;&amp; cd custom-controller<br/>$ operator-sdk init --domain=domain.com --repo=github.com/&lt;user&gt;/custom-controller<br/>$ operator-sdk create api --group=core --version=v1 --kind=Pod --controller=true --resource=false</span></pre><p id="f9e7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您在尝试初始化操作符时遇到go版本错误，请跳过初始化操作符命令中的go版本检查，但它仍然适用于go和kubernetes的更新版本。</p><pre class="kz la lb lc fd ld kr le lf aw lg bi"><span id="cf68" class="lh li hi kr b fi lj lk l ll lm">$ operator-sdk init --domain=domain.com --repo=github.com/&lt;user&gt;/custom-controller <!-- -->--skip-go-version-check</span></pre><p id="ba7e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这将在自定义控制器回购中生成一个<code class="du ko kp kq kr b">controller/pod_controller.go</code>。在该文件中，我们需要更新我们的逻辑来观察注释，并使用控制器向pod添加一个标签。</p><pre class="kz la lb lc fd ld kr le lf aw lg bi"><span id="7d73" class="lh li hi kr b fi lj lk l ll lm"><strong class="kr hj">func</strong> (r *PodReconciler) Reconcile(ctx context.Context, req ctrl.Request) (ctrl.Result, <strong class="kr hj">error</strong>) {<br/>    _ = r.Log.WithValues("pod", req.NamespacedName)<br/><br/>    <em class="kv">// your logic here<br/></em><br/>    <strong class="kr hj">return</strong> ctrl.Result{}, <strong class="kr hj">nil</strong><br/>}</span></pre><p id="e4ce" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对pod的任何操作都将调用Reconcile方法，pod的名称和命名空间可以从<code class="du ko kp kq kr b">ctrl.Request</code>结构中提取。</p></div><div class="ab cl kh ki gp kj" role="separator"><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km"/></div><div class="hb hc hd he hf"><p id="7408" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">完成代码以观察pod内的注释并向其添加标签:-</p><figure class="kz la lb lc fd ij"><div class="bz dy l di"><div class="ln lo l"/></div></figure><p id="01c0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在运行本地kubernetes集群设置，并使用<code class="du ko kp kq kr b">make run</code>命令从终端运行代码，确保您已经安装了minikube来在本地环境中运行集群。</p><pre class="kz la lb lc fd ld kr le lf aw lg bi"><span id="7482" class="lh li hi kr b fi lj lk l ll lm">2021-10-31T13:30:04.771+0530 INFO controller-runtime.manager.controller.pod Starting EventSource {"reconciler group": "", "reconciler kind": "Pod", "source": "kind source: /, Kind="}<br/>2021-10-31T13:30:04.771+0530 INFO controller-runtime.manager.controller.pod Starting Controller {"reconciler group": "", "reconciler kind": "Pod"}<br/>2021-10-31T13:30:04.872+0530 INFO controller-runtime.manager.controller.pod Starting workers {"reconciler group": "", "reconciler kind": "Pod", "worker count": 1}</span></pre><p id="bc55" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在另一个终端中用image nginx创建一个pod，并添加注释，以查看在运行go server的另一个终端上使用<code class="du ko kp kq kr b">make run</code> :-</p><pre class="kz la lb lc fd ld kr le lf aw lg bi"><span id="7068" class="lh li hi kr b fi lj lk l ll lm">$ kubectl run --image=nginx my-nginx<br/>NAME       READY   STATUS    RESTARTS   AGE   LABELS<br/>my-nginx   1/1     Running   0          18s   run=my-nginx</span></pre><p id="e1ca" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">pod运行后，将注释添加到正在运行的pod，这将触发一个事件，导致添加pod的名称作为标签，如上面的<code class="du ko kp kq kr b">pod_controller.go</code>代码中所定义。</p><pre class="kz la lb lc fd ld kr le lf aw lg bi"><span id="1f1e" class="lh li hi kr b fi lj lk l ll lm">$ kubectl annotate pod my-nginx custom/add-pod-name-label=true<br/>pod/my-nginx annotated</span></pre><p id="8f54" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">go控制器运行将显示触发的事件<code class="du ko kp kq kr b">adding label</code>，我们可以使用<code class="du ko kp kq kr b">kubectl</code>显示标签命令查看添加到pod的标签:-</p><pre class="kz la lb lc fd ld kr le lf aw lg bi"><span id="6d8e" class="lh li hi kr b fi lj lk l ll lm">$ kubectl get pods my-nginx --show-labels<br/>NAME       READY   STATUS    RESTARTS   AGE   LABELS<br/>my-nginx   1/1     Running   1          7d    custom/pod-name=my-nginx,run=my-nginx</span></pre><p id="e16c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">总结文章，<code class="du ko kp kq kr b">operator-sdk</code>是真正方便的sdk来创建kubernetes控制器。而我们只需要担心更新控制器的<code class="du ko kp kq kr b">Reconcile</code>方法内部的逻辑。完整代码可在<a class="ae jo" href="https://github.com/Himanshuxone/label-operator" rel="noopener ugc nofollow" target="_blank">https://github.com/Himanshuxone/label-operator</a>获得。</p><p id="4e20" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">关注<a class="ae jo" href="https://golang-geek.medium.com/" rel="noopener">https://golang-geek.medium.com/</a>获取更多关于云计算和其他技术的文章。如有任何问题，请在评论中提及，或给<em class="kv">himanshusdec8@gmail.com</em>写电子邮件，获取关于云的<em class="kv"> </em>信息。</p><p id="5c82" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">联系人:<em class="kv">himanshusdec8@gmail.com</em></p></div></div>    
</body>
</html>