<html>
<head>
<title>Setting up a VPN in AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在AWS中设置VPN</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/setting-up-a-vpn-in-aws-e3dc4295642a?source=collection_archive---------8-----------------------#2022-03-10">https://medium.com/geekculture/setting-up-a-vpn-in-aws-e3dc4295642a?source=collection_archive---------8-----------------------#2022-03-10</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/b12894a01e3e09d4c4a3227f2408d72d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PNTskW7MPuL9c8B8MOVN1A.jpeg"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">So easy a cat could do it!</figcaption></figure><div class=""/><p id="2428" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我需要围绕使用商用蜂窝(4G/5G)连接到VPN以访问受保护的服务并通过VPN实现客户端到客户端的通信来执行一些网络实验。VPN还必须支持机器对机器的通信—客户端必须能够自动进行身份验证并连接到VPN，而无需用户干预。我的目标是使用数字证书进行认证(用于相互认证)。这些客户机将运行多种操作系统，但Red Hat Linux是主要的操作系统。</p><h2 id="3b59" class="js jt hx bd ju jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km bi translated">这对谁还有帮助？</h2><p id="50f8" class="pw-post-body-paragraph iu iv hx iw b ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn kr jp jq jr hb bi translated">这种类型的通信网络还有其他使用案例。任何分布式系统(例如，IOT群，远程服务器的集合),没有公共网络可以运行，但是有到互联网的回程，并且可以运行VPN客户端。这是一种非常灵活的混合设置，因为VPN客户端可以设置为自动连接，使它们能够在失去连接、断电等情况后重新加入网络。</p><h1 id="8658" class="ks jt hx bd ju kt ku kv jy kw kx ky kc kz la lb kf lc ld le ki lf lg lh kl li bi translated">初步研究</h1><p id="a368" class="pw-post-body-paragraph iu iv hx iw b ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn kr jp jq jr hb bi translated">在做初步研究时，我发现OpenVPN(<a class="ae lj" href="https://openvpn.net" rel="noopener ugc nofollow" target="_blank">https://openvpn.net</a>)具有我需要的客户端到客户端的通信特性。客户端也可用于许多操作系统(【https://openvpn.net/vpn-client/】T2)。此外，OpenVPN客户端与Amazon Web Services VPN协同工作。我已经建立了一个AWS免费层帐户来试验这些功能，并验证我的计划是否可行。</p><figure class="ll lm ln lo fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lk"><img src="../Images/dd10d2ace21da4d2faf1bef37d3b4b60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0taqI5tOq5jcSe7DZGz-Tw.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">Target Network Setup</figcaption></figure><p id="0bf5" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">为了满足我的要求，我首先需要一个AWS虚拟私有云(VPC)。我使用了新的创建VPC向导，建立VPC非常简单，因为每个选项都提供了很好的默认值。这提供了公共和私有子网、一个互联网网关以及一个通往S3存储的安全网关。公共子网使用路由表(自动创建)连接到互联网网关。<em class="lp">我后来发现AWS自动为我创建了一个默认的VPC，所以我的是多余的。</em></p><p id="bf3d" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">下一步是创建客户端VPN端点，它将成为客户端的通信中心和我的VPC的入口。</p><p id="e18d" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我需要用于相互认证的数字证书。这些可以自签名，步骤如下:</p><p id="1238" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><a class="ae lj" href="https://docs.aws.amazon.com/vpn/latest/clientvpn-admin/client-authentication.html#mutual" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/VPN/latest/client VPN-admin/client-authentic ation . html # mutual</a></p><p id="f485" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">要将证书放入AWS凭证管理器(ACM ),我建议使用ACM控制台。您可以使用AWS CLI客户端，但这需要更多的工作，除非您已经设置好了。</p><p id="45e9" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><a class="ae lj" href="https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/CLI/latest/user guide/getting-started-install . html</a></p><blockquote class="lq lr ls"><p id="409c" class="iu iv lp iw b ix iy iz ja jb jc jd je lt jg jh ji lu jk jl jm lv jo jp jq jr hb bi translated">光是VPN设置就花了4个多小时才能够连接到客户端。希望这些笔记能帮助你更快地完成。最后一部分，转移话题，涵盖了我的错误，这样你就可以避免它们。</p></blockquote><h1 id="d706" class="ks jt hx bd ju kt ku kv jy kw kx ky kc kz la lb kf lc ld le ki lf lg lh kl li bi translated">自签名证书</h1><p id="3d0e" class="pw-post-body-paragraph iu iv hx iw b ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn kr jp jq jr hb bi translated">生成您自己的CA、服务器证书和密钥，以及一个或多个客户端证书和密钥非常简单，这里有详细的说明:</p><p id="f708" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><a class="ae lj" href="https://docs.aws.amazon.com/vpn/latest/clientvpn-admin/client-authentication.html#mutual" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/VPN/latest/client VPN-admin/client-authentic ation . html # mutual</a></p><blockquote class="lq lr ls"><p id="58ca" class="iu iv lp iw b ix iy iz ja jb jc jd je lt jg jh ji lu jk jl jm lv jo jp jq jr hb bi translated">关于安全的一句话。用于生成所有证书的命令指定nopass，这意味着不加密私钥(默认为加密)。easyrsa命令将提示您输入PEM通行短语。在某些情况下，这可能是必需的(无人值守登录，GUI客户端不知道如何要求您输入密码，等等。)关注自己的需求就好。</p></blockquote><p id="fa49" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">接下来，使用https://console.aws.amazon.com/acm<a class="ae lj" href="https://console.aws.amazon.com/acm" rel="noopener ugc nofollow" target="_blank">的ACM控制台上传证书</a></p><p id="fd54" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">需要注意的一点是，当您剪切和粘贴PEM编码的证书文件时，您需要包含证书数据的头(— -开始证书—-)和尾(—-结束证书— —)。</p><p id="02fd" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我导入了服务器证书和密钥，以及ca.crt文件和我的第一个客户机证书和密钥。我回去创建了一个新的客户端证书，发现指令中有一个小问题。在此之前，请务必将您的客户端证书和私钥复制到一个新文件(重命名)或位置！！</p><p id="c393" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">他们说要创建新的客户端证书，只需重新运行命令:</p><pre class="ll lm ln lo fd lw lx ly lz aw ma bi"><span id="d170" class="js jt hx lx b fi mb mc l md me">./easyrsa build-client-full client1.domain.tld nopass</span></pre><p id="476a" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这会导致以下错误(文件冲突):</p><blockquote class="lq lr ls"><p id="56cf" class="iu iv lp iw b ix iy iz ja jb jc jd je lt jg jh ji lu jk jl jm lv jo jp jq jr hb bi translated">请求文件已经存在。中止构建以避免覆盖此文件。如果您希望继续，请使用不同的名称或删除该文件。匹配文件位于:/Users/eizdepski/github/easy-RSA/easy RSA 3/PKI/reqs/client 1 . domain . TLD . req</p></blockquote><p id="d9b1" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">您需要做的是为新的客户端证书更改输出文件名。我简单地创建了我的客户端2，如下所示:</p><pre class="ll lm ln lo fd lw lx ly lz aw ma bi"><span id="93b3" class="js jt hx lx b fi mb mc l md me">./easyrsa build-client-full client2.domain.tld nopass</span></pre><p id="7aab" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我将新的证书对复制到包含所有证书的目录中，并使用ACM导入新的证书对。ACM还让我为证书添加一个键/值对，所以我给它们起了名字，表明它们的用途。</p><h1 id="ce3f" class="ks jt hx bd ju kt ku kv jy kw kx ky kc kz la lb kf lc ld le ki lf lg lh kl li bi translated">创建客户端VPN端点</h1><p id="850e" class="pw-post-body-paragraph iu iv hx iw b ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn kr jp jq jr hb bi translated">既然满足了先决条件，就该创建客户端VPN端点了。这一次，当我查看服务器证书ARN下拉列表时，我看到了我导入的新证书！</p><figure class="ll lm ln lo fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mf"><img src="../Images/ba812fe86eb9b2f2757f137436f281aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ttLKxOjhc1Gg7UfyvqRhFA.png"/></div></div></figure><p id="1cfc" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我还想确保只允许我在VPN服务器中颁发和提供的证书。不确定这是不是一个功能，但会做一些测试。</p><h2 id="07df" class="js jt hx bd ju jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km bi translated">日志和云观察</h2><p id="d421" class="pw-post-body-paragraph iu iv hx iw b ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn kr jp jq jr hb bi translated">因为我这样做是为了测试，所以我打开了CloudWatch日志。这要求我首先创建一个CloudWatch日志组名。我进入CloudWatch服务页面(<a class="ae lj" href="https://console.aws.amazon.com/cloudwatch" rel="noopener ugc nofollow" target="_blank">https://console.aws.amazon.com/cloudwatch</a>)，从页面菜单中选择Logs: Log Group，然后点击“创建日志组”按钮。从测试开始，我将日志保留时间设置为30天。您还应该创建一个日志流。刷新客户端VPN页面上的下拉菜单显示了我刚刚创建的组和日志流，因此我选择了它们。</p><figure class="ll lm ln lo fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mg"><img src="../Images/e762d0a11814a27ccefe63fe3d973899.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ohomgKJpMy9NbdaHrdAc7A.png"/></div></div></figure><p id="6cae" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">下面是一个成功的VPN客户端连接的cloudwatch日志示例。</p><pre class="ll lm ln lo fd lw lx ly lz aw ma bi"><span id="bd8d" class="js jt hx lx b fi mb mc l md me">{<br/>    "connection-log-type": "connection-attempt",<br/>    "connection-attempt-status": "successful",<br/>    "connection-attempt-failure-reason": "NA",<br/>    "connection-id": "cvpn-connection-blah",<br/>    "client-vpn-endpoint-id": "cvpn-endpoint-blah",<br/>    "transport-protocol": "tcp",<br/>    "connection-start-time": "2022-03-10 19:10:05",<br/>    "connection-last-update-time": "2022-03-10 19:10:05",<br/>    "client-ip": "10.0.0.131",<br/>    "common-name": "client1.domain.tld",<br/>    "device-type": "mac",<br/>    "device-ip": "72.83.89.146",<br/>    "port": "60521",<br/>    "ingress-bytes": "0",<br/>    "egress-bytes": "0",<br/>    "ingress-packets": "0",<br/>    "egress-packets": "0",<br/>    "connection-end-time": "NA",<br/>    "connection-duration-seconds": "0"<br/>}</span></pre><h2 id="183d" class="js jt hx bd ju jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km bi translated">可选(但很重要)</h2><p id="b70e" class="pw-post-body-paragraph iu iv hx iw b ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn kr jp jq jr hb bi translated">有一些重要的可选设置。我将TLS传输协议切换到TCP(我正在使用蜂窝连接，所以我想要可靠性)。我还打开了分割隧道，这样我的所有流量就不会通过VPN，并启用了自助服务门户，以便轻松检索客户端和VPN配置文件(结果是，当选择相互身份验证时，门户不工作)。</p><h2 id="cdbe" class="js jt hx bd ju jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km bi translated">将VPN关联到VPC</h2><p id="7faa" class="pw-post-body-paragraph iu iv hx iw b ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn kr jp jq jr hb bi translated">VPC的身份证呢？我做了一个VPC，但是当我检查我的控制台时，我发现我有两个。一个被列为默认。另一个是我做并命名的。这有点奇怪。我选择了默认的VPC。</p><figure class="ll lm ln lo fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mh"><img src="../Images/a9307c388a3b1fa53d84eb399ebe86d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3BfUCP1KUsoETIJFDzS6PQ.png"/></div></div></figure><p id="ad2f" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我做了更多的阅读，发现AWS为你创建了一个默认的VPC，所以我删除了我创建的那个，因为它没有用。它也有一个重叠的CIDR范围，阻止协会的工作。</p><p id="1e08" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">客户端VPN控制台显示状态为“待定-关联”。在控制台中，我选择了关联选项卡(在底部),关联过程开始了。这个过程大约需要10分钟才能完成。</p><figure class="ll lm ln lo fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mi"><img src="../Images/efbd4e7672f8a8c1c80b6966cea7c3f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y_4G9_3YdUpoxDteuGexMw.png"/></div></div></figure><h1 id="42f9" class="ks jt hx bd ju kt ku kv jy kw kx ky kc kz la lb kf lc ld le ki lf lg lh kl li bi translated">连接到VPN</h1><p id="f0e5" class="pw-post-body-paragraph iu iv hx iw b ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn kr jp jq jr hb bi translated">VPC仪表板现在有了一个新的按钮——下载客户端配置。这将为您提供客户端所需的OpenVPN配置文件。它包括VPN端点的DNS名称和我创建的CA证书。但是<strong class="iw hy">-<em class="lp">是不完整的，没有任何关于客户端证书的内容。</em>T5】</strong></p><p id="ba86" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">从客户端VPN控制台页面，我重新下载了我的opvn配置文件(并删除了其他文件)。我还尝试了VPN端点的DNS名称(ping ),它还没有激活。[顺便说一下，ping被VPN服务器忽略，但是这个命令会显示DNS名称是否解析为IP地址，所以仍然有用。]</p><p id="8714" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在调查这些问题时，我发现了一个示例ovpn配置文件，它解释了在哪里放置我的客户端证书和密钥数据。确保包含数据的页眉和页脚。</p><pre class="ll lm ln lo fd lw lx ly lz aw ma bi"><span id="865b" class="js jt hx lx b fi mb mc l md me">&lt;ca&gt;<br/><em class="lp">Contents of CA<br/></em>&lt;/ca&gt;<br/>&lt;cert&gt;<br/><em class="lp">Contents of client certificate (.crt) file<br/></em>&lt;/cert&gt;<br/>&lt;key&gt;<br/><em class="lp">Contents of private key (.key) file<br/></em>&lt;/key&gt;</span></pre><p id="a737" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我添加了用于客户端身份验证的证书和密钥，并尝试连接。它失败了，并说我的VPN端点的DNS名称没有解析。这可能需要几个小时来传播，所以我明天会尝试。</p><p id="06e9" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">第二天我试了一下我的OpenVPN客户端，仍然无法连接。我认为这花了太长时间，不仅仅是一个DNS名称传播问题。我在这里发现了一个有趣的额外说明，它讲述了在出现DNS错误的情况下如何更改OpenVPN配置文件:</p><div class="hh hi ez fb hj mj"><a href="https://docs.aws.amazon.com/vpn/latest/clientvpn-admin/troubleshooting.html#resolve-host-name" rel="noopener  ugc nofollow" target="_blank"><div class="mk ab dw"><div class="ml ab mm cl cj mn"><h2 class="bd hy fi z dy mo ea eb mp ed ef hw bi translated">客户端VPN故障排除</h2><div class="mq l"><h3 class="bd b fi z dy mo ea eb mp ed ef dx translated">以下主题可以帮助您解决客户端VPN端点可能遇到的问题。更多信息…</h3></div><div class="mr l"><p class="bd b fp z dy mo ea eb mp ed ef dx translated">docs.aws.amazon.com</p></div></div></div></a></div><p id="9a67" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">下载的配置文件有一个远程随机主机名设置，显然在OpenVPN(在使用版本3.3.3 (4163)的Mac上)中不起作用。</p><pre class="ll lm ln lo fd lw lx ly lz aw ma bi"><span id="c6b8" class="js jt hx lx b fi mb mc l md me">remote cvpn-endpoint-blah-blah-blah 443<br/>remote-random-hostname</span></pre><p id="121f" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">它应该做的是在DNS名称前附加一个随机字符串，以防止DNS缓存，但它没有。我加了“哈拉”DNS名称所在的远程线路，现在我可以连接:</p><pre class="ll lm ln lo fd lw lx ly lz aw ma bi"><span id="1e06" class="js jt hx lx b fi mb mc l md me">remote hala.cvpn-endpoint-blah-blah-blah 443<br/>remote-random-hostname</span></pre><h2 id="e006" class="js jt hx bd ju jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km bi translated">客户端到客户端的通信</h2><p id="f62d" class="pw-post-body-paragraph iu iv hx iw b ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn kr jp jq jr hb bi translated">我还需要更改VPN服务器配置，以允许客户端到客户端的通信，并使用多个客户端进行测试。我计划使用不同的接入网络(蜂窝和家庭FIOS)将它们连接起来。说明在这里:<a class="ae lj" href="https://docs.aws.amazon.com/vpn/latest/clientvpn-admin/scenario-client-to-client.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/VPN/latest/client VPN-admin/scenario-client-to-client . html</a></p><p id="b1a0" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">现在让我们看看它们的效果如何！这些指令顺利地发挥了作用。只是一定要注意你用的是哪个CIDR系列。有时是客户范围，有时是VPC范围。</p><figure class="ll lm ln lo fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ms"><img src="../Images/533583976d8a100f1af2e222a300f4b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F-nafgA-pAKNaxTizEjGGw.png"/></div></div></figure><p id="c1d6" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我将两台计算机连接到VPN，并尝试对它们进行ping操作。我可以从Windows转到Mac，但如果不关闭Windows防火墙，就不能反过来。底线是他们能够通过VPN通话。我还在Windows机器上启动了一个web服务器，在更改Apache配置以监听当前的VPN IP地址后，我可以通过Mac上的VPN客户端到客户端通信来查看网页。</p><h2 id="79db" class="js jt hx bd ju jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km bi translated">将EC2实例添加到VPC</h2><p id="8274" class="pw-post-body-paragraph iu iv hx iw b ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn kr jp jq jr hb bi translated">我想验证一切，所以还将在我使用的AWS VPC子网中设置一个简单的web服务器，这样我就可以测试从客户端通过VPN到web服务器的连接性。说明在这里:<a class="ae lj" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/launching-instance.html#initiate-instance-launch" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/AWS C2/latest/user guide/launching-instance . html # initiate-instance-launch</a></p><p id="fda3" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">启动实例时，请确保它在正确的VPC中启动，并且位于与您的客户端VPN关联的子网上。实例启动向导的实例详细信息部分显示了VPC和子网，并允许您编辑它们。启动后，您可以验证实例私有IP是否在客户端VPN端点的CIDR范围内。</p><p id="56e2" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我启动了我的实例，并尝试通过SSH连接。我可以使用它的公共DNS名称和我在实例启动期间创建的密钥对通过SSH连接，并且不需要在VPN上这样做。这不是我真正想要的，因为我只想通过VPN访问，但对于测试来说，这并不坏。我注意到你的redhat的SSH用户名必须是ec2-user vice root(文档是错误的)。你的密钥文件权限也不能太‘开放’。不允许全球可读。我在密钥文件上使用chmod 400重置了我的权限。</p><p id="e068" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">下一个挑战是当通过VPN连接时，使用SSH来访问VPC子网上的私有DNS(或IP)。这一开始并不奏效，因为当我授权从客户端VPN访问VPC子网时，<em class="lp">我调换了部分IP地址</em>。一旦我解决了这个问题，我就可以直接使用SSH和EC2实例的私有IP地址了。但是，EC2实例DNS名称不起作用。请注意，由于EC2实例防火墙的原因，ping可能不起作用，因此请使用其他方法来验证连通性。</p><p id="8452" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">默认情况下，EC2启动实例允许入站SSH流量——您可以在EC2控制台页面的Security选项卡中检查这些设置。防火墙似乎设置为“全部拒绝”，因此任何其他测试都需要添加适当的入站流量规则。</p><h2 id="2b2a" class="js jt hx bd ju jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km bi translated">Web服务器测试</h2><p id="da68" class="pw-post-body-paragraph iu iv hx iw b ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn kr jp jq jr hb bi translated">我在EC2实例上安装了Apache。需要3个命令(如果不想让它自动启动，只需要2个命令)就可以让它运行。</p><pre class="ll lm ln lo fd lw lx ly lz aw ma bi"><span id="dd6e" class="js jt hx lx b fi mb mc l md me">sudo yum install http<br/>sudo chkconfig httpd on<br/>sudo server httpd start</span></pre><p id="26be" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">确保为EC2实例的安全组添加HTTP入站流量规则！！</p><figure class="ll lm ln lo fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mt"><img src="../Images/5130093b014902b0cb51f0913e8e0e5a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*INK_KRg9Nypf1n_yfoQX4A.png"/></div></div></figure><p id="d43a" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我使用它的私有IP地址通过客户端VPN访问它，得到了RHEL测试页面。我仍然没有为VPN客户服务的DNS，虽然，没有访问VPC子网上的服务器，也没有为他们自己服务。我还希望根据客户端数字证书中的属性自动应用VPN客户端的DNS名称。这将使客户端更容易找到彼此，因为当您重新连接时，客户端IP会发生变化。</p><h2 id="72d9" class="js jt hx bd ju jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km bi translated">附加测试</h2><p id="e956" class="pw-post-body-paragraph iu iv hx iw b ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn kr jp jq jr hb bi translated">我做了一些其他的测试。我创建了一个没有客户端证书的配置文件，它无法按预期连接。我有丢失随机DNS字符串部分的原始配置文件，它不工作(又一次，如预期的那样)。我还创建了一个配置文件，其中包含一个没有上传到ACM的新客户端证书，它连接了。这意味着VPN接受任何拥有由我创建的CA签署的客户端证书的人。</p><p id="d013" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我尝试了Windows 10 OpenVPN客户端，它可以正常使用我创建的配置文件。然后我去掉了DNS前缀，看看remote-random-hostname是否适用于这个客户端，它确实适用！这很好，因为虽然前缀解决了Mac客户端的问题，但通过DNS缓存，您仍然可能遇到IP被Amazon更改，而您的本地DNS缓存指向旧IP的情况。随机前缀阻止缓存工作，因为它在缓存中找不到条目，并且总是查询DNS服务器。</p><p id="d9f8" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我还通过客户端VPN在一个4G热点(我的最终目标网络)上测试了一切，一切都正常。</p><h1 id="72a9" class="ks jt hx bd ju kt ku kv jy kw kx ky kc kz la lb kf lc ld le ki lf lg lh kl li bi translated">VPC的DNS</h1><p id="6548" class="pw-post-body-paragraph iu iv hx iw b ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn kr jp jq jr hb bi translated">虽然这种设置不需要DNS也可以工作，但是查找连接到VPN服务器的IP地址，或者使用我为EC2实例使用的子网中的服务的IP地址是很繁琐的。那么如何解决这个问题呢？</p><p id="1d1c" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">VPC子网中的DNS服务器位于子网的. 2地址。我的子网是172.31.0.0，这意味着DNS服务器应该在172.31.0.2。我上了VPN，用我的web服务器的私有DNS名称尝试了一个nslookup命令，它成功了。</p><pre class="ll lm ln lo fd lw lx ly lz aw ma bi"><span id="c942" class="js jt hx lx b fi mb mc l md me">eizdepski@eclector ~ % nslookup ip-172-31-73-3.ec2.internal 172.31.0.2<br/>Server:  172.31.0.2<br/>Address: 172.31.0.2#53</span><span id="bc52" class="js jt hx lx b fi mu mc l md me">Non-authoritative answer:<br/>Name: ip-172-31-73-3.ec2.internal<br/>Address: 172.31.73.3</span></pre><p id="0cce" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">只有一个问题——我不知道如何向OpenVPN客户端提供DNS服务器IP。我试过一种方法，但日志仍然显示没有设置DNS服务器。我回到客户端VPN设置，记得当我设置它时，我没有启用DNS，因为我当时不知道VPC DNS服务器的IP地址。我回去修好了。</p><figure class="ll lm ln lo fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mv"><img src="../Images/2017efc00099067f9509193d524b83fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QkR1p68HYorMwLhHQ35ZqA.png"/></div></div></figure><p id="0b50" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我重新连接了VPN客户端，现在日志显示了我的DNS服务器。我用私有DNS名称尝试了web服务器，得到了我想要的RHEL测试页面。</p><h1 id="4e7c" class="ks jt hx bd ju kt ku kv jy kw kx ky kc kz la lb kf lc ld le ki lf lg lh kl li bi translated">摘要</h1><p id="59db" class="pw-post-body-paragraph iu iv hx iw b ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn kr jp jq jr hb bi translated">这花了一些时间(总共大约9个小时，但包括这篇文章)，所以我希望它能帮助你走得更快一点。还有一件事我想实现；也就是说，为VPC客户提供DNS名称，这样他们可以更容易地找到彼此。至少在VPC，现在有了DNS支持，客户端可以很容易地连接到中央服务器，从而可以获得网络中所有节点的IP地址。其他要考虑的事情是进一步锁定环境，但在你把自己锁在外面之前，你只能到此为止，所以要小心。只允许SSH流量的默认规则是好的。</p><h1 id="b72e" class="ks jt hx bd ju kt ku kv jy kw kx ky kc kz la lb kf lc ld le ki lf lg lh kl li bi translated">转移</h1><p id="5d05" class="pw-post-body-paragraph iu iv hx iw b ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn kr jp jq jr hb bi translated">这是关于我犯的所有错误的部分！可能会节省你一些时间，所以仔细看看。</p><h2 id="b01a" class="js jt hx bd ju jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km bi translated">打字稿</h2><p id="82ef" class="pw-post-body-paragraph iu iv hx iw b ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn kr jp jq jr hb bi translated">小心那些CIDR山脉！</p><h2 id="89b2" class="js jt hx bd ju jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km bi translated">自定义VPC</h2><p id="a729" class="pw-post-body-paragraph iu iv hx iw b ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn kr jp jq jr hb bi translated">如果您自己制作VPC，请确保您的CIDR IP地址范围不与客户端VPN使用的范围重叠。这是行不通的，你不能改变范围，这意味着你必须重新开始，创造一个新的VPC。</p><h2 id="89f5" class="js jt hx bd ju jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km bi translated">自助服务页面</h2><p id="0d59" class="pw-post-body-paragraph iu iv hx iw b ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn kr jp jq jr hb bi translated">我尝试了自助服务页面，但收到一条错误消息。读了一会儿之后，我发现这个门户对那些使用相互认证的人不可用。</p><figure class="ll lm ln lo fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mw"><img src="../Images/1a609dd9955ecab8ccec9322e40e9cfc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v8nExTUVdI87vgQK6IQr3A.png"/></div></div></figure><h2 id="dcc8" class="js jt hx bd ju jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km bi translated">使用CLI上传证书</h2><p id="20dd" class="pw-post-body-paragraph iu iv hx iw b ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn kr jp jq jr hb bi translated"><em class="lp">注意——这是Mac OS特有的</em></p><p id="af56" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我使用的是版本1.10.62的AWS CLI(运行“AWS-Version”进行检查)，所以决定升级到版本2。低于1.20的版本基于Python 2.7，该版本已被弃用，加上我首先使用3.7.4，我必须删除旧的CLI，但在我的Mac上出现错误。</p><p id="be3f" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这将删除cli(除非您安装了pip)</p><pre class="ll lm ln lo fd lw lx ly lz aw ma bi"><span id="5b1f" class="js jt hx lx b fi mb mc l md me">sudo rm -rf /usr/local/aws</span><span id="f8d3" class="js jt hx lx b fi mu mc l md me">sudo rm /usr/local/bin/aws</span></pre><p id="981e" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">如果你安装了pip，那么用这种方式卸载。提示:要想知道你是否安装了pip，输入‘pip freeze’并查找awscli条目。</p><pre class="ll lm ln lo fd lw lx ly lz aw ma bi"><span id="c69f" class="js jt hx lx b fi mb mc l md me">eizdepski@eclector ~ % pip3 uninstall awscli</span></pre><p id="20f9" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我收到一个错误。</p><pre class="ll lm ln lo fd lw lx ly lz aw ma bi"><span id="54e5" class="js jt hx lx b fi mb mc l md me">xcrun: error: invalid active developer path (/Library/Developer/CommandLineTools), missing xcrun at: /Library/Developer/CommandLineTools/usr/bin/xcrun</span></pre><p id="0809" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">以下命令将修复该问题:xcode-select–install</p><p id="1eae" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">接下来，我安装了CLI版本2并验证了它。</p><pre class="ll lm ln lo fd lw lx ly lz aw ma bi"><span id="bd71" class="js jt hx lx b fi mb mc l md me">eizdepski@eclector ~ % curl “https://awscli.amazonaws.com/AWSCLIV2.pkg" -o “AWSCLIV2.pkg”<br/>% Total % Received % Xferd Average Speed Time Time Time Current<br/>Dload Upload Total Spent Left Speed<br/>100 27.1M 100 27.1M 0 0 5985k 0 0:00:04 0:00:04 — : — : — 5985k<br/>eizdepski@eclector ~ %<br/>eizdepski@eclector ~ % sudo installer -pkg ./AWSCLIV2.pkg -target /<br/>installer: Package name is AWS Command Line Interface<br/>installer: Installing at base path /<br/>installer: The install was successful.<br/>eizdepski@eclector ~ % which aws<br/>/usr/local/bin/aws<br/>eizdepski@eclector ~ % aws --version<br/>aws-cli/2.4.23 Python/3.8.8 Darwin/21.3.0 exe/x86_64 prompt/off<br/>eizdepski@eclector ~ %</span></pre><p id="1b60" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这是导入证书的命令:</p><pre class="ll lm ln lo fd lw lx ly lz aw ma bi"><span id="8103" class="js jt hx lx b fi mb mc l md me">eizdepski@eclector halavpn % aws acm import-certificate --certificate fileb://server.crt --private-key fileb://server.key --certificate-chain fileb://ca.crt</span></pre><p id="3ba6" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">但是，尝试上传还是没有成功。我没有上传的权限(可能是因为我将aws CLI升级到了版本2)，也没有完全安装新的CLI。调用ImportCertificate操作时出错(无法识别的ClientException):</p><pre class="ll lm ln lo fd lw lx ly lz aw ma bi"><span id="2fa8" class="js jt hx lx b fi mb mc l md me">The security token included in the request is invalid.</span></pre><p id="5e21" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我切换到ACM控制台——简单多了！</p></div></div>    
</body>
</html>