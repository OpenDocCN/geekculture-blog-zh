<html>
<head>
<title>Distributed Caching Pattern for Microservices with Redis Kubernetes )</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">面向微服务的分布式缓存模式</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/distributed-caching-pattern-for-microservices-with-redis-d95ea7c0e8f8?source=collection_archive---------3-----------------------#2021-08-14">https://medium.com/geekculture/distributed-caching-pattern-for-microservices-with-redis-d95ea7c0e8f8?source=collection_archive---------3-----------------------#2021-08-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="290f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当涉及到服务的生产级部署时，缓存是关键实现之一，它作为特定应用程序和保存实际数据的持久性系统之间的中间层，帮助我们提高系统的性能。</p><p id="42f0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我们研究微服务架构中缓存实施的可能模式时，有几种模式可供选择，包括:</p><ol class=""><li id="d9cc" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">嵌入式缓存</li><li id="537e" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">嵌入式分布式缓存</li><li id="5639" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">客户端服务器缓存</li><li id="7e19" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">云缓存</li><li id="89d4" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">边车缓存</li><li id="f41b" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">分布式缓存</li><li id="89a2" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">等等…</li></ol><p id="ff0b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了更好地理解这些模式，你可以参考<a class="ae jr" href="https://hazelcast.com/blog/architectural-patterns-for-caching-microservices/" rel="noopener ugc nofollow" target="_blank">【1】</a>和<a class="ae jr" href="https://www.youtube.com/watch?v=0x-ZV_vP73k" rel="noopener ugc nofollow" target="_blank">【2】</a>，在那里我们可以找到更详细的解释。</p><p id="3c51" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，我的目的是讨论分布式缓存模式，以及我们如何在单节点和高可用性设置中使用Redis部署分布式缓存解决方案。</p><p id="01a7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">作为第一步，我们将看看这种分布式缓存意味着什么——以下引文摘自<a class="ae jr" href="https://hazelcast.com/glossary/distributed-cache/" rel="noopener ugc nofollow" target="_blank">【3】</a>。</p><p id="5b44" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="js"/><strong class="ih hj"><em class="js">分布式高速缓存</em> </strong> <em class="js">是一种系统，它将多台联网计算机的随机存取内存(RAM)汇集到一个内存数据存储中，用作数据高速缓存，以提供对数据的快速访问。</em></p><p id="3539" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下图描述了使用分布式缓存的典型用例。同样的用例，我们将在Kubernetes上使用Spring Boot、MysQL和Redis来实现。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es jt"><img src="../Images/0764c1ee6dc6c7ae5fad6d27761be92c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mlppayrYbozQ_SLCIEIScw.png"/></div></div></figure><h1 id="adec" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">我们要在这里做什么！</h1><ol class=""><li id="03c5" class="jd je hi ih b ii ld im le iq lf iu lg iy lh jc ji jj jk jl bi translated">设置单节点Redis部署</li><li id="99f6" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">设置HA Redis部署(禁用集群并使用Sentinel实现高可用性)</li><li id="8c6d" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">准备一个样本Spring Boot微服务来测试应用程序和MySQL之间的缓存</li></ol><h1 id="6432" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">设置单节点Redis部署</h1><p id="dba9" class="pw-post-body-paragraph if ig hi ih b ii ld ik il im le io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">下图描述了当我们在Kubernetes中进行单节点Redis部署时，需要哪些组件以及它们是如何互连的。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es ll"><img src="../Images/d6790376b3040cc07b18552c4f061d0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9ARglIa8t4dg2Qa0Z2ootw.png"/></div></div></figure><p id="a164" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Spring Boot应用</strong> —为测试缓存而创建的应用。</p><p id="a451" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Redis服务</strong> —这是Redis的Kubernetes服务，用作Spring Boot应用程序的入口点。</p><p id="963b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Redis </strong> —这是Redis POD，在Kubernetes中作为StatefulSet运行。</p><p id="3a18" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> NFS存储供应器</strong> —这是通过持久性卷声明来动态供应持久性卷。当我们使用Redis集群时，这实际上是需要的，但我已经用单节点实现了同样的功能，因为它可以重用。这里使用的是<a class="ae jr" href="https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner" rel="noopener ugc nofollow" target="_blank">【4】nfs-subdir-external-Provisioner</a>，因为默认的nfs置备程序不再被维护，而且当使用旧的置备程序遇到问题时，它不能正确启动Kubernetes ( minikube版本:v1.22.0)中的NFS置备程序POD。</p><p id="9462" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">外置NFS服务器</strong> —用于持久存储。</p><p id="7566" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Minikube </strong> —出于本地测试的目的，我们可以使用Minikube来设置Kubernetes集群。</p><p id="4d5d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="js">注:这里我不打算解释如何设置Minikube，如果你是新手，请参考</em><a class="ae jr" href="https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner/tree/v4.0.2" rel="noopener ugc nofollow" target="_blank"><em class="js">【5】</em></a><em class="js">。</em></p><h2 id="f3e7" class="lm kg hi bd kh ln lo lp kl lq lr ls kp iq lt lu kt iu lv lw kx iy lx ly lb lz bi translated">步骤1:准备存储类。</h2><figure class="ju jv jw jx fd jy"><div class="bz dy l di"><div class="ma mb l"/></div></figure><h2 id="0bfe" class="lm kg hi bd kh ln lo lp kl lq lr ls kp iq lt lu kt iu lv lw kx iy lx ly lb lz bi translated">步骤2:准备角色和访问控制。</h2><figure class="ju jv jw jx fd jy"><div class="bz dy l di"><div class="ma mb l"/></div></figure><p id="7354" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤3:准备部署文件。</strong></p><figure class="ju jv jw jx fd jy"><div class="bz dy l di"><div class="ma mb l"/></div></figure><p id="439d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤4:执行脚本并检查部署。</strong></p><figure class="ju jv jw jx fd jy"><div class="bz dy l di"><div class="ma mb l"/></div></figure><figure class="ju jv jw jx fd jy"><div class="bz dy l di"><div class="ma mb l"/></div></figure><p id="ff7f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤5:准备redis-config.yaml </strong></p><figure class="ju jv jw jx fd jy"><div class="bz dy l di"><div class="ma mb l"/></div></figure><p id="a4bf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤6:准备Redis部署文件</strong></p><figure class="ju jv jw jx fd jy"><div class="bz dy l di"><div class="ma mb l"/></div></figure><p id="ddf7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤7:执行Redis部署脚本</strong></p><figure class="ju jv jw jx fd jy"><div class="bz dy l di"><div class="ma mb l"/></div></figure><p id="c076" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤8:验证初始设置</strong></p><figure class="ju jv jw jx fd jy"><div class="bz dy l di"><div class="ma mb l"/></div></figure><p id="ee53" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们完成了单节点设置，当我们在<strong class="ih hj">部分时，我们将通过Spring Boot应用程序验证这一点:3。</strong></p><h1 id="2ae7" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">设置HA Redis部署</h1><p id="126e" class="pw-post-body-paragraph if ig hi ih b ii ld ik il im le io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">谈到高可用性设置，有两个选项，一个是使用群集启用和群集禁用选项。这两种设置各有利弊，要获得更多信息，请参考“<a class="ae jr" href="https://docs.aws.amazon.com/AmazonElastiCache/latest/red-ug/Replication.Redis-RedisCluster.html" rel="noopener ugc nofollow" target="_blank">比较集群选项</a>”链接。</p><p id="e203" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这里，我将设置集群禁用模式，通过使用Sentinel实现高可用性。Sentinel将监控节点，例如，考虑到主节点出现故障，它将使其中一个从节点成为主节点，使其可用。</p><p id="8a5c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在此设置中，将有3个Redis节点、3个Sentinel节点以及2个NFS资源调配器来实现高可用性。</p><p id="b385" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤1:通过将副本数量增加到2来部署NFS置备程序。</strong></p><p id="cdea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤2:使用相同的Redis配置文件并部署它。</strong></p><p id="2939" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤3:使用相同的Redis部署文件，将副本更新为3并部署文件。</strong></p><p id="21af" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第四步:准备哨兵部署文件。</strong></p><p id="6c36" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意:需要相应地更新<namespace>标签。</namespace></p><figure class="ju jv jw jx fd jy"><div class="bz dy l di"><div class="ma mb l"/></div></figure><p id="c008" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤5:现在执行下面的命令来部署工件。</strong></p><figure class="ju jv jw jx fd jy"><div class="bz dy l di"><div class="ma mb l"/></div></figure><p id="2521" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将运行3个Redis PODs和3个Sentinel PODs，您可以使用相同的方法验证Redis节点，要验证Sentinel节点，您可以使用kubectl logs -f <podname> -n <namespace>检查日志。</namespace></podname></p><h1 id="39a4" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">准备一个样本Spring Boot微服务来测试应用程序和MySQL之间的缓存</h1><p id="6212" class="pw-post-body-paragraph if ig hi ih b ii ld ik il im le io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated"><strong class="ih hj">步骤1: </strong>实现spring boot项目以使用Redis缓存。我实现的样本可以在“<a class="ae jr" href="https://github.com/ajanthanblog/redis-springboot-cache.git" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> redis-sample </strong> </a>”找到。克隆它，转到项目文件夹，执行下面的命令来构建映像。</p><p id="4c45" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">应用程序代码中的亮点:</p><p id="0ddc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">应用程序开发. yaml属性文件。</strong></p><figure class="ju jv jw jx fd jy"><div class="bz dy l di"><div class="ma mb l"/></div></figure><p id="18e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">RedistestApplication.java</strong></p><figure class="ju jv jw jx fd jy"><div class="bz dy l di"><div class="ma mb l"/></div></figure><p id="a081" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">UserController.java</strong></p><figure class="ju jv jw jx fd jy"><div class="bz dy l di"><div class="ma mb l"/></div></figure><p id="214f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要构建映像，请从项目根文件夹中执行下面的命令。</p><figure class="ju jv jw jx fd jy"><div class="bz dy l di"><div class="ma mb l"/></div></figure><p id="8e08" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">成功构建后可以找到如下图像:</p><figure class="ju jv jw jx fd jy"><div class="bz dy l di"><div class="ma mb l"/></div></figure><figure class="ju jv jw jx fd jy"><div class="bz dy l di"><div class="ma mb l"/></div></figure><p id="caf0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤2: </strong>现在我们已经推送了我们的映像，现在需要将它部署到minikube集群。</p><p id="8294" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">准备以下部署文件:</p><figure class="ju jv jw jx fd jy"><div class="bz dy l di"><div class="ma mb l"/></div></figure><p id="9c4e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用以下命令进行部署，并验证是否所有单元都处于就绪状态。</p><figure class="ju jv jw jx fd jy"><div class="bz dy l di"><div class="ma mb l"/></div></figure><p id="6e47" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤3: </strong>验证缓存。</p><p id="2397" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用minikube ssh命令进入minikube集群并执行下面的curl命令。</p><figure class="ju jv jw jx fd jy"><div class="bz dy l di"><div class="ma mb l"/></div></figure><p id="ebd6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">还要检查应用程序日志:</p><figure class="ju jv jw jx fd jy"><div class="bz dy l di"><div class="ma mb l"/></div></figure><p id="7d18" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过从后端数据库获取记录，您可以看到第一个调用有日志。但是当你第二次执行时，它不会到达那里，但是你会得到响应。</p><figure class="ju jv jw jx fd jy"><div class="bz dy l di"><div class="ma mb l"/></div></figure><p id="630d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要验证这是否通过我们的Redis缓存，请执行下面的命令并进入redis POD。</p><figure class="ju jv jw jx fd jy"><div class="bz dy l di"><div class="ma mb l"/></div></figure><p id="aba1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以在那里看到我们的处决记录。这证实了我们的集成工作符合预期。</p><p id="7a8d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就是这样…此外，还可以通过更新和撤销缓存选项来更新应用程序。</p><h1 id="12bb" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">参考</h1><p id="8255" class="pw-post-body-paragraph if ig hi ih b ii ld ik il im le io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">[1]<a class="ae jr" href="https://developpaper.com/deploying-single-node-redis-in-kubernetes-environment/" rel="noopener ugc nofollow" target="_blank">https://develop paper . com/deploying-single-node-redis-in-kubernetes-environment/</a></p><p id="b751" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jr" href="https://www.youtube.com/watch?v=JmCn7k0PlV4" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=JmCn7k0PlV4</a></p><p id="56d7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jr" href="https://www.youtube.com/watch?v=AavnQzWDTEk" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=AavnQzWDTEk</a></p><p id="5813" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">[4]<a class="ae jr" href="https://www.wwt.com/article/the-power-of-distributed-caching-with-redis/" rel="noopener ugc nofollow" target="_blank">https://www . wwt . com/article/the-power-of-distributed-caching-with-redis/</a></p></div></div>    
</body>
</html>