<html>
<head>
<title>Building a Live Audio Streaming React Native App with Agora</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Agora构建实时音频流React本地应用程序</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/building-a-live-audio-streaming-react-native-app-with-agora-acff6e7fd68f?source=collection_archive---------7-----------------------#2021-03-19">https://medium.com/geekculture/building-a-live-audio-streaming-react-native-app-with-agora-acff6e7fd68f?source=collection_archive---------7-----------------------#2021-03-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/848bb77bc63cfb2b91e5a3157c8ad398.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yeOMC3eq77KJgXbFHa-lBw.png"/></div></div></figure><p id="2e4d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">从直播播客和采访到现场音乐表演，直播音频流在各种用途中越来越受欢迎。一旦有几个用户与观众实时互动，可能性是无穷无尽的。</p><p id="0074" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用Agora React Native SDK有一种简单的方法来实现实时音频流。在本教程中，我们将通过利用Agora Audio SDK构建一个直播音频广播应用程序，该应用程序可以拥有多个广播公司并托管数千个用户。在深入研究代码之前，我们将检查应用程序的结构、设置和执行。这里有开源代码:<a class="ae jo" href="https://github.com/EkaanshArora/Agora-RN-Audio-Broadcast" rel="noopener ugc nofollow" target="_blank">https://github.com/EkaanshArora/Agora-RN-Audio-Broadcast</a></p><p id="d69e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们将使用<a class="ae jo" href="https://www.npmjs.com/package/react-native-agora/" rel="noopener ugc nofollow" target="_blank">Agora RTC SDK for React Native</a>作为示例。我在写的时候用的是v3.2.2。</p><h1 id="c91d" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">创建Agora帐户</h1><p id="1ce1" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated"><a class="ae jo" href="https://sso.agora.io/en/signup?utm_source=medium&amp;utm_medium=blog&amp;utm_campaign=building-a-live-audio-streaming-react-native-app-with-agora" rel="noopener ugc nofollow" target="_blank">注册</a>账户并登录仪表板。</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div class="er es ks"><img src="../Images/470feb99e4e02dbc30b1e8d7a4a7a0fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1088/format:webp/1*YFtAcuBfRmPXr8DGEA79SA.png"/></div><figcaption class="kx ky et er es kz la bd b be z dx">Selecting the Project Management tab in the Agora.io Console.</figcaption></figure><p id="ab56" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">导航到“项目管理”选项卡下的“项目列表”选项卡，并通过单击蓝色的“创建”按钮创建一个项目。</p><p id="f16e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建一个项目并检索应用程序ID。(当系统提示使用应用ID +证书时，请仅选择应用ID。)在您开发应用程序时，应用程序ID将用于授权您的请求，而不会生成令牌。</p><p id="551a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">注意</strong>:本指南不实施令牌认证，建议在生产环境中运行的所有RTE应用程序都使用令牌认证。有关Agora平台内基于令牌的身份验证的更多信息，请参考本指南:<a class="ae jo" href="https://docs.agora.io/en/Video/token?platform=All%20Platforms" rel="noopener ugc nofollow" target="_blank">https://docs.agora.io/en/Video/token?平台=所有% 20个平台</a></p><h1 id="1b22" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">我们示例的结构</h1><p id="c64e" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">这是应用程序的结构:</p><pre class="kt ku kv kw fd lb lc ld le aw lf bi"><span id="3631" class="lg jq hi lc b fi lh li l lj lk"><strong class="lc hj">.</strong><br/>├── android<br/>├── components<br/>│ └── <strong class="lc hj">Permission.ts<br/></strong>│ └── <strong class="lc hj">Style.ts<br/></strong>├── ios<strong class="lc hj"><br/></strong>├── <strong class="lc hj">App.tsx</strong><br/>├── index.js<strong class="lc hj"><br/>.</strong></span></pre><h1 id="df90" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">运行应用程序</h1><p id="d0b3" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">你需要安装最新版本的Node.js和need</p><ul class=""><li id="05d8" class="ll lm hi is b it iu ix iy jb ln jf lo jj lp jn lq lr ls lt bi translated">确保你已经建立了一个Agora帐户，建立了一个项目，并生成了一个应用程序ID(如上所述)。</li><li id="90d3" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated">从主<a class="ae jo" href="https://github.com/EkaanshArora/Agora-RN-Audio-Broadcast%5C" rel="noopener ugc nofollow" target="_blank">分支</a>下载并解压ZIP文件。</li><li id="8f69" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated">运行<code class="du lz ma mb lc b">npm install</code>在解压后的目录中安装应用依赖项。</li><li id="d39c" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated">导航到<code class="du lz ma mb lc b">./App.tsx</code>，在状态声明中输入应用ID<code class="du lz ma mb lc b">`appId: <strong class="is hj">YourAppIdHere</strong>`</code>。</li><li id="9827" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated">如果你正在为iOS构建，打开一个终端并执行<code class="du lz ma mb lc b">cd ios &amp;&amp; pod install</code>。</li><li id="f89e" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated">连接你的设备，运行<code class="du lz ma mb lc b">npx react-native run-android</code> / <code class="du lz ma mb lc b">npx react-native run-ios</code>启动应用。给它几分钟时间来构建应用程序并将其安装到您的设备上。</li><li id="0cbb" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated">在移动设备(或模拟器)上看到主屏幕后，单击设备上的开始通话按钮。</li></ul><p id="1f4d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">就是这样。两台设备之间应该有音频广播。</p><p id="620e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">app使用<code class="du lz ma mb lc b">channel-x</code>作为频道名称。</p><h2 id="3ba5" class="lg jq hi bd jr mc md me jv mf mg mh jz jb mi mj kd jf mk ml kh jj mm mn kl mo bi translated">在深入研究代码之前，让我们先了解一些基础知识:</h2><ul class=""><li id="44ce" class="ll lm hi is b it kn ix ko jb mp jf mq jj mr jn lq lr ls lt bi translated">我们将使用Agora RTC(实时通信)SDK连接到一个频道并加入音频通话。</li><li id="1a28" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated">我们可以让多个用户向一个频道广播。该频道上作为观众的所有用户都可以收听广播电台。</li><li id="49ce" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated">观众可以动态地切换到广播员角色。</li><li id="4654" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated">Agora RTC SDK为每个用户使用唯一的id(uid)。为了将这些uid与用户名相关联，我们将使用Agora RTM(实时消息)SDK将用户名发送给通话中的其他人。我们将在下面讨论它是如何实现的。</li></ul><p id="7ab9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们看看代码是如何工作的:</p><h2 id="a364" class="lg jq hi bd jr mc md me jv mf mg mh jz jb mi mj kd jf mk ml kh jj mm mn kl mo bi translated">App.tsx</h2><p id="ad69" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">App.tsx将成为应用的入口。我们将所有的代码都放在这个文件中。当您打开应用程序时，会有一个用户名字段，其中有三个按钮:加入呼叫，结束呼叫，以及在广播公司和观众之间切换我们的用户角色。</p><figure class="kt ku kv kw fd ij"><div class="bz dy l di"><div class="ms mt l"/></div></figure><p id="cf40" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们从编写使用的导入语句开始。接下来，我们为应用程序状态定义一个包含以下内容的接口:</p><ul class=""><li id="5bda" class="ll lm hi is b it iu ix iy jb ln jf lo jj lp jn lq lr ls lt bi translated"><code class="du lz ma mb lc b"><strong class="is hj">appId</strong></code>:我们的Agora应用ID</li><li id="5e60" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated"><code class="du lz ma mb lc b"><strong class="is hj">token</strong></code>:生成加入频道的令牌</li><li id="8de0" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated"><code class="du lz ma mb lc b"><strong class="is hj">isHost</strong></code>:用于在观众和广播公司之间切换的布尔值</li><li id="ba28" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated"><code class="du lz ma mb lc b"><strong class="is hj">channelName</strong></code>:频道名称</li><li id="f35c" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated"><code class="du lz ma mb lc b"><strong class="is hj">joinSucceed</strong></code>:连接成功后要存储的布尔值</li><li id="41dd" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated"><code class="du lz ma mb lc b"><strong class="is hj">rtcUid</strong></code>:本地用户加入RTC通道的UID</li><li id="de15" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated"><code class="du lz ma mb lc b"><strong class="is hj">myUsername</strong></code>:登录RTM的本地用户名</li><li id="52ae" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated"><code class="du lz ma mb lc b"><strong class="is hj">usernames</strong></code>:一个将远程用户的RTC UIDs与他们的用户名相关联的字典，我们将使用RTM获得这些用户名</li><li id="c7a2" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated"><code class="du lz ma mb lc b"><strong class="is hj">peerIds</strong></code>:存储频道中其他用户的uid的数组</li></ul><figure class="kt ku kv kw fd ij"><div class="bz dy l di"><div class="ms mt l"/></div></figure><p id="3ae2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们定义了一个基于类的组件:_rtcEngine变量将存储rtcEngine类的实例，而_rtmEngine变量将存储rtmEngine类的实例，我们可以用它来访问SDK函数。</p><p id="25e5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在构造函数中，我们设置状态变量并请求在Android上录制音频的权限。(我们使用permission.ts中的一个helper函数，如下所述。)当组件被挂载时，我们调用initRTC <strong class="is hj"> </strong>和initRTM函数，这些函数使用App ID初始化RTC和RTM引擎。当组件卸载时，我们销毁我们的引擎实例。</p><h2 id="bf6a" class="lg jq hi bd jr mc md me jv mf mg mh jz jb mi mj kd jf mk ml kh jj mm mn kl mo bi translated">RTC初始化</h2><figure class="kt ku kv kw fd ij"><div class="bz dy l di"><div class="ms mt l"/></div></figure><p id="2fcb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们使用App ID来创建引擎实例。接下来，我们根据isHost状态变量值将channelProfile设置为Live Broadcasting和clientRole。</p><p id="9a30" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当我们加入通道时，RTC会为在场的每个用户以及稍后加入的每个新用户触发userJoined事件。当用户离开频道时，将触发userOffline事件。我们使用事件监听器来同步peerIds数组。</p><p id="e4a8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="mu">注意:</em>受众成员不会触发userJoined/userOffline事件。</p><h2 id="6845" class="lg jq hi bd jr mc md me jv mf mg mh jz jb mi mj kd jf mk ml kh jj mm mn kl mo bi translated">RTM初始化</h2><p id="55d8" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">我们使用RTM将我们的用户名发送给通话中的其他用户名。这就是我们如何将用户名与RTC UID相关联</p><ul class=""><li id="2af5" class="ll lm hi is b it iu ix iy jb ln jf lo jj lp jn lq lr ls lt bi translated">当一个用户加入一个渠道时，我们向所有渠道成员发送一条消息作为<code class="du lz ma mb lc b">UID:Username</code>。</li><li id="16c2" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated">在收到通道消息时，所有用户都将键-值对添加到他们的用户名字典中。</li><li id="9a43" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated">当一个新用户加入时，通道上的所有成员都以相同的模式<code class="du lz ma mb lc b">UID:Username</code>向该用户发送对等消息。</li><li id="2918" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated">在接收对等消息时，我们做同样的事情(将键-值对添加到字典中)并更新我们的用户名。</li></ul><figure class="kt ku kv kw fd ij"><div class="bz dy l di"><div class="ms mt l"/></div></figure><p id="90c4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">按照我们的计划，我们在<code class="du lz ma mb lc b">channelMessageReceived</code>(向频道广播消息)、<code class="du lz ma mb lc b">messageReceived</code>(对等消息)和<code class="du lz ma mb lc b">channelMemberJoined</code>事件上添加和更新用户名。我们还使用相同的应用ID在引擎上创建了一个客户端。</p><h2 id="4b5c" class="lg jq hi bd jr mc md me jv mf mg mh jz jb mi mj kd jf mk ml kh jj mm mn kl mo bi translated">我们按钮的功能</h2><figure class="kt ku kv kw fd ij"><div class="bz dy l di"><div class="ms mt l"/></div></figure><p id="dfb1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du lz ma mb lc b">toggleRole</code>函数更新状态，并根据状态使用正确的参数调用<code class="du lz ma mb lc b">setClientRole</code>函数。</p><p id="3832" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du lz ma mb lc b">startCall</code>函数检查是否输入了用户名。然后，它加入RTC通道。它还登录到RTM，加入通道，并发送用户名的通道消息，就像我们之前讨论的那样。</p><p id="ab7b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du lz ma mb lc b">endCall</code>函数离开RTC通道，发送用于从我们的远程用户字典中删除用户名的消息，然后离开并注销RTM。</p><h2 id="f91d" class="lg jq hi bd jr mc md me jv mf mg mh jz jb mi mj kd jf mk ml kh jj mm mn kl mo bi translated">呈现我们的用户界面</h2><figure class="kt ku kv kw fd ij"><div class="bz dy l di"><div class="ms mt l"/></div></figure><p id="dfac" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们定义了render函数，用于显示开始和结束呼叫以及切换角色的按钮。我们定义了一个函数<code class="du lz ma mb lc b">_renderUsers</code>来呈现所有广播公司和观众成员的列表。</p><h2 id="4906" class="lg jq hi bd jr mc md me jv mf mg mh jz jb mi mj kd jf mk ml kh jj mm mn kl mo bi translated">Permission.ts</h2><figure class="kt ku kv kw fd ij"><div class="bz dy l di"><div class="ms mt l"/></div></figure><p id="b908" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们正在导出一个助手函数，向Android操作系统请求麦克风权限。</p><h2 id="1852" class="lg jq hi bd jr mc md me jv mf mg mh jz jb mi mj kd jf mk ml kh jj mm mn kl mo bi translated">Style.ts</h2><figure class="kt ku kv kw fd ij"><div class="bz dy l di"><div class="ms mt l"/></div></figure><p id="b36b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Style.ts文件包含组件的样式。</p></div><div class="ab cl mv mw gp mx" role="separator"><span class="my bw bk mz na nb"/><span class="my bw bk mz na nb"/><span class="my bw bk mz na"/></div><div class="hb hc hd he hf"><h2 id="e696" class="lg jq hi bd jr mc md me jv mf mg mh jz jb mi mj kd jf mk ml kh jj mm mn kl mo bi translated"><strong class="ak">结论</strong></h2><p id="4996" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">这就是构建实时音频流应用程序的简单之处。你可以参考<a class="ae jo" href="https://docs.agora.io/en/Video/API%20Reference/react_native/index.html" rel="noopener ugc nofollow" target="_blank">Agora React Native API Reference</a>，了解可以帮助你快速添加麦克风静音、设置音频配置文件、音频混合等功能的方法。</p></div></div>    
</body>
</html>