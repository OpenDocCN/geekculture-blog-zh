<html>
<head>
<title>How to manage multitenancy on Kubernetes?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何管理Kubernetes上的多租户？</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/how-to-manage-multitenancy-on-kubernetes-62ed5d95fcfc?source=collection_archive---------24-----------------------#2021-09-13">https://medium.com/geekculture/how-to-manage-multitenancy-on-kubernetes-62ed5d95fcfc?source=collection_archive---------24-----------------------#2021-09-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="7d68" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在一个相当大的组织中，你如何管理Kubernetes集群？您是否为所有团队保留单独的集群？适用于所有环境？除了这些令人惊叹的功能，一旦你开始用Kubernetes成长，就会带来一些管理开销。随着基础设施的增长，您必须找到有效的方法来管理资源、用户和访问。</p><h1 id="6ebd" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">正确的方法？</h1><p id="c681" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">为每个团队和每个环境管理不同的集群并不是最有效的方式。您将需要更多的专业人员来管理这些集群，承担所有这些主节点的更多成本，并且依赖管理员来为每个团队部署和设置集群。这就需要集中管理甚至是集中集群！</p><h2 id="3988" class="kg je hi bd jf kh ki kj jj kk kl km jn iq kn ko jr iu kp kq jv iy kr ks jz kt bi translated">中央集群的问题？</h2><p id="f8e1" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">这里有两个主要的复杂因素<br/> <strong class="ih hj">隔离</strong>:这里最大的问题是隔离。一个项目的资源不应该妨碍其他项目<br/> <strong class="ih hj">访问</strong>:团队应该只能访问他们的资源</p><h2 id="fc49" class="kg je hi bd jf kh ki kj jj kk kl km jn iq kn ko jr iu kp kq jv iy kr ks jz kt bi translated">单一解决方案</h2><p id="c9ad" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated"><a class="ae ku" href="https://loft.sh/" rel="noopener ugc nofollow" target="_blank"> Loft </a>可以帮助经济高效地解决这两个问题。在接下来的几分钟里，我们将看到如何在Kubernetes集群中创建隔离(我们讨论的不仅仅是名称空间),并在一个中心位置进行配置。一旦管理员完成配置，开发人员将配备一个自助服务门户来调配他们的集群、管理他们的应用等</p></div><div class="ab cl kv kw gp kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="hb hc hd he hf"><h1 id="ff4c" class="jd je hi bd jf jg lc ji jj jk ld jm jn jo le jq jr js lf ju jv jw lg jy jz ka bi translated">设置</h1><p id="e50c" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">首先，我们需要我们的中央集群。对于这个演示，我使用一个部署在本地机器上的minikube集群</p><figure class="li lj lk ll fd lm er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es lh"><img src="../Images/2599f3d2869c3b6bc98774adac211923.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Kn2abzz3KUO2FsOE_K99jg.png"/></div></div></figure><p id="c322" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们需要安装Loft CLI。您可以根据您的操作系统在<a class="ae ku" href="https://loft.sh/docs/quickstart" rel="noopener ugc nofollow" target="_blank">快速入门指南</a>中找到这些步骤。对我来说，事情就是这样</p><pre class="li lj lk ll fd lt lu lv lw aw lx bi"><span id="bd92" class="kg je hi lu b fi ly lz l ma mb">curl -s -L "<a class="ae ku" href="https://github.com/loft-sh/loft/releases/latest" rel="noopener ugc nofollow" target="_blank">https://github.com/loft-sh/loft/releases/latest</a>" | sed -nE 's!.*"([^"]*loft-darwin-amd64)".*!<a class="ae ku" href="https://github.com\1!p'" rel="noopener ugc nofollow" target="_blank">https://github.com\1!p'</a> | xargs -n 1 curl -L -o loft &amp;&amp; chmod +x loft;</span><span id="68ae" class="kg je hi lu b fi mc lz l ma mb">sudo mv loft /usr/local/bin;</span></pre><p id="4bd8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">安装后，只需像这样验证安装</p><figure class="li lj lk ll fd lm er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es lh"><img src="../Images/67ef16094cfe2dc761742b16e5a6493c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7cc2wOSvRx35N9rUixt_qA.png"/></div></div></figure><p id="64b0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们已经准备好部署阁楼了。让我们从跑步开始</p><pre class="li lj lk ll fd lt lu lv lw aw lx bi"><span id="14bd" class="kg je hi lu b fi ly lz l ma mb">loft start</span></pre><blockquote class="md me mf"><p id="9dd3" class="if ig mg ih b ii ij ik il im in io ip mh ir is it mi iv iw ix mj iz ja jb jc hb bi translated">确保舵版本&gt; = 3.2，因为在后台运行的命令在舵升级时使用<code class="du mk ml mm lu b">--create-namespace</code>标志</p></blockquote><figure class="li lj lk ll fd lm er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es lh"><img src="../Images/1fdc59fdc2e7f7aa5eeff96c24b5f348.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e_iRwSzNZM3blm2C3jM1ng.png"/></div></div></figure><p id="b66b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为我正在运行minikube，所以出现了这个提示，我选择了<strong class="ih hj"> Yes </strong>并在下一个提示中进一步输入我的电子邮件id，提示为您的管理员用户输入一个电子邮件地址</p><p id="6f9a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">安装完成后，您将看到以下日志</p><pre class="li lj lk ll fd lt lu lv lw aw lx bi"><span id="6243" class="kg je hi lu b fi ly lz l ma mb">########################## LOGIN ############################</span><span id="d138" class="kg je hi lu b fi mc lz l ma mb">Username: admin<br/>Password: 72258f0b-2e60–4441–8981–4809144df1b5</span><span id="6168" class="kg je hi lu b fi mc lz l ma mb">Login via UI: <a class="ae ku" href="https://localhost:9898" rel="noopener ugc nofollow" target="_blank">https://localhost:9898</a><br/>Login via CLI: loft login --insecure <a class="ae ku" href="https://localhost:9898" rel="noopener ugc nofollow" target="_blank">https://localhost:9898</a></span><span id="d079" class="kg je hi lu b fi mc lz l ma mb">!!! You must accept the untrusted certificate in your browser !!!</span><span id="5783" class="kg je hi lu b fi mc lz l ma mb">#################################################################</span><span id="b355" class="kg je hi lu b fi mc lz l ma mb">Loft was successfully installed and port-forwarding has been started.<br/>If you stop this command, run ‘loft start’ again to restart port-forwarding.</span><span id="da77" class="kg je hi lu b fi mc lz l ma mb">Thanks for using loft!</span></pre></div><div class="ab cl kv kw gp kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="hb hc hd he hf"><h1 id="d305" class="jd je hi bd jf jg lc ji jj jk ld jm jn jo le jq jr js lf ju jv jw lg jy jz ka bi translated">我们去散步吧</h1><p id="419e" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">在浏览器中输入<a class="ae ku" href="https://localhost:9898" rel="noopener ugc nofollow" target="_blank"> https://localhost:9898 </a>并通过“您的连接不是私有的”警告后，您将看到这个页面，在这里您可以使用管理员凭据登录。</p><figure class="li lj lk ll fd lm er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es mn"><img src="../Images/179e6ee6c71dbd802f7de18ba6a36feb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jsoUpNNFWEE-kHuiO37oPQ.png"/></div></div></figure><p id="6d77" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后快速填写一份关于你的个人资料的表格，填写你的姓名、角色、团队规模和组织。填写完毕后，点击“完成”,你就成功了！</p><figure class="li lj lk ll fd lm er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es mo"><img src="../Images/9590951875778d8498ae252adeaf1f0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hcZNthngfy2tkQGwEccpyQ.jpeg"/></div></div></figure><h1 id="2413" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">将所有集群聚集在一起</h1><p id="2f8e" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">我们的第一步将是连接Loft管理下的所有不同集群。为此，请转到左侧的<strong class="ih hj">集群</strong>选项卡。<br/>在这里，您将看到一个名为<strong class="ih hj"> loft-cluster </strong>的集群，这是您刚刚部署loft的集群。</p><figure class="li lj lk ll fd lm er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es mp"><img src="../Images/afa1b2caaa4c87f6a6a5f9a7eac63bba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dcinKzLKYDYRJLernazYVQ.png"/></div></div></figure><p id="e2ac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">点击右上角的<strong class="ih hj">连接集群</strong>按钮，输入集群的名称和kube-config，如下所示。</p><figure class="li lj lk ll fd lm er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es mq"><img src="../Images/041e490b314f9379a43fabc221279b60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*CsmIIgSzWUggT7hNH9rU2A.gif"/></div></div></figure><p id="4f2a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，它会将<a class="ae ku" href="https://github.com/loft-sh/kiosk" rel="noopener ugc nofollow" target="_blank"> Kiosk </a>安装到您的集群中，这是一个轻量级、可插拔和可定制的多租户解决方案。</p><p id="700a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">除了Kiosk，一旦你点击一个集群，UI会给你一个额外的功能，一个非常方便的单击安装选项，可以安装很多其他应用程序。</p><figure class="li lj lk ll fd lm er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es mr"><img src="../Images/0b8b45feb6dea1e71b20e169b430f4ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kwrNUKtw0Tr7j4bFPWue7Q.png"/></div></div></figure><h1 id="9403" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">创建虚拟集群</h1><p id="faa0" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">既然我们已经在一个管理下准备好了所有的多租户集群，那么是时候创建隔离了。</p><p id="e7e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第一级隔离是通过虚拟集群(vClusters)完成的。这些虚拟集群实际上是在您的Kubernetes集群上运行的K3s集群。想了解K3s更多，可以看看<a class="ae ku" href="https://rajputvaibhav.medium.com/k3s-hottest-new-entry-in-cncf-sandbox-to-change-how-you-look-at-k8s-51545e10f614" rel="noopener">我早期的博客</a>。</p><p id="67c5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为此，请转到左侧面板中的vCluster选项，然后单击“Create vCluster”按钮。选择一个集群，给它起个名字，就可以开始了！<br/>这还将在您的集群中创建一个名称空间，您可以在UI的Spaces部分查看该名称空间。</p><h1 id="b128" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">连接到vCluster</h1><p id="08d2" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">一旦您的vCluster准备就绪，您就可以通过单击此选项并获得指定的命令来连接它</p><figure class="li lj lk ll fd lm er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es ms"><img src="../Images/919b5364647766a6b6e937dd4251fa58.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*onJRul3UykRT5zeiTmK3uQ.jpeg"/></div></div></figure><p id="29e3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该命令将类似于以下内容</p><pre class="li lj lk ll fd lt lu lv lw aw lx bi"><span id="f9ad" class="kg je hi lu b fi ly lz l ma mb">loft use vcluster &lt;vcluster-name&gt; --cluster &lt;cluster-name&gt; --space &lt;space-name&gt;</span></pre><p id="8e8e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，去你的终端运行</p><pre class="li lj lk ll fd lt lu lv lw aw lx bi"><span id="6cb3" class="kg je hi lu b fi ly lz l ma mb">loft login &lt;loft-address&gt; --username &lt;username&gt; --access-key &lt;access-key&gt;</span></pre><p id="d32c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我的例子中，loft-address是<a class="ae ku" href="https://localhost:9898" rel="noopener ugc nofollow" target="_blank"> https://localhost:9898 </a>。<br/>用户名和访问密钥取决于您用来登录的用户。可以在左窗格的用户部分创建用户，一旦用户登录，他们可以在左窗格的配置文件部分创建他们的访问密钥。</p><blockquote class="md me mf"><p id="649e" class="if ig mg ih b ii ij ik il im in io ip mh ir is it mi iv iw ix mj iz ja jb jc hb bi translated">注意:您可能需要在登录命令中使用<code class="du mk ml mm lu b">--insecure</code>标志，因为没有配置证书</p></blockquote><p id="f9bd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在运行您之前得到的<code class="du mk ml mm lu b">loft use vcluster</code>命令，您就成功了。现在，您可以在vCluster中运行<code class="du mk ml mm lu b">kubectl</code>命令。</p><h1 id="4fc7" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">离别赠言</h1><p id="c824" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">Loft是一个非常方便的解决方案，可以管理在单个集群上运行项目的多个团队，甚至可以管理来自多个发行版的集群。我在这里介绍了初始设置，但是这个工具还有更多内容。您可以安排集群以节省成本，限制分配给虚拟集群的配额，在集群之间共享机密等等。</p></div></div>    
</body>
</html>