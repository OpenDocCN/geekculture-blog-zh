<html>
<head>
<title>Dismantling the distributed monolith — Our microservices journey from orchestration to choreography</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">拆除分布式整体——我们的微服务从编排到编排之旅</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/dismantling-the-distributed-monolith-b24b4211966a?source=collection_archive---------7-----------------------#2022-02-04">https://medium.com/geekculture/dismantling-the-distributed-monolith-b24b4211966a?source=collection_archive---------7-----------------------#2022-02-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><blockquote class="if ig ih"><p id="300c" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">服务是一种有目的的软件功能，不同的客户可以使用</p></blockquote><h1 id="64d1" class="jh ji hi bd jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke bi translated">背景</h1><p id="dacc" class="pw-post-body-paragraph ii ij hi il b im kf io ip iq kg is it kh ki iw ix kj kk ja jb kl km je jf jg hb bi translated">几年前，当我们开始为公司进军欧亚大陆构建一个计费和财务系统时，我们选择了团队已经熟悉的工具和技术。</p><p id="e05f" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated">当时，我们已经使用Spring Boot和网飞操作系统堆栈建立了几个共享微服务(T1)——发送通知、安全存储文档等服务。这些服务由不同的客户端应用程序使用，从而消除了代码和工作的重复。他们在公司里大受欢迎。</p><p id="957d" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated">此外，当时我们有几项服务被公司外部的合作伙伴和客户访问。我们使用WSO2作为这些外部可用服务的API网关。用他们自己的话来说，WSO2还通过他们的企业集成能力提供了“低代码微服务集成方法”。</p><p id="3d8e" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated">这些现有的工具以及我们被要求在不到10个月的时间内构建这个系统的事实，塑造了我们对新的计费和财务系统应该如何构建的看法。</p><h1 id="7f44" class="jh ji hi bd jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke bi translated">版本1 —编排</h1><figure class="ko kp kq kr fd ks er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es kn"><img src="../Images/4fd0369375a9a399c41032d5fae26cbe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xIzB_iinfESj6avNN_0QXQ.png"/></div></div><figcaption class="kz la et er es lb lc bd b be z dx">Microservices orchestration</figcaption></figure><p id="3da7" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated">比方说，其中一个客户在队列中丢弃了一个事件，表明已经下了一个订单。计费和财务系统应记录费用，生成发票，并在总分类账中做分录。我们使用WSO2为每个任务调用不同的服务(即编排)。如果这些任务中的任何一个失败，WSO2 orchestrator将负责一个“<em class="ik">回滚”</em>。</p><p id="4423" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated">每个微服务都是一个提供REST服务的Spring Boot web应用。它们通过HTTP请求被调用，并通过相同的HTTP连接同步提供响应。</p><h2 id="048d" class="ld ji hi bd jj le lf lg jn lh li lj jr kh lk ll jv kj lm ln jz kl lo lp kd lq bi translated">利弊</h2><p id="640a" class="pw-post-body-paragraph ii ij hi il b im kf io ip iq kg is it kh ki iw ix kj kk ja jb kl km je jf jg hb bi translated">这种架构的主要优点是它利用了团队已经非常熟悉的工具和技术。</p><p id="0815" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated">另一个优势是orchestrator使得在运行时出现故障时保持数据一致性成为可能。微服务中的每个事务都有一个对应的<em class="ik">反向</em>(也称为补偿)事务。因此，如果WSO2 orchestrator在调用第n个微服务时遇到错误，它可以通过调用前n-1个微服务上的反向事务来执行“<em class="ik">回滚</em>”。</p><figure class="ko kp kq kr fd ks er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es lr"><img src="../Images/50fe6d82fe305caef455f76f8709acfa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l3tz-tB7cayf18fOqL-rlA.png"/></div></div><figcaption class="kz la et er es lb lc bd b be z dx">Performing a rollback</figcaption></figure><p id="1f36" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated">这种架构的主要缺点是紧密耦合导致的团队间依赖性。分布式架构的目标之一是允许快速并行开发。然而，基于编排的微服务架构导致了一个分布式的整体。在很多方面，它们都像一个整体一样存在相互依赖的问题。实际上，每个变更都需要多个团队来协调发布。</p><p id="a8be" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated">脆弱是这种设置的下一个突出缺点。如果单个服务出现故障，甚至短时间内表现不佳，整个端到端流程都会失败。</p><p id="0eb0" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated">此外，必须优先解决性能问题，因为这种同步请求-响应设置不能容忍运行缓慢的事务。</p><h1 id="574f" class="jh ji hi bd jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke bi translated">版本2 —编排</h1><figure class="ko kp kq kr fd ks er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es ls"><img src="../Images/a332de8ef3b06b1c095f4ad45a113cb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zbQ-JAUM1y9Ix7lm-xXoEw.png"/></div></div><figcaption class="kz la et er es lb lc bd b be z dx">Choreography</figcaption></figure><blockquote class="if ig ih"><p id="d3ec" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">贫瘠的土地上长不出水稻~中国古谚</p></blockquote><p id="1763" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated">对我们来说幸运的是，我们又有机会构建相同的系统——这一次，取代公司现有的传统计费和财务平台。在这一年中，我们已经脱离了网飞的OSS堆栈，转而采用了面向微服务的Kubernetes。Kafka在公司内部被用于数据传输，已经成为公司DNA的一部分。</p><h2 id="bfe8" class="ld ji hi bd jj le lf lg jn lh li lj jr kh lk ll jv kj lm ln jz kl lo lp kd lq bi translated">作为一等公民的事件</h2><p id="cd48" class="pw-post-body-paragraph ii ij hi il b im kf io ip iq kg is it kh ki iw ix kj kk ja jb kl km je jf jg hb bi translated">在版本1中，我们的微服务不支持事件感知。它们是通过WSO2 orchestrator同步调用的简单REST web服务。这导致了服务之间非常紧密的耦合。在新的架构中，重要的是要放松耦合，这样团队可以更加独立，开发可以进行得更快。</p><p id="1d82" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated">我们不得不重建我们的微服务来收听Kafka事件主题，并发布一些他们自己的主题。我们必须重新划分服务边界，以确保事务不会在微服务之间分割。我们不得不拆除管弦乐队。</p><p id="dc94" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated">在版本1中，我们的微服务是基于请求-响应的REST web服务。在版本2中，它们是事件驱动的组件。</p><figure class="ko kp kq kr fd ks er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es lt"><img src="../Images/648d612c364f686d628100787f68afbc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cFl1f3tKqb89j-h_zIrjVw.png"/></div></div><figcaption class="kz la et er es lb lc bd b be z dx">The New Billing &amp; Finance System</figcaption></figure><h1 id="824b" class="jh ji hi bd jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke bi translated">参考</h1><div class="lu lv ez fb lw lx"><a rel="noopener follow" target="_blank" href="/interviewnoodle/how-to-explain-an-event-driven-architecture-to-your-great-grandpa-10f19063d393"><div class="ly ab dw"><div class="lz ab ma cl cj mb"><h2 class="bd hj fi z dy mc ea eb md ed ef hh bi translated">如何向你的曾祖父解释事件驱动架构</h2><div class="me l"><h3 class="bd b fi z dy mc ea eb md ed ef dx translated">事件、命令和不变性</h3></div><div class="mf l"><p class="bd b fp z dy mc ea eb md ed ef dx translated">medium.com</p></div></div><div class="mg l"><div class="mh l mi mj mk mg ml kx lx"/></div></div></a></div><div class="lu lv ez fb lw lx"><a rel="noopener follow" target="_blank" href="/@apratim.shaw/an-architecture-of-necessity-8339edf5e560"><div class="ly ab dw"><div class="lz ab ma cl cj mb"><h2 class="bd hj fi z dy mc ea eb md ed ef hh bi translated">必然的建筑</h2><div class="me l"><h3 class="bd b fi z dy mc ea eb md ed ef dx translated">计费和财务系统的目标和原则</h3></div><div class="mf l"><p class="bd b fp z dy mc ea eb md ed ef dx translated">medium.com</p></div></div><div class="mg l"><div class="mm l mi mj mk mg ml kx lx"/></div></div></a></div><div class="lu lv ez fb lw lx"><a href="https://bootcamp.uxdesign.cc/ants-go-away-there-is-no-food-here-4ca964e3b2f3" rel="noopener follow" target="_blank"><div class="ly ab dw"><div class="lz ab ma cl cj mb"><h2 class="bd hj fi z dy mc ea eb md ed ef hh bi translated">蚂蚁，走开！这里没有食物</h2><div class="me l"><h3 class="bd b fi z dy mc ea eb md ed ef dx translated">错误处理不应该是事后的想法</h3></div><div class="mf l"><p class="bd b fp z dy mc ea eb md ed ef dx translated">bootcamp.uxdesign.cc</p></div></div><div class="mg l"><div class="mn l mi mj mk mg ml kx lx"/></div></div></a></div><div class="lu lv ez fb lw lx"><a href="https://blog.christianposta.com/microservices/netflix-oss-or-kubernetes-how-about-both/" rel="noopener  ugc nofollow" target="_blank"><div class="ly ab dw"><div class="lz ab ma cl cj mb"><h2 class="bd hj fi z dy mc ea eb md ed ef hh bi translated">网飞OSS，春云，还是Kubernetes？全部怎么样！</h2><div class="me l"><h3 class="bd b fi z dy mc ea eb md ed ef dx translated">我在2016年6月O'Reilly出版的《面向Java开发人员的微服务》一书中谈到了其中的一些内容(即将发布！)，但是我想…</h3></div><div class="mf l"><p class="bd b fp z dy mc ea eb md ed ef dx translated">blog.christianposta.com</p></div></div><div class="mg l"><div class="mo l mi mj mk mg ml kx lx"/></div></div></a></div></div></div>    
</body>
</html>