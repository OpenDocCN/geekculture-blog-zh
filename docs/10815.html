<html>
<head>
<title>Idempotent Data Pipeline</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">幂等数据流水线</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/idempotent-data-pipeline-ba4c962d8d8c?source=collection_archive---------0-----------------------#2022-02-17">https://medium.com/geekculture/idempotent-data-pipeline-ba4c962d8d8c?source=collection_archive---------0-----------------------#2022-02-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="9786" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">使您的数据管道可靠</h2></div><p id="343b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">《牛津词典》中定义的幂等元是一个集合中的一个元素，当它自身相乘或运算时，其值不变。</p><p id="2dab" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可能会问，这与我的数据管道有什么关系？帮我拿着啤酒，好吗？</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div class="er es jt"><img src="../Images/3f41880122efe68acbb928bcdd5a9c16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1278/format:webp/1*u-UiPZkxnrNdL1qeofi-Lw.png"/></div><figcaption class="kb kc et er es kd ke bd b be z dx">Image from<a class="ae kf" href="https://thesaurus.plus/thesaurus/idempotent" rel="noopener ugc nofollow" target="_blank"> Thesaurus</a></figcaption></figure><h1 id="19ab" class="kg kh hi bd ki kj kk kl km kn ko kp kq io kr ip ks ir kt is ku iu kv iv kw kx bi translated">大纲:</h1><ol class=""><li id="847d" class="ky kz hi iz b ja la jd lb jg lc jk ld jo le js lf lg lh li bi translated">什么是幂等数据管道</li><li id="13db" class="ky kz hi iz b ja lj jd lk jg ll jk lm jo ln js lf lg lh li bi translated">幂等数据管道的优势</li><li id="4961" class="ky kz hi iz b ja lj jd lk jg ll jk lm jo ln js lf lg lh li bi translated">如何使数据管道幂等</li><li id="577a" class="ky kz hi iz b ja lj jd lk jg ll jk lm jo ln js lf lg lh li bi translated">结论</li></ol><h2 id="57a3" class="lo kh hi bd ki lp lq lr km ls lt lu kq jg lv lw ks jk lx ly ku jo lz ma kw mb bi translated">1.什么是幂等数据管道</h2><p id="3e1b" class="pw-post-body-paragraph ix iy hi iz b ja la ij jc jd lb im jf jg mc ji jj jk md jm jn jo me jq jr js hb bi translated">多次运行从源获取数据并将其加载到关系数据库中的管道可能会导致数据库中出现重复值，从而导致错误的度量和许多其他错误。使管道幂等将防止这一点，并使你成为一个更好的工程师。</p><p id="11de" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">换句话说，使用相同的输入多次运行数据管道将始终产生相同的输出。</p><h2 id="55b9" class="lo kh hi bd ki lp lq lr km ls lt lu kq jg lv lw ks jk lx ly ku jo lz ma kw mb bi translated">2.幂等数据管道的优势</h2><p id="3969" class="pw-post-body-paragraph ix iy hi iz b ja la ij jc jd lb im jf jg mc ji jj jk md jm jn jo me jq jr js hb bi translated">下面列出了幂等数据管道的一些优点</p><ul class=""><li id="dabf" class="ky kz hi iz b ja jb jd je jg mf jk mg jo mh js mi lg lh li bi translated">这确保了在回填的情况下不会在存储位置产生重复的数据</li><li id="9442" class="ky kz hi iz b ja lj jd lk jg ll jk lm jo ln js mi lg lh li bi translated">它使得管道中的转换结果是可预测的</li><li id="abed" class="ky kz hi iz b ja lj jd lk jg ll jk lm jo ln js mi lg lh li bi translated">它有助于减少数据存储费用</li><li id="ac3e" class="ky kz hi iz b ja lj jd lk jg ll jk lm jo ln js mi lg lh li bi translated">它还有助于删除旧的/不需要的数据</li></ul><h2 id="db7a" class="lo kh hi bd ki lp lq lr km ls lt lu kq jg lv lw ks jk lx ly ku jo lz ma kw mb bi translated">3.如何使数据管道幂等</h2><p id="a5a7" class="pw-post-body-paragraph ix iy hi iz b ja la ij jc jd lb im jf jg mc ji jj jk md jm jn jo me jq jr js hb bi translated">数据管道中最常见的步骤是</p><ul class=""><li id="1c67" class="ky kz hi iz b ja jb jd je jg mf jk mg jo mh js mi lg lh li bi translated">从一个或多个来源提取数据</li><li id="b339" class="ky kz hi iz b ja lj jd lk jg ll jk lm jo ln js mi lg lh li bi translated">执行一些转换</li><li id="f590" class="ky kz hi iz b ja lj jd lk jg ll jk lm jo ln js mi lg lh li bi translated">加载到数据仓库</li></ul><p id="5616" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">幂等管道将确保，如果在列出的步骤中出现任何错误，仍然会产生预期的结果作为输出。</p><p id="907d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果在加载阶段出现错误，数据没有完全加载到数据仓库中，我们的幂等管道应该从数据仓库中删除半加载的数据，并在管道重新运行时将新数据作为完全加载的数据存储。只有当数据管道重新运行时将产生所需的相同数据时，才建议这样做。这种模式被称为<em class="mj">删除-写入</em>模式。Spark、Snowflake等技术提供了其他幂等设计模式，如<a class="ae kf" href="https://sparkbyexamples.com/spark/spark-overwrite-the-output-directory/" rel="noopener ugc nofollow" target="_blank"><em class="mj">Spark-overwrite</em></a><em class="mj">。</em></p><p id="5e02" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下面提供了一种在python中实现<em class="mj">删除-写入</em>模式的方法:</p><figure class="ju jv jw jx fd jy"><div class="bz dy l di"><div class="mk ml l"/></div><figcaption class="kb kc et er es kd ke bd b be z dx">delete_write_idempotent pipeline</figcaption></figure><p id="3ade" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在上面的代码片段中，我实现了一个简单的ETL管道，它从s3桶中获取parquet文件，并使用pandas <em class="mj"> read_parquet来读取它。</em>在我的例子中，数据随后根据识别的业务逻辑进行转换，删除所有<em class="mj"> customer_id </em>等于<em class="mj">的行。</em><em class="mj">delete _ write</em>模式在ETL的最后部分实现。这里，<em class="mj"> load_dwh </em>函数接受两个参数<em class="mj"> dataframe </em>和<em class="mj"/><em class="mj">output _ location，</em>检查<em class="mj"> output_location </em>是否已经存在，如果加载数据时出现错误，则删除<em class="mj"> output_location </em>中指定的文件夹，并用新数据重新创建它。</p><h2 id="037e" class="lo kh hi bd ki lp lq lr km ls lt lu kq jg lv lw ks jk lx ly ku jo lz ma kw mb bi translated">4.结论</h2><p id="f3f7" class="pw-post-body-paragraph ix iy hi iz b ja la ij jc jd lb im jf jg mc ji jj jk md jm jn jo me jq jr js hb bi translated">拥有一个幂等数据管道可以避免数据工程师的许多头痛，特别是当数据管道由于错误或业务逻辑改变而需要多次重新运行时。</p><h2 id="2295" class="lo kh hi bd ki lp lq lr km ls lt lu kq jg lv lw ks jk lx ly ku jo lz ma kw mb bi translated">参考和进一步阅读</h2><p id="96a0" class="pw-post-body-paragraph ix iy hi iz b ja la ij jc jd lb im jf jg mc ji jj jk md jm jn jo me jq jr js hb bi translated">Startdataengineering有一篇关于<a class="ae kf" href="https://www.startdataengineering.com/post/why-how-idempotent-data-pipeline/" rel="noopener ugc nofollow" target="_blank">制造数据管道幂等元</a>的文章</p><p id="3b67" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Fivetran解释了数据管道中的<a class="ae kf" href="https://www.fivetran.com/blog/what-is-idempotence" rel="noopener ugc nofollow" target="_blank">幂等性</a></p><p id="5c25" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae kf" href="https://www.fivetran.com/blog/idempotence-failure-proofs-data-pipeline" rel="noopener ugc nofollow" target="_blank">幂等性及其如何防止数据管道故障</a>five tran</p></div></div>    
</body>
</html>