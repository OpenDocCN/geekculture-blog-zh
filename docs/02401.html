<html>
<head>
<title>MongoDB Replica Set in AWS ECS with Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带有Terraform的AWS ECS中的MongoDB副本集</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/mongodb-replica-set-in-aws-ecs-with-terraform-4621451c6190?source=collection_archive---------5-----------------------#2021-05-14">https://medium.com/geekculture/mongodb-replica-set-in-aws-ecs-with-terraform-4621451c6190?source=collection_archive---------5-----------------------#2021-05-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="d074" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">今天我们将讨论使用ECS设置MongoDB副本集的解决方案。虽然可以使用Fargate启动类型在ECS中设置MongoDB，但是我们将遵循ECS中使用EC2启动类型的持久工作负载的最佳实践。为了允许该解决方案的可再现工件，我们将对所有配置使用Terraform。欢迎您重用此模板并对其进行相应的修改。</p></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><h1 id="b287" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">高级图表</h1><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es ki"><img src="../Images/9ca221e3603898ef1030529c596d3dfa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R97cteVloFJKxpSYxJLN7A.png"/></div></div></figure><p id="f98d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如上图所示，我们将使用EC2作为ECS群集的计算资源。为了简单起见，只使用1个EC2来运行3个MongoDB节点，但是您可以添加多个EC2来最大化冗余。这是我们将要建造的</p><ol class=""><li id="e2c4" class="ku kv hi ih b ii ij im in iq kw iu kx iy ky jc kz la lb lc bi translated">1个EC2，使用ECS实例的ECS优化映像</li><li id="f50f" class="ku kv hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">3使用<a class="ae li" href="http://docker.io/bitnami/mongodb:4.4-debian-10" rel="noopener ugc nofollow" target="_blank"> Bitnami </a>镜像的MongoDB服务</li><li id="e27b" class="ku kv hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">1个ECS集群</li><li id="17b4" class="ku kv hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">1个NLB，用于将流量路由到主要和辅助MongoDB服务</li></ol></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><h1 id="2200" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">为什么Bitnami MongoDB图像</h1><p id="2f6b" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq ll is it iu lm iw ix iy ln ja jb jc hb bi translated">要使用docker设置副本集，您需要配置副本集配置并相应地添加节点。MongoDB官方映像不提供开箱即用的自动副本配置，因此我们将使用Bitnami MongoDB映像，它允许用户使用环境变量配置副本集。</p></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><h1 id="8c0a" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">必备知识</h1><p id="6807" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq ll is it iu lm iw ix iy ln ja jb jc hb bi translated">本文中分享的解决方案需要了解以下知识:-</p><ol class=""><li id="4532" class="ku kv hi ih b ii ij im in iq kw iu kx iy ky jc kz la lb lc bi translated">码头集装箱</li><li id="1734" class="ku kv hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">AWS IAM、EC2、网络负载平衡器、ECS服务和任务定义</li><li id="743f" class="ku kv hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">地形脚本</li><li id="4460" class="ku kv hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">MongoDB配置</li></ol></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><h1 id="a8ce" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">先决条件设置</h1><p id="9c00" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq ll is it iu lm iw ix iy ln ja jb jc hb bi translated">您需要以下工具来遵循此解决方案:-</p><ol class=""><li id="1a71" class="ku kv hi ih b ii ij im in iq kw iu kx iy ky jc kz la lb lc bi translated"><a class="ae li" href="https://code.visualstudio.com/" rel="noopener ugc nofollow" target="_blank"> Visual Studio代码</a></li><li id="944e" class="ku kv hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated"><a class="ae li" href="https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html" rel="noopener ugc nofollow" target="_blank"> AWS CLI安装</a></li><li id="31ff" class="ku kv hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated"><a class="ae li" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-working-with-install-plugin.html" rel="noopener ugc nofollow" target="_blank"> AWS会话管理器插件</a></li><li id="abae" class="ku kv hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated"><a class="ae li" href="https://www.mongodb.com/products/compass" rel="noopener ugc nofollow" target="_blank"> MongoDB罗盘</a></li><li id="e1a1" class="ku kv hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated"><a class="ae li" href="https://www.terraform.io/downloads.html" rel="noopener ugc nofollow" target="_blank"> Terraform v0.15+ </a></li></ol><h1 id="f33e" class="jk jl hi bd jm jn lo jp jq jr lp jt ju jv lq jx jy jz lr kb kc kd ls kf kg kh bi translated">VPC货运公司</h1><p id="7b39" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq ll is it iu lm iw ix iy ln ja jb jc hb bi translated">在这个解决方案中，我们将对所有MongoDB服务使用<code class="du lt lu lv lw b">awsvpc</code>网络模式。这里的<a class="ae li" href="https://docs.aws.amazon.com/AmazonECS/latest/bestpracticesguide/networking-networkmode.html#networking-networkmode-awsvpc" rel="noopener ugc nofollow" target="_blank">参照</a>详细的<code class="du lt lu lv lw b">awsvpc</code>网络模式。<code class="du lt lu lv lw b">awsvpc</code>消耗每个EC2的网络接口或弹性网络接口(ENI)，每个EC2类型有一个有限的ENI。<a class="ae li" href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/container-instance-eni.html" rel="noopener ugc nofollow" target="_blank"> VPC货运</a>是一项新功能，允许我们使用<code class="du lt lu lv lw b">awsvpc</code>网络模式和EC2启动类型启动两倍的任务。但这是选择加入选项，您需要按照此<a class="ae li" href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/container-instance-eni.html" rel="noopener ugc nofollow" target="_blank">配置</a>来启用它，或者在ECS控制台中的帐户级别设置中启用，如下所示:-</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es lx"><img src="../Images/2770679dc0045ec249004720493394d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wvJT_cr-cR0WYWuqN2LRvg.png"/></div></div></figure></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><h1 id="6ecb" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">初始化项目</h1><p id="b2f6" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq ll is it iu lm iw ix iy ln ja jb jc hb bi translated">由于该项目是全面的一步一步来，我们将使用完成的项目进行解释。查看这里的<a class="ae li" href="https://github.com/jazztong/mongo-ecs-ha-tf.git" rel="noopener ugc nofollow" target="_blank">源代码</a>并配置AWS凭证。项目结构如下所示:-</p><figure class="kj kk kl km fd kn er es paragraph-image"><div class="er es ly"><img src="../Images/b9b7957591951b6d03b1bd60ddbefad0.png" data-original-src="https://miro.medium.com/v2/resize:fit:936/format:webp/1*267G-mtskJrlRlh6nZbwTA.png"/></div></figure></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><h1 id="f2ce" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">ECS服务模块</h1><p id="a300" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq ll is it iu lm iw ix iy ln ja jb jc hb bi translated">在项目中，有一个模块允许用户使用预定义的设置调配ECS服务。我们将浏览本模块的重要资源。</p><h2 id="bc5d" class="lz jl hi bd jm ma mb mc jq md me mf ju iq mg mh jy iu mi mj kc iy mk ml kg mm bi translated">aws _ ecs _服务资源</h2><p id="4f5e" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq ll is it iu lm iw ix iy ln ja jb jc hb bi translated">这是提供ECS服务的ECS服务资源。默认情况下，我们将其配置为使用<code class="du lt lu lv lw b">EC2</code>启动类型，并允许控制<code class="du lt lu lv lw b">load_balancer</code>设置。由于MongoDB节点不能同时运行多个任务，我们将<code class="du lt lu lv lw b">deployment_maximun_percent</code>配置为100。因此，任何新的部署都会立即停止现有任务。</p><figure class="kj kk kl km fd kn"><div class="bz dy l di"><div class="mn mo l"/></div></figure><h2 id="c7e0" class="lz jl hi bd jm ma mb mc jq md me mf ju iq mg mh jy iu mi mj kc iy mk ml kg mm bi translated">aws_ecs_task_definition资源</h2><p id="d985" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq ll is it iu lm iw ix iy ln ja jb jc hb bi translated">我们需要任务定义来控制我们的容器如何在ECS中运行。下面的资源允许动态卷配置，这是持久化MongoDB数据的一个重要部分。为了使用<a class="ae li" href="https://docs.docker.com/storage/" rel="noopener ugc nofollow" target="_blank"> docker卷</a>来管理卷，我们添加了<code class="du lt lu lv lw b">docker_volume_configuration</code>部分来允许我们配置本地或其他卷驱动程序。<code class="du lt lu lv lw b">placementConstraints</code>配置还允许我们控制我们的容器/任务应该在哪个EC2实例中提供。您可以使用不同的标签创建3个不同的EC2，并确保它们分别在AZ和EC2中发布。</p><figure class="kj kk kl km fd kn"><div class="bz dy l di"><div class="mn mo l"/></div></figure></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><h1 id="b49d" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">初始化EC2实例</h1><p id="b15d" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq ll is it iu lm iw ix iy ln ja jb jc hb bi translated">我们使用EC2 ECS来优化AMI，但是我们需要自动配置ECS集群和一些ECS设置。EC2启动时将运行以下<code class="du lt lu lv lw b">user_data.tmpl.sh</code>。</p><blockquote class="mp mq mr"><p id="2fd4" class="if ig ms ih b ii ij ik il im in io ip mt ir is it mu iv iw ix mv iz ja jb jc hb bi translated">出于学习目的，我们在user_data中使用了简单的密码，您应该在实际的生产设置中使用SSH密钥而不是密码</p></blockquote><figure class="kj kk kl km fd kn"><div class="bz dy l di"><div class="mn mo l"/></div></figure></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><h1 id="95d9" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">mongo _主要资源</h1><p id="d5da" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq ll is it iu lm iw ix iy ln ja jb jc hb bi translated">我们将使用ecs-service模块创建一个MongoDB节点。在这个Mongo主节点中，我们使用一个环境变量、卷和挂载点来配置<code class="du lt lu lv lw b">Network Load Balancer</code>、Bitnami Mongo副本设置，以持久化数据。参考此处的<a class="ae li" href="https://github.com/bitnami/bitnami-docker-mongodb" rel="noopener ugc nofollow" target="_blank"> Bitnami Mongo图像配置</a>。</p><blockquote class="mp mq mr"><p id="c406" class="if ig ms ih b ii ij ik il im in io ip mt ir is it mu iv iw ix mv iz ja jb jc hb bi translated"><code class="du lt lu lv lw b">desired_count</code>必须设置为1才能成功供应，<code class="du lt lu lv lw b">placementConstraints</code>也必须配置为匹配EC2标签</p></blockquote><figure class="kj kk kl km fd kn"><div class="bz dy l di"><div class="mn mo l"/></div></figure></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><h1 id="8be2" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">mongo_secondary和mongo_arbiter资源</h1><p id="8aab" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq ll is it iu lm iw ix iy ln ja jb jc hb bi translated">我们将设置<code class="du lt lu lv lw b">mongo_secondary</code>和<code class="du lt lu lv lw b">mongo_arbiter</code>来形成一个完整的最小复制集。仲裁节点不用于复制数据，但它创建奇数个节点，以允许选举主节点。这是一种低成本的复制设置。如果您愿意，可以对第三个节点使用辅助模式。为了将<code class="du lt lu lv lw b">mongo_secondary</code>和<code class="du lt lu lv lw b">mongo_arbiter</code>链接到<code class="du lt lu lv lw b">mongo_primary</code>节点，我们将使用服务发现名称作为主机名，在<code class="du lt lu lv lw b">MONGO_INITIAL_PRIMARY_HOST</code>环境变量中将它们连接在一起。</p><figure class="kj kk kl km fd kn"><div class="bz dy l di"><div class="mn mo l"/></div></figure><figure class="kj kk kl km fd kn"><div class="bz dy l di"><div class="mn mo l"/></div></figure></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><h1 id="dcab" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">开始调配解决方案</h1><p id="4a71" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq ll is it iu lm iw ix iy ln ja jb jc hb bi translated">我们已经完成了该解决方案中的一些重要设置，让我们开始调配该解决方案。在Visual Studio代码中打开签出源代码。</p><blockquote class="mp mq mr"><p id="0434" class="if ig ms ih b ii ij ik il im in io ip mt ir is it mu iv iw ix mv iz ja jb jc hb bi translated">我们将使用Makefile进行所有的配置。如果您的计算机不支持Makefile，您可以使用Makefile中的本机脚本来运行</p><p id="84c3" class="if ig ms ih b ii ij ik il im in io ip mt ir is it mu iv iw ix mv iz ja jb jc hb bi translated">请确保在开始预配之前配置aws凭据</p></blockquote><h2 id="ecfd" class="lz jl hi bd jm ma mb mc jq md me mf ju iq mg mh jy iu mi mj kc iy mk ml kg mm bi translated">地形初始化</h2><p id="d402" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq ll is it iu lm iw ix iy ln ja jb jc hb bi translated">在项目根目录下运行<code class="du lt lu lv lw b">make init</code>来初始化Terraform项目。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es mw"><img src="../Images/a96efb5b72b92e60a0389cf933b448ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QVpaf1_KMCeWv_yM9cyuHQ.png"/></div></div></figure><h2 id="1277" class="lz jl hi bd jm ma mb mc jq md me mf ju iq mg mh jy iu mi mj kc iy mk ml kg mm bi translated">地形图</h2><p id="e03e" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq ll is it iu lm iw ix iy ln ja jb jc hb bi translated">在项目根中运行<code class="du lt lu lv lw b">make plan</code>来验证地形图。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es mx"><img src="../Images/7abf4af95d443196d371602dbf868ff9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d2sR2nMBfDguh5ZNMvrG7g.png"/></div></div></figure><h2 id="422c" class="lz jl hi bd jm ma mb mc jq md me mf ju iq mg mh jy iu mi mj kc iy mk ml kg mm bi translated">地形应用</h2><p id="5f50" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq ll is it iu lm iw ix iy ln ja jb jc hb bi translated">Terraform计划成功后，我们可以使用terraform计划将其配置到我们的环境中。运行<code class="du lt lu lv lw b">make apply</code>以提供Terraform脚本。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es my"><img src="../Images/88347d0f1f419096d90b844f636a6920.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PfC9o5ZU-PVj82oZ6TAY7w.png"/></div></div></figure></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><h1 id="8ee8" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">探索您的结果</h1><p id="febd" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq ll is it iu lm iw ix iy ln ja jb jc hb bi translated">太好了，你跟着我。此时，您应该成功地将整个副本集设置到您的帐户中。让我们检查您的AWS环境以验证结果。</p><h2 id="244b" class="lz jl hi bd jm ma mb mc jq md me mf ju iq mg mh jy iu mi mj kc iy mk ml kg mm bi translated">探索您的集群</h2><p id="8350" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq ll is it iu lm iw ix iy ln ja jb jc hb bi translated">打开您的ECS主目录，您应该会发现<code class="du lt lu lv lw b">mongo-ecs-cluster</code>提供了3个服务、3个任务和1个容器实例。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es mz"><img src="../Images/3773e032e6d2d977fffee5566950aa86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_g6xQ8KyjTp5jVikOzdplw.png"/></div></div></figure><h2 id="4a42" class="lz jl hi bd jm ma mb mc jq md me mf ju iq mg mh jy iu mi mj kc iy mk ml kg mm bi translated">mongo-ECS-主要服务</h2><p id="1d26" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq ll is it iu lm iw ix iy ln ja jb jc hb bi translated">打开<code class="du lt lu lv lw b">mongo-ecs-primary</code>服务，检查日志是否正确启动，如下所示:-</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es na"><img src="../Images/bff8bb0a65c14d4b5d2dfe962e67360b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H0K8ytVV-MshE1WYYzsS2g.png"/></div></div></figure><h2 id="d246" class="lz jl hi bd jm ma mb mc jq md me mf ju iq mg mh jy iu mi mj kc iy mk ml kg mm bi translated">EC2实例</h2><p id="f932" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq ll is it iu lm iw ix iy ln ja jb jc hb bi translated">探索您的EC2家庭控制台，您应该看到一个EC2供应。使用会话管理器登录到EC2，运行<code class="du lt lu lv lw b">sudo docker ps</code>，您将看到当前正在运行的容器，包括ECS代理容器。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div class="er es nb"><img src="../Images/89512f9304554a74b64d78ffcc4b64f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1388/format:webp/1*yYCqwaSt-R7J9D2Tw8NLhA.png"/></div></figure><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es nc"><img src="../Images/fa3938b5735335acb439d707f1cdba72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OkH1JiTB29WHl0NDRX0hug.png"/></div></div></figure><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es nd"><img src="../Images/54d71461a3b2ac5e19c51bdf79839ab5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Syh9ysAii0MtvG9B3wdh-A.png"/></div></div></figure><h2 id="8853" class="lz jl hi bd jm ma mb mc jq md me mf ju iq mg mh jy iu mi mj kc iy mk ml kg mm bi translated">网络负载平衡器</h2><p id="301a" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq ll is it iu lm iw ix iy ln ja jb jc hb bi translated">打开负载平衡器页面，您应该看到一个<code class="du lt lu lv lw b">Network Load Balancer</code>被提供。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es ne"><img src="../Images/2fa9da6c143e4b55a8b0590e723599bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xpZHNWTsRkXnAC4Jg5pENQ.png"/></div></div></figure></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><h1 id="c9cc" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">测试来自NLB的连接</h1><p id="20a9" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq ll is it iu lm iw ix iy ln ja jb jc hb bi translated">让我们使用MongoDB Compass测试到MongoDB主节点的连接。在terraform输出中使用NLB DNS并填写凭据。创建一个新的数据库，并记录以验证它正在工作。</p><blockquote class="mp mq mr"><p id="c28b" class="if ig ms ih b ii ij ik il im in io ip mt ir is it mu iv iw ix mv iz ja jb jc hb bi translated">如果不更改默认值，默认用户名为<code class="du lt lu lv lw b">root</code>，密码为<code class="du lt lu lv lw b">mypassword</code></p></blockquote><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es nf"><img src="../Images/8b2af0448345c92e4beab0cc405ecb64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A5a_j-4Ze6te4iRTsuOm9g.png"/></div></div></figure><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es ng"><img src="../Images/b7057fe68221287eb6e06f52682ca881.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z0_K_UOkEu8Qpm0QiX8luw.png"/></div></div></figure></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><h1 id="01a3" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">故障转移测试</h1><p id="528b" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq ll is it iu lm iw ix iy ln ja jb jc hb bi translated">使用MongoDB Compass通过NLB DNS连接到主节点和辅助节点。我们将执行故障转移测试，以关闭主节点，并确保辅助节点上的故障转移正常工作。</p><h2 id="4bf1" class="lz jl hi bd jm ma mb mc jq md me mf ju iq mg mh jy iu mi mj kc iy mk ml kg mm bi translated">连接到主节点</h2><p id="e6fa" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq ll is it iu lm iw ix iy ln ja jb jc hb bi translated">使用MongoDB Compass通过NLB DNS连接到主节点，如下所示。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es nh"><img src="../Images/59984a2b7f1748b44cb935ed2bf4defa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2kg11hoJQTLcG1CVEiVNuA.png"/></div></div></figure><h2 id="ac48" class="lz jl hi bd jm ma mb mc jq md me mf ju iq mg mh jy iu mi mj kc iy mk ml kg mm bi translated">连接到辅助节点</h2><p id="9bc5" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq ll is it iu lm iw ix iy ln ja jb jc hb bi translated">使用MongoDB Compass连接到辅助节点。使用端口<code class="du lt lu lv lw b">27018</code>，因为它配置了一个不同于NLB的端口来路由到辅助节点。由于它是一个辅助节点，当我们连接到它时，我们需要指定Read Preference为<code class="du lt lu lv lw b">PrimaryPreffered</code>。验证不允许辅助节点执行写操作。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es ni"><img src="../Images/b89e8841cf4b338add95be924140fc4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E7p2B9xK1wi_riM-CTallg.png"/></div></div></figure><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es nj"><img src="../Images/7e5c8f789a8f78067f1949161669be6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2g0cz6ZPXwAix-kTWiDPMg.png"/></div></div></figure><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es nk"><img src="../Images/8a6468fb4969ec7882d6bb90a8ac7de0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Dkjh9U5HO16hPP_bcSfXKg.png"/></div></div></figure><h2 id="fbda" class="lz jl hi bd jm ma mb mc jq md me mf ju iq mg mh jy iu mi mj kc iy mk ml kg mm bi translated">停止MongoDB主任务</h2><p id="387d" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq ll is it iu lm iw ix iy ln ja jb jc hb bi translated">打开ECS home，并查找MongoDB主服务。在任务列表中，停止任务来模拟MongoDB主节点的宕机。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es nl"><img src="../Images/407349222a02f340af795a6887480a77.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wBaYjyfQk5WNMZ1cSblnXA.png"/></div></div></figure><h2 id="2f4f" class="lz jl hi bd jm ma mb mc jq md me mf ju iq mg mh jy iu mi mj kc iy mk ml kg mm bi translated">观察辅助节点成为主节点</h2><p id="119f" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq ll is it iu lm iw ix iy ln ja jb jc hb bi translated">观察辅助节点，故障切换将在1分钟内发生。辅助节点将成为主节点，并允许执行写操作。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es nm"><img src="../Images/882103382a05460a0d3d17a09937d569.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7SnJ4DkoKsN8a7gqyZDvWw.png"/></div></div></figure><h2 id="4e70" class="lz jl hi bd jm ma mb mc jq md me mf ju iq mg mh jy iu mi mj kc iy mk ml kg mm bi translated">旧主节点正在恢复</h2><p id="8376" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq ll is it iu lm iw ix iy ln ja jb jc hb bi translated">Bitnami映像的特性之一是恢复副本集，以强制原始主节点成为主节点。观察MongoDB主ECS服务，直到它创建一个新任务，当它稳定时，它将接管主节点。它允许系统返回到其原始状态，而无需在应用程序端进行更改。</p></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><h1 id="cb6b" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">减去</h1><p id="a53c" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq ll is it iu lm iw ix iy ln ja jb jc hb bi translated">我们使用Terraform构建所有组件，如果出现问题，它允许我们轻松地重建。我希望你喜欢这个解决方案，并让我知道如果有任何问题使用模板。</p><div class="nn no ez fb np nq"><a href="https://github.com/jazztong/mongo-ecs-ha-tf" rel="noopener  ugc nofollow" target="_blank"><div class="nr ab dw"><div class="ns ab nt cl cj nu"><h2 class="bd hj fi z dy nv ea eb nw ed ef hh bi translated">jazztong/mongo-ecs-ha-tf</h2><div class="nx l"><h3 class="bd b fi z dy nv ea eb nw ed ef dx translated">使用terraform演示Mongo ECS副本设置，它将使用EC2启动类型Run在ECS中设置3个MongoDb节点…</h3></div><div class="ny l"><p class="bd b fp z dy nv ea eb nw ed ef dx translated">github.com</p></div></div><div class="nz l"><div class="oa l ob oc od nz oe ks nq"/></div></div></a></div></div></div>    
</body>
</html>