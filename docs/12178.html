<html>
<head>
<title>Monitoring Websites Part-2 Email Alerting</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">监控网站第2部分电子邮件警报</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/monitoring-websites-part-2-email-alerting-b761bd6cc500?source=collection_archive---------6-----------------------#2022-04-30">https://medium.com/geekculture/monitoring-websites-part-2-email-alerting-b761bd6cc500?source=collection_archive---------6-----------------------#2022-04-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/></div><div class="ab cl if ig gp ih" role="separator"><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik"/></div><div class="hb hc hd he hf"><figure class="in io ip iq fd ir er es paragraph-image"><div role="button" tabindex="0" class="is it di iu bf iv"><div class="er es im"><img src="../Images/e29061e77cbae2a0a4e60a81d9f0d49d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LcjWrI-rQZ_z1pMKJ2S0rw.png"/></div></div></figure><h1 id="3d3c" class="iy iz hi bd ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv bi translated">简介:</h1><p id="6276" class="pw-post-body-paragraph jw jx hi jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt hb bi translated">在本文中，我们将集成google SMTP邮件服务器。此外，我们将了解如何在网站关闭或网站TLS证书到期不到一个月时创建电子邮件通知。如果你是第一次访问，请在这里浏览这篇文章的第一部分。</p><h1 id="4b5a" class="iy iz hi bd ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv bi translated">观众</h1><p id="e9e6" class="pw-post-body-paragraph jw jx hi jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt hb bi translated">开发人员、系统管理员、DevOps。这是一篇监控网站和电子邮件警报的实用实践文章。</p><h1 id="567e" class="iy iz hi bd ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv bi translated">网络安装程序</h1><ul class=""><li id="d91d" class="kv kw hi jy b jz ka kd ke kh kx kl ky kp kz kt la lb lc ld bi translated">黑盒出口设置，Grafana，普罗米修斯设置。</li><li id="8103" class="kv kw hi jy b jz le kd lf kh lg kl lh kp li kt la lb lc ld bi translated">用Grafana安装SMTP服务器。</li><li id="e929" class="kv kw hi jy b jz le kd lf kh lg kl lh kp li kt la lb lc ld bi translated">为网站状态创建电子邮件通知。</li><li id="199a" class="kv kw hi jy b jz le kd lf kh lg kl lh kp li kt la lb lc ld bi translated">为TLS证书过期创建电子邮件通知。</li></ul><h1 id="1940" class="iy iz hi bd ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv bi translated">文件夹结构</h1><ul class=""><li id="2a1f" class="kv kw hi jy b jz ka kd ke kh kx kl ky kp kz kt la lb lc ld bi translated">让我们克隆包含源代码的repo。</li></ul><pre class="in io ip iq fd lj lk ll lm aw ln bi"><span id="6469" class="lo iz hi lk b fi lp lq l lr ls"><strong class="lk hj">git clone </strong><a class="ae ku" href="https://github.com/cmjagtap/Website-Monitoring" rel="noopener ugc nofollow" target="_blank"><strong class="lk hj">https://github.com/cmjagtap/Website-Monitoring</strong></a></span></pre><h1 id="0942" class="iy iz hi bd ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv bi translated">黑盒出口设置，Grafana，普罗米修斯设置。</h1><ul class=""><li id="142c" class="kv kw hi jy b jz ka kd ke kh kx kl ky kp kz kt la lb lc ld bi translated">按照<a class="ae ku" rel="noopener" href="/geekculture/monitoring-websites-using-grafana-and-prometheus-69ccf936310c">这篇文章建立黑盒出口商，格拉夫纳，普罗米修斯。</a></li></ul><blockquote class="lt lu lv"><p id="1a1a" class="jw jx lw jy b jz lx kb kc kd ly kf kg lz ma kj kk mb mc kn ko md me kr ks kt hb bi translated">我已经在前一篇文章中解释了这个设置。我跳过这一步。</p></blockquote><h1 id="bbfe" class="iy iz hi bd ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv bi translated">使用Grafana设置SMTP服务器</h1><ul class=""><li id="e4ad" class="kv kw hi jy b jz ka kd ke kh kx kl ky kp kz kt la lb lc ld bi translated">如果您遵循了上述文章中的正确步骤，那么您应该已经准备好了下面的仪表板。</li></ul><figure class="in io ip iq fd ir er es paragraph-image"><div role="button" tabindex="0" class="is it di iu bf iv"><div class="er es im"><img src="../Images/34db6e88b9bc78696a2c9a8a00ac1c24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gT8FtGr4TCaiNNzzg9nsfg.png"/></div></div><figcaption class="mf mg et er es mh mi bd b be z dx">Dashboard</figcaption></figure><ul class=""><li id="4689" class="kv kw hi jy b jz lx kd ly kh mj kl mk kp ml kt la lb lc ld bi translated">现在，导航到<strong class="jy hj"> grafana.ini </strong>并编辑SMTP部分，如下图所示。</li></ul><figure class="in io ip iq fd ir er es paragraph-image"><div role="button" tabindex="0" class="is it di iu bf iv"><div class="er es mm"><img src="../Images/d69f38afbd29737903474e8010f83ef4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1ZXAS0JPXo7WOZVKEhpvug.png"/></div></div><figcaption class="mf mg et er es mh mi bd b be z dx">SMTP Server Setup</figcaption></figure><ul class=""><li id="5cd1" class="kv kw hi jy b jz lx kd ly kh mj kl mk kp ml kt la lb lc ld bi translated">将<strong class="jy hj"> <em class="lw">用户</em> </strong>替换为您的<strong class="jy hj"> Gmail地址</strong></li><li id="7294" class="kv kw hi jy b jz le kd lf kh lg kl lh kp li kt la lb lc ld bi translated">用您的<strong class="jy hj"> Gmail地址</strong>替换<strong class="jy hj"> <em class="lw"> from_address </em> </strong></li><li id="17db" class="kv kw hi jy b jz le kd lf kh lg kl lh kp li kt la lb lc ld bi translated">在<strong class="jy hj">密码部分</strong>添加您的<strong class="jy hj"> Gmail密码</strong></li><li id="a808" class="kv kw hi jy b jz le kd lf kh lg kl lh kp li kt la lb lc ld bi translated">使用以下命令重启Grafana容器，然后<br/> Grafana将选择您的新配置。</li></ul><pre class="in io ip iq fd lj lk ll lm aw ln bi"><span id="830d" class="lo iz hi lk b fi lp lq l lr ls"><strong class="lk hj">docker restart grafana</strong></span></pre><ul class=""><li id="15a0" class="kv kw hi jy b jz lx kd ly kh mj kl mk kp ml kt la lb lc ld bi translated">登录您的Gmail并导航到此地址<a class="ae ku" href="https://myaccount.google.com/lesssecureapps" rel="noopener ugc nofollow" target="_blank">https://myaccount.google.com/lesssecureapps</a>并启用不太安全的模式。</li></ul><figure class="in io ip iq fd ir er es paragraph-image"><div role="button" tabindex="0" class="is it di iu bf iv"><div class="er es mn"><img src="../Images/f46ecc411c3e6cd104d6d9a2cd48f1da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HJYeN3veNV-jfRBLVk1AsQ.png"/></div></div><figcaption class="mf mg et er es mh mi bd b be z dx">Gmail Setting</figcaption></figure><ul class=""><li id="962a" class="kv kw hi jy b jz lx kd ly kh mj kl mk kp ml kt la lb lc ld bi translated">让我们如下测试我们的电子邮件集成。</li><li id="e179" class="kv kw hi jy b jz le kd lf kh lg kl lh kp li kt la lb lc ld bi translated">导航至Grafana仪表盘，点击<strong class="jy hj">钟形图标</strong>，然后点击<strong class="jy hj">触点选项卡。</strong></li></ul><figure class="in io ip iq fd ir er es paragraph-image"><div role="button" tabindex="0" class="is it di iu bf iv"><div class="er es mo"><img src="../Images/24333a9773ab2935a7a8c0a8bebddc82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DVWHSyGZVR3cfb2lNYIqJg.png"/></div></div><figcaption class="mf mg et er es mh mi bd b be z dx">Alert Contact Tab</figcaption></figure><ul class=""><li id="1f5c" class="kv kw hi jy b jz lx kd ly kh mj kl mk kp ml kt la lb lc ld bi translated">编辑<strong class="jy hj"><em class="lw">grafana-default-email</em></strong>和<strong class="jy hj"> <em class="lw"> </em> </strong>添加您想要获取通知的电子邮件地址。</li><li id="e754" class="kv kw hi jy b jz le kd lf kh lg kl lh kp li kt la lb lc ld bi translated">您可以使用逗号分隔来添加多个电子邮件地址，如下所示。</li></ul><figure class="in io ip iq fd ir er es paragraph-image"><div role="button" tabindex="0" class="is it di iu bf iv"><div class="er es mp"><img src="../Images/f0edfc783c911feda763218f1622a993.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KG71gWebotHcOgBFhoRrkA.png"/></div></div><figcaption class="mf mg et er es mh mi bd b be z dx">Alert Contact Points</figcaption></figure><ul class=""><li id="2797" class="kv kw hi jy b jz lx kd ly kh mj kl mk kp ml kt la lb lc ld bi translated">现在点击右侧的<strong class="jy hj">测试按钮</strong>，然后点击<strong class="jy hj">发送通知。</strong></li><li id="5873" class="kv kw hi jy b jz le kd lf kh lg kl lh kp li kt la lb lc ld bi translated">现在，您应该会收到来自Grafana的测试邮件，如下所示。</li></ul><figure class="in io ip iq fd ir er es paragraph-image"><div role="button" tabindex="0" class="is it di iu bf iv"><div class="er es mq"><img src="../Images/bd7562231fc6516399b1bba1cf2a185c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CAdaRXZwnM_CVk7jLEpvDg.png"/></div></div><figcaption class="mf mg et er es mh mi bd b be z dx">Grafana email</figcaption></figure><ul class=""><li id="2c18" class="kv kw hi jy b jz lx kd ly kh mj kl mk kp ml kt la lb lc ld bi translated">点击<strong class="jy hj">保存接触点。</strong></li><li id="5226" class="kv kw hi jy b jz le kd lf kh lg kl lh kp li kt la lb lc ld bi translated">我们已经完成了Gmail SMTP服务器集成。</li></ul><h1 id="f19e" class="iy iz hi bd ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv bi translated">为网站状态创建电子邮件通知。</h1><ul class=""><li id="0277" class="kv kw hi jy b jz ka kd ke kh kx kl ky kp kz kt la lb lc ld bi translated">让我们为网站创建一个电子邮件通知，转到Grafana仪表板并添加一个新面板。</li><li id="9ef2" class="kv kw hi jy b jz le kd lf kh lg kl lh kp li kt la lb lc ld bi translated">在panel metric浏览器中，将以下命令添加到要创建通知的网站</li><li id="4417" class="kv kw hi jy b jz le kd lf kh lg kl lh kp li kt la lb lc ld bi translated"><strong class="jy hj"><em class="lw">probe _ success { instance = " https://github . com " }</em>T3】</strong></li><li id="8cf5" class="kv kw hi jy b jz le kd lf kh lg kl lh kp li kt la lb lc ld bi translated">在图例中添加<strong class="jy hj">{ {实例}} </strong></li><li id="3fd7" class="kv kw hi jy b jz le kd lf kh lg kl lh kp li kt la lb lc ld bi translated">右上角选择<strong class="jy hj">时间序列</strong></li></ul><blockquote class="lt lu lv"><p id="0517" class="jw jx lw jy b jz lx kb kc kd ly kf kg lz ma kj kk mb mc kn ko md me kr ks kt hb bi translated">如果通过复制粘贴上面的命令看不到数据，那么尝试手动输入。</p></blockquote><figure class="in io ip iq fd ir er es paragraph-image"><div role="button" tabindex="0" class="is it di iu bf iv"><div class="er es mr"><img src="../Images/bf3c4b49edff0d63dcb06549fd126be0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X8Tho2Sao7Nx2xtmienEnQ.png"/></div></div><figcaption class="mf mg et er es mh mi bd b be z dx">Create Web Panel</figcaption></figure><ul class=""><li id="971b" class="kv kw hi jy b jz lx kd ly kh mj kl mk kp ml kt la lb lc ld bi translated">点击保存，然后点击同一个面板中的<strong class="jy hj">警报选项卡</strong>，为该面板创建一个警报规则。</li></ul><figure class="in io ip iq fd ir er es paragraph-image"><div role="button" tabindex="0" class="is it di iu bf iv"><div class="er es ms"><img src="../Images/c0b34347c7e52b782e266832badd3f61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DzNQYAjNkvIK-0zYUeUogg.png"/></div></div><figcaption class="mf mg et er es mh mi bd b be z dx">Create Notification Rule</figcaption></figure><ul class=""><li id="a0c3" class="kv kw hi jy b jz lx kd ly kh mj kl mk kp ml kt la lb lc ld bi translated">现在，您应该会看到下面的选项卡</li></ul><figure class="in io ip iq fd ir er es paragraph-image"><div role="button" tabindex="0" class="is it di iu bf iv"><div class="er es mt"><img src="../Images/596b2d2e75d872cdfe107b918118a922.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7IMXHJkWVsqDwRRxR4YUfQ.png"/></div></div><figcaption class="mf mg et er es mh mi bd b be z dx">Create Notification Rule</figcaption></figure><ul class=""><li id="a12a" class="kv kw hi jy b jz lx kd ly kh mj kl mk kp ml kt la lb lc ld bi translated">在文件夹中创建一个新的文件夹名grafana(你可以自由选择任何名称)</li><li id="abf6" class="kv kw hi jy b jz le kd lf kh lg kl lh kp li kt la lb lc ld bi translated">然后查看突出显示的条件，它基本上是一个HTTP探测值，如果它变为零或低于零，您将会收到通知。</li></ul><figure class="in io ip iq fd ir er es paragraph-image"><div role="button" tabindex="0" class="is it di iu bf iv"><div class="er es mu"><img src="../Images/c0e88601adf770b97dbc9f4f777e8841.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2kgi9ekeJ49JsiqLsqkvNg.jpeg"/></div></div><figcaption class="mf mg et er es mh mi bd b be z dx">Create Notification Condition</figcaption></figure><ul class=""><li id="1534" class="kv kw hi jy b jz lx kd ly kh mj kl mk kp ml kt la lb lc ld bi translated">在第4节中，您可以添加自定义消息，如下所示。</li></ul><figure class="in io ip iq fd ir er es paragraph-image"><div role="button" tabindex="0" class="is it di iu bf iv"><div class="er es mv"><img src="../Images/9207923079fc1c20877f242468ddd0fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AfHOcio83z2O3I8EhsrOCw.png"/></div></div><figcaption class="mf mg et er es mh mi bd b be z dx">Notification Message</figcaption></figure><ul class=""><li id="3513" class="kv kw hi jy b jz lx kd ly kh mj kl mk kp ml kt la lb lc ld bi translated">现在保存并退出。</li><li id="34c9" class="kv kw hi jy b jz le kd lf kh lg kl lh kp li kt la lb lc ld bi translated">我们已经为单个网站启用了电子邮件通知，同样，您可以为您想要的多个网站复制它。</li></ul><h1 id="8afa" class="iy iz hi bd ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv bi translated">为TLS证书过期创建电子邮件通知。</h1><ul class=""><li id="b2fe" class="kv kw hi jy b jz ka kd ke kh kx kl ky kp kz kt la lb lc ld bi translated">让我们创建一个TLS证书到期的电子邮件通知，转到Grafana仪表板并添加一个新面板。</li><li id="2da8" class="kv kw hi jy b jz le kd lf kh lg kl lh kp li kt la lb lc ld bi translated">在panel metric browser中，添加以下命令和您想要跟踪TLS的网站。</li><li id="da0f" class="kv kw hi jy b jz le kd lf kh lg kl lh kp li kt la lb lc ld bi translated"><strong class="jy hj"><em class="lw">(probe _ SSL _ earliest _ cert _ expiry { instance = " https://github . com " }—time())/86400</em></strong></li><li id="ce59" class="kv kw hi jy b jz le kd lf kh lg kl lh kp li kt la lb lc ld bi translated">在图例中添加<strong class="jy hj">{ {实例}} </strong></li><li id="7de2" class="kv kw hi jy b jz le kd lf kh lg kl lh kp li kt la lb lc ld bi translated">右上角选择<strong class="jy hj">时间序列</strong></li><li id="382b" class="kv kw hi jy b jz le kd lf kh lg kl lh kp li kt la lb lc ld bi translated">该图表示证书的UNIX时间戳，我们使用<strong class="jy hj">时间()减去当前UNIX时间戳。</strong>因此，将获得证书剩余的确切秒数。然后我们正在划分<strong class="jy hj"> <em class="lw"> 86400 </em> </strong>在此之后将得到证书到期的剩余天数。</li></ul><figure class="in io ip iq fd ir er es paragraph-image"><div role="button" tabindex="0" class="is it di iu bf iv"><div class="er es mw"><img src="../Images/4154a034b53365b66a78888e877c2c14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OnHKPZgRajVjkJV5wXtm1w.png"/></div></div></figure><ul class=""><li id="d2b5" class="kv kw hi jy b jz lx kd ly kh mj kl mk kp ml kt la lb lc ld bi translated">点击保存，然后点击同一个面板中的<strong class="jy hj">警报选项卡</strong>，为该面板创建一个警报规则。</li></ul><figure class="in io ip iq fd ir er es paragraph-image"><div role="button" tabindex="0" class="is it di iu bf iv"><div class="er es im"><img src="../Images/12aa3a5f645438b86a29ce76edc3f6d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GUpO4vIiHpaLpIUqQrDtIg.png"/></div></div></figure><ul class=""><li id="a945" class="kv kw hi jy b jz lx kd ly kh mj kl mk kp ml kt la lb lc ld bi translated">在文件夹中创建一个新的文件夹名grafana(你可以自由选择任何名称)</li><li id="1798" class="kv kw hi jy b jz le kd lf kh lg kl lh kp li kt la lb lc ld bi translated">然后查看突出显示的条件，这基本上是一个条件，如果证书到期少于30天，那么你会收到通知。</li></ul><figure class="in io ip iq fd ir er es paragraph-image"><div role="button" tabindex="0" class="is it di iu bf iv"><div class="er es mu"><img src="../Images/d7a881de3c15a796c8ae55ea5aed7ab6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Fomh4rfOGun5HOCyzzloRw.jpeg"/></div></div></figure><blockquote class="lt lu lv"><p id="81e1" class="jw jx lw jy b jz lx kb kc kd ly kf kg lz ma kj kk mb mc kn ko md me kr ks kt hb bi translated">注意:突出显示的值是30天。</p></blockquote><ul class=""><li id="9c97" class="kv kw hi jy b jz lx kd ly kh mj kl mk kp ml kt la lb lc ld bi translated">在第4节中，您可以添加自定义消息，如下所示。</li></ul><figure class="in io ip iq fd ir er es paragraph-image"><div role="button" tabindex="0" class="is it di iu bf iv"><div class="er es mx"><img src="../Images/d60288b14df232aaeed1557cdb58d7e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l8p3zVmep4WnxpbhUwdJdA.png"/></div></div></figure><ul class=""><li id="03cf" class="kv kw hi jy b jz lx kd ly kh mj kl mk kp ml kt la lb lc ld bi translated">现在保存并退出。</li><li id="07ef" class="kv kw hi jy b jz le kd lf kh lg kl lh kp li kt la lb lc ld bi translated">我们已经为单个网站的TLS启用了电子邮件通知，同样，您可以根据需要复制它。</li><li id="84a3" class="kv kw hi jy b jz le kd lf kh lg kl lh kp li kt la lb lc ld bi translated">现在你应该看到下面的仪表板。绿色的心代表通知状态。如果网站关闭，它会变成红色心碎，你会收到电子邮件通知。</li></ul><figure class="in io ip iq fd ir er es paragraph-image"><div role="button" tabindex="0" class="is it di iu bf iv"><div class="er es im"><img src="../Images/e29061e77cbae2a0a4e60a81d9f0d49d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LcjWrI-rQZ_z1pMKJ2S0rw.png"/></div></div></figure><h1 id="0c83" class="iy iz hi bd ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv bi translated">打扫</h1><p id="3c7d" class="pw-post-body-paragraph jw jx hi jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt hb bi translated">执行以下shell脚本来清理所有docker容器并删除BlackBox导出器。</p><pre class="in io ip iq fd lj lk ll lm aw ln bi"><span id="1e35" class="lo iz hi lk b fi lp lq l lr ls">.<strong class="lk hj">/clean.sh</strong></span></pre><h1 id="5b33" class="iy iz hi bd ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv bi translated">摘要</h1><p id="f394" class="pw-post-body-paragraph jw jx hi jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt hb bi translated">我们已经了解了如何监控网站和TLS证书。此外，还了解了如何集成SMTP邮件服务器并为各种服务启用电子邮件通知。</p></div></div>    
</body>
</html>