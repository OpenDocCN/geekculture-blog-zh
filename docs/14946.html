<html>
<head>
<title>Automate Azure Infrastructure Provisioning with Terraform — Part II</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Terraform自动化Azure基础设施供应—第二部分</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/automate-azure-infrastructure-provisioning-with-terraform-part-ii-499594678624?source=collection_archive---------4-----------------------#2022-10-04">https://medium.com/geekculture/automate-azure-infrastructure-provisioning-with-terraform-part-ii-499594678624?source=collection_archive---------4-----------------------#2022-10-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/16308c7ff1c394be0c457eaf6b43d0e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1H9hnLpicpSG2sgWp6ApgA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">source — Author</figcaption></figure><p id="2791" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">如果你错过了我之前的博客，我在那里讨论了Terraform，请在我的个人资料中参考。</p><h1 id="5b3d" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">使用Terraform和Azure DevOps部署基础设施</h1><h2 id="9312" class="kq jt hi bd ju kr ks kt jy ku kv kw kc jf kx ky kg jj kz la kk jn lb lc ko ld bi translated">什么是CI/CD？持续集成和持续交付</h2><figure class="lf lg lh li fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es le"><img src="../Images/3736cfb346dcc14def39208866c40e4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b7ugJHDlNEUEKEDgkFTt3Q.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">source — <a class="ae lj" href="https://www.youtube.com/c/TechWorldwithNana" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/c/TechWorldwithNana</a></figcaption></figure><p id="ba67" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">持续集成(CI) </strong></p><p id="988b" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">持续集成是开发人员尽可能频繁地将他们的变更合并回主分支的实践。在这里，我们主要练习的是对代码库做任何必要的修改。然后，我们根据我们使用的技术栈，将这些更改打包到war文件或jar文件或任何必要的软件包中。然后，我们将使用选定的基本映像为包构建docker映像，并将其推送到公共或私有docker容器存储库。</p><figure class="lf lg lh li fd ij er es paragraph-image"><div class="er es lk"><img src="../Images/19d0604c95053cef40b3ae252463def3.png" data-original-src="https://miro.medium.com/v2/resize:fit:534/0*2DbTWaM_bCD0R2Ym"/></div><figcaption class="iq ir et er es is it bd b be z dx">source — <a class="ae lj" href="https://www.youtube.com/c/TechWorldwithNana" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/c/TechWorldwithNana</a></figcaption></figure><p id="bffa" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">连续交货(光盘)</strong></p><p id="75df" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">因为在构建步骤之后，它自动地将所有的代码变更发布到测试和/或生产环境中，所以持续交付是持续集成的扩展。在这里，我们从docker存储库中获取上面推送的映像，然后将其部署到容器中的相关pod。根据要求和流量，可能存在复制因素，我们有多个单元来满足更大的传入流量。</p><h2 id="30ef" class="kq jt hi bd ju kr ks kt jy ku kv kw kc jf kx ky kg jj kz la kk jn lb lc ko ld bi translated">服务连接</h2><figure class="lf lg lh li fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ll"><img src="../Images/2d42be283ca1d63d5e4e92fe2224e568.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tktQiodymbR6nWi3kCAerw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">source — <a class="ae lj" href="https://www.youtube.com/c/TechWorldwithNana" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/c/TechWorldwithNana</a></figcaption></figure><p id="cb92" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在开发运维过程中，我们经常需要连接到不同的平台并与之通信。<br/>对于Azure DevOps连续构建和连续发布管道来说，与外部和远程服务通信并执行活动，服务连接是必要的。通俗的说，我们在本地运行terraform的时候，基本上做的就是登录我们的Azure账号(az login)并设置订阅。</p><p id="7a1c" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">然后运行terraform计划并应用。但是，当我们通过管道实现流程自动化时，我们需要自动完成这些任务。为了做到这一点，我们创建了一个叫做服务连接的东西，这是一种特权用户类型的东西，通过这个帐户，它可以与Azure端执行任务。</p><h2 id="4462" class="kq jt hi bd ju kr ks kt jy ku kv kw kc jf kx ky kg jj kz la kk jn lb lc ko ld bi translated">演示项目</h2><ul class=""><li id="31c8" class="lm ln hi iw b ix lo jb lp jf lq jj lr jn ls jr lt lu lv lw bi translated">资源—<a class="ae lj" href="https://github.com/Sachin-Mamoru/weatherapi" rel="noopener ugc nofollow" target="_blank">https://github.com/Sachin-Mamoru/weatherapi</a></li></ul><figure class="lf lg lh li fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lx"><img src="../Images/7eadda1350140998d96f1689225e478e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OkoJCzMZH9Sn5NeZOF6pfQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">source — Author</figcaption></figure><p id="e9ae" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">简单地说，项目</p><ol class=""><li id="effc" class="lm ln hi iw b ix iy jb jc jf ly jj lz jn ma jr mb lu lv lw bi translated">首要的事情是创建一个存储帐户来存储tfstate文件，因为我们正在自动化这个过程，所以我们不能在本地保存它。相反，我创建了一个Azure存储帐户并保存在那里。</li></ol><pre class="lf lg lh li fd mc md me mf aw mg bi"><span id="9764" class="kq jt hi md b fi mh mi l mj mk">terraform {</span><span id="7673" class="kq jt hi md b fi ml mi l mj mk">  backend "azurerm" {</span><span id="8220" class="kq jt hi md b fi ml mi l mj mk">    resource_group_name = "tf_rg_storage"</span><span id="d904" class="kq jt hi md b fi ml mi l mj mk">    storage_account_name = "tffilestorage"</span><span id="6ea1" class="kq jt hi md b fi ml mi l mj mk">    container_name = "tfstate"</span><span id="c058" class="kq jt hi md b fi ml mi l mj mk">    key = "terraform.tfstate"</span><span id="9062" class="kq jt hi md b fi ml mi l mj mk">  }</span><span id="a206" class="kq jt hi md b fi ml mi l mj mk">}</span></pre><figure class="lf lg lh li fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mm"><img src="../Images/71dbe85c884edc580d193f97808c2f5b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kkqJK3pBXTKfe5nhI5pZ5w.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">source — Author</figcaption></figure><p id="6f0a" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">2.广告应用程序—客户端密码创建</p><p id="6d9c" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在这里，我们需要创建一个广告应用程序，然后创建一个客户端密码作为服务主体。正如我之前解释的，我们需要这个应用程序作为我们的特权用户，它将根据给定的权限和角色与Azure端进行所有的身份验证。</p><figure class="lf lg lh li fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mn"><img src="../Images/6f2986e18bb418e53e27d0e3c9041ef7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v9B-zUWFSf_lWszDpqEHKg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">source — Author</figcaption></figure><p id="1775" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">3.服务主体的环境变量</p><figure class="lf lg lh li fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mo"><img src="../Images/4c4f5b1d7db4e9a6641d7714b84cc8e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DMxcu5DR38bLSBUkl7B4Kg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">source — Author</figcaption></figure><p id="9126" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">执行管道需要创建的AD应用程序和Azure订阅帐户详细信息。因此，我们需要将它们添加到管道变量组中，这样就可以为管道获取这些值。</p><p id="b543" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">4.对于这个演示项目，我使用了由dotnet SDK weather API项目提供的一个示例项目。然后我用这个项目制作了一个docker图像。为此，添加了一个docker文件来创建管道中的映像。</p><figure class="lf lg lh li fd ij"><div class="bz dy l di"><div class="mp mq l"/></div></figure><p id="78f6" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">5.现在让我们回到地形部分。在main.tf文件中，我将创建几个资源。</p><ul class=""><li id="4734" class="lm ln hi iw b ix iy jb jc jf ly jj lz jn ma jr lt lu lv lw bi translated">资源组对创建的资源进行分组</li><li id="3345" class="lm ln hi iw b ix mr jb ms jf mt jj mu jn mv jr lt lu lv lw bi translated">使用构建的docker映像运行VM的容器</li><li id="8263" class="lm ln hi iw b ix mr jb ms jf mt jj mu jn mv jr lt lu lv lw bi translated">保护机密的密钥库</li><li id="ba59" class="lm ln hi iw b ix mr jb ms jf mt jj mu jn mv jr lt lu lv lw bi translated">随机密码资源，用于生成随机密码以保存密钥库中的秘密。</li></ul><figure class="lf lg lh li fd ij"><div class="bz dy l di"><div class="mp mq l"/></div></figure><p id="a0f2" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">正如您在代码中看到的，我为每个资源创建了单独的模块，因为这样更容易管理代码库的可读性和效率。</p><figure class="lf lg lh li fd ij"><div class="bz dy l di"><div class="mp mq l"/></div></figure><figure class="lf lg lh li fd ij"><div class="bz dy l di"><div class="mp mq l"/></div></figure><figure class="lf lg lh li fd ij"><div class="bz dy l di"><div class="mp mq l"/></div></figure><p id="970e" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">正如我前面解释的，我使用variables.tf文件来声明变量。变量的定义在terraform.tfvars文件中。</p><figure class="lf lg lh li fd ij"><div class="bz dy l di"><div class="mp mq l"/></div></figure><figure class="lf lg lh li fd ij"><div class="bz dy l di"><div class="mp mq l"/></div></figure><p id="5257" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">现在让我们运行管道。所以基本上，对于一个新手来说，去azure DevOps并在那里创建管道YAML文件并将其推送到GitHub会更容易。这样更容易，而不是从头开始写。</p><figure class="lf lg lh li fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mw"><img src="../Images/40601a0c7af38a35c0a811f667555e82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4uXyIiuqLQgDfuVIDx9qiQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">source — Author</figcaption></figure><p id="b271" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">转到管道部分并选择新建管道，然后配置您的代码库并创建管道YAML文件。</p><figure class="lf lg lh li fd ij"><div class="bz dy l di"><div class="mp mq l"/></div></figure><p id="d527" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">正如您在pipeline文件中看到的，我已经创建了第一个作业来构建包含最新更改的docker映像，并将其作为我的docker存储库推送到docker hub。这是项目的CI(持续集成)部分。</p><p id="cfee" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">然后在管道的第二阶段，我将运行terraform来提供部署项目的基础设施。所以在Azure端创建了所有必要的资源之后。我们将从docker hub获取构建的docker映像，并将其推送到容器实例。这是项目的CD(连续交付)部分。</p><figure class="lf lg lh li fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mx"><img src="../Images/aa41fa1941d1cb1e10c5ce6322caec60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mNiYKk92qbg-pf5bdkN9kQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">source — Author</figcaption></figure><p id="30ac" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">具体来说，在这里你可以看到terraform计划，其中计划了创建我们在tf文件中需要的资源所需的所有步骤。</p><p id="1567" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">现在，一旦你进入azure门户，你会看到它已经创建了你所有的资源。</p><figure class="lf lg lh li fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es my"><img src="../Images/f7d98911b5dd16a6431980aced5c91e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NkUlOeJHQsdMFk3aIN9Zkw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">source — Author</figcaption></figure><p id="d03c" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">现在让我们检查一下我们部署的天气API实例是否在工作。</p><figure class="lf lg lh li fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mz"><img src="../Images/11adb32e84f8861bc9dae4d665ebf58a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VrQ1H-rhw4_f9CYV3KWqUg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">source — Author</figcaption></figure><p id="8aa1" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在这里，您可以看到使用我们给定的DNS名称标签生成了一个URL。</p><figure class="lf lg lh li fd ij er es paragraph-image"><div class="er es na"><img src="../Images/f3470417e427406ddf6049df6731b75b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/format:webp/1*FG_HJ4YQWpSTDQsOHtu6vA.png"/></div><figcaption class="iq ir et er es is it bd b be z dx">source — Author</figcaption></figure><p id="b422" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">如您所见，我们的项目通过使用terraform自动配置基础设施而成功部署。</p><p id="e315" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">让我们在下一篇博客中讨论使用Terraform 部件的<strong class="iw hj">问题。</strong></p><p id="3548" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">谢谢，继续读☺️.</p></div></div>    
</body>
</html>