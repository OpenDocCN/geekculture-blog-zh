<html>
<head>
<title>Deploy a Rest API with a Proxy Method on AWS API Gateway with Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Terraform在AWS API网关上部署带有代理方法的Rest API</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/deploy-a-rest-api-with-a-proxy-method-on-aws-api-gateway-with-terraform-f19b3161006a?source=collection_archive---------10-----------------------#2021-06-11">https://medium.com/geekculture/deploy-a-rest-api-with-a-proxy-method-on-aws-api-gateway-with-terraform-f19b3161006a?source=collection_archive---------10-----------------------#2021-06-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/9db6f515fc423906ca3c6b23a4d19bf7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zkq-7Jn4U9v-wTtX-Wctkw.png"/></div></div></figure><p id="e115" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在本教程中，我们将看到如何使用Terraform在AWS上部署一个带有代理方法的Rest API。</p><p id="6dbc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">开始之前的先决条件:</strong>您需要在您的本地机器上完成terraform、AWS-CLI和配置。</p><p id="1042" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> Terraform安装指南:</strong><a class="ae jo" href="https://learn.hashicorp.com/tutorials/terraform/install-cli?in=terraform/aws-get-started" rel="noopener ugc nofollow" target="_blank">https://learn . hashi corp . com/tutorials/terra form/install-CLI？in = terra form/AWS-入门</a></p><p id="d3ec" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> AWS CLI安装</strong>:<a class="ae jo" href="https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/CLI/latest/user guide/install-CLI v2 . html</a>，将默认帐户设置为您将用于terraform的帐户。如果没有，您也可以从AWS控制台创建一个专门用于terraform的新帐户(推荐)，然后通过将该帐户凭据分配到本地计算机中的“AWS_PROFILE”变量中，将其与Terraform一起导出，以便在您的CLI上使用。</p><p id="ccbc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">例如:</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="0394" class="jy jz hi ju b fi ka kb l kc kd">export AWS_PROFILE=terraform-aws</span></pre><p id="9ebd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">完成这些先决条件后，您需要一个目录的基本结构，如下所示，</p><ul class=""><li id="9f11" class="ke kf hi is b it iu ix iy jb kg jf kh jj ki jn kj kk kl km bi translated">main.tf</li><li id="53ba" class="ke kf hi is b it kn ix ko jb kp jf kq jj kr jn kj kk kl km bi translated">providers.tf</li><li id="86ef" class="ke kf hi is b it kn ix ko jb kp jf kq jj kr jn kj kk kl km bi translated">变量. tf</li></ul><p id="fe40" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> main.tf </strong>:可以用来存放我们在本教程中将要创建的资源的所有代码块。[我们将在设置的每个步骤中实现该文件中的代码]</p><p id="9ad4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">页（page的缩写）s:不一定要将这个文件命名为“main.tf ”,但是因为我们在本教程中的唯一目标是在这个项目中设置API网关，所以它可以在这个文件上进行更一般的定义，因此有了这个文件名。</p><p id="b9b9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> providers.tf </strong>:这是我们让terraform知道我们将使用哪个云提供商的地方</p><figure class="jp jq jr js fd ij"><div class="bz dy l di"><div class="ks kt l"/></div></figure><p id="ba85" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> variables.tf: </strong>我们可以在这个文件中定义您在AWS上使用的首选区域，这个区域在上面的providers文件中被引用</p><figure class="jp jq jr js fd ij"><div class="bz dy l di"><div class="ks kt l"/></div></figure><p id="c124" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">好了，现在我们已经完成了基本的目录设置，我们可以运行第一个命令来初始化terraform需要的所有必要文件。</p><p id="7f90" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在上面提到的三个文件所在的根目录中，您可以运行下面的命令。</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="ca8c" class="jy jz hi ju b fi ka kb l kc kd">terraform init</span></pre><p id="3ebe" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这段代码将下载并初始化你的目录中的terraform资源，你可能会看到一个名为。运行此命令后，将创建terraform。</p><p id="e911" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，我们已经具备了terraform与您的AWS客户和地区合作所需的一切，让我们继续创建真正的交易。Rest API。</p><ol class=""><li id="52ef" class="ke kf hi is b it iu ix iy jb kg jf kh jj ki jn ku kk kl km bi translated"><strong class="is hj">使用将请求转发到代理HTTP调用的路径创建API。</strong></li></ol><p id="bee1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们使用资源"<strong class="is hj"> aws_api_gateway_rest_api </strong>创建一个API，它将包含一个名为"<strong class="is hj">post</strong>的路径，在这里它将<strong class="is hj">代理</strong>请求返回到一个示例HTTP服务器。在这个例子中，我们将著名的模拟API<a class="ae jo" href="https://jsonplaceholder.typicode.com/posts" rel="noopener ugc nofollow" target="_blank">https://jsonplaceholder.typicode.com</a>与“/posts”路由一起使用。</p><figure class="jp jq jr js fd ij"><div class="bz dy l di"><div class="ks kt l"/></div></figure><p id="5965" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">既然我们已经编写了用代理方法创建新的Rest API的代码定义，让我们进入下一步。</p><p id="c819" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> 2。定义API部署:这是我们告诉AWS应该部署哪个API的地方</strong></p><p id="2e12" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这段代码中，您会注意到3段代码，</p><figure class="jp jq jr js fd ij"><div class="bz dy l di"><div class="ks kt l"/></div></figure><ul class=""><li id="0625" class="ke kf hi is b it iu ix iy jb kg jf kh jj ki jn kj kk kl km bi translated"><strong class="is hj"> rest_api_id </strong>:这是我们上面定义的Rest API Id</li><li id="80b5" class="ke kf hi is b it kn ix ko jb kp jf kq jj kr jn kj kk kl km bi translated"><strong class="is hj">触发器</strong>:重新部署:这是一个触发器，告诉API Gateway在上面定义的API Gateway主体发生变化的情况下重新部署。</li><li id="0d07" class="ke kf hi is b it kn ix ko jb kp jf kq jj kr jn kj kk kl km bi translated"><strong class="is hj">生命周期</strong>:这告诉API网关在销毁旧的之前创建一个新的。</li></ul><p id="0a93" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.<strong class="is hj">定义API阶段</strong></p><figure class="jp jq jr js fd ij"><div class="bz dy l di"><div class="ks kt l"/></div></figure><p id="4169" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">通过定义一个阶段，我们可以保持部署的不同版本，我们可以用它在不同的环境中进行测试。例如:测试、开发、生产</p><p id="f050" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4.<strong class="is hj">打印部署URL </strong></p><figure class="jp jq jr js fd ij"><div class="bz dy l di"><div class="ks kt l"/></div></figure><p id="3c36" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后，让我们获取部署的API URL，这样我们就可以测试我们的endpoint‌了</p><p id="4ec3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">好了，现在我们已经有了所有的代码块，是时候调用一些terraform命令来部署这个API了。</p><p id="fc40" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">首先，我们应该跑，</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="89f5" class="jy jz hi ju b fi ka kb l kc kd">terraform plan</span></pre><p id="1715" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该命令将检查验证您的代码，然后检查您在代码中定义的AWS资源定义，如果没有错误，您应该会看到类似下面的内容</p><p id="8790" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">‌ <code class="du kv kw kx ju b">Plan: 3 to add, 0 to change, 0 to destroy.</code></p><p id="2fcb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，您可以浏览终端中提到的所有内容，如果一切正常，运行下面的命令。</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="ad84" class="jy jz hi ju b fi ka kb l kc kd">terraform apply</span></pre><p id="2e33" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">同样，这将是一个类似的输出，只是这次您必须键入“yes”进行确认，然后Terraform将创建代码中定义的所有资源。</p><p id="4100" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在apply命令完成之后，您应该会看到这样的内容以及创建的端点，</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ky"><img src="../Images/323986633d73c8d906c75d9c896eb776.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iKSOQdIsxPWPgeMHm6YLFg.png"/></div></div></figure><p id="8d5c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你访问这个网址，你会得到这个消息，</p><p id="affb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> { </strong>“消息”:“缺少认证令牌”<strong class="is hj"> } </strong></p><p id="4906" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因为它不是一个已知的路径，因为我们将路径创建为/posts，所以您可以在阶段名“test”之后这样做，如下所示，</p><p id="4104" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae jo" href="https://{API-ID}.execute-api.eu-central-1.amazonaws.com/test/posts" rel="noopener ugc nofollow" target="_blank"> https://{API-ID}。execute-api.eu-central-1.amazonaws.com/test/posts</a></p><p id="5912" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果一切设置正确，您将看到来自代理路径的JSON占位符端点的示例posts响应。</p><p id="82ee" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你有它！使用Terraform创建AWS网关代理端点的简单方法——将基础设施作为代码。</p></div><div class="ab cl kz la gp lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="hb hc hd he hf"><p id="8b53" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">希望这篇教程对你有用，我希望在接下来的文章中写一些部署Rest APIs和Terraform的其他方法和高级选项。</p></div></div>    
</body>
</html>