<html>
<head>
<title>Bring your Own Code to AWS SageMaker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将您自己的代码带到AWS SageMaker</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/bring-your-own-code-to-aws-sagemaker-74e1f98c326d?source=collection_archive---------14-----------------------#2021-07-16">https://medium.com/geekculture/bring-your-own-code-to-aws-sagemaker-74e1f98c326d?source=collection_archive---------14-----------------------#2021-07-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><h2 id="4acb" class="hg hh hi bd b fp hj hk hl hm hn ho dx hp translated" aria-label="kicker paragraph">逐步演练</h2><div class=""/><div class=""><h2 id="9651" class="pw-subtitle-paragraph io hr hi bd b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf dx translated"><em class="jg">通过7个简单的步骤训练和部署您的模型</em></h2></div><figure class="ji jj jk jl fd jm er es paragraph-image"><div class="er es jh"><img src="../Images/b4c8d949c0e7948837b34453d2eebb04.png" data-original-src="https://miro.medium.com/v2/resize:fit:802/format:webp/1*BB4ADd0ZdxEZQgKyhukaHA.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx">Photo by <a class="ae jt" href="https://unsplash.com/@charlesdeluvio?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Charles Deluvio</a> on <a class="ae jt" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="dda2" class="pw-post-body-paragraph ju jv hi jw b jx jy is jz ka kb iv kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi kq translated">开始一个新的平台可能会令人望而生畏！一个简单的方法是利用你已经知道的东西来使转换更容易。我在这里，以同样的方式帮助您启动AWS。如果你已经使用过AWS，你可以跳过这个7步指南的前3步。</p><blockquote class="kz"><p id="bc0e" class="la lb hi bd lc ld le lf lg lh li kp dx translated">这个博客将帮助你重用预先编写的代码来<strong class="ak">训练和部署SageMaker中的模型</strong></p></blockquote><p id="7e9e" class="pw-post-body-paragraph ju jv hi jw b jx lj is jz ka lk iv kc kd ll kf kg kh lm kj kk kl ln kn ko kp hb bi translated">出于本文的目的，我将使用一个用TensorFlow创建的U-Net模型——你可以在我的前一篇博客<a class="ae jt" rel="noopener" href="/geekculture/u-net-implementation-from-scratch-using-tensorflow-b4342266e406">上了解更多。</a></p><div class="lo lp ez fb lq lr"><a rel="noopener follow" target="_blank" href="/geekculture/u-net-implementation-from-scratch-using-tensorflow-b4342266e406"><div class="ls ab dw"><div class="lt ab lu cl cj lv"><h2 class="bd hs fi z dy lw ea eb lx ed ef hr bi translated">使用TensorFlow从头开始实现U-NET</h2><div class="ly l"><h3 class="bd b fi z dy lw ea eb lx ed ef dx translated">基础概念和逐步Python代码解释</h3></div><div class="lz l"><p class="bd b fp z dy lw ea eb lx ed ef dx translated">medium.com</p></div></div><div class="ma l"><div class="mb l mc md me ma mf jn lr"/></div></div></a></div><h1 id="7108" class="mg mh hi bd mi mj mk ml mm mn mo mp mq ix mr iy ms ja mt jb mu jd mv je mw mx bi translated">博客的内容</h1><ol class=""><li id="c8a2" class="my mz hi jw b jx na ka nb kd nc kh nd kl ne kp nf ng nh ni bi translated">核对先决条件</li><li id="47e1" class="my mz hi jw b jx nj ka nk kd nl kh nm kl nn kp nf ng nh ni bi translated">在亚马逊S3加载您的数据</li><li id="27c0" class="my mz hi jw b jx nj ka nk kd nl kh nm kl nn kp nf ng nh ni bi translated">设置SageMaker环境</li><li id="0481" class="my mz hi jw b jx nj ka nk kd nl kh nm kl nn kp nf ng nh ni bi translated">创建评估者</li><li id="9fba" class="my mz hi jw b jx nj ka nk kd nl kh nm kl nn kp nf ng nh ni bi translated">训练模型</li><li id="e268" class="my mz hi jw b jx nj ka nk kd nl kh nm kl nn kp nf ng nh ni bi translated">部署模型</li><li id="9c94" class="my mz hi jw b jx nj ka nk kd nl kh nm kl nn kp nf ng nh ni bi translated">预测！</li></ol><h1 id="9f40" class="mg mh hi bd mi mj mk ml mm mn mo mp mq ix mr iy ms ja mt jb mu jd mv je mw mx bi translated">1.核对先决条件</h1><p id="5830" class="pw-post-body-paragraph ju jv hi jw b jx na is jz ka nb iv kc kd no kf kg kh np kj kk kl nq kn ko kp hb bi translated">在我们开始之前，你需要两件东西:</p><ul class=""><li id="3157" class="my mz hi jw b jx jy ka kb kd nr kh ns kl nt kp nu ng nh ni bi translated">用于培训/部署的预写代码</li><li id="a384" class="my mz hi jw b jx nj ka nk kd nl kh nm kl nn kp nu ng nh ni bi translated">一个激活的AWS账户(<a class="ae jt" href="https://aws.amazon.com/premiumsupport/knowledge-center/create-and-activate-aws-account/" rel="noopener ugc nofollow" target="_blank">更多信息请点击</a>打开一个<strong class="jw hs">免费</strong>账户)</li></ul><h1 id="ee53" class="mg mh hi bd mi mj mk ml mm mn mo mp mq ix mr iy ms ja mt jb mu jd mv je mw mx bi translated">2.在亚马逊S3加载您的数据</h1><p id="8ec8" class="pw-post-body-paragraph ju jv hi jw b jx na is jz ka nb iv kc kd no kf kg kh np kj kk kl nq kn ko kp hb bi translated">一旦你登录到你的账户，第一步将是上传所需的数据，这可以通过亚马逊的简单存储服务(S3)轻松完成。S3是一种云存储驱动器，允许用户保存任何格式的大量数据，许多公司都使用它来安全地存储客户数据。在免费层中，5GB存储、前20k个GET请求和2K个PUT请求都不需要付费。</p><ul class=""><li id="a759" class="my mz hi jw b jx jy ka kb kd nr kh ns kl nt kp nu ng nh ni bi translated">打开AWS管理控制台，在“服务”下(左上角)查找“S3”(存储部分)</li><li id="52e8" class="my mz hi jw b jx nj ka nk kd nl kh nm kl nn kp nu ng nh ni bi translated">打开S3管理控制台后，点击右上角的“创建存储桶”按钮。您应该看到一个弹出的表单，如下图所示。</li></ul><blockquote class="nv nw nx"><p id="6229" class="ju jv ny jw b jx jy is jz ka kb iv kc nz ke kf kg oa ki kj kk ob km kn ko kp hb bi translated">S3桶<strong class="jw hs"> </strong>类似于文件夹，用于模块化和存储AWS云中的数据。用户可以自定义每个存储桶的设置，例如给予不同的访问权限。</p></blockquote><figure class="ji jj jk jl fd jm er es paragraph-image"><div role="button" tabindex="0" class="od oe di of bf og"><div class="er es oc"><img src="../Images/f85aeb34c65d6d2273683a2a2c627faa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kMmMArnk6jUtLWk4qEFf4Q.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Fig-1: Creating an S3 bucket</figcaption></figure><ul class=""><li id="175b" class="my mz hi jw b jx jy ka kb kd nr kh ns kl nt kp nu ng nh ni bi translated">表单(如上所示)将提示您为您的存储桶写一个名称，并选择一个“AWS区域”。一个经验法则是选择一个离你当前位置更近的区域来减少延迟。</li></ul><blockquote class="nv nw nx"><p id="3b18" class="ju jv ny jw b jx jy is jz ka kb iv kc nz ke kf kg oa ki kj kk ob km kn ko kp hb bi translated">AWS区域是世界各地的一个物理位置，由多个隔离的可用性区域(AZ)组成，每个AZ都有一个数据中心集群。在此阅读更多关于选择“正确”AWS区域的价值以及如何选择一个<a class="ae jt" href="https://www.concurrencylabs.com/blog/choose-your-aws-region-wisely/" rel="noopener ugc nofollow" target="_blank">的信息。</a></p></blockquote><ul class=""><li id="176b" class="my mz hi jw b jx jy ka kb kd nr kh ns kl nt kp nu ng nh ni bi translated">此外，您可以通过定制访问、版本控制、加密等，为您的用例选择理想的存储桶配置。如果你是新来的，只是尝试S3的个人项目，我建议使用默认设置。</li><li id="688c" class="my mz hi jw b jx nj ka nk kd nl kh nm kl nn kp nu ng nh ni bi translated">滚动到屏幕的末端，点击那个橙色的按钮。你们都完了！</li><li id="4e41" class="my mz hi jw b jx nj ka nk kd nl kh nm kl nn kp nu ng nh ni bi translated">既然bucket已经准备好了，我们只需点击upload按钮就可以开始上传文件或文件夹了。</li></ul><p id="1737" class="pw-post-body-paragraph ju jv hi jw b jx jy is jz ka kb iv kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">上传后，您可以通过单击文件名并查找URI来检查文件的位置(如下所示)。</p><figure class="ji jj jk jl fd jm er es paragraph-image"><div role="button" tabindex="0" class="od oe di of bf og"><div class="er es oh"><img src="../Images/b5612986e2c5e2c31c7e0b7f5c1f0d1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xnkl7V0D5HlCalJvhraQCQ.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Fig-2: The location copied from the S3 URI would be used in SageMaker to load the data</figcaption></figure><h1 id="9dd7" class="mg mh hi bd mi mj mk ml mm mn mo mp mq ix mr iy ms ja mt jb mu jd mv je mw mx bi translated">3.设置SageMaker环境</h1><blockquote class="kz"><p id="3e5c" class="la lb hi bd lc ld le lf lg lh li kp dx translated">A <!-- --> mazon SageMaker帮助数据科学家和开发人员快速准备、构建、训练和部署高质量的机器学习模型。~官方网站</p></blockquote><p id="1b81" class="pw-post-body-paragraph ju jv hi jw b jx lj is jz ka lk iv kc kd ll kf kg kh lm kj kk kl ln kn ko kp hb bi translated">既然我们已经设置好了数据，现在我们将集中精力设置一个笔记本，我们可以用它来访问数据，然后训练我们的模型。</p><ul class=""><li id="2746" class="my mz hi jw b jx jy ka kb kd nr kh ns kl nt kp nu ng nh ni bi translated">打开AWS管理控制台，在服务(左上角)下查找“Amazon SageMaker”(机器学习部分)</li><li id="2bc7" class="my mz hi jw b jx nj ka nk kd nl kh nm kl nn kp nu ng nh ni bi translated">从左侧菜单栏中，选择笔记本&gt;&gt;笔记本实例(图-3)</li></ul><blockquote class="nv nw nx"><p id="4aef" class="ju jv ny jw b jx jy is jz ka kb iv kc nz ke kf kg oa ki kj kk ob km kn ko kp hb bi translated">亚马逊SageMaker <strong class="jw hs">笔记本实例</strong>是运行Jupyter笔记本应用的ML计算实例。SageMaker还提供了<a class="ae jt" href="https://docs.aws.amazon.com/sagemaker/latest/dg/howitworks-nbexamples.html" rel="noopener ugc nofollow" target="_blank">示例笔记本</a>，可用于演示SageMaker的功能。</p></blockquote><ul class=""><li id="7cc4" class="my mz hi jw b jx jy ka kb kd nr kh ns kl nt kp nu ng nh ni bi translated">一旦新的屏幕打开，您将看到一个您以前创建的实例的列表，以及一个创建新实例的选项(图3)</li></ul><figure class="ji jj jk jl fd jm er es paragraph-image"><div role="button" tabindex="0" class="od oe di of bf og"><div class="er es oi"><img src="../Images/00bf8202639e93270da508a54eba8c5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hY5HhfL7Vcg7Jdx_JP4WMA.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Fig-3: Creating a new notebook instance</figcaption></figure><ul class=""><li id="1b61" class="my mz hi jw b jx jy ka kb kd nr kh ns kl nt kp nu ng nh ni bi translated">在创建笔记本实例时，您需要填写以下内容:<br/><br/><strong class="jw hs">Name</strong>:看起来很直接！<br/><br/><strong class="jw hs">类型</strong>:实例类型决定了您笔记本的内存和处理能力。最初，只有选择性类型可供您使用，您可以请求AWS支持来访问更多类型。<br/><br/><strong class="jw hs">权限</strong>:笔记本需要访问所有必要的资源(如S3桶)，这可以通过IAM角色授予。您可以使用现有角色，也可以创建一个新角色，并允许访问相关资源(图4)。<br/><br/><strong class="jw hs">网络</strong>:此可选功能可让您将笔记本电脑实例放在虚拟私有云(VPC)中，以获得额外的安全性。<br/><br/><strong class="jw hs">Git存储库</strong>:您可以直接将文件从AWS JupyterLab的UI推送到GitHub存储库。这可以通过克隆或创建新的回购来实现。</li></ul><blockquote class="nv nw nx"><p id="9492" class="ju jv ny jw b jx jy is jz ka kb iv kc nz ke kf kg oa ki kj kk ob km kn ko kp hb bi translated">在<a class="ae jt" href="https://docs.aws.amazon.com/sagemaker/latest/dg/howitworks-create-ws.html" rel="noopener ugc nofollow" target="_blank">官方文档</a>中阅读更多关于笔记本实例的信息。</p></blockquote><figure class="ji jj jk jl fd jm er es paragraph-image"><div role="button" tabindex="0" class="od oe di of bf og"><div class="er es oj"><img src="../Images/af8ac33bce61fa25a5b46a3132100c57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*14OsuqPglibN0FE322mCrA.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Fig-4: Creating a new IAM role for Notebook Instance</figcaption></figure><p id="e44f" class="pw-post-body-paragraph ju jv hi jw b jx jy is jz ka kb iv kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">现在我们准备编码了！</p><figure class="ji jj jk jl fd jm er es paragraph-image"><div role="button" tabindex="0" class="od oe di of bf og"><div class="er es ok"><img src="../Images/d191a8d07d95c69f6def3abc0fb62ec7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*KVq23u-zGSwKzdVC"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Photo by <a class="ae jt" href="https://unsplash.com/@preciousjfm?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">J E W E L M I T CH E L L</a> on <a class="ae jt" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="1f6f" class="mg mh hi bd mi mj mk ml mm mn mo mp mq ix mr iy ms ja mt jb mu jd mv je mw mx bi translated">4.创建评估者</h1><p id="5ecd" class="pw-post-body-paragraph ju jv hi jw b jx na is jz ka nb iv kc kd no kf kg kh np kj kk kl nq kn ko kp hb bi translated">SageMaker的开源库提供了内置的评估器，可用于训练模型，同时利用分配的资源编排ML生命周期。您可以创建这些估计器来访问内置的<a class="ae jt" href="https://docs.aws.amazon.com/sagemaker/latest/dg/algos.html" rel="noopener ugc nofollow" target="_blank">算法</a>、<a class="ae jt" href="https://sagemaker.readthedocs.io/en/stable/frameworks/index.html" rel="noopener ugc nofollow" target="_blank">框架</a>或用于训练提供的算法的通用估计器。</p><blockquote class="kz"><p id="8833" class="la lb hi bd lc ld le lf lg lh li kp dx translated">对于被考虑的<a class="ae jt" rel="noopener" href="/geekculture/u-net-implementation-from-scratch-using-tensorflow-b4342266e406"> U-Net用例</a>，我们将创建一个TensorFlow估算器。</p></blockquote><p id="13d0" class="pw-post-body-paragraph ju jv hi jw b jx lj is jz ka lk iv kc kd ll kf kg kh lm kj kk kl ln kn ko kp hb bi translated">estimator将入口点(您想要运行的源代码)、访问资源的角色信息、您想要运行的实例类型(可以不同于步骤3中定义的实例类型)、python版本、框架版本以及关于我们想要运行的脚本的一些其他细节作为参数。您也可以从估计器调用中编辑超参数。</p><pre class="ji jj jk jl fd ol om on oo aw op bi"><span id="0464" class="oq mh hi om b fi or os l ot ou">import sagemaker<br/>from sagemaker.tensorflow import TensorFlow<br/>from sagemaker import get_execution_role</span><span id="2015" class="oq mh hi om b fi ov os l ot ou">sagemaker_session = sagemaker.Session()<br/>role = get_execution_role()</span><span id="b8dc" class="oq mh hi om b fi ov os l ot ou">tf_estimator = TensorFlow(<strong class="om hs">entry_point = 'unet_from_scratch.py'</strong>, <br/>                          role = role,<br/>                          instance_count = 1, <br/>                          instance_type  = 'ml.m5.xlarge',<br/>                          py_version = 'py37',<br/>                          framework_version = '2.3.1',<br/>                          script_mode = True,<br/>                          output_path = output_path,<br/>                          sagemaker_session = sagemaker.Session(),<br/>                          metric_definitions = MetricDefinitions)</span></pre><h1 id="779a" class="mg mh hi bd mi mj mk ml mm mn mo mp mq ix mr iy ms ja mt jb mu jd mv je mw mx bi translated">5.训练模型</h1><p id="cce7" class="pw-post-body-paragraph ju jv hi jw b jx na is jz ka nb iv kc kd no kf kg kh np kj kk kl nq kn ko kp hb bi translated">一旦定义了估计量，我们就向estimator.fit函数提供S3桶位置。您还可以使用job_name为培训作业指定一个自定义名称。</p><pre class="ji jj jk jl fd ol om on oo aw op bi"><span id="7c3a" class="oq mh hi om b fi or os l ot ou">dataset_uri = 's3://vidushiprojects'<br/>job_name = f'tensorflow-single-gpu-<strong class="om hs">{</strong>time.strftime("%Y-%m-<strong class="om hs">%d</strong>-%H-%M-%S", time.gmtime())<strong class="om hs">}</strong>'</span><span id="2f40" class="oq mh hi om b fi ov os l ot ou">tf_estimator.fit(dataset_uri, job_name = job_name)</span></pre><blockquote class="nv nw nx"><p id="35f4" class="ju jv ny jw b jx jy is jz ka kb iv kc nz ke kf kg oa ki kj kk ob km kn ko kp hb bi translated">另一种训练模型的方法是将输入和验证数据作为参数提供给estimator.fit，而不是S3 URI。在这里阅读更多关于方法<a class="ae jt" href="https://docs.aws.amazon.com/sagemaker/latest/dg/ex1-train-model.html" rel="noopener ugc nofollow" target="_blank">信息。</a></p></blockquote><h1 id="d173" class="mg mh hi bd mi mj mk ml mm mn mo mp mq ix mr iy ms ja mt jb mu jd mv je mw mx bi translated">6.部署模型</h1><p id="bca2" class="pw-post-body-paragraph ju jv hi jw b jx na is jz ka nb iv kc kd no kf kg kh np kj kk kl nq kn ko kp hb bi translated">estimator.delpoy函数将定义的估计器模型部署到AWS端点。这将允许您使用Amazon EC2托管模型。在调用该函数时，您必须定义EC2实例的数量和类型。</p><pre class="ji jj jk jl fd ol om on oo aw op bi"><span id="229e" class="oq mh hi om b fi or os l ot ou">predictor = tf_estimator.deploy(<br/>    initial_instance_count=1,<br/>    instance_type='ml.m5.xlarge'    <br/>)</span><span id="748b" class="oq mh hi om b fi ov os l ot ou"># check the end point name <br/>name = predictor.endpoint_name</span></pre><blockquote class="nv nw nx"><p id="c7db" class="ju jv ny jw b jx jy is jz ka kb iv kc nz ke kf kg oa ki kj kk ob km kn ko kp hb bi translated">除非被用户删除，否则端点在ML实例中保持活动状态，并可用于在任何时候进行即时预测。</p></blockquote><h1 id="34e5" class="mg mh hi bd mi mj mk ml mm mn mo mp mq ix mr iy ms ja mt jb mu jd mv je mw mx bi translated">7.预测！</h1><p id="ea2b" class="pw-post-body-paragraph ju jv hi jw b jx na is jz ka nb iv kc kd no kf kg kh np kj kk kl nq kn ko kp hb bi translated">使用上面创建的端点，我们现在可以通过调用predict函数来预测新数据。</p><pre class="ji jj jk jl fd ol om on oo aw op bi"><span id="058d" class="oq mh hi om b fi or os l ot ou">data = {"instances": X.tolist()}<br/>out = predictor.predict(data)</span></pre><h1 id="1265" class="mg mh hi bd mi mj mk ml mm mn mo mp mq ix mr iy ms ja mt jb mu jd mv je mw mx bi translated">结论</h1><p id="81ef" class="pw-post-body-paragraph ju jv hi jw b jx na is jz ka nb iv kc kd no kf kg kh np kj kk kl nq kn ko kp hb bi translated">将您自己的代码引入AWS是试验该平台的一种简单方法。我希望这篇文章能帮助你开始你的AWS之旅。我很乐意帮助解决你的任何问题，其中一些问题也可以通过<a class="ae jt" href="https://github.com/VidushiBhatia/Bring-your-own-TensorFlow-code-to-SageMaker" rel="noopener ugc nofollow" target="_blank">源代码</a>解决。你也可以在官方<a class="ae jt" href="https://docs.aws.amazon.com/" rel="noopener ugc nofollow" target="_blank">文档</a>中阅读更多关于这个<a class="ae jt" href="https://sagemaker.readthedocs.io/en/stable/frameworks/tensorflow/using_tf.html#train-a-model-with-tensorflow" rel="noopener ugc nofollow" target="_blank">主题</a>和其他AWS应用的信息。</p><blockquote class="nv nw nx"><p id="6c2d" class="ju jv ny jw b jx jy is jz ka kb iv kc nz ke kf kg oa ki kj kk ob km kn ko kp hb bi translated"><strong class="jw hs">专业提示</strong>:如果你不想在月底收到AWS的长发票→那么在你完成你的申请后删除端点、模型和S3桶！</p></blockquote><figure class="ji jj jk jl fd jm er es paragraph-image"><div role="button" tabindex="0" class="od oe di of bf og"><div class="er es ow"><img src="../Images/92b886897336f14d2719ad7994232fe3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*26JyatkuD1vnMxBu"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Photo by <a class="ae jt" href="https://unsplash.com/@officestock?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Sebastian Herrmann</a> on <a class="ae jt" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure></div></div>    
</body>
</html>