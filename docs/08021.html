<html>
<head>
<title>Pushing Your Logs to Datadog Through Serilog Sink</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过Serilog接收器将您的日志推送到Datadog</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/pushing-your-logs-to-datadog-through-serilog-sink-77f0f26de53?source=collection_archive---------5-----------------------#2021-10-11">https://medium.com/geekculture/pushing-your-logs-to-datadog-through-serilog-sink-77f0f26de53?source=collection_archive---------5-----------------------#2021-10-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="21cf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">整合你的。NET核心应用程序与Serilog和Datadog，有很大的能见度在你的代码中发生了什么。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/f201ffc26e76a50b44b7085830c2edf4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZYDFdheSBiAyMoQbx5XXhA.jpeg"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Image by <a class="ae jt" href="https://unsplash.com/@taylor655ce" rel="noopener ugc nofollow" target="_blank">Randy ORourke</a> on <a class="ae jt" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><h2 id="e046" class="kb kc hi bd kd ke kf kg kh ki kj kk kl iq km kn ko iu kp kq kr iy ks kt ku kv bi translated">什么是Serilog？</h2><p id="d9f5" class="pw-post-body-paragraph if ig hi ih b ii kw ik il im kx io ip iq ky is it iu kz iw ix iy la ja jb jc hb bi translated">Serilog是一个<strong class="ih hj">结构的</strong>和便携式日志框架，用于将诊断日志记录到文件、控制台和其他地方的<strong class="ih hj"/>。</p><p id="4de8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">结构化日志记录通过将事件捕获过程与其向最终用户的传输和呈现分离开来，提高了搜索和分析代码的效率和可伸缩性。它们被视为一组带有时间戳的键/值属性，而不是将日志视为一系列文本行。例如，考虑这两行之间的差异:</p><pre class="je jf jg jh fd lb lc ld bn le lf bi"><span id="d7fe" class="lg kc hi lc b be lh li l lj lk"># text<br/>2021-10-07 09:05:37 [INF] UsersController:GetUserDetails#45 getting details for user with ID 16<br/># structured<br/>time=2021-10-07 09:05:37, level=INF, service=UsersController, method=GetUserDetails, line_num=45, content=details for user with ID 16</span></pre><p id="998b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我们仔细检查第二个日志，我们会意识到它实际上是一个JSON。所以让我们把它改写成一个:</p><pre class="je jf jg jh fd lb lc ld bn le lf bi"><span id="991b" class="lg kc hi lc b be lh li l lj lk">{<br/>  "time": "2021-10-07 09:05:37",<br/>  "level": "INF",<br/>  "service": "UsersController",<br/>  "method": "GetUserDetails"<br/>  "line_num": 45,<br/>  "content": "details for user with ID 16"<br/>}</span></pre><p id="5bfc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">像<a class="ae jt" href="https://www.datadoghq.com/" rel="noopener ugc nofollow" target="_blank"> Datadog </a>这样的工具可以帮助我们高效地显示、分析和搜索结构化日志。</p><p id="c7dd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Serilog使用一个称为“汇点”的概念，将日志路由到不同的目的地。这些接收器允许将日志发送到文本文件、数据库或基于云的监控平台，如Datadog。下图直观地展示了水槽的工作原理:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ll"><img src="../Images/ad915433b907cb4c26d1825e0cf2f027.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zKCjScPCfWgvAEGEUgrFJw.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Image by <a class="ae jt" href="https://www.codeproject.com/Articles/1041816/Serilog-An-Excellent-Logging-Framework-Integrated" rel="noopener ugc nofollow" target="_blank">codeproject</a></figcaption></figure></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><h2 id="38c3" class="kb kc hi bd kd ke kf kg kh ki kj kk kl iq km kn ko iu kp kq kr iy ks kt ku kv bi translated">将Serilog与集成。网络核心</h2><p id="fb80" class="pw-post-body-paragraph if ig hi ih b ii kw ik il im kx io ip iq ky is it iu kz iw ix iy la ja jb jc hb bi translated">首先，安装Serilog。将包加载到你的应用中。</p><pre class="je jf jg jh fd lb lc ld bn le lf bi"><span id="d279" class="lg kc hi lc b be lh li l lj lk">dotnet add package Serilog.AspNetCore</span></pre><p id="3bd0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，让我们为我们的应用程序设置JSON添加一个基本配置:</p><pre class="je jf jg jh fd lb lc ld bn le lf bi"><span id="297f" class="lg kc hi lc b be lh li l lj lk">{<br/>  "Serilog": {<br/>    "Using": [ "Serilog.Sinks.Console" ],<br/>    "MinimumLevel": {<br/>      "Default": "Information",<br/>      "Override": {<br/>        "Microsoft": "Warning",<br/>        "System": "Error",<br/>        "AWSSDK": "Warning"<br/>      }<br/>    },<br/>    "WriteTo": [<br/>      {<br/>        "Name": "Console",<br/>        "Args": {<br/>          "formatter": "Serilog.Formatting.Compact.CompactJsonFormatter, Serilog.Formatting.Compact"<br/>        }<br/>      }<br/>    ],<br/>    "Enrich": [ "WithThreadId", "WithMachineName" ]<br/>  },<br/>  "Datadog": {<br/>    "url": "https://http-intake.logs.datadoghq.eu"<br/>  }<br/>}</span></pre><p id="980c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在不要关心细节，我们稍后会提供详细的解释。</p><p id="b98e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，让我们为Datadog日志包添加Serilog接收器:</p><pre class="je jf jg jh fd lb lc ld bn le lf bi"><span id="ede4" class="lg kc hi lc b be lh li l lj lk">dotnet add package Serilog-Sinks-Datadog-Logs</span></pre><p id="7bc4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了将Serilog集成到我们的应用程序中，我们使用了<code class="du lm ln lo lc b">UseSerilog</code>方法。在<code class="du lm ln lo lc b">Program.cs</code>文件中，插入以下内容:</p><pre class="je jf jg jh fd lb lc ld bn le lf bi"><span id="4551" class="lg kc hi lc b be lh li l lj lk">public static IWebHostBuilder CreateWebHostBuilder(string[] args) =&gt;<br/>    WebHost.CreateDefaultBuilder(args)<br/>        .UseSerilog()<br/>        .UseStartup&lt;Startup&gt;();</span></pre><p id="1538" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们将在我们的<code class="du lm ln lo lc b">Startup.cs</code>文件中配置数据狗接收器:</p><pre class="je jf jg jh fd lb lc ld bn le lf bi"><span id="0add" class="lg kc hi lc b be lh li l lj lk">var datadogConf = new DatadogConfiguration(configuration.GetValue&lt;string&gt;("Datadog:url"));<br/>logger = logger.WriteTo.DatadogLogs(<br/>    _vaultService.GetSecret("DatadogApiKey"),<br/>    service: "development-backend",<br/>    host: Environment.GetEnvironmentVariable("DD_HOST") ?? "production",<br/>    configuration: datadogConf<br/>);</span></pre><p id="d49a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du lm ln lo lc b">Datadog:url</code>是数据狗API URL(例如<a class="ae jt" href="https://http-intake.logs.datadoghq.eu)," rel="noopener ugc nofollow" target="_blank">https://http-intake . logs . data dog HQ . eu)，</a>我们从我们的保险库中获取API密钥。</p><p id="8628" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此外，我们添加了以下<a class="ae jt" href="https://github.com/serilog/serilog/wiki/Enrichment" rel="noopener ugc nofollow" target="_blank">丰富器</a>来使我们的日志更加详细:</p><pre class="je jf jg jh fd lb lc ld bn le lf bi"><span id="92b3" class="lg kc hi lc b be lh li l lj lk">using System.Runtime.CompilerServices;<br/>using Serilog;<br/><br/>namespace company;<br/><br/>/// &lt;summary&gt;<br/>/// This class is used to enrich the default Serilog fields.<br/>/// For example, we can add the method's name, and the exact line number from<br/>/// which the log is executed.<br/>/// &lt;/summary&gt;<br/>public static class LoggerExtensions<br/>{<br/>  public static ILogger Enrich(this ILogger logger,<br/>    [CallerMemberName] string memberName = "",<br/>    [CallerLineNumber] int sourceLineNumber = 0)<br/>  {<br/>    return logger<br/>      .ForContext("MemberName", memberName)<br/>      .ForContext("LineNumber", sourceLineNumber);<br/>  }<br/>}</span></pre><p id="4732" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们使用这个enricher来查看日志中的源代码行号和成员名称。</p><p id="4d91" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我们需要安装以下软件包:</p><pre class="je jf jg jh fd lb lc ld bn le lf bi"><span id="84d8" class="lg kc hi lc b be lh li l lj lk">SeriLog.Enrichers.Environment<br/>Serilog.Enrichers.Thread<br/>Serilog.Formatting.Compact</span></pre></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><h2 id="d47b" class="kb kc hi bd kd ke kf kg kh ki kj kk kl iq km kn ko iu kp kq kr iy ks kt ku kv bi translated"><strong class="ak">使用记录器</strong></h2><p id="8510" class="pw-post-body-paragraph if ig hi ih b ii kw ik il im kx io ip iq ky is it iu kz iw ix iy la ja jb jc hb bi translated">下面是一个使用记录器的示例:</p><pre class="je jf jg jh fd lb lc ld bn le lf bi"><span id="a868" class="lg kc hi lc b be lh li l lj lk">public class UserService : IUserService<br/>{<br/>    private static readonly ILogger Logger = Log.ForContext(MethodBase.GetCurrentMethod().DeclaringType).Enrich();<br/>    <br/>    public async Task&lt;HttpResponseMessage&gt; UpdateUserName(string userName)<br/>    {<br/>        Logger.Information("updating username {@userDetails}", <br/>            new { currentName = context.GetUserName(), newName = userName });<br/>        // ...<br/>    }<br/>}</span></pre><p id="4b34" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在Datadog中，我们应该看到类似这样的内容:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lp"><img src="../Images/986db5d7d6670eac75143049c038c764.png" data-original-src="https://miro.medium.com/v2/resize:fit:1260/format:webp/1*MLs9oHtX7bLvJ6JAURbMKg.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx">Datadog</figcaption></figure><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lq"><img src="../Images/5857fb9b4a73847ae14565e807d5772f.png" data-original-src="https://miro.medium.com/v2/resize:fit:894/format:webp/1*3qA-VbHLm6fss6O6N_KlEw.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx">Datadog</figcaption></figure><p id="0d1e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上述JSON的所有字段都可以通过Datadog仪表板定制，并在单独的列中查看，这使得您的重要日志非常详细且可定制。</p><p id="336d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">总结</strong></p><p id="0823" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过利用Serilog接收器，您可以将结构化日志发布到Datadog，提供一个集中的平台来分析、监视和搜索应用程序中的事件。向Datadog发送日志的能力可以提高应用程序的可见性和控制力，从而更容易实时识别和解决问题。这将提高应用程序的可靠性和性能，并带来更好的用户体验。</p></div></div>    
</body>
</html>