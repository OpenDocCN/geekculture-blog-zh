<html>
<head>
<title>Privacy-friendly analytics in GatsbyJS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">盖茨比中的隐私友好分析</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/privacy-friendly-analytics-in-gatsbyjs-daaa2935518f?source=collection_archive---------7-----------------------#2021-06-19">https://medium.com/geekculture/privacy-friendly-analytics-in-gatsbyjs-daaa2935518f?source=collection_archive---------7-----------------------#2021-06-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="349e" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">我建立了我的Gatsby站点，只跟踪希望被跟踪的用户，使用cookie同意横幅请求他们的许可…</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/8a9c1fa71e936166d45ebec89e377912.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*nGhqX3NPH_KZYdtd.jpg"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">“Photo by <a class="ae jn" href="https://unsplash.com/@jdent?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Jason Dent</a> on <a class="ae jn" href="https://unsplash.com/s/photos/privacy?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a>”</figcaption></figure><p id="ea5c" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">🔔这篇文章最初发布在我的网站上，【MihaiBojin.com T4】。🔔</p></div><div class="ab cl kk kl gp km" role="separator"><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp"/></div><div class="hb hc hd he hf"><p id="3343" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">对于我的网站，我想获取用户分析，而不跟踪那些不想被跟踪的用户。在欧洲，通用数据保护条例(GDPR)保护消费者的隐私。特别是，<a class="ae jn" href="https://gdpr.eu/cookies/" rel="noopener ugc nofollow" target="_blank"> ePrivacy指令</a>在设置任何跟踪cookies之前会请求用户的同意。</p><p id="5c64" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">快速搜索显示<a class="ae jn" href="https://github.com/andrezimpel/gatsby-plugin-gdpr-cookies" rel="noopener ugc nofollow" target="_blank">Gatsby-plugin-gdpr-cookies</a>，一个支持<a class="ae jn" href="https://analytics.google.com/analytics/web/" rel="noopener ugc nofollow" target="_blank">谷歌分析</a>、<a class="ae jn" href="https://marketingplatform.google.com/about/tag-manager/" rel="noopener ugc nofollow" target="_blank">谷歌标签管理器</a>和<a class="ae jn" href="https://www.facebook.com/business/help/742478679120153?id=1205376682832142&amp;helpref=faq_content" rel="noopener ugc nofollow" target="_blank">脸书像素</a>的插件。</p><p id="dc9c" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">简而言之，它提供了一种要求用户明确同意设置任何cookies的机制；正是我所需要的！</p><h2 id="eb69" class="kr ks hi bd kt ku kv kw kx ky kz la lb jx lc ld le kb lf lg lh kf li lj lk ll bi translated">安装插件</h2><p id="2f47" class="pw-post-body-paragraph jo jp hi jq b jr lm ij jt ju ln im jw jx lo jz ka kb lp kd ke kf lq kh ki kj hb bi translated">我用<code class="du lr ls lt lu b">npm install gatsby-plugin-gdpr-cookies</code>安装了插件，然后把它添加到我的<code class="du lr ls lt lu b">gatsby-config.js</code>文件中:</p><pre class="iy iz ja jb fd lv lu lw lx aw ly bi"><span id="fcc8" class="kr ks hi lu b fi lz ma l mb mc">module.exports = {<br/>  plugins: [<br/>    {<br/>      resolve: `gatsby-plugin-gdpr-cookies`,<br/>      options: {<br/>        googleAnalytics: {<br/>          trackingId: /*GA_TRACKING_ID*/,<br/>          cookieName: "gatsby-gdpr-google-analytics",<br/>          anonymize: true, // https://github.com/andrezimpel/gatsby-plugin-gdpr-cookies#anonymize<br/>          allowAdFeatures: false,<br/>        },<br/>      },<br/>    },<br/>  ],<br/>};</span></pre><p id="a6c2" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">然后，什么都没有…</p><p id="13ff" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">事实证明，配置这个插件比文档显示的<a class="ae jn" href="https://github.com/andrezimpel/gatsby-plugin-gdpr-cookies#initialize-and-track" rel="noopener ugc nofollow" target="_blank">要麻烦一点。</a></p><p id="32a0" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">插件<strong class="jq hj">要求您设置名为</strong> <code class="du lr ls lt lu b"><strong class="jq hj">cookieName</strong></code>的cookie，例如:<code class="du lr ls lt lu b">gatsby-gdpr-google-analytics=true</code>，以启用跟踪。</p><p id="18e0" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这一点并不明显，我最终花费了不必要的时间去弄清楚为什么它不起作用。</p><h2 id="0ad1" class="kr ks hi bd kt ku kv kw kx ky kz la lb jx lc ld le kb lf lg lh kf li lj lk ll bi translated">与同意横幅整合</h2><p id="226e" class="pw-post-body-paragraph jo jp hi jq b jr lm ij jt ju ln im jw jx lo jz ka kb lp kd ke kf lq kh ki kj hb bi translated">这样一来，我需要一个开关来跟踪用户是否已经接受了横幅。通常，我会使用另一种cookie——但那会违背我的初衷。</p><p id="567f" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">本地存储来救援！</strong>我找到了<a class="ae jn" href="https://www.joshwcomeau.com/snippets/react-hooks/use-sticky-state/" rel="noopener ugc nofollow" target="_blank"> Josh Comeau关于粘性状态的优秀教程</a>并实现了它。</p><p id="4300" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">一个简单的React组件之后，和一些用于横幅的<a class="ae jn" href="https://tailwindui.com/components/marketing/elements/banners#component-39dd57897ef8e6d37aa07fbbafc188b1" rel="noopener ugc nofollow" target="_blank"> TailwindUI代码，它就准备好了！</a></p><p id="d952" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">下面是生成的代码(简化):</p><pre class="iy iz ja jb fd lv lu lw lx aw ly bi"><span id="304e" class="kr ks hi lu b fi lz ma l mb mc">import * as React from 'react';<br/>import { useLocation } from '@reach/router';<br/>import { initializeAndTrack } from 'gatsby-plugin-gdpr-cookies';<br/><br/>function isBrowser() {<br/>  return typeof window !== 'undefined';<br/>}<br/><br/>function getValue(key, defaultValue) {<br/>  return isBrowser() &amp;&amp; window.localStorage.getItem(key)<br/>    ? JSON.parse(window.localStorage.getItem(key))<br/>    : defaultValue;<br/>}<br/><br/>function setValue(key, value) {<br/>  window.localStorage.setItem(key, JSON.stringify(value));<br/>}<br/><br/>function useStickyState(defaultValue, key) {<br/>  const [value, setter] = React.useState(() =&gt; {<br/>    return getValue(key, defaultValue);<br/>  });<br/><br/>  React.useEffect(() =&gt; {<br/>    setValue(key, value);<br/>  }, [key, value]);<br/><br/>  return [value, setter];<br/>}<br/><br/>const CookieConsent = () =&gt; {<br/>  const location = useLocation();<br/>  if (isBrowser()) {<br/>    initializeAndTrack(location);<br/>  }<br/><br/>  const [bannerHidden, setBannerHidden] = useStickyState(<br/>    false,<br/>    'consentCookieHidden',<br/>  );<br/><br/>  const EnableAnalytics = () =&gt; {<br/>    document.cookie = 'gatsby-gdpr-google-analytics=true';<br/>    setBannerHidden(true);<br/>  };<br/><br/>  return (<br/>    &lt;&gt;<br/>      {!bannerHidden &amp;&amp; (<br/>        &lt;div&gt;<br/>          &lt;span&gt;<br/>            We use cookies to personalize content and analyze our<br/>            traffic.<br/>          &lt;/span&gt;<br/>          &lt;button onClick={EnableAnalytics}&gt;OK&lt;/button&gt;<br/>        &lt;/div&gt;<br/>      )}<br/>    &lt;/&gt;<br/>  );<br/>};<br/><br/>export default CookieConsent;</span></pre><p id="e544" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">剩下的最后一件事是在站点的页脚调用这个组件。</p><pre class="iy iz ja jb fd lv lu lw lx aw ly bi"><span id="b405" class="kr ks hi lu b fi lz ma l mb mc">import CookieConsent from 'cookie-consent';<br/>...<br/>&lt;CookieConsent/&gt;</span></pre><p id="e016" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这确保了在用户单击OK之前，不会运行任何分析代码，也不会设置任何cookies。</p><p id="6400" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">就是这样！这是您在启用分析和跟踪cookies之前获得用户同意的方式！</p></div><div class="ab cl kk kl gp km" role="separator"><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp"/></div><div class="hb hc hd he hf"><p id="7cf8" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">如果你喜欢这篇文章并想阅读更多类似的文章，<a class="ae jn" href="https://motivated-founder-807.ck.page/db1cf284bf" rel="noopener ugc nofollow" target="_blank">请订阅我的简讯</a>；我每隔几周就发一封！</p></div></div>    
</body>
</html>