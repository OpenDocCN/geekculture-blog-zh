<html>
<head>
<title>Circuit Breaker Pattern (Design Patterns for Microservices)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">断路器模式(微服务的设计模式)</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/design-patterns-for-microservices-circuit-breaker-pattern-276249ffab33?source=collection_archive---------1-----------------------#2021-06-12">https://medium.com/geekculture/design-patterns-for-microservices-circuit-breaker-pattern-276249ffab33?source=collection_archive---------1-----------------------#2021-06-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/c741d9765db5dbf99d12085f441c69bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1300/format:webp/0*Xe1qrXbqR1rAgU7r.jpg"/></div><figcaption class="im in et er es io ip bd b be z dx">Source: <a class="ae iq" href="https://womenyoushouldknow.net/" rel="noopener ugc nofollow" target="_blank">https://womenyoushouldknow.net/</a></figcaption></figure><p id="d70e" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi jp translated">在一个<a class="ae iq" href="https://en.wikipedia.org/wiki/Distributed_computing" rel="noopener ugc nofollow" target="_blank">分布式系统</a>中，我们不知道其他组件会如何失效。网络问题可能会发生，组件可能会出现故障，或者路由器或交换机可能会损坏。我们不知道会出什么问题。<br/>因此，分布式系统中的每个组件都有责任保持活力。作为一名软件工程师，你有责任让他们活下去。</p><h1 id="be18" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">什么是断路器？</h1><p id="88cd" class="pw-post-body-paragraph ir is hi it b iu kw iw ix iy kx ja jb jc ky je jf jg kz ji jj jk la jm jn jo hb bi translated">🌟要了解断路器设计模式，您应该首先了解断路器。</p><p id="22cc" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟如果你家是用电的，我肯定你家有断路器。当你从主电网获得电力时，它会通过一个断路器。</p><p id="de35" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟断路器是一种自动操作的电气开关，用于保护电路免受过载(例如:雷击)或短路造成的损坏。其主要目的是在发现缺陷时停止电流，保护您家中的电器。</p><p id="3447" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟你想知道这一点是因为，断路器的工作方式或多或少与断路器设计模式非常相似。</p><figure class="lb lc ld le fd ij er es paragraph-image"><div class="ab fe cl lf"><img src="../Images/0e0c1b2f7f9ad580224ed98fd1a0bf3a.png" data-original-src="https://miro.medium.com/v2/format:webp/0*85rc9WAFji0zAhVE.jpg"/></div><figcaption class="im in et er es io ip bd b be z dx">Circuit breaker (Source: <a class="ae iq" href="https://pixabay.com/users/diermaier-1497330/" rel="noopener ugc nofollow" target="_blank">https://pixabay.com/users/diermaier-1497330/</a>)</figcaption></figure></div><div class="ab cl lg lh gp li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="hb hc hd he hf"><h1 id="8f77" class="jy jz hi bd ka kb ln kd ke kf lo kh ki kj lp kl km kn lq kp kq kr lr kt ku kv bi translated">断路器模式</h1><p id="cbf7" class="pw-post-body-paragraph ir is hi it b iu kw iw ix iy kx ja jb jc ky je jf jg kz ji jj jk la jm jn jo hb bi translated">🌟顾名思义，断路器设计模式用于在服务不工作时停止请求和响应过程。</p><figure class="lb lc ld le fd ij er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es ls"><img src="../Images/ca05fa8c3238f819bfb5a011b1317a5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*r5-TFswFRCUErn9i.png"/></div></div><figcaption class="im in et er es io ip bd b be z dx">Figure 1: <a class="ae iq" href="https://www.edureka.co/blog/microservices-design-patterns#CircuitBreaker" rel="noopener ugc nofollow" target="_blank">Circuit Breaker Pattern</a></figcaption></figure><p id="302f" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟例如，假设一个消费者发送一个从多个服务获取数据的请求。但是，由于技术问题，其中一项服务不可用。现在你将面临两个主要问题。</p><ul class=""><li id="ae56" class="lx ly hi it b iu iv iy iz jc lz jg ma jk mb jo mc md me mf bi translated">首先，因为消费者不会意识到某个特定的服务不可用(失败)，所以请求会被持续发送到该服务。</li><li id="5ba0" class="lx ly hi it b iu mg iy mh jc mi jg mj jk mk jo mc md me mf bi translated">第二个问题是，网络资源将被耗尽，性能和用户体验很低。</li></ul><blockquote class="ml mm mn"><p id="7869" class="ir is mo it b iu iv iw ix iy iz ja jb mp jd je jf mq jh ji jj mr jl jm jn jo hb bi translated">我们将通过用例来讨论这些问题。继续读下去😃</p></blockquote><p id="cd18" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟您可以利用断路器设计模式来避免这样的问题。消费者将使用这种模式通过代理调用远程服务。该代理将充当电路屏障。</p><p id="c309" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟当故障数量达到某个阈值时，断路器在规定的持续时间内跳闸。</p><p id="7cbe" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟在此超时期间，对脱机服务器的任何请求都将失败。当该时间段结束时，断路器将允许有限数量的测试通过，如果这些请求成功，断路器将返回正常操作。如果出现故障，超时周期将重新开始。</p><blockquote class="ml mm mn"><p id="208e" class="ir is mo it b iu iv iw ix iy iz ja jb mp jd je jf mq jh ji jj mr jl jm jn jo hb bi translated">🤔仍然对断路器模式的工作原理感到困惑。我相信在这篇文章结束时你会有更好的想法。</p></blockquote><p id="ea65" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">但在我们深入了解更多细节之前，我想让你熟悉两件事，</p><ol class=""><li id="daf6" class="lx ly hi it b iu iv iy iz jc lz jg ma jk mb jo ms md me mf bi translated">我们将在本文中使用的主要用例。</li><li id="14be" class="lx ly hi it b iu mg iy mh jc mi jg mj jk mk jo ms md me mf bi translated">如果我们的服务失败，可用性会产生怎样的影响。</li></ol></div><div class="ab cl lg lh gp li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="hb hc hd he hf"><h1 id="9008" class="jy jz hi bd ka kb ln kd ke kf lo kh ki kj lp kl km kn lq kp kq kr lr kt ku kv bi translated">断路器的主要使用案例</h1><p id="52bb" class="pw-post-body-paragraph ir is hi it b iu kw iw ix iy kx ja jb jc ky je jf jg kz ji jj jk la jm jn jo hb bi translated">🌟这将是我用来解释断路器模式的几个用例的主要例子。</p><p id="450b" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟如果你读过我以前的微博客，你可能对商业金融的例子很熟悉。</p><p id="7570" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟如果你不熟悉我以前的博客，不要担心。因为你不需要知道整个场景。(但我希望您熟悉聚合模式)。</p><p id="999f" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟您已经使用微服务架构实现了Mercantile Finance的员工管理。该系统具有以下服务。</p><ul class=""><li id="6edd" class="lx ly hi it b iu iv iy iz jc lz jg ma jk mb jo mc md me mf bi translated">🔩服务1:获取个人信息。</li><li id="3145" class="lx ly hi it b iu mg iy mh jc mi jg mj jk mk jo mc md me mf bi translated">🔩服务二:获取请假信息。</li><li id="ffe0" class="lx ly hi it b iu mg iy mh jc mi jg mj jk mk jo mc md me mf bi translated">🔩服务三:获取员工绩效信息。</li><li id="4494" class="lx ly hi it b iu mg iy mh jc mi jg mj jk mk jo mc md me mf bi translated">🔩服务4:获取分配信息。</li></ul><figure class="lb lc ld le fd ij er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es mt"><img src="../Images/d7281aec0bd99e0e1c55fd496bdbe812.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*evo-WosIzbdJtiuPr4KVdA.png"/></div></div><figcaption class="im in et er es io ip bd b be z dx">Figure 2</figcaption></figure><p id="f0c3" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟当有多个服务时，这些服务调用(使用聚合器模式)多个后端(服务)是非常可能的。</p><p id="f5ac" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟所以你想知道的主要用例场景。现在，让我们看看为什么可用性对于微服务非常重要。</p></div><div class="ab cl lg lh gp li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="hb hc hd he hf"><h1 id="d4e6" class="jy jz hi bd ka kb ln kd ke kf lo kh ki kj lp kl km kn lq kp kq kr lr kt ku kv bi translated">为什么可用性在微服务架构中至关重要</h1><figure class="lb lc ld le fd ij er es paragraph-image"><div class="er es mu"><img src="../Images/8c0d310a34910a9a90f2c67909a98960.png" data-original-src="https://miro.medium.com/v2/resize:fit:1160/format:webp/1*K5cofOmvH-cwBDA7U8HJsA.png"/></div><figcaption class="im in et er es io ip bd b be z dx">Figure 3: <a class="ae iq" href="https://web.archive.org/web/20180728204314/https:/www.digitaldaniels.com/availability-service-level-9s-equate/" rel="noopener ugc nofollow" target="_blank">Levels of availability</a></figcaption></figure><p id="047a" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟所以假设，当你的公司实现员工管理系统的这些服务时，他们承诺商业金融的正常运行时间为<code class="du mv mw mx my b">99.999%</code>(五个九)。</p><p id="93ec" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">💻❓<code class="du mv mw mx my b">99.999%</code>的最大停机时间是如何计算的</p><p id="7a53" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">每天<code class="du mv mw mx my b">24</code> <code class="du mv mw mx my b">hours</code>和每年<code class="du mv mw mx my b">365</code><code class="du mv mw mx my b">days</code>=每年<code class="du mv mw mx my b"> 8760</code> <code class="du mv mw mx my b">hours</code>。</p><p id="85f4" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated"><code class="du mv mw mx my b">8760</code> x <code class="du mv mw mx my b">60</code> = <code class="du mv mw mx my b">525600</code> <code class="du mv mw mx my b">minutes</code>每年。</p><p id="2b04" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated"><code class="du mv mw mx my b">99.999%</code>正常运行时间意味着可接受的故障变化= <code class="du mv mw mx my b">0.001%</code></p><p id="6fe0" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated"><code class="du mv mw mx my b">525600</code> X <code class="du mv mw mx my b">0.001%</code> = <code class="du mv mw mx my b">5.256 minutes</code></p><p id="7d2d" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟一项服务每年可能会停机。对于单芯片系统来说，每年5.25分钟的停机时间完全没问题。</p><p id="ee9a" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟但是与整体架构不同，在微服务架构中，可能有许多服务。假设有100个服务。这可能导致每年<strong class="it hj"> 8.78小时</strong>的停机时间。这是一个关键的数字😨。这就是为什么我们需要注意保护我们的服务。</p><p id="91f9" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">那么，让我们看看中断服务的原因是什么。</p></div><div class="ab cl lg lh gp li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="hb hc hd he hf"><h1 id="6363" class="jy jz hi bd ka kb ln kd ke kf lo kh ki kj lp kl km kn lq kp kq kr lr kt ku kv bi translated">中断服务的原因是什么？</h1><h2 id="b8e4" class="mz jz hi bd ka na nb nc ke nd ne nf ki jc ng nh km jg ni nj kq jk nk nl ku nm bi translated">用例1</h2><p id="ae49" class="pw-post-body-paragraph ir is hi it b iu kw iw ix iy kx ja jb jc ky je jf jg kz ji jj jk la jm jn jo hb bi translated">🌟假设您有5个不同的服务，并且您有一个web服务器来调用这些服务。现在，当收到请求时，服务器会分配一个线程来调用服务。</p><p id="ed93" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟现在发生的是这个服务有一点延迟(由于一个故障),这个线程正在等待。一个线程等待就可以了。</p><figure class="lb lc ld le fd ij er es paragraph-image"><div class="er es nn"><img src="../Images/e4acd361c71e209ec08ae8198e99f51f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1086/format:webp/1*zZ-9zuIoV52rlkTv_ueKFw.png"/></div><figcaption class="im in et er es io ip bd b be z dx">Figure 4</figcaption></figure><p id="8d38" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟但是如果这个服务是一个高需求服务(获得越来越多的请求)，更多的线程将被分配给这个服务，并且所有被分配来调用该服务的线程将不得不等待。</p><figure class="lb lc ld le fd ij er es paragraph-image"><div class="er es no"><img src="../Images/0ecca72306f4b2c52fc9821337005a44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1094/format:webp/1*ZedKbD46oX-JK6Mr0Qy2sA.png"/></div><figcaption class="im in et er es io ip bd b be z dx">Figure 5</figcaption></figure><p id="a3e2" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟因此，如果您现在有100个线程，其中98个可能被占用，如果另外两个线程被另外两个服务占用，所有线程现在都被阻塞。</p><figure class="lb lc ld le fd ij er es paragraph-image"><div class="er es np"><img src="../Images/b443087071496564d6102ab0e7cc9804.png" data-original-src="https://miro.medium.com/v2/resize:fit:1092/format:webp/1*xd3FRt6qtCToF7kGmgIsGw.png"/></div><figcaption class="im in et er es io ip bd b be z dx">Figure 6</figcaption></figure><p id="0241" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟现在发生的是到达您的服务的剩余请求将被排队(阻塞)。因此，与此同时，50多个请求也来了，所有这些请求都在排队，因为线程被耗尽了。</p><figure class="lb lc ld le fd ij er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es nq"><img src="../Images/ed132b4dd53c177aef1db95b4c5573c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q-x-Eb5m6nT34mN52hfK4Q.png"/></div></div><figcaption class="im in et er es io ip bd b be z dx">Figure 7</figcaption></figure><p id="feb9" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟几秒钟后，故障服务恢复正常。现在，web服务器尝试处理队列中的所有请求。因此，web服务器(或代理)可能永远无法恢复。原因是当web服务器处理队列请求时，越来越多的请求不断到达。所以，这种类型的场景会扼杀你的服务。</p><p id="00fa" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">现在让我们进入下一个场景</p></div><div class="ab cl lg lh gp li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="hb hc hd he hf"><h2 id="87da" class="mz jz hi bd ka na nb nc ke nd ne nf ki jc ng nh km jg ni nj kq jk nk nl ku nm bi translated">用例2</h2><figure class="lb lc ld le fd ij er es paragraph-image"><div class="er es nr"><img src="../Images/b545ba5d612562133b863bca52de6576.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OvJE2ARnw57pL6HdCKF2Tw.png"/></div><figcaption class="im in et er es io ip bd b be z dx">Figure 8</figcaption></figure><p id="1257" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟在这个场景中，<strong class="it hj">服务A </strong>调用<strong class="it hj"> B </strong>，<strong class="it hj">服务B </strong>调用<strong class="it hj"> C </strong>，<strong class="it hj">服务C </strong>调用<strong class="it hj"> D </strong>。同时还有其他服务<strong class="it hj"> W </strong>、<strong class="it hj"> X </strong>、<strong class="it hj"> Y </strong>和<strong class="it hj"> Z </strong>。但是如果服务不能及时响应会发生什么呢？💥</p><p id="a1b1" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟假设服务D 没有及时回复。</p><figure class="lb lc ld le fd ij er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es ns"><img src="../Images/c631da4b5c515065597da2f55052ee73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4ZcMJ5Ua35WirVFYBPn-Cw.png"/></div></div><figcaption class="im in et er es io ip bd b be z dx">Figure 9 : Service D failed</figcaption></figure><p id="fe79" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟现在服务C必须等待。</p><figure class="lb lc ld le fd ij er es paragraph-image"><div class="er es nt"><img src="../Images/3cde9a57c7fce3462989201244eb2de5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1396/format:webp/1*odKu941BXTVk3khfRWrhqg.png"/></div><figcaption class="im in et er es io ip bd b be z dx">Figure 10: Service C is waiting</figcaption></figure><p id="aff5" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟由于服务C正在等待，服务B也必须等待。因此，相应地，服务A必须等待。这会导致<a class="ae iq" href="https://en.wikipedia.org/wiki/Cascading_failure" rel="noopener ugc nofollow" target="_blank"> <strong class="it hj">级联失效</strong> </a>。</p><figure class="lb lc ld le fd ij er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es nu"><img src="../Images/907081e7efaa03a1524f95c9165d2f8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Kz6tbBVB21BSyu90xRZHQw.png"/></div></div><figcaption class="im in et er es io ip bd b be z dx">Figure 11 : Service A,B and C waiting for D</figcaption></figure><figure class="lb lc ld le fd ij er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es nv"><img src="../Images/719abd8bc882f4dcf9e8c8fee264b52f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*__7YaZ4pgikHI9A3kvVvww.png"/></div></div><figcaption class="im in et er es io ip bd b be z dx">Figure 12 : Casacade faliure</figcaption></figure><p id="4003" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟无论你的服务如何失败，但当服务失败时，它将离线。那么，我们能做些什么来保持这些服务的正常运行呢？🤔</p></div><div class="ab cl lg lh gp li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="hb hc hd he hf"><h1 id="d40e" class="jy jz hi bd ka kb ln kd ke kf lo kh ki kj lp kl km kn lq kp kq kr lr kt ku kv bi translated">断路器模式的解决方案</h1><figure class="lb lc ld le fd ij er es paragraph-image"><div class="er es nw"><img src="../Images/d73006845a5f0e64efbe280c87bf5a2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:548/format:webp/1*Npgzkr6pdhoAw7G5SqnFRg.png"/></div><figcaption class="im in et er es io ip bd b be z dx">Figure 13: <a class="ae iq" href="https://martinfowler.com/bliki/CircuitBreaker.html" rel="noopener ugc nofollow" target="_blank">Circuit breaker pattern</a></figcaption></figure><p id="c622" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟因此，正如我上面提到的(在“断路器的主要用例”中)，系统中有04个服务和一个代理(一个调用这些服务的聚合器模式)。</p><p id="b2df" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟在经历了使用原因1和2之后，我相信您现在已经知道，当个别服务失败时，可能会发生系统故障(<strong class="it hj">供应商变得不响应</strong> )—图13。</p><p id="8571" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟那么它可能会导致系统耗尽关键资源(例如:还记得用例1中线程是如何被占用的吗)。</p><p id="4f7d" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟断路器的基本概念是将受保护的函数调用包装在断路器对象中，该对象监视故障。当失败次数达到某个阈值时，断路器跳闸，并且对断路器的所有请求返回一个错误。</p><figure class="lb lc ld le fd ij er es paragraph-image"><div class="er es nx"><img src="../Images/f1d3ec9e82740849aaae6b95d0f384d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:900/format:webp/1*RkQtS_LAO2H2K3kXlltapQ.png"/></div><figcaption class="im in et er es io ip bd b be z dx">Figure 14: <a class="ae iq" href="https://martinfowler.com/bliki/CircuitBreaker.html" rel="noopener ugc nofollow" target="_blank">States of Circuit Breaker</a></figcaption></figure><p id="2553" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">断路器模式有3种状态。</p><ol class=""><li id="11f4" class="lx ly hi it b iu iv iy iz jc lz jg ma jk mb jo ms md me mf bi translated"><strong class="it hj">打开。</strong></li><li id="a2ba" class="lx ly hi it b iu mg iy mh jc mi jg mj jk mk jo ms md me mf bi translated"><strong class="it hj">关闭。</strong></li><li id="d745" class="lx ly hi it b iu mg iy mh jc mi jg mj jk mk jo ms md me mf bi translated"><strong class="it hj">半开。</strong></li></ol><p id="282d" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟当断路器处于“<strong class="it hj">闭合</strong>状态时，断路器正常工作(通过服务传递请求)。但是当故障超过阈值极限时，断路器跳闸。如上图所示，此“<strong class="it hj">打开</strong>电路(状态切换到“打开”)。</p><p id="758a" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟当电路“<strong class="it hj">打开</strong>”时，传入的请求将返回错误，而不会尝试执行真正的操作</p><p id="3f61" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟一段时间后，断路器进入“<strong class="it hj">半开</strong>状态。在这种状态下，断路器将允许有限数量的测试请求通过，如果请求成功，断路器复位并返回到“<strong class="it hj">闭合</strong>状态，通信将照常通过。如果这个请求失败，断路器返回到打开状态，直到另一个超时。</p><blockquote class="ml mm mn"><p id="0e80" class="ir is mo it b iu iv iw ix iy iz ja jb mp jd je jf mq jh ji jj mr jl jm jn jo hb bi translated">例如:服务A应该在200毫秒内响应。</p><p id="7601" class="ir is mo it b iu iv iw ix iy iz ja jb mp jd je jf mq jh ji jj mr jl jm jn jo hb bi translated">0ms -100ms:预期延迟间隔。<br/> 100ms -200ms:有风险。</p><p id="8000" class="ir is mo it b iu iv iw ix iy iz ja jb mp jd je jf mq jh ji jj mr jl jm jn jo hb bi translated">如果响应时间超过200毫秒，则切断服务。</p><p id="d24e" class="ir is mo it b iu iv iw ix iy iz ja jb mp jd je jf mq jh ji jj mr jl jm jn jo hb bi translated">如果您创建了一个监控仪表板，您可以监控请求及其响应时间。在此基础上，你可以决定阈值水平。</p></blockquote><p id="d26a" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟因此，断路器模式的工作原理是，如果请求的数量(例如，75%的请求)达到上限(150-200毫秒)，这意味着服务正在缓慢失败。</p><figure class="lb lc ld le fd ij er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es ny"><img src="../Images/195c16df489cc96a11736a783ee84c35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VMmMl0gA3xyh_gYQmDI4FQ.png"/></div></div><figcaption class="im in et er es io ip bd b be z dx">Figure 15</figcaption></figure><figure class="lb lc ld le fd ij er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es nz"><img src="../Images/8734f8c0021893028d734e64fd780e40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IRerpJTWp370Au3SX_WJKg.png"/></div></div><figcaption class="im in et er es io ip bd b be z dx">Figure 16</figcaption></figure><p id="0b91" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟如果发生次数超过200毫秒(服务的最大阈值)，代理将识别出该服务不再响应。</p><p id="2fcb" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟它接下来做的是，访问服务A的请求将回切。它中断了代理和服务a之间的连接。</p><p id="4cf9" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟现在你的代理不会去服务a，这意味着它不会等待。</p></div><div class="ab cl lg lh gp li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="hb hc hd he hf"><h2 id="d22a" class="mz jz hi bd ka na nb nc ke nd ne nf ki jc ng nh km jg ni nj kq jk nk nl ku nm bi translated"><strong class="ak">但是为什么不直接去服务看看。如果失败，请求可以返回。为什么一定要有介于两者之间的东西？🤥</strong></h2><p id="6ca9" class="pw-post-body-paragraph ir is hi it b iu kw iw ix iy kx ja jb jc ky je jf jg kz ji jj jk la jm jn jo hb bi translated">🌟假设你有30秒的超时时间。如果每个请求都试图到达服务A，不考虑它失败，所有来自消费者的请求将等待30秒。这些请求将在30秒后超时。</p><p id="32da" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟在这30秒内，剩余的使用A的请求将尝试到达服务A，这些请求也在队列中等待。</p><p id="1f14" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟因此，断路器模式所做的是，如果服务失败次数超过给定阈值，它将不会尝试到达服务A，而是回切到消费者，告知服务A不可用。</p><h2 id="066a" class="mz jz hi bd ka na nb nc ke nd ne nf ki jc ng nh km jg ni nj kq jk nk nl ku nm bi translated"><strong class="ak">那么如何连接回去呢？🤔</strong></h2><p id="af1d" class="pw-post-body-paragraph ir is hi it b iu kw iw ix iy kx ja jb jc ky je jf jg kz ji jj jk la jm jn jo hb bi translated">🌟在后台，它及时向服务A发送ping请求(图16)或默认请求。因此，当响应时间回到正常阈值时，它将再次打开请求。</p><p id="91a5" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟因此，到达消费服务A的下一个请求将直接到达服务A</p><blockquote class="ml mm mn"><p id="3668" class="ir is mo it b iu iv iw ix iy iz ja jb mp jd je jf mq jh ji jj mr jl jm jn jo hb bi translated">在故障期间，所有使用服务A的请求都会被发送回一条错误消息。所以现在没有排队。当服务恢复时，它将为新的流量开放。</p></blockquote></div><div class="ab cl lg lh gp li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="hb hc hd he hf"><h2 id="f6d8" class="mz jz hi bd ka na nb nc ke nd ne nf ki jc ng nh km jg ni nj kq jk nk nl ku nm bi translated">但是我们不是没有回应一些消费者的要求吗？🙄</h2><p id="36d3" class="pw-post-body-paragraph ir is hi it b iu kw iw ix iy kx ja jb jc ky je jf jg kz ji jj jk la jm jn jo hb bi translated">🌟是的，一些请求被(没有排队)发回给消费者，并带有一条错误消息，但是他们没有得到服务a的响应。</p><p id="b9db" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟但是，如果这些请求试图到达服务A(失败了),并且这些请求被排队，结果会是什么呢？</p><p id="cd5e" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟由于服务后面创建的巨大队列，整个系统可能已经失败。因为即使服务恢复了，这些队列也会消耗服务A，最终服务A会失败。</p><p id="75a3" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟但是使用这种方法服务，A可能会在一段时间内失败，某些请求可能无法从服务A获得响应，并将返回一个错误。但是一旦服务A恢复在线，下一个到来的流量将被服务。所以卡萨卡德的失败不会发生。</p><p id="e852" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟这就是断路器模式背后的原理。</p><blockquote class="ml mm mn"><p id="f865" class="ir is mo it b iu iv iw ix iy iz ja jb mp jd je jf mq jh ji jj mr jl jm jn jo hb bi translated">从用户的角度来看，长时间等待响应并不是一种好的用户体验。与其让消费者等待更长的时间，不如快速做出反应。不管是成功还是失败；重要的是用户不会一直等待。</p></blockquote></div><div class="ab cl lg lh gp li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="hb hc hd he hf"><p id="fa70" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">🌟好吧，我希望你现在知道断路器模式和它是如何工作的。在下一篇文章中，我们来谈谈代理设计模式。请在下面评论您的想法和反馈。😃。谢谢你。</p><h1 id="f072" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">参考</h1><figure class="lb lc ld le fd ij"><div class="bz dy l di"><div class="oa ob l"/></div></figure><div class="oc od ez fb oe of"><a href="https://www.amazon.com/Release-Design-Deploy-Production-Ready-Software/dp/1680502395" rel="noopener  ugc nofollow" target="_blank"><div class="og ab dw"><div class="oh ab oi cl cj oj"><h2 class="bd hj fi z dy ok ea eb ol ed ef hh bi translated">释放它！:设计和部署生产就绪软件</h2><div class="om l"><h3 class="bd b fi z dy ok ea eb ol ed ef dx translated">释放它！:在Amazon.com上设计和部署生产就绪软件。*免费*送货到…</h3></div><div class="on l"><p class="bd b fp z dy ok ea eb ol ed ef dx translated">www.amazon.com</p></div></div><div class="oo l"><div class="op l oq or os oo ot ik of"/></div></div></a></div><div class="oc od ez fb oe of"><a href="https://martinfowler.com/bliki/CircuitBreaker.html" rel="noopener  ugc nofollow" target="_blank"><div class="og ab dw"><div class="oh ab oi cl cj oj"><h2 class="bd hj fi z dy ok ea eb ol ed ef hh bi translated">断路器</h2><div class="om l"><h3 class="bd b fi z dy ok ea eb ol ed ef dx translated">软件系统对运行在不同进程中的软件进行远程调用是很常见的，可能是在不同的…</h3></div><div class="on l"><p class="bd b fp z dy ok ea eb ol ed ef dx translated">martinfowler.com</p></div></div><div class="oo l"><div class="ou l oq or os oo ot ik of"/></div></div></a></div><div class="oc od ez fb oe of"><a href="https://www.edureka.co/blog/microservices-design-patterns#CircuitBreaker" rel="noopener  ugc nofollow" target="_blank"><div class="og ab dw"><div class="oh ab oi cl cj oj"><h2 class="bd hj fi z dy ok ea eb ol ed ef hh bi translated">微服务设计模式|微服务模式| Edureka</h2><div class="om l"><h3 class="bd b fi z dy ok ea eb ol ed ef dx translated">在当今的市场上，微服务已经成为构建应用程序的首选解决方案。众所周知，它们可以解决…</h3></div><div class="on l"><p class="bd b fp z dy ok ea eb ol ed ef dx translated">www.edureka.co</p></div></div><div class="oo l"><div class="ov l oq or os oo ot ik of"/></div></div></a></div><div class="oc od ez fb oe of"><a href="https://techblog.constantcontact.com/software-development/circuit-breakers-and-microservices/" rel="noopener  ugc nofollow" target="_blank"><div class="og ab dw"><div class="oh ab oi cl cj oj"><h2 class="bd hj fi z dy ok ea eb ol ed ef hh bi translated">断路器和微服务架构|持续接触技术博客</h2><div class="om l"><h3 class="bd b fi z dy ok ea eb ol ed ef dx translated">到目前为止，众所周知，微服务架构有许多优势。这些包括低耦合…</h3></div><div class="on l"><p class="bd b fp z dy ok ea eb ol ed ef dx translated">techblog.constantcontact.com</p></div></div><div class="oo l"><div class="ow l oq or os oo ot ik of"/></div></div></a></div></div></div>    
</body>
</html>