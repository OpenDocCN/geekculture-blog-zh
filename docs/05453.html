<html>
<head>
<title>Wow! Backtest RSI Crossover Strategy in Elasticsearch</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">哇！弹性搜索中的回测RSI交叉策略</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/wow-backtest-rsi-crossover-strategy-in-elasticsearch-1cdf837a72a1?source=collection_archive---------14-----------------------#2021-07-21">https://medium.com/geekculture/wow-backtest-rsi-crossover-strategy-in-elasticsearch-1cdf837a72a1?source=collection_archive---------14-----------------------#2021-07-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="e1e9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有时候，你可能会有一些疯狂的想法，想测试你的交易策略。通过使用历史市场数据进行回溯测试，您可以评估风险、利润和衡量绩效，以获得在未来使用交易策略的信心。当然，如果你是一个熟练的程序员，你是没有问题的。但是，您需要编写一个复杂且负载繁重的程序来处理数据检索后的数据分析。由于Elasticsearch在搜索、数据分析、机器学习方面的强大能力，值得写一系列关于Elasticsearch回溯测试不同交易策略的文章供大家参考。</p><p id="1cc5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我之前的文章里，<a class="ae jd" rel="noopener" href="/nerd-for-tech/rsi-bb-or-rsi-bb-easy-lets-test-it-with-elasticsearch-51129e8819e5"> RSI BB还是RSI &amp; BB？简单，我们用Elasticsearch </a>来测试一下，我们已经介绍了如何使用Elasticsearch实现相对强弱指数(RSI)指标。本文将继续制作一个简单的工具来回测Elasticsearch中的RSI交易策略。由于大部分工作都是在Elasticsearch集群中完成的，客户端的工作量不会很大。Elasticsearch将提供买入或卖出信号，然后将它们与一个简单的Python程序集成，以进一步分析信号并生成报告。建议读者快速浏览一下我之前的文章，了解RSI以及使用Elasticsearch的实现细节。</p><p id="e579" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">RSI是一个动量指标，它提供了价格变化的信息，以支持买卖资产的机会。价格变化被转换成两种类型的数据，最近的总收益和最近的总损失，通常周期为14。RSI方程可以写成这样，其中SMA <em class="je"> gain，n，1 </em>和SMA <em class="je"> loss，n，1 </em>分别是收益的总最近移动平均线和亏损的总最近移动平均线。对应于带窗口<em class="je"> n </em>的Elasticsearch SMA函数，需要右移1个数据来包含当前数据。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es jf"><img src="../Images/c3893685681498a216ba57ad166c8101.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p7ODA9MHw6U9qwVg5hQKuw.jpeg"/></div></div></figure><p id="1198" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">RSI交叉策略定义RSI在指定值的交叉，表示超买(&gt; = 70)和超卖(&lt;= 30) signals. For other RSI values, be patient and wait for the buy or sell signal. It is much easier to use graphs to observe changes in values. In this article, we try to apply backtesting to commission-free exchange-traded funds (ETFs) and focus on Elasticsearch as an analysis tool. The following example randomly selects “Fidelity International Multifactor ETF”. Its ticker symbol is FDEV. 10 more ETFs randomly selected will be run, and the final results will be shown later. The data is selected from the time range between 2021–01–15 and 2021–05–31 provided by IEX, Investors Exchange. In the chart below, the RSI is plotted together with the daily closing price. In the daily price curve, the RSI values over 70 are marked in red, and the RSI values less than 30 are marked in blue.</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es jr"><img src="../Images/88b6723649e2437de7ee90889cf500d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qRzsi6IuFZoRgSX8A4iXzw.jpeg"/></div></div></figure><p id="36a6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Here, we present a simple RSI crossover strategy and use Elasticsearch to show the implementation details.</p><p id="6524" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">◆ Assuming that it is restricted to buy and hold 1 share at a time, no transaction will occur until the held share is sold. <br/> ◆当RSI值&lt; = 30时买入1股。<br/> ◆当RSI值&gt; = 70时卖出1股。<br/> ◆测试期结束时，持有份额按现价兑现。</p><p id="8113" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有4个蓝点和10个红点，但是基于策略只允许两个买入和两个卖出交易。让我们描述一下使用Elasticsearch的实现。假设有一个用数据填充的Elasticsearch索引，其使用的数据映射与上一篇论文中描述的相同。以下步骤演示了REST API请求体的代码。</p><blockquote class="js jt ju"><p id="04d7" class="if ig je ih b ii ij ik il im in io ip jv ir is it jw iv iw ix jx iz ja jb jc hb bi translated">通过搜索操作收集所有相关文件</p></blockquote><p id="d910" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用带有“must”子句的“bool”查询来收集符号为FDEV且日期在2021–01–15和2021–05–31之间的文档。由于14个交易日移动平均线的计算，额外数据调整1个月(从2020年12月15日到2021年1月14日)。</p><pre class="jg jh ji jj fd jy jz ka kb aw kc bi"><span id="5bc7" class="kd ke hi jz b fi kf kg l kh ki">{<br/>    "query": {<br/>        "bool": {<br/>            "must": [<br/>                {"range": {"date": {"gte": "2020-12-15", "lte": "2021-05-31"}}},<br/>                {"term": {"symbol": "FDEV"}}<br/>            ]<br/>        }<br/>    },</span></pre><blockquote class="js jt ju"><p id="8779" class="if ig je ih b ii ij ik il im in io ip jv ir is it jw iv iw ix jx iz ja jb jc hb bi translated">提取基金的收盘价值</p></blockquote><p id="539b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用名为Backtest_RSI的“date_histogram”聚合，参数“field”为“date ”,参数“interval”为“1d ”,提取基金每天的价格。然后是名为Daily的“平均”聚合，以检索收盘价，因为后续的管道聚合不能直接使用文档字段。</p><pre class="jg jh ji jj fd jy jz ka kb aw kc bi"><span id="158d" class="kd ke hi jz b fi kf kg l kh ki">    "aggs": {<br/>        "Backtest_RSI": {<br/>            "date_histogram": {<br/>                "field": "date",<br/>                "interval": "1d",<br/>                "format": "yyyy-MM-dd"<br/>            },<br/>            "aggs": {<br/>                "Daily": {<br/>                    "avg": {"field": "close"}<br/>                },</span></pre><blockquote class="js jt ju"><p id="6c7b" class="if ig je ih b ii ij ik il im in io ip jv ir is it jw iv iw ix jx iz ja jb jc hb bi translated">提取桶的日期</p></blockquote><p id="f087" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于存在额外的数据，后续操作需要稍后过滤掉超出范围的部分。一个名为“DateStr”的“min”聚合将获取存储桶的日期。在Elasticsearch服务器中，日期字段以纪元时间存储。时间单位是毫秒，时区是UTC。</p><pre class="jg jh ji jj fd jy jz ka kb aw kc bi"><span id="3978" class="kd ke hi jz b fi kf kg l kh ki">                "DateStr": {<br/>                    "min": {"field": "date"}<br/>                },</span></pre><blockquote class="js jt ju"><p id="83ee" class="if ig je ih b ii ij ik il im in io ip jv ir is it jw iv iw ix jx iz ja jb jc hb bi translated">选择包含1个以上文档的存储桶</p></blockquote><p id="ae9b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了过滤掉空的时段(非交易日)，使用一个名为SDaily的“bucket_selector”聚合来选择文档计数大于0的时段。</p><pre class="jg jh ji jj fd jy jz ka kb aw kc bi"><span id="11f6" class="kd ke hi jz b fi kf kg l kh ki">                "SDaily": {<br/>                    "bucket_selector": {<br/>                        "buckets_path": {"count":"_count"},<br/>                        "script": "params.count &gt; 0"<br/>                    }<br/>                },</span></pre><blockquote class="js jt ju"><p id="5d6a" class="if ig je ih b ii ij ik il im in io ip jv ir is it jw iv iw ix jx iz ja jb jc hb bi translated">计算每日差异</p></blockquote><p id="59bb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用名为Price_Diff的“衍生”聚合，并使用参数“buckets_path”来指定每日收盘值，以计算与前一个值的差异。</p><pre class="jg jh ji jj fd jy jz ka kb aw kc bi"><span id="2fba" class="kd ke hi jz b fi kf kg l kh ki">                "Price_Diff": {<br/>                    "derivative": {<br/>                        "buckets_path": "Daily" <br/>                     }<br/>                },</span></pre><blockquote class="js jt ju"><p id="a49e" class="if ig je ih b ii ij ik il im in io ip jv ir is it jw iv iw ix jx iz ja jb jc hb bi translated">确定每日值相对于之前的数据是盈利还是亏损</p></blockquote><p id="09d6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用两个名为Gain和Loss的“bucket_script”聚合，并使用参数“buckets_path”来指定Diff聚合的结果以确定值。两个值都是正的。</p><pre class="jg jh ji jj fd jy jz ka kb aw kc bi"><span id="2d04" class="kd ke hi jz b fi kf kg l kh ki">                "Gain": {<br/>                    "bucket_script": {<br/>                        "buckets_path": {"Price_Diff": "Price_Diff"},<br/>                        "script": "(params.Price_Diff &gt; 0) ? params.Price_Diff : 0"<br/>                    }<br/>                }, <br/>                "Loss": {<br/>                    "bucket_script": {<br/>                        "buckets_path": {"Price_Diff": "Price_Diff"}, <br/>                        "script": "(params.Price_Diff &lt; 0) ? -params.Price_Diff : 0"<br/>                    }<br/>                },</span></pre><blockquote class="js jt ju"><p id="5332" class="if ig je ih b ii ij ik il im in io ip jv ir is it jw iv iw ix jx iz ja jb jc hb bi translated">计算总收益和总损失的每日简单移动平均线</p></blockquote><p id="48b3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用两个“移动_fn”聚合，命名为GainSMA和LossSMA，参数window为14，参数“buckets_path”分别为增益和损耗。参数“shift”设置为1，以包括当天和过去13个交易日的数据。SMA是使用未加权平均函数(MovingFunctions.unweightedAvg)计算的。</p><pre class="jg jh ji jj fd jy jz ka kb aw kc bi"><span id="71f1" class="kd ke hi jz b fi kf kg l kh ki">                "GainSMA": {<br/>                    "moving_fn": {<br/>                        "script": "MovingFunctions.unweightedAvg(values)", "window": 14, "buckets_path": "Gain", "shift":1<br/>                    }<br/>                },<br/>                "LossSMA": {<br/>                    "moving_fn": {<br/>                        "script": "MovingFunctions.unweightedAvg(values)", "window": 14, "buckets_path": "Loss", "shift":1<br/>                    }<br/>                },</span></pre><blockquote class="js jt ju"><p id="8826" class="if ig je ih b ii ij ik il im in io ip jv ir is it jw iv iw ix jx iz ja jb jc hb bi translated">计算RSI</p></blockquote><p id="4873" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用名为RSI的“bucket_script”聚合和参数“buckets _ path”来指定GainSMA和LossSMA的结果。然后根据脚本中的等式计算RSI指标。</p><pre class="jg jh ji jj fd jy jz ka kb aw kc bi"><span id="430a" class="kd ke hi jz b fi kf kg l kh ki">                "RSI": {<br/>                    "bucket_script": {<br/>                        "buckets_path": {"GainSMA": "GainSMA", "LossSMA": "LossSMA"}, <br/>                        "script": "100 - 100/(1+params.GainSMA/params.LossSMA)"<br/>                    }<br/>                },</span></pre><blockquote class="js jt ju"><p id="b7e1" class="if ig je ih b ii ij ik il im in io ip jv ir is it jw iv iw ix jx iz ja jb jc hb bi translated">识别RSI值的类型</p></blockquote><p id="6ad0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用名为RSI_Type的“bucket_script”聚合和参数“buckets_path”来指定RSI值，以确定类型。如果RSI值&gt; = 70，则将类型设置为2。如果RSI值&lt;= 30. Set the type to 0 for other RSI values.</p><pre class="jg jh ji jj fd jy jz ka kb aw kc bi"><span id="d13a" class="kd ke hi jz b fi kf kg l kh ki">                "RSI_Type": {<br/>                    "bucket_script": {<br/>                        "buckets_path": {"RSI": "RSI"}, "script": "params.RSI &gt;= 70 ? 2 : params.RSI &lt;= 30 ? 1 : 0"<br/>                    }<br/>                },</span></pre><blockquote class="js jt ju"><p id="994e" class="if ig je ih b ii ij ik il im in io ip jv ir is it jw iv iw ix jx iz ja jb jc hb bi translated">Filter out the additional documents for output</p></blockquote><p id="1a58" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Use a “bucket_selector” aggregation, named Buy_Sell_Signal, with the parameter “buckets_path” to specify “DateStr” and “RSI_Type” to select the correct buckets. The selection criteria are those buckets having the date on or after 2021–01–15 (the epoch time 1612137600000 in milliseconds) and RSI_Type = 1 (RSI &gt; = 70)或RSI_Type = 2 (RSI &lt;= 30).</p><pre class="jg jh ji jj fd jy jz ka kb aw kc bi"><span id="87b6" class="kd ke hi jz b fi kf kg l kh ki">                "Buy_Sell_Signal": {<br/>                    "bucket_selector": {<br/>                        "buckets_path": {"DateStr": "DateStr", "RSI_Type": "RSI_Type"}, <br/>                        "script": "params.DateStr &gt;= 1610697600000L &amp;&amp; (params.RSI_Type == 1 || params.RSI_Type == 2)"<br/>                     }<br/>                }</span></pre><blockquote class="js jt ju"><p id="403d" class="if ig je ih b ii ij ik il im in io ip jv ir is it jw iv iw ix jx iz ja jb jc hb bi translated">After collecting results, we can draw the figures as shown before.</p></blockquote></div><div class="ab cl kj kk gp kl" role="separator"><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko"/></div><div class="hb hc hd he hf"><p id="8cb9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">The result of the implementation will emit buy or sell signals; however, those signals only satisfy the second and the third cases of our simply RSI trading strategy. For the first and fourth cases, we need to use Python programming language to code the program. The program includes four parts.</p><p id="5f0f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">◆ Read two command line parameters. One is for the selected ticker symbol, and the other is for the file name containing the trading strategy written in Elasticsearch REST API Request body using JSON format.<br/> ◆从Elasticsearch服务器获取数据，则将类型设置为1。<br/> ◆解析响应数据，提炼买卖信号。<br/> ◆上报回测统计。</p><p id="2680" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">主要功能如下所示:</p><pre class="jg jh ji jj fd jy jz ka kb aw kc bi"><span id="5844" class="kd ke hi jz b fi kf kg l kh ki">def main(argv):<br/>    inputfile, symbol = get_opt(argv)<br/>    resp = get_data(inputfile, symbol)<br/>    transactions = parse_data(resp)<br/>    report(transactions)</span></pre><p id="111d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，只显示了细化买卖信号的代码段。读者可以进一步参考GitHub上的开源项目(<a class="ae jd" href="https://github.com/wtwong316/Backtest_RSI" rel="noopener ugc nofollow" target="_blank"> Backtest_RSI </a>)。为了确保一次买入并持有一股，并且在持有的股票卖出之前没有交易发生，我们使用布尔变量“hold”来确保交易满足以下条件。</p><p id="7034" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">◆当保持标志为假时，买入信号生效<br/> ◆当保持标志为真时，卖出信号生效</p><p id="a066" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">parse_data()函数如下所示。最后，事务数组将包含有效信号。</p><pre class="jg jh ji jj fd jy jz ka kb aw kc bi"><span id="50b6" class="kd ke hi jz b fi kf kg l kh ki"># parse the response data and refine the buy/sell signal<br/>def parse_data(resp):<br/>    result = json.loads(resp)<br/>    aggregations = result['aggregations']<br/>    if aggregations and 'Backtest_RSI' in aggregations:<br/>        Backtest_RSI = aggregations['Backtest_RSI']</span><span id="4d68" class="kd ke hi jz b fi kq kg l kh ki">    transactions = []<br/>    hold = False<br/>    if Backtest_RSI and 'buckets' in Backtest_RSI:<br/>        for bucket in Backtest_RSI['buckets']:<br/>            transaction = {}<br/>            transaction['date'] = bucket['key_as_string']<br/>            transaction['Daily'] = bucket['Daily']['value']<br/>            # honor buy signal if there is no share hold<br/>            if bucket['RSI_Type']['value'] == 1 and not hold:<br/>                transaction['buy_or_sell'] = 'buy'<br/>                hold = True<br/>            # honor sell signal if there is a share hold<br/>            elif bucket['RSI_Type']['value'] == 2 and hold:<br/>                transaction['buy_or_sell'] = 'sell'<br/>                hold = False<br/>            # for other situations, just hold the action<br/>            else:<br/>                transaction['buy_or_sell'] = 'hold'<br/>            transactions.append(transaction)</span><span id="3386" class="kd ke hi jz b fi kq kg l kh ki">    return transactions</span></pre><p id="d8f2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">python程序提供交易策略的统计数据，包括整个买卖交易的“赢”和“输”，如下所示:</p><pre class="jg jh ji jj fd jy jz ka kb aw kc bi"><span id="f393" class="kd ke hi jz b fi kf kg l kh ki">number of buy:             2<br/>number of sell:             2<br/>number of win:             2<br/>number of lose:            0<br/>total profit:              2.02<br/>profit/transaction:     1.01<br/>maximum buy price:     27.20<br/>profit percent:         7.42%</span></pre><p id="c0ff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下表收集了2021年1月15日至2021年5月31日期间使用RSI交叉交易策略随机挑选的11只ETF的所有统计数据。结果表明，这个时期是一个很好的交易时期，因为所有选择的符号都可以获利。但是，不要根据大多数交易者的建议使用单一指标进行交易。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es kr"><img src="../Images/ebce9ae94451e921dcca6979b22f6e81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jJKLGCM1lCf15NntrjqnYA.jpeg"/></div></div></figure></div><div class="ab cl kj kk gp kl" role="separator"><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko"/></div><div class="hb hc hd he hf"><p id="176e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">备注:<br/>一、感谢IEX(投资者交易所)提供ETF数据，GitHub提供开源项目存储。<br/>二世。本文基于一种技术思路，不构成任何投资建议。读者在使用时必须承担自己的责任。<br/>三。文章可能还有错误，恳请读者指正。<br/>四。感兴趣的读者可以参考作者撰写的《弹性搜索的基本技巧》一书。《高级弹性搜索7.0》，2019年8月，Packt，ISBN: 9781789957754。</p></div></div>    
</body>
</html>