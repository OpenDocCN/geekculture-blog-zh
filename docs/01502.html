<html>
<head>
<title>Join Files</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">加入文件</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/join-files-cc5e38e3c658?source=collection_archive---------17-----------------------#2021-04-12">https://medium.com/geekculture/join-files-cc5e38e3c658?source=collection_archive---------17-----------------------#2021-04-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="84ba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">假设您有一些多线程/多进程应用程序，其中每个线程/进程创建一些文件(每个线程/进程创建<strong class="ih hj">不同的</strong>文件)，您想要将它们合并到一个文件中。创建的文件有一些命名约定，例如<code class="du jd je jf jg b">output*.txt</code>，结果文件应该是<code class="du jd je jf jg b">output.txt</code>。</p><p id="2166" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意</strong>:例如，你可以用线程/进程名来代替星号，这样就足够独特了。</p><p id="ecd5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，在主进程/线程中，您想要创建一个最终文件，该文件将包含所有已创建文件的内容(它们由文件掩码标识，如<code class="du jd je jf jg b">output*.txt</code>)到一个最终文件(如<code class="du jd je jf jg b">output.txt</code>)。</p><p id="9ac4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意:</strong>如果您期望有一些<code class="du jd je jf jg b">output-SpawnPoolWorker-2.txt</code>而它却不存在，您可能想要在最终文件中添加一些指示。下面的代码不会自动执行。如果需要，您可以在加入结果之前自己创建带有错误指示的<code class="du jd je jf jg b">output-SpawnPoolWorker-2.txt</code>。</p><p id="2fa7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了做到这一点，我创建了<code class="du jd je jf jg b">join_files</code>函数。</p></div><div class="ab cl jh ji gp jj" role="separator"><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm"/></div><div class="hb hc hd he hf"><p id="f199" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">源代码你可以在这里找到<a class="ae jo" href="https://github.com/alex-ber/AlexBerUtils/blob/master/alexber/utils/mains.py" rel="noopener ugc nofollow" target="_blank"/>。它是我的AlexBerUtils项目的一部分。</p><p id="1270" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以从PyPi安装AlexBerUtils:</p><p id="6583" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du jd je jf jg b">python3 -m pip install -U alex-ber-utils</code></p><p id="7c63" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">关于如何安装的更多详细说明，请参见<a class="ae jo" href="https://github.com/alex-ber/AlexBerUtils" rel="noopener ugc nofollow" target="_blank">这里的</a>。</p></div><div class="ab cl jh ji gp jj" role="separator"><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm"/></div><div class="hb hc hd he hf"><p id="5537" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们看看应用程序的一些代码存根:</p><p id="ba2c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du jd je jf jg b">app.py</code>的代码:</p><figure class="jp jq jr js fd jt"><div class="bz dy l di"><div class="ju jv l"/></div></figure><p id="b195" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意:</strong>这里我使用的是<em class="jw"> init_app_conf </em>模块。你可以在这里阅读<a class="ae jo" rel="noopener" href="/analytics-vidhya/my-major-init-app-conf-module-1a5d9fb3998c"/>。</p><p id="42b6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意:</strong>通常，在脚本/应用程序的<code class="du jd je jf jg b">main()</code>函数的末尾有以下几行:</p><figure class="jp jq jr js fd jt"><div class="bz dy l di"><div class="ju jv l"/></div></figure><p id="a6bc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">看这里<a class="ae jo" href="https://alex-ber.medium.com/making-more-yo-relative-path-to-file-to-work-fbf6280f9511" rel="noopener">为我的替代设置制作更多的文件相对路径</a>。</p><p id="b410" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要理解<code class="du jd je jf jg b">GuardedWorkerException</code>，请参见<a class="ae jo" href="https://alex-ber.medium.com/exception-propagation-from-another-process-bb09894ba4ce" rel="noopener">来自另一个进程的异常传播</a>。</p><p id="d23a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以在另一个进程的<a class="ae jo" href="https://alex-ber.medium.com/exception-propagation-from-another-process-bb09894ba4ce" rel="noopener">异常传播中的<code class="du jd je jf jg b">Appendix</code>上查找缺失的代码部分。</a></p></div><div class="ab cl jh ji gp jj" role="separator"><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm"/></div><div class="hb hc hd he hf"><p id="07ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里有两个有趣的部分:<code class="du jd je jf jg b">_write_partial_output()</code>和<code class="du jd je jf jg b">join_files()</code>。</p><p id="ed90" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du jd je jf jg b">_write_partial_output()</code>应该真的是某个类的一部分。<code class="du jd je jf jg b">account_id</code>、<code class="du jd je jf jg b">user_id</code>应为计算值。第一部分，第67-74行只是一些关于如何为每个进程/线程生成唯一(足够)文件名的<em class="jw">示例</em>代码——它从配置字典中获取不带后缀的文件名，并附加一些唯一部分和保留后缀(也保留目录)。第二部分，第75–76行是将内容存储为CSV的简单方法。我要重复一遍，这只是样本，并不打算成为通用的可重用代码片段。</p><p id="edf7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du jd je jf jg b">join_files() </code> —在我们调用这个方法之前，我们从配置字典中检索完整的文件名(例如，<code class="du jd je jf jg b">/tmp/output.txt</code>)。<code class="du jd je jf jg b">join_files()</code>会查看文件被指出的目录(例如<code class="du jd je jf jg b">/tmp/</code>)；它的文件名将是结果文件的文件名(例如<code class="du jd je jf jg b">output.txt</code>),并且<code class="du jd je jf jg b">join_files()</code>将在<code class="du jd je jf jg b">/tmp/</code>中的<code class="du jd je jf jg b">output*.txt</code>上查找所有创建的文件(这在<code class="du jd je jf jg b">_write_partial_output()</code>中完成)。</p></div><div class="ab cl jh ji gp jj" role="separator"><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm"/></div><div class="hb hc hd he hf"><h1 id="54e5" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated"><code class="du jd je jf jg b">join_files()</code>如何工作？</h1><ol class=""><li id="09e7" class="kv kw hi ih b ii kx im ky iq kz iu la iy lb jc lc ld le lf bi translated">首先，它创建了引用输出文件的类似文件的对象(用于写入)。</li><li id="4810" class="kv kw hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">然后迭代具有相似掩码的文件(如<code class="du jd je jf jg b">output*.txt</code>)并创建类似文件的对象(用于读取)。<br/> <strong class="ih hj">实现注意:</strong>我用的是<code class="du jd je jf jg b">pathlib.path.glob()</code>。</li><li id="2718" class="kv kw hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">然后，它将数据从类似读取文件的对象逐块复制到类似写入文件的对象。<br/> <strong class="ih hj">实现注意:</strong>我用的是<code class="du jd je jf jg b">shutil.copyfileobj()</code>。</li></ol></div><div class="ab cl jh ji gp jj" role="separator"><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm"/></div><div class="hb hc hd he hf"><p id="7913" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">源代码你可以在这里找到<a class="ae jo" href="https://github.com/alex-ber/AlexBerUtils/blob/master/alexber/utils/mains.py" rel="noopener ugc nofollow" target="_blank"/>。它是我的AlexBerUtils项目的一部分。</p><p id="a2a4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以从PyPi安装AlexBerUtils:</p><p id="e0f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du jd je jf jg b">python3 -m pip install -U alex-ber-utils</code></p><p id="49f2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">参见<a class="ae jo" href="https://github.com/alex-ber/AlexBerUtils" rel="noopener ugc nofollow" target="_blank">此处</a>了解更多关于如何安装的详细说明。</p></div><div class="ab cl jh ji gp jj" role="separator"><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm"/></div><div class="hb hc hd he hf"><h1 id="7f4d" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">另请参见:</h1><ul class=""><li id="d2d2" class="kv kw hi ih b ii kx im ky iq kz iu la iy lb jc ll ld le lf bi translated"><a class="ae jo" rel="noopener" href="/analytics-vidhya/integrating-pythons-logging-and-warnings-packages-7ffd6f65e02d">集成Python的日志和警告包</a>。</li><li id="f5bc" class="kv kw hi ih b ii lg im lh iq li iu lj iy lk jc ll ld le lf bi translated"><code class="du jd je jf jg b"><a class="ae jo" href="https://github.com/alex-ber/AlexBerUtils/blob/master/alexber/utils/mains.py" rel="noopener ugc nofollow" target="_blank"><em class="jw">mains</em></a></code> <em class="jw"> </em>模块中的<code class="du jd je jf jg b"><a class="ae jo" href="https://github.com/alex-ber/AlexBerUtils/blob/master/alexber/utils/mains.py#L12" rel="noopener ugc nofollow" target="_blank"><em class="jw">fixabscwd()</em></a><em class="jw"> </em></code>功能或<a class="ae jo" rel="noopener" href="/@alex_ber/making-relative-path-to-file-to-work-d5d0f1da67bf">制作文件的相对路径来工作</a>。</li><li id="0d78" class="kv kw hi ih b ii lg im lh iq li iu lj iy lk jc ll ld le lf bi translated"><code class="du jd je jf jg b"><a class="ae jo" href="https://github.com/alex-ber/AlexBerUtils/blob/master/alexber/utils/mains.py" rel="noopener ugc nofollow" target="_blank"><em class="jw">mains</em></a></code> <em class="jw"> </em>模块中的<code class="du jd je jf jg b"><a class="ae jo" href="https://github.com/alex-ber/AlexBerUtils/blob/master/alexber/utils/mains.py#L237" rel="noopener ugc nofollow" target="_blank"><em class="jw">fix_retry_env</em></a><em class="jw">() </em></code>功能或<a class="ae jo" href="https://alex-ber.medium.com/make-path-to-file-on-windows-works-on-linux-402ed3624f66" rel="noopener">在Windows上制作文件路径在Linux上工作。</a></li><li id="b782" class="kv kw hi ih b ii lg im lh iq li iu lj iy lk jc ll ld le lf bi translated"><code class="du jd je jf jg b"><a class="ae jo" href="https://github.com/alex-ber/AlexBerUtils/blob/master/alexber/utils/mains.py#L263" rel="noopener ugc nofollow" target="_blank">FixRelCwd()</a></code>功能在<code class="du jd je jf jg b"><a class="ae jo" href="https://github.com/alex-ber/AlexBerUtils/blob/master/alexber/utils/mains.py" rel="noopener ugc nofollow" target="_blank"><em class="jw">mains</em></a></code> <em class="jw"> </em>模块或<a class="ae jo" href="https://alex-ber.medium.com/making-more-yo-relative-path-to-file-to-work-fbf6280f9511" rel="noopener">模块中多以相对路径文件来工作</a></li><li id="3378" class="kv kw hi ih b ii lg im lh iq li iu lj iy lk jc ll ld le lf bi translated"><code class="du jd je jf jg b"><a class="ae jo" href="https://github.com/alex-ber/AlexBerUtils/blob/master/alexber/utils/mains.py" rel="noopener ugc nofollow" target="_blank"><em class="jw">mains</em></a></code> <em class="jw"> </em>模块中的<code class="du jd je jf jg b"><a class="ae jo" href="https://github.com/alex-ber/AlexBerUtils/blob/master/alexber/utils/mains.py#L295" rel="noopener ugc nofollow" target="_blank">GuardedWorkerException()</a></code>函数或<a class="ae jo" href="https://alex-ber.medium.com/exception-propagation-from-another-process-bb09894ba4ce" rel="noopener">异常从另一个进程</a>传播</li><li id="6572" class="kv kw hi ih b ii lg im lh iq li iu lj iy lk jc ll ld le lf bi translated"><code class="du jd je jf jg b"><a class="ae jo" href="https://github.com/alex-ber/AlexBerUtils/blob/master/alexber/utils/files.py" rel="noopener ugc nofollow" target="_blank"><em class="jw">files </em></a></code>模块中的<code class="du jd je jf jg b"><a class="ae jo" href="https://github.com/alex-ber/AlexBerUtils/blob/master/alexber/utils/files.py#L9" rel="noopener ugc nofollow" target="_blank">join_files()</a></code>功能或<a class="ae jo" href="https://alex-ber.medium.com/join-files-cc5e38e3c658" rel="noopener">加入文件</a>。</li><li id="91b8" class="kv kw hi ih b ii lg im lh iq li iu lj iy lk jc ll ld le lf bi translated"><a class="ae jo" href="https://github.com/alex-ber/AlexBerUtils/blob/master/alexber/utils/stdlogging.py" rel="noopener ugc nofollow" target="_blank"> <em class="jw"> stdLogging </em> </a>模块，或<a class="ae jo" href="https://alex-ber.medium.com/stdlogging-module-d5d69ff7103f" rel="noopener">我的stdLogging模块</a></li></ul></div></div>    
</body>
</html>