# 戈朗的心跳

> 原文：<https://medium.com/geekculture/heartbeats-in-golang-1a12c4c366f?source=collection_archive---------2----------------------->

![](img/f49709c4df899cba97e4c7c476ff7af5.png)

# 什么是心跳？

心跳是并发进程向外界发出生命信号的一种方式。它们的名字来源于人体解剖学，对观察者来说，心跳意味着生命。心跳在 Go 之前就已经存在了，并且仍然有用。

并发代码对心跳感兴趣有几个不同的原因。它们允许我们洞察我们的系统，并且它们可以使测试系统具有确定性，否则它可能不具有确定性。

有两种不同类型的心跳:

*   **每隔一段时间发生的心跳。**
*   **心跳发生在一个工作单元的开始。**

按时间间隔发生的心跳对于**并发代码**很有用，它可能在等待其他事情发生，以便处理一个工作单元。因为你不知道那份工作什么时候会到来，所以你的工作可能会持续一段时间，等待事情的发生。心跳是向它的听众发出信号的一种方式，表明一切都很好，沉默是意料之中的。
下面的代码演示了**一个公开心跳**的 goroutine:

注意，因为我们可能在等待输入时发出多个脉冲，或者在等待发送结果时发出多个脉冲，所以所有的`select`语句都需要在`for`循环中。目前为止看起来不错；我们如何利用这个函数并使用它发出的事件？让我们来看看:

运行这段代码会产生:

您可以看到，正如我们预期的那样，每个结果我们接收到大约两个脉冲。

在一个正常运行的系统中，心跳并不那么有趣。我们可能会使用它们来收集关于空闲时间的统计数据，但是当您的 goroutine 不按预期运行时，基于间隔的心跳实用程序会大放异彩。

考虑下一个例子。我们将通过仅在两次迭代后停止 goroutine，然后不关闭我们的任何一个通道，来模拟一个错误编写的 goroutine。让我们来看看:

结果是:

漂亮！不到两秒钟，我们的系统就意识到我们的 goroutine 出了问题，并打破了 for-select 循环。通过使用心跳，我们已经成功地避免了死锁，并且通过不必依赖更长的超时，我们保持了确定性。

此外，注意心跳有助于相反的情况:它们让我们知道长时间运行的 goroutines 保持运行，但只是需要一段时间来产生一个值以在值通道上发送。

现在让我们转而看看在一个工作单元开始时发生的心跳。这些对测试非常有用。下面是一个在每个工作单元之前发送脉冲的示例:

你可以看到结果是:

在这个例子中，您可以看到，我们按照预期为每个结果接收一个脉冲。

这项技术真正的亮点在于编写测试。基于间隔的心跳也可以以同样的方式使用，但是如果您只关心 goroutine 已经开始工作，这种心跳方式就很简单。考虑以下代码:

`DoWork`函数是一个非常简单的生成器，它将我们传入的数字转换成它返回的通道上的流。让我们来测试一下这个功能。这里有一个*坏*测试的例子:

运行这个测试会产生:

这个测试不好，因为它是不确定的。在我们的示例函数中，我已经确保这个测试总是失败，但是如果我移除`time.Sleep`，情况实际上会变得更糟:这个测试有时会通过，有时会失败。

这是一个非常非常糟糕的处境。团队不再知道是否可以信任测试失败，并开始忽略整个努力开始瓦解的失败。

还好，有心跳，这个很容易解决。这里有一个决定性的测试:

结果是:

由于心跳，我们可以安全地编写测试而不会超时。我们面临的唯一风险是我们的一个迭代花费了过多的时间。如果这对我们很重要，我们可以利用更安全的基于间隔的心跳，实现完美的安全性。

下面是一个利用基于时间间隔的心跳的测试示例:

运行该测试会产生:

你可能已经注意到这个版本的测试不太清晰。我们测试的逻辑有点混乱。出于这个原因，如果你有理由确信 goroutine 的循环一旦开始就不会停止执行，我建议只在第一次心跳时阻塞，然后进入一个简单的`range`语句。您可以编写单独的测试，专门测试未能关闭通道、循环迭代耗时过长以及任何其他与时间相关的问题。

Katherine Cox-Buday 的《资源:Go 中的并发性:开发人员的工具和技术》

[](https://read.amazon.com/kp/embed?asin=B0742NH2SG&preview=newtab&linkCode=kpe&ref_=cm_sw_r_kb_dp_ATCTRBVME3DXZN9B27ZV) [## Go 中的并发性:开发人员的工具和技术

### 我们很抱歉。此预览目前在此浏览器上不可用。与此同时，你可以阅读这些…

read.amazon.com](https://read.amazon.com/kp/embed?asin=B0742NH2SG&preview=newtab&linkCode=kpe&ref_=cm_sw_r_kb_dp_ATCTRBVME3DXZN9B27ZV)