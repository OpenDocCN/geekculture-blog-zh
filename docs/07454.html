<html>
<head>
<title>Pushing Logs to Loki Without Using Promtail</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">不使用Promtail将日志推送到Loki</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/pushing-logs-to-loki-without-using-promtail-fc31dfdde3c6?source=collection_archive---------1-----------------------#2021-09-19">https://medium.com/geekculture/pushing-logs-to-loki-without-using-promtail-fc31dfdde3c6?source=collection_archive---------1-----------------------#2021-09-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="5c15" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您曾经使用过Loki进行日志分析，那么您可能对Promtail很熟悉。Promtail是一个可爱的助手，它从你的机器上抓取日志目标，并把它们推送到Loki。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/dfa20b573bd74d57195a0c99faba1d32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zePoIbuI5RkVPR_W3TFOcQ.png"/></div></div></figure><p id="0c99" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，正如您可能知道的，Promtail只能被配置为<strong class="ih hj">从文件、pod或日志</strong>中抓取日志。但是，如果您有一个必须将日志直接发送到Loki的用例，该怎么办呢？例如，想象一下，如果我们可以使用Python的内置日志模块直接从我们的程序向Loki发送日志。原来我也有同样的需求，这就是我解决它的方法。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jp"><img src="../Images/7372c943f00dcd9b710648a0aa559506.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u0dEs6Vq4336gy7gMVR3uw.png"/></div></div></figure><h1 id="1af2" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">先决条件</h1><ul class=""><li id="72bb" class="ko kp hi ih b ii kq im kr iq ks iu kt iy ku jc kv kw kx ky bi translated">您已经创建了一个Loki实例，并准备好将日志推送到该实例</li><li id="a293" class="ko kp hi ih b ii kz im la iq lb iu lc iy ld jc kv kw kx ky bi translated">您已经设置了Grafana，并且知道使用LogQL查询日志的基本知识</li><li id="f5d5" class="ko kp hi ih b ii kz im la iq lb iu lc iy ld jc kv kw kx ky bi translated">您的机器上安装了Python，并且有一些脚本编写经验</li></ul><h1 id="8290" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">概观</h1><p id="73ee" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">首先，我会注意到Grafana Loki确实列出了一个<a class="ae lh" href="https://github.com/sleleko/devops-kb/blob/master/python/push-to-loki.py" rel="noopener ugc nofollow" target="_blank">非官方的python clien </a> t，可以用来将日志直接推送到Loki。然而，我不推荐使用它，因为它非常简单，你可能很难把你的标签转换成Loki要求的格式。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es li"><img src="../Images/fb1a10fa8003dfa11b90af9ed6e41183.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C4AHism0PozkzHld2_ypfQ.png"/></div></div><figcaption class="lj lk et er es ll lm bd b be z dx"><a class="ae lh" href="https://github.com/sleleko/devops-kb/blob/master/python/push-to-loki.py" rel="noopener ugc nofollow" target="_blank">https://github.com/sleleko/devops-kb/blob/master/python/push-to-loki.py</a></figcaption></figure><p id="751c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">幸运的是，有人已经解决了我们的问题，它被称为<a class="ae lh" href="https://github.com/GreyZmeem/python-logging-loki" rel="noopener ugc nofollow" target="_blank"> python-logging-loki库</a>。本质上，它是一个开源解决方案，使您能够使用Python的<a class="ae lh" href="https://docs.python.org/3/library/logging.html" rel="noopener ugc nofollow" target="_blank">日志包</a>将日志直接发送到Loki。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ln"><img src="../Images/fb70430646f6288e58d75d0eda37329d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LlTzqLnyn5HvqeuIyXDsaw.png"/></div></div></figure><p id="ad06" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">其工作方式是通过<a class="ae lh" href="https://docs.python.org/3/library/logging.html#handler-objects" rel="noopener ugc nofollow" target="_blank">将一个名为“LokiHandler”的处理程序</a>附加到您的日志实例。每次使用模块级函数(例如logger.error)，LokiHandler直接向<a class="ae lh" href="https://grafana.com/docs/loki/latest/api/" rel="noopener ugc nofollow" target="_blank"> Loki HTTP API </a>发送一个POST。它还抽象出必须正确格式化Loki的标签。</p><h1 id="063f" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">初始设置</h1><p id="06af" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">首先，使用pip安装python logging loki包。</p><pre class="je jf jg jh fd lo lp lq lr aw ls bi"><span id="bae1" class="lt jr hi lp b fi lu lv l lw lx">pip install python-logging-loki</span></pre><p id="4c4e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们导入两个主要的依赖对象:logging和logging_loki。然后我们用参数初始化Loki处理程序对象；我们的Loki数据源的URL，以及我们使用的版本。如果您使用的是Loki ≥ 0.0.4，请使用版本1。对于URL，重要的是附加到主机的路径是由Loki HTTP API公开的推送端点(/loki/api/v1/push)。</p><pre class="je jf jg jh fd lo lp lq lr aw ls bi"><span id="6b2e" class="lt jr hi lp b fi lu lv l lw lx">import logging<br/>import logging_loki</span><span id="b05c" class="lt jr hi lp b fi ly lv l lw lx">logging_loki.emitter.LokiEmitter.level_tag = "level"</span><span id="4c71" class="lt jr hi lp b fi ly lv l lw lx"># assign to a variable named handler <br/>handler = logging_loki.LokiHandler(<br/>   url="http://loki:3100/loki/api/v1/push",</span><span id="0a94" class="lt jr hi lp b fi ly lv l lw lx">   version="1",<br/>)</span><span id="8be3" class="lt jr hi lp b fi ly lv l lw lx"># create a new logger instance, name it whatever you want<br/>logger = logging.getLogger("my-logger")</span></pre><p id="1089" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您使用Grafana来可视化日志指标，第4行非常重要。默认情况下，LokiEmitter的level标记设置为“severity”。但是，Grafana中的所有日志查询都会自动显示带有“level”的标记(您将在后面看到这一点)。这个<a class="ae lh" href="https://github.com/GreyZmeem/python-logging-loki/issues/17" rel="noopener ugc nofollow" target="_blank">问题是在Github </a>上提出的，应该使用“级别”而不是“严重性”。但是另一个用户用我们在第4行中的代码提供了一个变通方法。</p><h1 id="fb08" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">让我们做一些记录</h1><p id="1d4b" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">现在我们有了LokiHandler设置，我们可以将它作为一个处理程序添加到Python的日志对象中。</p><pre class="je jf jg jh fd lo lp lq lr aw ls bi"><span id="ebfe" class="lt jr hi lp b fi lu lv l lw lx">logger.addHandler(handler)</span></pre><p id="21ed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">每次我们调用日志功能时，Loki处理器都会自动将带有正确标签的日志流推送到Loki。如果你想给Loki发送额外的标签，你可以在调用函数时把它们放在“标签”对象中</p><pre class="je jf jg jh fd lo lp lq lr aw ls bi"><span id="0f1e" class="lt jr hi lp b fi lu lv l lw lx"># now use the logging object's functions as you normally would</span><span id="1f83" class="lt jr hi lp b fi ly lv l lw lx">logger.error(<br/>   "Something bad happened",<br/>  <br/>   extra={"tags": {"service": "my-service"}},<br/>)</span><span id="b1cb" class="lt jr hi lp b fi ly lv l lw lx">logger.warning(<br/>   "Something bad happened but we can keep going",</span><span id="0bbd" class="lt jr hi lp b fi ly lv l lw lx">   extra={"tags": {"service": "my-service"}},<br/>)</span><span id="25a2" class="lt jr hi lp b fi ly lv l lw lx"># extra={"tags": {"service": "my-service", "one": "more thing"}}</span></pre><p id="ce8b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在转到Grafana实例，使用其中一个标签查询日志。此外，您可以看到一个配色方案被应用到每个日志行，因为我们之前将level_tag设置为“level ”, Grafana正在使用它。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lz"><img src="../Images/fb3b192759de845754bbcc3e7064b4f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0ZF_4SPBpoxUq7YJhAU6xw.png"/></div></div></figure><p id="8c67" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，如果您单击您的一个日志行，您应该看到由LokiHandler应用到流的所有标签。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ma"><img src="../Images/32092500a716f13d45ffbe824d249d9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uHGH_XRUrMUVka3U1yEyvA.png"/></div></div></figure><h1 id="5b17" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">让我们尝试一些其他的功能…但是等等。</h1><p id="ae84" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">现在，如果您真的很渴望，您可能已经尝试过调用函数logger.info()或logger.debug()，如下所示:</p><pre class="je jf jg jh fd lo lp lq lr aw ls bi"><span id="4621" class="lt jr hi lp b fi lu lv l lw lx">logger.info(<br/>   "Here's Something to read",<br/>   extra={"tags": {"service": "my-service"}},<br/>)</span><span id="8cb1" class="lt jr hi lp b fi ly lv l lw lx">logger.debug(<br/>   "Something on purpose",<br/>   extra={"tags": {"service": "my-service"}},<br/>)</span></pre><p id="4aaf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，如果你去检查格拉夫纳他们不在那里！？您没有在仪表板中看到日志的原因是由于Python的日志模块中的一种现象，称为<strong class="ih hj">基于级别的过滤。</strong>这是<a class="ae lh" href="https://github.com/GreyZmeem/python-logging-loki/issues/20" rel="noopener ugc nofollow" target="_blank">在Github </a>上提出的另一个问题。</p><p id="0e57" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">来自RealPython的Brad Solomon对日志模块的架构进行了深入分析，解释了为什么会出现这种情况。简而言之，Python的日志级别只是一个映射到整数值的类似枚举的结构。</p><pre class="je jf jg jh fd lo lp lq lr aw ls bi"><span id="9f2e" class="lt jr hi lp b fi lu lv l lw lx">CRITICAL = 50<br/>ERROR = 40<br/>WARNING = 30  &lt;--- default level<br/>INFO = 20<br/>DEBUG = 10<br/>NOTSET = 0</span><span id="a3cf" class="lt jr hi lp b fi ly lv l lw lx"># this will return the currently set level<br/>logger.getEffectiveLevel()</span></pre><p id="d7a9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，日志记录对象的默认日志级别设置为WARNING。这意味着任何低于警告值的值都不会通过。这就是为什么我们看不到调试和信息日志，但我们可以看到警告、错误或严重错误。</p><h1 id="635f" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">容易解决的问题</h1><p id="f648" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">幸运的是，我们只用一行代码就可以解决这个问题。在实例化日志记录对象后，请正确放置:</p><pre class="je jf jg jh fd lo lp lq lr aw ls bi"><span id="1a30" class="lt jr hi lp b fi lu lv l lw lx">logger.setLevel(logging.DEBUG)</span></pre><p id="ea16" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这样做的目的是为这个处理程序设置调试阈值(10)。因此，现在任何不如DEBUG严重的日志消息都将被忽略。</p><p id="8224" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">尝试再次运行您的程序，然后在Grafana中查询您的日志。您现在应该可以看到信息和调试日志。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mb"><img src="../Images/d221e3d7c47f1b7b3c577ac3d89f5a90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mOK8aHdUu3ky4o7ENIhKZA.png"/></div></div></figure><h1 id="acfa" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">添加您自己的日志级别</h1><p id="301e" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">如果您浏览Python的日志记录文档，您会注意到只为错误、警告、信息和调试提供了函数。但是如果您的应用程序需要更多的日志级别呢？例如，“详细”或“跟踪”。</p><p id="a2e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我们必须告诉日志记录对象我们想要添加一个名为“TRACE”的新名称。日志记录有一个名为addLevelName()的内置函数，它接受两个参数:<em class="mc">级别</em>和<em class="mc">级别名称</em>。</p><pre class="je jf jg jh fd lo lp lq lr aw ls bi"><span id="d50e" class="lt jr hi lp b fi lu lv l lw lx">logging.addLevelName(15, "TRACE")</span></pre><p id="da29" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请记住，由于我们将日志级别设置为debug，如果我们希望它通过，它的值必须大于10。接下来，我们必须创建一个处理跟踪日志的函数。</p><pre class="je jf jg jh fd lo lp lq lr aw ls bi"><span id="414f" class="lt jr hi lp b fi lu lv l lw lx">def trace(self, message, *args, **kws):<br/>   if self.isEnabledFor(15):<br/>   # Yes, logger takes its '*args' as 'args'.<br/>   self._log(15, message, args, **kws)</span><span id="a32c" class="lt jr hi lp b fi ly lv l lw lx">logging.Logger.trace = trace</span></pre><p id="9cfe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，我们动态地将它添加到日志记录对象中。现在，在我们的代码中，我们可以像这样调用logger.trace():</p><pre class="je jf jg jh fd lo lp lq lr aw ls bi"><span id="d378" class="lt jr hi lp b fi lu lv l lw lx">logger.trace(<br/>   "Something to follow",<br/>   extra={"tags": {"service": "my-service"}},<br/>)</span></pre><p id="c160" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后我们可以在Grafana中查询它，并看到颜色方案被应用于跟踪日志。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es md"><img src="../Images/e5a4f7eb59fb73e4a1c1ca7b7b0efe7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FfhPysN1y2y-Xj9Ue-6eyg.png"/></div></div></figure><h1 id="64cd" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">最终计划</h1><p id="dfbd" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">这是本文涵盖的完整程序。随意改装它来满足你的伐木需要。感谢阅读！</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="me mf l"/></div></figure><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mg"><img src="../Images/f4542c3f1f95c5819716c5e073e8627b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Tu27kOQu07L6KBZwfpvdLA.png"/></div></div><figcaption class="lj lk et er es ll lm bd b be z dx">Bonus: rainbow logs!</figcaption></figure></div></div>    
</body>
</html>