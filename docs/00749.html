<html>
<head>
<title>Magento Commerce— Staging — What It Is and Its Dark Secret</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">magento Commerce——Staging——它是什么及其黑暗的秘密</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/magento-commerce-staging-what-it-is-and-its-dark-secret-985b393a8fc5?source=collection_archive---------9-----------------------#2021-03-12">https://medium.com/geekculture/magento-commerce-staging-what-it-is-and-its-dark-secret-985b393a8fc5?source=collection_archive---------9-----------------------#2021-03-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="ee1e" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">Magento2 Commerce不久前推出了“staging”功能。这个功能在理论上很棒，但有一个不为人知的秘密。</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/e9e0335d40fc15a4017b093226abe1ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jdPJCEgdquAcbAad60_n_Q.jpeg"/></div></div></figure><p id="e3f2" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">首先，让我们看看这种暂存功能是什么？</p><p id="59c6" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">你可能需要一个特定的页面，比如CMS页面，或者一个产品，甚至是一个分类页面，在一个特定的时间和日期改变。例如，你在圣诞节销售一种产品，你想在24号午夜停止销售。</p><p id="0470" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">暂存功能允许您在后台为产品、类别或CMS页面配置多个状态。例如，我们可以为我们的产品创建一个阶段，以便在12月23日启用它，并在24日午夜禁用它。这意味着在22日23时59分访问该网站的顾客将无法找到该产品。但是如果他们在23日00h01m访问该网站，他们会(几乎)访问。</p><p id="21a9" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">您可以使用它来更改任何产品属性；您还可以使用它来更改类别页面，例如在页面上临时添加横幅，或者在给定时间发布类别。</p><p id="1e9b" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">如果没有这一点，您将需要一个管理员在给定的时间做更改，即使这样，他可能会晚做一些更改；犯一个错误…这一切都自动化了。</p><p id="876b" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">你可以走得相当远，有连续的阶段；同样，如果我们保持我们的圣诞主题，我们可以制作一个类似CMS页面上显示的降临节日历。每天页面都会自动更新。您甚至可以在给定阶段看到页面的预览，这允许您验证您的更改。</p><p id="52da" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">这个特性当然有一些限制，其中之一就是时区。如果你的网站在多个时区销售，而你希望你的更改在有问题的时区生效，你将无法做到这一点。有一些方法可以解决这个问题，但是它需要大量的重复，仍然有局限性。</p><p id="fd6b" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">第二个问题来自数据的存储方式。因此，让我们看看如何分期工作，以了解这个问题。</p><h1 id="2dc2" class="kf kg hi bd kh ki kj kk kl km kn ko kp io kq ip kr ir ks is kt iu ku iv kv kw bi translated">阶段是如何存储的？</h1><p id="c731" class="pw-post-body-paragraph jj jk hi jl b jm kx ij jo jp ky im jr js kz ju jv jw la jy jz ka lb kc kd ke hb bi translated">Magento使用EAV来存储其值，因此某个商店的产品名称将存储如下:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es lc"><img src="../Images/fa0ad493d4932e244c5f28ae1a261a1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1322/format:webp/1*arhADY1mFJBfI5Wkg3tE7A.jpeg"/></div></figure><p id="d234" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">这基本上意味着产品“4”在<em class="ld">目录_产品_实体</em>表中有一个条目，在<em class="ld">目录_产品_实体_varchar </em>表中有多个条目来存储所有的文本值。</p><p id="b716" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">当分级模块被启用时，结构改变，</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es le"><img src="../Images/e0518c7a6b7850314575600fdf842972.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iuTvgGpeRpX85XMgkzPp6w.jpeg"/></div></div></figure><p id="1a6e" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><em class="ld">目录_产品_实体</em>表变化比较大；我们在表中添加了3个新列。<strong class="jl hj"> <em class="ld"> entity_id </em> </strong>不再是表的主键，现在是<strong class="jl hj"> <em class="ld"> row_id。</em> </strong>这意味着同一产品可以有多行。<strong class="jl hj"><em class="ld">created _ in</em></strong>&amp;<strong class="jl hj"><em class="ld">updated _ in</em></strong>列允许我们在给定的时间加载“适当的”阶段。</p><p id="2283" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我们还要注意，存储在varchar表中的值对于每一行都是重复的。因此，我们不是每个产品都有一个值，而是每个产品和版本都有一个值。这似乎合乎逻辑。</p><p id="5228" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">有了staging，所有对产品的查询都会自动添加一个新条件:</p><p id="c1b2" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><em class="ld">((main _ table . created _ in≤1615385079)和(main _ table . updated _ in&gt;1615385079))</em></p><p id="faec" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">这样，所有使用产品集合的查询将只加载一个产品一次，即使它有多个阶段。怎么会这样如果我们有一个从24号开始到25号结束的阶段(从1号开始并且永远不会结束的基本阶段),查询应该会找到这两个阶段。</p><p id="9cb1" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">是的，这就是为什么“主”阶段在数据库中被分成两部分:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lf"><img src="../Images/35fbc569a5ddbf3e7b79fa1b5f488570.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R03nLcNB5ZTpDw9WGwAv1g.jpeg"/></div></div></figure><p id="e389" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">因此，我们在数据库中存储了该产品的3个副本。这使得这些阶段可以在前端非常高效地工作。但是edition是如何工作的呢？</p><p id="4ed9" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">假设我们创建了我们的舞台“圣诞舞台”,我们仍然在12月21日。我们现在修复我们产品上的某些东西；对从0开始到24号结束的第一阶段进行更改？当25号到来时，我们的改变消失了？不是。有一个附加的表，<strong class="jl hj"><em class="ld">staging _ update</em></strong>将数据库中的这些“期间”相互联系起来。因此，当您编辑“主阶段”时，它将在数据库中更新0–24期以及25至无限期的条目。</p><p id="dbe9" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">您可能已经开始看到这里的问题了。但首先，让我们看看搜索会受到什么影响。</p><h1 id="c092" class="kf kg hi bd kh ki kj kk kl km kn ko kp io kq ip kr ir ks is kt iu ku iv kv kw bi translated">为什么数据库结构是这样一个问题？</h1><p id="ac7a" class="pw-post-body-paragraph jj jk hi jl b jm kx ij jo jp ky im jr js kz ju jv jw la jy jz ka lb kc kd ke hb bi translated">当你开始有很多阶段时，问题就出现了:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lg"><img src="../Images/a734db8160236be3cb9e50769dd44798.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ixJjwXTD09tFQL_ZMIb2BQ.jpeg"/></div></div></figure><p id="cbe5" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我们有5个阶段，但在数据库中，数据被复制了9次。这意味着数据库中有((2 * nb_stage) -1)个条目。因此，我们在数据库中复制数据，我们知道这是一种不好的做法，我不认为需要时间在这里解释。</p><p id="2a30" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">第二个问题更实际；当我们试图拯救产品时，它就会出现。你拥有的阶段越多，“主阶段”就变得越支离破碎，越难以更新；使得产品上的保存操作越来越慢。</p><p id="bab1" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">最后，没有清理方法，一旦复活节过去，我们可以想象删除旧的阶段，并删除一些重复的数据。没有什么是天生的。</p><h1 id="9a4f" class="kf kg hi bd kh ki kj kk kl km kn ko kp io kq ip kr ir ks is kt iu ku iv kv kw bi translated">技术的</h1><h2 id="cd61" class="lh kg hi bd kh li lj lk kl ll lm ln kp js lo lp kr jw lq lr kt ka ls lt kv lu bi translated">查询是如何改变的</h2><p id="acd1" class="pw-post-body-paragraph jj jk hi jl b jm kx ij jo jp ky im jr js kz ju jv jw la jy jz ka lb kc kd ke hb bi translated">如前所述，可分级实体上的所有查询都被更改，这是通过由分级模块(magento/module-staging)添加的from rendered完成的，该模块具有类<em class="ld">Magento \ Staging \ Model \ Select \ from renderer</em>。</p><p id="c4e3" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">如果希望防止将此条件添加到查询中，可以通过添加以下代码来实现:</p><pre class="iy iz ja jb fd lv lw lx ly aw lz bi"><span id="491f" class="lh kg hi lw b fi ma mb l mc md">$select-&gt;setPart("disable_staging_preview", true)</span></pre><p id="f906" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">您很少需要这样做；除非您试图通过一个查询获得所有阶段的数据。</p><h2 id="0941" class="lh kg hi bd kh li lj lk kl ll lm ln kp js lo lp kr jw lq lr kt ka ls lt kv lu bi translated">搜索和指数化</h2><p id="08d8" class="pw-post-body-paragraph jj jk hi jl b jm kx ij jo jp ky im jr js kz ju jv jw la jy jz ka lb kc kd ke hb bi translated">转移功能不会改变任何索引表或弹性索引。相反，我们有了一个新的cron“staging _ apply _ version”。这将搜索所有需要重新编制索引的可停滞实体。</p><p id="1b83" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">这引入了第二个限制，如果许多实体需要在给定时间切换，索引将会延迟，因为它们的更新将花费大量时间。</p><h1 id="0295" class="kf kg hi bd kh ki kj kk kl km kn ko kp io kq ip kr ir ks is kt iu ku iv kv kw bi translated">结论</h1><p id="83ce" class="pw-post-body-paragraph jj jk hi jl b jm kx ij jo jp ky im jr js kz ju jv jw la jy jz ka lb kc kd ke hb bi translated">Magento的staging模块非常有用，尤其是对于不太复杂的对象，比如CMS页面或价格规则。如果您的数据库相对较小，它也可以安全地用于产品和类别。</p><p id="d31e" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我的主要问题是，它是默认安装在Magento的商业版中的，它应该是集成商可选安装的。该模块广泛地修改了数据库结构，这意味着一旦安装就不容易被删除。所以最好只在需要的时候安装。很多项目没有理由就安装和启用了这些模块，通常在网站上工作的开发人员没有考虑到这一点，导致在实际使用时出现错误。所以容易产生bug。</p><p id="71c6" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><em class="ld">编辑1:添加了额外的信息，说明在代码的什么地方对可分级实体的查询进行了修改，以及如何禁用它。我还补充了一些关于指数化(搜索)如何受阶段影响的信息。</em></p></div></div>    
</body>
</html>