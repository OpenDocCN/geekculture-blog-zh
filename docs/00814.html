<html>
<head>
<title>S3 Authorization — Refresher</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">S3授权-复习</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/s3-authorization-refresher-ff3ba6cdc931?source=collection_archive---------8-----------------------#2021-03-14">https://medium.com/geekculture/s3-authorization-refresher-ff3ba6cdc931?source=collection_archive---------8-----------------------#2021-03-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/ad1d482b89a71762f33570b5be3169e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bpW1lJBZp5hXIroVrOOhew.jpeg"/></div></div></figure><div class=""/><p id="cbb8" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">AWS S3授权涉及多个实体，遵循明确定义的路径。它评估IAM策略、存储桶策略、存储桶ACL、对象ACL、端点策略和接入点策略。只有在没有显式拒绝并且有显式允许的情况下，它才会成功。</p><figure class="jp jq jr js fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es jo"><img src="../Images/0428b27029bfd37351ea8149b6a396d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GiPJZ8twF5gFNG_nDYWFDg.png"/></div></div></figure><p id="23d1" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这篇博客中，我们将经历授权过程。但是，在我们了解如何处理授权请求之前，我们需要明确几个术语:</p><h2 id="56d9" class="jt ju ht bd jv jw jx jy jz ka kb kc kd jb ke kf kg jf kh ki kj jj kk kl km kn bi translated">请求者</h2><figure class="jp jq jr js fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ko"><img src="../Images/7bc198e54017c46a9d568629b9eb092a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SREM4zKZm2qRuHQnBVBP0Q.png"/></div></div></figure><p id="5ca5" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在访问S3实体(桶/对象)时，我们大致有两种类型的请求者。</p><p id="30ee" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">AWS已知的或AWS拥有的。像创建或链接到AWS的角色、用户和身份提供者。此外，帐户的根用户是一个特殊的实体，以不同的方式处理。在bucket ACL中，当您看到authenticated时，表示AWS知道的实体，不一定是您的帐户。</p><p id="12d5" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">其余的不为AWS系统所知。AWS称之为公开或匿名。</p><h2 id="7b70" class="jt ju ht bd jv jw jx jy jz ka kb kc kd jb ke kf kg jf kh ki kj jj kk kl km kn bi translated">物主</h2><figure class="jp jq jr js fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es kp"><img src="../Images/c23ad7483f646af97f001ad88135ca8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OQIijxgufickIC_zixFDiw.png"/></div></div></figure><p id="6412" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">默认情况下，当其他AWS帐户将对象上传到另一个帐户的存储桶时，这些对象仍归上传帐户所有。对象所有者使用ACL委托访问。强制将对象所有权转移到目标帐户的方法是使用一个存储桶策略，该策略只允许在所有权转移时创建对象。下面是那个条件。</p><pre class="jp jq jr js fd kq kr ks kt aw ku bi"><span id="0705" class="jt ju ht kr b fi kv kw l kx ky">Condition:<br/>  StringEquals:<br/>    <strong class="kr hu">s3:x-amz-acl: bucket-owner-full-control</strong></span></pre><p id="e7b6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后，用户必须向ACL提供所有权转移。请参见下面的代码片段。</p><pre class="jp jq jr js fd kq kr ks kt aw ku bi"><span id="56d2" class="jt ju ht kr b fi kv kw l kx ky">s3.put_object(<br/>    Bucket=bucketname,<br/>    Key=filename,<br/>    Body=content_bytes,<br/>    ContentMD5=content_md5,<br/>    <strong class="kr hu">ACL="bucket-owner-full-control"</strong><br/>)</span></pre><p id="140a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">需要注意的一点是，如果您想要启用bucket复制，您必须强制用户提供<code class="du kz la lb kr b">bucket-owner-fill-control</code>。</p><h2 id="cb24" class="jt ju ht bd jv jw jx jy jz ka kb kc kd jb ke kf kg jf kh ki kj jj kk kl km kn bi translated">操作</h2><figure class="jp jq jr js fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lc"><img src="../Images/6a0c5e01527e6a60f25c3a10055e3fd9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-NrFAcF4Hwp2a0ovnQyJhg.png"/></div></div></figure><h2 id="08d4" class="jt ju ht bd jv jw jx jy jz ka kb kc kd jb ke kf kg jf kh ki kj jj kk kl km kn bi translated">语境</h2><p id="da49" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hb bi translated">根据实体的所有者(请求者或操作类型)，S3为策略或访问评估使用不同的上下文。实体所有者帐户具有上下文权限。</p><p id="ed7e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu">用户背景</strong></p><p id="d619" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">申请人和存储桶位于不同帐户的情况</p><blockquote class="li lj lk"><p id="35a1" class="iq ir ll is b it iu iv iw ix iy iz ja lm jc jd je ln jg jh ji lo jk jl jm jn hb bi translated">申请人所属的帐户。<br/>评估该帐户拥有的策略。<br/>母账户的SCP将发挥作用</p></blockquote><p id="781f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请求者和存储桶在同一个帐户中的情况</p><blockquote class="li lj lk"><p id="9459" class="iq ir ll is b it iu iv iw ix iy iz ja lm jc jd je ln jg jh ji lo jk jl jm jn hb bi translated">存储桶策略、ACL和对象ACL一起评估。</p></blockquote><p id="a347" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu"> <em class="ll">注意:</em></strong><em class="ll">root发出的请求，没有用户上下文。</em></p><p id="ad0a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu">桶上下文</strong></p><blockquote class="li lj lk"><p id="66ad" class="iq ir ll is b it iu iv iw ix iy iz ja lm jc jd je ln jg jh ji lo jk jl jm jn hb bi translated">该时段所属的帐户。<br/>存储桶策略&amp;评估ACL以查看是否有明确的拒绝。<br/>如果适用，还会评估接入点策略&amp;端点策略</p></blockquote><blockquote class="lp"><p id="e582" class="lq lr ht bd ls lt lu lv lw lx ly jn dx translated">S3接入点是具有专用访问策略的唯一主机名，这些策略描述了如何使用该端点访问数据</p></blockquote><p id="7b92" class="pw-post-body-paragraph iq ir ht is b it lz iv iw ix ma iz ja jb mb jd je jf mc jh ji jj md jl jm jn hb bi translated"><strong class="is hu">对象上下文</strong></p><blockquote class="li lj lk"><p id="1bb7" class="iq ir ll is b it iu iv iw ix iy iz ja lm jc jd je ln jg jh ji lo jk jl jm jn hb bi translated">检查对象ACL以查看对象所有者是否允许访问<br/>也寻找显式拒绝。</p></blockquote><p id="fb2b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">铲斗操作评估流程:</p><figure class="jp jq jr js fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es me"><img src="../Images/1525802cac9fec76b0637415c95a8f2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8FBOV2qBaj083HAFbhuzSw.png"/></div></div></figure><p id="1c4c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">目标操作评估流程:</p><figure class="jp jq jr js fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mf"><img src="../Images/89a86c5f348cd464e2d5c4c6b0d59e68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iLzF_hojWPa1fp-Qv1UWvA.png"/></div></div></figure><h2 id="07d8" class="jt ju ht bd jv jw jx jy jz ka kb kc kd jb ke kf kg jf kh ki kj jj kk kl km kn bi translated">亚马逊S3预定义组</h2><blockquote class="li lj lk"><p id="44c4" class="iq ir ll is b it iu iv iw ix iy iz ja lm jc jd je ln jg jh ji lo jk jl jm jn hb bi translated">all users-Public Any one<br/>authenticated users-Any AWS Account<br/>log delivery-用于放置来自负载平衡器的访问日志</p></blockquote><h2 id="73c9" class="jt ju ht bd jv jw jx jy jz ka kb kc kd jb ke kf kg jf kh ki kj jj kk kl km kn bi translated">ACL和IAM策略的映射</h2><blockquote class="li lj lk"><p id="3afa" class="iq ir ll is b it iu iv iw ix iy iz ja lm jc jd je ln jg jh ji lo jk jl jm jn hb bi translated">READ — s3:ListBucket，s3:ListBucketVersions，S3:ListBucketMultipartUploads S3:GetObject，s3:GetObjectVersion，s3:GetObjectTorrent</p><p id="81ec" class="iq ir ll is b it iu iv iw ix iy iz ja lm jc jd je ln jg jh ji lo jk jl jm jn hb bi translated">WRITE — s3:PutObject和s3:DeleteObject，s3:DeleteObjectVersion</p><p id="b041" class="iq ir ll is b it iu iv iw ix iy iz ja lm jc jd je ln jg jh ji lo jk jl jm jn hb bi translated">READ _ ACP—S3:GetBucketAcl S3:getobject ACL和S3:GetObjectVersionAcl<br/>WRITE _ ACP—S3:PutBucketAcl S3:putobject ACL和S3:PutObjectVersionAcl<br/>FULL _ CONTROL—READ+WRITE+READ _ ACP+WRITE _ ACP</p></blockquote><h2 id="c4cc" class="jt ju ht bd jv jw jx jy jz ka kb kc kd jb ke kf kg jf kh ki kj jj kk kl km kn bi translated">封装的ACL和与ACL的映射(组)</h2><blockquote class="li lj lk"><p id="8daa" class="iq ir ll is b it iu iv iw ix iy iz ja lm jc jd je ln jg jh ji lo jk jl jm jn hb bi translated">private — FULL_CONTROL(所有者)<br/>public—read—FULL _ CONTROL(所有者)，READ(所有用户)<br/>public—READ—WRITE—FULL _ CONTROL(所有者)&amp; WRITE(所有用户)<br/>authenticated—READ—FULL _ CONTROL(所有者)，READ(authenticated users)<br/>bucket—owner—READ—FULL _ CONTROL(对象所有者)READ(所有者)<br/>bucket—owner—FULL _ CONTROL—FULL _ CONTROL(所有者)&amp;FULL _ CONTROL(所有者【对象所有者】<br/>log—delivery—WRITE&amp;</p></blockquote><h2 id="a5e9" class="jt ju ht bd jv jw jx jy jz ka kb kc kd jb ke kf kg jf kh ki kj jj kk kl km kn bi translated">存储桶策略(推荐方式)</h2><blockquote class="li lj lk"><p id="ebd8" class="iq ir ll is b it iu iv iw ix iy iz ja lm jc jd je ln jg jh ji lo jk jl jm jn hb bi translated">语法与IAM类似<br/>能够添加deny，ACL只能“允许”<br/>有选择地使用前缀</p></blockquote><h2 id="34b2" class="jt ju ht bd jv jw jx jy jz ka kb kc kd jb ke kf kg jf kh ki kj jj kk kl km kn bi translated">阻止公共访问</h2><p id="83f7" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hb bi translated">这个特性允许我们阻止任何意外的公共对象/桶。建议在启用BPA的不同帐户中为公共存储桶和私有存储桶设置单独的中央帐户。</p><blockquote class="li lj lk"><p id="6b90" class="iq ir ll is b it iu iv iw ix iy iz ja lm jc jd je ln jg jh ji lo jk jl jm jn hb bi translated">BlockPublicAcls —使用公共ACL拒绝上传<br/>ignorrepublicals—忽略公共ACL<br/>BlockPublicPolicy—拒绝上传使存储桶公开的策略<br/> RestrictPublicBuckets —拒绝通过已验证组授予的访问权限</p></blockquote><h2 id="50b2" class="jt ju ht bd jv jw jx jy jz ka kb kc kd jb ke kf kg jf kh ki kj jj kk kl km kn bi translated">使用Athena打开访问日志和查询</h2><pre class="jp jq jr js fd kq kr ks kt aw ku bi"><span id="4d97" class="jt ju ht kr b fi kv kw l kx ky">SELECT count(*), bucket<br/>FROM s3_access_logs_db.mybucket_logs<br/>WHERE http_status BETWEEN 200 and 209<br/>AND requester = '-' AND authtype = '-' AND<br/>request_uri not like '%X-Amz-Security-Token%'<br/>GROUP BY bucket</span></pre><p id="3a02" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">安全快乐！！！</p></div></div>    
</body>
</html>