<html>
<head>
<title>The Advanced Challenge of Load Balancing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">负载平衡的高级挑战</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/the-advanced-challenge-of-load-balancing-6f6ef5f36ec4?source=collection_archive---------29-----------------------#2021-06-15">https://medium.com/geekculture/the-advanced-challenge-of-load-balancing-6f6ef5f36ec4?source=collection_archive---------29-----------------------#2021-06-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="139e" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">并非所有流量都可以任意路由。</h2></div><p id="dc10" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">虽然承担了成熟服务的责任，但是单个服务器可能无法处理所有的工作负载。这是由于三个主要考虑因素:性能、可用性和经济性。</p><p id="4b18" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了很好地处理过量的流量，增加处理请求的能力是必要的，这可以通过纵向扩展或横向扩展来实现。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es jt"><img src="../Images/afebc456a356e9550120a46073b5a9fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GiQKawoLartjlQGm"/></div></div><figcaption class="kf kg et er es kh ki bd b be z dx">Photo by <a class="ae kj" href="https://unsplash.com/@saltsup" rel="noopener ugc nofollow" target="_blank">Piret Ilver</a> on Unsplash</figcaption></figure><p id="29ec" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然而，机器故障时有发生，使用顶级规格机器的成本可能无法承受。在大多数情况下，将工作量平均分配给多个普通员工听起来是一个更可行的解决方案。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es kk"><img src="../Images/556938fba11c0325d6ef0dc73a6bce9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9_iDvyGlQ_FpJ0uZ7tCdNg.png"/></div></div></figure><p id="3a98" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这看起来很自然…对吗？</p><blockquote class="kl km kn"><p id="8b8e" class="ix iy ko iz b ja jb ij jc jd je im jf kp jh ji jj kq jl jm jn kr jp jq jr js hb bi translated">是的，但实际上不是。</p></blockquote><p id="3424" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">该架构适用于大多数无状态API，但是这个新添加的“<strong class="iz hj"> Spread </strong>”行为为其他有状态交互增加了一些不确定性。</p></div><div class="ab cl ks kt gp ku" role="separator"><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx"/></div><div class="hb hc hd he hf"><h1 id="e2cb" class="kz la hi bd lb lc ld le lf lg lh li lj io lk ip ll ir lm is ln iu lo iv lp lq bi translated">会议</h1><p id="fa5b" class="pw-post-body-paragraph ix iy hi iz b ja lr ij jc jd ls im jf jg lt ji jj jk lu jm jn jo lv jq jr js hb bi translated">任何让服务器存储“状态”的技术都会导致它们之间不同的逻辑行为，这可能与上面的一般负载平衡架构相冲突。</p><p id="6e80" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在web服务上使用会话是一个典型的例子。</p><p id="5c74" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">受限于HTTP协议的无状态设计，为了让用户在每次操作时都有连续性，在服务器端存储了一定时间段内的上下文信息，如登录状态、购物车等。</p><p id="8dcc" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">就像现实世界里的外卖一样。顾客在柜台点餐后可以获得一个号码牌，当饭菜准备好了，他们可以拿着号码牌取餐。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es jt"><img src="../Images/9e6430347b23f008586ed0032129a4dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Dw2Irliq0pHz0KSd"/></div></div><figcaption class="kf kg et er es kh ki bd b be z dx">Photo by <a class="ae kj" href="https://unsplash.com/@brookecagle" rel="noopener ugc nofollow" target="_blank">Brooke Cagle</a> on Unsplash</figcaption></figure><p id="22b7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">对于顾客来说，点餐和取餐是两个独立的步骤，但具有连续的逻辑，这是因为柜台已经存储了他们是谁以及他们点了什么的数据，并且可以通过他们提供的车牌进行检索。</p><h2 id="a54f" class="lw la hi bd lb lx ly lz lf ma mb mc lj jg md me ll jk mf mg ln jo mh mi lp mj bi translated">粘性会话</h2><p id="f006" class="pw-post-body-paragraph ix iy hi iz b ja lr ij jc jd ls im jf jg lt ji jj jk lu jm jn jo lv jq jr js hb bi translated">嗯，大多数时候，号码牌只能在同一个商店使用，我们不能拿着在A店得到的号码牌去B店吃饭。</p><p id="654c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这个原则在web服务上也是一样的，因为会话数据可能是不共享的。解决这个问题有两个主要方向:</p><ol class=""><li id="e9e9" class="mk ml hi iz b ja jb jd je jg mm jk mn jo mo js mp mq mr ms bi translated">在所有具有外部存储(例如Redis集群)的web服务器之间共享会话数据</li><li id="f8da" class="mk ml hi iz b ja mt jd mu jg mv jk mw jo mx js mp mq mr ms bi translated">强制将来自同一客户端的所有请求调度到同一服务器。</li></ol><p id="d91b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">第一个稍微复杂一点，超出了本文的范围，在这里我将重点讨论第二个解决方案。</p><p id="268e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">维护客户端和web服务器之间的映射关系可以帮助我们将每个客户端转发到它们上次连接的同一服务器，该服务器当前为它们处理会话上下文。</p><p id="5d79" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这可以通过来自客户端的各种标识符来实现，如IP地址和cookies。许多知名的负载平衡解决方案通过不同的方法提供了这一选项，如AWS NLB/ALB、GCP云负载平衡器和CNCF的Envoy。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es jt"><img src="../Images/dd724b8ae8d350395342cdecd975b229.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-wq4j3GYElMK5tjB"/></div></div><figcaption class="kf kg et er es kh ki bd b be z dx">Photo by <a class="ae kj" href="https://unsplash.com/@bibipace" rel="noopener ugc nofollow" target="_blank">Benedetta Pacelli</a> on Unsplash</figcaption></figure><p id="ff0a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">但是，启用粘滞会话选项相当于添加一个可能与流量平衡相冲突的硬性规则。例如，在处理大量具有相同IP地址的客户端请求时，基于IP的粘性会话可能不是一个好的选择，因为它可能会导致部分服务器工作负载过重。</p></div><div class="ab cl ks kt gp ku" role="separator"><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx"/></div><div class="hb hc hd he hf"><h1 id="e3a9" class="kz la hi bd lb lc ld le lf lg lh li lj io lk ip ll ir lm is ln iu lo iv lp lq bi translated">WebSocket</h1><p id="1b3c" class="pw-post-body-paragraph ix iy hi iz b ja lr ij jc jd ls im jf jg lt ji jj jk lu jm jn jo lv jq jr js hb bi translated">在现代软件服务中，有很多情况需要实时更新信息，比如股市交易、网络游戏、聊天室等。</p><p id="d58c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用由客户端发送的周期性请求驱动的轮询策略听起来不经济，我们需要为每个请求支付TCP连接的成本，并且很可能没有要更新的信息。</p><p id="06bc" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">采用全双工通信的WebSocket是一个值得尝试的解决方案。它允许服务器端主动向客户端推送消息，有效地避免了无意义的请求。</p><p id="0c69" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然而，在第一次请求之后，客户机和服务器之间的长期连接将被保持…</p><blockquote class="my"><p id="e86a" class="mz na hi bd nb nc nd ne nf ng nh js dx translated">我们实际上是在平衡连接，而不是工作负载。</p></blockquote><blockquote class="kl km kn"><p id="5915" class="ix iy ko iz b ja ni ij jc jd nj im jf kp nk ji jj kq nl jm jn kr nm jq jr js hb bi translated">这有什么问题吗？</p></blockquote><p id="7da6" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">主要风险是工作负载不能在多台机器之间适当分配:</p><ul class=""><li id="8bca" class="mk ml hi iz b ja jb jd je jg mm jk mn jo mo js nn mq mr ms bi translated">不同的连接同时有不同的工作量<br/>对于聊天软件服务器来说，有很多好友的用户可能会比没有好友的用户有高得多的连接工作量(好难过……)。</li><li id="810a" class="mk ml hi iz b ja mt jd mu jg mv jk mw jo mx js nn mq mr ms bi translated">相同的连接在不同的时间有不同的工作负载<br/>一个明显的例子是游戏服务器，尤其是大型开放世界RPG。当一个角色在市场中浏览和交易物品时，所需的数据传输可能相对较小，但由于很多角色在激战中频繁移动和施放技能，工作量可能会在瞬间急剧增加。</li></ul><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es jt"><img src="../Images/7d7abdf6ca5040f908950a75c11b355f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9cKCUJctoB33z1mX"/></div></div><figcaption class="kf kg et er es kh ki bd b be z dx">Photo by <a class="ae kj" href="https://unsplash.com/@cha_ra_cha_chan" rel="noopener ugc nofollow" target="_blank">Chanhee Lee</a> on Unsplash</figcaption></figure><p id="86e9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了避免单个服务器承载过多的工作负载，有两个主要方向可以解决这个问题:</p><ol class=""><li id="abfc" class="mk ml hi iz b ja jb jd je jg mm jk mn jo mo js mp mq mr ms bi translated">降低集群扩展触发器的度量值上限</li><li id="dc91" class="mk ml hi iz b ja mt jd mu jg mv jk mw jo mx js mp mq mr ms bi translated">通过重新连接重塑流量</li></ol><h2 id="c66d" class="lw la hi bd lb lx ly lz lf ma mb mc lj jg md me ll jk mf mg ln jo mh mi lp mj bi translated">降低集群扩展触发器的度量值上限</h2><p id="f6e1" class="pw-post-body-paragraph ix iy hi iz b ja lr ij jc jd ls im jf jg lt ji jj jk lu jm jn jo lv jq jr js hb bi translated">假设经过一段时间的观察和统计，我们发现同一组WebSocket连接在高峰时段的工作量大约是平时的两倍，那么我们可以做一些简单的计算:</p><ul class=""><li id="4db7" class="mk ml hi iz b ja jb jd je jg mm jk mn jo mo js nn mq mr ms bi translated">将70%的资源使用设置为横向扩展触发器是非常危险的，常见的流量波动很容易使服务器过载。</li><li id="2934" class="mk ml hi iz b ja mt jd mu jg mv jk mw jo mx js nn mq mr ms bi translated">将50%的资源使用率设置为横向扩展触发器可能是一个很好的选择，从过去的经验来看，每台服务器在超过99%的时间里都不会耗尽资源。</li><li id="5652" class="mk ml hi iz b ja mt jd mu jg mv jk mw jo mx js nn mq mr ms bi translated">将30%的资源使用率设置为横向扩展触发器似乎不太经济，超过一半的资源在非高峰时段处于闲置状态。</li></ul><p id="00ce" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这只是一个简单的例子，很容易解释，这个策略高度依赖于你的服务的流量形状和业务性质。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es jt"><img src="../Images/69bac4ed7d8ec6fea9b96c4afd831934.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*BL2USDaP_8UmquQc"/></div></div><figcaption class="kf kg et er es kh ki bd b be z dx">Photo by <a class="ae kj" href="https://unsplash.com/@marcuscastro" rel="noopener ugc nofollow" target="_blank">Marcus Castro</a> on Unsplash</figcaption></figure><p id="9440" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果服务只在节假日遇到流量高峰，我们绝对可以在工作日设置70%的资源使用量为上限，只在节假日前增加触发的敏感度。</p><p id="dc32" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">老实说，我不建议将这种做法作为长期解决方案。虽然这种方法相对简单，并能立竿见影，但并没有从根本上解决工作负载不均衡的问题，反而使设备成本增长更快。</p><h2 id="13d9" class="lw la hi bd lb lx ly lz lf ma mb mc lj jg md me ll jk mf mg ln jo mh mi lp mj bi translated">通过重新连接重塑流量</h2><p id="9649" class="pw-post-body-paragraph ix iy hi iz b ja lr ij jc jd ls im jf jg lt ji jj jk lu jm jn jo lv jq jr js hb bi translated">另一个更可靠的做法是通过重新连接来重塑所有流量。在一定程度上克服了长期连接的均衡失败，但也给用户体验和服务弹性带来了新的挑战。</p><blockquote class="my"><p id="f062" class="mz na hi bd nb nc nd ne nf ng nh js dx translated">每一次重新连接不仅是一次机会，也是一次风险。</p></blockquote><p id="edc1" class="pw-post-body-paragraph ix iy hi iz b ja ni ij jc jd nj im jf jg nk ji jj jk nl jm jn jo nm jq jr js hb bi translated">重新连接的时机是一个关键问题，它对负载平衡的有效性和用户体验有非常直接的影响。以下是几种常用的策略:</p><blockquote class="kl km kn"><p id="d99a" class="ix iy ko iz b ja jb ij jc jd je im jf kp jh ji jj kq jl jm jn kr jp jq jr js hb bi translated"><strong class="iz hj">定期重新连接</strong></p></blockquote><p id="8902" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这是最直观的方法之一，通过适当的时间间隔设置，几乎可以保证工作负载均衡的有效性。不幸的是，这一硬性规则的强力可能会破坏客户在使用服务时的体验。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es jt"><img src="../Images/995b68ce553d354e7d2f6db6bbc1b9a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*bWka-3csOuTa9wSQ"/></div></div><figcaption class="kf kg et er es kh ki bd b be z dx">Photo by <a class="ae kj" href="https://unsplash.com/@heytowner" rel="noopener ugc nofollow" target="_blank">JOHN TOWNER</a> on Unsplash</figcaption></figure><p id="a7f9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">产品经理可以很容易地列出不应该被打断的情况:</p><ul class=""><li id="6e51" class="mk ml hi iz b ja jb jd je jg mm jk mn jo mo js nn mq mr ms bi translated">用户在购物时没有意识到预算控制</li><li id="355d" class="mk ml hi iz b ja mt jd mu jg mv jk mw jo mx js nn mq mr ms bi translated">用户正在填写采购订单所需的信息</li><li id="1ffa" class="mk ml hi iz b ja mt jd mu jg mv jk mw jo mx js nn mq mr ms bi translated">用户在电子竞技游戏中玩玩家对玩家(PVP)竞技场</li><li id="b50a" class="mk ml hi iz b ja mt jd mu jg mv jk mw jo mx js nn mq mr ms bi translated">用户正在玩一种每轮都有时间限制的纸牌游戏，目前正在倒计时</li></ul><p id="d237" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">毫无疑问，当用户期望流畅的操作时打扰他们是很糟糕的。</p><blockquote class="kl km kn"><p id="baf9" class="ix iy ko iz b ja jb ij jc jd je im jf kp jh ji jj kq jl jm jn kr jp jq jr js hb bi translated"><strong class="iz hj">选择合适的时机重新联系</strong></p></blockquote><p id="8319" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">既然可以梳理出很多不适合重新连接的情况，那么另一方面也可能存在一些适合的。更确切的说，我们可以利用好用户可以接受并期待等待的时刻:</p><ul class=""><li id="2cc8" class="mk ml hi iz b ja jb jd je jg mm jk mn jo mo js nn mq mr ms bi translated">开始在社交应用上观看新的直播</li><li id="b194" class="mk ml hi iz b ja mt jd mu jg mv jk mw jo mx js nn mq mr ms bi translated">请求大量数据或下载文件</li><li id="8320" class="mk ml hi iz b ja mt jd mu jg mv jk mw jo mx js nn mq mr ms bi translated">在开放世界角色扮演游戏中的不同地图间传送</li></ul><p id="2064" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当用户准备等待时，他不太在乎多等一会儿，他们甚至不会注意到你在偷偷重新连接。即使重连不幸失败，也不会中断持续运行，不会产生太大的负面影响。</p></div><div class="ab cl ks kt gp ku" role="separator"><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx"/></div><div class="hb hc hd he hf"><h1 id="1d9f" class="kz la hi bd lb lc ld le lf lg lh li lj io lk ip ll ir lm is ln iu lo iv lp lq bi translated">包裹</h1><p id="7e1a" class="pw-post-body-paragraph ix iy hi iz b ja lr ij jc jd ls im jf jg lt ji jj jk lu jm jn jo lv jq jr js hb bi translated">良好的用户体验往往被视为圣杯，为了实现各种产品想象，其背后的技术和策略总是惊人的。</p><p id="76d4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我希望我在负载平衡架构和策略方面的经验分享可以帮助您在未来很好地处理软件工程中的挑战:)</p></div></div>    
</body>
</html>