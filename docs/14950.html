<html>
<head>
<title>Automate Azure Infrastructure Provisioning with Terraform — Part III</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Terraform自动化Azure基础设施供应—第三部分</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/automate-azure-infrastructure-provisioning-with-terraform-part-iii-597552137dc?source=collection_archive---------8-----------------------#2022-10-04">https://medium.com/geekculture/automate-azure-infrastructure-provisioning-with-terraform-part-iii-597552137dc?source=collection_archive---------8-----------------------#2022-10-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/04cce3f25f41d7c7f86676c2f0e6b116.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dG9AI1Npwb7aMkmoz4kb0A.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">source — Author</figcaption></figure><p id="c7bc" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">如果你错过了我之前的博客，在那里我讨论了使用Terraform和Azure DevOps部署基础设施，请参考我的个人资料。在那里，我解释了一个演示项目和所有需要的代码库。</p><p id="738b" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在进入地形问题之前，让我们先讨论一下地形摧毁命令及其问题。</p><h1 id="e70e" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">使用地形摧毁基础设施</h1><figure class="kr ks kt ku fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kq"><img src="../Images/97c4f3e1eba4dcb210ea4e92c014e482.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*c12pI5RUAXaURcx5"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">source — <a class="ae kv" href="https://riddhi-shree.medium.com/terraform-destroy-its-easy-67df22fe3028" rel="noopener">https://riddhi-shree.medium.com/terraform-destroy-its-easy-67df22fe3028</a></figcaption></figure><p id="b3b0" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">通过这样做，Terraform Plan将在销毁模式下运行，并显示建议的销毁修改，而不实际进行这些修改。<br/> Terraform会正确分析依赖模块，然后按照相反的模式删除。</p><p id="14f1" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">但是当使用Terraform破坏Azure资源时，会出现一些问题。</p><ul class=""><li id="3df1" class="kw kx hi iw b ix iy jb jc jf ky jj kz jn la jr lb lc ld le bi translated">防止资源删除— <a class="ae kv" href="https://learn.hashicorp.com/tutorials/terraform/resource-lifecycle?in=terraform/state#prevent-resource-deletion" rel="noopener ugc nofollow" target="_blank">管理资源生命周期</a></li></ul><p id="042a" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">此生命周期选项可防止Terraform意外删除关键资源。</p><pre class="kr ks kt ku fd lf lg lh li aw lj bi"><span id="4973" class="lk jt hi lg b fi ll lm l ln lo">lifecycle {<br/>prevent_destroy = true<br/>}</span></pre><p id="4917" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">如果需要删除资源，此属性应为false。</p><ul class=""><li id="39cb" class="kw kx hi iw b ix iy jb jc jf ky jj kz jn la jr lb lc ld le bi translated">删除锁</li></ul><p id="7f08" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我们可以在资源中添加几个删除锁来防止删除。例如，ACR (Azure容器注册中心)锁定存储帐户锁定等。</p><p id="a3c6" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我们必须在删除前移除这些锁。</p><ul class=""><li id="5623" class="kw kx hi iw b ix iy jb jc jf ky jj kz jn la jr lb lc ld le bi translated">从属模块</li></ul><p id="a069" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">当我们在Azure中创建资源时，会有依赖模块。对于一个实例，在创建密钥库之前，我们需要创建密钥库访问策略。那么如果因为上面提到的一些情况，导致依赖模块无法删除怎么办？那么依赖于这些模块的所有模块都不能被删除。所以它会让地形摧毁阶段失败。</p><h1 id="b986" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">使用Terraform的问题</h1><ul class=""><li id="25cb" class="kw kx hi iw b ix lp jb lq jf lr jj ls jn lt jr lb lc ld le bi translated">有些资源不支持地形改造</li></ul><p id="018a" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">例如:管道代理池创建—<a class="ae kv" href="https://github.com/Azure/terraform-azurerm-aci-devops-agent/issues/4" rel="noopener ugc nofollow" target="_blank">https://github . com/Azure/terraform-Azure RM-ACI-devo PS-Agent/issues/4</a></p><ul class=""><li id="8e1a" class="kw kx hi iw b ix iy jb jc jf ky jj kz jn la jr lb lc ld le bi translated">状态错误</li></ul><p id="d2c3" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">关于已经提供的资源的数据保存在Terraform状态文件中。资源被映射到您的配置，并且所有相关的元数据都被跟踪。如果您的状态不同步，Terraform可能会更改或删除您当前的资源。</p><ul class=""><li id="99a6" class="kw kx hi iw b ix iy jb jc jf ky jj kz jn la jr lb lc ld le bi translated">缺乏语言灵活性</li></ul><p id="097d" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">不能在tfvars文件中进行字符串插值。通常我们使用tfvars文件来定义变量。因此，如果我们想在不同的环境中重用相同的配置，我们不能在tfvars文件中这样做，因为字符串插值不能在其上完成。</p><ul class=""><li id="a750" class="kw kx hi iw b ix iy jb jc jf ky jj kz jn la jr lb lc ld le bi translated">在状态文件中存储敏感值</li></ul><p id="89d7" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这里，terraform将以明文形式将密码值存储在tfstate文件中。这是一个主要的安全问题。我在我的一篇博客中讨论过这个问题。</p><div class="lu lv ez fb lw lx"><a href="https://sachinmamoru.medium.com/most-secured-approach-to-provision-azure-key-vault-and-manage-secrets-6fc8f83f547c" rel="noopener follow" target="_blank"><div class="ly ab dw"><div class="lz ab ma cl cj mb"><h2 class="bd hj fi z dy mc ea eb md ed ef hh bi translated">提供Azure密钥库和管理机密的最安全的方法</h2><div class="me l"><h3 class="bd b fi z dy mc ea eb md ed ef dx translated">在解释这些方法之前，我们需要理解密钥库和环境供应的用例。</h3></div><div class="mf l"><p class="bd b fp z dy mc ea eb md ed ef dx translated">sachinmamoru.medium.com</p></div></div><div class="mg l"><div class="mh l mi mj mk mg ml io lx"/></div></div></a></div><p id="91ca" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">为了记录，我将向您展示我在以前的博客中讨论过的项目的tfstate文件。</p><figure class="kr ks kt ku fd ij"><div class="bz dy l di"><div class="mm mn l"/></div></figure><p id="9f96" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">现在让我们检查创建的密钥库中的一个秘密值。</p><figure class="kr ks kt ku fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mo"><img src="../Images/c717dc23ecea0c73ed6b696ed3e7ba16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZPru4kDP0hPsp379c8q8TA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">source — Author</figcaption></figure><p id="b53c" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">如果您在上面的tfstate文件中搜索这个值，您会看到它已经以纯文本的形式存储了秘密值。</p><p id="fe9b" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">为了缓解这个问题，最好使用单独的bash文件存储秘密，而不是使用Terraform。</p><h1 id="01b8" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">要点</h1><p id="b947" class="pw-post-body-paragraph iu iv hi iw b ix lp iz ja jb lq jd je jf mp jh ji jj mq jl jm jn mr jp jq jr hb bi translated">现在让我们来讨论我在项目中遇到的几个关键点。</p><h2 id="55bf" class="lk jt hi bd ju ms mt mu jy mv mw mx kc jf my mz kg jj na nb kk jn nc nd ko ne bi translated">状态文件锁定</h2><p id="51b4" class="pw-post-body-paragraph iu iv hi iw b ix lp iz ja jb lq jd je jf mp jh ji jj mq jl jm jn mr jp jq jr hb bi translated">有时，当我们在状态中间停止terraform应用程序时，文件会损坏，其状态会被锁定，在此情况下，我们无法应用到terraform，直到我们释放锁定。</p><figure class="kr ks kt ku fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nf"><img src="../Images/7eee7fe9941b7fd71574fd98a637a2be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NLqeHxCQ4P5Hsvg4P8J3fw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">source — Author</figcaption></figure><p id="87c9" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">为此，我们必须访问Azure门户，并需要获得状态文件存储帐户来解除租约。</p><figure class="kr ks kt ku fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ng"><img src="../Images/3a08626dccafcbd959235892a6dfc1de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XAHw57k-GirQDwRGm9lREA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">source — Author</figcaption></figure><p id="6785" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">一旦你点击<strong class="iw hj">解除租赁</strong>，它将解除锁定。</p><figure class="kr ks kt ku fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nh"><img src="../Images/c8208d5faeb5736efbf6cc14b8a49432.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zh6sg1JO7KV3TsbQ8yMbeA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">source — Author</figcaption></figure><p id="a008" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">现在，您将看到租赁状态为“已中断”。现在，您可以再次应用地形。</p><h2 id="7160" class="lk jt hi bd ju ms mt mu jy mv mw mx kc jf my mz kg jj na nb kk jn nc nd ko ne bi translated">mac m1 pro机器中的Docker映像构建</h2><p id="d775" class="pw-post-body-paragraph iu iv hi iw b ix lp iz ja jb lq jd je jf mp jh ji jj mq jl jm jn mr jp jq jr hb bi translated">基于ARM的MacBook Pro中的苹果M1 Pro处理器可能会导致这个问题。因此，Docker build命令默认以arm64为目标。<br/>实际上，Docker认为苹果M1 Pro平台是linux/arm64/v8。<br/>在版本标签和构建命令中提供平台就足够了:</p><pre class="kr ks kt ku fd lf lg lh li aw lj bi"><span id="aa83" class="lk jt hi lg b fi ll lm l ln lo">docker build --platform=linux/arm64 -t &lt;image-name&gt;:&lt;version&gt;-arm64</span></pre><h2 id="1514" class="lk jt hi bd ju ms mt mu jy mv mw mx kc jf my mz kg jj na nb kk jn nc nd ko ne bi translated">Azure Pipelines对私人项目拨款的变化</h2><p id="456c" class="pw-post-body-paragraph iu iv hi iw b ix lp iz ja jb lq jd je jf mp jh ji jj mq jl jm jn mr jp jq jr hb bi translated">Azure方面发生了一个政策变化，微软已经暂时禁止为公共项目和新组织中的某些私人项目免费提供并行工作。</p><div class="lu lv ez fb lw lx"><a href="https://devblogs.microsoft.com/devops/change-in-azure-pipelines-grant-for-private-projects/" rel="noopener  ugc nofollow" target="_blank"><div class="ly ab dw"><div class="lz ab ma cl cj mb"><h2 class="bd hj fi z dy mc ea eb md ed ef hh bi translated">Azure Pipelines对私人项目拨款的变化</h2><div class="me l"><h3 class="bd b fi z dy mc ea eb md ed ef dx translated">Azure Pipelines从一开始就向客户提供免费的CI/CD。这允许人们尝试Azure…</h3></div><div class="mf l"><p class="bd b fp z dy mc ea eb md ed ef dx translated">devblogs.microsoft.com</p></div></div><div class="mg l"><div class="ni l mi mj mk mg ml io lx"/></div></div></a></div><p id="d985" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">但是您可以通过以下表格申请免费层。</p><div class="lu lv ez fb lw lx"><a href="https://aka.ms/azpipelines-parallelism-request" rel="noopener  ugc nofollow" target="_blank"><div class="ly ab dw"><div class="lz ab ma cl cj mb"><h2 class="bd hj fi z dy mc ea eb md ed ef hh bi translated">Microsoft表单</h2><div class="me l"><h3 class="bd b fi z dy mc ea eb md ed ef dx translated">编辑描述</h3></div><div class="mf l"><p class="bd b fp z dy mc ea eb md ed ef dx translated">又名ms</p></div></div></div></a></div><p id="51e8" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这就是关于<strong class="iw hj">用Terraform </strong>自动化Azure基础设施供应的博客系列。</p><p id="9980" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">谢谢，继续读☺️.</p></div></div>    
</body>
</html>