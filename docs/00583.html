<html>
<head>
<title>Responsive Image Optimization With Media in Drupal 9</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Drupal 9中的媒体响应图像优化</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/responsive-image-optimization-with-media-in-drupal-9-62080c31d5f4?source=collection_archive---------1-----------------------#2021-03-06">https://medium.com/geekculture/responsive-image-optimization-with-media-in-drupal-9-62080c31d5f4?source=collection_archive---------1-----------------------#2021-03-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/35aa03507b6c6750431fe0d27eff0723.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ay9b3CtelTzpl3ZbhLYtgA.png"/></div></div></figure><div class=""/><p id="d13f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">正确配置响应式映像总是一件痛苦的事情。在Drupal中，你可以<a class="ae jo" href="https://www.drupal.org/docs/theming-drupal/working-with-breakpoints-in-drupal" rel="noopener ugc nofollow" target="_blank">在你的主题或模块</a>中创建断点，并使用<a class="ae jo" href="https://www.drupal.org/docs/mobile-guide/responsive-images" rel="noopener ugc nofollow" target="_blank">响应图像模块</a>来设置不同的响应图像样式，定义特定断点使用哪种图像样式。这需要相当多的工作和计划来设置一切，如果需要更改，维护所有的图像样式总是一件痛苦的事情。我最近建立的大多数网站也有流畅的设计。由于图像是为固定断点定义的，这导致为用户加载的许多图像仍然太大。</p><p id="d834" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">经过一番努力，我们思考如何找到一种方法来改善这种情况。在HTML5中，我们可以定义一个“srcset”属性，它根据浏览器的视窗加载正确的图像。为了获得更好的性能，默认的“src”包含了一个非常小的图像版本。还要注意HTML5的“loading”属性，它支持图像的延迟加载，从而实现更多的优化。</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="44a0" class="jy jz ht ju b fi ka kb l kc kd">&lt;img src="image-50w.jpg" srcset="image-480w.jpg 480w, image-800w.jpg 800w" alt="My pretty image" loading="lazy" /&gt;</span></pre><h1 id="8433" class="ke jz ht bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">每纵横比的媒体视图模式</h1><p id="8bf5" class="pw-post-body-paragraph iq ir ht is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">由于我们使用媒体将图像添加到内容中，我们尝试了由纵横比定义的媒体视图模式，并结合了特定纵横比的图像的一系列不同图像样式。媒体模板可以为所有图像样式提供不同的宽度，并使用“srcset”属性让浏览器选择最佳图像。因此，我们现在得到了4:3和16:9比例的图像样式，如下所示:</p><ul class=""><li id="fa8c" class="lg lh ht is b it iu ix iy jb li jf lj jj lk jn ll lm ln lo bi translated">响应式_4_3_50w</li><li id="3e51" class="lg lh ht is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated">响应式_16_9_50w</li><li id="3106" class="lg lh ht is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated">响应式_4_3_150w</li><li id="26f0" class="lg lh ht is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated">响应式_16_9150w</li><li id="fa80" class="lg lh ht is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi">…</li><li id="1eb9" class="lg lh ht is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated">响应式_4_3_1450w</li><li id="daa2" class="lg lh ht is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated">响应式_16_9_1450w</li></ul><p id="7e7c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于保持原始比例的图像，我们只使用宽度，如<em class="lu"> 50w </em>、<em class="lu"> 150w </em>等。我们的“16_9”视图模式的媒体模板(<em class="lu">media-image-16-9 . html . Twig</em>)现在看起来像这样，使用<a class="ae jo" href="https://www.drupal.org/project/twig_tweak" rel="noopener ugc nofollow" target="_blank"> Twig Tweak模块</a>的“image_style”过滤器从文件中加载图像样式的实际图像URL:</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="0d85" class="jy jz ht ju b fi ka kb l kc kd">{#<br/>/**<br/> * @file<br/> * Default theme implementation to display an image.<br/> */<br/>#}<br/>{% set file = media.field_media_image.entity %}<br/>{% set src = file.uri.value|image_url('responsive_16_9_50w') %}<br/>{% set srcset = [<br/>  file.uri.value|image_style('responsive_16_9_150w') ~ ' 150w',<br/>  file.uri.value|image_style('responsive_16_9_350w') ~ ' 350w',<br/>  file.uri.value|image_style('responsive_16_9_550w') ~ ' 550w',<br/>  file.uri.value|image_style('responsive_16_9_950w') ~ ' 950w',<br/>  file.uri.value|image_style('responsive_16_9_1250w') ~ ' 1250w',<br/>  file.uri.value|image_style('responsive_16_9_1450w') ~ ' 1450w',<br/>] %}<br/>&lt;img src="{{ src }}" srcset="{{ srcset|join(',') }}" alt="{{ media.field_media_image.alt }}" loading="lazy" /&gt;</span></pre><h1 id="f137" class="ke jz ht bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">基于容器宽度的图像样式</h1><p id="9168" class="pw-post-body-paragraph iq ir ht is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">我们注意到的第一个问题是,“srcset”属性使用了视窗宽度，而不是图像容器的宽度。这意味着当视窗为1400像素，图像显示在宽度为200像素的列中时，浏览器会选择宽度为1400像素的图像样式。这并没有给我们想要的结果。计算容器宽度的唯一方法是通过JavaScript，因此我们编写了一个小脚本来计算每个图像的可用宽度，并使用<a class="ae jo" href="https://developer.mozilla.org/en-US/docs/Web/API/ResizeObserver" rel="noopener ugc nofollow" target="_blank"> ResizeObserver </a>加载正确的图像样式。ResizeObserver在IE11中不工作，但这不是我们项目的要求。此外，Drupal还将<a class="ae jo" href="https://www.drupal.org/node/3199540" rel="noopener ugc nofollow" target="_blank">在Drupal 10 </a>中放弃IE11支持！为了防止浏览器最初从“srcset”属性加载大图像，我们将“srcset”属性更改为“data-srcset ”,并让JavaScript处理剩下的部分。</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="7688" class="jy jz ht ju b fi ka kb l kc kd">// Fetch all images containing a "data-srcset" attribute.<br/>const images = context.querySelectorAll('img[data-srcset]');<br/><br/>// Create a ResizeObserver to update the image "src" attribute when its<br/>// parent container resizes.<br/>const observer = new ResizeObserver(entries =&gt; {<br/>  for (let entry of entries) {<br/>    const images = entry.target.querySelectorAll('img[data-srcset]');<br/>    images.forEach(image =&gt; {<br/>      const availableWidth = <strong class="ju hu"><em class="lu">Math</em></strong>.floor(image.parentNode.clientWidth);<br/>      const attrWidth = image.getAttribute('width');<br/>      const sources = image.getAttribute('data-srcset').split(',');<br/><br/>      // If the selected image is already bigger than the available width,<br/>      // we do not update the image.<br/>      if (attrWidth &amp;&amp; attrWidth &gt; availableWidth) {<br/>        return;<br/>      }<br/><br/>      // Find the best matching source based on actual image space.<br/>      let source, responsiveImgPath, responsiveImgWidth;<br/>      for (source of sources) {<br/>        let array = source.split(' ');<br/>        responsiveImgPath = array[0];<br/>        responsiveImgWidth = array[1].slice(0, -1);<br/>        if (availableWidth &lt; responsiveImgWidth) {<br/>          break;<br/>        }<br/>      }<br/><br/>      // Update the "src" with the new image and also set the "width"<br/>      // attribute to easily check if we need a new image after resize.<br/>      image.setAttribute('src', responsiveImgPath);<br/>      image.setAttribute('width', responsiveImgWidth);<br/>    });<br/>  }<br/>});<br/><br/>// Attach the ResizeObserver to the image containers.<br/>images.forEach(image =&gt; {<br/>  observer.observe(image.parentNode);<br/>});</span></pre><h1 id="e0d4" class="ke jz ht bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">自动生成图像样式</h1><p id="d479" class="pw-post-body-paragraph iq ir ht is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">这种方法的第二个问题是创建我们需要的所有图像样式。这可以通过一个表单来自动创建我们需要的长宽比的所有图像样式来解决。因此，我们建立了<a class="ae jo" href="https://www.drupal.org/project/easy_responsive_images" rel="noopener ugc nofollow" target="_blank">易响应图像模块</a>。该模块需要最小和最大宽度以及每种图像风格之间的优选像素数量。还可以定义一个可选的纵横比列表。保存配置时，会自动生成样式。</p><figure class="jp jq jr js fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lv"><img src="../Images/ca9f6c1671c64275e0d5c8685532a579.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y972LldgwCZqR7-6cV-wjQ.png"/></div></div></figure><h1 id="93da" class="ke jz ht bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">图像优化和WebP支持</h1><p id="c33c" class="pw-post-body-paragraph iq ir ht is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">既然我们已经基于容器加载了最好的图像，我们可以再采取一个步骤来提高图像的性能。使用<a class="ae jo" href="https://www.drupal.org/project/imageapi_optimize" rel="noopener ugc nofollow" target="_blank">图像优化模块</a>，我们可以创建优化管道，可以自动应用于通过图像样式显示的图像。我们选择使用通过<a class="ae jo" href="https://www.drupal.org/project/imageapi_optimize_binaries" rel="noopener ugc nofollow" target="_blank">图像优化二进制文件模块</a>支持的JpegOptim和PngQuant(<a class="ae jo" href="https://www.previousnext.com.au/blog/better-image-optimisation-drupal" rel="noopener ugc nofollow" target="_blank">上一篇博客</a>包含了更多关于模块和结果的数据)。如果你不能在你的服务器上安装这些二进制文件，还有一个<a class="ae jo" href="https://www.drupal.org/project/imageapi_optimize_gd" rel="noopener ugc nofollow" target="_blank"> ImageAPI优化GD模块</a>。</p><p id="afca" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后还有<a class="ae jo" href="https://www.drupal.org/project/imageapi_optimize_webp" rel="noopener ugc nofollow" target="_blank"> ImageAPI优化WebP </a>模块。</p><blockquote class="lw lx ly"><p id="5498" class="iq ir lu is b it iu iv iw ix iy iz ja lz jc jd je ma jg jh ji mb jk jl jm jn hb bi translated">WebP是一种现代图像格式，为网络上的图像提供卓越的无损和有损压缩。使用WebP，网站管理员和web开发人员可以创建更小、更丰富的图像，使web速度更快。</p></blockquote><p id="4eb3" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在我们的测试中，我们发现对于大多数图像，WebP比jpg图像小30%-50%。对于png图像，它甚至更多。为了在浏览器支持时轻松加载图像的WebP版本，我们在<a class="ae jo" href="https://www.drupal.org/project/easy_responsive_images" rel="noopener ugc nofollow" target="_blank"> Easy Responsive Images模块</a>中创建了一个“image_url”分支过滤器，通过<a class="ae jo" href="https://www.drupal.org/project/imagecache_external" rel="noopener ugc nofollow" target="_blank"> Imagecache外部模块</a>增加了对外部图像的额外支持。</p><p id="4a6e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用JavaScript和新的Twig过滤器的媒体视图模式的最终文件如下所示:</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="95fc" class="jy jz ht ju b fi ka kb l kc kd">{#<br/>/**<br/> * @file<br/> * Default theme implementation to display an image.<br/> */<br/>#}<br/>{{ attach_library('easy_responsive_images/resizer') }}</span><span id="c757" class="jy jz ht ju b fi mc kb l kc kd">{% set file = media.field_media_image.entity %}<br/>{% set src = file.uri.value|image_url('responsive_16_9_50w') %}<br/>{% set srcset = [<br/>  file.uri.value|image_url('responsive_16_9_150w') ~ ' 150w',<br/>  file.uri.value|image_url('responsive_16_9_350w') ~ ' 350w',<br/>  file.uri.value|image_url('responsive_16_9_550w') ~ ' 550w',<br/>  file.uri.value|image_url('responsive_16_9_950w') ~ ' 950w',<br/>  file.uri.value|image_url('responsive_16_9_1250w') ~ ' 1250w',<br/>  file.uri.value|image_url('responsive_16_9_1450w') ~ ' 1450w',<br/>] %}<br/>&lt;img src="{{ src }}" data-srcset="{{ srcset|join(',') }}" alt="{{ media.field_media_image.alt }}" loading="lazy" /&gt;</span></pre><p id="2d43" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该示例对所有定义的宽度使用相同的纵横比，但从技术上讲，这不是一项要求。根据需要，仍然可以对较小/较大的屏幕使用不同的宽高比，尽管这将使设置更加复杂，并且需要更多的媒体查看模式。</p><p id="7a52" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">大概就是这样。接下来的一些步骤可能是为模块添加格式化程序，并弄清楚对视网膜图像的支持(即使这些会增加图像大小)。</p><p id="6a01" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">希望这有助于任何希望改进和优化Drupal中响应图像实现方式的人。</p></div></div>    
</body>
</html>