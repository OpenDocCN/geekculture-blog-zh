<html>
<head>
<title>Deploying PHP-App-as-a-Container Services in Amazon Lightsail with Github Actions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Github操作在Amazon Lightsail中部署PHP-App-as-a-Container服务</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/deploying-php-app-as-a-container-services-in-amazon-lightsail-with-github-actions-edbe68fcb45d?source=collection_archive---------28-----------------------#2021-06-21">https://medium.com/geekculture/deploying-php-app-as-a-container-services-in-amazon-lightsail-with-github-actions-edbe68fcb45d?source=collection_archive---------28-----------------------#2021-06-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="f314" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">作者:<a class="ae jd" href="https://github.com/neidiom" rel="noopener ugc nofollow" target="_blank">奈迪姆·哈德济马穆托维奇</a></p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/b2d8a44d312e152327abfc67da8a3460.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Edvf_WhAeT_TOkr9K-toOA.jpeg"/></div></div></figure><p id="cb4a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">AWS Lightsail containers服务是一种新的、简单的部署容器的方式。有了Lightsail，你不需要担心注册表、服务、健康检查、主机名等。—因为一切都是内置的。</p><h1 id="b1e3" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">我们的应用</h1><p id="f678" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">在本例中，我们将部署一个虚拟PHP应用程序并运行两个容器:</p><ul class=""><li id="3b2f" class="kt ku hi ih b ii ij im in iq kv iu kw iy kx jc ky kz la lb bi translated">NginX容器</li><li id="e2cb" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">PHP容器</li></ul><p id="4ced" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我甚至提供了一个虚拟的composer文件，以便我们可以安装依赖项。</p><h1 id="5b2e" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">NginX容器</h1><p id="782d" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">这个docker文件复制预先配置的NginX配置文件，并设置常用的内容，例如:</p><ul class=""><li id="1b54" class="kt ku hi ih b ii ij im in iq kv iu kw iy kx jc ky kz la lb bi translated">webroot，</li><li id="53f8" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">启用gzip，</li><li id="aa21" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">增加大小限制，这样我们就不会得到通常的超时，</li><li id="b6e1" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">当然，最重要的事情是:将php文件传递给PHP容器(它监听端口9001)。</li></ul><p id="3526" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有关更多详细信息，请参见下面的链接文件。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lh li l"/></div><figcaption class="lj lk et er es ll lm bd b be z dx"><a class="ae jd" href="https://github.com/ClearView/aws_lightsail/blob/master/infra/Dockerfile.nginx" rel="noopener ugc nofollow" target="_blank">Dockerfile</a></figcaption></figure><h1 id="4d76" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">PHP容器</h1><p id="cc7c" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">该does文件执行以下操作:</p><ul class=""><li id="9824" class="kt ku hi ih b ii ij im in iq kv iu kw iy kx jc ky kz la lb bi translated">使用最新的Composer Docker映像将Composer二进制文件复制到PHP映像，</li><li id="bcc6" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">安装PHP版本8和所需的扩展，</li><li id="d8a1" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">设置php.ini中的常用参数，</li><li id="172f" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">显示了构建过程中安装的php模块(非常适合调试)，</li><li id="58ea" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">将PHP-FPM端口从标准的9000更改为9001，</li><li id="349c" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">运行composer安装命令，</li><li id="3a49" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">使用自定义入口点脚本，这对于错误调试非常有用，因为您可以稍后添加自定义命令(将在容器启动时运行)。</li></ul><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lh li l"/></div><figcaption class="lj lk et er es ll lm bd b be z dx"><a class="ae jd" href="https://github.com/ClearView/aws_lightsail/blob/master/infra/Dockerfile.php" rel="noopener ugc nofollow" target="_blank">Dockerfile</a></figcaption></figure><h1 id="96b8" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">Lightsail设置</h1><p id="b3bd" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">通过<em class="ln"> awscli </em>创建服务。我们必须选择:</p><ul class=""><li id="1e35" class="kt ku hi ih b ii ij im in iq kv iu kw iy kx jc ky kz la lb bi translated">服务的名称，</li><li id="f80d" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">服务的能力(内存和vCPU)，</li><li id="f9e6" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">服务的规模(运行容器的计算节点的数量)。</li></ul><p id="0311" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本例中，我们将添加一个名为my-lightsail-container-service的服务，它具有nano的功能，我们将把它扩展到一个计算节点实例。</p><p id="9fda" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="ln">注意:有时部署会因为缺乏资源而失败；在这种情况下，提高服务的能力。</em></p><pre class="jf jg jh ji fd lo lp lq lr aw ls bi"><span id="5bf2" class="lt jr hi lp b fi lu lv l lw lx">aws lightsail create-container-service \<br/>— service-name my-lightsail-container-service \<br/>— power nano \<br/>— scale 1 \<br/>— output yaml</span></pre><p id="56e5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="ln">注意:您需要添加服务名作为Github秘密，以便通过Github动作进行部署。</em></p><p id="6928" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们检查一下:</p><ol class=""><li id="8c85" class="kt ku hi ih b ii ij im in iq kv iu kw iy kx jc ly kz la lb bi translated">如果已经创建了服务</li><li id="df4c" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ly kz la lb bi translated">它的状态</li><li id="e682" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ly kz la lb bi translated">公共端点。</li></ol><pre class="jf jg jh ji fd lo lp lq lr aw ls bi"><span id="c348" class="lt jr hi lp b fi lu lv l lw lx">aws lightsail \<br/>get-container-services \<br/>— output yaml</span></pre><p id="2b7c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="ln">注意:您需要在本地comp上安装awscli并设置凭证，以上命令才能工作。</em></p><h1 id="14b0" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">Github操作设置</h1><h1 id="4fd2" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">秘密设置</h1><p id="b400" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">第一步是为AWS身份验证设置Github秘密，并设置将在AWS Lightsail上创建的容器服务名称。</p><p id="b4e4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为此，创建以下秘密，如下图所示:</p><ul class=""><li id="a307" class="kt ku hi ih b ii ij im in iq kv iu kw iy kx jc ky kz la lb bi translated">AWS_ACCESS_KEY_ID</li><li id="e56b" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">AWS_SECRET_ACCESS_KEY</li><li id="757b" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">AWS_REGION</li><li id="66f1" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">服务名称</li></ul><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es lz"><img src="../Images/424965f72d37e994d3a052813700e892.png" data-original-src="https://miro.medium.com/v2/resize:fit:864/format:webp/1*ST0QtX2Qj5ePMhzp9z0QgQ.png"/></div></figure><h1 id="1458" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">工作流程</h1><p id="0574" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">GitHub操作由两个文件组成:</p><ul class=""><li id="b207" class="kt ku hi ih b ii ij im in iq kv iu kw iy kx jc ky kz la lb bi translated">运行操作的CI/CD工作流文件，</li><li id="5c22" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">容器部署模板。</li></ul><h2 id="75a1" class="lt jr hi bd js ma mb mc jw md me mf ka iq mg mh ke iu mi mj ki iy mk ml km mm bi translated">CI/CD工作流文件</h2><p id="3da4" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">工作流程中的步骤如下:</p><ul class=""><li id="4c7d" class="kt ku hi ih b ii ij im in iq kv iu kw iy kx jc ky kz la lb bi translated">升级转轮上的<em class="ln"> awscli </em>并安装<em class="ln"> lightsailctl </em>，</li><li id="7c2b" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">配置AWS凭证，以便我们能够部署，</li><li id="4f31" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">构建Docker PHP映像，</li><li id="2507" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">构建Docker NginX映像，</li><li id="95bb" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">列出了滑道上的Docker图像，</li><li id="74c5" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">推送Docker PHP图片，</li><li id="c3be" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">推送Docker NginX图像，</li><li id="bcc5" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">从Lightsail获取Docker图像，</li><li id="8838" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">从Lightsail获取最新的NginX Docker图片，</li><li id="8ffb" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">从Lightsail获取最新的PHP Docker图片，</li><li id="444e" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">从Lightsail获取最新的PHP Docker图片，保存到LATEST _ PHP _ light sail _ Docker _ Image变量中，</li><li id="3a07" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">从Lightsail获取最新的NGINX Docker图片，保存到LATEST _ NGINX _ light sail _ Docker _ Image，</li><li id="2a98" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">创建container_with_image.yml并用LATEST _ PHP _ light sail _ DOCKER _ IMAGE和LATEST _ NGINX _ light sail _ DOCKER _ IMAGE中的值填充它，</li><li id="e0b7" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">展开光帆，</li><li id="65ed" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">调试PHP容器日志，</li><li id="d2d5" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">调试NginX容器日志。</li></ul><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lh li l"/></div><figcaption class="lj lk et er es ll lm bd b be z dx"><a class="ae jd" href="https://github.com/ClearView/aws_lightsail/blob/master/.github/workflows/build_and_deploy.yml" rel="noopener ugc nofollow" target="_blank">CI/CD_Workflow</a></figcaption></figure><h2 id="4f37" class="lt jr hi bd js ma mb mc jw md me mf ka iq mg mh ke iu mi mj ki iy mk ml km mm bi translated">容器部署文件</h2><p id="f707" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">这个文件定义了AWS Lightsail解析的最终结果。它采取了上述所有步骤才到达这里；我们有部署文件的最终版本。</p><p id="e179" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该文件定义了以下内容:</p><ul class=""><li id="8360" class="kt ku hi ih b ii ij im in iq kv iu kw iy kx jc ky kz la lb bi translated">服务名称，</li><li id="9e73" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">具有最新映像版本的容器，</li><li id="7672" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">每个容器的环境变量，</li><li id="46ab" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">哪个容器将被用作公共端点，</li><li id="9207" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">健康检查。</li></ul><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lh li l"/></div><figcaption class="lj lk et er es ll lm bd b be z dx"><a class="ae jd" href="https://github.com/ClearView/aws_lightsail/blob/master/.github/workflows/container.yml.tpl" rel="noopener ugc nofollow" target="_blank">Container_Deployment</a></figcaption></figure><h1 id="5d53" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">关闭</h1><p id="f95f" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">在本教程中，我们详细演示了如何使用Github操作将流行的Github平台上托管的PHP应用程序部署到AWS Lightsail容器服务，以及如何调试已部署的容器。我们希望您在使用AWS的这项新技术时会感到愉快，这项技术让容器离更广泛的受众更近了一步。</p><p id="d48c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇文章的最后，我们将分享到Clearview的AWS Lightsail Github库的链接。</p></div></div>    
</body>
</html>