<html>
<head>
<title>Envoy for TLS origination</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">TLS发起特使</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/setup-envoy-for-tls-origination-973d3cab6d1b?source=collection_archive---------20-----------------------#2021-05-05">https://medium.com/geekculture/setup-envoy-for-tls-origination-973d3cab6d1b?source=collection_archive---------20-----------------------#2021-05-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="9e74" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">特使版本:1.8.0 </em></p><blockquote class="je jf jg"><p id="f90e" class="if ig jd ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated">配置特使是设置特使最难的部分之一。</p></blockquote><p id="912d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi jk translated"><span class="l jl jm jn bm jo jp jq jr js di"> R </span>最近，我需要设置TLS发起的特使，当你在私有网络中处理数百个微服务时，这非常有用，并且一些服务需要通过HTTPS与第三方服务进行对话。拥有TLS发起有助于通过消除拥有HTTPS服务器的需求来更容易地编写服务测试。</p><h1 id="6cae" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated"><strong class="ak">步骤1 </strong>:准备配置</h1><figure class="kr ks kt ku fd kv"><div class="bz dy l di"><div class="kw kx l"/></div></figure><p id="3738" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们讨论一下这个特定于TLS发起要求的配置。</p><p id="a6ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> request_headers_to_add: </strong>这是一个监听器配置，用于向传出的上游请求添加头。这可用于添加上游服务器授权所需的任何凭证。最后附加的报头，即<strong class="ih hj">主机</strong>是一个非常特殊的报头，如果您不重写它，那么如果上游服务器使用主机报头来确定其相应的上游主机，您将获得HTTP状态代码<strong class="ih hj"> 404 </strong>。例如没有主机重写</p><figure class="kr ks kt ku fd kv er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es ky"><img src="../Images/fcc7f3ac3f7cdedcba06b51bbd2e35fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XHFGrX9CERQXWxWG-cnlhA.png"/></div></div><figcaption class="lf lg et er es lh li bd b be z dx">envoy without host rewrite</figcaption></figure><p id="1c61" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">另一方面，用主机重写作品如下:</p><figure class="kr ks kt ku fd kv er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es ky"><img src="../Images/7cd2cd9dd91df20081f5fece4cfea9f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zfnA-N7sR4sJ-ZxhB8rcOA.png"/></div></div><figcaption class="lf lg et er es lh li bd b be z dx">envoy with host rewrite</figcaption></figure><p id="e384" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> tls_context: </strong>该配置键用于定义特使是否需要进行上游tls_origination，同时<strong class="ih hj"> alpn_protocols </strong>仅在上游服务器公开alpn协议时使用。更多细节可以在官方文档<a class="ae lj" href="https://www.envoyproxy.io/docs/envoy/v1.8.0/api-v2/api/v2/auth/cert.proto#envoy-api-msg-auth-commontlscontext" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><h1 id="9095" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">步骤2:调试</h1><p id="5df0" class="pw-post-body-paragraph if ig hi ih b ii lk ik il im ll io ip iq lm is it iu ln iw ix iy lo ja jb jc hb bi translated">即使在使用上述配置，或使用更新的配置或更新的特使版本，您可能需要调试，以检查TLS握手是否工作。</p><p id="0e30" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我更喜欢在将日志级别设置为<code class="du lp lq lr ls b">trace</code>时，先查看特使日志。希望，你会找到一些东西，如果没有，那么是时候把大枪。</p><p id="0d40" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> tcpdump: </strong>借助以下命令，您可以使用它来捕获TCP流量:</p><pre class="kr ks kt ku fd lt ls lu lv aw lw bi"><span id="bdc1" class="lx ju hi ls b fi ly lz l ma mb">tcpdump -ni eth0 "tcp port 443 and (tcp[((tcp[12] &amp; 0xf0) &gt;&gt; 2)] = 0x16)"</span></pre><p id="cc40" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以查看<a class="ae lj" href="https://stackoverflow.com/questions/39624745/capture-only-ssl-handshake-with-tcpdump" rel="noopener ugc nofollow" target="_blank">这篇</a>堆栈溢出文章了解更多细节。</p><p id="aab2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果特使的吊舱部署在k8s上，同样的命令也可以在其上运行。</p><p id="e5e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> ngrep </strong>:您可以使用下面的命令安装这个命令行工具</p><pre class="kr ks kt ku fd lt ls lu lv aw lw bi"><span id="56f8" class="lx ju hi ls b fi ly lz l ma mb">apt-get install ngrep</span></pre><p id="c610" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">安装后，grep上游的IP地址，只观察相关的流量</p><pre class="kr ks kt ku fd lt ls lu lv aw lw bi"><span id="d456" class="lx ju hi ls b fi ly lz l ma mb">ngrep -Wbyline "upstream ip address" -d any</span></pre><p id="060b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">wireshark: 我个人更喜欢这种方法，如果有太多的日志，并且上面的两个命令对搜索和过滤功能都没有帮助。</p><ul class=""><li id="48b9" class="mc md hi ih b ii ij im in iq me iu mf iy mg jc mh mi mj mk bi translated">首先在本地安装Wireshark。</li><li id="50cf" class="mc md hi ih b ii ml im mm iq mn iu mo iy mp jc mh mi mj mk bi translated">使用以下命令在本地计算机上创建命名管道</li></ul><pre class="kr ks kt ku fd lt ls lu lv aw lw bi"><span id="5f0f" class="lx ju hi ls b fi ly lz l ma mb">mkfifo /tmp/remote</span></pre><ul class=""><li id="799b" class="mc md hi ih b ii ij im in iq me iu mf iy mg jc mh mi mj mk bi translated">然后将Wireshark指向这个</li></ul><pre class="kr ks kt ku fd lt ls lu lv aw lw bi"><span id="fe77" class="lx ju hi ls b fi ly lz l ma mb">wireshark -k -i /tmp/remote</span></pre><ul class=""><li id="015f" class="mc md hi ih b ii ij im in iq me iu mf iy mg jc mh mi mj mk bi translated">使用以下命令在远程计算机上运行tcpdump命令。</li></ul><pre class="kr ks kt ku fd lt ls lu lv aw lw bi"><span id="0c23" class="lx ju hi ls b fi ly lz l ma mb">ssh root@firewall "tcpdump -s 0 -U -n -w - -i eth0 not port 22" &gt; /tmp/remote</span></pre><p id="c1ee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果特使部署在k8s上</p><pre class="kr ks kt ku fd lt ls lu lv aw lw bi"><span id="c187" class="lx ju hi ls b fi ly lz l ma mb">k exec envoy-876ffdb89-2542s -- tcpdump -s 0 -U -n -w - -i eth0 &gt; /tmp/remote</span></pre><ul class=""><li id="d7e3" class="mc md hi ih b ii ij im in iq me iu mf iy mg jc mh mi mj mk bi translated">一旦您通过envoy向backend1发送请求，您应该立即在Wireshark GUI上观察到一些流量，然后您可以使用<code class="du lp lq lr ls b">tls</code>过滤器来检查TLS握手。</li></ul><figure class="kr ks kt ku fd kv er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es mq"><img src="../Images/7c60fbb5134c2b3b991bb6d4b5f9326c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_hwpjrmW6MXxmwXEeHvEqg.png"/></div></div><figcaption class="lf lg et er es lh li bd b be z dx">Wireshark TLS traffic</figcaption></figure><p id="7f4e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在评论中回复您的反馈、建议以及您遇到的任何其他用于调试envoy配置的工具。</p></div></div>    
</body>
</html>