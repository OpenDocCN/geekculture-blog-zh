<html>
<head>
<title>Sending Emails using AWS SES, Lambda and API Gateway</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS SES、Lambda和API网关发送电子邮件</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/sending-emails-using-aws-ses-lambda-and-api-gateway-ec59f5d5045d?source=collection_archive---------2-----------------------#2021-12-27">https://medium.com/geekculture/sending-emails-using-aws-ses-lambda-and-api-gateway-ec59f5d5045d?source=collection_archive---------2-----------------------#2021-12-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="12d8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Python中的概要指南</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/c187c6d688fadf69ed44dc58ed2cb3cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0RwkvUGs0SC3vuZVL72sBw.jpeg"/></div></div></figure><p id="3fcc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我正在建立一些SaaS，我将使用AWS SES发送“重置密码”功能的电子邮件。周围还有其他选择，我选择这个是因为我对它最熟悉(几年前就已经为客户这么做了)。</p><p id="cba5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">尽管如此，我仍然发现自己忘记了大部分步骤。此外，虽然我以前在Node.js中这样做过，但这一次我将使用Python(因为我最近一直在使用Python)。像往常一样，我在这里记录这个过程，以防有人(或我自己)需要。</p><h1 id="207f" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated"><strong class="ak">步骤0a:确保你在正确的区域</strong></h1><p id="5fb7" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">我实际上忘记做这个了。我的帐户创建于很久以前，那时AWS还没有那么多地区，所以我实际上在他们的默认地区切换了几个东西——us-east-1(北弗吉尼亚)。当我最近重新登录时，我没有意识到我的默认设置现在被设置为我的地理区域，我继续验证身份并请求我当前区域的限制。</p><p id="f351" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">AWS接着问我为什么要在一个新的地区申请限额。</p><p id="ac4d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">哎呀。除了身份验证和限制之外，我们稍后需要使用的SDK(在Lambda中使用)也是区域敏感的。因此，请检查区域(在菜单栏中)是否正确。</p><h1 id="667b" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">步骤0b:验证身份</h1><p id="6434" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">我们需要一些经过验证的身份来做测试——至少两个经过验证的电子邮件(一个用于发送，一个用于接收)或一个经过验证的域。如有需要，请查看<a class="ae ks" href="https://loistsnippets.hashnode.dev/a-whole-week-delayed-due-to-dns-settings" rel="noopener ugc nofollow" target="_blank">我对DNS DKIM </a>的咆哮进行域名验证。</p><h1 id="0b87" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">步骤1:创建Lambda函数</h1><p id="d3eb" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">在λ中，点击<strong class="ih hj">创建函数</strong>。我从零开始用了<strong class="ih hj">作者</strong>。</p><p id="fa1a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">输入一个<strong class="ih hj">函数名</strong>，对于<strong class="ih hj">运行时</strong>，我用的是<strong class="ih hj"> Python 3.9 </strong>(最新支持)。</p><p id="6feb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<strong class="ih hj">更改默认执行角色</strong>下，我选择了<strong class="ih hj">创建一个具有基本Lambda权限的新角色</strong>。</p><p id="ffa2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">点击<strong class="ih hj">创建功能</strong>。</p><h1 id="1b19" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">步骤Lambda角色的权限</h1><p id="a4db" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">转到IAM(如果你知道角色的名字)或者转到Lambda函数的页面，<strong class="ih hj">配置</strong>选项卡，点击角色名。</p><p id="c662" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<strong class="ih hj">权限</strong>下，点击<strong class="ih hj">附加策略</strong>。搜索<strong class="ih hj">amazonsefull access</strong>并将其添加到角色的权限中。</p><p id="f392" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果没有此步骤，您将在控制台中看到“…无权执行…”消息。</p><h1 id="be45" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated"><strong class="ak">第三步:函数体</strong></h1><p id="ba68" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">在<strong class="ih hj">代码</strong>选项卡下，将下面的基本代码(大部分摘自<a class="ae ks" href="https://docs.aws.amazon.com/ses/latest/DeveloperGuide/send-using-sdk-python.html" rel="noopener ugc nofollow" target="_blank"> AWS的文档</a>)粘贴到函数体中。请注意更改发件人和收件人地址以及AWS_REGION。在这里，我设置电子邮件地址，从<strong class="ih hj">事件</strong>参数中获取输入值。</p><pre class="je jf jg jh fd kt ku kv kw aw kx bi"><span id="ff1b" class="ky jq hi ku b fi kz la l lb lc">import json<br/>import boto3<br/>from botocore.exceptions import ClientError</span><span id="9747" class="ky jq hi ku b fi ld la l lb lc">def lambda_handler(event, context):<br/>   <br/>    <br/>    # This address must be verified with Amazon SES.<br/>    SENDER = event['from_name']+' &lt;'+event['from_address']+'&gt;'<br/>  <br/>    # If your account is still in the sandbox, this address must be verified.<br/>    RECIPIENT = event['to_address']<br/>    <br/>    <br/>    # the AWS Region you're using for Amazon SES.<br/>    AWS_REGION = "us-west-2"<br/>    <br/>    # The subject line for the email.<br/>    SUBJECT = event["email_subject"]<br/>    <br/>    # The email body for recipients with non-HTML email clients.<br/>    BODY_TEXT = ("Amazon SES Test (Python)\r\n"<br/>                 "This email was sent with Amazon SES using the "<br/>                 "AWS SDK for Python (Boto)."<br/>                )<br/>                <br/>    # The HTML body of the email.<br/>    BODY_HTML = """&lt;html&gt;<br/>    &lt;head&gt;&lt;/head&gt;<br/>    &lt;body&gt;<br/>      &lt;h1&gt;Amazon SES Test (SDK for Python)&lt;/h1&gt;<br/>      &lt;p&gt;This email was sent with<br/>        &lt;a href='<a class="ae ks" href="https://aws.amazon.com/ses/'" rel="noopener ugc nofollow" target="_blank">https://aws.amazon.com/ses/'</a>&gt;Amazon SES&lt;/a&gt; using the<br/>        &lt;a href='<a class="ae ks" href="https://aws.amazon.com/sdk-for-python/'" rel="noopener ugc nofollow" target="_blank">https://aws.amazon.com/sdk-for-python/'</a>&gt;<br/>          AWS SDK for Python (Boto)&lt;/a&gt;.&lt;/p&gt;<br/>    &lt;/body&gt;<br/>    &lt;/html&gt;<br/>                """            <br/>    <br/>    # The character encoding for the email.<br/>    CHARSET = "UTF-8"</span><span id="037d" class="ky jq hi ku b fi ld la l lb lc">    # Create SES client (edited)<br/>    ses = boto3.client('ses', region=AWS_REGION)</span><span id="d182" class="ky jq hi ku b fi ld la l lb lc">    try:<br/>        #Provide the contents of the email.<br/>        response = ses.send_email(<br/>            Destination={<br/>                'ToAddresses': [<br/>                    RECIPIENT,<br/>                ],<br/>            },<br/>            Message={<br/>                'Body': {<br/>                    'Html': {<br/>                        'Charset': CHARSET,<br/>                        'Data': BODY_HTML,<br/>                    },<br/>                    'Text': {<br/>                        'Charset': CHARSET,<br/>                        'Data': BODY_TEXT,<br/>                    },<br/>                },<br/>                'Subject': {<br/>                    'Charset': CHARSET,<br/>                    'Data': SUBJECT,<br/>                },<br/>            },<br/>            Source=SENDER<br/>        )<br/>    # Display an error if something goes wrong. <br/>    except ClientError as e:<br/>        print(e.response['Error']['Message'])<br/>    else:<br/>        print("Email sent! Message ID:"),<br/>        print(response['MessageId'])<br/>    <br/>  <br/>    return {<br/>        'statusCode': 200,<br/>        'body': json.dumps('Hello from Lambda!')<br/>    }</span></pre><p id="3af9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">点击<strong class="ih hj">部署</strong>保存更改。</p><h1 id="f7a4" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">步骤4:测试Lambda函数</h1><p id="9456" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">仍在<strong class="ih hj">代码</strong>选项卡内，点击<strong class="ih hj">测试</strong>按钮。选择<strong class="ih hj">配置测试事件</strong>。</p><p id="8bce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<strong class="ih hj">创建新的测试事件</strong>下，输入新的<strong class="ih hj">事件名称</strong>。我的活动模板如下所示(请注意，我使用的是经过验证的电子邮件地址):</p><pre class="je jf jg jh fd kt ku kv kw aw kx bi"><span id="b6fb" class="ky jq hi ku b fi kz la l lb lc">{<br/>  "from_address": "sender@verifiedidentity.com",<br/>  "from_name": "Sender Name",<br/>  "to_address": "receiver@verifiedidentity.com",<br/>  "email_subject": "Test Lambda Function"<br/>}</span></pre><p id="fd3d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">点击<strong class="ih hj">创建</strong>。</p><p id="0205" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">返回<strong class="ih hj">代码</strong>选项卡，点击<strong class="ih hj">测试</strong>。一个新的标签“执行结果”将在lambda_function标签旁边打开。</p><p id="5430" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此时，邮件应该已经成功发送到您的邮箱了。如果您在收件箱中没有看到垃圾邮件，您可能需要检查垃圾邮件文件夹。</p><h1 id="9c83" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">步骤5:触发Lambda函数</h1><p id="3742" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">现在Lambda函数开始工作了，我们需要在它前面放置一个API网关，这样它就可以作为API被触发。</p><p id="be1d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在服务下，转到<strong class="ih hj"> API网关</strong>。点击<strong class="ih hj">创建API </strong>。</p><p id="398b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于<strong class="ih hj">选择API类型</strong>，我选择了<strong class="ih hj"> REST API </strong>(表示“对请求和响应的完全控制”)。</p><p id="35f5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">输入<strong class="ih hj"> API名称、描述</strong>并点击<strong class="ih hj">创建API </strong>。</p><p id="75ca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在API页面内，点击<strong class="ih hj">动作</strong>。我选择了<strong class="ih hj">创建方法&gt;发布</strong>。在<strong class="ih hj">集成类型</strong>下，选择<strong class="ih hj"> Lambda函数</strong>，并输入上面创建的Lambda函数的名称。点击<strong class="ih hj">保存</strong>。</p><p id="2f6c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">出现一个弹出窗口，上面写着“向Lambda函数添加权限”。点击<strong class="ih hj">确定</strong>。</p><p id="ca42" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们准备测试我们的API触发器。因为我们选择了POST，所以为<strong class="ih hj">请求主体</strong>出现了一个文本字段。</p><pre class="je jf jg jh fd kt ku kv kw aw kx bi"><span id="3275" class="ky jq hi ku b fi kz la l lb lc">{<br/>  "from_address": "sender@verifiedidentity.com",<br/>  "from_name": "Sender Name",<br/>  "to_address": "receiver@verifiedidentity.com",<br/>  "email_subject": "Test API Gateway"<br/>}</span></pre><p id="8d36" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">点击<strong class="ih hj">测试</strong>。</p></div><div class="ab cl le lf gp lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="hb hc hd he hf"><p id="f23f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">可能有其他方法可以做到这一点，比如使用HTTP API选项。请随意尝试替代方案(如果有更好的或错误的地方请告诉我)，我总是从错误中学习。谢谢你读到这里，我希望这有所帮助！</p></div></div>    
</body>
</html>