<html>
<head>
<title>How to Host a Personal Email Server on Google Cloud (for Free!): Part VI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Google Cloud上托管个人邮件服务器(免费！):第六部分</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/how-to-host-a-personal-email-server-on-google-cloud-for-free-part-vi-6ea09f18d7df?source=collection_archive---------8-----------------------#2022-01-13">https://medium.com/geekculture/how-to-host-a-personal-email-server-on-google-cloud-for-free-part-vi-6ea09f18d7df?source=collection_archive---------8-----------------------#2022-01-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="a698" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">用Rspamd &amp; Sieve过滤垃圾邮件</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/6b2e8f16b70af07c66f9c8ac6b6afd8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uZ5IoRx580iym_S42I5RpA.jpeg"/></div></div></figure><h1 id="6158" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">本系列文章</h1><ol class=""><li id="72bb" class="kb kc hi kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated"><a class="ae kt" href="https://lp3.medium.com/how-to-host-a-personal-email-server-on-google-cloud-for-free-part-i-8124d65d1d25" rel="noopener">简介&amp; GCP设置</a></li><li id="30c1" class="kb kc hi kd b ke ku kg kv ki kw kk kx km ky ko kp kq kr ks bi translated"><a class="ae kt" href="https://lp3.medium.com/how-to-host-a-personal-email-server-on-google-cloud-for-free-part-ii-20aaeb0ae9eb" rel="noopener">配置后缀、邮件枪、&amp; DNS记录</a></li><li id="87c6" class="kb kc hi kd b ke ku kg kv ki kw kk kx km ky ko kp kq kr ks bi translated"><a class="ae kt" href="https://lp3.medium.com/how-to-host-a-personal-email-server-on-google-cloud-for-free-part-iii-15e2db1f1f8e" rel="noopener">配置鸽笼&amp;加密</a></li><li id="3726" class="kb kc hi kd b ke ku kg kv ki kw kk kx km ky ko kp kq kr ks bi translated"><a class="ae kt" href="https://lp3.medium.com/how-to-host-a-personal-email-server-on-google-cloud-for-free-part-iv-1b5142cab9c" rel="noopener">使用MariaDB &amp; Postfixadmin </a>管理虚拟邮箱</li><li id="8930" class="kb kc hi kd b ke ku kg kv ki kw kk kx km ky ko kp kq kr ks bi translated"><a class="ae kt" href="https://lp3.medium.com/how-to-host-a-personal-email-server-on-google-cloud-for-free-part-v-f9a4b3643622" rel="noopener">使用Roundcube托管网络邮件</a></li><li id="4f25" class="kb kc hi kd b ke ku kg kv ki kw kk kx km ky ko kp kq kr ks bi translated"><strong class="kd hj"> <em class="kz">用Rspamd &amp;筛子</em> </strong>过滤垃圾邮件</li></ol><p id="ec68" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">如果您还没有阅读本系列的前几篇文章，请按照上面的链接进行阅读。现在，我们已经将运行在GCP上的服务器配置为通过SMTP协议发送和接收电子邮件，并允许IMAP连接，同时使用TLS加密流量。我们的DNS记录配置正确，以确保电子邮件发送到我们，我们使用虚拟邮箱，因此每个邮箱不需要本地unix用户。这些文件存储在MariaDB数据库中，通过网络浏览器使用Postfixadmin进行管理。我们可以从电子邮件客户端或通过Roundcube webmail在浏览器中访问我们的邮箱。</p><p id="44ee" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">剩下的唯一步骤是处理垃圾邮件。我们将安装<em class="kz"> Rspamd </em>来检测垃圾邮件。<em class="kz"> Rspamd </em>扫描邮件的模式以确定垃圾邮件分数。分数越高，越有可能是垃圾邮件。具有高垃圾邮件分数的邮件将被直接拒绝，但是具有中等垃圾邮件分数的邮件仍将被发送，因为我们希望确保不会因误报而拒绝合法邮件。在这些情况下，会在消息中添加一个<code class="du lp lq lr ls b"><strong class="kd hj"><em class="kz">X-Spam</em></strong></code>头。因此，我们可以使用Dovecot的<em class="kz"> Sieve </em>插件将带有此标题的邮件过滤到垃圾文件夹中。太棒了，对吧？我们开始吧！</p><h1 id="b630" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">安装Rspamd</h1><p id="050f" class="pw-post-body-paragraph la lb hi kd b ke kf ij ld kg kh im lf ki lt lh li kk lu lk ll km lv ln lo ko hb bi translated">Rspamd使用<em class="kz"> Redis </em>来存储数据，所以我们必须两者都安装。</p><pre class="iy iz ja jb fd lw ls lx ly aw lz bi"><span id="8f64" class="ma jk hi ls b fi mb mc l md me">sudo apt install rspamd redis-server -y</span></pre><h2 id="f1d7" class="ma jk hi bd jl mf mg mh jp mi mj mk jt ki ml mm jv kk mn mo jx km mp mq jz mr bi translated">配置Redis</h2><p id="7d0a" class="pw-post-body-paragraph la lb hi kd b ke kf ij ld kg kh im lf ki lt lh li kk lu lk ll km lv ln lo ko hb bi translated">因为我们的RAM预算紧张，所以让我们限制Redis可以使用的内存。当需要释放内存时，我们还会告诉Redis删除最接近到期的密钥。将这些行添加到<code class="du lp lq lr ls b">/etc/redis/redis.conf</code>。</p><pre class="iy iz ja jb fd lw ls lx ly aw lz bi"><span id="32ec" class="ma jk hi ls b fi mb mc l md me">maxmemory 256mb<br/>maxmemory-policy volatile-ttl</span></pre><p id="a3e3" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">保存并重启Redis。</p><pre class="iy iz ja jb fd lw ls lx ly aw lz bi"><span id="bf21" class="ma jk hi ls b fi mb mc l md me">sudo service redis restart</span></pre><h2 id="25a7" class="ma jk hi bd jl mf mg mh jp mi mj mk jt ki ml mm jv kk mn mo jx km mp mq jz mr bi translated">配置Rspamd</h2><p id="3636" class="pw-post-body-paragraph la lb hi kd b ke kf ij ld kg kh im lf ki lt lh li kk lu lk ll km lv ln lo ko hb bi translated">Postfix通过<strong class="kd hj"><em class="kz">milter</em></strong>(<strong class="kd hj">m</strong>ail f<strong class="kd hj">filter</strong>)协议与Rspamd通信。由于我们在同一台机器上运行Postfix &amp; Rspamd，所以我们可以使用unix套接字更有效地在两者之间进行通信，所以在<code class="du lp lq lr ls b">/etc/rspamd/worker-proxy.inc</code>中添加下面一行。</p><pre class="iy iz ja jb fd lw ls lx ly aw lz bi"><span id="c19b" class="ma jk hi ls b fi mb mc l md me">bind_socket = "/var/spool/postfix/var/run/rspamd/milter.sock mode=0666 owner=_rspamd";</span></pre><p id="2305" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">我们还可以将<em class="kz">代理工作器</em>设置为<code class="du lp lq lr ls b">self_scan</code>模式，这允许我们禁用<em class="kz">普通工作器</em>，释放我们宝贵的资源。编辑同一个文件的<code class="du lp lq lr ls b">upstream</code>部分以启用<code class="du lp lq lr ls b">self_scan</code>。</p><pre class="iy iz ja jb fd lw ls lx ly aw lz bi"><span id="43e0" class="ma jk hi ls b fi mb mc l md me">upstream "local" {<br/>  default = yes;<br/>  hosts = "localhost";<br/>  self_scan = yes;<br/>}</span></pre><p id="1866" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">然后，给<code class="du lp lq lr ls b">/etc/rspamd/worker-normal.inc</code>加上下面一行。</p><pre class="iy iz ja jb fd lw ls lx ly aw lz bi"><span id="6905" class="ma jk hi ls b fi mb mc l md me">enabled = false;</span></pre><p id="36e8" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">我们需要创建套接字目录，并将所有权赋予<strong class="kd hj"> <em class="kz"> _rspamd </em> </strong>用户&amp; <strong class="kd hj"> <em class="kz">后缀</em> </strong>组。</p><pre class="iy iz ja jb fd lw ls lx ly aw lz bi"><span id="9091" class="ma jk hi ls b fi mb mc l md me">sudo mkdir -p /var/spool/postfix/var/run/rspamd/ &amp;&amp; sudo chown -R _rspamd:postfix /var/spool/postfix/var/run/rspamd/</span></pre><p id="4571" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">接下来，我们需要告诉我们的Rspamd bayes分类器使用Redis。我们将继续打开自动学习，这只是Rspamd将完成其工作的许多方式之一。要查看它过滤垃圾邮件的所有方式的列表，请阅读<a class="ae kt" href="https://rspamd.com/about.html" rel="noopener ugc nofollow" target="_blank"> this </a>。创建<code class="du lp lq lr ls b">/etc/rspamd/local.d/classifier-bayes.conf</code>并添加以下行:</p><pre class="iy iz ja jb fd lw ls lx ly aw lz bi"><span id="1589" class="ma jk hi ls b fi mb mc l md me">servers = "127.0.0.1";<br/>backend = "redis";<br/>autolearn = true;</span></pre><p id="dd53" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">我们还应该告诉Rspamd，一旦用户回复，就不要将主题中的电子邮件标记为垃圾邮件，因此创建<code class="du lp lq lr ls b">/etc/rspamd/local.d/replies.conf</code>并添加:</p><pre class="iy iz ja jb fd lw ls lx ly aw lz bi"><span id="85a2" class="ma jk hi ls b fi mb mc l md me">action = "no action";</span></pre><p id="9e1c" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">然后重新启动Rspamd。</p><pre class="iy iz ja jb fd lw ls lx ly aw lz bi"><span id="671c" class="ma jk hi ls b fi mb mc l md me">sudo service rspamd restart</span></pre><p id="0699" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">Rspamd现在可以检测垃圾邮件，并通过学习进行改进。如果你想从一开始就有所提升，你可以找一些电子邮件来训练。由于这不是必要的，我不会在这里讨论它。如果有兴趣的话，也许它值得一篇自己的后续文章。现在我们需要将我们的电子邮件软件连接到Rspamd。</p><h1 id="3b2e" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">将Postfix连接到Rspamd</h1><p id="dca2" class="pw-post-body-paragraph la lb hi kd b ke kf ij ld kg kh im lf ki lt lh li kk lu lk ll km lv ln lo ko hb bi translated">将下面几行添加到<code class="du lp lq lr ls b">/etc/postfix/main.cf</code>来连接两者。</p><pre class="iy iz ja jb fd lw ls lx ly aw lz bi"><span id="9a18" class="ma jk hi ls b fi mb mc l md me">smtpd_milters = unix:/var/run/rspamd/milter.sock<br/>milter_default_action = accept</span></pre><p id="5c05" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated"><code class="du lp lq lr ls b">milter_default_action</code>告诉Postfix在出现阻止到达Rspamd的问题时应该做什么。重新启动Postfix以应用更改。</p><pre class="iy iz ja jb fd lw ls lx ly aw lz bi"><span id="a355" class="ma jk hi ls b fi mb mc l md me">sudo service postfix restart</span></pre><p id="6976" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">Rspamd现在将扫描传入的消息。得分高的垃圾邮件将被拒绝，得分中等的垃圾邮件将以<code class="du lp lq lr ls b">X-Spam</code>标题发送。现在我们需要配置Dovecot，将带有此标题的邮件分类到垃圾文件夹中。</p><h1 id="73fc" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">使用筛子处理垃圾邮件</h1><p id="956a" class="pw-post-body-paragraph la lb hi kd b ke kf ij ld kg kh im lf ki lt lh li kk lu lk ll km lv ln lo ko hb bi translated">Sieve是一种用于过滤电子邮件的脚本语言。要使用它，我们首先需要安装<code class="du lp lq lr ls b">dovecot-sieve</code>插件。让我们也创建一个目录来存储我们的筛选脚本。</p><pre class="iy iz ja jb fd lw ls lx ly aw lz bi"><span id="8b49" class="ma jk hi ls b fi mb mc l md me">sudo apt install dovecot-sieve<br/>sudo mkdir /etc/dovecot/sieve/</span></pre><h2 id="2666" class="ma jk hi bd jl mf mg mh jp mi mj mk jt ki ml mm jv kk mn mo jx km mp mq jz mr bi translated">将垃圾邮件移至垃圾邮件文件夹</h2><p id="5e9e" class="pw-post-body-paragraph la lb hi kd b ke kf ij ld kg kh im lf ki lt lh li kk lu lk ll km lv ln lo ko hb bi translated">我们必须通过编辑<code class="du lp lq lr ls b">/etc/dovecot/conf.d/20-lmtp.conf</code>底部的<code class="du lp lq lr ls b">protocol lmtp</code>部分来告诉Dovecot使用这个插件。</p><pre class="iy iz ja jb fd lw ls lx ly aw lz bi"><span id="c63d" class="ma jk hi ls b fi mb mc l md me">protocol lmtp {<br/>  mail_plugins = $mail_plugins sieve<br/>}</span></pre><p id="7cae" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">接下来，我们需要编写一个简短的脚本，告诉Dovecot将包含<code class="du lp lq lr ls b">X-Spam</code>标题的电子邮件移动到垃圾文件夹中。创建<code class="du lp lq lr ls b">/etc/dovecot/sieve/move-spam-to-junk.sieve</code>并将下面的脚本复制到文件中。</p><pre class="iy iz ja jb fd lw ls lx ly aw lz bi"><span id="1f40" class="ma jk hi ls b fi mb mc l md me">require ["fileinto"];</span><span id="8a8c" class="ma jk hi ls b fi ms mc l md me">if header :is "X-Spam" "Yes" {<br/>        fileinto "Junk";<br/>}</span></pre><p id="3112" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">然后我们必须使用<code class="du lp lq lr ls b">sievec</code>工具编译这个脚本。</p><pre class="iy iz ja jb fd lw ls lx ly aw lz bi"><span id="292d" class="ma jk hi ls b fi mb mc l md me">sudo sievec /etc/dovecot/sieve/move-spam-to-junk.sieve</span></pre><p id="4f13" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">最后，打开<code class="du lp lq lr ls b">/etc/dovecot/conf.d/90-sieve.conf</code>并编辑以下行:</p><pre class="iy iz ja jb fd lw ls lx ly aw lz bi"><span id="d0f9" class="ma jk hi ls b fi mb mc l md me">sieve_after = /etc/dovecot/sieve/move-spam-to-junk.sieve</span></pre><p id="991e" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">这告诉Dovecot在运行任何用户定义的脚本之后运行<code class="du lp lq lr ls b">move-spam-to-junk</code>脚本。</p><h2 id="6dce" class="ma jk hi bd jl mf mg mh jp mi mj mk jt ki ml mm jv kk mn mo jx km mp mq jz mr bi translated">从用户操作中学习</h2><p id="2061" class="pw-post-body-paragraph la lb hi kd b ke kf ij ld kg kh im lf ki lt lh li kk lu lk ll km lv ln lo ko hb bi translated">当用户将邮件移入或移出垃圾文件夹时，我们可以训练Rspamd。为此，我们必须激活IMAP的Sieve插件。打开<code class="du lp lq lr ls b">/etc/dovecot/conf.d/20-imap.conf</code>并编辑文件末尾的<code class="du lp lq lr ls b">protocol imap</code>部分。</p><pre class="iy iz ja jb fd lw ls lx ly aw lz bi"><span id="1620" class="ma jk hi ls b fi mb mc l md me">protocol imap {<br/>  mail_plugins = $mail_plugins imap_sieve<br/>}</span></pre><p id="780d" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">现在，让我们编写报告垃圾邮件和火腿的筛选脚本。</p><p id="eaf8" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">创建<code class="du lp lq lr ls b">/etc/dovecot/sieve/report-spam.sieve</code>并复制以下脚本:</p><pre class="iy iz ja jb fd lw ls lx ly aw lz bi"><span id="1198" class="ma jk hi ls b fi mb mc l md me">require ["vnd.dovecot.pipe", "copy", "imapsieve"];<br/>pipe :copy "learn-spam.sh";</span></pre><p id="fc3a" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">然后用下面的脚本创建<code class="du lp lq lr ls b">/etc/dovecot/sieve/report-ham.sieve</code>:</p><pre class="iy iz ja jb fd lw ls lx ly aw lz bi"><span id="7325" class="ma jk hi ls b fi mb mc l md me">require ["vnd.dovecot.pipe", "copy", "imapsieve"];<br/>pipe :copy "learn-ham.sh";</span></pre><p id="92f4" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">这些脚本调用我们将要编写的shell脚本。shell脚本将依次调用Rspamd的<code class="du lp lq lr ls b">learn_spam</code>或<code class="du lp lq lr ls b">learn_ham</code>函数。让我们继续编译它们。</p><pre class="iy iz ja jb fd lw ls lx ly aw lz bi"><span id="e647" class="ma jk hi ls b fi mb mc l md me">sudo sievec /etc/dovecot/sieve/report-spam.sieve &amp;&amp; sudo sievec /etc/dovecot/sieve/report-ham.sieve</span></pre><p id="4c41" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">接下来，创建包含以下内容的<code class="du lp lq lr ls b">/etc/dovecot/sieve/learn-spam.sh</code>:</p><pre class="iy iz ja jb fd lw ls lx ly aw lz bi"><span id="9976" class="ma jk hi ls b fi mb mc l md me">#!/bin/sh<br/>exec /usr/bin/rspamc learn_spam</span></pre><p id="1bb3" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">然后，用下面几行创建<code class="du lp lq lr ls b">/etc/dovecot/sieve/learn-ham.sh</code>:</p><pre class="iy iz ja jb fd lw ls lx ly aw lz bi"><span id="1a07" class="ma jk hi ls b fi mb mc l md me">#!/bin/sh<br/>exec /usr/bin/rspamc learn_ham</span></pre><p id="debd" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">我们还需要使我们的shell脚本可执行。</p><pre class="iy iz ja jb fd lw ls lx ly aw lz bi"><span id="ae38" class="ma jk hi ls b fi mb mc l md me">sudo chmod u=rwx,go= /etc/dovecot/sieve/learn-{spam,ham}.sh</span></pre><p id="3719" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">现在再次打开<code class="du lp lq lr ls b">/etc/dovecot/conf.d/90-sieve.conf</code>并编辑下面一行来启用IMAP的Sieve插件。</p><pre class="iy iz ja jb fd lw ls lx ly aw lz bi"><span id="6fad" class="ma jk hi ls b fi mb mc l md me">sieve_plugins = sieve_imapsieve sieve_extprograms</span></pre><p id="af3b" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">然后，在同一文件的<code class="du lp lq lr ls b">plugin</code>部分中添加以下行。</p><pre class="iy iz ja jb fd lw ls lx ly aw lz bi"><span id="c8bf" class="ma jk hi ls b fi mb mc l md me"># Move to Junk folder<br/>imapsieve_mailbox1_name = Junk<br/>imapsieve_mailbox1_causes = COPY FLAG<br/>imapsieve_mailbox1_before = file:/etc/dovecot/sieve/report-spam.sieve</span><span id="d3dd" class="ma jk hi ls b fi ms mc l md me"># Move from Junk folder<br/>imapsieve_mailbox2_name = *<br/>imapsieve_mailbox2_from = Junk<br/>imapsieve_mailbox2_causes = COPY<br/>imapsieve_mailbox2_before = file:/etc/dovecot/sieve/report-ham.sieve</span><span id="939d" class="ma jk hi ls b fi ms mc l md me">sieve_pipe_bin_dir = /etc/dovecot/sieve<br/>sieve_global_extensions = +vnd.dovecot.pipe</span></pre><p id="510f" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">这些规则告诉Dovecot，当用户将邮件移入或移出垃圾文件夹时，应该运行哪些筛选脚本。<code class="du lp lq lr ls b">sieve_pipe_bin_dir</code>告诉Dovecot在哪里可以找到我们的shell脚本，我们的<code class="du lp lq lr ls b">sieve_global_extension</code>设置启用了<code class="du lp lq lr ls b">pipe</code>插件，使我们能够将电子邮件传递给外部命令。</p><p id="3ba0" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">最后，重启Dovecot来应用我们所有的更改。</p><pre class="iy iz ja jb fd lw ls lx ly aw lz bi"><span id="0a03" class="ma jk hi ls b fi mb mc l md me">sudo service dovecot restart</span></pre><p id="6d3b" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">就是这样！我们的服务器已经准备好处理垃圾邮件，并从用户交互中学习！</p><p id="1746" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">仅供参考，Rspamd有许多配置选项，超出了本文的范围。可以调整评分参数，配置训练等。您还可以通过编写Sieve脚本或使用Sieve manager客户端(如Roundcube的插件)来进一步配置邮件过滤。要了解更多信息，请从这里开始<a class="ae kt" href="http://sieve.info" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="4716" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">现在让我们来测试一下。</p><h1 id="5036" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">测试垃圾邮件过滤</h1><h2 id="f7e4" class="ma jk hi bd jl mf mg mh jp mi mj mk jt ki ml mm jv kk mn mo jx km mp mq jz mr bi translated">测试拒绝</h2><p id="15d8" class="pw-post-body-paragraph la lb hi kd b ke kf ij ld kg kh im lf ki lt lh li kk lu lk ll km lv ln lo ko hb bi translated">我们可以使用未经请求的批量电子邮件通用测试(GTUBE)模式来测试我们的垃圾邮件过滤。为此，只需向自己发送一封包含以下字符串的电子邮件(从另一个帐户发送):</p><pre class="iy iz ja jb fd lw ls lx ly aw lz bi"><span id="8876" class="ma jk hi ls b fi mb mc l md me"><em class="kz">XJS*C4JDBQADN1.NSBN3*2IDNEN*GTUBE-STANDARD-ANTI-UBE-TEST-EMAIL*C.34X</em></span></pre><p id="e2d9" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">您应该会收到以下电子邮件被阻止的发送状态通知。不错！</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mt"><img src="../Images/572801060357cd2a52d161fec0a2098d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u1Fu7TstsLca3zYhSxv81Q.png"/></div></div></figure><p id="c15e" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">我们可以通过启用额外的邮件头并检查它们来检查Rspamd是否正在扫描和记录所有进入我们邮箱的邮件。为此，用下面一行创建文件<code class="du lp lq lr ls b">/etc/rspamd/local.d/headers.conf</code>:</p><pre class="iy iz ja jb fd lw ls lx ly aw lz bi"><span id="80bc" class="ma jk hi ls b fi mb mc l md me">enable_test_patterns = true;</span></pre><p id="4aa6" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">然后重新启动Rspamd。</p><pre class="iy iz ja jb fd lw ls lx ly aw lz bi"><span id="3da6" class="ma jk hi ls b fi mb mc l md me">sudo service rspamd restart</span></pre><p id="0d94" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated"><strong class="kd hj">注意:</strong>我选择在我部署的服务器上关闭它，只留下用于分类的<code class="du lp lq lr ls b">X-Spam</code>头。但是，如果你选择让它开着，并没有什么负面影响。</p><p id="33b1" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">现在给自己发一封邮件。在Roundcube中，我们可以很容易地检查标题。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mu"><img src="../Images/2604b70860abe27b531c2b662281f7a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZDqgStUMQFAl9v6ZBsIpxg.png"/></div></div></figure><p id="b32f" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">如果我们点击<em class="kz">标题</em>，一个弹出窗口将显示所有的消息标题。我们可以向下滚动，找到由Rspamd添加的头。下面显示了可用信息的一小部分。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mv"><img src="../Images/7e772e030f651443b71e579497c1a570.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mdv1Q9CI3BoeLk9W5z2r-g.png"/></div></div></figure><p id="4ba0" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">如果你愿意，你也可以使用任何电子邮件客户端来查找邮件头。方法会有所不同，因此您可能希望在线搜索您的首选客户端的说明。如果邮件被确定为垃圾邮件，那么<code class="du lp lq lr ls b">X-Spam: Yes</code>标题将会被添加，我们的筛选脚本将会把邮件移动到我们的垃圾文件夹中。</p><h1 id="fe2d" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">结论</h1><p id="531e" class="pw-post-body-paragraph la lb hi kd b ke kf ij ld kg kh im lf ki lt lh li kk lu lk ll km lv ln lo ko hb bi translated">我们成功了！无论是字面上还是象征性的。这是一次漫长而乏味的旅程，希望是一次有趣的旅程！我们从一个梦想，也许是一个域名，到在云端托管我们自己的私人电子邮件服务器，始终可以可靠地访问我们的邮箱。为了让我们的成就更加甜美，我们可以让它免费运行！</p><p id="fd9a" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">随意向你的家人和朋友吹嘘你的成就。你应得的！但是你不想让他们嫉妒，所以跳上你的管理门户，给他们创建一个邮箱@你的域名。很简单！</p><p id="d765" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">让我们快速回顾一下我们是如何结束个人云电子邮件之旅的:</p><ul class=""><li id="2fa3" class="kb kc hi kd b ke lc kg le ki mw kk mx km my ko mz kq kr ks bi translated">我们安装了Rspamd，将其配置为使用Redis来存储数据和学习。</li><li id="1c10" class="kb kc hi kd b ke ku kg kv ki kw kk kx km ky ko mz kq kr ks bi translated">我们配置了Rspamd和Redis来限制资源的使用。</li><li id="3956" class="kb kc hi kd b ke ku kg kv ki kw kk kx km ky ko mz kq kr ks bi translated">我们将Postfix连接到Rspamd来扫描和分类收到的消息。</li><li id="d74a" class="kb kc hi kd b ke ku kg kv ki kw kk kx km ky ko mz kq kr ks bi translated">我们使用Sieve脚本配置Dovecot，将垃圾邮件移动到我们的垃圾文件夹中，并在我们将邮件移入和移出垃圾邮件时训练Rspamd。</li></ul><p id="c3b5" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">再次祝贺！我希望你在这个旅程中学到了一些很酷的东西，我真的希望你喜欢你的新个人电子邮件！</p><p id="2e2d" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">一如既往的感谢您的阅读！如果您发现这个系列或文章有帮助，请鼓掌并跟随。也欢迎评论！</p></div></div>    
</body>
</html>