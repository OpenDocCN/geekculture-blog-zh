<html>
<head>
<title>Creating a Stock Market Simulator for Twitch Chat Using NodeJS and AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用NodeJS和AWS为Twitch创建一个股票市场模拟器</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/creating-a-stock-market-simulator-for-twitch-chat-using-nodejs-and-aws-fcbae7ce9017?source=collection_archive---------14-----------------------#2021-03-07">https://medium.com/geekculture/creating-a-stock-market-simulator-for-twitch-chat-using-nodejs-and-aws-fcbae7ce9017?source=collection_archive---------14-----------------------#2021-03-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/8d7028c0d1b462aabbd900019d678dfa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_0VPfLyG9J5Rjh1a"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Photo by <a class="ae iu" href="https://unsplash.com/@m_b_m?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">M. B. M.</a> on <a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="84af" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最近对Twitch的痴迷导致了一系列与创建包含Twitch聊天的游戏和体验相关的想法。其中一个是股票市场模拟器，聊天者共享一个初始现金池账户，他们在聊天中输入买卖指令。收益、亏损、当前头寸和其他账户数据将被传输，这样聊天者就可以知道他们的交易表现如何。</p><p id="f0ee" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">对于这个项目，我使用NodeJS和AWS构建了一个Twitch聊天机器人来读取股票订单，一个后端服务来处理订单，以及一个前端UI来将帐户数据显示到浏览器，该浏览器可以传输到Twitch。我将逐一介绍这些组件，分享实现细节，并提供一些创建您自己的类似项目的演练。</p><h1 id="f9d6" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">先决条件</h1><ol class=""><li id="7c45" class="kr ks hi ix b iy kt jc ku jg kv jk kw jo kx js ky kz la lb bi translated">需要一个<a class="ae iu" href="https://www.twitch.tv/" rel="noopener ugc nofollow" target="_blank"> Twitch </a>帐户，以便您可以将帐户凭证传递到您的机器人中。</li><li id="0c04" class="kr ks hi ix b iy lc jc ld jg le jk lf jo lg js ky kz la lb bi translated">需要一个<a class="ae iu" href="https://aws.amazon.com/" rel="noopener ugc nofollow" target="_blank"> AWS </a>账户，因为我们将使用AWS SNS和DynamoDB。</li><li id="2933" class="kr ks hi ix b iy lc jc ld jg le jk lf jo lg js ky kz la lb bi translated">为了获得实时报价数据以便在后端服务中处理订单，我使用我的TD Ameritrade帐户向他们的<a class="ae iu" href="https://developer.tdameritrade.com/apis" rel="noopener ugc nofollow" target="_blank">实时报价数据API</a>发出授权请求。如果您没有经纪帐户，您可以创建一个开发者帐户并获得延迟数据。你也可以从其他各种途径获得报价数据，比如刮<a class="ae iu" href="https://finance.yahoo.com/" rel="noopener ugc nofollow" target="_blank">雅虎财经</a>。</li></ol><h1 id="6d5d" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">Twitch聊天机器人</h1><p id="ec6b" class="pw-post-body-paragraph iv iw hi ix b iy kt ja jb jc ku je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">对聊天机器人的要求很简单，它需要:</p><ol class=""><li id="99f1" class="kr ks hi ix b iy iz jc jd jg lk jk ll jo lm js ky kz la lb bi translated">实时阅读Twitch聊天</li><li id="2a93" class="kr ks hi ix b iy lc jc ld jg le jk lf jo lg js ky kz la lb bi translated">解析股票市场订单的聊天消息</li><li id="0ae8" class="kr ks hi ix b iy lc jc ld jg le jk lf jo lg js ky kz la lb bi translated">将订单发送到后端服务器进行处理</li></ol><p id="99a4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用Node的<a class="ae iu" href="https://github.com/tmijs/tmi.js" rel="noopener ugc nofollow" target="_blank"> tmi.js包</a>很容易创建Twitch聊天机器人。tmi.js包允许机器人为各种事件调用事件处理程序，比如在聊天中键入新消息时。</p><figure class="ln lo lp lq fd ij"><div class="bz dy l di"><div class="lr ls l"/></div></figure><p id="e700" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">主要的机器人驱动程序代码相当简单。使用您的Twitch帐户凭证创建一个客户端，我们定义一个<strong class="ix hj"> onMessageHandler </strong>函数，在市场开放时处理每条消息。使用正则表达式(例如“购买AAPL 10”)解析消息，以确定它们是否是订单。然后订单排队发布到AWS SNS主题。</p><p id="ea7f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要设置SNS主题，请转到AWS控制台并导航到简单通知服务。转到<strong class="ix hj">主题</strong>，然后<strong class="ix hj">创建主题</strong>。确保在创建主题屏幕上选择<strong class="ix hj">标准</strong>。我们需要标准，因为我们的后端服务将通过HTTP订阅SNS主题。</p><figure class="ln lo lp lq fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lt"><img src="../Images/3ea7f390a646fd93dbc4ab277d068fcc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nAMkTEAOwiFLJX-tyesWEg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">AWS SNS Topic Creation</figcaption></figure><p id="5bcd" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为您的主题选择任意名称，您可以将其余选项保留为默认名称。创建主题并转到左侧菜单上的<strong class="ix hj">主题</strong>。您应该能够看到您新创建的主题及其<strong class="ix hj"> ARN </strong>。将主题ARN复制到一个. env文件或环境变量中，以便机器人知道将订单发送到哪里。</p><p id="6ea4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">有了这个，我们应该有一个可以工作的机器人，它可以读取股票市场订单，并将它们发布到SNS主题，供其他服务使用。</p><p id="3ad0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://github.com/nramkissoon/Twitch-Stock-Order-Bot" rel="noopener ugc nofollow" target="_blank">这里是完整聊天机器人实现的GitHub库</a>。</p><h1 id="3f69" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">用于处理订单和更新帐户的后端服务</h1><p id="0949" class="pw-post-body-paragraph iv iw hi ix b iy kt ja jb jc ku je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">后端服务器是一个简单的Express服务器，每当来自SNS的新订单到来时，或者在设定的时间间隔后，处理订单并更新DynamoDB中的帐户数据，以尽可能保持数据最新。</p><p id="309e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">服务器有两个API端点:orders端点和account端点。</p><pre class="ln lo lp lq fd lu lv lw lx aw ly bi"><span id="33e7" class="lz ju hi lv b fi ma mb l mc md">POST<br/>/sns/orders</span><span id="c444" class="lz ju hi lv b fi me mb l mc md">GET<br/>/data/account</span></pre><p id="bfe6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">orders端点接受来自SNS主题的订单消息。为此，我们需要为我们的API端点订阅SNS主题。打开AWS控制台，转到您创建的SNS主题，然后创建订阅。</p><figure class="ln lo lp lq fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mf"><img src="../Images/61e9bccc1ba23f0cb169f3e0c4ab1e51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A30a4UiWl6MhoRxaxhVIhA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">AWS SNS Create Subscription Form</figcaption></figure><p id="833f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">请务必为您的SNS主题选择ARN主题，并选择HTTPS作为协议(因为我们为该主题订阅了一个web服务器)。如果您在本地主机上运行服务器，端点可能会比较棘手。我使用了<a class="ae iu" href="https://ngrok.com/" rel="noopener ugc nofollow" target="_blank"> ngrok </a>并添加了ngrok创建的URL作为端点。可以在EC2、DigitalOcean Droplets等上托管服务器。并且只需提供主机URL + /sns/orders。</p><p id="e7fa" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在订单API逻辑的Express router函数中，我们需要通过AWS SDK确认SNS订阅。这需要对SNS做出简单的响应来确认订阅。一旦AWS收到确认，SNS主题就可以开始向服务器发送订单消息。每当新的SNS通知被发送到端点时，我们从SNS中提取消息并将其解析为订单对象，然后将订单传递给包含核心帐户数据更新逻辑的<strong class="ix hj"> runUpdate </strong>函数。</p><figure class="ln lo lp lq fd ij"><div class="bz dy l di"><div class="lr ls l"/></div></figure><p id="8d2a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在我们开始研究runUpdate函数之前，我们需要设置DynamoDB表来读写帐户数据。使用AWS控制台设置DynamoDB表相对简单，所以我们将直接进入我们的应用程序需要哪些表。</p><p id="9627" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">需要三个表，在我的实现中，我创建了另一个表来读/写我的TD Ameritrade帐户的API凭证(如果您使用不同的报价数据源，这个表并不重要)。这些是必需的表格和每个表格的样本文档:</p><p id="748d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">账户值表</strong>:包含游戏百分比、市值等账户数据。带有时间戳排序键(每个DynamoDB文档都是给定时间点的帐户值的快照)</p><pre class="ln lo lp lq fd lu lv lw lx aw ly bi"><span id="45b1" class="lz ju hi lv b fi ma mb l mc md">{<br/>  "day_gain_percent": 0,<br/>  "day_gain_total": 0,<br/>  "key": "account_value",<br/>  "mkt_value": 100000,<br/>  "previous_day_mkt_value": 100000,<br/>  "timestamp": 1611071780713,<br/>  "total_gain_percent": 0,<br/>  "total_gain_total": 0<br/>}</span></pre><p id="ad2d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">持仓表</strong>:包含代表每个持仓的文件，用股票代号索引，每个文件都有最新的持仓值/盈亏、价格、数量等。</p><pre class="ln lo lp lq fd lu lv lw lx aw ly bi"><span id="d9ab" class="lz ju hi lv b fi ma mb l mc md">{<br/>  "asset_type": "Equity",<br/>  "average_cost_per_unit": 142.65,<br/>  "day_gain_percent": 0.1187,<br/>  "day_gain_total": 0.17,<br/>  "mkt_value": 2866.6,<br/>  "POSITION": "AAPL",<br/>  "price": 143.33,<br/>  "quantity": 20,<br/>  "total_gain_percent": 0.48,<br/>  "total_gain_total": 13.6<br/>}</span></pre><p id="c296" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">已处理订单表</strong>:包含服务器上给定更新的已处理订单，每个订单还包含与输入订单的Twitch用户相关的数据。</p><pre class="ln lo lp lq fd lu lv lw lx aw ly bi"><span id="4b26" class="lz ju hi lv b fi ma mb l mc md">{<br/>  "key": "processed_orders",<br/>  "processedOrders": [<br/>    {<br/>      "executed": true,<br/>      "orderValidationInfo": {<br/>        "isValid": true<br/>      },<br/>      "processedTimestamp": 1611671916539,<br/>      "userOrderData": {<br/>        "badges": {<br/>          "premium": "1"<br/>        },<br/>        "color": "#FF0000",<br/>        "display-name": "foo",<br/>        "id": "123",<br/>        "order": "!SELL NIO 110",<br/>        "tmi-sent-ts": "1611671926787",<br/>        "user-id": "1234",<br/>        "username": "foo"<br/>      }<br/>    }<br/>  ],<br/>  "timestamp": 1611671916605<br/>}</span></pre><p id="8e8c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> runUpdate </strong>函数利用所有这些表在设定的时间间隔后或每当通过AWS SNS收到新订单时更新账户和头寸。</p><figure class="ln lo lp lq fd ij"><div class="bz dy l di"><div class="lr ls l"/></div></figure><p id="61b3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">更新数据的步骤非常简单:</p><ol class=""><li id="8599" class="kr ks hi ix b iy iz jc jd jg lk jk ll jo lm js ky kz la lb bi translated">获取当前位置</li><li id="735d" class="kr ks hi ix b iy lc jc ld jg le jk lf jo lg js ky kz la lb bi translated">获取当前帐户值</li><li id="d94e" class="kr ks hi ix b iy lc jc ld jg le jk lf jo lg js ky kz la lb bi translated">获取两个位置和任何新订单的报价，然后使用一些数据提供商获取报价数据</li><li id="9a2b" class="kr ks hi ix b iy lc jc ld jg le jk lf jo lg js ky kz la lb bi translated">验证并执行订单</li><li id="4fd0" class="kr ks hi ix b iy lc jc ld jg le jk lf jo lg js ky kz la lb bi translated">更新职位</li><li id="1e9a" class="kr ks hi ix b iy lc jc ld jg le jk lf jo lg js ky kz la lb bi translated">将新的头寸和账户数据写入DynamoDB表</li></ol><p id="5d28" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了深入了解订单验证逻辑、对DynamoDB的读写以及更新逻辑，<a class="ae iu" href="https://github.com/nramkissoon/TP_stonks_OrderProcessing" rel="noopener ugc nofollow" target="_blank">这里是完整后端服务器</a>的GitHub存储库。</p><h1 id="67ec" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">显示账户数据和头寸的前端</h1><p id="65ba" class="pw-post-body-paragraph iv iw hi ix b iy kt ja jb jc ku je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">目标是将模拟账户以近乎实时的方式直播到Twitch。浏览器可以流，所以前端用户界面将是一个简单的网页。为此，我使用<a class="ae iu" href="https://reactjs.org/" rel="noopener ugc nofollow" target="_blank"> React </a>和<a class="ae iu" href="https://material-ui.com/" rel="noopener ugc nofollow" target="_blank"> Material-UI组件库</a>构建了一个带有不同面板的仪表板，显示不同类型的数据。</p><p id="4fd8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">实施了五个面板组件:</p><ol class=""><li id="fbf3" class="kr ks hi ix b iy iz jc jd jg lk jk ll jo lm js ky kz la lb bi translated">全天账户价值图</li><li id="7518" class="kr ks hi ix b iy lc jc ld jg le jk lf jo lg js ky kz la lb bi translated">当前账户价值和每日/总收益</li><li id="1b79" class="kr ks hi ix b iy lc jc ld jg le jk lf jo lg js ky kz la lb bi translated">包含当前头寸和单个收益、数量等的表格。</li><li id="68ed" class="kr ks hi ix b iy lc jc ld jg le jk lf jo lg js ky kz la lb bi translated">Twitch用户可以输入有效股票市场订单格式的面板</li><li id="c582" class="kr ks hi ix b iy lc jc ld jg le jk lf jo lg js ky kz la lb bi translated">订单事件的提要，显示每个用户输入了什么订单以及订单是否被执行</li></ol><p id="08bf" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">关于UI面板的一些其他注意事项:图表是使用<a class="ae iu" href="https://github.com/reactchartjs/react-chartjs-2" rel="noopener ugc nofollow" target="_blank"> react-chart-js-2 </a>开发的，并且整个UI按照设定的时间间隔更新。</p><p id="cdf4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">前端通过在后端定期从前面提到的账户数据API获取账户数据，从后端服务器接收新数据。新的帐户数据被传递到适当的组件状态/属性中，以更新整个UI。</p><p id="a4cc" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这里是前端的GitHub库。</p><p id="0b68" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下面是用户界面的最终外观(账户赤字很大……)。</p><figure class="ln lo lp lq fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mg"><img src="../Images/1b5cde61d3b089e230b874ff65600b95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DvmjvFBKltIWQC_9-XyCzg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">UI for displaying data to Twitch</figcaption></figure><h1 id="858b" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">把所有的放在一起</h1><p id="7c98" class="pw-post-body-paragraph iv iw hi ix b iy kt ja jb jc ku je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">通过在bot、后端和前端节点项目中运行<strong class="ix hj"> npm run start(或dev) </strong>，并使我们的AWS资源可用，项目应该正在运行。剩下的就是在网络浏览器上打开前端UI，流式传输到Twitch！</p><p id="af86" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">对于中级程序员或有抱负的软件工程师来说，这种规模的项目在设计方面教会了很多东西。这是一个真正的全栈项目，有明确的需求和最终产品。包含SNS和DynamoDB等AWS服务是一个额外的好处，可以让您在JavaScript中使用AWS和AWS SDK。</p><p id="5fb6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当然，可以添加新功能，如期权交易(真正的股票市场乐趣所在)和Twitch用户订阅或关注的事件。例如，一个很酷的想法是，每次有新用户加入时，在账户中加入更多的模拟现金。Twitch API包括<a class="ae iu" href="https://dev.twitch.tv/docs/api/webhooks-reference" rel="noopener ugc nofollow" target="_blank"> webhooks </a>就是为了这个目的！完全脱离股票交易，可以使用聊天机器人/后端/前端架构开发带有Twitch聊天的交互式游戏的新思路。这里的可能性是无限的。</p></div></div>    
</body>
</html>