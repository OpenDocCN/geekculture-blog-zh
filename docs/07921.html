<html>
<head>
<title>Backend Design— Software Pattern For Authentication &amp; Authorization</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">后端设计—用于身份验证和授权的软件模式</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/backend-design-software-pattern-for-authentication-authorization-ed86bbd17c9?source=collection_archive---------7-----------------------#2021-10-06">https://medium.com/geekculture/backend-design-software-pattern-for-authentication-authorization-ed86bbd17c9?source=collection_archive---------7-----------------------#2021-10-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="f4e5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这篇文章将分享我的一些真实世界的审查经验，以及什么样的软件模式适合于authn/authz检查逻辑。</p></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><h1 id="c33f" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">认证和授权</h1><p id="3958" class="pw-post-body-paragraph if ig hi ih b ii ki ik il im kj io ip iq kk is it iu kl iw ix iy km ja jb jc hb bi translated">在实现后端服务时，身份验证和授权扮演着非常重要的角色。</p><p id="f7d6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在讨论今天的主要话题之前，我们先试着回答下面这个问题。</p><blockquote class="kn ko kp"><p id="83cf" class="if ig kq ih b ii ij ik il im in io ip kr ir is it ks iv iw ix kt iz ja jb jc hb bi translated">认证和授权有什么区别？</p></blockquote><h2 id="e0b1" class="ku jl hi bd jm kv kw kx jq ky kz la ju iq lb lc jy iu ld le kc iy lf lg kg lh bi translated">认证</h2><blockquote class="kn ko kp"><p id="a947" class="if ig kq ih b ii ij ik il im in io ip kr ir is it ks iv iw ix kt iz ja jb jc hb bi translated">一种可以检查你是否是你的机制。</p></blockquote><p id="e6b1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如，当您尝试登录到Medium时，您将向服务器提供用户名和密码组合。用户名/密码是一个非常简单的认证机制来证明你的身份。</p><h2 id="2264" class="ku jl hi bd jm kv kw kx jq ky kz la ju iq lb lc jy iu ld le kc iy lf lg kg lh bi translated">授权</h2><blockquote class="kn ko kp"><p id="e058" class="if ig kq ih b ii ij ik il im in io ip kr ir is it ks iv iw ix kt iz ja jb jc hb bi translated">一种检查您是否可以访问特定操作或资源的机制。</p></blockquote><p id="5351" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们继续以Medium为例。</p><p id="6e52" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您已经登录了Medium，您正在尝试删除我的Medium帖子。如果中型服务器允许此操作，这可能会很快成为一个非常严重的安全问题。</p><p id="f0ca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">幸运的是，Medium中的开发人员理解授权的概念，服务器会试图阻止此操作，因为您不允许执行此操作。</p><p id="8beb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">好了，我们对认证和授权有了基本的了解。让我们继续今天的话题<strong class="ih hj">authz/authn逻辑的软件模式</strong>。</p></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><h1 id="a6a9" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">以1为例—简单的实现</h1><p id="bd94" class="pw-post-body-paragraph if ig hi ih b ii ki ik il im kj io ip iq kk is it iu kl iw ix iy km ja jb jc hb bi translated">现在我们知道authn &amp; authz有多重要，并尝试在我们的服务中实现相关的检查逻辑。</p><p id="8e6e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第一种方法是在控制器中编写检查逻辑。</p><p id="53fd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们以actix-web view.rs为例。</p><figure class="li lj lk ll fd lm"><div class="bz dy l di"><div class="ln lo l"/></div></figure><p id="efaa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">代码将授权检查逻辑集成到现有服务中，非常简单，</p><ol class=""><li id="395e" class="lp lq hi ih b ii ij im in iq lr iu ls iy lt jc lu lv lw lx bi translated">从cookie头获取令牌</li><li id="e749" class="lp lq hi ih b ii ly im lz iq ma iu mb iy mc jc lu lv lw lx bi translated">检查并验证JWT令牌，并获取用户id和角色</li><li id="188c" class="lp lq hi ih b ii ly im lz iq ma iu mb iy mc jc lu lv lw lx bi translated">检查令牌是否在黑名单令牌中</li><li id="904f" class="lp lq hi ih b ii ly im lz iq ma iu mb iy mc jc lu lv lw lx bi translated">检查角色是否为管理员</li><li id="ba6e" class="lp lq hi ih b ii ly im lz iq ma iu mb iy mc jc lu lv lw lx bi translated">否则，我们返回401未授权</li></ol><p id="3f68" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面的方法肯定能做它应该做的事情，但是一些问题会带来将来的可维护性问题。</p></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><h1 id="8c5a" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">第二步——意大利面条式代码和松散耦合</h1><p id="cc59" class="pw-post-body-paragraph if ig hi ih b ii ki ik il im kj io ip iq kk is it iu kl iw ix iy km ja jb jc hb bi translated">作为一个有经验的软件工程师，人们可以很快发现以前的方法有一个设计缺陷:<a class="ae md" href="https://en.wikipedia.org/wiki/Copy-and-paste_programming#:~:text=Copy%2Dand%2Dpaste%20programming%2C,a%20lack%20of%20programming%20competence." rel="noopener ugc nofollow" target="_blank">复制&amp;粘贴编程模式</a>和<a class="ae md" href="https://en.wikipedia.org/wiki/Spaghetti_code" rel="noopener ugc nofollow" target="_blank">意大利面代码</a>。</p><h2 id="618f" class="ku jl hi bd jm kv kw kx jq ky kz la ju iq lb lc jy iu ld le kc iy lf lg kg lh bi translated">意大利面条代码</h2><blockquote class="kn ko kp"><p id="4df1" class="if ig kq ih b ii ij ik il im in io ip kr ir is it ks iv iw ix kt iz ja jb jc hb bi translated">意大利面条式代码是一个贬义词，指的是无结构和难以维护的源代码。<br/>来自<a class="ae md" href="https://en.wikipedia.org/wiki/Spaghetti_code" rel="noopener ugc nofollow" target="_blank">维基百科</a></p></blockquote><figure class="li lj lk ll fd lm er es paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="er es me"><img src="../Images/348d04d6e5252819a2e6ddf0fb40e453.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XBcJwNLkvMiC5Vik"/></div></div><figcaption class="ml mm et er es mn mo bd b be z dx">Image from <a class="ae md" href="https://unsplash.com/photos/1ixfp1DDRA4" rel="noopener ugc nofollow" target="_blank">https://unsplash.com/photos/1ixfp1DDRA4</a></figcaption></figure><p id="a469" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">图像，您必须添加一个新的API端点，并进行适当的身份验证检查，我们必须将上述代码复制/粘贴到另一个API端点中。</p><p id="8194" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">过了一段时间，我们发现原来的auth检查逻辑有一些缺陷，需要修改，负责这项任务的开发人员可能需要修改多个地方。</p><p id="704a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">几个月或几年后，API端点的数量成千上万，代码将很快变得不可维护，未来的维护者别无选择，只能重构整个代码。</p><p id="d3a3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面例子的一个快速总结</p><p id="df16" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> (1)控制器业务逻辑和授权检查逻辑耦合在一起</strong></p><p id="b17b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> (2)同样的逻辑被复制粘贴到许多地方，因而不容易解决那个逻辑块的问题</strong></p><h2 id="5417" class="ku jl hi bd jm kv kw kx jq ky kz la ju iq lb lc jy iu ld le kc iy lf lg kg lh bi translated">松耦合</h2><blockquote class="kn ko kp"><p id="6c86" class="if ig kq ih b ii ij ik il im in io ip kr ir is it ks iv iw ix kt iz ja jb jc hb bi translated">组件之间的关联很弱(具有易断关系)，因此，一个组件的变化对另一个组件的存在或性能的影响最小。</p><p id="7247" class="if ig kq ih b ii ij ik il im in io ip kr ir is it ks iv iw ix kt iz ja jb jc hb bi translated">来自<a class="ae md" href="https://en.wikipedia.org/wiki/Loose_coupling" rel="noopener ugc nofollow" target="_blank">维基百科</a></p></blockquote><p id="b0a3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了使逻辑更清晰和更好，可以<strong class="ih hj">将授权检查逻辑分离到一个单独的函数</strong>中，并将其放入类似于我在<a class="ae md" rel="noopener" href="/geekculture/backend-design-actix-web-project-hierarchy-7fc229bd830c">上一篇文章中提到的app:utils模块中。</a></p><p id="20fc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一个更好的解决方案是应用<a class="ae md" href="https://en.wikipedia.org/wiki/Decorator_pattern" rel="noopener ugc nofollow" target="_blank">装饰模式</a>用auth decorator装饰原始控制器函数。</p><h2 id="0728" class="ku jl hi bd jm kv kw kx jq ky kz la ju iq lb lc jy iu ld le kc iy lf lg kg lh bi translated">请求提取器</h2><p id="2def" class="pw-post-body-paragraph if ig hi ih b ii ki ik il im kj io ip iq kk is it iu kl iw ix iy km ja jb jc hb bi translated">一个更加actix-web友好的解决方案是利用<a class="ae md" href="https://actix.rs/docs/extractors/" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">请求提取器</strong> </a> <strong class="ih hj">。</strong></p><p id="9e04" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">可以实现一个struct，该struct实现了FromRequest 特征，并从该特征执行验证检查逻辑。</p><p id="6fb3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">actix-web身份插件是展示这种模式的一个很好的例子。</p><p id="c353" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">控制器实现可以使用类似下面的代码片段来执行验证检查逻辑。</p><figure class="li lj lk ll fd lm"><div class="bz dy l di"><div class="ln lo l"/></div></figure></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><h1 id="423f" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">第三步—在设计中采用安全最佳实践</h1><p id="b867" class="pw-post-body-paragraph if ig hi ih b ii ki ik il im kj io ip iq kk is it iu kl iw ix iy km ja jb jc hb bi translated">从软件工程师的角度来看，请求提取器方法实际上相当不错，但是从安全工程师的角度来看，这可能还不够。</p><h2 id="8c65" class="ku jl hi bd jm kv kw kx jq ky kz la ju iq lb lc jy iu ld le kc iy lf lg kg lh bi translated">安全反模式—默认允许</h2><p id="afdf" class="pw-post-body-paragraph if ig hi ih b ii ki ik il im kj io ip iq kk is it iu kl iw ix iy km ja jb jc hb bi translated">请求提取器方法要求开发者<strong class="ih hj">显式地修饰控制器函数，否则控制器将是一个未授权的端点</strong>。</p><p id="23e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这种做法被称为<strong class="ih hj">默认允许</strong>。</p><blockquote class="kn ko kp"><p id="a6b2" class="if ig kq ih b ii ij ik il im in io ip kr ir is it ks iv iw ix kt iz ja jb jc hb bi translated">默认允许假设任何人都可以访问每个端点，除非有人明确禁止。</p></blockquote><p id="51f4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在utopia中，每个软件开发者都有意识去写一个合适的验证逻辑；然而，至关重要的现实却恰恰相反。</p><p id="8a8d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不是每个软件工程师都有安全意识。此外，即使他们已经意识到这个话题，人类也容易犯错误。</p><h2 id="81c9" class="ku jl hi bd jm kv kw kx jq ky kz la ju iq lb lc jy iu ld le kc iy lf lg kg lh bi translated">安全最佳实践—默认拒绝</h2><p id="4de5" class="pw-post-body-paragraph if ig hi ih b ii ki ik il im kj io ip iq kk is it iu kl iw ix iy km ja jb jc hb bi translated">因此，从我的安全审查经验来看，使用<a class="ae md" href="https://securosis.com/blog/network-security-fundamentals-default-deny" rel="noopener ugc nofollow" target="_blank">默认拒绝</a>策略总是更好。</p><blockquote class="kn ko kp"><p id="4d66" class="if ig kq ih b ii ij ik il im in io ip kr ir is it ks iv iw ix kt iz ja jb jc hb bi translated">默认拒绝假设每个端点都需要auth，除非有人明确允许。</p></blockquote><figure class="li lj lk ll fd lm er es paragraph-image"><div class="er es mp"><img src="../Images/200e9c44da002d8e0f110883c055ab87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1282/format:webp/0*4ARHGPhh1UwOnwxT.jpg"/></div></figure><p id="7856" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，我们的目标是找到一种模式，在默认情况下对每个端点强制进行身份验证检查，以防止上述可能的错误。</p><h2 id="9c14" class="ku jl hi bd jm kv kw kx jq ky kz la ju iq lb lc jy iu ld le kc iy lf lg kg lh bi translated">中间件模式</h2><p id="d146" class="pw-post-body-paragraph if ig hi ih b ii ki ik il im kj io ip iq kk is it iu kl iw ix iy km ja jb jc hb bi translated">对我来说，我认为中间件非常适合这种情况。</p><p id="aa22" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">中间件是一个软件层，当后端服务器接收到任何请求时将调用它，此外，中间件将在控制器逻辑之前被调用。我们可以将我们的授权检查逻辑放入中间件，因此所有的端点都将被迫运行检查机制。</p><p id="2afb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">令人欣慰的是，actix-web提供了一种非常简单的方式将中间件集成到整个服务实现中。</p><p id="39eb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面的代码片段展示了中间件模式的思想。代码片段将在处理剩余的业务逻辑之前执行authn_authz_check。</p><figure class="li lj lk ll fd lm"><div class="bz dy l di"><div class="ln lo l"/></div></figure><p id="24af" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在authn_authz_check中，我们需要做的是维护一个表，明确定义哪个端点根本不需要auth。</p></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><h1 id="0b3d" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">最后的话</h1><p id="5ce3" class="pw-post-body-paragraph if ig hi ih b ii ki ik il im kj io ip iq kk is it iu kl iw ix iy km ja jb jc hb bi translated">在这篇文章中，我根据我的安全代码审查经验，简要描述了一些用于authn/authz检查的软件模式。</p><p id="36e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们快速总结一些关键话题，</p><p id="fea0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">松耦合</strong></p><p id="6267" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">授权检查逻辑应该与业务逻辑高度分离，以避免复制粘贴编程和意大利面条式代码，从而提高未来的可维护性。</p><p id="6056" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">默认拒绝优于默认允许</strong></p><p id="16ba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">人类容易犯错误，并且不是所有的软件工程师都将auth n/authz作为设计考虑因素。<br/>因此，使用默认的拒绝策略而不是默认的允许来进一步减少未来的安全顾虑。</p><h2 id="fc16" class="ku jl hi bd jm kv kw kx jq ky kz la ju iq lb lc jy iu ld le kc iy lf lg kg lh bi translated">未来主题</h2><p id="d8c1" class="pw-post-body-paragraph if ig hi ih b ii ki ik il im kj io ip iq kk is it iu kl iw ix iy km ja jb jc hb bi translated">我只讨论单片后端实现的软件设计模式。我没有详细讨论如何实现认证和授权。</p><p id="8bd3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此外，上述软件模式可能只适合于整体服务实现，而不适合于现代web服务基础设施设计。</p><p id="76a3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这些将是我未来帖子的一些很好的主题，所以请继续关注。</p></div></div>    
</body>
</html>