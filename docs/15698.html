<html>
<head>
<title>Helm — Chart Hooks and Test</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">舵-海图钩和测试</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/helm-chart-hooks-and-test-c914ee439341?source=collection_archive---------3-----------------------#2022-11-15">https://medium.com/geekculture/helm-chart-hooks-and-test-c914ee439341?source=collection_archive---------3-----------------------#2022-11-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="3eb3" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">舵钩配置和舵释放测试</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/1769d1a284d9342cb40a4355c88a0d78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GbjgmpkORgDyrH8u"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Photo by <a class="ae jn" href="https://unsplash.com/@aridley88?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Andrew Ridley</a> on <a class="ae jn" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="1a1b" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">上一篇:</strong> <a class="ae jn" rel="noopener" href="/gitconnected/helm-data-sharing-between-parent-and-child-chart-c4487a452d4e"> <strong class="jq hj">赫尔姆—父子图表间的数据共享</strong> </a></p><p id="ba2d" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">Helm为我们提供了一个图表机制，允许我们在一个版本的生命周期中的某些点进行干预。例如，我们可以使用钩子来:</p><p id="e53e" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">●在安装过程中确定任务的优先顺序。例如，在加载图表的任何其他组件之前加载配置映射或秘密。</p><p id="8921" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">●在安装/升级新图表或在升级后恢复数据库之前，备份数据库。</p><p id="09ae" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">钩子文件看起来类似于帮助我们生成kubernetes清单的模板文件。除了一些特殊的注释。假设我们想在进行任何其他安装之前加载一个kubernetes ConfigMap。带有挂钩的模板将如下所示:</p><pre class="iy iz ja jb fd kk kl km kn aw ko bi"><span id="d43b" class="kp kq hi kl b fi kr ks l kt ku"># mychart/template/hookConfigMap.yaml</span><span id="54fe" class="kp kq hi kl b fi kv ks l kt ku">apiVersion: v1<br/>kind: ConfigMap<br/>metadata:<br/>  creationTimestamp: null<br/>  name: test<br/>  labels:<br/>    app: webserver<br/>    app.kubernetes.io/managed-by: Helm<br/><strong class="kl hj">  annotations: <br/>   "helm.sh/hook": pre-install<br/>   "helm.sh/hook-weight": "5"<br/>   "helm.sh/hook-delete-policy": before-hook-creation</strong><br/>data:<br/>  name: nginx</span></pre><p id="ba4c" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在上面的演示中，定义了一些<strong class="jq hj">注释</strong>。这些注释用于配置舵钩。</p><p id="43c9" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">让我们在接下来的部分中讨论每个注释的作用:</p><h2 id="01c2" class="kp kq hi bd kw kx ky kz la lb lc ld le jx lf lg lh kb li lj lk kf ll lm ln lo bi translated">helm.sh/hook</h2><p id="1778" class="pw-post-body-paragraph jo jp hi jq b jr lp ij jt ju lq im jw jx lr jz ka kb ls kd ke kf lt kh ki kj hb bi translated"><code class="du lu lv lw kl b"><strong class="jq hj">helm.sh/hook</strong></code>注释定义了钩子。在上面的演示中，我们使用了<code class="du lu lv lw kl b"><strong class="jq hj">pre-install</strong></code> <strong class="jq hj"> </strong>钩子，这意味着ConfigMap将在其他安装发生之前加载。</p><p id="22df" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">有多种挂钩可供选择:</p><pre class="iy iz ja jb fd kk kl km kn aw ko bi"><span id="506d" class="kp kq hi kl b fi kr ks l kt ku"><strong class="kl hj">pre-install </strong></span><span id="3003" class="kp kq hi kl b fi kv ks l kt ku"><strong class="kl hj">post-install </strong></span><span id="e079" class="kp kq hi kl b fi kv ks l kt ku"><strong class="kl hj">pre-delete </strong></span><span id="1290" class="kp kq hi kl b fi kv ks l kt ku"><strong class="kl hj">post-delete</strong></span><span id="0566" class="kp kq hi kl b fi kv ks l kt ku"><strong class="kl hj">pre-upgrade</strong></span><span id="483f" class="kp kq hi kl b fi kv ks l kt ku"><strong class="kl hj">post-upgrade </strong></span><span id="cc31" class="kp kq hi kl b fi kv ks l kt ku"><strong class="kl hj">pre-rollback </strong></span><span id="6816" class="kp kq hi kl b fi kv ks l kt ku"><strong class="kl hj">post-rollback</strong></span><span id="f81d" class="kp kq hi kl b fi kv ks l kt ku"><strong class="kl hj">test</strong></span></pre><p id="e4c4" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">上面定义的钩子实际上描述了它的作用。欲了解更多详情，请阅读helm官方文档中的本部分<a class="ae jn" href="https://helm.sh/docs/topics/charts_hooks/#the-available-hooks" rel="noopener ugc nofollow" target="_blank"><strong class="jq hj"/></a>。在所有钩子中，我们将在最后部分讨论<strong class="jq hj">【测试】</strong>钩子。</p><p id="bdff" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">如果需要，我们也可以将多个挂钩结合使用:</p><pre class="iy iz ja jb fd kk kl km kn aw ko bi"><span id="4360" class="kp kq hi kl b fi kr ks l kt ku">annotations: <br/>   "helm.sh/hook":<strong class="kl hj"> pre-install, pre-delete, post-rollback</strong></span></pre><h2 id="14b1" class="kp kq hi bd kw kx ky kz la lb lc ld le jx lf lg lh kb li lj lk kf ll lm ln lo bi translated"><strong class="ak">helm.sh/hook-weight</strong></h2><p id="77bf" class="pw-post-body-paragraph jo jp hi jq b jr lp ij jt ju lq im jw jx lr jz ka kb ls kd ke kf lt kh ki kj hb bi translated">可以为一个钩子定义一个权重，这将有助于建立一个确定的执行顺序。使用以下注释定义权重:</p><pre class="iy iz ja jb fd kk kl km kn aw ko bi"><span id="e598" class="kp kq hi kl b fi kr ks l kt ku"><strong class="kl hj">annotations</strong>:<br/>  <strong class="kl hj">"helm.sh/hook-weight": </strong>"5"</span></pre><p id="6263" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">吊钩重量可以是正数或负数，但必须用字符串</strong>表示。当Helm启动一个特定类型钩子的执行周期时，它会将这些钩子按升序排序。</p><p id="120a" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">假设我们有两个指定了“预安装”挂钩的不同模板。它们中的每一个都配置有不同的“<strong class="jq hj">钩重”。</strong></p><pre class="iy iz ja jb fd kk kl km kn aw ko bi"><span id="6ed8" class="kp kq hi kl b fi kr ks l kt ku"># templates/hooks1.yaml</span><span id="6a1c" class="kp kq hi kl b fi kv ks l kt ku">annotations:<br/>  <!-- -->"helm.sh/hook": <strong class="kl hj">pre-install</strong><br/>  <!-- -->"helm.sh/hook-weight": <strong class="kl hj">"-1"</strong></span><span id="63bb" class="kp kq hi kl b fi kv ks l kt ku"><br/>---<br/># templates/hooks2.yaml</span><span id="7d96" class="kp kq hi kl b fi kv ks l kt ku">annotations:<br/>  <!-- -->"helm.sh/hook": <strong class="kl hj">pre-install</strong><br/>  <!-- -->"helm.sh/hook-weight":<strong class="kl hj"> "-5"</strong></span></pre><p id="47c4" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在上面的演示中，带'- <strong class="jq hj"> 5' </strong>的吊钩重量将首先执行，因为舵将按升序对所有吊钩进行排序。</p><h2 id="6a30" class="kp kq hi bd kw kx ky kz la lb lc ld le jx lf lg lh kb li lj lk kf ll lm ln lo bi translated"><strong class="ak">helm.sh/hook-delete-policy</strong></h2><p id="fe55" class="pw-post-body-paragraph jo jp hi jq b jr lp ij jt ju lq im jw jx lr jz ka kb ls kd ke kf lt kh ki kj hb bi translated">有三种类型的删除策略。</p><blockquote class="lx ly lz"><p id="e9f2" class="jo jp ma jq b jr js ij jt ju jv im jw mb jy jz ka mc kc kd ke md kg kh ki kj hb bi translated"><code class="du lu lv lw kl b"><strong class="jq hj">before-hook-creation</strong> </code> <em class="hi"> —在一个新的挂钩启动之前删除以前的资源(默认)。<br/> </em> <code class="du lu lv lw kl b"><strong class="jq hj">hook-succeeded </strong></code> <em class="hi"> —钩子执行成功后删除资源。<br/> </em> <code class="du lu lv lw kl b"><strong class="jq hj"><em class="hi">hook-failed</em></strong></code> <em class="hi"> —如果钩子执行失败，删除资源。</em></p></blockquote></div><div class="ab cl me mf gp mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="hb hc hd he hf"><h2 id="4f39" class="kp kq hi bd kw kx ky kz la lb lc ld le jx lf lg lh kb li lj lk kf ll lm ln lo bi translated">舵试验</h2><p id="c460" class="pw-post-body-paragraph jo jp hi jq b jr lp ij jt ju lq im jw jx lr jz ka kb ls kd ke kf lt kh ki kj hb bi translated">有一种舵钩叫“测试”。使用“test”钩子，我们可以测试我们的发布。舵测试命令将释放作为输入。因此，为了测试我们的图表，我们必须事先安装图表。然后我们可以运行<strong class="jq hj"> helm test </strong>命令来测试我们的发布。</p><p id="056b" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">所有的测试文件都位于<strong class="jq hj">“图表名/模板/测试”</strong>目录下。让我们看一个测试模板文件:</p><pre class="iy iz ja jb fd kk kl km kn aw ko bi"><span id="d579" class="kp kq hi kl b fi kr ks l kt ku"><strong class="kl hj"># chartName/templates/tests/test-connection.yaml</strong></span><span id="9c5d" class="kp kq hi kl b fi kv ks l kt ku">apiVersion: v1<br/>kind: Pod<br/>metadata:<br/>  name: "{{ include "webserver.fullname" . }}-test-connection"<br/>  labels:<br/>    {{- include "webserver.labels" . | nindent 4 }}<br/><strong class="kl hj">  annotations:<br/>    "helm.sh/hook": test</strong><br/>spec:<br/>  containers:<br/>    - name: wget<br/>      image: busybox<br/>      command: ['wget']<br/>      args: ['{{ include "webserver.fullname" . }}:{{ .Values.service.port }}']<br/>  restartPolicy: Never</span></pre><p id="e835" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在上面的演示中，我们可以看到定义了一个" t <strong class="jq hj"> est" </strong>类型的钩子。尽管它是一个pod，但它不会在图表的安装阶段安装。只有当我们使用<strong class="jq hj">舵测试</strong>命令触发它时，它才会被安装。此pod将测试pod和上述模板文件中指定的特定服务之间的连接。还有其他一些用例，例如，在部署数据库时，我们可以检查数据库密码设置是否正确。</p><p id="8470" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">上面的测试模板文件来自nginx图表。让我们安装它，看看会发生什么:</p><pre class="iy iz ja jb fd kk kl km kn aw ko bi"><span id="a7b8" class="kp kq hi kl b fi kr ks l kt ku"><strong class="kl hj">&gt;&gt;</strong>  helm install webserver webserver/</span></pre><p id="6b86" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在我们将使用<strong class="jq hj">舵测试</strong>命令测试我们的发布:</p><pre class="iy iz ja jb fd kk kl km kn aw ko bi"><span id="4d2e" class="kp kq hi kl b fi kr ks l kt ku">   helm test <strong class="kl hj">[ RELEASE ]</strong><br/>&gt;&gt; helm test  webserver</span><span id="486a" class="kp kq hi kl b fi kv ks l kt ku">--------------------------------------------------------------------<br/><strong class="kl hj">NAME: webserver</strong><br/>LAST DEPLOYED: Mon Oct 31 07:29:44 2022<br/>NAMESPACE: default<br/>STATUS: deployed<br/>REVISION: 1<br/>TEST SUITE:     webserver-test-connection<br/>Last Started:   Mon Oct 31 07:30:08 2022<br/>Last Completed: Mon Oct 31 07:30:15 2022<br/><strong class="kl hj">Phase:          Succeeded</strong></span></pre><p id="0ee9" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在上面的演示中，我们可以看到我们的测试成功了。为了进行测试，部署了一个名为“<strong class="jq hj">web server-test-connection</strong>”的pod。并且处于<strong class="jq hj">完成</strong>状态。</p><pre class="iy iz ja jb fd kk kl km kn aw ko bi"><span id="f4c3" class="kp kq hi kl b fi kr ks l kt ku"><strong class="kl hj">&gt;&gt;</strong> kubectl get pods </span><span id="e83b" class="kp kq hi kl b fi kv ks l kt ku">NAME                         READY   STATUS      RESTARTS<br/>webserver-test-connection    0/1    <strong class="kl hj"> Completed  </strong> 0              </span></pre><p id="c3de" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在，重要的是要注意。如果我们卸载我们的版本，除了为测试部署的pod(<strong class="jq hj">web server-test-connection</strong>)之外，所有与该版本相关的资源都将被删除。要在测试成功后删除相应的测试pod，我们可以在测试模板文件中添加另一个注释<code class="du lu lv lw kl b"><strong class="jq hj">helm.sh/hook-delete-policy: hook-succeeded</strong></code> <strong class="jq hj"> </strong>。</p></div><div class="ab cl me mf gp mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="hb hc hd he hf"><blockquote class="lx ly lz"><p id="6d9d" class="jo jp ma jq b jr js ij jt ju jv im jw mb jy jz ka mc kc kd ke md kg kh ki kj hb bi translated"><em class="hi">如果你觉得这篇文章很有帮助，请不要忘记</em><strong class="jq hj"><em class="hi"/></strong><em class="hi">去点击</em> <strong class="jq hj"> <em class="hi">跟随</em> </strong> <em class="hi">👉</em> <strong class="jq hj"> <em class="hi"> </em> </strong> <em class="hi">和</em> <strong class="jq hj"> <em class="hi">拍手</em> </strong> <em class="hi">👏</em> <strong class="jq hj"> <em class="hi"> </em> </strong> <em class="hi">按钮帮助我写更多这样的文章。<br/>谢谢🖤 </em></p></blockquote></div><div class="ab cl me mf gp mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="hb hc hd he hf"><h2 id="ad13" class="kp kq hi bd kw kx ky kz la lb lc ld le jx lf lg lh kb li lj lk kf ll lm ln lo bi translated"><em class="ml">👉</em>所有关于头盔的文章—</h2><div class="mm mn ez fb mo"><div role="button" tabindex="0" class="ab bv ff cb dy mp mq bn mr jh ms"><div class="mt l"><div class="ab q"><div class="l di"><img alt="Md Shamim" class="l de bw mu mv du" src="../Images/b46bdc53005abde6c6cb3e8ff0c200c3.png" width="20" height="20" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:40:40/1*Hqd8Xz1WHsoL1s2To3awnA.png"/><div class="dr bw l mu mv ds n aw dt"/></div><div class="gg l dw"><p class="bd b fp z dy dz ea eb ec ed ee ef dx translated"><a class="ae af ag ah ai aj ak al am an ao ap aq ar as" rel="noopener follow" target="_top" href="/@shamimice03?source=post_page-----c914ee439341--------------------------------"> Md沙米姆</a></p></div></div><div class="my mz fg l"><h2 class="bd hj sl sm dy sn ea eb so ed ef hh bi translated">HelmーSeries</h2></div><div class="ab q"><div class="l dw"><a class="bd b be z bi sp au sq sr ss po st an fx fy su sv sw gb gc gd de bk ge" rel="noopener follow" target="_top" href="/@shamimice03/list/helmseries-6e2076d48ba8?source=post_page-----c914ee439341--------------------------------">View list</a></div><div class="sx l dw"><span class="bd b fp z dx">11 stories</span></div></div></div><div class="nl dh nm dy ab nn dw di"><div class="di nd bv ne nf"><div class="dh l"><img alt="" class="dh" src="../Images/9ba5df61339b6f5d2ad01696050835e3.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*3NGLzkzV47jeWMX8"/></div></div><div class="di nd bv ng nh ni"><div class="dh l"><img alt="" class="dh" src="../Images/74e4f8812ce0aceba2616e176b3021c2.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*wzqjRqAlMOjlwt7x"/></div></div><div class="di bv nj nk ni"><div class="dh l"><img alt="" class="dh" src="../Images/a734d6746ba78eda4d8d1347c4231bae.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*6RKJMoeEspoXyjGN"/></div></div></div></div></div></div></div>    
</body>
</html>