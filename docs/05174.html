<html>
<head>
<title>Angular optimisation: Load content below the fold</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">角度优化:加载折叠下方的内容</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/angular-optimisation-load-content-below-the-fold-8ef87559c867?source=collection_archive---------8-----------------------#2021-07-13">https://medium.com/geekculture/angular-optimisation-load-content-below-the-fold-8ef87559c867?source=collection_archive---------8-----------------------#2021-07-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="d2cf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在页面滚动上加载组件</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/d73de89fdf9c45081bbba2d514b08bc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*BeRrri7nOFnl0BYW0vwh_A.png"/></div></figure></div><div class="ab cl jl jm gp jn" role="separator"><span class="jo bw bk jp jq jr"/><span class="jo bw bk jp jq jr"/><span class="jo bw bk jp jq"/></div><div class="hb hc hd he hf"><p id="ca82" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了减少页面的加载时间，一个好的规则是只加载折叠线以上的内容，只有当用户滚动页面时才加载折叠线以下的内容。</p><p id="7283" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为此，我们将侦听“窗口”上的“滚动”事件，并在页面上标记一个元素，一旦该元素可见，将触发“到达位置”事件。注意,“滚动”事件将在角度之外<strong class="ih hj">被监听，以避免大量和不必要的变化检测周期。<br/>此时，我们可以加载更多的内容，比如在“ng-dynamic-component”库和服务的帮助下加载一个模块的组件。</strong></p><p id="b0b1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们创建一个名为“tagReached”的指令</p><pre class="je jf jg jh fd js jt ju jv aw jw bi"><span id="a45b" class="jx jy hi jt b fi jz ka l kb kc"><strong class="jt hj">tagReached.directive.ts</strong></span><span id="4910" class="jx jy hi jt b fi kd ka l kb kc">import {<br/>    AfterViewInit,<br/>    ContentChild,<br/>    Directive,<br/>    ElementRef,<br/>    EventEmitter,<br/>    NgZone,<br/>    OnDestroy,<br/>    OnInit,<br/>    Output<br/>} from '<a class="ae ke" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';<br/>import {Subscription} from 'rxjs';<br/>import {debounceTime} from 'rxjs/operators';</span><span id="ee5d" class="jx jy hi jt b fi kd ka l kb kc">import {CommonService} from '../common.service';</span><span id="a87a" class="jx jy hi jt b fi kd ka l kb kc"><a class="ae ke" href="http://twitter.com/Directive" rel="noopener ugc nofollow" target="_blank">@Directive</a>({<br/>    selector: '[tagReached]'<br/>})<br/>export class TagReachedDirective implements OnInit, AfterViewInit, OnDestroy {<br/>$windowSize: Subscription;<br/>documentHeight;<br/>breakpointOffsetTop;<br/>_scrollEventBind;<br/> reachedEmitted = false;</span><span id="d885" class="jx jy hi jt b fi kd ka l kb kc"><a class="ae ke" href="http://twitter.com/ContentChild" rel="noopener ugc nofollow" target="_blank">@ContentChild</a>('breakpointTag', { static: false, read: ElementRef }) breakpointTag: ElementRef;<br/><a class="ae ke" href="http://twitter.com/Output" rel="noopener ugc nofollow" target="_blank">@Output</a>() reached: EventEmitter&lt;boolean&gt; = new EventEmitter&lt;boolean&gt;();</span><span id="276b" class="jx jy hi jt b fi kd ka l kb kc">constructor(private ngZone: NgZone, private commonService: CommonService) { }</span><span id="4ff3" class="jx jy hi jt b fi kd ka l kb kc">ngOnInit() {<br/>        <strong class="jt hj">// Run only in client side</strong><br/>        if (!this.commonService.isBrowser())<br/>            return;<br/>        this._scrollEventBind = this.handler.bind(this);<br/>        this.commonService.addListenerToWindowScroll(this._scrollEventBind);<br/>    }</span><span id="4bb6" class="jx jy hi jt b fi kd ka l kb kc">ngAfterViewInit() {<br/>        // Run only in client side<br/>        if (!this.commonService.isBrowser())<br/>            return;</span><span id="489e" class="jx jy hi jt b fi kd ka l kb kc">        <strong class="jt hj">// Delay the init function to avoid the access to DOM for perform better first load</strong><br/>        if ('requestIdleCallback' in window) {<br/>            // <a class="ae ke" href="http://twitter.com/ts" rel="noopener ugc nofollow" target="_blank">@ts</a>-ignore<br/>            window.requestIdleCallback(() =&gt; this._init());<br/>        } else<br/>        // For Internet Explorer<br/>            this._init();</span><span id="f822" class="jx jy hi jt b fi kd ka l kb kc">// Recalculate if browser window changes the dimensions<br/>        this.$windowSize = this.commonService.$windowSize.pipe(debounceTime(50)).subscribe(() =&gt; {<br/>            this.initOffsets();<br/>        });<br/>    }</span><span id="c9d0" class="jx jy hi jt b fi kd ka l kb kc">_init() {<br/>  this.initOffsets();</span><span id="8683" class="jx jy hi jt b fi kd ka l kb kc">  if (this.checkBreakpoint(window.scrollY)) {<br/>        this.reachedEmitted = true;<br/>        this.reached.next(true);<br/>      }<br/>  }</span><span id="5750" class="jx jy hi jt b fi kd ka l kb kc">initOffsets() {<br/>  this.documentHeight = this.commonService.getHeight();</span><span id="bdc0" class="jx jy hi jt b fi kd ka l kb kc">  if (this.breakpointTag) {<br/>      this.breakpointOffsetTop =        this.findPos(this.breakpointTag.nativeElement)[1];<br/>     }<br/> }</span><span id="28d9" class="jx jy hi jt b fi kd ka l kb kc">handler (event) {<br/>  const scrollY = event.currentTarget.pageYOffset;</span><span id="12f8" class="jx jy hi jt b fi kd ka l kb kc">  if (!this.reachedEmitted) {</span><span id="4932" class="jx jy hi jt b fi kd ka l kb kc">  // Tag reached!<br/>     if (this.checkBreakpoint(scrollY)) {<br/>         this.reachedEmitted = true;</span><span id="6cf5" class="jx jy hi jt b fi kd ka l kb kc"><strong class="jt hj">// Necessary due scroll event is captured outside angular change detection</strong><br/>         this.ngZone.run(() =&gt; {<br/>              this.reached.next(true);<br/>            });<br/>         }<br/>        }<br/>    }</span><span id="49d6" class="jx jy hi jt b fi kd ka l kb kc">checkBreakpoint(scrollTop) {<br/>        return scrollTop &gt; this.breakpointOffsetTop - this.documentHeight;<br/>    }</span><span id="a62e" class="jx jy hi jt b fi kd ka l kb kc">findPos(obj) {<br/>        let curleft = 0;<br/>        let curtop = 0;<br/>        if (obj.offsetParent) {<br/>            do {<br/>                curleft += obj.offsetLeft;<br/>                curtop += obj.offsetTop;<br/>            } while (obj = obj.offsetParent);<br/>        }<br/>        return [curleft, curtop];<br/>    }</span><span id="7a2d" class="jx jy hi jt b fi kd ka l kb kc">ngOnDestroy() {<br/> if (!this.commonService.isBrowser())<br/>            return;</span><span id="dfea" class="jx jy hi jt b fi kd ka l kb kc">this.commonService.removeListenerToWindowScroll(this._scrollEventBind);<br/> this.$windowSize.unsubscribe();<br/> }<br/>}</span></pre><p id="b579" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们创建一个公共服务，您可以在其中管理滚动事件的添加/删除以及浏览器窗口的当前大小</p><pre class="je jf jg jh fd js jt ju jv aw jw bi"><span id="f20f" class="jx jy hi jt b fi jz ka l kb kc"><strong class="jt hj">common.service.ts</strong></span><span id="6a2a" class="jx jy hi jt b fi kd ka l kb kc">import {Injectable, Inject, PLATFORM_ID, NgZone} from '<a class="ae ke" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';<br/>import {isPlatformBrowser} from '<a class="ae ke" href="http://twitter.com/angular/common" rel="noopener ugc nofollow" target="_blank">@angular/common</a>';<br/>import {Subject} from 'rxjs';</span><span id="fd6f" class="jx jy hi jt b fi kd ka l kb kc"><a class="ae ke" href="http://twitter.com/Injectable" rel="noopener ugc nofollow" target="_blank">@Injectable</a>()<br/>export class CommonService {<br/>  private currentWidth = 0;<br/>  private currentHeight = 0;</span><span id="af3a" class="jx jy hi jt b fi kd ka l kb kc">private isBrowserPlatform: boolean;</span><span id="80c0" class="jx jy hi jt b fi kd ka l kb kc">public $windowSize = new Subject&lt;Object&gt;();</span><span id="ba3a" class="jx jy hi jt b fi kd ka l kb kc">passiveSupported = false;<br/>passiveSupportedTested = false;<br/>private eventOptions: boolean | {capture?: boolean, passive?: boolean};</span><span id="b691" class="jx jy hi jt b fi kd ka l kb kc">scrollCallbacks = []; // Holds all window scroll callbacks for disable they when needed</span><span id="dec1" class="jx jy hi jt b fi kd ka l kb kc">constructor(<a class="ae ke" href="http://twitter.com/Inject" rel="noopener ugc nofollow" target="_blank">@Inject</a>(PLATFORM_ID) platformId: Object, private ngZone: NgZone) {<br/>    this.isBrowserPlatform = isPlatformBrowser(platformId);<br/>  }</span><span id="87f8" class="jx jy hi jt b fi kd ka l kb kc">isBrowser(): boolean {<br/>    return this.isBrowserPlatform;<br/>  }</span><span id="e0b4" class="jx jy hi jt b fi kd ka l kb kc">getWidth() {<br/>    return this.currentWidth;<br/>  }</span><span id="c975" class="jx jy hi jt b fi kd ka l kb kc">getHeight() {<br/>    return this.currentHeight;<br/>  }</span><span id="f124" class="jx jy hi jt b fi kd ka l kb kc">setDeviceDimensions(width, height) {<br/>    this.currentWidth = width;<br/>    this.currentHeight = height;<br/>  }</span><span id="7441" class="jx jy hi jt b fi kd ka l kb kc">addListenerToWindowScroll(callback) {<br/>    if (!this.isBrowser())<br/>      return;<br/>    if (!this.passiveSupportedTested) {<br/>      this.passiveSupportedTested = true;</span><span id="ef47" class="jx jy hi jt b fi kd ka l kb kc">       try {<br/>        window.addEventListener('test', null,<br/>          Object.defineProperty({}, 'passive',<br/>            {<br/>              get: function () {<br/>                this.passiveSupported = true;<br/>              }<br/>            }));</span><span id="3eef" class="jx jy hi jt b fi kd ka l kb kc">       } catch (err) {}<br/>    }<br/>    if (this.passiveSupported) {<br/>      this.eventOptions = {<br/>        capture: true,<br/>        passive: true<br/>      };<br/>    } else {<br/>      this.eventOptions = true;<br/>    }</span><span id="a578" class="jx jy hi jt b fi kd ka l kb kc"><strong class="jt hj">// Necessary for avoid a change detection on each scroll event</strong><br/>    this.ngZone.runOutsideAngular(() =&gt; {<br/>      this.scrollCallbacks.push(callback);<br/>      window.addEventListener('scroll', callback, &lt;any&gt;this.eventOptions);<br/>    });<br/>  }</span><span id="2a35" class="jx jy hi jt b fi kd ka l kb kc">removeListenerToWindowScroll(handler) {<br/>    for (let i = 0; i &lt; this.scrollCallbacks.length; i++)<br/>      if (handler === this.scrollCallbacks[i]) {<br/>        this.scrollCallbacks.splice(i, 1);<br/>        break;<br/>      }<br/>    window.removeEventListener('scroll', handler, &lt;any&gt;this.eventOptions);<br/>  }<br/>}</span></pre><p id="4796" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们创建一个加载模块组件的服务</p><pre class="je jf jg jh fd js jt ju jv aw jw bi"><span id="0435" class="jx jy hi jt b fi jz ka l kb kc"><strong class="jt hj">loadLazyModule.service.ts</strong></span><span id="a219" class="jx jy hi jt b fi kd ka l kb kc">import {Compiler, Injectable, NgModuleFactory} from "<a class="ae ke" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>";</span><span id="6a08" class="jx jy hi jt b fi kd ka l kb kc"><a class="ae ke" href="http://twitter.com/Injectable" rel="noopener ugc nofollow" target="_blank">@Injectable</a>({providedIn: 'root'})<br/>export class LoadLazyModuleService {<br/>    myModuleComponents;</span><span id="51c9" class="jx jy hi jt b fi kd ka l kb kc">constructor(private compiler: Compiler) {<br/>    }</span><span id="b754" class="jx jy hi jt b fi kd ka l kb kc">load() {<br/>        return Promise.all([import('./my.module')])<br/>            .then(m =&gt; m[0].MyModule)<br/>            .then((modalModule) =&gt; {<br/>                this.myModuleComponents = modalModule.components;<br/>                if (modalModule instanceof NgModuleFactory) {<br/>                    return modalModule;<br/>                } else {<br/>                    return this.compiler.compileModuleAsync(modalModule);<br/>                }<br/>            })<br/>            .then(factory =&gt; {<br/>                return {components: this.myModuleComponents};<br/>            });<br/>    }<br/>}</span></pre><p id="e9ca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们创建一个模块，它包含一个我们想要在页面上显示的组件</p><pre class="je jf jg jh fd js jt ju jv aw jw bi"><span id="d81e" class="jx jy hi jt b fi jz ka l kb kc"><strong class="jt hj">my.module.ts</strong></span><span id="0753" class="jx jy hi jt b fi kd ka l kb kc">import {NgModule} from "<a class="ae ke" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>";<br/>import {LazyComponent} from "./lazy.component";</span><span id="ef4e" class="jx jy hi jt b fi kd ka l kb kc"><a class="ae ke" href="http://twitter.com/NgModule" rel="noopener ugc nofollow" target="_blank">@NgModule</a>({<br/>    declarations: [LazyComponent]<br/>})<br/>export class MyModule {<br/>    static components = {lazyComponent: LazyComponent};<br/>}</span></pre><p id="987d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们创建懒惰组件</p><pre class="je jf jg jh fd js jt ju jv aw jw bi"><span id="1c3b" class="jx jy hi jt b fi jz ka l kb kc"><strong class="jt hj">lazy.component.ts</strong></span><span id="843f" class="jx jy hi jt b fi kd ka l kb kc">import {Component} from "<a class="ae ke" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>";</span><span id="382d" class="jx jy hi jt b fi kd ka l kb kc"><a class="ae ke" href="http://twitter.com/Component" rel="noopener ugc nofollow" target="_blank">@Component</a>({<br/>    selector: 'app-lazy',<br/>    template: `&lt;div style="color: red"&gt;LAZY COMPONENT&lt;/div&gt;`<br/>})</span><span id="aba5" class="jx jy hi jt b fi kd ka l kb kc">export class LazyComponent {}</span></pre><p id="f4e8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在页面上使用指令</p><pre class="je jf jg jh fd js jt ju jv aw jw bi"><span id="1b71" class="jx jy hi jt b fi jz ka l kb kc"><strong class="jt hj">app.component.html</strong></span><span id="8ac9" class="jx jy hi jt b fi kd ka l kb kc">&lt;div tagReached (reached)="belowTagReached($event)"&gt;<br/>    &lt;div style="height: 800px; text-align: center; border: 3px solid blue;"&gt;<br/>        &lt;br&gt;<br/>        ABOVE<br/>        &lt;br&gt;<br/>        THE<br/>        &lt;br&gt;<br/>        FOLD<br/>        &lt;br&gt;<br/>        CONTENT<br/>    &lt;/div&gt;</span><span id="c3a2" class="jx jy hi jt b fi kd ka l kb kc">&lt;div <strong class="jt hj">#breakpointTag</strong>&gt;<br/>        &lt;div style="text-align: center; border: 3px solid yellow;"&gt;<br/>            BELOW<br/>            &lt;br&gt;<br/>            THE<br/>            &lt;br&gt;<br/>            FOLD<br/>            &lt;br&gt;<br/>            CONTENT<br/>            &lt;br&gt;<br/>            <strong class="jt hj">&lt;ng-template [ngComponentOutlet]="lazyComponent"&gt;&lt;/ng-template&gt;</strong><br/>        &lt;/div&gt;<br/>    &lt;/div&gt;<br/>&lt;/div&gt;</span></pre><p id="24b9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们在组件中捕获事件，并为浏览器大小更改事件添加一个侦听器</p><pre class="je jf jg jh fd js jt ju jv aw jw bi"><span id="c170" class="jx jy hi jt b fi jz ka l kb kc"><strong class="jt hj">app.component.ts</strong></span><span id="0d27" class="jx jy hi jt b fi kd ka l kb kc">import {Component, HostListener, NgZone, OnDestroy, Type} from '<a class="ae ke" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';</span><span id="9455" class="jx jy hi jt b fi kd ka l kb kc">import {CommonService} from '../common.service';<br/>import {LoadLazyModuleService} from "./loadLazyModule.service";<br/>import {LazyComponent} from "./lazy.component";</span><span id="b59a" class="jx jy hi jt b fi kd ka l kb kc"><a class="ae ke" href="http://twitter.com/Component" rel="noopener ugc nofollow" target="_blank">@Component</a>({<br/>  selector: 'app-root',<br/>  templateUrl: './app.component.html',<br/>  styleUrls: ['./app.component.scss']<br/>})<br/>export class AppComponent implements OnDestroy {</span><span id="4520" class="jx jy hi jt b fi kd ka l kb kc">// Window resize listener<br/>  <a class="ae ke" href="http://twitter.com/HostListener" rel="noopener ugc nofollow" target="_blank">@HostListener</a>('window:resize', ['$event'])<br/>  onResize(event) {<br/>    const widthChanged = this.commonService.getWidth() !== event.target.innerWidth;<br/>    const heightChanged = this.commonService.getHeight() !== event.target.innerHeight;</span><span id="22d5" class="jx jy hi jt b fi kd ka l kb kc">this.commonService.setDeviceDimensions(event.target.innerWidth, event.target.innerHeight);<br/>    this.commonService.$windowSize.next({width: event.target.innerWidth, height: event.target.innerHeight,<br/>      widthChanged, heightChanged});<br/>  }</span><span id="a555" class="jx jy hi jt b fi kd ka l kb kc">lazyContent = false;<br/>lazyComponent: Type&lt;LazyComponent&gt;;<br/>destroyed = false;</span><span id="0952" class="jx jy hi jt b fi kd ka l kb kc">constructor(private commonService: CommonService,<br/>              private ngZone: NgZone, private loadLazyModule: LoadLazyModuleService) {</span><span id="3465" class="jx jy hi jt b fi kd ka l kb kc">// Set the first window size<br/>    if (commonService.isBrowser()) {<br/>      this.commonService.setDeviceDimensions(window.innerWidth, window.innerHeight);<br/>      this.commonService.$windowSize.next({width: window.innerWidth, height: window.innerHeight});<br/>    } else<br/>      // Force to be a smartphone (Moto G4) when SSR<br/>      this.commonService.setDeviceDimensions(360, 640);<br/>  }</span><span id="1a1c" class="jx jy hi jt b fi kd ka l kb kc"><strong class="jt hj">belowTagReached</strong>(event) {<br/>    if (event &amp;&amp; !this.lazyContent) {<br/>      this.ngZone.run(() =&gt; {<br/>        console.log('reached');<br/>        this.lazyContent = true;<br/>        this.loadLazyModule.load().then((module) =&gt; {<br/>          if (!this.destroyed)<br/>            this.lazyComponent = module.components.lazyComponent;<br/>        });<br/>     });<br/>    }<br/>  }</span><span id="2aeb" class="jx jy hi jt b fi kd ka l kb kc">ngOnDestroy(): void {<br/>    this.destroyed = true;<br/>  }<br/>}</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es kf"><img src="../Images/384385ca5eb621a734adff2aee9e8dfa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*443IYH9GEN7Cv0YjqZjzvQ.gif"/></div></div><figcaption class="kk kl et er es km kn bd b be z dx">Lazy component loaded when “below the fold” was reached</figcaption></figure><p id="41c1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这种技术对于获取各种基准的分数也非常有用，比如Lighthouse和其他，因此可以提高SEO排名。</p></div></div>    
</body>
</html>