<html>
<head>
<title>Using Stripe with custom validation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用带自定义验证的条带</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/using-stripe-with-custom-validation-e838e1413ca9?source=collection_archive---------12-----------------------#2022-01-11">https://medium.com/geekculture/using-stripe-with-custom-validation-e838e1413ca9?source=collection_archive---------12-----------------------#2022-01-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="30e5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">付款前后</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/2cd9993b78954df5bf2892a383a1c744.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*P6O9f2l0cNzXUIXJ"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Photo by <a class="ae jt" href="https://unsplash.com/@pickawood?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Pickawood</a> on <a class="ae jt" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="85b3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最近，我刚刚推出了我的第一个小图标库，<a class="ae jt" href="https://www.craftglyphs.com" rel="noopener ugc nofollow" target="_blank"> Craft:Glyphs </a>，并集成Stripe作为支付网关。也许这是过度考虑，但我想确保该电子邮件帐户还没有注册之前，它去结帐。</p><p id="9703" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以我的流程是这样的:检查电子邮件是否存在&gt;使用表单中预填的电子邮件进行结帐&gt;如果支付成功，使用电子邮件创建帐户。</p><p id="c376" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要在结账时预填电子邮件，我不能使用“支付链接”方法，必须做一些编码，我将在本文中描述。</p><h1 id="80d0" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">步骤0:从条带中获取必要的项目</h1><p id="f0bc" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated"><strong class="ih hj">0a)Stripe SDK</strong>:Stripe的<a class="ae jt" href="https://stripe.com/docs/development/quickstart" rel="noopener ugc nofollow" target="_blank">文档</a>列出了各种语言的信息(向下滚动到“2安装Stripe库”)。我用的是PHP，在PHP标签下显示我们可以通过composer或者直接从Github获得PHP SDK。我的是从Github得到的。</p><p id="c72c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">秘密API密匙:我们可以通过<strong class="ih hj">开发者&gt; API密匙</strong>获得。在<strong class="ih hj">标准密钥</strong>下，点击<strong class="ih hj">显示</strong>获取<strong class="ih hj">密钥</strong>。请注意，<strong class="ih hj">秘密密钥</strong>只能在<strong class="ih hj">服务器端</strong>使用，不得公开可见。看起来是这样的:</p><pre class="je jf jg jh fd kx ky kz la aw lb bi"><span id="05c7" class="lc jv hi ky b fi ld le l lf lg">$stripe_key = 'sk_test_xxxxxxxxxxxxxxxxxxxx........';</span></pre><h1 id="76fb" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">步骤1:创建产品(和价格)</h1><p id="830e" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">在主菜单栏上，点击<strong class="ih hj">产品</strong>，然后点击<strong class="ih hj">添加产品</strong>。输入<strong class="ih hj">名称</strong>、<strong class="ih hj">描述</strong>(可选)和<strong class="ih hj">图像</strong>(可选)。</p><p id="59d3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">输入<strong class="ih hj">价格信息</strong>，并根据需要创建额外的价格信息。</p><p id="82ee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">点击<strong class="ih hj">保存产品</strong>。</p><h1 id="9345" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">步骤2:记下价格ID</h1><p id="db99" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">从<strong class="ih hj">产品</strong>产品&gt;产品<strong class="ih hj">概述</strong>页面，点击新创建的产品。向下滚动到<strong class="ih hj">定价</strong>，注意我们将要集成的<strong class="ih hj"> API ID </strong>。它们看起来像这样:</p><pre class="je jf jg jh fd kx ky kz la aw lb bi"><span id="7a0f" class="lc jv hi ky b fi ld le l lf lg">$price_id = 'price_xxxxxxxxxxx';</span></pre><h1 id="ae8b" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">步骤3:生成支付链接</h1><p id="c39c" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">正如我前面提到的，在进入结帐屏幕之前，我还有一个额外的步骤。因为这不在本文的讨论范围内，所以我在这里将它写成伪代码:</p><pre class="je jf jg jh fd kx ky kz la aw lb bi"><span id="b04c" class="lc jv hi ky b fi ld le l lf lg">if (email_is_okay($email)){<br/>   // go to stripe<br/>}</span></pre><p id="38da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个if中，我们使用SDK来创建支付链接。总的来说，代码如下所示:</p><pre class="je jf jg jh fd kx ky kz la aw lb bi"><span id="2d17" class="lc jv hi ky b fi ld le l lf lg">require '[path_to_stripe_sdk]/init.php';</span><span id="2595" class="lc jv hi ky b fi lh le l lf lg">if (email_is_okay($email)){</span><span id="1698" class="lc jv hi ky b fi lh le l lf lg">   $stripe = new \Stripe\StripeClient($stripe_key); // from step 0</span><span id="96cc" class="lc jv hi ky b fi lh le l lf lg">   try{<br/>      $session = $stripe-&gt;checkout-&gt;sessions-&gt;create([<br/>         'success_url' =&gt; 'success.php',<br/>         'cancel_url' =&gt; 'cancel.php',<br/>         'line_items' =&gt; [<br/>            ['price' =&gt; $price_id, // the price id from step 2<br/>            'quantity' =&gt; 1,<br/>            'adjustable_quantity' =&gt; [ //optional<br/>               'enabled' =&gt; true,<br/>               'minimum' =&gt; 1,<br/>               'maximum' =&gt; 99,],<br/>            ],<br/>         ],<br/>         'customer_email' =&gt; $email, //our user email<br/>         'mode' =&gt; 'payment',<br/>         'allow_promotion_codes' =&gt; true, //optional<br/>      ]);</span><span id="d174" class="lc jv hi ky b fi lh le l lf lg">      $url = $session-&gt;url;<br/>      // $url is the payment link, we can return this result<br/>   }<br/>   catch(\Stripe\Exception\CardException $e) {<br/>   } catch (\Stripe\Exception\RateLimitException $e) {<br/>   } catch (\Stripe\Exception\InvalidRequestException $e) {<br/>   } catch (\Stripe\Exception\AuthenticationException $e) {<br/>   } catch (\Stripe\Exception\ApiConnectionException $e) {<br/>   } catch (\Stripe\Exception\ApiErrorException $e) {<br/>   } catch (Exception $e) {}</span><span id="4542" class="lc jv hi ky b fi lh le l lf lg">}<br/>else{<br/>   // return message that $email cannot be used<br/>}</span></pre><p id="8bc4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">需要注意两件事:</p><p id="c742" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 3a) success_url和cancel_url </strong>:这些是用户在结帐屏幕后将被转发到的url。它不同于条带webhook，因为它不包含有效负载。然而，我们可以添加一些参数，比如“success.php？param=123 '来处理内部逻辑，如有必要。</p><p id="3e09" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 3b)$session- &gt; url: </strong>这是创建的“支付链接”的url。我用这个将我的用户转到带有预填电子邮件地址的结帐屏幕。</p><h1 id="92d8" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">第四步:处理回电</h1><p id="213e" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">如前所述，success_url可用于处理支付成功后的逻辑，但它不携带来自Stripe的有效载荷。如果我们想要存储像payment_intent或receipt url这样的参考信息，webhook回调是必要的。</p><h2 id="1df4" class="lc jv hi bd jw li lj lk ka ll lm ln ke iq lo lp ki iu lq lr km iy ls lt kq lu bi translated"><strong class="ak"> 4a)用于多个子站点(可选)</strong></h2><p id="5ad2" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">我想提请注意的一点是(因为这并不明显)webhook端点是针对整个帐户的。</p><p id="c3b5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这意味着，如果有子网站A和B(例如，同一公司帐户下的不同派生)，我们不能让一个webhook从站点A侦听payment_intent.succeeded，而让另一个webhook从站点B侦听同一事件。</p><p id="77c3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们需要额外的代码来区分回调。</p><p id="c033" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这种情况下，我从条带支持收到的建议是:</p><blockquote class="lv lw lx"><p id="a5fe" class="if ig ly ih b ii ij ik il im in io ip lz ir is it ma iv iw ix mb iz ja jb jc hb bi translated">“最好的选择是检查一次成功支付的事件，看看哪些事件有你需要的信息。”</p></blockquote><p id="ea68" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，我们将需要像产品支付的信息，以便在不同的子网站触发相应的逻辑。不同的条带事件返回不同的信息，因此，我们需要检查每个事件，以找到最合适的候选项。</p><p id="f55b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我具体是怎么做的，是让一个测试脚本将所有的事件代码发送到我的数据库。</p><pre class="je jf jg jh fd kx ky kz la aw lb bi"><span id="eb18" class="lc jv hi ky b fi ld le l lf lg">try {<br/>   $event = \Stripe\Webhook::constructEvent(<br/>      $payload, $sig_header, $endpoint_secret<br/>   );</span><span id="9110" class="lc jv hi ky b fi lh le l lf lg">   //insert event code into the db<br/>   $query = 'insert into db.stripe_test (message) value (:msg)';<br/>   $params = [];<br/>   $params[':msg'] = $event-&gt;type;<br/>   $stmt = $db-&gt;prepare($query);<br/>   $stmt-&gt;execute($params);</span><span id="fc4f" class="lc jv hi ky b fi lh le l lf lg">} catch(\UnexpectedValueException $e) {<br/>   <em class="ly">// Invalid payload</em><br/>   http_response_code(400);<br/>   exit();<br/>} catch(\Stripe\Exception\SignatureVerificationException $e) {<br/>   <em class="ly">// Invalid signature<br/>   </em>http_response_code(400);<br/>   exit();<br/>}</span></pre><p id="d0d7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将它上传到测试服务器后，创建一个新的webhook，并附加所有听起来与我们的用例相关的事件。从支付链接完成一次成功的支付(不是在控制台上测试Webhook！)来激发所有可能的事件。</p><p id="1432" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我的例子中，我注意到<strong class="ih hj">payment _ intent . successed</strong>等。在我的结果里。然而，这是我附加的事件的一个较小的子集，我认为应该被触发。(所以不要假设每个事件都会被触发！)</p><p id="64f4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们知道了什么事件会被触发，我们可以转到<strong class="ih hj"> Test Webhook </strong>(在Stripe控制台中)来逐个触发事件。检查负载并使用包含我们需要的信息的事件。</p><h2 id="02ae" class="lc jv hi bd jw li lj lk ka ll lm ln ke iq lo lp ki iu lq lr km iy ls lt kq lu bi translated"><strong class="ak"> 4b)实现webhook </strong></h2><p id="a7f7" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">实现webhook相对简单，并在<a class="ae jt" href="https://stripe.com/docs/webhooks" rel="noopener ugc nofollow" target="_blank"> Stripe文档</a>中提供，所以我不会在这里重复。</p><p id="7f58" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但要强调的是，这里重要的部分是webhook签名:</p><pre class="je jf jg jh fd kx ky kz la aw lb bi"><span id="612d" class="lc jv hi ky b fi ld le l lf lg">$event = \Stripe\Webhook::constructEvent(<br/>        $payload, $sig_header, $endpoint_secret<br/>);</span></pre><p id="099a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后是响应代码:</p><pre class="je jf jg jh fd kx ky kz la aw lb bi"><span id="5209" class="lc jv hi ky b fi ld le l lf lg">http_response_code(200);</span></pre><p id="2449" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要获得$endpoint_secret，请转到<strong class="ih hj">开发者&gt; Webhooks </strong>，并点击webhook。在webhook界面中，在<strong class="ih hj">签名密码</strong>下，点击<strong class="ih hj">显示</strong>。</p><h1 id="58af" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">第五步:上线</h1><p id="dfa6" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">上线实际上是再次经历上述相同的步骤，但我仍然遇到了错误，因为我错过了一些步骤。因此，我会唠叨，在这里放一个清单:</p><p id="2781" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 5a)获取实时密钥。这只会被披露一次，所以把它放在一个超级安全的地方。</strong></p><p id="288d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 5b)在实时控制台中创建产品和价格，并获取其价格id。</strong></p><p id="c53b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 5c)在现场控制台中创建一个webhook。</strong>确保webhook的签名密码得到更新。否则支付成功，但不会触发后续逻辑。(即用户支付了费用，但没有收到产品！)</p></div><div class="ab cl mc md gp me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="hb hc hd he hf"><p id="4c37" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，就这些了！谢谢你读到这里，我希望以上对你有所帮助。祝你发射成功！</p><p id="f1fc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">顺便问一下，我有没有说过我已经启动了一些项目？如果你能在<a class="ae jt" href="https://www.craftglyphs.com" rel="noopener ugc nofollow" target="_blank">工艺:符号</a>和<a class="ae jt" href="https://www.craftposts.com" rel="noopener ugc nofollow" target="_blank">工艺:帖子</a>查看它们，我会很高兴的！</p></div></div>    
</body>
</html>