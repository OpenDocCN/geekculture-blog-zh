<html>
<head>
<title>Building a Kubernetes cluster on AWS from scratch</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从头开始在AWS上构建Kubernetes集群</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/building-a-kubernetes-cluster-on-aws-from-scratch-7e1e8b0342c4?source=collection_archive---------1-----------------------#2022-07-09">https://medium.com/geekculture/building-a-kubernetes-cluster-on-aws-from-scratch-7e1e8b0342c4?source=collection_archive---------1-----------------------#2022-07-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/ce6edd80364b1aff1942a0176d7f4369.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5SvtYfpLNS0ekr7-"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Photo by <a class="ae iu" href="https://unsplash.com/@ventiviews?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Venti Views</a> on <a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="584d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如今，在任何云提供商上部署Kubernetes集群都非常简单和容易，但并不总是经济高效的。作为开发运维工程师，我们被配置的便利性宠坏了，看不到“幕后”，尤其是在主控制平面上。但是总有一个令人困扰的问题，那就是它是如何工作的。让我们揭开帷幕，开始在AWS上构建我们自己HA(高可用性)Kubernetes集群的旅程。</p><p id="df70" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">本演练对于在生产环境中支持Kubernetes集群并希望了解它们是如何组合在一起的人来说是必不可少的；以及这一切是如何在AWS上运行的。这项工作是基于凯尔西·海托华的《Kubernetes The Hard Way Guide》,该指南被部署到GCP(谷歌云平台)。</p></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><p id="0e04" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在我们进入之前，请花些时间看看这本神奇的书，书名为<a class="ae iu" href="https://packt.link/xSfMI" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj">机器学习，来自Packt出版社</strong> </a>。立即获取一份副本，看看如何在Kubernetes上构建令人惊叹的机器学习应用程序。</p><figure class="kb kc kd ke fd ij er es paragraph-image"><div class="er es ka"><img src="../Images/a4983a85365fdd80b2357f069147db22.png" data-original-src="https://miro.medium.com/v2/resize:fit:1150/format:webp/1*5nCxeIEV19_heAgVAs0pWA.png"/></div></figure></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><p id="7963" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">也请不要忘记关注我(<a class="kf kg ge" href="https://medium.com/u/1a31d3880a4a?source=post_page-----7e1e8b0342c4--------------------------------" rel="noopener" target="_blank">克雷格·牛顿</a>)，非常感谢你的支持。</p></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><p id="21ec" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">好了，现在回到节目上来。下面是我们想要实现的基础架构的简单表示:</p><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kh"><img src="../Images/5d7b3cace02d89a88a550c71009f41aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bYdQVbDLwH5Sh1p4BtBTEQ.png"/></div></div></figure><p id="eb78" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们需要在AWS中调配以下计算资源:</p><ul class=""><li id="0008" class="ki kj hi ix b iy iz jc jd jg kk jk kl jo km js kn ko kp kq bi translated">网络— VPC、子网、互联网网关、路由表、安全组、网络负载平衡器</li><li id="633d" class="ki kj hi ix b iy kr jc ks jg kt jk ku jo kv js kn ko kp kq bi translated">计算实例—控制器和工作人员的EC2节点，SSH密钥对</li></ul></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><p id="daed" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在我们开始之前，我们首先需要确保我们有一些先决条件:</p><ul class=""><li id="78f2" class="ki kj hi ix b iy iz jc jd jg kk jk kl jo km js kn ko kp kq bi translated">有一个AWS帐户设置(希望有一些免费的信用，但这个集群不会花费我们太多，因为我们会在事后拆除它)。</li><li id="7266" class="ki kj hi ix b iy kr jc ks jg kt jk ku jo kv js kn ko kp kq bi translated">安装AWS CLI，以便与您的AWS帐户交互来设置资源；或者你可以使用<a class="ae iu" href="https://aws.amazon.com/cloudshell/" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj"> AWS云外壳</strong> </a>，这是一个基于浏览器的替代方案，可以在你的机器上设置所有这些。</li><li id="a5a9" class="ki kj hi ix b iy kr jc ks jg kt jk ku jo kv js kn ko kp kq bi translated">选择一个您想要部署的AWS区域，最好是离您最近的区域；对我来说，我选择<strong class="ix hj"> eu-central-1 </strong>，因为那是我最近的AWS地区。</li></ul><figure class="kb kc kd ke fd ij er es paragraph-image"><div class="er es kw"><img src="../Images/0cd85702f1695df8c0d3502256a2c442.png" data-original-src="https://miro.medium.com/v2/resize:fit:1094/format:webp/1*Tu_RdMjQMocnix-W3TlM9w.png"/></div><figcaption class="iq ir et er es is it bd b be z dx">AWS Cloud Shell — browser based terminal at your fingertips</figcaption></figure><ul class=""><li id="7d49" class="ki kj hi ix b iy iz jc jd jg kk jk kl jo km js kn ko kp kq bi translated">您还可以安装并使用<a class="ae iu" href="https://github.com/tmux/tmux/wiki" rel="noopener ugc nofollow" target="_blank"><strong class="ix hj">tmux</strong></a><strong class="ix hj"/>来简化在多个实例上运行相同的命令。</li><li id="03d2" class="ki kj hi ix b iy kr jc ks jg kt jk ku jo kv js kn ko kp kq bi translated">我们将生成相当多的<a class="ae iu" href="https://en.wikipedia.org/wiki/Public_key_infrastructure" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj"> PKI基础设施</strong> </a>密钥，并生成TLS证书，因为我们希望一切都是安全的。确保您已经安装了<a class="ae iu" href="https://github.com/cloudflare/cfssl" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj"> cfssl </strong> </a>和<a class="ae iu" href="https://github.com/cloudflare/cfssl" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj"> cfssljon </strong> </a>命令行实用程序。</li><li id="ad1b" class="ki kj hi ix b iy kr jc ks jg kt jk ku jo kv js kn ko kp kq bi translated">因为我们将使用Kubernetes，所以我们还需要确保我们安装了可信任的<a class="ae iu" href="https://kubernetes.io/docs/tasks/tools/" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj"> kubectl </strong> </a>客户端，这样我们就可以在我们的Kubernetes集群上执行操作。</li></ul><h2 id="add3" class="kx ky hi bd kz la lb lc ld le lf lg lh jg li lj lk jk ll lm ln jo lo lp lq lr bi translated">设置默认计算区域和分区</h2><p id="6617" class="pw-post-body-paragraph iv iw hi ix b iy ls ja jb jc lt je jf jg lu ji jj jk lv jm jn jo lw jq jr js hb bi translated">在您的终端窗口或AWS CloudShell窗口中运行:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="8a53" class="kx ky hi ly b fi mc md l me mf">AWS_REGION=eu-central-1<br/>aws configure set default.region $AWS_REGION</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div class="er es mg"><img src="../Images/00367d8e76a0dbb5d116e8aac6d77097.png" data-original-src="https://miro.medium.com/v2/resize:fit:1192/format:webp/1*k1YowS3r0Esp9_PHQLUnhQ.png"/></div></figure></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><h2 id="f2fb" class="kx ky hi bd kz la lb lc ld le lf lg lh jg li lj lk jk ll lm ln jo lo lp lq lr bi translated">安装一些我们需要的客户端工具</h2><p id="15b5" class="pw-post-body-paragraph iv iw hi ix b iy ls ja jb jc lt je jf jg lu ji jj jk lv jm jn jo lw jq jr js hb bi translated">我将在这里使用linux的例子，但如果你使用其他操作系统，如Mac OS X，那么<a class="ae iu" href="https://github.com/kelseyhightower/kubernetes-the-hard-way/blob/master/docs/02-client-tools.md" rel="noopener ugc nofollow" target="_blank">参考本页</a>。</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="f246" class="kx ky hi ly b fi mc md l me mf">wget -q --timestamping \<br/>  <a class="ae iu" href="https://storage.googleapis.com/kubernetes-the-hard-way/cfssl/1.4.1/linux/cfssl" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/kubernetes-the-hard-way/cfssl/1.4.1/linux/cfssl</a> \<br/>  <a class="ae iu" href="https://storage.googleapis.com/kubernetes-the-hard-way/cfssl/1.4.1/linux/cfssljson" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/kubernetes-the-hard-way/cfssl/1.4.1/linux/cfssljson</a></span><span id="b5f4" class="kx ky hi ly b fi mh md l me mf">chmod +x cfssl cfssljson<br/>sudo mv cfssl cfssljson /usr/local/bin/</span><span id="22bf" class="kx ky hi ly b fi mh md l me mf">cfssl version<br/>cfssljson --version</span><span id="d3e1" class="kx ky hi ly b fi mh md l me mf">wget <a class="ae iu" href="https://storage.googleapis.com/kubernetes-release/release/v1.21.0/bin/linux/amd64/kubectl" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/kubernetes-release/release/v1.21.0/bin/linux/amd64/kubectl</a></span><span id="0df8" class="kx ky hi ly b fi mh md l me mf">chmod +x kubectl<br/>sudo mv kubectl /usr/local/bin/</span><span id="cc58" class="kx ky hi ly b fi mh md l me mf">kubectl version --client</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mi"><img src="../Images/cdb9ec131d11dfd9b4bfa4c4ad86c7fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y5X8HDWz58tyPw3lCa6K1Q.png"/></div></div></figure></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><h2 id="1f0f" class="kx ky hi bd kz la lb lc ld le lf lg lh jg li lj lk jk ll lm ln jo lo lp lq lr bi translated">调配计算基础架构</h2><p id="b0a2" class="pw-post-body-paragraph iv iw hi ix b iy ls ja jb jc lt je jf jg lu ji jj jk lv jm jn jo lw jq jr js hb bi translated">AWS的最佳实践要求我们将我们的“项目”/“产品”包装到它自己的VPC(虚拟私有云)中，其中包含子网、路由表、负载平衡器和一个互联网网关(其中每个VPC只允许一个互联网网关)。这不仅是一种分组机制，也是一层安全保障。</p><p id="a74a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> VPC </strong></p><p id="b2b7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们设置一个名为<strong class="ix hj">kubernetes-从头开始</strong>的VPC，它启用了DNS支持和DNS主机名支持。在终端会话中执行以下命令:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="4226" class="kx ky hi ly b fi mc md l me mf">VPC_ID=$(aws ec2 create-vpc --cidr-block 10.0.0.0/16 --output text --query 'Vpc.VpcId')</span><span id="17bd" class="kx ky hi ly b fi mh md l me mf">aws ec2 create-tags --resources ${VPC_ID} --tags Key=Name,Value=kubernetes-from-scratch</span><span id="a927" class="kx ky hi ly b fi mh md l me mf">aws ec2 modify-vpc-attribute --vpc-id ${VPC_ID} --enable-dns-support '{"Value": true}'</span><span id="f289" class="kx ky hi ly b fi mh md l me mf">aws ec2 modify-vpc-attribute --vpc-id ${VPC_ID} --enable-dns-hostnames '{"Value": true}'</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mj"><img src="../Images/1367c29d982dd08b38af82a8149f38ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CArBA8mfXjEChnmdZeVduQ.png"/></div></div></figure><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mk"><img src="../Images/7ad3e45639ed1e0f8833621c095100e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TQwbfYKKndnS0Ob7LquRLw.png"/></div></div></figure><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ml"><img src="../Images/7a56274b8c6081bd49562b5282a88f63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yid83mwS3ed_L3h5hBvCjA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx"><a class="ae iu" href="https://cidr.xyz" rel="noopener ugc nofollow" target="_blank">https://cidr.xyz</a> — allows you to easily visualize out CIDR ranges</figcaption></figure><p id="8d8b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">私有子网</strong></p><p id="0095" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们需要能够为控制平面控制器和工作实例的计算实例分配私有IP地址。VPC中的子网允许我们创建一系列IP地址，我们可以将这些地址分配给不允许外部访问的实例(除非通过代理或负载平衡器):</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="ac08" class="kx ky hi ly b fi mc md l me mf">SUBNET_ID=$(aws ec2 create-subnet \<br/>  --vpc-id ${VPC_ID} \<br/>  --cidr-block 10.0.1.0/24 \<br/>  --output text --query 'Subnet.SubnetId')</span><span id="5c90" class="kx ky hi ly b fi mh md l me mf">aws ec2 create-tags --resources ${SUBNET_ID} --tags Key=Name,Value=kubernetes-pvt</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mm"><img src="../Images/79691c5f6a94e65561310f155af3f703.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RZQ3Xy004ryhkU6a2qBiFQ.png"/></div></div></figure><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mn"><img src="../Images/a34f428671347a31326dd301fd65aadc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eyv4saDBun4Wbth7eOuz7w.png"/></div></div></figure><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mo"><img src="../Images/53675aa3054c3f64333a5ec1444832ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z0e1eJwrdDun9tmlZ-oByg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx"><a class="ae iu" href="https://cidr.xyz" rel="noopener ugc nofollow" target="_blank">https://cidr.xyz</a> — allows you to easily visualize out CIDR ranges</figcaption></figure><p id="3ef3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">通过使用这个CIDR范围10.0.1.0/24，我们有多达256台主机(实际上更少，因为AWS保留了一些IP，前4个和后1个，<a class="ae iu" href="https://docs.aws.amazon.com/vpc/latest/userguide/configure-subnets.html" rel="noopener ugc nofollow" target="_blank">在此阅读更多信息</a>)。</p><p id="9934" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">互联网网关</strong></p><p id="1ef8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们的实例需要某种方式与互联网连接和通信，因为我们在一个私有网络上。这意味着我们需要提供一个网关来代理我们的流量。让我们通过运行以下命令来设置一个:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="02cc" class="kx ky hi ly b fi mc md l me mf">INTERNET_GATEWAY_ID=$(aws ec2 create-internet-gateway --output text --query 'InternetGateway.InternetGatewayId')</span><span id="0579" class="kx ky hi ly b fi mh md l me mf">aws ec2 create-tags --resources ${INTERNET_GATEWAY_ID} --tags Key=Name,Value=kubernetes-igw</span><span id="c475" class="kx ky hi ly b fi mh md l me mf">aws ec2 attach-internet-gateway --internet-gateway-id ${INTERNET_GATEWAY_ID} --vpc-id ${VPC_ID}</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mp"><img src="../Images/3887396f53b9e91f3921a7a2ec0fa03f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tuZDcrl5Z1zGZJsOS4WWNA.png"/></div></div></figure><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mq"><img src="../Images/d35adde50154cfafef9b39019e4612cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*snqZmBrzzuvSJ5HPJmb9GA.png"/></div></div></figure><p id="a453" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">路由表</strong></p><p id="3b99" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们现在需要定义如何通过我们的互联网网关从我们网络中的实例路由我们的流量。为此，我们为流量定义了一个路由表:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="538b" class="kx ky hi ly b fi mc md l me mf">ROUTE_TABLE_ID=$(aws ec2 create-route-table --vpc-id ${VPC_ID} --output text --query 'RouteTable.RouteTableId')</span><span id="4ede" class="kx ky hi ly b fi mh md l me mf">aws ec2 create-tags --resources ${ROUTE_TABLE_ID} --tags Key=Name,Value=kubernetes-rt</span><span id="f467" class="kx ky hi ly b fi mh md l me mf">aws ec2 associate-route-table --route-table-id ${ROUTE_TABLE_ID} --subnet-id ${SUBNET_ID}</span><span id="1199" class="kx ky hi ly b fi mh md l me mf">aws ec2 create-route --route-table-id ${ROUTE_TABLE_ID} --destination-cidr-block 0.0.0.0/0 --gateway-id ${INTERNET_GATEWAY_ID}</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mi"><img src="../Images/37c1e4a4b1458912229928a0739f5317.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3srSgQRDVhn8RVDB2Eo5dg.png"/></div></div></figure><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mr"><img src="../Images/30f121b7a36b872abd2d55bbcca8be44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TiAn7yFz6n7F9Lf_C4V0Og.png"/></div></div></figure><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ms"><img src="../Images/87b2cb892d6b46777d900a61863b65b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rW9fIWahKWN_v-ngKYiw8g.png"/></div></div></figure><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mt"><img src="../Images/2da5f87ce79bb963cdd6bb76971a37e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pgYWN3tBBKJLpJvs5kKVsA.png"/></div></div></figure><p id="df88" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们的专用子网现在已经与路由表相关联，并且我们的路由已经为我们的互联网网关设置好了。</p><p id="3dc8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">安全组</strong></p><p id="49ba" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们需要一个安全组，这样我们就可以允许实例之间的流量，以及从我们的客户端软件进行访问。我们定义我们的控制者和我们的工人之间的交流规则；SSH、Kubernetes API服务器、HTTPS和ICMP(用于pings):</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="39fc" class="kx ky hi ly b fi mc md l me mf">SECURITY_GROUP_ID=$(aws ec2 create-security-group \<br/>  --group-name kubernetes-from-scratch \<br/>  --description "Kubernetes from scratch - security group" \<br/>  --vpc-id ${VPC_ID} \<br/>  --output text --query 'GroupId')</span><span id="f78f" class="kx ky hi ly b fi mh md l me mf">aws ec2 create-tags --resources ${SECURITY_GROUP_ID} --tags Key=Name,Value=kubernetes-sg</span><span id="af22" class="kx ky hi ly b fi mh md l me mf">aws ec2 authorize-security-group-ingress --group-id ${SECURITY_GROUP_ID} --protocol all --cidr 10.0.0.0/16<br/>aws ec2 authorize-security-group-ingress --group-id ${SECURITY_GROUP_ID} --protocol all --cidr 10.200.0.0/16</span><span id="537f" class="kx ky hi ly b fi mh md l me mf">aws ec2 authorize-security-group-ingress --group-id ${SECURITY_GROUP_ID} --protocol tcp --port 22 --cidr 0.0.0.0/0<br/>aws ec2 authorize-security-group-ingress --group-id ${SECURITY_GROUP_ID} --protocol tcp --port 6443 --cidr 0.0.0.0/0<br/>aws ec2 authorize-security-group-ingress --group-id ${SECURITY_GROUP_ID} --protocol tcp --port 443 --cidr 0.0.0.0/0<br/>aws ec2 authorize-security-group-ingress --group-id ${SECURITY_GROUP_ID} --protocol icmp --port -1 --cidr 0.0.0.0/0</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mu"><img src="../Images/8dd8181c5eb204ee816a9ae74d8fd632.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2_8WBTujYOg4qAX44xGXrQ.png"/></div></div></figure><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mv"><img src="../Images/d3fc9258c1f2d5ea8738480cdb0646ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9yYLd3xo7H2jpiQdH0RvMQ.png"/></div></div></figure><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mw"><img src="../Images/308727a487a2c5283e71f188b5fc72c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wotQe4cVjIKc6cXaxh4TnA.png"/></div></div></figure><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mx"><img src="../Images/43f86e2a6fa766cbcc68bddf86b5246c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hlpHOzAOju6QMaIDXGY2AA.png"/></div></div></figure><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es my"><img src="../Images/b15c383d8e09f9749367a314f6fff49d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t_wEEewH63L9Tp_dWOKKiA.png"/></div></div></figure><p id="91cc" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">网络负载均衡器</strong></p><p id="8f94" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们需要某种方式从外界访问我们的Kubernetes API。我们创建一个<strong class="ix hj">面向互联网的网络负载平衡器</strong>并注册我们的控制平面控制器。这样我们就可以拥有一个HA(高可用性)控制平面。要创建我们的负载平衡器，请执行以下操作:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="999d" class="kx ky hi ly b fi mc md l me mf">LOAD_BALANCER_ARN=$(aws elbv2 create-load-balancer \<br/>    --name kubernetes-nlb \<br/>    --subnets ${SUBNET_ID} \<br/>    --scheme internet-facing \<br/>    --type network \<br/>    --output text --query 'LoadBalancers[].LoadBalancerArn')</span><span id="e23b" class="kx ky hi ly b fi mh md l me mf">TARGET_GROUP_ARN=$(aws elbv2 create-target-group \<br/>    --name kubernetes-tg \<br/>    --protocol TCP \<br/>    --port 6443 \<br/>    --vpc-id ${VPC_ID} \<br/>    --target-type ip \<br/>    --output text --query 'TargetGroups[].TargetGroupArn')</span><span id="2382" class="kx ky hi ly b fi mh md l me mf">aws elbv2 register-targets --target-group-arn ${TARGET_GROUP_ARN} --targets Id=10.0.1.1{0,1,2}</span><span id="8ef6" class="kx ky hi ly b fi mh md l me mf">aws elbv2 create-listener \<br/>    --load-balancer-arn ${LOAD_BALANCER_ARN} \<br/>    --protocol TCP \<br/>    --port 443 \<br/>    --default-actions Type=forward,TargetGroupArn=${TARGET_GROUP_ARN} \<br/>    --output text --query 'Listeners[].ListenerArn'</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mz"><img src="../Images/4e84ae78b2935395210273fc81b0a591.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gjWWXaDI2ZxTB5WzmYUW3g.png"/></div></div></figure><p id="cb39" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们可以获得我们的负载平衡器的公共DNS地址，供以后使用:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="80e0" class="kx ky hi ly b fi mc md l me mf">KUBERNETES_PUBLIC_ADDRESS=$(aws elbv2 describe-load-balancers \<br/>  --load-balancer-arns ${LOAD_BALANCER_ARN} \<br/>  --output text --query 'LoadBalancers[].DNSName')</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es na"><img src="../Images/6dfe85bafda323ac1b2a6ded22508e52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9DzsPpDrqMbzVtiet7YlGQ.png"/></div></div></figure><p id="6216" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">计算实例</strong></p><p id="c1b8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">既然我们已经建立了所有的路由和支持基础设施，现在是时候定义我们的工作马(控制器和工人)了。我们将在计算实例中使用Ubuntu 20.04，因此我们需要首先选择它:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="ebbb" class="kx ky hi ly b fi mc md l me mf">IMAGE_ID=$(aws ec2 describe-images --owners 099720109477 \<br/>  --output json \<br/>  --filters \<br/>  'Name=root-device-type,Values=ebs' \<br/>  'Name=architecture,Values=x86_64' \<br/>  'Name=name,Values=ubuntu/images/hvm-ssd/ubuntu-focal-20.04-amd64-server-*' \<br/>  | jq -r '.Images|sort_by(.Name)[-1]|.ImageId')</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div class="er es nb"><img src="../Images/d3db6986f887482f1c2fa793193af400.png" data-original-src="https://miro.medium.com/v2/resize:fit:1310/format:webp/1*TG6k6iEkUqDDv9hUPS5bzA.png"/></div></figure><p id="8b6d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这将为我们将在节点上运行的Ubuntu 20.04操作系统获取我们区域中的IMAGE_ID。</p><p id="90fa" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们需要连接到我们的节点，以便我们可以安装软件和管理系统，因此我们需要创建一个密钥对，以便我们可以使用它安全地连接到我们的实例。让我们创建新的密钥对:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="7fd8" class="kx ky hi ly b fi mc md l me mf">aws ec2 create-key-pair --key-name kubernetes --output text --query 'KeyMaterial' &gt; kubernetes.id_rsa</span><span id="19df" class="kx ky hi ly b fi mh md l me mf">chmod 600 kubernetes.id_rsa</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nc"><img src="../Images/d5f38eb2001f8d213c373e54d5fd3ff1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L8EyUHrSTsCxZhXySUniFA.png"/></div></div></figure><p id="8928" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">记得把这个文件保存在一个安全的地方，比如钥匙链或者类似Bitwarden的东西。</p><p id="936d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">接下来，让我们调配我们的Kubernetes控制器。我们将需要3个HA(高可用性)，在这一步中我们将使用<strong class="ix hj"> t3.micro </strong>实例(请随意尝试不同的实例类型，但要记住它们确实会让您花钱):</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="72cf" class="kx ky hi ly b fi mc md l me mf">for i in 0 1 2; do<br/>  instance_id=$(aws ec2 run-instances \<br/>    --associate-public-ip-address \<br/>    --image-id ${IMAGE_ID} \<br/>    --count 1 \<br/>    --key-name kubernetes \<br/>    --security-group-ids ${SECURITY_GROUP_ID} \<br/>    --instance-type t3.micro \<br/>    --private-ip-address 10.0.1.1${i} \<br/>    --user-data "name=controller-${i}" \<br/>    --subnet-id ${SUBNET_ID} \<br/>    --block-device-mappings='{"DeviceName": "/dev/sda1", "Ebs": { "VolumeSize": 50 }, "NoDevice": "" }' \<br/>    --output text --query 'Instances[].InstanceId')<br/>  aws ec2 modify-instance-attribute --instance-id ${instance_id} --no-source-dest-check<br/>  aws ec2 create-tags --resources ${instance_id} --tags "Key=Name,Value=controller-${i}"<br/>  echo "controller-${i} created "<br/>done</span></pre><p id="9bf0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果您对<strong class="ix hj">键名</strong>的命名与我们在之前步骤中的不同，请特别注意。我们还将公共ip地址与实例相关联。</p><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nd"><img src="../Images/6d1dc0294cab9092afa79065650a84dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*imd7ahhVemaG6nAznpacjw.png"/></div></div></figure><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ne"><img src="../Images/05bbb9a697401513fc2b2003fb1530f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2PGYOkQyf6EuE_V0v2vCpQ.png"/></div></div></figure><p id="6c2f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在是创建工作节点的时候了:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="2f6d" class="kx ky hi ly b fi mc md l me mf">for i in 0 1 2; do<br/>  instance_id=$(aws ec2 run-instances \<br/>    --associate-public-ip-address \<br/>    --image-id ${IMAGE_ID} \<br/>    --count 1 \<br/>    --key-name kubernetes \<br/>    --security-group-ids ${SECURITY_GROUP_ID} \<br/>    --instance-type t3.micro \<br/>    --private-ip-address 10.0.1.2${i} \<br/>    --user-data "name=worker-${i}|pod-cidr=10.200.${i}.0/24" \<br/>    --subnet-id ${SUBNET_ID} \<br/>    --block-device-mappings='{"DeviceName": "/dev/sda1", "Ebs": { "VolumeSize": 50 }, "NoDevice": "" }' \<br/>    --output text --query 'Instances[].InstanceId')<br/>  aws ec2 modify-instance-attribute --instance-id ${instance_id} --no-source-dest-check<br/>  aws ec2 create-tags --resources ${instance_id} --tags "Key=Name,Value=worker-${i}"<br/>  echo "worker-${i} created"<br/>done</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nf"><img src="../Images/ddfb385ce848f3a59733137976d07c1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cBG-yc4u6l_BcDwhprH0vg.png"/></div></div></figure><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ng"><img src="../Images/2d89226f0e866bbf53366c351dcc9bd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E_oHIHtydlvLU3UvIU5xFw.png"/></div></div></figure><p id="c560" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">就像我们已经有了基础架构一样，我们现在需要继续在每个节点上安装必要的软件和配置。</p></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><h2 id="d3e9" class="kx ky hi bd kz la lb lc ld le lf lg lh jg li lj lk jk ll lm ln jo lo lp lq lr bi translated">设置CA并生成TLS证书</h2><p id="e21f" class="pw-post-body-paragraph iv iw hi ix b iy ls ja jb jc lt je jf jg lu ji jj jk lv jm jn jo lw jq jr js hb bi translated">安全性非常重要，通过使用TLS证书，我们可以确保系统中节点之间的通信是安全的。</p><p id="1aab" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们继续创建一个名为certs的文件夹，然后进入该文件夹:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="a8fc" class="kx ky hi ly b fi mc md l me mf">mkdir -p certs<br/>cd certs/</span></pre><p id="4040" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">认证机构</strong></p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="3b02" class="kx ky hi ly b fi mc md l me mf">cat &gt; ca-config.json &lt;&lt;EOF<br/>{<br/>  "signing": {<br/>    "default": {<br/>      "expiry": "8760h"<br/>    },<br/>    "profiles": {<br/>      "kubernetes": {<br/>        "usages": ["signing", "key encipherment", "server auth", "client auth"],<br/>        "expiry": "8760h"<br/>      }<br/>    }<br/>  }<br/>}<br/>EOF</span><span id="117f" class="kx ky hi ly b fi mh md l me mf">cat &gt; ca-csr.json &lt;&lt;EOF<br/>{<br/>  "CN": "Kubernetes",<br/>  "key": {<br/>    "algo": "rsa",<br/>    "size": 2048<br/>  },<br/>  "names": [<br/>    {<br/>      "C": "NL",<br/>      "L": "Netherlands",<br/>      "O": "Kubernetes",<br/>      "OU": "AMS",<br/>      "ST": "Amsterdam"<br/>    }<br/>  ]<br/>}<br/>EOF</span><span id="af14" class="kx ky hi ly b fi mh md l me mf">cfssl gencert -initca ca-csr.json | cfssljson -bare ca</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nh"><img src="../Images/c2b9b35ea5b906ddacea0e8ca4d0ea72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8rJLOPwZYhedIqAw18N71g.png"/></div></div></figure><h2 id="0dbd" class="kx ky hi bd kz la lb lc ld le lf lg lh jg li lj lk jk ll lm ln jo lo lp lq lr bi translated">客户端和服务器证书</h2><p id="165d" class="pw-post-body-paragraph iv iw hi ix b iy ls ja jb jc lt je jf jg lu ji jj jk lv jm jn jo lw jq jr js hb bi translated">我们需要为每个Kubernetes组件生成客户机和服务器证书，并为Kubernetes <strong class="ix hj"> admin </strong>用户生成客户机证书。</p><p id="fcfc" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">管理员客户端证书</strong></p><p id="d01f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">生成<strong class="ix hj">管理员</strong>客户端证书和私钥:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="47ce" class="kx ky hi ly b fi mc md l me mf">cat &gt; admin-csr.json &lt;&lt;EOF<br/>{<br/>  "CN": "admin",<br/>  "key": {<br/>    "algo": "rsa",<br/>    "size": 2048<br/>  },<br/>  "names": [<br/>    {<br/>      "C": "NL",<br/>      "L": "Netherlands",<br/>      "O": "system:masters",<br/>      "OU": "Kubernetes from scratch",<br/>      "ST": "Amsterdam"<br/>    }<br/>  ]<br/>}<br/>EOF</span><span id="9d19" class="kx ky hi ly b fi mh md l me mf">cfssl gencert \<br/>  -ca=ca.pem \<br/>  -ca-key=ca-key.pem \<br/>  -config=ca-config.json \<br/>  -profile=kubernetes \<br/>  admin-csr.json | cfssljson -bare admin</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ni"><img src="../Images/1a864a06b509bab3f511c8bfc252e578.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mo6w5PYI2MMdjpFcAEUvhg.png"/></div></div></figure><p id="81e4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">kube let客户证书</strong></p><p id="5758" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Kubernetes使用一种叫做节点授权器的<a class="ae iu" href="https://kubernetes.io/docs/admin/authorization/node/" rel="noopener ugc nofollow" target="_blank">专用授权模式</a>，专门授权由<a class="ae iu" href="https://kubernetes.io/docs/concepts/overview/components/#kubelet" rel="noopener ugc nofollow" target="_blank"> Kubelets </a>发出的API请求。为了得到节点授权者的授权，Kubelets必须使用一个证书来标识他们在<strong class="ix hj">系统:节点</strong>组中，用户名为<strong class="ix hj">系统:节点:&lt;节点名&gt; </strong>。在本节中，您将为每个满足节点授权者要求的Kubernetes worker节点创建一个证书。</p><p id="bf72" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为每个Kubernetes工作节点生成一个证书和私钥:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="17d7" class="kx ky hi ly b fi mc md l me mf">for i in 0 1 2; do<br/>  instance="worker-${i}"<br/>  instance_hostname="ip-10-0-1-2${i}"<br/>  cat &gt; ${instance}-csr.json &lt;&lt;EOF<br/>{<br/>  "CN": "system:node:${instance_hostname}",<br/>  "key": {<br/>    "algo": "rsa",<br/>    "size": 2048<br/>  },<br/>  "names": [<br/>    {<br/>      "C": "NL",<br/>      "L": "Netherlands",<br/>      "O": "system:nodes",<br/>      "OU": "Kubernetes from scratch",<br/>      "ST": "Amsterdam"<br/>    }<br/>  ]<br/>}<br/>EOF</span><span id="b14c" class="kx ky hi ly b fi mh md l me mf">external_ip=$(aws ec2 describe-instances --filters \<br/>    "Name=tag:Name,Values=${instance}" \<br/>    "Name=instance-state-name,Values=running" \<br/>    --output text --query 'Reservations[].Instances[].PublicIpAddress')</span><span id="8a55" class="kx ky hi ly b fi mh md l me mf">internal_ip=$(aws ec2 describe-instances --filters \<br/>    "Name=tag:Name,Values=${instance}" \<br/>    "Name=instance-state-name,Values=running" \<br/>    --output text --query 'Reservations[].Instances[].PrivateIpAddress')</span><span id="b768" class="kx ky hi ly b fi mh md l me mf">cfssl gencert \<br/>    -ca=ca.pem \<br/>    -ca-key=ca-key.pem \<br/>    -config=ca-config.json \<br/>    -hostname=${instance_hostname},${external_ip},${internal_ip} \<br/>    -profile=kubernetes \<br/>    worker-${i}-csr.json | cfssljson -bare worker-${i}<br/>done</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nj"><img src="../Images/64bb00c3a0b6983e18d8ff80fffb7f1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2i4u84xmL7fb_sBmMmp_Ng.png"/></div></div></figure><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nk"><img src="../Images/f9d0a03ba00892c3ba686f4ac920b277.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZDJvkAVdo7qaEh1kmMoQUA.png"/></div></div></figure><p id="44cb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">控制器管理器客户端证书</strong></p><p id="93c1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">生成<strong class="ix hj">kube-controller-manager</strong>客户端证书和私钥:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="3f5e" class="kx ky hi ly b fi mc md l me mf">cat &gt; kube-controller-manager-csr.json &lt;&lt;EOF<br/>{<br/>  "CN": "system:kube-controller-manager",<br/>  "key": {<br/>    "algo": "rsa",<br/>    "size": 2048<br/>  },<br/>  "names": [<br/>    {<br/>      "C": "NL",<br/>      "L": "Netherlands",<br/>      "O": "system:kube-controller-manager",<br/>      "OU": "Kubernetes from scratch",<br/>      "ST": "Amsterdam"<br/>    }<br/>  ]<br/>}<br/>EOF</span><span id="f4cc" class="kx ky hi ly b fi mh md l me mf">cfssl gencert \<br/>  -ca=ca.pem \<br/>  -ca-key=ca-key.pem \<br/>  -config=ca-config.json \<br/>  -profile=kubernetes \<br/>  kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nk"><img src="../Images/76f7d742363997ab688308f6f31f383a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LRUzmtXs4b5pF167Ii4fqw.png"/></div></div></figure><p id="39e8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">Kube代理客户证书</strong></p><p id="f363" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">生成<strong class="ix hj"> kube-proxy </strong>客户端证书和私钥:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="5d9a" class="kx ky hi ly b fi mc md l me mf">cat &gt; kube-proxy-csr.json &lt;&lt;EOF<br/>{<br/>  "CN": "system:kube-proxy",<br/>  "key": {<br/>    "algo": "rsa",<br/>    "size": 2048<br/>  },<br/>  "names": [<br/>    {<br/>      "C": "NL",<br/>      "L": "Netherlands",<br/>      "O": "system:node-proxier",<br/>      "OU": "Kubernetes from scratch",<br/>      "ST": "Amsterdam"<br/>    }<br/>  ]<br/>}<br/>EOF</span><span id="82ad" class="kx ky hi ly b fi mh md l me mf">cfssl gencert \<br/>  -ca=ca.pem \<br/>  -ca-key=ca-key.pem \<br/>  -config=ca-config.json \<br/>  -profile=kubernetes \<br/>  kube-proxy-csr.json | cfssljson -bare kube-proxy</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nl"><img src="../Images/a13f5f5e0e015c3ba7b7e98439f58c0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6CiHwxxk_oaR_HHBqJlS5Q.png"/></div></div></figure><p id="c474" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">调度程序客户端证书</strong></p><p id="a037" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">生成<strong class="ix hj"> kube-scheduler </strong>客户端证书和私钥:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="520d" class="kx ky hi ly b fi mc md l me mf">cat &gt; kube-scheduler-csr.json &lt;&lt;EOF<br/>{<br/>  "CN": "system:kube-scheduler",<br/>  "key": {<br/>    "algo": "rsa",<br/>    "size": 2048<br/>  },<br/>  "names": [<br/>    {<br/>      "C": "NL",<br/>      "L": "Netherlands",<br/>      "O": "system:kube-scheduler",<br/>      "OU": "Kubernetes from scratch",<br/>      "ST": "Amsterdam"<br/>    }<br/>  ]<br/>}<br/>EOF</span><span id="b432" class="kx ky hi ly b fi mh md l me mf">cfssl gencert \<br/>  -ca=ca.pem \<br/>  -ca-key=ca-key.pem \<br/>  -config=ca-config.json \<br/>  -profile=kubernetes \<br/>  kube-scheduler-csr.json | cfssljson -bare kube-scheduler</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nm"><img src="../Images/502af7d2d6764fbfc67ad86b81ec24c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eCeLjZ39r5VSUotnVZRXkg.png"/></div></div></figure><p id="545f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">Kubernetes API服务器证书</strong></p><p id="0e24" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Kubernetes公共地址将包含在Kubernetes API服务器证书的主题替换名称列表中。这将确保证书可以被远程客户端验证。</p><p id="55d5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">生成Kubernetes API服务器证书和私钥:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="e0b9" class="kx ky hi ly b fi mc md l me mf">KUBERNETES_HOSTNAMES=kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.svc.cluster.local</span><span id="4872" class="kx ky hi ly b fi mh md l me mf">cat &gt; kubernetes-csr.json &lt;&lt;EOF<br/>{<br/>  "CN": "kubernetes",<br/>  "key": {<br/>    "algo": "rsa",<br/>    "size": 2048<br/>  },<br/>  "names": [<br/>    {<br/>      "C": "NL",<br/>      "L": "Netherlands",<br/>      "O": "Kubernetes",<br/>      "OU": "Kubernetes from scratch",<br/>      "ST": "Amsterdam"<br/>    }<br/>  ]<br/>}<br/>EOF</span><span id="89f0" class="kx ky hi ly b fi mh md l me mf">cfssl gencert \<br/>  -ca=ca.pem \<br/>  -ca-key=ca-key.pem \<br/>  -config=ca-config.json \<br/>  -hostname=10.32.0.1,10.0.1.10,10.0.1.11,10.0.1.12,${KUBERNETES_PUBLIC_ADDRESS},127.0.0.1,${KUBERNETES_HOSTNAMES} \<br/>  -profile=kubernetes \<br/>  kubernetes-csr.json | cfssljson -bare kubernetes</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nn"><img src="../Images/8ca2ee814c2dd0ecd47d41bdd3f00485.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vdUrpPXKBMpoWO6VYzI5-A.png"/></div></div></figure><p id="06c6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">服务账户密钥对</strong></p><p id="7703" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Kubernetes控制器管理器利用一个密钥对来生成和签署服务帐户令牌，如<a class="ae iu" href="https://kubernetes.io/docs/admin/service-accounts-admin/" rel="noopener ugc nofollow" target="_blank">管理服务帐户</a>文档中所述。</p><p id="6a45" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">生成<strong class="ix hj">服务账户</strong>证书和私钥:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="fe29" class="kx ky hi ly b fi mc md l me mf">cat &gt; service-account-csr.json &lt;&lt;EOF<br/>{<br/>  "CN": "service-accounts",<br/>  "key": {<br/>    "algo": "rsa",<br/>    "size": 2048<br/>  },<br/>  "names": [<br/>    {<br/>      "C": "NL",<br/>      "L": "Netherlands",<br/>      "O": "Kubernetes",<br/>      "OU": "Kubernetes from scratch",<br/>      "ST": "Amsterdam"<br/>    }<br/>  ]<br/>}<br/>EOF</span><span id="62a1" class="kx ky hi ly b fi mh md l me mf">cfssl gencert \<br/>  -ca=ca.pem \<br/>  -ca-key=ca-key.pem \<br/>  -config=ca-config.json \<br/>  -profile=kubernetes \<br/>  service-account-csr.json | cfssljson -bare service-account</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mi"><img src="../Images/3ef80f847a0b6889c331dcdbe8c978e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f_J3QsSIpGQE_sKjikSTyQ.png"/></div></div></figure><p id="2800" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">分发客户端和服务器证书</strong></p><p id="e868" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在我们有了这个充满证书的目录，是时候将它们发送到节点了。</p><p id="fad2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">首先，我们将证书和私钥复制到每个worker实例:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="e193" class="kx ky hi ly b fi mc md l me mf">for instance in worker-0 worker-1 worker-2; do<br/>  external_ip=$(aws ec2 describe-instances --filters \<br/>    "Name=tag:Name,Values=${instance}" \<br/>    "Name=instance-state-name,Values=running" \<br/>    --output text --query 'Reservations[].Instances[].PublicIpAddress')</span><span id="f861" class="kx ky hi ly b fi mh md l me mf">scp -i ../kubernetes.id_rsa ca.pem ${instance}-key.pem ${instance}.pem ubuntu@${external_ip}:~/<br/>done</span></pre><p id="906d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">注意，我们在<strong class="ix hj">证书/ </strong>文件夹中，所以给我加了<strong class="ix hj">../kubernetes.id_rsa </strong> —这是我们之前所在目录的上一级目录，以防您遇到权限被拒绝的错误。</p><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es no"><img src="../Images/97d90227636fe8cb75af04830b8f740b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XFS8_9JEhtk-ZJNIg9puGQ.png"/></div></div></figure><p id="e47d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">接下来，我们将证书和私钥复制到每个控制器实例:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="0295" class="kx ky hi ly b fi mc md l me mf">for instance in controller-0 controller-1 controller-2; do<br/>  external_ip=$(aws ec2 describe-instances --filters \<br/>    "Name=tag:Name,Values=${instance}" \<br/>    "Name=instance-state-name,Values=running" \<br/>    --output text --query 'Reservations[].Instances[].PublicIpAddress')</span><span id="3723" class="kx ky hi ly b fi mh md l me mf">scp -i ../kubernetes.id_rsa \<br/>    ca.pem ca-key.pem kubernetes-key.pem kubernetes.pem \<br/>    service-account-key.pem service-account.pem ubuntu@${external_ip}:~/<br/>done</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mp"><img src="../Images/50acb5585f6979014194d9c6ff81de03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jOrEQwLTu4xLCXFZ8d9Gxg.png"/></div></div></figure></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><h2 id="067a" class="kx ky hi bd kz la lb lc ld le lf lg lh jg li lj lk jk ll lm ln jo lo lp lq lr bi translated">为身份验证生成Kubernetes配置文件</h2><p id="2c8e" class="pw-post-body-paragraph iv iw hi ix b iy ls ja jb jc lt je jf jg lu ji jj jk lv jm jn jo lw jq jr js hb bi translated">我们需要生成一些<a class="ae iu" href="https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/" rel="noopener ugc nofollow" target="_blank"><strong class="ix hj">kube configs</strong></a>——Kubernetes配置文件——使Kubernetes客户端能够定位并认证到Kubernetes API服务器。</p><p id="ef54" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为此，我们将返回主文件夹，创建一个名为configs的文件夹，然后切换到该文件夹:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="aca6" class="kx ky hi ly b fi mc md l me mf">cd ~/<br/>mkdir -p configs<br/>cd configs/</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div class="er es np"><img src="../Images/afea403f3b46fa71906f5a735e26f23e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1004/format:webp/1*YTKuQu2kTh5yjtOS-yMcRA.png"/></div></figure><p id="00cf" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">kube let配置文件</strong></p><p id="8fe9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为每个工作节点生成一个kubeconfig:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="87a4" class="kx ky hi ly b fi mc md l me mf">for instance in worker-0 worker-1 worker-2; do<br/>  kubectl config set-cluster kubernetes-from-scratch \<br/>    --certificate-authority=../certs/ca.pem \<br/>    --embed-certs=true \<br/>    --server=<a class="ae iu" href="https://${KUBERNETES_PUBLIC_ADDRESS}:443" rel="noopener ugc nofollow" target="_blank">https://${KUBERNETES_PUBLIC_ADDRESS}:443</a> \<br/>    --kubeconfig=${instance}.kubeconfig</span><span id="f4bb" class="kx ky hi ly b fi mh md l me mf">kubectl config set-credentials system:node:${instance} \<br/>    --client-certificate=../certs/${instance}.pem \<br/>    --client-key=../certs/${instance}-key.pem \<br/>    --embed-certs=true \<br/>    --kubeconfig=${instance}.kubeconfig</span><span id="f750" class="kx ky hi ly b fi mh md l me mf">kubectl config set-context default \<br/>    --cluster=kubernetes-from-scratch \<br/>    --user=system:node:${instance} \<br/>    --kubeconfig=${instance}.kubeconfig</span><span id="53c3" class="kx ky hi ly b fi mh md l me mf">kubectl config use-context default --kubeconfig=${instance}.kubeconfig<br/>done</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div class="er es nq"><img src="../Images/9a3a19bda131e3ebfbfc37aeee7f3e2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1208/format:webp/1*WwR2uri-PnvVeEmu0zTQfw.png"/></div></figure><p id="0393" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">kube-proxy Kubernets配置文件</strong></p><p id="a4bb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为<strong class="ix hj"> kube-proxy </strong>服务生成kubeconfig文件:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="31fa" class="kx ky hi ly b fi mc md l me mf">kubectl config set-cluster kubernetes-from-scratch \<br/>  --certificate-authority=../certs/ca.pem \<br/>  --embed-certs=true \<br/>  --server=<a class="ae iu" href="https://${KUBERNETES_PUBLIC_ADDRESS}:443" rel="noopener ugc nofollow" target="_blank">https://${KUBERNETES_PUBLIC_ADDRESS}:443</a> \<br/>  --kubeconfig=kube-proxy.kubeconfig</span><span id="ee33" class="kx ky hi ly b fi mh md l me mf">kubectl config set-credentials system:kube-proxy \<br/>  --client-certificate=../certs/kube-proxy.pem \<br/>  --client-key=../certs/kube-proxy-key.pem \<br/>  --embed-certs=true \<br/>  --kubeconfig=kube-proxy.kubeconfig</span><span id="b675" class="kx ky hi ly b fi mh md l me mf">kubectl config set-context default \<br/>  --cluster=kubernetes-from-scratch \<br/>  --user=system:kube-proxy \<br/>  --kubeconfig=kube-proxy.kubeconfig</span><span id="f42f" class="kx ky hi ly b fi mh md l me mf">kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nr"><img src="../Images/8df534cc7e4395e8ca767776ba5ae1aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_Qf1Xb9TsH-GMvTcGZNoDQ.png"/></div></div></figure><p id="55b8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">kube-控制器-管理器Kubernetes配置文件</strong></p><p id="3ee9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为<strong class="ix hj">kube-controller-manager</strong>服务生成kubeconfig文件:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="e158" class="kx ky hi ly b fi mc md l me mf">kubectl config set-cluster kubernetes-from-scratch \<br/>  --certificate-authority=../certs/ca.pem \<br/>  --embed-certs=true \<br/>  --server=<a class="ae iu" href="https://127.0.0.1:6443" rel="noopener ugc nofollow" target="_blank">https://127.0.0.1:6443</a> \<br/>  --kubeconfig=kube-controller-manager.kubeconfig</span><span id="1919" class="kx ky hi ly b fi mh md l me mf">kubectl config set-credentials system:kube-controller-manager \<br/>  --client-certificate=../certs/kube-controller-manager.pem \<br/>  --client-key=../certs/kube-controller-manager-key.pem \<br/>  --embed-certs=true \<br/>  --kubeconfig=kube-controller-manager.kubeconfig</span><span id="afbc" class="kx ky hi ly b fi mh md l me mf">kubectl config set-context default \<br/>  --cluster=kubernetes-from-scratch \<br/>  --user=system:kube-controller-manager \<br/>  --kubeconfig=kube-controller-manager.kubeconfig</span><span id="dcf1" class="kx ky hi ly b fi mh md l me mf">kubectl config use-context default --kubeconfig=kube-controller-manager.kubeconfig</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ns"><img src="../Images/ca8db03e17bd950157244382fa537723.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ydoQg2GMa3omEl5Zq6oEKg.png"/></div></div></figure><p id="2b06" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">kube-scheduler Kubernetes配置文件</strong></p><p id="97c6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为<strong class="ix hj"> kube-scheduler </strong>服务生成一个kubeconfig文件:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="1dd7" class="kx ky hi ly b fi mc md l me mf">kubectl config set-cluster kubernetes-from-scratch \<br/>  --certificate-authority=../certs/ca.pem \<br/>  --embed-certs=true \<br/>  --server=<a class="ae iu" href="https://127.0.0.1:6443" rel="noopener ugc nofollow" target="_blank">https://127.0.0.1:6443</a> \<br/>  --kubeconfig=kube-scheduler.kubeconfig</span><span id="ec8f" class="kx ky hi ly b fi mh md l me mf">kubectl config set-credentials system:kube-scheduler \<br/>  --client-certificate=../certs/kube-scheduler.pem \<br/>  --client-key=../certs/kube-scheduler-key.pem \<br/>  --embed-certs=true \<br/>  --kubeconfig=kube-scheduler.kubeconfig</span><span id="5d17" class="kx ky hi ly b fi mh md l me mf">kubectl config set-context default \<br/>  --cluster=kubernetes-from-scratch \<br/>  --user=system:kube-scheduler \<br/>  --kubeconfig=kube-scheduler.kubeconfig</span><span id="7f11" class="kx ky hi ly b fi mh md l me mf">kubectl config use-context default --kubeconfig=kube-scheduler.kubeconfig</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nt"><img src="../Images/eef524887c14fb852e482aa740761420.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4fpiXR_SL8qtilsj9v26kg.png"/></div></div></figure><p id="d82a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">管理员Kubernetes配置文件</strong></p><p id="617f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为<strong class="ix hj">管理员</strong>用户生成一个kubeconfig文件:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="fd5b" class="kx ky hi ly b fi mc md l me mf">kubectl config set-cluster kubernetes-from-scratch \<br/>  --certificate-authority=../certs/ca.pem \<br/>  --embed-certs=true \<br/>  --server=<a class="ae iu" href="https://127.0.0.1:6443" rel="noopener ugc nofollow" target="_blank">https://127.0.0.1:6443</a> \<br/>  --kubeconfig=admin.kubeconfig</span><span id="3c05" class="kx ky hi ly b fi mh md l me mf">kubectl config set-credentials admin \<br/>  --client-certificate=../certs/admin.pem \<br/>  --client-key=../certs/admin-key.pem \<br/>  --embed-certs=true \<br/>  --kubeconfig=admin.kubeconfig</span><span id="e13c" class="kx ky hi ly b fi mh md l me mf">kubectl config set-context default \<br/>  --cluster=kubernetes-from-scratch \<br/>  --user=admin \<br/>  --kubeconfig=admin.kubeconfig</span><span id="60b4" class="kx ky hi ly b fi mh md l me mf">kubectl config use-context default --kubeconfig=admin.kubeconfig</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nr"><img src="../Images/276c04611f35a9ac08950f0a0cd5f950.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uyLsh7wlzAfiZ8u_9e03ew.png"/></div></div></figure><p id="e6f8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">分发Kubernetes配置文件</strong></p><p id="c823" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将<strong class="ix hj"> kubelet </strong>和<strong class="ix hj"> kube-proxy </strong> kubeconfig文件复制到每个worker实例中:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="318b" class="kx ky hi ly b fi mc md l me mf">for instance in worker-0 worker-1 worker-2; do<br/>  external_ip=$(aws ec2 describe-instances --filters \<br/>    "Name=tag:Name,Values=${instance}" \<br/>    "Name=instance-state-name,Values=running" \<br/>    --output text --query 'Reservations[].Instances[].PublicIpAddress')</span><span id="18b0" class="kx ky hi ly b fi mh md l me mf">scp -i ../kubernetes.id_rsa \<br/>    ${instance}.kubeconfig kube-proxy.kubeconfig ubuntu@${external_ip}:~/<br/>done</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nu"><img src="../Images/c0896a8d15d518367bff5e58063048b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L5VI8ok4AVtZnUGAP9dBqQ.png"/></div></div></figure><p id="2dab" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">请注意，我们在<strong class="ix hj"> configs/ </strong>文件夹中，所以我添加了<strong class="ix hj">../kubernetes.id_rsa </strong> —这是我们之前所在目录的上一级目录，以防您遇到权限被拒绝的错误。</p><p id="d55f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将<strong class="ix hj">kube-controller-manager</strong>和<strong class="ix hj">kube-scheduler</strong>kube config文件复制到每个控制器实例:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="d43f" class="kx ky hi ly b fi mc md l me mf">for instance in controller-0 controller-1 controller-2; do<br/>  external_ip=$(aws ec2 describe-instances --filters \<br/>    "Name=tag:Name,Values=${instance}" \<br/>    "Name=instance-state-name,Values=running" \<br/>    --output text --query 'Reservations[].Instances[].PublicIpAddress')<br/>  <br/>  scp -i ../kubernetes.id_rsa \<br/>    admin.kubeconfig kube-controller-manager.kubeconfig kube-scheduler.kubeconfig ubuntu@${external_ip}:~/<br/>done</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nv"><img src="../Images/8608085b84bd93e31cffe521b46736a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2iCnRqBWgDKdmA7Yd4YyDg.png"/></div></div></figure><p id="9f5b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">请注意，我们在<strong class="ix hj"> configs/ </strong>文件夹中，所以我添加了<strong class="ix hj">../kubernetes.id_rsa </strong> —这是我们之前所在目录的上一级目录，以防您遇到权限被拒绝的错误。</p></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><h2 id="5f27" class="kx ky hi bd kz la lb lc ld le lf lg lh jg li lj lk jk ll lm ln jo lo lp lq lr bi translated">生成数据加密配置和密钥</h2><p id="9e02" class="pw-post-body-paragraph iv iw hi ix b iy ls ja jb jc lt je jf jg lu ji jj jk lv jm jn jo lw jq jr js hb bi translated">Kubernetes存储各种数据，包括集群状态、应用程序配置和秘密。Kubernetes支持<a class="ae iu" href="https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data" rel="noopener ugc nofollow" target="_blank">加密</a>静态集群数据的能力。</p><p id="ee5c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为此，我们需要生成一个加密密钥和一个适合加密Kubernetes秘密的<a class="ae iu" href="https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/#understanding-the-encryption-at-rest-configuration" rel="noopener ugc nofollow" target="_blank">加密配置</a>。</p><p id="5b33" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为此，我们将返回我们的主文件夹，创建一个名为<strong class="ix hj"> encryption </strong>的文件夹，然后切换到该文件夹:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="9fc3" class="kx ky hi ly b fi mc md l me mf">cd ~/<br/>mkdir -p encryption<br/>cd encryption/</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div class="er es nw"><img src="../Images/d5eeb7550b73b01d9a7df0c67e71eca4.png" data-original-src="https://miro.medium.com/v2/resize:fit:784/format:webp/1*rxvKq6eKRC9f_5wV-VSheA.png"/></div></figure><p id="6665" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">加密密钥</strong></p><p id="7a9d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">生成加密密钥:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="2612" class="kx ky hi ly b fi mc md l me mf">ENCRYPTION_KEY=$(head -c 32 /dev/urandom | base64)</span></pre><p id="6bd8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">加密配置</strong></p><p id="7679" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建<strong class="ix hj"> encryption-config.yaml </strong>加密配置文件:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="eef2" class="kx ky hi ly b fi mc md l me mf">cat &gt; encryption-config.yaml &lt;&lt;EOF<br/>kind: EncryptionConfig<br/>apiVersion: v1<br/>resources:<br/>  - resources:<br/>      - secrets<br/>    providers:<br/>      - aescbc:<br/>          keys:<br/>            - name: key1<br/>              secret: ${ENCRYPTION_KEY}<br/>      - identity: {}<br/>EOF</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div class="er es nx"><img src="../Images/4caf95e1231472d2083dae549829daf7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1098/format:webp/1*dBWe7t3iB3_3_4bdQvX95A.png"/></div></figure><p id="2901" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将<strong class="ix hj"> encryption-config.yaml </strong>加密配置文件复制到每个控制器实例中；</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="c5be" class="kx ky hi ly b fi mc md l me mf">for instance in controller-0 controller-1 controller-2; do<br/>  external_ip=$(aws ec2 describe-instances --filters \<br/>    "Name=tag:Name,Values=${instance}" \<br/>    "Name=instance-state-name,Values=running" \<br/>    --output text --query 'Reservations[].Instances[].PublicIpAddress')<br/>  <br/>  scp -i ../kubernetes.id_rsa encryption-config.yaml ubuntu@${external_ip}:~/<br/>done</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mv"><img src="../Images/6946a55e985cc03654926c818c2ce041.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GGvrDptSRba9UWa_FE5xow.png"/></div></div></figure></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><p id="d504" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">引导etcd集群</strong></p><p id="25e4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们首先回到我们的主目录:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="0f10" class="kx ky hi ly b fi mc md l me mf">cd ~/</span></pre><p id="dcc2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Kubernetes组件是无状态的，将集群状态存储在<a class="ae iu" href="https://github.com/etcd-io/etcd" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj"> etcd </strong> </a>中。我们将配置一个三节点etcd集群，并针对HA(高可用性)和安全远程访问进行配置。</p><p id="1a3a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下一个命令将生成我们的SSH命令行参数，以便能够连接到我们的控制器实例:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="e019" class="kx ky hi ly b fi mc md l me mf">for instance in controller-0 controller-1 controller-2; do<br/>  external_ip=$(aws ec2 describe-instances --filters \<br/>    "Name=tag:Name,Values=${instance}" \<br/>    "Name=instance-state-name,Values=running" \<br/>    --output text --query 'Reservations[].Instances[].PublicIpAddress')</span><span id="9381" class="kx ky hi ly b fi mh md l me mf">echo ssh -i kubernetes.id_rsa ubuntu@$external_ip<br/>done</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ny"><img src="../Images/45b1d716fd5364ccb35df6fbc171b401.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DVaNOTxv-Aw6YzED9Zz8eg.png"/></div></div></figure><p id="31fb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在可以使用tmux创建多个窗格并连接到每个实例。我使用AWS CloudShell，所以我将创建单独的行:</p><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nz"><img src="../Images/db47ee2e41774d8b7de535d7e9aa9037.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5fSoVjaaknViJSP8CQyKZA.png"/></div></div></figure><figure class="kb kc kd ke fd ij er es paragraph-image"><div class="er es oa"><img src="../Images/04bb437ef6177e059f8bca6de55b57a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*npqAMpbBfw0MADaZA6n5Gg.png"/></div></figure><figure class="kb kc kd ke fd ij er es paragraph-image"><div class="er es ob"><img src="../Images/4cf0d5fad49805124e8f05396257a59c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1130/format:webp/1*Djgdl3TWRzpaU1ZaqVfrYw.png"/></div></figure><p id="f3cf" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">引导和etcd集群成员</strong></p><p id="dd44" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">登录到每个控制器节点后，我们现在需要从<a class="ae iu" href="https://github.com/etcd-io/etcd" rel="noopener ugc nofollow" target="_blank"><strong class="ix hj">etcd GitHub</strong></a>proe jct下载正式的etcd发布二进制文件(在每个节点上运行这个程序):</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="79ec" class="kx ky hi ly b fi mc md l me mf">wget -q --timestamping \<br/>  "<a class="ae iu" href="https://github.com/etcd-io/etcd/releases/download/v3.4.15/etcd-v3.4.15-linux-amd64.tar.gz" rel="noopener ugc nofollow" target="_blank">https://github.com/etcd-io/etcd/releases/download/v3.4.15/etcd-v3.4.15-linux-amd64.tar.gz</a>"</span><span id="d510" class="kx ky hi ly b fi mh md l me mf">tar -xvf etcd-v3.4.15-linux-amd64.tar.gz</span><span id="87dc" class="kx ky hi ly b fi mh md l me mf">sudo mv etcd-v3.4.15-linux-amd64/etcd* /usr/local/bin/</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div class="er es oc"><img src="../Images/5b5e0fa327df3e22081d0432839360c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1172/format:webp/1*U7SMKsYzD8EmG5qu_TsuLA.png"/></div></figure><p id="5ad3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">配置etcd服务器</strong></p><p id="e3fc" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">接下来，我们创建必要的配置文件夹，并复制证书和密钥。我们还获得了节点的内部IP地址，以便在配置文件中使用。我们还需要在etcd集群中设置一个唯一的名称。记住在每个控制器实例中运行一次:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="ab87" class="kx ky hi ly b fi mc md l me mf">sudo mkdir -p /etc/etcd /var/lib/etcd<br/>sudo chmod 700 /var/lib/etcd<br/>sudo cp ca.pem kubernetes-key.pem kubernetes.pem /etc/etcd/</span><span id="2d6e" class="kx ky hi ly b fi mh md l me mf">INTERNAL_IP=$(curl -s <a class="ae iu" href="http://169.254.169.254/latest/meta-data/local-ipv4" rel="noopener ugc nofollow" target="_blank">http://169.254.169.254/latest/meta-data/local-ipv4</a>)</span><span id="09b0" class="kx ky hi ly b fi mh md l me mf">ETCD_NAME=$(curl -s <a class="ae iu" href="http://169.254.169.254/latest/user-data/" rel="noopener ugc nofollow" target="_blank">http://169.254.169.254/latest/user-data/</a> \<br/>  | tr "|" "\n" | grep "^name" | cut -d"=" -f2)<br/>echo "${ETCD_NAME}"</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div class="er es od"><img src="../Images/3a72bb8a54ff13a71664032162ce604a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1350/format:webp/1*kx0RoVLMxtkKSeEliNqpag.png"/></div></figure><p id="d256" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们希望确保etcd在引导时在每个控制器上启动，因此我们需要创建一个<strong class="ix hj"> etcd.service </strong> systemd单元文件，并启用和启动etcd服务(记住在每个控制器节点上运行该文件):</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="313f" class="kx ky hi ly b fi mc md l me mf">cat &lt;&lt;EOF | sudo tee /etc/systemd/system/etcd.service<br/>[Unit]<br/>Description=etcd<br/>Documentation=<a class="ae iu" href="https://github.com/coreos" rel="noopener ugc nofollow" target="_blank">https://github.com/coreos</a></span><span id="15c0" class="kx ky hi ly b fi mh md l me mf">[Service]<br/>Type=notify<br/>ExecStart=/usr/local/bin/etcd \\<br/>  --name ${ETCD_NAME} \\<br/>  --cert-file=/etc/etcd/kubernetes.pem \\<br/>  --key-file=/etc/etcd/kubernetes-key.pem \\<br/>  --peer-cert-file=/etc/etcd/kubernetes.pem \\<br/>  --peer-key-file=/etc/etcd/kubernetes-key.pem \\<br/>  --trusted-ca-file=/etc/etcd/ca.pem \\<br/>  --peer-trusted-ca-file=/etc/etcd/ca.pem \\<br/>  --peer-client-cert-auth \\<br/>  --client-cert-auth \\<br/>  --initial-advertise-peer-urls <a class="ae iu" href="https://${INTERNAL_IP}:2380" rel="noopener ugc nofollow" target="_blank">https://${INTERNAL_IP}:2380</a> \\<br/>  --listen-peer-urls <a class="ae iu" href="https://${INTERNAL_IP}:2380" rel="noopener ugc nofollow" target="_blank">https://${INTERNAL_IP}:2380</a> \\<br/>  --listen-client-urls <a class="ae iu" href="https://${INTERNAL_IP}:2379,https://127.0.0.1:2379" rel="noopener ugc nofollow" target="_blank">https://${INTERNAL_IP}:2379,https://127.0.0.1:2379</a> \\<br/>  --advertise-client-urls <a class="ae iu" href="https://${INTERNAL_IP}:2379" rel="noopener ugc nofollow" target="_blank">https://${INTERNAL_IP}:2379</a> \\<br/>  --initial-cluster-token etcd-cluster-0 \\<br/>  --initial-cluster controller-0=<a class="ae iu" href="https://10.0.1.10:2380,controller-1=https://10.0.1.11:2380,controller-2=https://10.0.1.12:2380" rel="noopener ugc nofollow" target="_blank">https://10.0.1.10:2380,controller-1=https://10.0.1.11:2380,controller-2=https://10.0.1.12:2380</a> \\<br/>  --initial-cluster-state new \\<br/>  --data-dir=/var/lib/etcd<br/>Restart=on-failure<br/>RestartSec=5</span><span id="868a" class="kx ky hi ly b fi mh md l me mf">[Install]<br/>WantedBy=multi-user.target<br/>EOF</span><span id="36ce" class="kx ky hi ly b fi mh md l me mf">sudo systemctl daemon-reload<br/>sudo systemctl enable etcd<br/>sudo systemctl start etcd</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nn"><img src="../Images/2a91f5bbcf5275adbbff637e2cde627e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Db1DMt3UhDEcmdxyCD7f_A.png"/></div></div></figure><p id="d10a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以通过运行以下命令来检查<strong class="ix hj"> etcd </strong>服务的状态:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="351b" class="kx ky hi ly b fi mc md l me mf">sudo service etcd status</span></pre><p id="bdf9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们还可以通过运行以下命令来验证etcd集群成员:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="d666" class="kx ky hi ly b fi mc md l me mf">sudo ETCDCTL_API=3 etcdctl member list \<br/>  --endpoints=<a class="ae iu" href="https://127.0.0.1:2379" rel="noopener ugc nofollow" target="_blank">https://127.0.0.1:2379</a> \<br/>  --cacert=/etc/etcd/ca.pem \<br/>  --cert=/etc/etcd/kubernetes.pem \<br/>  --key=/etc/etcd/kubernetes-key.pem</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div class="er es oe"><img src="../Images/6f35b31928c3df5617acde7b0adce982.png" data-original-src="https://miro.medium.com/v2/resize:fit:1302/format:webp/1*kr3VTd-JQ1FjOt4ezVzvFw.png"/></div></figure></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><h2 id="3099" class="kx ky hi bd kz la lb lc ld le lf lg lh jg li lj lk jk ll lm ln jo lo lp lq lr bi translated">引导Kubernetes控制平面</h2><p id="08f5" class="pw-post-body-paragraph iv iw hi ix b iy ls ja jb jc lt je jf jg lu ji jj jk lv jm jn jo lw jq jr js hb bi translated">我们将在每个控制器节点上安装以下组件:<a class="ae iu" href="https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj"> Kubernetes API服务器</strong> </a>、<a class="ae iu" href="https://kubernetes.io/docs/reference/command-line-tools-reference/kube-scheduler/" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj">调度器</strong> </a>和<a class="ae iu" href="https://kubernetes.io/docs/reference/command-line-tools-reference/kube-controller-manager/" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj">控制器管理器</strong> </a>。</p><p id="5239" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">确保您已经通过SSH登录到每个控制器节点，您可以通过运行以下命令获得SSH命令列表:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="30e3" class="kx ky hi ly b fi mc md l me mf">for instance in controller-0 controller-1 controller-2; do<br/>  external_ip=$(aws ec2 describe-instances --filters \<br/>    "Name=tag:Name,Values=${instance}" \<br/>    "Name=instance-state-name,Values=running" \<br/>    --output text --query 'Reservations[].Instances[].PublicIpAddress')</span><span id="4129" class="kx ky hi ly b fi mh md l me mf">echo ssh -i kubernetes.id_rsa ubuntu@$external_ip<br/>done</span></pre><p id="ffac" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">提供Kubernetes控制平面</strong></p><p id="f3f9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们将创建我们的目录结构，下载并安装二进制文件，复制我们需要的证书和密钥。我们还确定节点的内部IP地址，以便在我们的配置中使用它。</p><p id="3a4d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">请记住在我们的每个控制器节点上运行此命令:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="3133" class="kx ky hi ly b fi mc md l me mf">sudo mkdir -p /etc/kubernetes/config<br/>sudo mkdir -p /var/lib/kubernetes/</span><span id="33fe" class="kx ky hi ly b fi mh md l me mf">sudo mv ca.pem ca-key.pem kubernetes-key.pem kubernetes.pem \<br/>  service-account-key.pem service-account.pem \<br/>  encryption-config.yaml /var/lib/kubernetes/</span><span id="68f9" class="kx ky hi ly b fi mh md l me mf">wget -q --show-progress --https-only --timestamping \<br/>  "<a class="ae iu" href="https://storage.googleapis.com/kubernetes-release/release/v1.21.0/bin/linux/amd64/kube-apiserver" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/kubernetes-release/release/v1.21.0/bin/linux/amd64/kube-apiserver</a>" \<br/>  "<a class="ae iu" href="https://storage.googleapis.com/kubernetes-release/release/v1.21.0/bin/linux/amd64/kube-controller-manager" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/kubernetes-release/release/v1.21.0/bin/linux/amd64/kube-controller-manager</a>" \<br/>  "<a class="ae iu" href="https://storage.googleapis.com/kubernetes-release/release/v1.21.0/bin/linux/amd64/kube-scheduler" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/kubernetes-release/release/v1.21.0/bin/linux/amd64/kube-scheduler</a>" \<br/>  "<a class="ae iu" href="https://storage.googleapis.com/kubernetes-release/release/v1.21.0/bin/linux/amd64/kubectl" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/kubernetes-release/release/v1.21.0/bin/linux/amd64/kubectl</a>"</span><span id="a493" class="kx ky hi ly b fi mh md l me mf">chmod +x kube-apiserver kube-controller-manager kube-scheduler kubectl<br/>sudo mv kube-apiserver kube-controller-manager kube-scheduler kubectl /usr/local/bin/</span><span id="39c2" class="kx ky hi ly b fi mh md l me mf">INTERNAL_IP=$(curl -s <a class="ae iu" href="http://169.254.169.254/latest/meta-data/local-ipv4" rel="noopener ugc nofollow" target="_blank">http://169.254.169.254/latest/meta-data/local-ipv4</a>)</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es no"><img src="../Images/e60f0f2e4a0017432e1c52013504ec53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f9WO71CMEOE0lm2T_v7JQQ.png"/></div></div></figure><p id="dbbb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们希望确保在引导时在每个控制器上启动了<strong class="ix hj"> kube-apiserver </strong>服务，因此我们需要创建一个<strong class="ix hj">kube-API server . service</strong>systemd单元文件(记得在每个控制器节点上运行这个文件):</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="274c" class="kx ky hi ly b fi mc md l me mf">cat &lt;&lt;EOF | sudo tee /etc/systemd/system/kube-apiserver.service<br/>[Unit]<br/>Description=Kubernetes API Server<br/>Documentation=<a class="ae iu" href="https://github.com/kubernetes/kubernetes" rel="noopener ugc nofollow" target="_blank">https://github.com/kubernetes/kubernetes</a></span><span id="9e48" class="kx ky hi ly b fi mh md l me mf">[Service]<br/>ExecStart=/usr/local/bin/kube-apiserver \\<br/>  --advertise-address=${INTERNAL_IP} \\<br/>  --allow-privileged=true \\<br/>  --apiserver-count=3 \\<br/>  --audit-log-maxage=30 \\<br/>  --audit-log-maxbackup=3 \\<br/>  --audit-log-maxsize=100 \\<br/>  --audit-log-path=/var/log/audit.log \\<br/>  --authorization-mode=Node,RBAC \\<br/>  --bind-address=0.0.0.0 \\<br/>  --client-ca-file=/var/lib/kubernetes/ca.pem \\<br/>  --enable-admission-plugins=NamespaceLifecycle,NodeRestriction,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota \\<br/>  --etcd-cafile=/var/lib/kubernetes/ca.pem \\<br/>  --etcd-certfile=/var/lib/kubernetes/kubernetes.pem \\<br/>  --etcd-keyfile=/var/lib/kubernetes/kubernetes-key.pem \\<br/>  --etcd-servers=<a class="ae iu" href="https://10.0.1.10:2379,https://10.0.1.11:2379,https://10.0.1.12:2379" rel="noopener ugc nofollow" target="_blank">https://10.0.1.10:2379,https://10.0.1.11:2379,https://10.0.1.12:2379</a> \\<br/>  --event-ttl=1h \\<br/>  --encryption-provider-config=/var/lib/kubernetes/encryption-config.yaml \\<br/>  --kubelet-certificate-authority=/var/lib/kubernetes/ca.pem \\<br/>  --kubelet-client-certificate=/var/lib/kubernetes/kubernetes.pem \\<br/>  --kubelet-client-key=/var/lib/kubernetes/kubernetes-key.pem \\<br/>  --runtime-config='api/all=true' \\<br/>  --service-account-key-file=/var/lib/kubernetes/service-account.pem \\<br/>  --service-account-signing-key-file=/var/lib/kubernetes/service-account-key.pem \\<br/>  --service-account-issuer=<a class="ae iu" href="https://${KUBERNETES_PUBLIC_ADDRESS}:443" rel="noopener ugc nofollow" target="_blank">https://${KUBERNETES_PUBLIC_ADDRESS}:443</a> \\<br/>  --service-cluster-ip-range=10.32.0.0/24 \\<br/>  --service-node-port-range=30000-32767 \\<br/>  --tls-cert-file=/var/lib/kubernetes/kubernetes.pem \\<br/>  --tls-private-key-file=/var/lib/kubernetes/kubernetes-key.pem \\<br/>  --v=2<br/>Restart=on-failure<br/>RestartSec=5</span><span id="017f" class="kx ky hi ly b fi mh md l me mf">[Install]<br/>WantedBy=multi-user.target<br/>EOF</span></pre><p id="bd73" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">配置Kubernetes控制器管理器</strong></p><p id="31d3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将<strong class="ix hj">kube-controller-manager</strong>kube config移动到位(记住在每个控制器节点上运行此操作):</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="7fa5" class="kx ky hi ly b fi mc md l me mf">sudo mv kube-controller-manager.kubeconfig /var/lib/kubernetes/</span></pre><p id="b2ed" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建<strong class="ix hj">kube-controller-manager . service</strong>systemd单元文件(记得在每个控制器节点上运行这个文件):</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="e4ee" class="kx ky hi ly b fi mc md l me mf">cat &lt;&lt;EOF | sudo tee /etc/systemd/system/kube-controller-manager.service<br/>[Unit]<br/>Description=Kubernetes Controller Manager<br/>Documentation=<a class="ae iu" href="https://github.com/kubernetes/kubernetes" rel="noopener ugc nofollow" target="_blank">https://github.com/kubernetes/kubernetes</a></span><span id="d185" class="kx ky hi ly b fi mh md l me mf">[Service]<br/>ExecStart=/usr/local/bin/kube-controller-manager \\<br/>  --bind-address=0.0.0.0 \\<br/>  --cluster-cidr=10.200.0.0/16 \\<br/>  --cluster-name=kubernetes \\<br/>  --cluster-signing-cert-file=/var/lib/kubernetes/ca.pem \\<br/>  --cluster-signing-key-file=/var/lib/kubernetes/ca-key.pem \\<br/>  --kubeconfig=/var/lib/kubernetes/kube-controller-manager.kubeconfig \\<br/>  --leader-elect=true \\<br/>  --root-ca-file=/var/lib/kubernetes/ca.pem \\<br/>  --service-account-private-key-file=/var/lib/kubernetes/service-account-key.pem \\<br/>  --service-cluster-ip-range=10.32.0.0/24 \\<br/>  --use-service-account-credentials=true \\<br/>  --v=2<br/>Restart=on-failure<br/>RestartSec=5</span><span id="3506" class="kx ky hi ly b fi mh md l me mf">[Install]<br/>WantedBy=multi-user.target<br/>EOF</span></pre><p id="c5a4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">配置Kubernetes调度程序</strong></p><p id="7c1b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将<strong class="ix hj">kube-scheduler</strong>kube config移动到位(记住在每个控制器节点上运行该程序):</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="e65c" class="kx ky hi ly b fi mc md l me mf">sudo mv kube-scheduler.kubeconfig /var/lib/kubernetes/</span></pre><p id="cedb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建<strong class="ix hj"> kube-scheuduler.yaml </strong>配置文件:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="50c3" class="kx ky hi ly b fi mc md l me mf">cat &lt;&lt;EOF | sudo tee /etc/kubernetes/config/kube-scheduler.yaml<br/>apiVersion: kubescheduler.config.k8s.io/v1beta1<br/>kind: KubeSchedulerConfiguration<br/>clientConnection:<br/>  kubeconfig: "/var/lib/kubernetes/kube-scheduler.kubeconfig"<br/>leaderElection:<br/>  leaderElect: true<br/>EOF</span></pre><p id="bf32" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建<strong class="ix hj">kube-scheduler . service</strong>systemd单元文件:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="ff0b" class="kx ky hi ly b fi mc md l me mf">cat &lt;&lt;EOF | sudo tee /etc/systemd/system/kube-scheduler.service<br/>[Unit]<br/>Description=Kubernetes Scheduler<br/>Documentation=<a class="ae iu" href="https://github.com/kubernetes/kubernetes" rel="noopener ugc nofollow" target="_blank">https://github.com/kubernetes/kubernetes</a></span><span id="9d57" class="kx ky hi ly b fi mh md l me mf">[Service]<br/>ExecStart=/usr/local/bin/kube-scheduler \\<br/>  --config=/etc/kubernetes/config/kube-scheduler.yaml \\<br/>  --v=2<br/>Restart=on-failure<br/>RestartSec=5</span><span id="76f9" class="kx ky hi ly b fi mh md l me mf">[Install]<br/>WantedBy=multi-user.target<br/>EOF</span></pre><p id="3919" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">启用开机启动并启动控制器服务</strong></p><p id="12b4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">请记住在每个控制器节点上运行此命令:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="3120" class="kx ky hi ly b fi mc md l me mf">sudo systemctl daemon-reload<br/>sudo systemctl enable kube-apiserver kube-controller-manager kube-scheduler<br/>sudo systemctl start kube-apiserver kube-controller-manager kube-scheduler</span></pre><p id="a710" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">添加主机文件条目</strong></p><p id="ef45" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了让<strong class="ix hj"> kubectl exec </strong>命令工作，每个控制器节点都必须能够解析工作主机名称。这在AWS中不是默认设置的。解决方法是在每个控制器节点上添加手动主机条目:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="d69b" class="kx ky hi ly b fi mc md l me mf">cat &lt;&lt;EOF | sudo tee -a /etc/hosts<br/>10.0.1.20 ip-10-0-1-20<br/>10.0.1.21 ip-10-0-1-21<br/>10.0.1.22 ip-10-0-1-22<br/>EOF</span></pre><p id="7cc3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果错过此步骤，DNS群集加载项测试将失败，并显示如下错误:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="9e8b" class="kx ky hi ly b fi mc md l me mf">Error from server: error dialing backend: dial tcp: lookup ip-10-0-1-22 on 127.0.0.53:53: server misbehaving</span></pre><p id="a3ea" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">验证您可以在控制平面节点上访问Kubernetes集群</strong></p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="15ed" class="kx ky hi ly b fi mc md l me mf">kubectl cluster-info --kubeconfig admin.kubeconfig</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mw"><img src="../Images/67e0b4dc74e0be2eaabadfc3ddc41850.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fofDcw-Hgly3U73-ZAzQxQ.png"/></div></div></figure><p id="d17b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> RBAC对库伯莱的授权</strong></p><p id="a80e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们需要为Kubernetes API服务器设置角色和权限，以访问每个worker节点上的Kubelet API。在pods中检索指标、日志和执行命令需要访问Kubelet API。</p><p id="e860" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">本节中的命令将影响整个集群，并且只需要从其中一个控制器节点运行一次，下面的命令将打印出您应该用来连接到实例的SSH命令:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="1b49" class="kx ky hi ly b fi mc md l me mf">external_ip=$(aws ec2 describe-instances --filters \<br/>    "Name=tag:Name,Values=controller-0" \<br/>    "Name=instance-state-name,Values=running" \<br/>    --output text --query 'Reservations[].Instances[].PublicIpAddress')</span><span id="9801" class="kx ky hi ly b fi mh md l me mf">ssh -i kubernetes.id_rsa ubuntu@${external_ip}</span></pre><p id="1c84" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建<strong class="ix hj">system:kube-API server-to-ku delet</strong>cluster role，该角色有权访问Kubelet API并执行一些与管理pod相关的常见任务:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="af17" class="kx ky hi ly b fi mc md l me mf">cat &lt;&lt;EOF | kubectl apply --kubeconfig admin.kubeconfig -f -<br/>apiVersion: rbac.authorization.k8s.io/v1<br/>kind: ClusterRole<br/>metadata:<br/>  annotations:<br/>    rbac.authorization.kubernetes.io/autoupdate: "true"<br/>  labels:<br/>    kubernetes.io/bootstrapping: rbac-defaults<br/>  name: system:kube-apiserver-to-kubelet<br/>rules:<br/>  - apiGroups:<br/>      - ""<br/>    resources:<br/>      - nodes/proxy<br/>      - nodes/stats<br/>      - nodes/log<br/>      - nodes/spec<br/>      - nodes/metrics<br/>    verbs:<br/>      - "*"<br/>EOF</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div class="er es of"><img src="../Images/37b4aa964a400e9f1ec57f7e700d1902.png" data-original-src="https://miro.medium.com/v2/resize:fit:1140/format:webp/1*QtLJTBLq5p_sOx-0YM7x7g.png"/></div></figure><p id="f23c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将<strong class="ix hj">系统:kube-API server-to-kube let</strong>cluster role绑定到<strong class="ix hj"> kubernetes </strong>用户:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="544c" class="kx ky hi ly b fi mc md l me mf">cat &lt;&lt;EOF | kubectl apply --kubeconfig admin.kubeconfig -f -<br/>apiVersion: rbac.authorization.k8s.io/v1<br/>kind: ClusterRoleBinding<br/>metadata:<br/>  name: system:kube-apiserver<br/>  namespace: ""<br/>roleRef:<br/>  apiGroup: rbac.authorization.k8s.io<br/>  kind: ClusterRole<br/>  name: system:kube-apiserver-to-kubelet<br/>subjects:<br/>  - apiGroup: rbac.authorization.k8s.io<br/>    kind: User<br/>    name: kubernetes<br/>EOF</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div class="er es og"><img src="../Images/4f6e6a0228dbb639edbff1a7bd46729b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1188/format:webp/1*SiElro0-J5wCbov-R5Z34A.png"/></div></figure><p id="3862" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">验证集群公共端点</strong></p><p id="76b0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">注销SSH连接并返回到主终端窗口，因为您需要执行AWS命令来远程验证公共端点:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="408b" class="kx ky hi ly b fi mc md l me mf">KUBERNETES_PUBLIC_ADDRESS=$(aws elbv2 describe-load-balancers \<br/>  --load-balancer-arns ${LOAD_BALANCER_ARN} \<br/>  --output text --query 'LoadBalancers[].DNSName')</span><span id="a849" class="kx ky hi ly b fi mh md l me mf">curl --cacert certs/ca.pem https://${KUBERNETES_PUBLIC_ADDRESS}/version</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es oh"><img src="../Images/12650853d752590330395871f725869a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vWDd74teCRnajltmA5hfdg.png"/></div></div></figure></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><h2 id="01de" class="kx ky hi bd kz la lb lc ld le lf lg lh jg li lj lk jk ll lm ln jo lo lp lq lr bi translated">引导Kubernetes工作节点</h2><p id="0371" class="pw-post-body-paragraph iv iw hi ix b iy ls ja jb jc lt je jf jg lu ji jj jk lv jm jn jo lw jq jr js hb bi translated">每个节点上将安装以下组件:<a class="ae iu" href="https://github.com/opencontainers/runc" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj"> runc </strong> </a>，<a class="ae iu" href="https://github.com/containernetworking/cni" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj">容器联网插件</strong> </a>，<a class="ae iu" href="https://github.com/containerd/containerd" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj"> containerd </strong> </a>，<a class="ae iu" href="https://kubernetes.io/docs/admin/kubelet" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj"> kubelet </strong> </a>，以及<a class="ae iu" href="https://kubernetes.io/docs/concepts/cluster-administration/proxies" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj"> kube-proxy </strong> </a>。</p><p id="5036" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这些命令需要在每个worker实例上运行。让我们生成SSH命令列表:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="0d81" class="kx ky hi ly b fi mc md l me mf">for instance in worker-0 worker-1 worker-2; do<br/>  external_ip=$(aws ec2 describe-instances --filters \<br/>    "Name=tag:Name,Values=${instance}" \<br/>    "Name=instance-state-name,Values=running" \<br/>    --output text --query 'Reservations[].Instances[].PublicIpAddress')</span><span id="d1d9" class="kx ky hi ly b fi mh md l me mf">echo ssh -i kubernetes.id_rsa ubuntu@$external_ip<br/>done</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div class="er es oi"><img src="../Images/6c502c8b263acd28f689dfa307b7415a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1124/format:webp/1*w0X7nQADtMnsGlsa3foYaw.png"/></div></figure><p id="1533" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">SSH到一个单独的窗格中的每个实例。</p><figure class="kb kc kd ke fd ij er es paragraph-image"><div class="er es oj"><img src="../Images/b98b2d4a9ba7751f6dbf6f43e78307a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1058/format:webp/1*DVKLZSLdbVJLm95EoapWzA.png"/></div></figure><p id="61a1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">提供一个Kubernetes工人节点</strong></p><p id="479f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">安装操作系统依赖项，禁用交换，下载并安装工作二进制文件:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="ef5b" class="kx ky hi ly b fi mc md l me mf">sudo apt-get update<br/>sudo apt-get -y install socat conntrack ipset</span><span id="f1bf" class="kx ky hi ly b fi mh md l me mf">sudo swapon --show<br/>sudo swapoff -a</span><span id="956b" class="kx ky hi ly b fi mh md l me mf">wget -q --show-progress --https-only --timestamping \<br/>  <a class="ae iu" href="https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.21.0/crictl-v1.21.0-linux-amd64.tar.gz" rel="noopener ugc nofollow" target="_blank">https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.21.0/crictl-v1.21.0-linux-amd64.tar.gz</a> \<br/>  <a class="ae iu" href="https://github.com/opencontainers/runc/releases/download/v1.0.0-rc93/runc.amd64" rel="noopener ugc nofollow" target="_blank">https://github.com/opencontainers/runc/releases/download/v1.0.0-rc93/runc.amd64</a> \<br/>  <a class="ae iu" href="https://github.com/containernetworking/plugins/releases/download/v0.9.1/cni-plugins-linux-amd64-v0.9.1.tgz" rel="noopener ugc nofollow" target="_blank">https://github.com/containernetworking/plugins/releases/download/v0.9.1/cni-plugins-linux-amd64-v0.9.1.tgz</a> \<br/>  <a class="ae iu" href="https://github.com/containerd/containerd/releases/download/v1.4.4/containerd-1.4.4-linux-amd64.tar.gz" rel="noopener ugc nofollow" target="_blank">https://github.com/containerd/containerd/releases/download/v1.4.4/containerd-1.4.4-linux-amd64.tar.gz</a> \<br/>  <a class="ae iu" href="https://storage.googleapis.com/kubernetes-release/release/v1.21.0/bin/linux/amd64/kubectl" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/kubernetes-release/release/v1.21.0/bin/linux/amd64/kubectl</a> \<br/>  <a class="ae iu" href="https://storage.googleapis.com/kubernetes-release/release/v1.21.0/bin/linux/amd64/kube-proxy" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/kubernetes-release/release/v1.21.0/bin/linux/amd64/kube-proxy</a> \<br/>  <a class="ae iu" href="https://storage.googleapis.com/kubernetes-release/release/v1.21.0/bin/linux/amd64/kubelet" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/kubernetes-release/release/v1.21.0/bin/linux/amd64/kubelet</a></span><span id="56c8" class="kx ky hi ly b fi mh md l me mf">sudo mkdir -p \<br/>  /etc/cni/net.d \<br/>  /opt/cni/bin \<br/>  /var/lib/kubelet \<br/>  /var/lib/kube-proxy \<br/>  /var/lib/kubernetes \<br/>  /var/run/kubernetes</span><span id="aea6" class="kx ky hi ly b fi mh md l me mf">mkdir containerd<br/>tar -xvf crictl-v1.21.0-linux-amd64.tar.gz<br/>tar -xvf containerd-1.4.4-linux-amd64.tar.gz -C containerd<br/>sudo tar -xvf cni-plugins-linux-amd64-v0.9.1.tgz -C /opt/cni/bin/<br/>sudo mv runc.amd64 runc<br/>chmod +x crictl kubectl kube-proxy kubelet runc <br/>sudo mv crictl kubectl kube-proxy kubelet runc /usr/local/bin/<br/>sudo mv containerd/bin/* /bin/</span></pre><p id="1b3a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">配置CNI网络</strong></p><p id="d34a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">检索当前计算实例的Pod CIDR范围。创建网桥和环回配置(记得在每个工作节点上运行):</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="88ee" class="kx ky hi ly b fi mc md l me mf">POD_CIDR=$(curl -s <a class="ae iu" href="http://169.254.169.254/latest/user-data/" rel="noopener ugc nofollow" target="_blank">http://169.254.169.254/latest/user-data/</a> \<br/>  | tr "|" "\n" | grep "^pod-cidr" | cut -d"=" -f2)<br/>echo "${POD_CIDR}"</span><span id="ca74" class="kx ky hi ly b fi mh md l me mf">cat &lt;&lt;EOF | sudo tee /etc/cni/net.d/10-bridge.conf<br/>{<br/>    "cniVersion": "0.4.0",<br/>    "name": "bridge",<br/>    "type": "bridge",<br/>    "bridge": "cnio0",<br/>    "isGateway": true,<br/>    "ipMasq": true,<br/>    "ipam": {<br/>        "type": "host-local",<br/>        "ranges": [<br/>          [{"subnet": "${POD_CIDR}"}]<br/>        ],<br/>        "routes": [{"dst": "0.0.0.0/0"}]<br/>    }<br/>}<br/>EOF</span><span id="ef39" class="kx ky hi ly b fi mh md l me mf">cat &lt;&lt;EOF | sudo tee /etc/cni/net.d/99-loopback.conf<br/>{<br/>    "cniVersion": "0.4.0",<br/>    "name": "lo",<br/>    "type": "loopback"<br/>}<br/>EOF</span></pre><p id="38e3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">配置容器id</strong></p><p id="2861" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建一个<strong class="ix hj"> containerd </strong>配置文件，并创建<strong class="ix hj">container d . service</strong>systemd单元文件(记住要在每个worker节点上运行):</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="4273" class="kx ky hi ly b fi mc md l me mf">sudo mkdir -p /etc/containerd/</span><span id="38f3" class="kx ky hi ly b fi mh md l me mf">cat &lt;&lt; EOF | sudo tee /etc/containerd/config.toml<br/>[plugins]<br/>  [plugins.cri.containerd]<br/>    snapshotter = "overlayfs"<br/>    [plugins.cri.containerd.default_runtime]<br/>      runtime_type = "io.containerd.runtime.v1.linux"<br/>      runtime_engine = "/usr/local/bin/runc"<br/>      runtime_root = ""<br/>EOF</span><span id="c58a" class="kx ky hi ly b fi mh md l me mf">cat &lt;&lt;EOF | sudo tee /etc/systemd/system/containerd.service<br/>[Unit]<br/>Description=containerd container runtime<br/>Documentation=<a class="ae iu" href="https://containerd.io" rel="noopener ugc nofollow" target="_blank">https://containerd.io</a><br/>After=network.target</span><span id="fb69" class="kx ky hi ly b fi mh md l me mf">[Service]<br/>ExecStartPre=/sbin/modprobe overlay<br/>ExecStart=/bin/containerd<br/>Restart=always<br/>RestartSec=5<br/>Delegate=yes<br/>KillMode=process<br/>OOMScoreAdjust=-999<br/>LimitNOFILE=1048576<br/>LimitNPROC=infinity<br/>LimitCORE=infinity</span><span id="fadd" class="kx ky hi ly b fi mh md l me mf">[Install]<br/>WantedBy=multi-user.target<br/>EOF</span></pre><p id="7dc9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">配置Kubelet </strong></p><p id="b8f2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">移动并存储证书和密钥，并创建必要的文件夹和配置(记住在每个工作节点上运行):</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="4a41" class="kx ky hi ly b fi mc md l me mf">WORKER_NAME=$(curl -s <a class="ae iu" href="http://169.254.169.254/latest/user-data/" rel="noopener ugc nofollow" target="_blank">http://169.254.169.254/latest/user-data/</a> \<br/>| tr "|" "\n" | grep "^name" | cut -d"=" -f2)<br/>echo "${WORKER_NAME}"</span><span id="8f4e" class="kx ky hi ly b fi mh md l me mf">sudo mv ${WORKER_NAME}-key.pem ${WORKER_NAME}.pem /var/lib/kubelet/<br/>sudo mv ${WORKER_NAME}.kubeconfig /var/lib/kubelet/kubeconfig<br/>sudo mv ca.pem /var/lib/kubernetes/</span><span id="a3db" class="kx ky hi ly b fi mh md l me mf">cat &lt;&lt;EOF | sudo tee /var/lib/kubelet/kubelet-config.yaml<br/>kind: KubeletConfiguration<br/>apiVersion: kubelet.config.k8s.io/v1beta1<br/>authentication:<br/>  anonymous:<br/>    enabled: false<br/>  webhook:<br/>    enabled: true<br/>  x509:<br/>    clientCAFile: "/var/lib/kubernetes/ca.pem"<br/>authorization:<br/>  mode: Webhook<br/>clusterDomain: "cluster.local"<br/>clusterDNS:<br/>  - "10.32.0.10"<br/>podCIDR: "${POD_CIDR}"<br/>resolvConf: "/run/systemd/resolve/resolv.conf"<br/>runtimeRequestTimeout: "15m"<br/>tlsCertFile: "/var/lib/kubelet/${WORKER_NAME}.pem"<br/>tlsPrivateKeyFile: "/var/lib/kubelet/${WORKER_NAME}-key.pem"<br/>EOF</span></pre><p id="7b40" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> resolveConf </strong>配置用于在运行<strong class="ix hj"> systemd-resolved </strong>的系统上使用CoreDNS进行服务发现时避免循环。</p><p id="41fa" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建<strong class="ix hj">kube let . service</strong>systemd单元文件(记得在每个worker节点上运行):</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="72ec" class="kx ky hi ly b fi mc md l me mf">cat &lt;&lt;EOF | sudo tee /etc/systemd/system/kubelet.service<br/>[Unit]<br/>Description=Kubernetes Kubelet<br/>Documentation=<a class="ae iu" href="https://github.com/kubernetes/kubernetes" rel="noopener ugc nofollow" target="_blank">https://github.com/kubernetes/kubernetes</a><br/>After=containerd.service<br/>Requires=containerd.service</span><span id="ae3b" class="kx ky hi ly b fi mh md l me mf">[Service]<br/>ExecStart=/usr/local/bin/kubelet \\<br/>  --config=/var/lib/kubelet/kubelet-config.yaml \\<br/>  --container-runtime=remote \\<br/>  --container-runtime-endpoint=unix:///var/run/containerd/containerd.sock \\<br/>  --image-pull-progress-deadline=2m \\<br/>  --kubeconfig=/var/lib/kubelet/kubeconfig \\<br/>  --network-plugin=cni \\<br/>  --register-node=true \\<br/>  --v=2<br/>Restart=on-failure<br/>RestartSec=5</span><span id="83e6" class="kx ky hi ly b fi mh md l me mf">[Install]<br/>WantedBy=multi-user.target<br/>EOF</span></pre><p id="2922" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">配置Kubernetes代理</strong></p><p id="6bc5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将<strong class="ix hj"> kube-proxy </strong> kubeconfig移动到位，创建kube-proxy-config，最后创建<strong class="ix hj">kube-proxy . service</strong>systemd单元文件(记住在每个worker节点上运行):</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="25d3" class="kx ky hi ly b fi mc md l me mf">sudo mv kube-proxy.kubeconfig /var/lib/kube-proxy/kubeconfig</span><span id="5496" class="kx ky hi ly b fi mh md l me mf">cat &lt;&lt;EOF | sudo tee /var/lib/kube-proxy/kube-proxy-config.yaml<br/>kind: KubeProxyConfiguration<br/>apiVersion: kubeproxy.config.k8s.io/v1alpha1<br/>clientConnection:<br/>  kubeconfig: "/var/lib/kube-proxy/kubeconfig"<br/>mode: "iptables"<br/>clusterCIDR: "10.200.0.0/16"<br/>EOF</span><span id="4d8c" class="kx ky hi ly b fi mh md l me mf">cat &lt;&lt;EOF | sudo tee /etc/systemd/system/kube-proxy.service<br/>[Unit]<br/>Description=Kubernetes Kube Proxy<br/>Documentation=<a class="ae iu" href="https://github.com/kubernetes/kubernetes" rel="noopener ugc nofollow" target="_blank">https://github.com/kubernetes/kubernetes</a></span><span id="b282" class="kx ky hi ly b fi mh md l me mf">[Service]<br/>ExecStart=/usr/local/bin/kube-proxy \\<br/>  --config=/var/lib/kube-proxy/kube-proxy-config.yaml<br/>Restart=on-failure<br/>RestartSec=5</span><span id="d088" class="kx ky hi ly b fi mh md l me mf">[Install]<br/>WantedBy=multi-user.target<br/>EOF</span></pre><p id="7758" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">启用启动时启动并启动工人服务</strong></p><p id="dc5f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">记住在每个工作节点上运行:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="00a6" class="kx ky hi ly b fi mc md l me mf">sudo systemctl daemon-reload<br/>sudo systemctl enable containerd kubelet kube-proxy<br/>sudo systemctl start containerd kubelet kube-proxy</span></pre><p id="8047" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">验证一切正常</strong></p><p id="3ce5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">切换回拥有AWS权限的终端(不是登录的worker节点)并运行:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="1b9a" class="kx ky hi ly b fi mc md l me mf">external_ip=$(aws ec2 describe-instances --filters \<br/>    "Name=tag:Name,Values=controller-0" \<br/>    "Name=instance-state-name,Values=running" \<br/>    --output text --query 'Reservations[].Instances[].PublicIpAddress')</span><span id="7386" class="kx ky hi ly b fi mh md l me mf">ssh -i kubernetes.id_rsa ubuntu@${external_ip} kubectl get nodes --kubeconfig admin.kubeconfig</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ny"><img src="../Images/ab2ac470dfe706dcd705a0879da3bb7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2pcQakFXGd8mk_IV829oRQ.png"/></div></div></figure><p id="5016" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们可以看到3个工作节点启动并运行，并且<strong class="ix hj">就绪</strong>。</p></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><h2 id="360f" class="kx ky hi bd kz la lb lc ld le lf lg lh jg li lj lk jk ll lm ln jo lo lp lq lr bi translated">为远程访问配置kubectl</h2><p id="a500" class="pw-post-body-paragraph iv iw hi ix b iy ls ja jb jc lt je jf jg lu ji jj jk lv jm jn jo lw jq jr js hb bi translated">我们将根据<strong class="ix hj">管理员</strong>用户凭证为<strong class="ix hj"> kubectl </strong>命令行实用程序生成一个kubeconfig文件。</p><p id="a392" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">每个kubeconfig都需要一个Kubernetes API服务器来连接。为了支持HA(高可用性)，将使用面向Kubernetes API服务器的外部负载平衡器的DNS名称。</p><p id="4d31" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">生成一个适合作为<strong class="ix hj">管理员</strong>用户验证的kubeconfig文件:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="f75e" class="kx ky hi ly b fi mc md l me mf">cd ~</span><span id="a1be" class="kx ky hi ly b fi mh md l me mf">KUBERNETES_PUBLIC_ADDRESS=$(aws elbv2 describe-load-balancers \<br/>--load-balancer-arns ${LOAD_BALANCER_ARN} \<br/>--output text --query 'LoadBalancers[].DNSName')</span><span id="7b38" class="kx ky hi ly b fi mh md l me mf">kubectl config set-cluster kubernetes-from-scratch \<br/>  --certificate-authority=certs/ca.pem \<br/>  --embed-certs=true \<br/>  --server=<a class="ae iu" href="https://${KUBERNETES_PUBLIC_ADDRESS}:443" rel="noopener ugc nofollow" target="_blank">https://${KUBERNETES_PUBLIC_ADDRESS}:443</a></span><span id="058a" class="kx ky hi ly b fi mh md l me mf">kubectl config set-credentials admin \<br/>  --client-certificate=certs/admin.pem \<br/>  --client-key=certs/admin-key.pem</span><span id="84b7" class="kx ky hi ly b fi mh md l me mf">kubectl config set-context kubernetes-from-scratch \<br/>  --cluster=kubernetes-from-scratch \<br/>  --user=admin</span><span id="b7a1" class="kx ky hi ly b fi mh md l me mf">kubectl config use-context kubernetes-from-scratch</span></pre><p id="7432" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">验证一切正常</strong></p><p id="f9f3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">检查远程Kubernetes集群的版本:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="aede" class="kx ky hi ly b fi mc md l me mf">kubectl version<br/>kubectl get nodes<br/>kubectl config view</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ok"><img src="../Images/a3bbc02ad51ba098ef9c0bb7ec339606.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7kZDYvZnxqyzQPoqXMLmQA.png"/></div></div></figure></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><h2 id="b68a" class="kx ky hi bd kz la lb lc ld le lf lg lh jg li lj lk jk ll lm ln jo lo lp lq lr bi translated">供应Pod网络路由</h2><p id="2e45" class="pw-post-body-paragraph iv iw hi ix b iy ls ja jb jc lt je jf jg lu ji jj jk lv jm jn jo lw jq jr js hb bi translated">调度到一个节点的Pod从该节点的Pod CIDR范围接收IP地址。此时，由于缺少网络<a class="ae iu" href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Route_Tables.html" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj">路由</strong> </a>，吊舱无法与运行在不同节点上的其他吊舱通信。</p><p id="4369" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们将为每个工作节点创建一个路由，将节点的Pod CIDR范围映射到节点的内部IP地址。</p><p id="eb98" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然而，在生产工作负载中，该功能将由CNI插件提供，如法兰绒、calico、amazon-vpc-cni-k8s。手动这样做可以更容易理解那些插件在幕后做什么。</p><p id="6bde" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">打印每个工作实例的内部IP地址和Pod CIDR范围，并创建路由表条目:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="a521" class="kx ky hi ly b fi mc md l me mf">for instance in worker-0 worker-1 worker-2; do<br/>  instance_id_ip="$(aws ec2 describe-instances \<br/>    --filters "Name=tag:Name,Values=${instance}" \<br/>    --output text --query 'Reservations[].Instances[].[InstanceId,PrivateIpAddress]')"<br/>  instance_id="$(echo "${instance_id_ip}" | cut -f1)"<br/>  instance_ip="$(echo "${instance_id_ip}" | cut -f2)"<br/>  pod_cidr="$(aws ec2 describe-instance-attribute \<br/>    --instance-id "${instance_id}" \<br/>    --attribute userData \<br/>    --output text --query 'UserData.Value' \<br/>    | base64 --decode | tr "|" "\n" | grep "^pod-cidr" | cut -d'=' -f2)"<br/>  echo "${instance_ip} ${pod_cidr}"</span><span id="bf2f" class="kx ky hi ly b fi mh md l me mf">aws ec2 create-route \<br/>    --route-table-id "${ROUTE_TABLE_ID}" \<br/>    --destination-cidr-block "${pod_cidr}" \<br/>    --instance-id "${instance_id}"<br/>done</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div class="er es ol"><img src="../Images/79ace72b69bafc89d7c8be63cce3ac7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1214/format:webp/1*qBflefIAu3iY03Pu09-XEw.png"/></div></figure><p id="e96f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">验证路线</strong></p><p id="93ad" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">验证每个工作实例的网络路由:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="4bbf" class="kx ky hi ly b fi mc md l me mf">aws ec2 describe-route-tables \<br/>  --route-table-ids "${ROUTE_TABLE_ID}" \<br/>  --query 'RouteTables[].Routes'</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div class="er es om"><img src="../Images/8fd7e66b8d8d780d3aa4a47932000cb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:928/format:webp/1*EaxiSyZC-4yIFzQ9dUd8PQ.png"/></div></figure></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><p id="d55a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">部署DNS群集插件</strong></p><p id="20d9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们现在将部署DNS插件，该插件为Kubernetes集群中运行的应用程序提供基于DNS的服务发现，并由CoreDNS提供支持。</p><p id="05d5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">部署<strong class="ix hj"> coredns </strong>集群附加组件:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="afaa" class="kx ky hi ly b fi mc md l me mf">kubectl apply -f <a class="ae iu" href="https://storage.googleapis.com/kubernetes-the-hard-way/coredns-1.8.yaml" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/kubernetes-the-hard-way/coredns-1.8.yaml</a></span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es on"><img src="../Images/ed29029142b7c48f55068b8c8fe8b3db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tE8l0ZL1cBsf4CSgiQthnA.png"/></div></div></figure><p id="08bb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">由<strong class="ix hj">核心dns </strong>部署创建的列表窗格:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="306c" class="kx ky hi ly b fi mc md l me mf">kubectl get pods -l k8s-app=kube-dns -n kube-system</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div class="er es oo"><img src="../Images/13aa5275350f564aeb6412eef21b8a94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/format:webp/1*osWCrKJp2oTu7JjAdUZW2Q.png"/></div></figure><p id="9b12" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">确认一切正常</strong></p><p id="a2e3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建一个<strong class="ix hj"> busybox </strong>部署，然后列出pod:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="766d" class="kx ky hi ly b fi mc md l me mf">kubectl run busybox --image=busybox:1.28 --command -- sleep 3600</span><span id="b753" class="kx ky hi ly b fi mh md l me mf">kubectl get pods -l run=busybox</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div class="er es op"><img src="../Images/4ce96eedf2000fb1f67614663e1d7770.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/1*D55gTRISSIKB6Y0XvgJqNQ.png"/></div></figure><p id="9c0e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">检索<strong class="ix hj"> busybox </strong> pod的全名，并在<strong class="ix hj"> busybox </strong> pod中执行<strong class="ix hj"> kubernetes </strong>服务的DNS查找:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="9f4d" class="kx ky hi ly b fi mc md l me mf">POD_NAME=$(kubectl get pods -l run=busybox -o jsonpath="{.items[0].metadata.name}")</span><span id="eb77" class="kx ky hi ly b fi mh md l me mf">kubectl exec -ti $POD_NAME -- nslookup kubernetes</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es oq"><img src="../Images/0d29cce03b388f3df99ec781415b2571.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B3AT_SI0kHZ6912SE4_zeQ.png"/></div></div></figure></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><h2 id="9592" class="kx ky hi bd kz la lb lc ld le lf lg lh jg li lj lk jk ll lm ln jo lo lp lq lr bi translated">烟气试验</h2><p id="fdd9" class="pw-post-body-paragraph iv iw hi ix b iy ls ja jb jc lt je jf jg lu ji jj jk lv jm jn jo lw jq jr js hb bi translated"><strong class="ix hj">数据加密</strong></p><p id="2f48" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">通过创建一个通用<strong class="ix hj">秘密</strong>，然后使用<strong class="ix hj"> hexdump </strong>检查<strong class="ix hj"> etcd </strong>中存储的条目，验证加密静态秘密数据的能力:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="8bbe" class="kx ky hi ly b fi mc md l me mf">kubectl create secret generic kubernetes-from-scratch \<br/>  --from-literal="mykey=mydata"</span><span id="f285" class="kx ky hi ly b fi mh md l me mf">external_ip=$(aws ec2 describe-instances --filters \<br/>  "Name=tag:Name,Values=controller-0" \<br/>  "Name=instance-state-name,Values=running" \<br/>  --output text --query 'Reservations[].Instances[].PublicIpAddress')</span><span id="6229" class="kx ky hi ly b fi mh md l me mf">ssh -i kubernetes.id_rsa ubuntu@${external_ip} \<br/> "sudo ETCDCTL_API=3 etcdctl get \<br/>  --endpoints=<a class="ae iu" href="https://127.0.0.1:2379" rel="noopener ugc nofollow" target="_blank">https://127.0.0.1:2379</a> \<br/>  --cacert=/etc/etcd/ca.pem \<br/>  --cert=/etc/etcd/kubernetes.pem \<br/>  --key=/etc/etcd/kubernetes-key.pem\<br/>  /registry/secrets/default/kubernetes-from-scratch | hexdump -C"</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div class="er es or"><img src="../Images/a1b7a97652303a9ce7a7e57784d59a4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1274/format:webp/1*7jFxraEiOT1bVADlLG_Yfg.png"/></div></figure><p id="bf33" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">etcd密钥应该以<strong class="ix hj"> k8s:enc:aescbc:v1:key1 </strong>为前缀，这表明<strong class="ix hj"> aesbc </strong>提供程序被用于使用<strong class="ix hj"> key1 </strong>加密密钥加密数据。</p><p id="f253" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">创建部署</strong></p><p id="8646" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">部署一个<strong class="ix hj"> nginx </strong> web服务器并列出pod:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="13da" class="kx ky hi ly b fi mc md l me mf">kubectl create deployment nginx --image=nginx</span><span id="5d61" class="kx ky hi ly b fi mh md l me mf">kubectl get pods -l app=nginx</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div class="er es os"><img src="../Images/e25978faeba4035515c9738d6ade80bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/1*KUvrZ03I4qivB57KGYtoWg.png"/></div></figure><p id="bf60" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">端口转发</strong></p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="e48e" class="kx ky hi ly b fi mc md l me mf">POD_NAME=$(kubectl get pods -l app=nginx -o jsonpath="{.items[0].metadata.name}")</span><span id="3ef7" class="kx ky hi ly b fi mh md l me mf">kubectl port-forward $POD_NAME 8080:80</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ot"><img src="../Images/35926bcf6d59798b2d07fdb8e1d0b73e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jTkZMShGO65YqRiulADD0w.png"/></div></div></figure><p id="a170" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在新的终端窗口中，向端口转发端点执行HTTP请求:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="ded3" class="kx ky hi ly b fi mc md l me mf">curl --head <a class="ae iu" href="http://127.0.0.1:8080" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:8080</a></span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div class="er es ou"><img src="../Images/06b1ac0617c3f44eed0e036df3af4cfb.png" data-original-src="https://miro.medium.com/v2/resize:fit:950/format:webp/1*jQIxEN0Sj_EznfUKeTo42A.png"/></div></figure><p id="d509" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">日志</strong></p><p id="2465" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">打印<strong class="ix hj"> nginx </strong> pod日志:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="11ce" class="kx ky hi ly b fi mc md l me mf">kubectl logs $POD_NAME</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div class="er es ov"><img src="../Images/3f2cdbadf825a8ba98884e0a5a4f4b7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1326/format:webp/1*Imz1xHb_8qy2EiBTc6kBtg.png"/></div></figure><p id="39cc" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> Exec </strong></p><p id="eb87" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">验证我们能够在容器中<a class="ae iu" href="https://kubernetes.io/docs/tasks/debug-application-cluster/get-shell-running-container/#running-individual-commands-in-a-container" rel="noopener ugc nofollow" target="_blank">执行命令:</a></p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="c2ec" class="kx ky hi ly b fi mc md l me mf">kubectl exec -ti $POD_NAME -- nginx -v</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div class="er es ow"><img src="../Images/dc2b2d46d1461fd2d1ed79a98d9c98ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1050/format:webp/1*8gvEzERsP7hiipArVrx5Eg.png"/></div></figure><p id="ebe1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">服务</strong></p><p id="6ec9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用<a class="ae iu" href="https://kubernetes.io/docs/concepts/services-networking/service/#type-nodeport" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj">节点端口</strong> </a> <strong class="ix hj"> </strong> <a class="ae iu" href="https://kubernetes.io/docs/concepts/services-networking/service/" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj">服务</strong> </a> <strong class="ix hj"> : </strong>公开<strong class="ix hj"> nginx </strong>部署</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="bbb9" class="kx ky hi ly b fi mc md l me mf">kubectl expose deployment nginx --port 80 --type NodePort</span><span id="aa05" class="kx ky hi ly b fi mh md l me mf">NODE_PORT=$(kubectl get svc nginx \<br/>  --output=jsonpath='{range .spec.ports[0]}{.nodePort}')</span></pre><p id="d29a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建允许远程访问<strong class="ix hj"> nginx </strong>节点端口的防火墙规则:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="e698" class="kx ky hi ly b fi mc md l me mf">aws ec2 authorize-security-group-ingress \<br/>  --group-id ${SECURITY_GROUP_ID} \<br/>  --protocol tcp \<br/>  --port ${NODE_PORT} \<br/>  --cidr 0.0.0.0/0</span></pre><p id="9e11" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">获取运行<strong class="ix hj"> nginx </strong> pod的worker节点名称，并检索worker实例的外部IP地址，最后向外部IP地址和<strong class="ix hj"> nginx </strong>节点端口发出HTTP请求:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="d245" class="kx ky hi ly b fi mc md l me mf">INSTANCE_NAME=$(kubectl get pod $POD_NAME --output=jsonpath='{.spec.nodeName}')</span><span id="ba98" class="kx ky hi ly b fi mh md l me mf">EXTERNAL_IP=$(aws ec2 describe-instances --filters \<br/>    "Name=instance-state-name,Values=running" \<br/>    "Name=network-interface.private-dns-name,Values=${INSTANCE_NAME}.*.internal*" \<br/>    --output text --query 'Reservations[].Instances[].PublicIpAddress')</span><span id="2900" class="kx ky hi ly b fi mh md l me mf">curl -I <a class="ae iu" href="http://${EXTERNAL_IP}:${NODE_PORT" rel="noopener ugc nofollow" target="_blank">http://${EXTERNAL_IP}:${NODE_PORT</a>}</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ox"><img src="../Images/bc4b6cf0e9521140cf8198d06f56fe23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Reee1-1FpZYhdnI_JEs20w.png"/></div></div></figure></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><p id="a0b8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">奖励:使用kube-hunter扫描漏洞</strong></p><p id="da92" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://github.com/aquasecurity/kube-hunter" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj"> kube-hunter </strong> </a>搜寻Kubernetes集群中的安全弱点。开发该工具是为了提高Kubernetes环境中安全问题的意识和可见性。</p><p id="b37f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将作业直接部署到集群中以扫描漏洞:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="386f" class="kx ky hi ly b fi mc md l me mf">cat &lt;&lt;EOF | kubectl apply --kubeconfig admin.kubeconfig -f -<br/>apiVersion: batch/v1<br/>kind: Job<br/>metadata:<br/>  name: kube-hunter<br/>spec:<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: kube-hunter<br/>    spec:<br/>      containers:<br/>        - name: kube-hunter<br/>          image: aquasec/kube-hunter:0.6.8<br/>          command: ["kube-hunter"]<br/>          args: ["--pod"]<br/>      restartPolicy: Never<br/>EOF</span></pre><figure class="kb kc kd ke fd ij er es paragraph-image"><div class="er es oy"><img src="../Images/fa4b933ee76ef08ef9218f5a6b6ae2ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1066/format:webp/1*V-q_92y7v3y-_lvTOAaANg.png"/></div></figure><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="c8db" class="kx ky hi ly b fi mc md l me mf">kubectl logs --kubeconfig admin.kubeconfig kube-hunter-tws6b &gt; logs.txt</span><span id="345d" class="kx ky hi ly b fi mh md l me mf">cat logs.txt</span><span id="9773" class="kx ky hi ly b fi mh md l me mf">2022-07-08 14:22:13,466 INFO kube_hunter.modules.report.collector Started hunting</span><span id="fb06" class="kx ky hi ly b fi mh md l me mf">2022-07-08 14:22:13,471 INFO kube_hunter.modules.report.collector Discovering Open Kubernetes Services</span><span id="0799" class="kx ky hi ly b fi mh md l me mf">2022-07-08 14:22:13,478 INFO kube_hunter.modules.report.collector Found vulnerability "CAP_NET_RAW Enabled" in Local to Pod (kube-hunter-tws6b)</span><span id="64cd" class="kx ky hi ly b fi mh md l me mf">2022-07-08 14:22:13,478 INFO kube_hunter.modules.report.collector Found vulnerability "Read access to pod's service account token" in Local to Pod (kube-hunter-tws6b)</span><span id="07cb" class="kx ky hi ly b fi mh md l me mf">2022-07-08 14:22:13,479 INFO kube_hunter.modules.report.collector Found vulnerability "Access to pod's secrets" in Local to Pod (kube-hunter-tws6b)</span><span id="0ddc" class="kx ky hi ly b fi mh md l me mf">2022-07-08 14:22:13,515 INFO kube_hunter.modules.report.collector Found vulnerability "AWS Metadata Exposure" in Local to Pod (kube-hunter-tws6b)</span><span id="1d5b" class="kx ky hi ly b fi mh md l me mf">2022-07-08 14:22:13,678 INFO kube_hunter.modules.report.collector Found open service "Kubelet API" at 10.0.1.20:10250</span><span id="7df0" class="kx ky hi ly b fi mh md l me mf">2022-07-08 14:22:13,691 INFO kube_hunter.modules.report.collector Found open service "Kubelet API" at 10.0.1.21:10250</span><span id="da1c" class="kx ky hi ly b fi mh md l me mf">2022-07-08 14:22:13,694 INFO kube_hunter.modules.report.collector Found open service "Etcd" at 10.0.1.10:2379</span><span id="50f7" class="kx ky hi ly b fi mh md l me mf">2022-07-08 14:22:13,695 INFO kube_hunter.modules.report.collector Found open service "Kubelet API" at 10.0.1.22:10250</span><span id="212e" class="kx ky hi ly b fi mh md l me mf">2022-07-08 14:22:13,750 INFO kube_hunter.modules.report.collector Found open service "Etcd" at 10.0.1.12:2379</span><span id="a7ac" class="kx ky hi ly b fi mh md l me mf">2022-07-08 14:22:13,754 INFO kube_hunter.modules.report.collector Found open service "Etcd" at 10.0.1.11:2379</span><span id="a85e" class="kx ky hi ly b fi mh md l me mf">2022-07-08 14:22:13,817 INFO kube_hunter.modules.report.collector Found open service "Kubelet API" at 10.200.2.1:10250</span><span id="096a" class="kx ky hi ly b fi mh md l me mf">2022-07-08 14:22:13,821 INFO kube_hunter.modules.report.collector Found open service "Metrics Server" at 10.0.1.10:6443</span><span id="0305" class="kx ky hi ly b fi mh md l me mf">2022-07-08 14:22:13,825 INFO kube_hunter.modules.report.collector Found open service "Metrics Server" at 10.0.1.12:6443</span><span id="956f" class="kx ky hi ly b fi mh md l me mf">2022-07-08 14:22:13,857 INFO kube_hunter.modules.report.collector Found open service "Metrics Server" at 10.0.1.11:6443</span><span id="7e9c" class="kx ky hi ly b fi mh md l me mf">2022-07-08 14:22:21,218 INFO kube_hunter.modules.report.collector Found open service "Metrics Server" at 10.0.1.72:443</span><span id="4431" class="kx ky hi ly b fi mh md l me mf">2022-07-08 14:22:21,406 INFO kube_hunter.modules.report.collector Found open service "API Server" at 10.32.0.1:443</span><span id="a1aa" class="kx ky hi ly b fi mh md l me mf">2022-07-08 14:22:21,418 INFO kube_hunter.modules.report.collector Found vulnerability "K8s Version Disclosure" in 10.32.0.1:443</span><span id="c4d9" class="kx ky hi ly b fi mh md l me mf">2022-07-08 14:22:21,424 INFO kube_hunter.modules.report.collector Found vulnerability "Access to API using service account token" in 10.32.0.1:443</span><span id="847e" class="kx ky hi ly b fi mh md l me mf">Nodes</span><span id="5617" class="kx ky hi ly b fi mh md l me mf">+-------------+------------+</span><span id="3328" class="kx ky hi ly b fi mh md l me mf">| TYPE        | LOCATION   |</span><span id="c615" class="kx ky hi ly b fi mh md l me mf">+-------------+------------+</span><span id="e7a5" class="kx ky hi ly b fi mh md l me mf">| Node/Master | 10.200.2.1 |</span><span id="f398" class="kx ky hi ly b fi mh md l me mf">+-------------+------------+</span><span id="0ab6" class="kx ky hi ly b fi mh md l me mf">| Node/Master | 10.32.0.1  |</span><span id="9642" class="kx ky hi ly b fi mh md l me mf">+-------------+------------+</span><span id="9c41" class="kx ky hi ly b fi mh md l me mf">| Node/Master | 10.0.1.72  |</span><span id="f269" class="kx ky hi ly b fi mh md l me mf">+-------------+------------+</span><span id="a644" class="kx ky hi ly b fi mh md l me mf">| Node/Master | 10.0.1.22  |</span><span id="5027" class="kx ky hi ly b fi mh md l me mf">+-------------+------------+</span><span id="cc37" class="kx ky hi ly b fi mh md l me mf">| Node/Master | 10.0.1.21  |</span><span id="433f" class="kx ky hi ly b fi mh md l me mf">+-------------+------------+</span><span id="627f" class="kx ky hi ly b fi mh md l me mf">| Node/Master | 10.0.1.20  |</span><span id="13f9" class="kx ky hi ly b fi mh md l me mf">+-------------+------------+</span><span id="a3f6" class="kx ky hi ly b fi mh md l me mf">| Node/Master | 10.0.1.12  |</span><span id="e008" class="kx ky hi ly b fi mh md l me mf">+-------------+------------+</span><span id="5a36" class="kx ky hi ly b fi mh md l me mf">| Node/Master | 10.0.1.11  |</span><span id="df1d" class="kx ky hi ly b fi mh md l me mf">+-------------+------------+</span><span id="ee8b" class="kx ky hi ly b fi mh md l me mf">| Node/Master | 10.0.1.10  |</span><span id="9404" class="kx ky hi ly b fi mh md l me mf">+-------------+------------+</span><span id="7feb" class="kx ky hi ly b fi mh md l me mf">Detected Services</span><span id="0142" class="kx ky hi ly b fi mh md l me mf">+----------------+------------------+----------------------+</span><span id="f4c8" class="kx ky hi ly b fi mh md l me mf">| SERVICE        | LOCATION         | DESCRIPTION          |</span><span id="8507" class="kx ky hi ly b fi mh md l me mf">+----------------+------------------+----------------------+</span><span id="65e5" class="kx ky hi ly b fi mh md l me mf">| Metrics Server | 10.0.1.72:443    | The Metrics server   |</span><span id="dcdc" class="kx ky hi ly b fi mh md l me mf">|                |                  | is in charge of      |</span><span id="500a" class="kx ky hi ly b fi mh md l me mf">|                |                  | providing resource   |</span><span id="5c04" class="kx ky hi ly b fi mh md l me mf">|                |                  | usage metrics for    |</span><span id="2df0" class="kx ky hi ly b fi mh md l me mf">|                |                  | pods and nodes to    |</span><span id="b3e4" class="kx ky hi ly b fi mh md l me mf">|                |                  | the API server       |</span><span id="aa27" class="kx ky hi ly b fi mh md l me mf">+----------------+------------------+----------------------+</span><span id="4be8" class="kx ky hi ly b fi mh md l me mf">| Metrics Server | 10.0.1.12:6443   | The Metrics server   |</span><span id="7658" class="kx ky hi ly b fi mh md l me mf">|                |                  | is in charge of      |</span><span id="7efe" class="kx ky hi ly b fi mh md l me mf">|                |                  | providing resource   |</span><span id="bd4b" class="kx ky hi ly b fi mh md l me mf">|                |                  | usage metrics for    |</span><span id="add6" class="kx ky hi ly b fi mh md l me mf">|                |                  | pods and nodes to    |</span><span id="2fae" class="kx ky hi ly b fi mh md l me mf">|                |                  | the API server       |</span><span id="d90d" class="kx ky hi ly b fi mh md l me mf">+----------------+------------------+----------------------+</span><span id="2995" class="kx ky hi ly b fi mh md l me mf">| Metrics Server | 10.0.1.11:6443   | The Metrics server   |</span><span id="c0cf" class="kx ky hi ly b fi mh md l me mf">|                |                  | is in charge of      |</span><span id="646b" class="kx ky hi ly b fi mh md l me mf">|                |                  | providing resource   |</span><span id="c65b" class="kx ky hi ly b fi mh md l me mf">|                |                  | usage metrics for    |</span><span id="2b70" class="kx ky hi ly b fi mh md l me mf">|                |                  | pods and nodes to    |</span><span id="7aaa" class="kx ky hi ly b fi mh md l me mf">|                |                  | the API server       |</span><span id="6f1c" class="kx ky hi ly b fi mh md l me mf">+----------------+------------------+----------------------+</span><span id="aaca" class="kx ky hi ly b fi mh md l me mf">| Metrics Server | 10.0.1.10:6443   | The Metrics server   |</span><span id="6d4d" class="kx ky hi ly b fi mh md l me mf">|                |                  | is in charge of      |</span><span id="e976" class="kx ky hi ly b fi mh md l me mf">|                |                  | providing resource   |</span><span id="d2dd" class="kx ky hi ly b fi mh md l me mf">|                |                  | usage metrics for    |</span><span id="ab24" class="kx ky hi ly b fi mh md l me mf">|                |                  | pods and nodes to    |</span><span id="ecf0" class="kx ky hi ly b fi mh md l me mf">|                |                  | the API server       |</span><span id="da96" class="kx ky hi ly b fi mh md l me mf">+----------------+------------------+----------------------+</span><span id="3aea" class="kx ky hi ly b fi mh md l me mf">| Kubelet API    | 10.200.2.1:10250 | The Kubelet is the   |</span><span id="0d54" class="kx ky hi ly b fi mh md l me mf">|                |                  | main component in    |</span><span id="8426" class="kx ky hi ly b fi mh md l me mf">|                |                  | every Node, all pod  |</span><span id="d100" class="kx ky hi ly b fi mh md l me mf">|                |                  | operations goes      |</span><span id="2629" class="kx ky hi ly b fi mh md l me mf">|                |                  | through the kubelet  |</span><span id="74a4" class="kx ky hi ly b fi mh md l me mf">+----------------+------------------+----------------------+</span><span id="3b84" class="kx ky hi ly b fi mh md l me mf">| Kubelet API    | 10.0.1.22:10250  | The Kubelet is the   |</span><span id="b0e0" class="kx ky hi ly b fi mh md l me mf">|                |                  | main component in    |</span><span id="7fd1" class="kx ky hi ly b fi mh md l me mf">|                |                  | every Node, all pod  |</span><span id="655f" class="kx ky hi ly b fi mh md l me mf">|                |                  | operations goes      |</span><span id="f820" class="kx ky hi ly b fi mh md l me mf">|                |                  | through the kubelet  |</span><span id="aaa7" class="kx ky hi ly b fi mh md l me mf">+----------------+------------------+----------------------+</span><span id="cfc0" class="kx ky hi ly b fi mh md l me mf">| Kubelet API    | 10.0.1.21:10250  | The Kubelet is the   |</span><span id="2189" class="kx ky hi ly b fi mh md l me mf">|                |                  | main component in    |</span><span id="7d3e" class="kx ky hi ly b fi mh md l me mf">|                |                  | every Node, all pod  |</span><span id="7d23" class="kx ky hi ly b fi mh md l me mf">|                |                  | operations goes      |</span><span id="32e7" class="kx ky hi ly b fi mh md l me mf">|                |                  | through the kubelet  |</span><span id="ddd6" class="kx ky hi ly b fi mh md l me mf">+----------------+------------------+----------------------+</span><span id="52b8" class="kx ky hi ly b fi mh md l me mf">| Kubelet API    | 10.0.1.20:10250  | The Kubelet is the   |</span><span id="8564" class="kx ky hi ly b fi mh md l me mf">|                |                  | main component in    |</span><span id="541e" class="kx ky hi ly b fi mh md l me mf">|                |                  | every Node, all pod  |</span><span id="148f" class="kx ky hi ly b fi mh md l me mf">|                |                  | operations goes      |</span><span id="96a6" class="kx ky hi ly b fi mh md l me mf">|                |                  | through the kubelet  |</span><span id="ed04" class="kx ky hi ly b fi mh md l me mf">+----------------+------------------+----------------------+</span><span id="0958" class="kx ky hi ly b fi mh md l me mf">| Etcd           | 10.0.1.12:2379   | Etcd is a DB that    |</span><span id="d38b" class="kx ky hi ly b fi mh md l me mf">|                |                  | stores cluster's     |</span><span id="2f60" class="kx ky hi ly b fi mh md l me mf">|                |                  | data, it contains    |</span><span id="a93c" class="kx ky hi ly b fi mh md l me mf">|                |                  | configuration and    |</span><span id="f968" class="kx ky hi ly b fi mh md l me mf">|                |                  | current              |</span><span id="d99c" class="kx ky hi ly b fi mh md l me mf">|                |                  |     state            |</span><span id="11c1" class="kx ky hi ly b fi mh md l me mf">|                |                  | information, and     |</span><span id="1469" class="kx ky hi ly b fi mh md l me mf">|                |                  | might contain        |</span><span id="53b2" class="kx ky hi ly b fi mh md l me mf">|                |                  | secrets              |</span><span id="f375" class="kx ky hi ly b fi mh md l me mf">+----------------+------------------+----------------------+</span><span id="af0a" class="kx ky hi ly b fi mh md l me mf">| Etcd           | 10.0.1.11:2379   | Etcd is a DB that    |</span><span id="fc8e" class="kx ky hi ly b fi mh md l me mf">|                |                  | stores cluster's     |</span><span id="aae6" class="kx ky hi ly b fi mh md l me mf">|                |                  | data, it contains    |</span><span id="d8f3" class="kx ky hi ly b fi mh md l me mf">|                |                  | configuration and    |</span><span id="42ec" class="kx ky hi ly b fi mh md l me mf">|                |                  | current              |</span><span id="4a84" class="kx ky hi ly b fi mh md l me mf">|                |                  |     state            |</span><span id="7889" class="kx ky hi ly b fi mh md l me mf">|                |                  | information, and     |</span><span id="5e87" class="kx ky hi ly b fi mh md l me mf">|                |                  | might contain        |</span><span id="367c" class="kx ky hi ly b fi mh md l me mf">|                |                  | secrets              |</span><span id="16ca" class="kx ky hi ly b fi mh md l me mf">+----------------+------------------+----------------------+</span><span id="f0d7" class="kx ky hi ly b fi mh md l me mf">| Etcd           | 10.0.1.10:2379   | Etcd is a DB that    |</span><span id="b4d2" class="kx ky hi ly b fi mh md l me mf">|                |                  | stores cluster's     |</span><span id="27fe" class="kx ky hi ly b fi mh md l me mf">|                |                  | data, it contains    |</span><span id="6b25" class="kx ky hi ly b fi mh md l me mf">|                |                  | configuration and    |</span><span id="ffd3" class="kx ky hi ly b fi mh md l me mf">|                |                  | current              |</span><span id="f2e4" class="kx ky hi ly b fi mh md l me mf">|                |                  |     state            |</span><span id="e41e" class="kx ky hi ly b fi mh md l me mf">|                |                  | information, and     |</span><span id="a7b2" class="kx ky hi ly b fi mh md l me mf">|                |                  | might contain        |</span><span id="6d27" class="kx ky hi ly b fi mh md l me mf">|                |                  | secrets              |</span><span id="e4ea" class="kx ky hi ly b fi mh md l me mf">+----------------+------------------+----------------------+</span><span id="b8a3" class="kx ky hi ly b fi mh md l me mf">| API Server     | 10.32.0.1:443    | The API server is in |</span><span id="5d4d" class="kx ky hi ly b fi mh md l me mf">|                |                  | charge of all        |</span><span id="b5d4" class="kx ky hi ly b fi mh md l me mf">|                |                  | operations on the    |</span><span id="ca7a" class="kx ky hi ly b fi mh md l me mf">|                |                  | cluster.             |</span><span id="5711" class="kx ky hi ly b fi mh md l me mf">+----------------+------------------+----------------------+</span><span id="c736" class="kx ky hi ly b fi mh md l me mf">Vulnerabilities</span><span id="052e" class="kx ky hi ly b fi mh md l me mf">For further information about a vulnerability, search its ID in:</span><span id="83d3" class="kx ky hi ly b fi mh md l me mf">https://avd.aquasec.com/</span><span id="2c99" class="kx ky hi ly b fi mh md l me mf">+--------+----------------------+----------------------+----------------------+----------------------+----------------------+</span><span id="dcce" class="kx ky hi ly b fi mh md l me mf">| ID     | LOCATION             | MITRE CATEGORY       | VULNERABILITY        | DESCRIPTION          | EVIDENCE             |</span><span id="e425" class="kx ky hi ly b fi mh md l me mf">+--------+----------------------+----------------------+----------------------+----------------------+----------------------+</span><span id="7183" class="kx ky hi ly b fi mh md l me mf">| None   | Local to Pod (kube-  | Lateral Movement //  | CAP_NET_RAW Enabled  | CAP_NET_RAW is       |                      |</span><span id="2918" class="kx ky hi ly b fi mh md l me mf">|        | hunter-tws6b)        | ARP poisoning and IP |                      | enabled by default   |                      |</span><span id="5d43" class="kx ky hi ly b fi mh md l me mf">|        |                      | spoofing             |                      | for pods.            |                      |</span><span id="4b21" class="kx ky hi ly b fi mh md l me mf">|        |                      |                      |                      |     If an attacker   |                      |</span><span id="4166" class="kx ky hi ly b fi mh md l me mf">|        |                      |                      |                      | manages to           |                      |</span><span id="4218" class="kx ky hi ly b fi mh md l me mf">|        |                      |                      |                      | compromise a pod,    |                      |</span><span id="f754" class="kx ky hi ly b fi mh md l me mf">|        |                      |                      |                      |     they could       |                      |</span><span id="f865" class="kx ky hi ly b fi mh md l me mf">|        |                      |                      |                      | potentially take     |                      |</span><span id="fe46" class="kx ky hi ly b fi mh md l me mf">|        |                      |                      |                      | advantage of this    |                      |</span><span id="39e3" class="kx ky hi ly b fi mh md l me mf">|        |                      |                      |                      | capability to        |                      |</span><span id="113f" class="kx ky hi ly b fi mh md l me mf">|        |                      |                      |                      | perform network      |                      |</span><span id="0db7" class="kx ky hi ly b fi mh md l me mf">|        |                      |                      |                      |     attacks on other |                      |</span><span id="880a" class="kx ky hi ly b fi mh md l me mf">|        |                      |                      |                      | pods running on the  |                      |</span><span id="e2ec" class="kx ky hi ly b fi mh md l me mf">|        |                      |                      |                      | same node            |                      |</span><span id="a695" class="kx ky hi ly b fi mh md l me mf">+--------+----------------------+----------------------+----------------------+----------------------+----------------------+</span><span id="1bf2" class="kx ky hi ly b fi mh md l me mf">| KHV002 | 10.32.0.1:443        | Initial Access //    | K8s Version          | The kubernetes       | v1.21.0              |</span><span id="c3c9" class="kx ky hi ly b fi mh md l me mf">|        |                      | Exposed sensitive    | Disclosure           | version could be     |                      |</span><span id="1f8e" class="kx ky hi ly b fi mh md l me mf">|        |                      | interfaces           |                      | obtained from the    |                      |</span><span id="10a7" class="kx ky hi ly b fi mh md l me mf">|        |                      |                      |                      | /version endpoint    |                      |</span><span id="3e38" class="kx ky hi ly b fi mh md l me mf">+--------+----------------------+----------------------+----------------------+----------------------+----------------------+</span><span id="e7bf" class="kx ky hi ly b fi mh md l me mf">| KHV053 | Local to Pod (kube-  | Discovery //         | AWS Metadata         | Access to the AWS    | cidr: 10.0.1.0/24    |</span><span id="a9b4" class="kx ky hi ly b fi mh md l me mf">|        | hunter-tws6b)        | Instance Metadata    | Exposure             | Metadata API exposes |                      |</span><span id="5e27" class="kx ky hi ly b fi mh md l me mf">|        |                      | API                  |                      | information about    |                      |</span><span id="5de2" class="kx ky hi ly b fi mh md l me mf">|        |                      |                      |                      | the machines         |                      |</span><span id="c455" class="kx ky hi ly b fi mh md l me mf">|        |                      |                      |                      | associated with the  |                      |</span><span id="536b" class="kx ky hi ly b fi mh md l me mf">|        |                      |                      |                      | cluster              |                      |</span><span id="7674" class="kx ky hi ly b fi mh md l me mf">+--------+----------------------+----------------------+----------------------+----------------------+----------------------+</span><span id="bc82" class="kx ky hi ly b fi mh md l me mf">| KHV005 | 10.32.0.1:443        | Discovery // Access  | Access to API using  | The API Server port  | b'{"kind":"APIVersio |</span><span id="5ff8" class="kx ky hi ly b fi mh md l me mf">|        |                      | the K8S API Server   | service account      | is accessible.       | ns","versions":["v1" |</span><span id="ecbd" class="kx ky hi ly b fi mh md l me mf">|        |                      |                      | token                |     Depending on     | ],"serverAddressByCl |</span><span id="288c" class="kx ky hi ly b fi mh md l me mf">|        |                      |                      |                      | your RBAC settings   | ientCIDRs":[{"client |</span><span id="36c7" class="kx ky hi ly b fi mh md l me mf">|        |                      |                      |                      | this could expose    | CIDR":"0.0.0.0/0","s |</span><span id="8ec0" class="kx ky hi ly b fi mh md l me mf">|        |                      |                      |                      | access to or control | ...                  |</span><span id="99ad" class="kx ky hi ly b fi mh md l me mf">|        |                      |                      |                      | of your cluster.     |                      |</span><span id="634b" class="kx ky hi ly b fi mh md l me mf">+--------+----------------------+----------------------+----------------------+----------------------+----------------------+</span><span id="1907" class="kx ky hi ly b fi mh md l me mf">| None   | Local to Pod (kube-  | Credential Access // | Access to pod's      | Accessing the pod's  | ['/var/run/secrets/k |</span><span id="bd76" class="kx ky hi ly b fi mh md l me mf">|        | hunter-tws6b)        | Access container     | secrets              | secrets within a     | ubernetes.io/service |</span><span id="f6fb" class="kx ky hi ly b fi mh md l me mf">|        |                      | service account      |                      | compromised pod      | account/namespace',  |</span><span id="40f2" class="kx ky hi ly b fi mh md l me mf">|        |                      |                      |                      | might disclose       | '/var/run/secrets/ku |</span><span id="243e" class="kx ky hi ly b fi mh md l me mf">|        |                      |                      |                      | valuable data to a   | bernetes.io/servicea |</span><span id="a865" class="kx ky hi ly b fi mh md l me mf">|        |                      |                      |                      | potential attacker   | ...                  |</span><span id="e92e" class="kx ky hi ly b fi mh md l me mf">+--------+----------------------+----------------------+----------------------+----------------------+----------------------+</span><span id="3ff6" class="kx ky hi ly b fi mh md l me mf">| KHV050 | Local to Pod (kube-  | Credential Access // | Read access to pod's | Accessing the pod    | eyJhbGciOiJSUzI1NiIs |</span><span id="e344" class="kx ky hi ly b fi mh md l me mf">|        | hunter-tws6b)        | Access container     | service account      | service account      | ImtpZCI6IjItYnpCa1pK |</span><span id="4ada" class="kx ky hi ly b fi mh md l me mf">|        |                      | service account      | token                | token gives an       | aE1pTVpXZE1qSkhnRDA5 |</span><span id="10ae" class="kx ky hi ly b fi mh md l me mf">|        |                      |                      |                      | attacker the option  | YmdMZ3BLdmNxejV4VVYw |</span><span id="0212" class="kx ky hi ly b fi mh md l me mf">|        |                      |                      |                      | to use the server    | OW12LVEifQ.eyJhdWQiO |</span><span id="d6e7" class="kx ky hi ly b fi mh md l me mf">|        |                      |                      |                      | API                  | ...                  |</span><span id="8e3b" class="kx ky hi ly b fi mh md l me mf">+--------+----------------------+----------------------+----------------------+----------------------+----------------------+</span></pre><p id="24e7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">从上面的日志输出中，您可以看到关于漏洞的大量信息，以及一些潜在的解决步骤。您可以使用这个输出开始修补您的Kubernetes集群，以确保获得您所需要的最高安全性。</p><h2 id="9fe8" class="kx ky hi bd kz la lb lc ld le lf lg lh jg li lj lk jk ll lm ln jo lo lp lq lr bi translated">清理</h2><p id="5f59" class="pw-post-body-paragraph iv iw hi ix b iy ls ja jb jc lt je jf jg lu ji jj jk lv jm jn jo lw jq jr js hb bi translated">确保你删除了我们创建的所有资源，否则它会产生运行成本。</p><p id="f858" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">删除所有<strong class="ix hj">工作者</strong>实例，然后删除<strong class="ix hj">控制器</strong>实例，同时删除我们的<strong class="ix hj">密钥对</strong>:</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="4a6d" class="kx ky hi ly b fi mc md l me mf">echo "Issuing shutdown to worker nodes.. " &amp;&amp; \<br/>aws ec2 terminate-instances \<br/>  --instance-ids \<br/>    $(aws ec2 describe-instances --filters \<br/>      "Name=tag:Name,Values=worker-0,worker-1,worker-2" \<br/>      "Name=instance-state-name,Values=running" \<br/>      --output text --query 'Reservations[].Instances[].InstanceId')</span><span id="4854" class="kx ky hi ly b fi mh md l me mf">echo "Waiting for worker nodes to finish terminating.. " &amp;&amp; \<br/>aws ec2 wait instance-terminated \<br/>  --instance-ids \<br/>    $(aws ec2 describe-instances \<br/>      --filter "Name=tag:Name,Values=worker-0,worker-1,worker-2" \<br/>      --output text --query 'Reservations[].Instances[].InstanceId')</span><span id="3a2e" class="kx ky hi ly b fi mh md l me mf">echo "Issuing shutdown to master nodes.. " &amp;&amp; \<br/>aws ec2 terminate-instances \<br/>  --instance-ids \<br/>    $(aws ec2 describe-instances --filter \<br/>      "Name=tag:Name,Values=controller-0,controller-1,controller-2" \<br/>      "Name=instance-state-name,Values=running" \<br/>      --output text --query 'Reservations[].Instances[].InstanceId')</span><span id="4275" class="kx ky hi ly b fi mh md l me mf">echo "Waiting for master nodes to finish terminating.. " &amp;&amp; \<br/>aws ec2 wait instance-terminated \<br/>  --instance-ids \<br/>    $(aws ec2 describe-instances \<br/>      --filter "Name=tag:Name,Values=controller-0,controller-1,controller-2" \<br/>      --output text --query 'Reservations[].Instances[].InstanceId')</span><span id="5e0b" class="kx ky hi ly b fi mh md l me mf">aws ec2 delete-key-pair --key-name kubernetes</span></pre><p id="ce02" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">删除外部负载平衡器和网络资源(如果您丢失了任何环境变量的值，则可以使用AWS命令来查找它们，或者可以通过查看AWS控制台中的资源来手动设置它们):</p><pre class="kb kc kd ke fd lx ly lz ma aw mb bi"><span id="9e8a" class="kx ky hi ly b fi mc md l me mf">aws elbv2 delete-load-balancer --load-balancer-arn "${LOAD_BALANCER_ARN}"</span><span id="33af" class="kx ky hi ly b fi mh md l me mf">aws elbv2 delete-target-group --target-group-arn "${TARGET_GROUP_ARN}"</span><span id="bfb0" class="kx ky hi ly b fi mh md l me mf">aws ec2 delete-security-group --group-id "${SECURITY_GROUP_ID}"</span><span id="b5d2" class="kx ky hi ly b fi mh md l me mf">ROUTE_TABLE_ASSOCIATION_ID="$(aws ec2 describe-route-tables \<br/>  --route-table-ids "${ROUTE_TABLE_ID}" \<br/>  --output text --query 'RouteTables[].Associations[].RouteTableAssociationId')"</span><span id="e278" class="kx ky hi ly b fi mh md l me mf">aws ec2 disassociate-route-table --association-id "${ROUTE_TABLE_ASSOCIATION_ID}"</span><span id="5b4b" class="kx ky hi ly b fi mh md l me mf">aws ec2 delete-route-table --route-table-id "${ROUTE_TABLE_ID}"<br/>echo "Waiting a minute for all public address(es) to be unmapped.. " &amp;&amp; sleep 60</span><span id="c2e6" class="kx ky hi ly b fi mh md l me mf">aws ec2 detach-internet-gateway \<br/>  --internet-gateway-id "${INTERNET_GATEWAY_ID}" \<br/>  --vpc-id "${VPC_ID}"</span><span id="e0df" class="kx ky hi ly b fi mh md l me mf">aws ec2 delete-internet-gateway --internet-gateway-id "${INTERNET_GATEWAY_ID}"</span><span id="a187" class="kx ky hi ly b fi mh md l me mf">aws ec2 delete-subnet --subnet-id "${SUBNET_ID}"</span><span id="e8ee" class="kx ky hi ly b fi mh md l me mf">aws ec2 delete-vpc --vpc-id "${VPC_ID}"</span></pre><p id="7587" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">我必须强调这一点，仔细查看您的AWS控制台资源，确保您已经删除了我们在本指南中提供的所有内容。你不想一年后回来时还在想为什么你的信用卡余额会受损！！！</strong></p></div></div>    
</body>
</html>