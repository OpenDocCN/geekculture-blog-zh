<html>
<head>
<title>DB Migration In Go Lang</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Go Lang中的数据库迁移</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/db-migration-in-go-lang-d325effc55de?source=collection_archive---------0-----------------------#2021-07-27">https://medium.com/geekculture/db-migration-in-go-lang-d325effc55de?source=collection_archive---------0-----------------------#2021-07-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="5d26" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当使用数据库时，模式迁移是我们应该在整个应用程序生命周期中完成的一项特殊任务。在这篇博客中，我们将看到如何使用Go lang管理数据库迁移。</p><p id="37c9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为此，我们使用golang-migrate <a class="ae jd" href="https://github.com/golang-migrate/migrate" rel="noopener ugc nofollow" target="_blank">库</a>。该库支持许多数据库引擎，如Postgres，MySQL，Mongo …</p><p id="cc9e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有关CLI文档，请单击此处的<a class="ae jd" href="https://github.com/golang-migrate/migrate/tree/master/cmd/migrate" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="95d2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用自制软件安装golang-migrate</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="f10f" class="jn jo hi jj b fi jp jq l jr js"><strong class="jj hj">brew install golang-migrate</strong></span></pre><p id="840a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是golang-migrate的用法</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="b930" class="jn jo hi jj b fi jp jq l jr js">$ migrate -help<br/>Usage: migrate OPTIONS COMMAND [arg...]<br/>       migrate [ -version | -help ]<br/><br/>Options:<br/>  -source          Location of the migrations (driver://url)<br/>  -path            Shorthand for -source=file://path<br/>  -database        Run migrations against this database (driver://url)<br/>  -prefetch N      Number of migrations to load in advance before executing (default 10)<br/>  -lock-timeout N  Allow N seconds to acquire database lock (default 15)<br/>  -verbose         Print verbose logging<br/>  -version         Print version<br/>  -help            Print usage<br/><br/>Commands:<br/>  create [-ext E] [-dir D] [-seq] [-digits N] [-format] NAME<br/>               Create a set of timestamped up/down migrations titled NAME, in directory D with extension E.<br/>               Use -seq option to generate sequential up/down migrations with N digits.<br/>               Use -format option to specify a Go time format string.<br/>  goto V       Migrate to version V<br/>  up [N]       Apply all or N up migrations<br/>  down [N]     Apply all or N down migrations<br/>  drop         Drop everything inside database<br/>  force V      Set version V but don't run migration (ignores dirty state)<br/>  version      Print current migration version</span></pre><p id="7cb9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们创建一个简单的文件夹，看看迁移是如何进行的</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="1987" class="jn jo hi jj b fi jp jq l jr js">mkdir playground<br/>cd playground<br/>mkdir -p db/migration</span></pre><blockquote class="jt ju jv"><p id="b746" class="if ig jw ih b ii ij ik il im in io ip jx ir is it jy iv iw ix jz iz ja jb jc hb bi translated">我已经在我的本地mac上安装了postgres。这里没有使用docker。</p></blockquote><p id="9cc8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们创建第一个迁移文件。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="6afd" class="jn jo hi jj b fi jp jq l jr js"><strong class="jj hj">$ migrate create -ext sql -dir db/migration -seq playground_schema</strong></span></pre><p id="75c0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面的命令将创建两个文件，在所创建的sql文件的后缀处使用up和down。当我们启用了<code class="du ka kb kc jj b">seq</code>标志时，文件是用版本号创建的。</p><figure class="je jf jg jh fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es kd"><img src="../Images/1d354403e19514d7976fd751300b9899.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FpqsxTLbDt1l0PP7b2_kMA.png"/></div></div></figure><p id="d999" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">文件是空的。让我在<code class="du ka kb kc jj b">up</code>文件中创建一些表，在<code class="du ka kb kc jj b">down</code>文件中创建回滚命令。</p><p id="ed61" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">000001 _ playground _ schema . up . SQL</strong></p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="9376" class="jn jo hi jj b fi jp jq l jr js"><strong class="jj hj"><em class="jw">CREATE TABLE users (<br/>   id BIGSERIAL primary key,<br/>   first_name TEXT not null,<br/>   last_name TEXT,<br/>   created_at TIMESTAMP default now()<br/>);</em></strong></span></pre><p id="00aa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">000001 _ playground _ schema . down . SQL</strong></p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="0959" class="jn jo hi jj b fi jp jq l jr js"><strong class="jj hj"><em class="jw">DROP TABLE IF EXISTS users;</em></strong></span></pre><p id="c18f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们创建一个Makefile以便于使用。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="3b7d" class="jn jo hi jj b fi jp jq l jr js"><em class="jw">migrateup:<br/>migrate -path db/migration -database "postgresql://&lt;user&gt;:&lt;pwd&gt;@localhost:5432/go_sample?sslmode=disable" -verbose up</em></span><span id="a0b0" class="jn jo hi jj b fi kl jq l jr js"><em class="jw">migratedown:<br/>migrate -path db/migration -database "postgresql://&lt;user&gt;@&lt;pwd&gt;:5432/go_sample?sslmode=disable" -verbose down</em></span></pre><p id="3b45" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在执行migrateup命令</p><figure class="je jf jg jh fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es km"><img src="../Images/deefb1a813cc40de3e992c246a7c0b70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FD2TviuBa_cMxSDjPRKxNw.png"/></div></div></figure><p id="b93c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将创建两个表<code class="du ka kb kc jj b">users</code>和<code class="du ka kb kc jj b">schema_migrations</code>。后一种是由迁徙的戈兰人创造的。它实际上并不存储changelog，而只是存储迁移是否成功。</p><figure class="je jf jg jh fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es kn"><img src="../Images/fbbcee1217074e46f8b23129bc73eb28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Afpni1odP5DulQuFb97lIA.png"/></div></div></figure><p id="57c0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面的流程显示了新旧模式之间的迁移是如何进行的。</p><figure class="je jf jg jh fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es ko"><img src="../Images/fca38b8e6aeda7c07141d31fbfc71ef7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*efAX7XpKmDFf80nrl8dzXw.png"/></div></div></figure><p id="4b9c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="jw">向上迁移</em> </strong></p><figure class="je jf jg jh fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es kp"><img src="../Images/2431cacd6ce63d2b009193ed25bab375.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FJyBFKybG-hm7o_D6Ux3KA.png"/></div></div></figure><blockquote class="jt ju jv"><p id="cb0c" class="if ig jw ih b ii ij ik il im in io ip jx ir is it jy iv iw ix jz iz ja jb jc hb bi translated"><em class="hi">向上迁移将按照SQL文件的前缀顺序依次运行。</em></p></blockquote><p id="8cf7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="jw">向下迁移</em> </strong></p><figure class="je jf jg jh fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es kp"><img src="../Images/f0dccdc441adce893acbb2a19ce4c90b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OStTYUZq0HyXzeaVxWPNrQ.png"/></div></div></figure><blockquote class="jt ju jv"><p id="25d0" class="if ig jw ih b ii ij ik il im in io ip jx ir is it jy iv iw ix jz iz ja jb jc hb bi translated"><em class="hi">向上迁移将按照与SQL文件相反的前缀顺序依次运行。</em></p></blockquote><p id="f292" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们初始化另一个版本，要求是将<code class="du ka kb kc jj b">phone_number</code>添加到用户表中。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="4f7d" class="jn jo hi jj b fi jp jq l jr js"><strong class="jj hj">$ migrate create -ext sql -dir db/migration -seq playground_schema</strong></span></pre><figure class="je jf jg jh fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es kq"><img src="../Images/072ecd8a1d56e04df62a52d1e748dd01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dwQv2YSqlYlC_O7TZOFvIQ.png"/></div></div></figure><p id="987a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">000002 _ playground _ schema . up . SQL</strong></p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="df22" class="jn jo hi jj b fi jp jq l jr js"><strong class="jj hj">ALTER TABLE users add column phone_number not null;</strong></span></pre><p id="c073" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">000002 _ playground _ schema . down . SQL</strong></p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="93cc" class="jn jo hi jj b fi jp jq l jr js"><strong class="jj hj">Alter table users drop column phone_number</strong></span></pre><p id="6300" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在运行<code class="du ka kb kc jj b">make migrateup</code>命令</p><figure class="je jf jg jh fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es kr"><img src="../Images/0003242a7e42f8bd0d98efecc15acfd0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zWPQCiPsu1ed0pF74wwsbA.png"/></div></div></figure><p id="85ea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">使用golang迁移时的缺点</strong></p><ol class=""><li id="3698" class="ks kt hi ih b ii ij im in iq ku iu kv iy kw jc kx ky kz la bi translated">这并不像其他流行的移植那样先进，比如npm的<code class="du ka kb kc jj b">sequelize</code>，java的<code class="du ka kb kc jj b">liquibase</code>。它不存储changelog，所以只说明版本是否是脏的。</li><li id="de48" class="ks kt hi ih b ii lb im lc iq ld iu le iy lf jc kx ky kz la bi translated">默认情况下，migrate up和migrate <code class="du ka kb kc jj b">down</code>会删除对模式的所有更改，我们在使用它时应该小心。它提示申请全部或不申请。<br/>我们应该使用下面的命令<code class="du ka kb kc jj b">goto</code>恢复到一个特定的版本。</li></ol><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="8c88" class="jn jo hi jj b fi jp jq l jr js"><strong class="jj hj">$ migrate -path db/migration -database "postgresql://&lt;user&gt;:&lt;pwd&gt;@localhost:5432/go_sample?sslmode=disable" -verbose goto 1</strong></span></pre><p id="8655" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="jw">结论</em> </strong></p><p id="1ab7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">golang中还有其他可以进行数据库迁移的模块。实现一个请明智选择。</p></div></div>    
</body>
</html>