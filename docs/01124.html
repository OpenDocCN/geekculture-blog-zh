<html>
<head>
<title>Appointment Scheduling with Facebook Messenger Chat Bots and NodeJS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Facebook Messenger聊天机器人和NodeJS安排约会</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/appointment-scheduling-with-facebook-messenger-chat-bots-and-nodejs-53f1a539b283?source=collection_archive---------21-----------------------#2021-03-28">https://medium.com/geekculture/appointment-scheduling-with-facebook-messenger-chat-bots-and-nodejs-53f1a539b283?source=collection_archive---------21-----------------------#2021-03-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/91bf794a5bcbaee1cf3b291b993a01d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*UqLVihMBbNCryihd.jpg"/></div></div></figure><p id="6c0f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这篇文章中，我解释了我们如何使用Facebook Messenger API创建一个集成了<strong class="is hj">预约</strong>的聊天机器人。这是一个NodeJS实现，但可以很容易地用任何其他现代语言复制。</p><p id="4263" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">脸书非常灵活，提供了许多很酷的功能。messenger可以添加到您自己的脸书页面，也可以直接嵌入到您自己的网站或应用程序中。出于教育目的，我们将在脸书页面上使用它。完整的代码位于本文底部的GitHub库。</p><p id="533d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这是它如何工作的基本演示:</p><figure class="jp jq jr js fd ij er es paragraph-image"><div class="er es jo"><img src="../Images/45bf4c118554e287f3cb856ea651a439.png" data-original-src="https://miro.medium.com/v2/resize:fit:590/0*vrBE5u3DRveIEJeL.gif"/></div></figure><h1 id="c363" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">获取API凭据</h1><p id="3af2" class="pw-post-body-paragraph iq ir hi is b it kr iv iw ix ks iz ja jb kt jd je jf ku jh ji jj kv jl jm jn hb bi translated">要开始使用Facebook Messenger API，你可以跟随官方指南<a class="ae kw" href="https://developers.facebook.com/docs/messenger-platform/getting-started/" rel="noopener ugc nofollow" target="_blank"/>。你需要获得三个重要的凭证:<code class="du kx ky kz la b">App Secret Key</code>、<code class="du kx ky kz la b">Page Access Token</code>和<code class="du kx ky kz la b">Callback user token</code>。最后一个令牌是用户定义的值。</p><h1 id="6697" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">履行</h1><p id="6ede" class="pw-post-body-paragraph iq ir hi is b it kr iv iw ix ks iz ja jb kt jd je jf ku jh ji jj kv jl jm jn hb bi translated">在其中一个步骤中，您必须提供一个webhook URL到您的服务器，这允许脸书验证连接，但也验证您的用户定义的令牌:</p><pre class="jp jq jr js fd lb la lc ld aw le bi"><span id="cef1" class="lf ju hi la b fi lg lh l li lj">// GET request<br/>router.get('/spurwing-fbbot/', (req, res) =&gt; {<br/>  // verify token and send back the challenge<br/>});</span></pre><p id="705f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一旦你的脸书应用程序被创建并且网页挂钩被脸书成功验证，我们就可以开始实现和测试我们页面的信使和聊天机器人:</p><pre class="jp jq jr js fd lb la lc ld aw le bi"><span id="3575" class="lf ju hi la b fi lg lh l li lj">// POST request<br/>router.post('/spurwing-fbbot/', async (req, res) =&gt; {</span><span id="7d62" class="lf ju hi la b fi lk lh l li lj">  verifyRequestSignature(req, res) // make sure it really is Facebook's message</span><span id="f761" class="lf ju hi la b fi lk lh l li lj">  for (const e of req.body.entry) {<br/>    if (e.messaging)<br/>      for (const m of e.messaging) {<br/>        await fb_msg_process(m.sender.id, m.message)<br/>      }<br/>  }</span><span id="2346" class="lf ju hi la b fi lk lh l li lj">  res.send({success:1})<br/>});</span></pre><p id="cf47" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">上面的代码是一个非常简单的路由器实现，用于通过messenger接收用户消息。接下来，我们需要处理用户文本并正确回复:</p><pre class="jp jq jr js fd lb la lc ld aw le bi"><span id="6b59" class="lf ju hi la b fi lg lh l li lj">async function fb_msg_process(senderId, msg) {</span><span id="8277" class="lf ju hi la b fi lk lh l li lj">  // default fall-back message<br/>  let resp = {text: "I don't know what you mean :("}</span><span id="c13e" class="lf ju hi la b fi lk lh l li lj">  if (msg &amp;&amp; msg.text) {<br/>    let text = msg.text.toLowerCase();<br/>    if (msg.quick_reply &amp;&amp; msg.quick_reply.payload)<br/>      text = msg.quick_reply.payload;</span><span id="4622" class="lf ju hi la b fi lk lh l li lj">    switch(true) {<br/>      case /^book$/.test(text):<br/>        resp = await fb_msg_process_funcs.book(text);<br/>        break;<br/>      case /^book_day:.+$/.test(text):<br/>        resp = await fb_msg_process_funcs.book_day(text);<br/>        break;<br/>      case /^book_slot:.+$/.test(text):<br/>        resp = await fb_msg_process_funcs.book_slot(text);<br/>        break;<br/>    }  <br/>  }</span><span id="1fb2" class="lf ju hi la b fi lk lh l li lj">  fb_msg_reply(senderId, resp) // send a reply back</span><span id="c2c8" class="lf ju hi la b fi lk lh l li lj">}</span></pre><p id="ad2c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">上面的代码根据上下文解析和处理接收到的消息。顶部的动画gif显示了这种逻辑的实际应用。</p><p id="e181" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">预约和调度逻辑</strong>由我们的Spurwing API ( <a class="ae kw" href="https://github.com/spurwingio/Spurwing-API-NodeJS-Library" rel="noopener ugc nofollow" target="_blank"> NodeJS库</a>)提供。它允许我们列出所有可用的日期，然后列出某一天所有可用的时间段，最后在选定的时间段预约。该实现的完整代码位于我们的<a class="ae kw" href="https://github.com/Spurwingio/Chat-Bots/tree/main/Facebook/NodeJS" rel="noopener ugc nofollow" target="_blank"> GitHub库</a>的<code class="du kx ky kz la b">index.js</code>中。</p><h1 id="072a" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">结论</h1><p id="3af1" class="pw-post-body-paragraph iq ir hi is b it kr iv iw ix ks iz ja jb kt jd je jf ku jh ji jj kv jl jm jn hb bi translated">这是一个使用Facebook Messenger API的非常简单而有效的聊天机器人实现。但它确实遗漏了一些关键细节:</p><ul class=""><li id="c7cf" class="ll lm hi is b it iu ix iy jb ln jf lo jj lp jn lq lr ls lt bi translated">所有日期和时间都相对于您的服务器，而不是相对于用户的时区。脸书有高级消息传递功能，您可以启用它来接收用户的实际时区。</li><li id="a69a" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated">或者，你可以在聊天中询问用户的时区。</li><li id="1844" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated">快速回复按钮数量有限。但是可用天数和/或时隙数可能会超过这个限制。应该实现自定义逻辑来提供更灵活的调度选项。</li></ul><p id="7cdd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">由开发人员决定如何处理用户的时区和快速回复输入。后者可以通过手动输入一个时间段并给出关于其可用性的反馈来实现，甚至可以使用NLP策略来进行更复杂的语言解析。但是如果你是一个编程新手，保持简单和容易。</p><p id="a994" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">欲了解更多预订和日历解决方案，请访问我们的<a class="ae kw" href="https://github.com/Spurwingio/" rel="noopener ugc nofollow" target="_blank"> Github账户</a>。</p></div></div>    
</body>
</html>