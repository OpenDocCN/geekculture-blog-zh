<html>
<head>
<title>How to manage Auto Scaling Group and Load Balancer with Terraform?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用Terraform管理自动伸缩组和负载均衡器？</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/how-to-manage-auto-scaling-group-and-load-balancer-with-terraform-9ece263060b5?source=collection_archive---------0-----------------------#2021-09-23">https://medium.com/geekculture/how-to-manage-auto-scaling-group-and-load-balancer-with-terraform-9ece263060b5?source=collection_archive---------0-----------------------#2021-09-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="2aba" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">什么是Terraform？</h1><p id="443b" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">Terraform是一个开源的i <strong class="jf hj">基础设施代码(IAC) </strong>工具，允许<strong class="jf hj">创建、管理</strong> &amp; <strong class="jf hj">部署</strong>生产就绪环境。Terraform将云API编码成声明性的配置文件。Terraform可以管理<strong class="jf hj">现有服务提供商</strong>和<strong class="jf hj">定制内部解决方案。</strong></p><p id="efaf" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">从<a class="ae kg" href="https://www.terraform.io/intro/index.html" rel="noopener ugc nofollow" target="_blank"> <strong class="jf hj">这里</strong> </a>阅读更多关于地形的信息</p><h1 id="635c" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">先决条件:</h1><ul class=""><li id="8e46" class="kh ki hi jf b jg jh jk jl jo kj js kk jw kl ka km kn ko kp bi translated">基本了解<a class="ae kg" href="https://docs.aws.amazon.com/" rel="noopener ugc nofollow" target="_blank"><strong class="jf hj">AWS</strong></a>&amp;<a class="ae kg" href="https://www.terraform.io/intro/index.html" rel="noopener ugc nofollow" target="_blank"><strong class="jf hj">terra form</strong></a></li><li id="14a6" class="kh ki hi jf b jg kq jk kr jo ks js kt jw ku ka km kn ko kp bi translated">预装了<a class="ae kg" href="https://learn.hashicorp.com/tutorials/terraform/install-cli" rel="noopener ugc nofollow" target="_blank"> <strong class="jf hj">地形</strong> </a>的服务器</li><li id="f928" class="kh ki hi jf b jg kq jk kr jo ks js kt jw ku ka km kn ko kp bi translated">一个<strong class="jf hj">访问密钥</strong> &amp; <strong class="jf hj">秘密密钥</strong>创建了AWS</li><li id="185b" class="kh ki hi jf b jg kq jk kr jo ks js kt jw ku ka km kn ko kp bi translated"><strong class="jf hj"> SSH密钥</strong></li></ul><p id="8748" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">在本教程中，我将使用terraform创建各种资源，如<strong class="jf hj"> VPC </strong>、<strong class="jf hj"> EC2 </strong>、<strong class="jf hj"> SG </strong>等&amp;将管理<strong class="jf hj"> ASG </strong> &amp; <strong class="jf hj"> ELB </strong>。那么，让我们开始娱乐吧。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es kv"><img src="../Images/393bf6ced2b6c770b7e885141415478e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hzcn58R-qukKR_eg"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx">ELB + ASG</figcaption></figure><blockquote class="ll lm ln"><p id="1c4a" class="jd je lo jf b jg kb ji jj jk kc jm jn lp kd jq jr lq ke ju jv lr kf jy jz ka hb bi translated">我们<!-- -->将使用单独的文件来创建所有的资源&amp;一个单独的变量文件。最后我将讨论变量文件。</p></blockquote><p id="5ecc" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">步骤1:- </strong>创建<strong class="jf hj">提供者</strong>块</p><ul class=""><li id="05ff" class="kh ki hi jf b jg kb jk kc jo ls js lt jw lu ka km kn ko kp bi translated">创建<code class="du lv lw lx ly b">provider.tf</code>文件并将以下内容添加到其中</li></ul><pre class="kw kx ky kz fd lz ly ma mb aw mc bi"><span id="07f3" class="md ig hi ly b fi me mf l mg mh">provider "aws" {<br/>    region = "us-east-1"<br/>    access_key = "{}"<br/>    secret_key = "{}"<br/>    version = "v2.70.0"<br/>}</span></pre><ul class=""><li id="746f" class="kh ki hi jf b jg kb jk kc jo ls js lt jw lu ka km kn ko kp bi translated">这里我用的是<strong class="jf hj"> 2.70.0 </strong>版本的<strong class="jf hj"> AWS </strong>，因为整个代码都是用<strong class="jf hj"> terraform 11 </strong>版本写的。</li></ul><p id="0ee6" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">第二步:- </strong>创建<strong class="jf hj"> AWS VPC </strong></p><ul class=""><li id="a4a2" class="kh ki hi jf b jg kb jk kc jo ls js lt jw lu ka km kn ko kp bi translated">创建<code class="du lv lw lx ly b">vpc.tf</code>文件，并将下面的代码添加到其中</li></ul><pre class="kw kx ky kz fd lz ly ma mb aw mc bi"><span id="2be2" class="md ig hi ly b fi me mf l mg mh">resource "aws_vpc" "demovpc" {<br/>  cidr_block       = "${var.vpc_cidr}"<br/>  instance_tenancy = "default"</span><span id="29f6" class="md ig hi ly b fi mi mf l mg mh">tags = {<br/>    Name = "Demo VPC"<br/>  }<br/>}</span></pre><p id="3488" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">步骤3:- </strong>创建<strong class="jf hj"> AWS </strong>互联网网关</p><ul class=""><li id="5fea" class="kh ki hi jf b jg kb jk kc jo ls js lt jw lu ka km kn ko kp bi translated">创建<code class="du lv lw lx ly b">igw.tf</code>文件，并添加以下代码</li></ul><pre class="kw kx ky kz fd lz ly ma mb aw mc bi"><span id="9530" class="md ig hi ly b fi me mf l mg mh">resource "aws_internet_gateway" "demogateway" {<br/>  vpc_id = "${aws_vpc.demovpc.id}"<br/>}</span></pre><ul class=""><li id="4208" class="kh ki hi jf b jg kb jk kc jo ls js lt jw lu ka km kn ko kp bi translated">在这里，我正在新创建的<strong class="jf hj"> VPC </strong>中创建<strong class="jf hj">互联网网关</strong></li></ul><p id="5a3c" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">步骤4:- </strong>创建<strong class="jf hj"> AWS </strong>子网<strong class="jf hj"/></p><ul class=""><li id="38bb" class="kh ki hi jf b jg kb jk kc jo ls js lt jw lu ka km kn ko kp bi translated">创建<code class="du lv lw lx ly b">subnet.tf</code>文件，并将下面的代码添加到其中</li></ul><pre class="kw kx ky kz fd lz ly ma mb aw mc bi"><span id="3f95" class="md ig hi ly b fi me mf l mg mh"># Creating 1st subnet <br/>resource "aws_subnet" "demosubnet" {<br/>  vpc_id                  = "${aws_vpc.demovpc.id}"<br/>  cidr_block             = "${var.subnet_cidr}"<br/>  map_public_ip_on_launch = true<br/>  availability_zone = "us-east-1a"</span><span id="8d06" class="md ig hi ly b fi mi mf l mg mh">tags = {<br/>    Name = "Demo subnet"<br/>  }<br/>}</span><span id="a7c3" class="md ig hi ly b fi mi mf l mg mh"># Creating 2nd subnet <br/>resource "aws_subnet" "demosubnet1" {<br/>  vpc_id                  = "${aws_vpc.demovpc.id}"<br/>  cidr_block             = "${var.subnet1_cidr}"<br/>  map_public_ip_on_launch = true<br/>  availability_zone = "us-east-1b"</span><span id="95d6" class="md ig hi ly b fi mi mf l mg mh">tags = {<br/>    Name = "Demo subnet 1"<br/>  }<br/>}</span></pre><ul class=""><li id="de63" class="kh ki hi jf b jg kb jk kc jo ls js lt jw lu ka km kn ko kp bi translated">在这里，我创建了两个子网，它们都将作为公共子网</li></ul><p id="d28e" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">第五步:- </strong>创建<strong class="jf hj"> AWS </strong> <strong class="jf hj">路由表</strong></p><ul class=""><li id="05e8" class="kh ki hi jf b jg kb jk kc jo ls js lt jw lu ka km kn ko kp bi translated">创建<code class="du lv lw lx ly b">route_table.tf</code>文件并将下面的代码添加到其中</li></ul><pre class="kw kx ky kz fd lz ly ma mb aw mc bi"><span id="70b0" class="md ig hi ly b fi me mf l mg mh">#Creating Route Table<br/>resource "aws_route_table" "route" {<br/>    vpc_id = "${aws_vpc.demovpc.id}"</span><span id="9323" class="md ig hi ly b fi mi mf l mg mh">route {<br/>        cidr_block = "0.0.0.0/0"<br/>        gateway_id = "${aws_internet_gateway.demogateway.id}"<br/>    }</span><span id="ef34" class="md ig hi ly b fi mi mf l mg mh">tags = {<br/>        Name = "Route to internet"<br/>    }<br/>}</span><span id="3ff7" class="md ig hi ly b fi mi mf l mg mh">resource "aws_route_table_association" "rt1" {<br/>    subnet_id = "${aws_subnet.demosubnet.id}"<br/>    route_table_id = "${aws_route_table.route.id}"<br/>}</span><span id="a730" class="md ig hi ly b fi mi mf l mg mh">resource "aws_route_table_association" "rt2" {<br/>    subnet_id = "${aws_subnet.demosubnet1.id}"<br/>    route_table_id = "${aws_route_table.route.id}"<br/>}</span></pre><ul class=""><li id="6541" class="kh ki hi jf b jg kb jk kc jo ls js lt jw lu ka km kn ko kp bi translated">在这里，我创建了一个新的路由表，并将该路由表与新创建的子网相关联。两个新创建的子网都将作为公共子网。</li></ul><p id="bd16" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">步骤6:- </strong>为<strong class="jf hj">负载平衡器</strong>创建<strong class="jf hj"> AWS安全组</strong></p><ul class=""><li id="29d2" class="kh ki hi jf b jg kb jk kc jo ls js lt jw lu ka km kn ko kp bi translated">创建<code class="du lv lw lx ly b">sg_elb.tf</code>文件，并将下面的代码添加到其中</li></ul><pre class="kw kx ky kz fd lz ly ma mb aw mc bi"><span id="096e" class="md ig hi ly b fi me mf l mg mh"># Creating Security Group for ELB<br/>resource "aws_security_group" "demosg1" {<br/>  name        = "Demo Security Group"<br/>  description = "Demo Module"<br/>  vpc_id      = "${aws_vpc.demovpc.id}"</span><span id="ab40" class="md ig hi ly b fi mi mf l mg mh"># Inbound Rules<br/>  # HTTP access from anywhere<br/>  ingress {<br/>    from_port   = 80<br/>    to_port     = 80<br/>    protocol    = "tcp"<br/>    cidr_blocks = ["0.0.0.0/0"]<br/>  }</span><span id="cdf9" class="md ig hi ly b fi mi mf l mg mh">  # HTTPS access from anywhere<br/>  ingress {<br/>    from_port   = 443<br/>    to_port     = 443<br/>    protocol    = "tcp"<br/>    cidr_blocks = ["0.0.0.0/0"]<br/>  }</span><span id="be75" class="md ig hi ly b fi mi mf l mg mh">  # SSH access from anywhere<br/>  ingress {<br/>    from_port   = 22<br/>    to_port     = 22<br/>    protocol    = "tcp"<br/>    cidr_blocks = ["0.0.0.0/0"]<br/>  }</span><span id="980a" class="md ig hi ly b fi mi mf l mg mh"># Outbound Rules<br/>  # Internet access to anywhere<br/>  egress {<br/>    from_port   = 0<br/>    to_port     = 0<br/>    protocol    = "-1"<br/>    cidr_blocks = ["0.0.0.0/0"]<br/>  }<br/>}</span></pre><ul class=""><li id="b14a" class="kh ki hi jf b jg kb jk kc jo ls js lt jw lu ka km kn ko kp bi translated">在这里，我为端口22、80和443创建入站规则，并为所有IP的所有端口打开出站连接。</li></ul><p id="f5c1" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">步骤7:- </strong>创建<strong class="jf hj"> AWS </strong>负载均衡器<strong class="jf hj"/></p><p id="c3ca" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">创建<code class="du lv lw lx ly b">elb.tf</code>文件，并添加以下代码</p><pre class="kw kx ky kz fd lz ly ma mb aw mc bi"><span id="88fb" class="md ig hi ly b fi me mf l mg mh">resource "aws_elb" "web_elb" {<br/>  name = "web-elb"<br/>  security_groups = [<br/>    "${aws_security_group.demosg1.id}"<br/>  ]<br/>  subnets = [<br/>    "${aws_subnet.demosubnet.id}",<br/>    "${aws_subnet.demosubnet1.id}"<br/>  ]</span><span id="a0b1" class="md ig hi ly b fi mi mf l mg mh">cross_zone_load_balancing   = true</span><span id="ab8b" class="md ig hi ly b fi mi mf l mg mh">health_check {<br/>    healthy_threshold = 2<br/>    unhealthy_threshold = 2<br/>    timeout = 3<br/>    interval = 30<br/>    target = "HTTP:80/"<br/>  }</span><span id="1180" class="md ig hi ly b fi mi mf l mg mh">listener {<br/>    lb_port = 80<br/>    lb_protocol = "http"<br/>    instance_port = "80"<br/>    instance_protocol = "http"<br/>  }</span><span id="90ca" class="md ig hi ly b fi mi mf l mg mh">}</span></pre><ul class=""><li id="7e6d" class="kh ki hi jf b jg kb jk kc jo ls js lt jw lu ka km kn ko kp bi translated">新创建的应用程序负载平衡器至少需要2个子网，因此我将这两个子网都连接起来</li><li id="b88b" class="kh ki hi jf b jg kq jk kr jo ks js kt jw ku ka km kn ko kp bi translated">我已经启用了跨区域负载平衡</li><li id="57a5" class="kh ki hi jf b jg kq jk kr jo ks js kt jw ku ka km kn ko kp bi translated">我已经定义了运行状况检查策略，因此我将始终拥有与我的负载平衡器相关联的运行状况良好的实例</li></ul><p id="72ff" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">步骤8:- </strong>创建<strong class="jf hj"> AWS启动配置</strong></p><ul class=""><li id="c05c" class="kh ki hi jf b jg kb jk kc jo ls js lt jw lu ka km kn ko kp bi translated">创建<code class="du lv lw lx ly b">launch_config.tf</code>文件，并将下面的代码添加到其中</li></ul><pre class="kw kx ky kz fd lz ly ma mb aw mc bi"><span id="970c" class="md ig hi ly b fi me mf l mg mh">resource "aws_launch_configuration" "web" {<br/>  name_prefix = "web-"</span><span id="7ec0" class="md ig hi ly b fi mi mf l mg mh">image_id = "ami-087c17d1fe0178315" <br/>  instance_type = "t2.micro"<br/>  key_name = "tests"</span><span id="f28e" class="md ig hi ly b fi mi mf l mg mh">security_groups = [ "${aws_security_group.demosg.id}" ]<br/>  associate_public_ip_address = true<br/>  user_data = "${file("data.sh")}"</span><span id="e3cf" class="md ig hi ly b fi mi mf l mg mh">lifecycle {<br/>    create_before_destroy = true<br/>  }<br/>}</span></pre><ul class=""><li id="bafa" class="kh ki hi jf b jg kb jk kc jo ls js lt jw lu ka km kn ko kp bi translated">这里我使用<strong class="jf hj"> AWS Linux 2 </strong>作为AMI实例，并使用<strong class="jf hj">用户数据</strong>来配置新创建的实例。我将在文章的后面讨论<strong class="jf hj">用户数据</strong>部分。</li><li id="f892" class="kh ki hi jf b jg kq jk kr jo ks js kt jw ku ka km kn ko kp bi translated">该区域中已经存在密钥对</li><li id="ffae" class="kh ki hi jf b jg kq jk kr jo ks js kt jw ku ka km kn ko kp bi translated">在销毁旧的实例之前，我在这里使用<code class="du lv lw lx ly b">create_before_destroy</code>从新的启动配置创建新的实例。</li></ul><p id="5987" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">步骤9:- </strong>为<strong class="jf hj"> EC2实例</strong>创建<strong class="jf hj"> AWS安全组</strong></p><ul class=""><li id="bfe3" class="kh ki hi jf b jg kb jk kc jo ls js lt jw lu ka km kn ko kp bi translated">创建<code class="du lv lw lx ly b">sg_ec2.tf</code>文件，并将下面的代码添加到其中</li></ul><pre class="kw kx ky kz fd lz ly ma mb aw mc bi"><span id="24c0" class="md ig hi ly b fi me mf l mg mh"># Creating Security Group for ELB<br/>resource "aws_security_group" "demosg1" {<br/>  name        = "Demo Security Group"<br/>  description = "Demo Module"<br/>  vpc_id      = "${aws_vpc.demovpc.id}"</span><span id="9953" class="md ig hi ly b fi mi mf l mg mh"># Inbound Rules<br/>  # HTTP access from anywhere<br/>  ingress {<br/>    from_port   = 80<br/>    to_port     = 80<br/>    protocol    = "tcp"<br/>    cidr_blocks = ["0.0.0.0/0"]<br/>  }</span><span id="862d" class="md ig hi ly b fi mi mf l mg mh"># HTTPS access from anywhere<br/>  ingress {<br/>    from_port   = 443<br/>    to_port     = 443<br/>    protocol    = "tcp"<br/>    cidr_blocks = ["0.0.0.0/0"]<br/>  }</span><span id="769f" class="md ig hi ly b fi mi mf l mg mh"># SSH access from anywhere<br/>  ingress {<br/>    from_port   = 22<br/>    to_port     = 22<br/>    protocol    = "tcp"<br/>    cidr_blocks = ["0.0.0.0/0"]<br/>  }</span><span id="89ed" class="md ig hi ly b fi mi mf l mg mh"># Outbound Rules<br/>  # Internet access to anywhere<br/>  egress {<br/>    from_port   = 0<br/>    to_port     = 0<br/>    protocol    = "-1"<br/>    cidr_blocks = ["0.0.0.0/0"]<br/>  }<br/>}</span></pre><ul class=""><li id="8fa4" class="kh ki hi jf b jg kb jk kc jo ls js lt jw lu ka km kn ko kp bi translated">在这里，我为端口<strong class="jf hj"> 22，80 &amp; 443 </strong>创建入站规则，并为所有IP的所有端口打开出站连接。</li></ul><p id="9330" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">步骤10:- </strong>创建<strong class="jf hj"> AWS自动缩放组</strong></p><ul class=""><li id="23a2" class="kh ki hi jf b jg kb jk kc jo ls js lt jw lu ka km kn ko kp bi translated">创建<code class="du lv lw lx ly b">asg.tf</code>文件并将下面的代码添加到其中</li></ul><pre class="kw kx ky kz fd lz ly ma mb aw mc bi"><span id="30f4" class="md ig hi ly b fi me mf l mg mh">resource "aws_autoscaling_group" "web" {<br/>  name = "${aws_launch_configuration.web.name}-asg"</span><span id="f496" class="md ig hi ly b fi mi mf l mg mh">  min_size             = 1<br/>  desired_capacity     = 1<br/>  max_size             = 2<br/>  <br/>  health_check_type    = "ELB"<br/>  load_balancers = [<br/>    "${aws_elb.web_elb.id}"<br/>  ]</span><span id="acac" class="md ig hi ly b fi mi mf l mg mh">launch_configuration = "${aws_launch_configuration.web.name}"</span><span id="5822" class="md ig hi ly b fi mi mf l mg mh">enabled_metrics = [<br/>    "GroupMinSize",<br/>    "GroupMaxSize",<br/>    "GroupDesiredCapacity",<br/>    "GroupInServiceInstances",<br/>    "GroupTotalInstances"<br/>  ]</span><span id="a1c8" class="md ig hi ly b fi mi mf l mg mh">metrics_granularity = "1Minute"</span><span id="5f2a" class="md ig hi ly b fi mi mf l mg mh">vpc_zone_identifier  = [<br/>    "${aws_subnet.demosubnet.id}",<br/>    "${aws_subnet.demosubnet1.id}"<br/>  ]</span><span id="61aa" class="md ig hi ly b fi mi mf l mg mh"># Required to redeploy without an outage.<br/>  lifecycle {<br/>    create_before_destroy = true<br/>  }</span><span id="e038" class="md ig hi ly b fi mi mf l mg mh">tag {<br/>    key                 = "Name"<br/>    value               = "web"<br/>    propagate_at_launch = true<br/>  }</span><span id="7102" class="md ig hi ly b fi mi mf l mg mh">}</span></pre><ul class=""><li id="d6eb" class="kh ki hi jf b jg kb jk kc jo ls js lt jw lu ka km kn ko kp bi translated">将至少有1个实例来服务流量。</li><li id="5620" class="kh ki hi jf b jg kq jk kr jo ks js kt jw ku ka km kn ko kp bi translated">最多将有2个实例为交通服务。</li><li id="62d2" class="kh ki hi jf b jg kq jk kr jo ks js kt jw ku ka km kn ko kp bi translated">自动缩放组将在1个实例中启动</li><li id="2173" class="kh ki hi jf b jg kq jk kr jo ks js kt jw ku ka km kn ko kp bi translated">自动缩放组将从<code class="du lv lw lx ly b">ELB</code>中获得关于实例可用性的信息</li><li id="f6d3" class="kh ki hi jf b jg kq jk kr jo ks js kt jw ku ka km kn ko kp bi translated">我已经为一些云观察指标设置了一个集合，以监控自动扩展组的状态。</li><li id="9e06" class="kh ki hi jf b jg kq jk kr jo ks js kt jw ku ka km kn ko kp bi translated">从这个自动缩放组启动的每个实例将有一个设置为<code class="du lv lw lx ly b">web</code>的标签<code class="du lv lw lx ly b">Name</code>。</li></ul><p id="7634" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">步骤11:- </strong>创建<strong class="jf hj"> AWS自动缩放策略</strong></p><ul class=""><li id="a7c9" class="kh ki hi jf b jg kb jk kc jo ls js lt jw lu ka km kn ko kp bi translated">创建<code class="du lv lw lx ly b">asg_policy.tf</code>文件并添加下面的代码。</li></ul><pre class="kw kx ky kz fd lz ly ma mb aw mc bi"><span id="ea1b" class="md ig hi ly b fi me mf l mg mh">resource "aws_autoscaling_policy" "web_policy_up" {<br/>  name = "web_policy_up"<br/>  scaling_adjustment = 1<br/>  adjustment_type = "ChangeInCapacity"<br/>  cooldown = 300<br/>  autoscaling_group_name = "${aws_autoscaling_group.web.name}"<br/>}</span><span id="097e" class="md ig hi ly b fi mi mf l mg mh">resource "aws_cloudwatch_metric_alarm" "web_cpu_alarm_up" {<br/>  alarm_name = "web_cpu_alarm_up"<br/>  comparison_operator = "GreaterThanOrEqualToThreshold"<br/>  evaluation_periods = "2"<br/>  metric_name = "CPUUtilization"<br/>  namespace = "AWS/EC2"<br/>  period = "120"<br/>  statistic = "Average"<br/>  threshold = "70"</span><span id="acb4" class="md ig hi ly b fi mi mf l mg mh">dimensions = {<br/>    AutoScalingGroupName = "${aws_autoscaling_group.web.name}"<br/>  }</span><span id="8a17" class="md ig hi ly b fi mi mf l mg mh">alarm_description = "This metric monitor EC2 instance CPU utilization"<br/>  alarm_actions = [ "${aws_autoscaling_policy.web_policy_up.arn}" ]<br/>}</span><span id="937e" class="md ig hi ly b fi mi mf l mg mh">resource "aws_autoscaling_policy" "web_policy_down" {<br/>  name = "web_policy_down"<br/>  scaling_adjustment = -1<br/>  adjustment_type = "ChangeInCapacity"<br/>  cooldown = 300<br/>  autoscaling_group_name = "${aws_autoscaling_group.web.name}"<br/>}</span><span id="30e3" class="md ig hi ly b fi mi mf l mg mh">resource "aws_cloudwatch_metric_alarm" "web_cpu_alarm_down" {<br/>  alarm_name = "web_cpu_alarm_down"<br/>  comparison_operator = "LessThanOrEqualToThreshold"<br/>  evaluation_periods = "2"<br/>  metric_name = "CPUUtilization"<br/>  namespace = "AWS/EC2"<br/>  period = "120"<br/>  statistic = "Average"<br/>  threshold = "30"</span><span id="dda0" class="md ig hi ly b fi mi mf l mg mh">dimensions = {<br/>    AutoScalingGroupName = "${aws_autoscaling_group.web.name}"<br/>  }</span><span id="ea82" class="md ig hi ly b fi mi mf l mg mh">alarm_description = "This metric monitor EC2 instance CPU utilization"<br/>  alarm_actions = [ "${aws_autoscaling_policy.web_policy_down.arn}" ]<br/>}</span></pre><ul class=""><li id="70c6" class="kh ki hi jf b jg kb jk kc jo ls js lt jw lu ka km kn ko kp bi translated"><code class="du lv lw lx ly b">aws_autoscaling_policy</code>声明当<code class="du lv lw lx ly b">aws_cloudwatch_metric_alarm</code>触发时，AWS应如何更改自动缩放组实例计数。</li><li id="1df7" class="kh ki hi jf b jg kq jk kr jo ks js kt jw ku ka km kn ko kp bi translated"><code class="du lv lw lx ly b">cooldown</code>选项将等待300秒，然后再次增加自动缩放组。</li><li id="c381" class="kh ki hi jf b jg kq jk kr jo ks js kt jw ku ka km kn ko kp bi translated"><code class="du lv lw lx ly b">aws_cloudwatch_metric_alarm</code>是一个警报，如果我们的自动扩展组中所有实例的总CPU利用率在120秒内大于或等于<code class="du lv lw lx ly b">threshold</code>值70%,将触发该警报。</li><li id="bb10" class="kh ki hi jf b jg kq jk kr jo ks js kt jw ku ka km kn ko kp bi translated"><code class="du lv lw lx ly b">aws_cloudwatch_metric_alarm</code>是一个警报，如果我们的自动缩放组中所有实例的总CPU利用率在120秒内小于或等于<code class="du lv lw lx ly b">threshold</code>值30%,也会触发该警报。</li></ul><p id="3538" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">步骤12:- </strong>创建地形<strong class="jf hj">变量</strong>文件</p><ul class=""><li id="2b48" class="kh ki hi jf b jg kb jk kc jo ls js lt jw lu ka km kn ko kp bi translated">创建<code class="du lv lw lx ly b">vars.tf</code>文件，并将下面的代码添加到其中</li></ul><pre class="kw kx ky kz fd lz ly ma mb aw mc bi"><span id="9d23" class="md ig hi ly b fi me mf l mg mh"># Defining Public Key<br/>variable "public_key" {<br/>  default = "tests.pub"<br/>}</span><span id="9a34" class="md ig hi ly b fi mi mf l mg mh"># Defining Private Key<br/>variable "private_key" {<br/>  default = "tests.pem"<br/>}</span><span id="c629" class="md ig hi ly b fi mi mf l mg mh"># Definign Key Name for connection<br/>variable "key_name" {<br/>  default = "tests"<br/>  description = "Name of AWS key pair"<br/>}</span><span id="08eb" class="md ig hi ly b fi mi mf l mg mh"># Defining CIDR Block for VPC<br/>variable "vpc_cidr" {<br/>  default = "10.0.0.0/16"<br/>}</span><span id="147d" class="md ig hi ly b fi mi mf l mg mh"># Defining CIDR Block for Subnet<br/>variable "subnet_cidr" {<br/>  default = "10.0.1.0/24"<br/>}</span><span id="9a3f" class="md ig hi ly b fi mi mf l mg mh"># Defining CIDR Block for 2d Subnet<br/>variable "subnet1_cidr" {<br/>  default = "10.0.2.0/24"<br/>}</span></pre><p id="7131" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">步骤13:- </strong>创建一个<strong class="jf hj">用户数据</strong>文件</p><ul class=""><li id="ee8f" class="kh ki hi jf b jg kb jk kc jo ls js lt jw lu ka km kn ko kp bi translated">创建<code class="du lv lw lx ly b">data.sh</code>文件并将以下代码添加到其中</li></ul><pre class="kw kx ky kz fd lz ly ma mb aw mc bi"><span id="6a70" class="md ig hi ly b fi me mf l mg mh">sudo yum update -y<br/>sudo amazon-linux-extras install docker -y<br/>sudo service docker start<br/>sudo usermod -a -G docker ec2-user<br/>sudo chkconfig docker on<br/>sudo chmod 666 /var/run/docker.sock<br/>docker pull dhruvin30/dhsoniweb:v1<br/>docker run -d -p 80:80 dhruvin30/dhsoniweb:latest</span></pre><ul class=""><li id="025f" class="kh ki hi jf b jg kb jk kc jo ls js lt jw lu ka km kn ko kp bi translated">在这里，我正在安装docker并运行我的投资组合网站的docker图像</li></ul><p id="251c" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">所以，现在我们的全部代码都准备好了。我们需要运行以下步骤来创建基础架构。</p><ul class=""><li id="9979" class="kh ki hi jf b jg kb jk kc jo ls js lt jw lu ka km kn ko kp bi translated"><code class="du lv lw lx ly b">terraform init</code>初始化AWS提供者的工作目录和下载插件</li><li id="e3b5" class="kh ki hi jf b jg kq jk kr jo ks js kt jw ku ka km kn ko kp bi translated"><code class="du lv lw lx ly b">terraform plan</code>是为我们的代码创建执行计划</li><li id="0ac6" class="kh ki hi jf b jg kq jk kr jo ks js kt jw ku ka km kn ko kp bi translated"><code class="du lv lw lx ly b">terraform apply</code>是创建实际的基础设施。它将要求您提供<strong class="jf hj">访问密钥</strong>和<strong class="jf hj">秘密密钥</strong>，以便创建基础设施。因此，与其硬编码<strong class="jf hj">访问密钥</strong>和<strong class="jf hj">秘密密钥，</strong>不如在运行时应用。</li></ul><p id="3abc" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">terraform应用完成后，您可以在AWS控制台上验证资源。Terraform将创建以下资源。</p><ul class=""><li id="4641" class="kh ki hi jf b jg kb jk kc jo ls js lt jw lu ka km kn ko kp bi translated"><strong class="jf hj"> VPC </strong></li><li id="4b6c" class="kh ki hi jf b jg kq jk kr jo ks js kt jw ku ka km kn ko kp bi translated"><strong class="jf hj">自动缩放组</strong></li><li id="ba44" class="kh ki hi jf b jg kq jk kr jo ks js kt jw ku ka km kn ko kp bi translated"><strong class="jf hj">发射配置</strong></li><li id="fa57" class="kh ki hi jf b jg kq jk kr jo ks js kt jw ku ka km kn ko kp bi translated"><strong class="jf hj">自动缩放策略</strong></li><li id="5494" class="kh ki hi jf b jg kq jk kr jo ks js kt jw ku ka km kn ko kp bi translated"><strong class="jf hj">负载平衡器</strong></li><li id="42d3" class="kh ki hi jf b jg kq jk kr jo ks js kt jw ku ka km kn ko kp bi translated"><strong class="jf hj">互联网网关</strong></li><li id="2c3a" class="kh ki hi jf b jg kq jk kr jo ks js kt jw ku ka km kn ko kp bi translated"><strong class="jf hj">路由表</strong></li><li id="d932" class="kh ki hi jf b jg kq jk kr jo ks js kt jw ku ka km kn ko kp bi translated"><strong class="jf hj">安全组</strong></li><li id="27da" class="kh ki hi jf b jg kq jk kr jo ks js kt jw ku ka km kn ko kp bi translated"><strong class="jf hj">子网</strong></li><li id="5077" class="kh ki hi jf b jg kq jk kr jo ks js kt jw ku ka km kn ko kp bi translated"><strong class="jf hj">云手表报警</strong></li></ul><p id="787a" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">基础设施准备就绪后，您可以通过导航<code class="du lv lw lx ly b">http://DNS-of-Load-Balancer </code>来验证输出，您应该会看到下面的输出。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es mj"><img src="../Images/76e06c01aabf8596947920a8cda66635.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JKW1sdcItNIMCDJQLjFJkw.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx">Output</figcaption></figure><p id="2071" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">至此，您已经了解了如何设置动态自动扩展组和负载平衡器，以便将流量分配到多个可用性区域中的实例。你可以在这里  <strong class="jf hj">进一步探索地形<a class="ae kg" href="https://terraform.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="jf hj">。</strong></a></strong></p><p id="c9a2" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">你可以在我的<a class="ae kg" href="https://github.com/DhruvinSoni30/Terrafrom-ELB-ASG" rel="noopener ugc nofollow" target="_blank"> <strong class="jf hj"> GitHub </strong> </a>账号找到完整的代码。也可以随意查看我的其他库。</p><p id="1f82" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">如果您发现此指南有帮助，请点击👏按钮，也可以随意发表评论。</p><p id="5198" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">关注更多类似的故事😊</p></div></div>    
</body>
</html>