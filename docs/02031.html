<html>
<head>
<title>Going Real Time with Typescript and WebSockets.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Typescript和WebSockets实现实时。</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/going-real-time-with-typescript-and-websockets-fe11d1447f44?source=collection_archive---------9-----------------------#2021-05-02">https://medium.com/geekculture/going-real-time-with-typescript-and-websockets-fe11d1447f44?source=collection_archive---------9-----------------------#2021-05-02</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/a6a5cde5c548c3d9e1a87f0fdd1eb72d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aWj-iaLLtT4M2SGuqZCotA.png"/></div></div></figure><div class=""/><p id="50ad" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在我的整个学士学位期间，我对机器学习及其应用产生了浓厚的兴趣。所以很自然地，我大学四年的大部分时间都花在了不同规模的人工智能项目上。直到毕业后，我才第一次涉足Web开发的海洋。这在很大程度上是因为我在一家初创公司的新工作，要求我帮助公司开发软件，以支持一个正在进行的大型计算机视觉项目。</p><p id="f1df" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">但是只有当我写了第一行React代码，加上Typescript的优雅，我才开始真正欣赏GUI开发的艺术。然而，前面的道路是漫长而艰巨的。因此，这一系列的帖子不仅是我内化一些概念的一种方式，也是与其他刚刚起步的人分享一些想法的一种方式。我将向您介绍我的开发过程，同时描述过程中面临的警告以及我如何尝试解决它们。</p><p id="966c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这篇文章中，我首先构建一个简单的应用程序，它可以用来在两个或多个用户之间发送实时聊天消息。</p><h1 id="b612" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">反应</h1><p id="2360" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">React是由脸书开发的GUI框架。我非常喜欢React，主要是因为两个原因:</p><ol class=""><li id="31e8" class="kr ks ht is b it iu ix iy jb kt jf ku jj kv jn kw kx ky kz bi translated">它将HTML与Javascript结合起来，允许您轻松地将服务器端脚本与显示组件集成在一起。</li><li id="1517" class="kr ks ht is b it la ix lb jb lc jf ld jj le jn kw kx ky kz bi translated">React是相当高的性能。它为您提供了大量的组件，可以用来最小化GUI需要刷新的次数和频率。</li></ol><h1 id="5a42" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">以打字打的文件</h1><p id="b476" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">虽然typescript通常是大型项目的首选，但是一旦您习惯了它，它可以节省大量的时间。它利用接口和类型来确保编译时的类型安全。这意味着不再意外地试图打印空变量的长度或向整数添加字符串。</p><p id="f4dd" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Typescript文件以扩展名<code class="du lf lg lh li b">.tsx</code>保存。重要的是将它们与您在处理React和Javascript时可能遇到的其他类型的文件区分开来，例如<code class="du lf lg lh li b">.js</code> <code class="du lf lg lh li b">.ts</code>和<code class="du lf lg lh li b">.jsx</code></p><h1 id="2390" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">计算机编程语言</h1><p id="2351" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">对于服务器，我使用Flask-SocketIO接受和广播来自使用WebSocket协议的各种客户机的消息。</p><p id="91eb" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因为您正在阅读这篇文章，而不是题为“Web开发基础”的文章，所以我假设您对React和Python有所了解。然而，对于门外汉，我将在整篇文章的相关地方留下所有主要概念的链接。所以让我们开始吧！</p><p id="39d7" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">本文中使用的所有代码将在这个<a class="ae lj" href="https://github.com/PawanBhandarkar/DemoProjects/tree/master/FlaskReactWebSocketDemo" rel="noopener ugc nofollow" target="_blank"> Github回购。</a></p><h1 id="af41" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">第1部分:后端。</h1><p id="b07b" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">通常，每当我开始构建一个基于web的项目时，我都喜欢从后端开始。这有助于我从一开始就摆脱大部分繁重的工作。然而，由于这是一个简单的项目，后端相当简单。</p><h2 id="a845" class="lk jp ht bd jq ll lm ln ju lo lp lq jy jb lr ls kc jf lt lu kg jj lv lw kk lx bi translated">步骤1:创建一个conda虚拟env并激活它。</h2><p id="de27" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">使用新的虚拟环境来避免模块版本冲突始终是最佳实践。</p><pre class="ly lz ma mb fd mc li md me aw mf bi"><span id="fb60" class="lk jp ht li b fi mg mh l mi mj">conda create -n chatroom python==3.7<br/>conda activate chatroom</span></pre><h2 id="448c" class="lk jp ht bd jq ll lm ln ju lo lp lq jy jb lr ls kc jf lt lu kg jj lv lw kk lx bi translated">步骤2:安装所需的python模块</h2><p id="e5af" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">我们将使用flask-socketio和gevent来托管websocket服务器。</p><pre class="ly lz ma mb fd mc li md me aw mf bi"><span id="8365" class="lk jp ht li b fi mg mh l mi mj">pip3 install flask_socketio gevent gevent-websocket</span></pre><h2 id="6cd4" class="lk jp ht bd jq ll lm ln ju lo lp lq jy jb lr ls kc jf lt lu kg jj lv lw kk lx bi translated">步骤3:构建服务器</h2><p id="2995" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">感谢Flask python库背后的聪明才智，我们只用12行代码就可以建立并运行一个WebSocket服务器，如下所示。此服务器的唯一目的是接受传入的客户端连接请求，并将消息广播给所有连接的客户端。</p><figure class="ly lz ma mb fd hk"><div class="bz dy l di"><div class="mk ml l"/></div></figure><p id="0498" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们现在可以使用</p><pre class="ly lz ma mb fd mc li md me aw mf bi"><span id="c9a7" class="lk jp ht li b fi mg mh l mi mj"> python3 server.py</span></pre><h1 id="202d" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">第2部分:前端</h1><p id="2d39" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">对于前端，我使用React-Typescript。我还为我的组件使用React-Boostrap CSS样式。得益于<a class="ae lj" href="https://react-bootstrap.github.io" rel="noopener ugc nofollow" target="_blank">反应堆启动带</a> npm模块，这变得很方便。最后，我还使用<a class="ae lj" href="https://www.npmjs.com/package/socket.io-client" rel="noopener ugc nofollow" target="_blank"> Socket.io-client </a> npm模块来建立客户端套接字连接。</p><h2 id="4ddf" class="lk jp ht bd jq ll lm ln ju lo lp lq jy jb lr ls kc jf lt lu kg jj lv lw kk lx bi translated">步骤1:创建一个Typescript项目</h2><p id="543d" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">现在我们进入这个项目最复杂的部分。但是不用担心！我们一步一步来。</p><p id="a196" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">首先，我们需要初始化一个新的typescript项目。最简单的方法是使用<a class="ae lj" href="https://reactjs.org/docs/create-a-new-react-app.html#create-react-app" rel="noopener ugc nofollow" target="_blank"> create-react-app </a>。最近，他们增加了对typescript的支持，减少了90%的麻烦！</p><p id="c54a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们还将使用React-Bootstrap GUI组件，因为它允许我们拥有一个看起来不错的页面，而不必钻研CSS，这超出了本文的范围。我们还需要为typescript安装相应的类型。</p><pre class="ly lz ma mb fd mc li md me aw mf bi"><span id="d99b" class="lk jp ht li b fi mg mh l mi mj">npx create-react-app gui --template typescript<br/>cd gui<br/>npm i react-bootstrap bootstrap<br/>npm i @types/react-bootstrap @types/bootstrap --save-dev<br/>npm i socket.io-client @types/socket.io-client</span></pre><p id="0473" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">虽然这应该是开箱即用的，但目前有一些问题<a class="ae lj" href="https://github.com/facebook/create-react-app/issues/10109#issuecomment-752650608" rel="noopener ugc nofollow" target="_blank">阻止您这样做。以下命令将修复它:</a></p><pre class="ly lz ma mb fd mc li md me aw mf bi"><span id="57a7" class="lk jp ht li b fi mg mh l mi mj">npm i @types/react --save-dev</span></pre><p id="6b4c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在。您可以运行<code class="du lf lg lh li b">npm start</code>，它应该会加载ReactTypescript的登录页面:</p><figure class="ly lz ma mb fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mm"><img src="../Images/15ae1a4f9aaa78ddd9158ecdbdd9c398.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D-CigtIEHcJwCOsdK-D39w.png"/></div></div></figure><p id="7112" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们在半路上🎉</p><h2 id="c214" class="lk jp ht bd jq ll lm ln ju lo lp lq jy jb lr ls kc jf lt lu kg jj lv lw kk lx bi translated">步骤2:构建GUI</h2><p id="54f2" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">接下来，我们必须用我们的代码替换默认模板，使它看起来更像一个聊天应用程序。</p><p id="7d39" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">正如这篇博文中所描述的，最佳实践是利用React上下文将socket对象声明为一个全局可访问的组件。因此，让我们为此创建一个名为<code class="du lf lg lh li b">socket.tsx</code>的文件，并添加以下代码。</p><figure class="ly lz ma mb fd hk"><div class="bz dy l di"><div class="mk ml l"/></div></figure><p id="6f0c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来，我们创建一个名为<code class="du lf lg lh li b">ChatRoom.tsx</code>的文件，它将包含我们的大部分GUI代码。为此，我们将使用React <a class="ae lj" href="https://www.freecodecamp.org/news/react-components-jsx-props-for-beginners/" rel="noopener ugc nofollow" target="_blank">功能组件</a>。</p><p id="68de" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">注意:在下面的代码列表中，<code class="du lf lg lh li b">...</code>用来表示为了便于解释，某些代码被省略了。</p><p id="3964" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">首先，我们用将要使用的状态创建并导出一个基本的功能组件。</p><figure class="ly lz ma mb fd hk"><div class="bz dy l di"><div class="mk ml l"/></div></figure><p id="1bc6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在上述要点中，状态是:</p><ol class=""><li id="9bca" class="kr ks ht is b it iu ix iy jb kt jf ku jj kv jn kw kx ky kz bi translated"><code class="du lf lg lh li b">socket</code>:socket对象的上下文变量。</li><li id="513b" class="kr ks ht is b it la ix lb jb lc jf ld jj le jn kw kx ky kz bi translated"><code class="du lf lg lh li b">username</code>:用于存储每个新用户的标识。</li><li id="a23d" class="kr ks ht is b it la ix lb jb lc jf ld jj le jn kw kx ky kz bi translated"><code class="du lf lg lh li b">message</code>:用于在发送前存储新输入的信息。</li><li id="85c0" class="kr ks ht is b it la ix lb jb lc jf ld jj le jn kw kx ky kz bi translated"><code class="du lf lg lh li b">allMessages</code>:用于讲述聊天历史。</li><li id="11ef" class="kr ks ht is b it la ix lb jb lc jf ld jj le jn kw kx ky kz bi translated"><code class="du lf lg lh li b">error</code>:用于存储错误信息(可选)。</li><li id="6b8b" class="kr ks ht is b it la ix lb jb lc jf ld jj le jn kw kx ky kz bi translated"><code class="du lf lg lh li b">loggedIn</code>:用于决定显示登录页面还是聊天页面。</li></ol><p id="8586" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来，让我们定义一个钩子来对传入的消息做出反应。我们将使用<code class="du lf lg lh li b">useEffect()</code>钩子来达到我们的目的。</p><figure class="ly lz ma mb fd hk"><div class="bz dy l di"><div class="mk ml l"/></div></figure><p id="7cf0" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">React Hooks有时可能有点挑战性，即使对于经验丰富的Web开发人员也是如此。所以快速总结一下<code class="du lf lg lh li b">useEffect()</code>钩子，就知道:</p><ol class=""><li id="7c39" class="kr ks ht is b it iu ix iy jb kt jf ku jj kv jn kw kx ky kz bi translated">在<code class="du lf lg lh li b">useEffect(()=&gt;{})</code>中定义的函数将在组件安装时执行一次，每次在方括号<code class="du lf lg lh li b">[]</code>中声明的变量改变时执行一次</li><li id="4d3e" class="kr ks ht is b it la ix lb jb lc jf ld jj le jn kw kx ky kz bi translated">它们异步运行，应该优先用于非阻塞操作，比如与后端通信。</li></ol><p id="418d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来，我们将创建一个函数，当用户单击send按钮时，该函数向服务器发送消息:</p><figure class="ly lz ma mb fd hk"><div class="bz dy l di"><div class="mk ml l"/></div></figure><p id="b63a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于上述内容，我们还定义了一个用于消息的typescript接口。也就是说，我们不是向服务器发送普通的消息字符串，而是将消息和当前登录用户的用户名一起发送。这有助于区分聊天室中的消息。</p><p id="fe16" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后，我们将创建一个函数来设置登录状态，以便我们可以从登录页面转换到cat页面。</p><figure class="ly lz ma mb fd hk"><div class="bz dy l di"><div class="mk ml l"/></div></figure><p id="81e3" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">太好了！我们快到了！现在剩下的就是添加实际的显示组件了。如前所述，我们将使用两种布局:</p><figure class="ly lz ma mb fd hk"><div class="bz dy l di"><div class="mk ml l"/></div></figure><p id="40e4" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">注意:最佳实践是为每个React组件使用单独的文件。但是因为我想保持示例项目相当简单，所以我选择在主组件中定义它们。</p><p id="a5c9" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后，我们添加一些逻辑来选择适当的显示组件:</p><figure class="ly lz ma mb fd hk"><div class="bz dy l di"><div class="mk ml l"/></div></figure><h2 id="3d75" class="lk jp ht bd jq ll lm ln ju lo lp lq jy jb lr ls kc jf lt lu kg jj lv lw kk lx bi translated">第三步:把所有东西放在一起</h2><p id="38d2" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">现在剩下的就是将所有这些组件放在<code class="du lf lg lh li b">App.tsx</code>文件中，这样我们就可以使用<code class="du lf lg lh li b">npm start</code>来运行它。</p><figure class="ly lz ma mb fd hk"><div class="bz dy l di"><div class="mk ml l"/></div></figure><h2 id="107c" class="lk jp ht bd jq ll lm ln ju lo lp lq jy jb lr ls kc jf lt lu kg jj lv lw kk lx bi translated">第四步:运行应用程序！</h2><p id="e278" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">祝贺你到达终点线！您现在可以运行您的代码，并惊叹于您新建的聊天室！从项目的根目录运行以下命令:</p><pre class="ly lz ma mb fd mc li md me aw mf bi"><span id="fe69" class="lk jp ht li b fi mg mh l mi mj">python3 server.py<br/>cd gui <br/>npm start</span></pre><p id="a7e4" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最终的应用程序看起来会像这样。请注意，我已经在两个独立的浏览器窗口上启动了<code class="du lf lg lh li b">http://localhost:3000</code>，以可视化他们之间的实时通信。</p><figure class="ly lz ma mb fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mn"><img src="../Images/7c932d5c9cb450f3d529e6907cba7828.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*ZGXE-oyCBAI6acij8tIRJQ.gif"/></div></div><figcaption class="mo mp et er es mq mr bd b be z dx">And that’s a wrap!</figcaption></figure><h1 id="af6d" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">结论</h1><p id="1ebe" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">请注意，尽管最终应用程序看起来非常简单，但是您现在已经了解了足够多的知识，可以将这些概念应用到您自己的项目中。以下是关于如何推进这个项目的一些想法:</p><ol class=""><li id="d1f9" class="kr ks ht is b it iu ix iy jb kt jf ku jj kv jn kw kx ky kz bi translated">添加CSS样式，使其看起来更有吸引力</li><li id="d5f3" class="kr ks ht is b it la ix lb jb lc jf ld jj le jn kw kx ky kz bi translated">添加对通过Websocket协议发送图像的支持。</li><li id="f347" class="kr ks ht is b it la ix lb jb lc jf ld jj le jn kw kx ky kz bi translated">在线托管应用程序(例如在Heroku上)</li><li id="694a" class="kr ks ht is b it la ix lb jb lc jf ld jj le jn kw kx ky kz bi translated">尝试和应用你自己的想法，让它脱颖而出！</li></ol><p id="4664" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">感谢您完整阅读这篇文章。如果你喜欢，一定要分享并留下一些你希望我接下来报道的评论。一如既往，建设性的批评总是受欢迎的！快乐学习！</p></div></div>    
</body>
</html>