<html>
<head>
<title>Building a Multi-Tenant App With NodeJS + MongoDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用NodeJS + MongoDB构建多租户应用</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/building-a-multi-tenant-app-with-nodejs-mongodb-ec9b5be6e737?source=collection_archive---------0-----------------------#2021-03-07">https://medium.com/geekculture/building-a-multi-tenant-app-with-nodejs-mongodb-ec9b5be6e737?source=collection_archive---------0-----------------------#2021-03-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/cff52b38025dedc32a7eb9b49f122b65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ay3JkGpCCp46JM3Wq-iLIQ.jpeg"/></div></div></figure><p id="f174" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">今天，我们完成了一个应用程序的重写，并将其投入生产。这是一次从单租户Ruby on Rails + ReactJS到多租户MERN的迁移，我想借此机会分享一些东西，希望有些人会觉得相关和有用。</p><p id="3774" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">什么是多租户app？构建和部署多租户应用的好处和缺点是什么？这篇文章不打算讨论这些细节。TL；灾难恢复多租户应用程序允许您部署可服务多个客户的单一代码库，并允许您优化服务应用程序所需的基础架构。这已经成为现代基于云的SaaS应用的事实。</p><p id="0233" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你有一些Ruby on Rails的背景知识，你可能会遇到一个叫做<a class="ae jo" href="https://github.com/influitive/apartment" rel="noopener ugc nofollow" target="_blank">公寓</a>的宝石，它是任何RoR多租户应用程序构建的基础。但是如果你在NodeJS中构建一个app，你会怎么做呢？NodeJS的公寓gem有没有等价的库？看到NodeJS + MongoDB在现代web应用程序开发中非常流行，人们会认为已经有一些稳定且流行的东西了。啊，不太好！就像其他人一样，我试图用MongoDB在NodeJS中找到一些现成的多租户解决方案，但没有找到任何好的东西，所以我决定从头开始构建一些东西(查看<a class="ae jo" href="https://github.com/syook/node_mongo_multitenant" rel="noopener ugc nofollow" target="_blank">样例repo </a>以获得完整的样板代码)。</p></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><p id="9568" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，让我们深入了解一下多租户NodeJS + MongoDB应用程序的构建模块。</p><p id="ac18" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">app(和db)分为2类:<strong class="is hj">租户app </strong>和<strong class="is hj">管理员app</strong>(API路由被隔离为<code class="du jw jx jy jz b">/admin</code>和<code class="du jw jx jy jz b">/tenant</code>)。</p><p id="a39a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">管理应用</strong>用于管理租户创建、存储和获取租户数据库连接信息等。</p><p id="68cb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">租户应用</strong>是每个租户将使用的主要应用，在这里您将编写业务逻辑的核心，如用户管理等。</p><p id="d20d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">每个租户将获得自己的数据库，该数据库在管理应用程序中创建新租户时进行初始化。为了简化设置，所有数据库(管理员和租户)都将托管在同一个mongoDB实例中，并带有一个连接池，一个公共数据库连接管理器将管理数据库连接池，但这可以根据您的架构和偏好非常容易地向外扩展。</p><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ka"><img src="../Images/da1234424753b8cb9e0585938099cc3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yFAnQXN029oB1v3Z99iR7Q.png"/></div></div><figcaption class="kf kg et er es kh ki bd b be z dx">admin and tenat db segregation</figcaption></figure><p id="673c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">以下是该系统的关键组件:</p><ul class=""><li id="b055" class="kj kk hi is b it iu ix iy jb kl jf km jj kn jn ko kp kq kr bi translated"><code class="du jw jx jy jz b">initAdminDbConnection</code>:通过连接到管理数据库URI返回数据库连接池。</li></ul><figure class="kb kc kd ke fd ij"><div class="bz dy l di"><div class="ks kt l"/></div></figure><ul class=""><li id="a80e" class="kj kk hi is b it iu ix iy jb kl jf km jj kn jn ko kp kq kr bi translated"><code class="du jw jx jy jz b">initTenantDbConnection</code>:通过连接到租户数据库URI返回数据库连接池。</li></ul><figure class="kb kc kd ke fd ij"><div class="bz dy l di"><div class="ks kt l"/></div></figure><ul class=""><li id="dd48" class="kj kk hi is b it iu ix iy jb kl jf km jj kn jn ko kp kq kr bi translated">这是一个帮助文件，它将管理所有的数据库连接请求。</li></ul><p id="d679" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du jw jx jy jz b">connectAllDb</code>方法需要在<code class="du jw jx jy jz b">index.js</code>中的应用程序启动时调用。这个方法将获得在admin db中注册的所有租户，然后为每个租户初始化db连接。缓存变量<code class="du jw jx jy jz b">connectionMap</code>将保存所有初始化的租户数据库连接。每当在管理应用程序中创建新租户时，该租户的db连接都应该被添加到这个连接缓存中(您可以添加一个方法来完成此操作，或者只是简单地从服务中再次调用<code class="du jw jx jy jz b">connectAllDb</code>)。</p><p id="b920" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">每当发出任何租户数据库请求时，<code class="du jw jx jy jz b">getConnectionByTenant</code>方法将连接到所需的租户数据库。</p><p id="b92c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">每当发出任何admin db请求时，<code class="du jw jx jy jz b">getAdminConnection</code>方法将提供到admin db的连接。</p><figure class="kb kc kd ke fd ij"><div class="bz dy l di"><div class="ks kt l"/></div></figure><ul class=""><li id="dc83" class="kj kk hi is b it iu ix iy jb kl jf km jj kn jn ko kp kq kr bi translated"><code class="du jw jx jy jz b">connectionResolver</code>:这个中间件将负责为每个api请求解析db连接，并使db连接可用于api处理链的下游。</li></ul><p id="20da" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于每个租户api请求，需要调用<code class="du jw jx jy jz b">resolveTenant</code>中间件方法来设置所需的租户数据库连接。我们需要在标头中传递租户标识符，然后用它来设置db连接。每个请求都需要确定范围，以便独立处理一个请求(这里我使用<a class="ae jo" href="https://www.npmjs.com/package/continuation-local-storage" rel="noopener ugc nofollow" target="_blank">continuation-local-storage</a>来保持到租户数据库的连接，直到请求被处理)。</p><p id="ab3d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于每个admin api请求，我们使用<code class="du jw jx jy jz b">setAdminDb</code>中间件方法以相同的方式设置db到admin db的连接。</p><figure class="kb kc kd ke fd ij"><div class="bz dy l di"><div class="ks kt l"/></div></figure><ul class=""><li id="3954" class="kj kk hi is b it iu ix iy jb kl jf km jj kn jn ko kp kq kr bi translated">示例路由以及用于解析数据库连接的中间件</li></ul><figure class="kb kc kd ke fd ij"><div class="bz dy l di"><div class="ks kt l"/></div></figure><ul class=""><li id="6b2f" class="kj kk hi is b it iu ix iy jb kl jf km jj kn jn ko kp kq kr bi translated"><strong class="is hj">管理应用程序API</strong>(租户服务):用于获取所有租户和创建新租户的租户服务示例API。由<code class="du jw jx jy jz b">connectionResolver</code>中间件方法提供的管理数据库连接作为参数传递给服务方法，然后服务方法调用所需的模型并在模型上执行数据库查询。</li></ul><figure class="kb kc kd ke fd ij"><div class="bz dy l di"><div class="ks kt l"/></div></figure><ul class=""><li id="7255" class="kj kk hi is b it iu ix iy jb kl jf km jj kn jn ko kp kq kr bi translated"><strong class="is hj">租户应用程序API</strong>(用户服务):用户服务的示例API，将用于获取租户的所有用户和创建新用户。由<code class="du jw jx jy jz b">connectionResolver</code>中间件方法提供的租户数据库连接作为参数传递给服务方法，然后服务方法调用所需的模型并在模型上执行数据库查询。</li></ul><figure class="kb kc kd ke fd ij"><div class="bz dy l di"><div class="ks kt l"/></div></figure><p id="7862" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">API请求流程</strong></p><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ku"><img src="../Images/983dc2e94d2a2b4e3233422e2d8ebc11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cHC-EKblXK6gk-djSm71Ig.png"/></div></div><figcaption class="kf kg et er es kh ki bd b be z dx">api routes with middleware for resolving db connections</figcaption></figure><p id="017f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这只是一个基本设置，可以根据所设计系统的需要进行修改。例如，在我们的生产应用程序中，我使用<a class="ae jo" href="https://www.npmjs.com/package/awilix" rel="noopener ugc nofollow" target="_blank"> awilix </a>进行DI和管理范围，因此有些事情的处理方式与这里描述的略有不同。我可能会写另一篇后续文章，在未来提出这些细节，并与DI一起提交一个样板文件，以及我们在生产中运行应用程序时学到的一些技巧。直到那时快乐编码:)</p></div></div>    
</body>
</html>