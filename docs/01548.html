<html>
<head>
<title>Deploying Multi-Node Kubernetes Cluster on AWS Using Ansible Automation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Ansible Automation在AWS上部署多节点Kubernetes集群</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/deploying-multi-node-kubernetes-cluster-on-aws-using-ansible-automation-7d8a5eb25c53?source=collection_archive---------3-----------------------#2021-04-15">https://medium.com/geekculture/deploying-multi-node-kubernetes-cluster-on-aws-using-ansible-automation-7d8a5eb25c53?source=collection_archive---------3-----------------------#2021-04-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/77e115d3c99cb0b4fc44787d5694b763.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*1DhdzotBGUvkhFu8ZmZwfQ.gif"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">Created by Raktim</figcaption></figure><div class=""/><div class=""><h2 id="37ac" class="pw-subtitle-paragraph iu hw hx bd b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl dx translated">有没有想过——为什么在当今的技术世界中“学习多种技术并集成它们对工程师来说很重要”？或者，当你有了在AWS、Ansible &amp; Kubernetes上工作的知识和技能，你能做什么？让我们试着找出这些答案…</h2></div><h1 id="e897" class="jm jn hx bd jo jp jq jr js jt ju jv jw jd jx je jy jg jz jh ka jj kb jk kc kd bi translated">为什么是多种技术？</h1><figure class="kf kg kh ki fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ke"><img src="../Images/c554ca9b9cf2d2d5e723151a59e1fe7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tkOcxHLaIRkb-bmoUo7BPQ.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">Source: Google</figcaption></figure><blockquote class="kj"><p id="8f42" class="kk kl hx bd km kn ko kp kq kr ks kt dx translated">让我向您介绍一下我学习多种技术的旅程&amp;我得到了什么结果。</p></blockquote><ul class=""><li id="e314" class="ku kv hx kw b kx ky kz la lb lc ld le lf lg kt lh li lj lk bi translated">1年前开始学习<strong class="kw hy"> Linux &amp; Docker </strong>。花了将近<strong class="kw hy"> 1到2个月</strong>才掌握这些技术的大部分概念。然后我开始学习<strong class="kw hy"> Kubernetes </strong> &amp;又花了<strong class="kw hy"> 2个月</strong>去练习&amp;探索Kubernetes所有可能的方面。</li></ul><blockquote class="ll lm ln"><p id="c76a" class="lo lp lq kw b kx lr iy ls kz lt jb lu lv lw lx ly lz ma mb mc md me mf mg kt hb bi translated"><strong class="kw hy">注:</strong>你可能在想<strong class="kw hy">为什么要花4个月的时间来学习Docker、K8s、Linux这些简单的技术。但是有趣的是，我同时学习很多东西，所以我不会对一件事感到厌倦。目前我从事ML、DevOps、MLOps、CC、大数据、Web &amp;移动开发、全栈开发&amp;等等。</strong></p></blockquote><ul class=""><li id="ada1" class="ku kv hx kw b kx lr kz lt lb mh ld mi lf mj kt lh li lj lk bi translated">然后我开始学习<strong class="kw hy"> Ansible </strong>，<strong class="kw hy">当今业界要求最苛刻的自动化工具之一。我开始自动化配置任务的时刻终于到来了。<strong class="kw hy">最有趣的任务之一是使用Ansible建立多节点kubernetes集群。</strong>在本地虚拟机上完成这项任务非常有趣。</strong></li><li id="ef8e" class="ku kv hx kw b kx mk kz ml lb mm ld mn lf mo kt lh li lj lk bi translated">然后我开始学习AWS，花了4个多月的时间学习那里的许多服务。使用Terraform &amp; Ansible 自动化AWS供应任务的时刻终于到来了。我实际上很喜欢做这些任务&amp;完成后，与全世界分享我的作品感觉棒极了:)</li></ul><blockquote class="ll lm ln"><p id="6ab1" class="lo lp lq kw b kx lr iy ls kz lt jb lu lv lw lx ly lz ma mb mc md me mf mg kt hb bi translated"><strong class="kw hy"> <em class="hx">长话短说</em> </strong> <em class="hx"> —我们总觉得要拘泥于一个领域或一项技术。获得体面的工作很好，但在当今的行业中，无论我们实施什么，我们都在从云计算中获取资源，我们希望消除所有的手动任务。</em>  <em class="hx">所以，</em> <strong class="kw hy"> <em class="hx">学习CC &amp; DevOps自动化很重要&amp;同样将它们整合起来也重要得多。</em> </strong></p></blockquote><h1 id="34fa" class="jm jn hx bd jo jp jq jr js jt ju jv jw jd jx je jy jg jz jh ka jj kb jk kc kd bi translated">什么是Kubernetes，Ansible &amp; AWS？</h1><figure class="kf kg kh ki fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mp"><img src="../Images/2a88b9f20e12af57475e431196459caf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wKp8VM_3HYPU-zuzC0tRrg.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">Created by Raktim</figcaption></figure><ul class=""><li id="d59c" class="ku kv hx kw b kx lr kz lt lb mh ld mi lf mj kt lh li lj lk bi translated">我百分之百肯定，如果你正在阅读这篇博客，意味着你要么知道这些技术，要么想了解它们。但是这个博客更关注如何整合这些技术，而不是这些技术是什么。所以，如果你是来学习这些技术的，那么我强烈建议你使用下面提到的我的博客…</li></ul><div class="hh hi ez fb hj mq"><a href="https://raktimmidya.medium.com/getting-started-with-aws-terraform-293e9125dff" rel="noopener follow" target="_blank"><div class="mr ab dw"><div class="ms ab mt cl cj mu"><h2 class="bd hy fi z dy mv ea eb mw ed ef hw bi translated">AWS &amp; Terraform入门。</h2><div class="mx l"><h3 class="bd b fi z dy mv ea eb mw ed ef dx translated">如何入门使用Terraform在AWS中构建基础设施？</h3></div><div class="my l"><p class="bd b fp z dy mv ea eb mw ed ef dx translated">raktimmidya.medium.com</p></div></div><div class="mz l"><div class="na l nb nc nd mz ne hp mq"/></div></div></a></div><div class="hh hi ez fb hj mq"><a rel="noopener follow" target="_blank" href="/swlh/getting-started-with-ansible-ee31be8c6a75"><div class="mr ab dw"><div class="ms ab mt cl cj mu"><h2 class="bd hy fi z dy mv ea eb mw ed ef hw bi translated">Ansible入门</h2><div class="mx l"><h3 class="bd b fi z dy mv ea eb mw ed ef dx translated">让我们学习Ansible的基础知识以及一个实用工具——使用Ansible进行docker环境供应。</h3></div><div class="my l"><p class="bd b fp z dy mv ea eb mw ed ef dx translated">medium.com</p></div></div><div class="mz l"><div class="nf l nb nc nd mz ne hp mq"/></div></div></a></div><div class="hh hi ez fb hj mq"><a rel="noopener follow" target="_blank" href="/swlh/ci-cd-pipeline-using-git-jenkins-kubernetes-ee06da43c5b0"><div class="mr ab dw"><div class="ms ab mt cl cj mu"><h2 class="bd hy fi z dy mv ea eb mw ed ef hw bi translated">使用Git、Jenkins &amp; Kubernetes的CI/CD管道</h2><div class="mx l"><h3 class="bd b fi z dy mv ea eb mw ed ef dx translated">在本文中，我将使用Jenkins、Git和Kubernetes演示持续集成和持续部署…</h3></div><div class="my l"><p class="bd b fp z dy mv ea eb mw ed ef dx translated">medium.com</p></div></div><div class="mz l"><div class="ng l nb nc nd mz ne hp mq"/></div></div></a></div><h1 id="20e3" class="jm jn hx bd jo jp jq jr js jt ju jv jw jd jx je jy jg jz jh ka jj kb jk kc kd bi translated">让我们看看问题陈述:</h1><ol class=""><li id="6558" class="ku kv hx kw b kx nh kz ni lb nj ld nk lf nl kt nm li lj lk bi translated">创建可启动3个AWS EC2实例的角色。</li><li id="30b7" class="ku kv hx kw b kx mk kz ml lb mm ld mn lf mo kt nm li lj lk bi translated">创建一个可行的角色来配置这些实例上的Docker。</li><li id="be5f" class="ku kv hx kw b kx mk kz ml lb mm ld mn lf mo kt nm li lj lk bi translated">使用kubeadm在上面创建的EC2实例上创建角色来配置K8S主节点和K8S工作节点。</li></ol><h2 id="118f" class="nn jn hx bd jo no np nq js nr ns nt jw lb nu nv jy ld nw nx ka lf ny nz kc oa bi translated">视频演示:</h2><div class="hh hi ez fb hj mq"><a href="https://www.linkedin.com/posts/raktimmidya_blogging-arth2020-aws-activity-6788451728208482304-G9ed" rel="noopener  ugc nofollow" target="_blank"><div class="mr ab dw"><div class="ms ab mt cl cj mu"><h2 class="bd hy fi z dy mv ea eb mw ed ef hw bi translated">LinkedIn上的Raktim Midya博客#aws #kubernetes #ansible</h2><div class="mx l"><h3 class="bd b fi z dy mv ea eb mw ed ef dx translated">使用Ansible Automation在AWS上设置Kubernetes多节点集群的视频演示…🔥</h3></div><div class="my l"><p class="bd b fp z dy mv ea eb mw ed ef dx translated">www.linkedin.com</p></div></div><div class="mz l"><div class="ob l nb nc nd mz ne hp mq"/></div></div></a></div><h1 id="cbc7" class="jm jn hx bd jo jp jq jr js jt ju jv jw jd jx je jy jg jz jh ka jj kb jk kc kd bi translated">先决条件:</h1><p id="5699" class="pw-post-body-paragraph lo lp hx kw b kx nh iy ls kz ni jb lu lb oc lx ly ld od mb mc lf oe mf mg kt hb bi translated">我知道我知道，问题陈述看起来非常简单，但是这个任务并不小。不要担心，因为我会在15分钟后讨论我的代码&amp; <strong class="kw hy">的每一点&amp;，你一定会觉得——“哇…这是一个了不起的自动化:)”</strong></p><h2 id="4a4a" class="nn jn hx bd jo no np nq js nr ns nt jw lb nu nv jy ld nw nx ka lf ny nz kc oa bi translated">但是在进入编码部分之前，这里有一些理解这项任务的基本先决条件…</h2><ul class=""><li id="518f" class="ku kv hx kw b kx nh kz ni lb nj ld nk lf nl kt lh li lj lk bi translated"><strong class="kw hy">你肯定需要AWS EC2实例的基础知识，可转换角色&amp; Kubernetes多节点集群。</strong></li><li id="a1c7" class="ku kv hx kw b kx mk kz ml lb mm ld mn lf mo kt lh li lj lk bi translated">我使用我的本地Windows机器&amp;在那里我使用Oracle VM box来运行Linux操作系统。在我的虚拟机中，我安装了Ansible版本2.10.4。同样为了使事情更容易，我通过SSH将我的RHEL8虚拟机与我的Windows系统的VS代码连接起来。</li><li id="565e" class="ku kv hx kw b kx mk kz ml lb mm ld mn lf mo kt lh li lj lk bi translated">最后，我们需要一个AWS帐户&amp;使用IAM，我们需要创建AWS访问密钥和秘密密钥，以便Ansible可以登录到我们的AWS帐户来启动实例。</li></ul><h2 id="31d8" class="nn jn hx bd jo no np nq js nr ns nt jw lb nu nv jy ld nw nx ka lf ny nz kc oa bi translated">让我们开始运行命令和编写代码…</h2><h1 id="5cb0" class="jm jn hx bd jo jp jq jr js jt ju jv jw jd jx je jy jg jz jh ka jj kb jk kc kd bi translated">创建三个角色:</h1><p id="5b97" class="pw-post-body-paragraph lo lp hx kw b kx nh iy ls kz ni jb lu lb oc lx ly ld od mb mc lf oe mf mg kt hb bi translated">我会把我的职责代码上传到GitHub上，你会在博客末尾看到链接。但是如果你想理解代码，那就继续读下去，因为<strong class="kw hy">我会解释代码的每一位……</strong></p><ul class=""><li id="e0c9" class="ku kv hx kw b kx lr kz lt lb mh ld mi lf mj kt lh li lj lk bi translated"><strong class="kw hy">创建一个工作空间，比如说“aws-ansible”。</strong>进入这个工作区&amp;创建一个名为“角色”的文件夹。现在进入这个文件夹&amp;运行下面提到的三个命令。</li></ul><pre class="kf kg kh ki fd of og oh oi aw oj bi"><span id="641d" class="nn jn hx og b fi ok ol l om on">ansible-galaxy init ec2<br/>ansible-galaxy init k8s_master<br/>ansible-galaxy init k8s_slave</span></pre><ul class=""><li id="f45c" class="ku kv hx kw b kx lr kz lt lb mh ld mi lf mj kt lh li lj lk bi translated">记住一件事，它将在<strong class="kw hy"> "aws-ansible/roles/" </strong>文件夹中创建三个Ansible角色&amp;你可以给你的角色取任何你想要的名字，但是<strong class="kw hy">我建议给一些逻辑名字。</strong></li></ul><h1 id="6277" class="jm jn hx bd jo jp jq jr js jt ju jv jw jd jx je jy jg jz jh ka jj kb jk kc kd bi translated">设置可行的配置文件:</h1><p id="0e5d" class="pw-post-body-paragraph lo lp hx kw b kx nh iy ls kz ni jb lu lb oc lx ly ld od mb mc lf oe mf mg kt hb bi translated">在Ansible中，我们有两种配置文件——全局和本地。<strong class="kw hy">我们将在“aws-ansible”文件夹中创建一个本地配置文件&amp;无论我们将来想要运行什么ansible命令，我们都将在这个文件夹中运行。</strong>因为只有Ansible能够读取这个本地配置文件&amp;才能相应地工作。</p><h2 id="bf7c" class="nn jn hx bd jo no np nq js nr ns nt jw lb nu nv jy ld nw nx ka lf ny nz kc oa bi translated">因此，在“aws-ansible”文件夹中创建一个名为“ansible.cfg”的文件，并将下面提到的内容放入其中…</h2><figure class="kf kg kh ki fd hk"><div class="bz dy l di"><div class="oo op l"/></div></figure><ul class=""><li id="c92a" class="ku kv hx kw b kx lr kz lt lb mh ld mi lf mj kt lh li lj lk bi translated">这里我们可以看到一些常见的关键字，如<strong class="kw hy">、【主机密钥检查】、【命令警告】</strong>等。<strong class="kw hy">我不讨论这些关键词，因为如果你满足我提到的先决条件，那么你肯定知道这些术语。</strong></li><li id="6a0b" class="ku kv hx kw b kx mk kz ml lb mm ld mn lf mo kt lh li lj lk bi translated">让我告诉一些新的关键字，如<strong class="kw hy">“private _ key _ file”</strong>，它表示aws密钥对。<strong class="kw hy">当Ansible通过SSH登录AWS实例来设置K8s时，它需要私有密钥文件</strong>。另外<strong class="kw hy">EC2实例的默认远程用户是“ec2-user”。</strong></li></ul><h1 id="871b" class="jm jn hx bd jo jp jq jr js jt ju jv jw jd jx je jy jg jz jh ka jj kb jk kc kd bi translated">创建AWS密钥对并将其放入工作区:</h1><p id="4657" class="pw-post-body-paragraph lo lp hx kw b kx nh iy ls kz ni jb lu lb oc lx ly ld od mb mc lf oe mf mg kt hb bi translated"><strong class="kw hy">转到AWS = &gt; EC2 = &gt; Key-pair &amp;在那里创建一个密钥对——假设是“ansible.pem”。</strong>然后在您的虚拟机工作区中下载密钥。最后运行…</p><pre class="kf kg kh ki fd of og oh oi aw oj bi"><span id="66b5" class="nn jn hx og b fi ok ol l om on">chmod 400 ansible.pem</span></pre><h1 id="e873" class="jm jn hx bd jo jp jq jr js jt ju jv jw jd jx je jy jg jz jh ka jj kb jk kc kd bi translated">创建一个用于存储AWS凭据的安全存储库:</h1><p id="5adb" class="pw-post-body-paragraph lo lp hx kw b kx nh iy ls kz ni jb lu lb oc lx ly ld od mb mc lf oe mf mg kt hb bi translated"><strong class="kw hy">最后，在您的工作区运行… </strong></p><pre class="kf kg kh ki fd of og oh oi aw oj bi"><span id="ffad" class="nn jn hx og b fi ok ol l om on">ansible-vault create cred.yml</span></pre><ul class=""><li id="6486" class="ku kv hx kw b kx lr kz lt lb mh ld mi lf mj kt lh li lj lk bi translated">它将要求提供一个保险库密码&amp;然后它将打开Linux上的VI编辑器，在这个文件中创建两个变量&amp;将您的AWS访问密钥和秘密密钥作为值。比如说…</li></ul><pre class="kf kg kh ki fd of og oh oi aw oj bi"><span id="cec0" class="nn jn hx og b fi ok ol l om on">access_key: ABCDEFGHIJK<br/>secret_key: abcdefghijk12345</span></pre><ul class=""><li id="04cd" class="ku kv hx kw b kx lr kz lt lb mh ld mi lf mj kt lh li lj lk bi translated">保存文件。现在你终于准备好编写可完成的角色了。</li></ul><h2 id="960d" class="nn jn hx bd jo no np nq js nr ns nt jw lb nu nv jy ld nw nx ka lf ny nz kc oa bi translated">仅供参考，运行下面提到的命令，观察下面截图中的输出…</h2><figure class="kf kg kh ki fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es oq"><img src="../Images/a665a7871186a3278846c44375d09f55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pNANG1j-cSs2j03gPeDJ2w.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">Screenshot of Terminal</figcaption></figure><h1 id="3bf1" class="jm jn hx bd jo jp jq jr js jt ju jv jw jd jx je jy jg jz jh ka jj kb jk kc kd bi translated">为ec2角色编写代码:</h1><figure class="kf kg kh ki fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mp"><img src="../Images/f565d088e257543e41152de33a5fe2ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hMrKVUxqqOeZA_mmNCwCyQ.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">Created by Raktim</figcaption></figure><h2 id="0ecd" class="nn jn hx bd jo no np nq js nr ns nt jw lb nu nv jy ld nw nx ka lf ny nz kc oa bi translated">任务YML文件:</h2><p id="b55e" class="pw-post-body-paragraph lo lp hx kw b kx nh iy ls kz ni jb lu lb oc lx ly ld od mb mc lf oe mf mg kt hb bi translated"><strong class="kw hy">进入文件夹“AWS-ansi ble/roles/ec2/tasks/”&amp;开始编辑“main.yml”文件。在这个文件中写下下面提到的代码…</strong></p><figure class="kf kg kh ki fd hk"><div class="bz dy l di"><div class="oo op l"/></div></figure><ul class=""><li id="ce3f" class="ku kv hx kw b kx lr kz lt lb mh ld mi lf mj kt lh li lj lk bi translated">我知道，我知道这段代码看起来有点大，但是它为我们做了很多事情。让我解释……</li><li id="1978" class="ku kv hx kw b kx mk kz ml lb mm ld mn lf mo kt lh li lj lk bi translated">首先，我们使用<strong class="kw hy">“pip”</strong>模块来安装两个包— <strong class="kw hy"> boto &amp; boto3 </strong>，因为这些包能够联系AWS来启动EC2实例。我使用了一个名为<strong class="kw hy"> "python_pkgs" </strong> &amp;的变量，它的值存储在<strong class="kw hy">" AWS-ansi ble/roles/ec2/vars/main . yml "</strong>文件中。解释完这段代码后，我还会分享那个文件。</li><li id="e096" class="ku kv hx kw b kx mk kz ml lb mm ld mn lf mo kt lh li lj lk bi translated">接下来，我使用<strong class="kw hy">“ec2 _ Group”</strong>模块在AWS上创建安全组。虽然我们可以为我们的实例创建一个强大的安全组，但是为了简单起见，我允许所有端口的入口&amp;出口。但是在真实场景中，我们从不这样做。</li><li id="0ddb" class="ku kv hx kw b kx mk kz ml lb mm ld mn lf mo kt lh li lj lk bi translated">接下来，我使用<strong class="kw hy">“ec2”</strong>模块在AWS上启动实例，&amp;这里所有的参数我们都知道。我只想谈谈两个参数——第一个是<strong class="kw hy">“寄存器”</strong>,它将所有元数据存储在一个名为<strong class="kw hy">“ec2”</strong>的变量中，以便将来我们可以从中解析所需的信息。第二个是<strong class="kw hy">“循环”</strong>，它再次使用一个包含一个列表的变量。接下来使用<strong class="kw hy"> "item" </strong>关键字，我们一个接一个地调用列表值。<strong class="kw hy">这将使用不同的实例标签运行ec2模块3次，最终将启动3个实例。</strong></li><li id="514e" class="ku kv hx kw b kx mk kz ml lb mm ld mn lf mo kt lh li lj lk bi translated">接下来，我使用了<strong class="kw hy">“add _ host”</strong>模块，该模块能够在运行行动手册时创建一个动态清单。在这个模块中，我使用了<strong class="kw hy">“hostname”</strong>关键字来告诉要存储在动态主机组中的值。在这里，我使用那个<strong class="kw hy">“ec2”</strong>变量&amp;进行JSON解析，以找到第一个实例的公共ip。</li></ul><blockquote class="ll lm ln"><p id="00d3" class="lo lp lq kw b kx lr iy ls kz lt jb lu lv lw lx ly lz ma mb mc md me mf mg kt hb bi translated"><strong class="kw hy">如果你注意到了，这里我创建了两个主机组——ec2 _ master&amp;ec2_slave&amp;第一个实例属于“ec2 _ master”&amp;第二个，第三个实例属于“ec2 _ slave”主机组。</strong></p></blockquote><ul class=""><li id="a455" class="ku kv hx kw b kx lr kz lt lb mh ld mi lf mj kt lh li lj lk bi translated">最后，我运行<strong class="kw hy">“等待”</strong>模块来等待剧本几秒钟，直到所有节点的SSH服务都启动。</li></ul><figure class="kf kg kh ki fd hk"><div class="bz dy l di"><div class="oo op l"/></div></figure><h2 id="2644" class="nn jn hx bd jo no np nq js nr ns nt jw lb nu nv jy ld nw nx ka lf ny nz kc oa bi translated">变量YML文件:</h2><p id="54ee" class="pw-post-body-paragraph lo lp hx kw b kx nh iy ls kz ni jb lu lb oc lx ly ld od mb mc lf oe mf mg kt hb bi translated"><strong class="kw hy">打开“AWS-ansi ble/roles/ec2/vars/main . yml”文件&amp;存储我们在“task/main.yml”文件中提到的所有变量及其各自的值。为了便于参考，我附上了文件…</strong></p><h1 id="0adf" class="jm jn hx bd jo jp jq jr js jt ju jv jw jd jx je jy jg jz jh ka jj kb jk kc kd bi translated">为k8s_master角色编写代码:</h1><figure class="kf kg kh ki fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mp"><img src="../Images/3c5849c1ba901dd6334474204f6fef8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BjCFSQwk8riOKkZQ6x1shA.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">Created by Raktim</figcaption></figure><h2 id="d72d" class="nn jn hx bd jo no np nq js nr ns nt jw lb nu nv jy ld nw nx ka lf ny nz kc oa bi translated">任务YML文件:</h2><p id="b60e" class="pw-post-body-paragraph lo lp hx kw b kx nh iy ls kz ni jb lu lb oc lx ly ld od mb mc lf oe mf mg kt hb bi translated"><strong class="kw hy">类似地像上次一样打开“AWS-ansi ble/roles/k8s _ master/tasks/main . yml”文件&amp; </strong>把下面提到的代码放在那里…</p><figure class="kf kg kh ki fd hk"><div class="bz dy l di"><div class="oo op l"/></div></figure><ul class=""><li id="0493" class="ku kv hx kw b kx lr kz lt lb mh ld mi lf mj kt lh li lj lk bi translated">这里我们需要在我们的主节点上安装kubeadm程序来设置K8s集群。因此，我添加了K8s社区提供的yum存储库。<strong class="kw hy">在这里，因为我对所有实例使用AWS Linux 2，所以我们不需要为docker cli配置存储库。</strong></li><li id="5c62" class="ku kv hx kw b kx mk kz ml lb mm ld mn lf mo kt lh li lj lk bi translated">接下来使用<strong class="kw hy"> "package" </strong>模块，我们将在主实例上安装<strong class="kw hy"> "Docker "、" Kubeadm" &amp; "iproute-tc" </strong>包。</li><li id="10c3" class="ku kv hx kw b kx mk kz ml lb mm ld mn lf mo kt lh li lj lk bi translated">接下来我使用<strong class="kw hy">“服务”</strong>模块来启动<strong class="kw hy"> docker &amp; kubelet服务</strong>。这里我再次使用了名为“service_names”的列表上的循环来运行同一个模块两次。</li><li id="6b6a" class="ku kv hx kw b kx mk kz ml lb mm ld mn lf mo kt lh li lj lk bi translated">接下来，我使用<strong class="kw hy">“command”</strong>模块运行一个kubeadm命令，该命令将提取运行Kubernetes集群所需的所有Docker映像。在Ansible中，我们没有任何运行“kubeadm”命令的模块，这就是为什么我使用“command”模块。</li><li id="966d" class="ku kv hx kw b kx mk kz ml lb mm ld mn lf mo kt lh li lj lk bi translated"><strong class="kw hy">接下来我们需要将我们的Docker默认cgroup改为“systemd”，否则kubeadm将无法设置K8s集群。</strong>首先使用<strong class="kw hy">“复制”</strong>模块创建一个文件<strong class="kw hy">"/etc/docker/daemon . JSON "</strong>&amp;将一些内容放入其中。接下来再次使用<strong class="kw hy"> "service" </strong>模块，我们重新启动docker来更改cgroup。</li><li id="1456" class="ku kv hx kw b kx mk kz ml lb mm ld mn lf mo kt lh li lj lk bi translated">接下来，我们使用<strong class="kw hy">“command”</strong>模块初始化集群&amp;，然后使用<strong class="kw hy">模块在主节点上设置“kubectl”命令。</strong></li><li id="0d5c" class="ku kv hx kw b kx mk kz ml lb mm ld mn lf mo kt lh li lj lk bi translated"><strong class="kw hy">接下来，我使用“命令”模块在Kubernetes集群上部署了法兰绒，以便它创建覆盖网络设置。</strong></li><li id="acd0" class="ku kv hx kw b kx mk kz ml lb mm ld mn lf mo kt lh li lj lk bi translated">第二个“命令”模块也用于获取从属节点加入集群的令牌。<strong class="kw hy">使用“寄存器”,我将第二个“命令”模块的输出存储在一个名为“令牌”的变量中。</strong>现在这个令牌变量包含了我们需要在从节点上运行的命令，以便它加入主节点。</li><li id="4c2b" class="ku kv hx kw b kx mk kz ml lb mm ld mn lf mo kt lh li lj lk bi translated">最后，我使用“shell”模块来清理主节点上的缓冲区缓存，因为在进行设置时，它会在RAM上创建大量临时数据。</li></ul><figure class="kf kg kh ki fd hk"><div class="bz dy l di"><div class="oo op l"/></div></figure><h2 id="e0ad" class="nn jn hx bd jo no np nq js nr ns nt jw lb nu nv jy ld nw nx ka lf ny nz kc oa bi translated">变量YML文件:</h2><p id="929a" class="pw-post-body-paragraph lo lp hx kw b kx nh iy ls kz ni jb lu lb oc lx ly ld od mb mc lf oe mf mg kt hb bi translated"><strong class="kw hy">打开“AWS-ansi ble/roles/k8s _ master/vars/main . yml”文件&amp;将变量“service_name”的值存储在列表中……</strong></p><h1 id="8dfd" class="jm jn hx bd jo jp jq jr js jt ju jv jw jd jx je jy jg jz jh ka jj kb jk kc kd bi translated">为k8s_slave角色编写代码:</h1><figure class="kf kg kh ki fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mp"><img src="../Images/d2e3aec91d349b317f061f665446293a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XIL-EwNFjyAx63q-KkBE1g.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">Created by Raktim</figcaption></figure><h2 id="85d4" class="nn jn hx bd jo no np nq js nr ns nt jw lb nu nv jy ld nw nx ka lf ny nz kc oa bi translated">任务YML文件:</h2><p id="665c" class="pw-post-body-paragraph lo lp hx kw b kx nh iy ls kz ni jb lu lb oc lx ly ld od mb mc lf oe mf mg kt hb bi translated"><strong class="kw hy">类似于之前打开的“AWS-ansi ble/roles/k8s _ slave/tasks/main . yml”文件&amp; </strong>将下面提到的代码放在那里…</p><figure class="kf kg kh ki fd hk"><div class="bz dy l di"><div class="oo op l"/></div></figure><ul class=""><li id="5000" class="ku kv hx kw b kx lr kz lt lb mh ld mi lf mj kt lh li lj lk bi translated"><strong class="kw hy">直到docker服务重启任务，这个文件和之前“k8s_master”角色的文件一模一样。在从节点上，我们不需要初始化集群&amp;，也不需要设置kubectl。</strong>其余的事情我们需要做，因为在从节点中我们也需要“kubeadm”命令&amp; Docker作为容器引擎。</li><li id="fd93" class="ku kv hx kw b kx mk kz ml lb mm ld mn lf mo kt lh li lj lk bi translated">接下来，我使用<strong class="kw hy"> "copy" </strong>模块创建一个名为<strong class="kw hy">"/etc/sysctl . d/k8s . conf "</strong>的配置文件，这将允许从机启用某些网络规则。接下来要启用规则，我们需要重新加载<strong class="kw hy">“sysctl”</strong>&amp;，因为我使用了<strong class="kw hy">“command”</strong>模块。</li></ul><h2 id="ae3c" class="nn jn hx bd jo no np nq js nr ns nt jw lb nu nv jy ld nw nx ka lf ny nz kc oa bi translated">现在最有趣的部分来了…</h2><ul class=""><li id="0990" class="ku kv hx kw b kx nh kz ni lb nj ld nk lf nl kt lh li lj lk bi translated">如果您还记得，我们在之前的<strong class="kw hy">角色中使用了<strong class="kw hy">“token”</strong>变量来存储从机加入集群</strong>的令牌命令。现在，每个角色都有自己单独的名称空间来存储变量。因此，我们需要转到我们动态创建的上一个主机组的命名空间。</li><li id="d89b" class="ku kv hx kw b kx mk kz ml lb mm ld mn lf mo kt lh li lj lk bi translated">为此，我们在其中使用了<strong class="kw hy">“hostvars”</strong>关键字&amp;，我们称之为“ec2_master”主机组。接下来，在这个主机组中，我们可以有多个主机(节点)。要选择第一台主机，我们使用“[0]”选项。<strong class="kw hy">这意味着最后“hostvars[groups[' ec2 _ master '][0]]”选项正在调用主节点的命名空间。</strong></li><li id="497d" class="ku kv hx kw b kx mk kz ml lb mm ld mn lf mo kt lh li lj lk bi translated"><strong class="kw hy">接下来使用“['token']['stdout']”我们刚刚解析了可以在slave中使用的加入主节点的命令。</strong></li></ul><blockquote class="ll lm ln"><p id="f36f" class="lo lp lq kw b kx lr iy ls kz lt jb lu lv lw lx ly lz ma mb mc md me mf mg kt hb bi translated"><strong class="kw hy">注意:这里我们需要创建与我们在“k8s_master”角色上创建的相同的“vars/main.yml”文件。</strong></p></blockquote><h1 id="ad55" class="jm jn hx bd jo jp jq jr js jt ju jv jw jd jx je jy jg jz jh ka jj kb jk kc kd bi translated">最后，创建安装文件:</h1><ul class=""><li id="1e1f" class="ku kv hx kw b kx nh kz ni lb nj ld nk lf nl kt lh li lj lk bi translated">现在终于到了创建<strong class="kw hy"> "setup.yml" </strong>文件的时候了，我们将运行该文件在AWS上创建整个基础设施。<strong class="kw hy">记住一件事，我们需要在文件夹“aws-ansible”中创建这个文件。</strong>作为参考，我在下面附上了文件…</li></ul><figure class="kf kg kh ki fd hk"><div class="bz dy l di"><div class="oo op l"/></div></figure><ul class=""><li id="0005" class="ku kv hx kw b kx lr kz lt lb mh ld mi lf mj kt lh li lj lk bi translated">如您所见，我们正在本地主机上运行第一个<strong class="kw hy">“ec2”</strong>角色，因为<strong class="kw hy">它将从本地主机联系AWS API。</strong>同样使用<strong class="kw hy">“vars _ files”</strong>我将<strong class="kw hy">“cred . yml”</strong>文件包含在该任务中，以便“ec2”角色可以访问它。</li><li id="ae76" class="ku kv hx kw b kx mk kz ml lb mm ld mn lf mo kt lh li lj lk bi translated"><strong class="kw hy">在接下来的两个步骤中，我们分别在“ec2 _ master”&amp;“ec2 _ slave”动态主机组上运行“k8s _ master”&amp;“k8s _ slave”角色。</strong></li></ul><h2 id="1127" class="nn jn hx bd jo no np nq js nr ns nt jw lb nu nv jy ld nw nx ka lf ny nz kc oa bi translated">GitHub参考库:</h2><div class="hh hi ez fb hj mq"><a href="https://github.com/raktim00/Kubernetes-Multi-Node-AWS-Ansible" rel="noopener  ugc nofollow" target="_blank"><div class="mr ab dw"><div class="ms ab mt cl cj mu"><h2 class="bd hy fi z dy mv ea eb mw ed ef hw bi translated">rak Tim 00/Kubernetes-多节点-AWS-Ansible</h2><div class="mx l"><h3 class="bd b fi z dy mv ea eb mw ed ef dx translated">使用Ansible脚本自动化在AWS EC2实例上设置Kubernetes多节点集群…</h3></div><div class="my l"><p class="bd b fp z dy mv ea eb mw ed ef dx translated">github.com</p></div></div><div class="mz l"><div class="or l nb nc nd mz ne hp mq"/></div></div></a></div><blockquote class="ll lm ln"><p id="7996" class="lo lp lq kw b kx lr iy ls kz lt jb lu lv lw lx ly lz ma mb mc md me mf mg kt hb bi translated"><strong class="kw hy">编码部分到此为止。现在是运行剧本的时候了。为此，在“aws-ansible”文件夹中运行下面提到的命令。</strong></p></blockquote><pre class="kf kg kh ki fd of og oh oi aw oj bi"><span id="d4af" class="nn jn hx og b fi ok ol l om on">ansible-playbook setup.yml --ask-vault-pass</span></pre><ul class=""><li id="ae23" class="ku kv hx kw b kx lr kz lt lb mh ld mi lf mj kt lh li lj lk bi translated">接下来，它将提示您传递您的Ansible Vault (cred.yml文件)的密码，提供密码&amp;然后<strong class="kw hy">您将看到自动化的力量……</strong></li></ul><figure class="kf kg kh ki fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mp"><img src="../Images/5eb8409e79f7c9f9ff5679df4028b6ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*cq2F-DUAttvOG_JnXhlJdA.gif"/></div></div></figure><h1 id="fa1c" class="jm jn hx bd jo jp jq jr js jt ju jv jw jd jx je jy jg jz jh ka jj kb jk kc kd bi translated">最后的话:</h1><ul class=""><li id="a03f" class="ku kv hx kw b kx nh kz ni lb nj ld nk lf nl kt lh li lj lk bi translated"><strong class="kw hy">学习Ansible、Kubernetes、AWS有无限的未来可能。这只是一个简单的Ansible角色演示，但是如果你愿意，你可以通过添加更多的模块来创建更多更大的基础设施。我们可以使用Ansible实现的每一种配置。</strong></li><li id="4397" class="ku kv hx kw b kx mk kz ml lb mm ld mn lf mo kt lh li lj lk bi translated"><strong class="kw hy">下面是本练习第二部分的链接，我通过添加NFS服务器角色&amp;在Kubernetes上部署Wordpress角色……</strong>来扩展整个架构</li></ul><div class="hh hi ez fb hj mq"><a href="https://raktimmidya.medium.com/provisioning-kubernetes-mna-nfs-server-wordpress-on-aws-using-ansible-automation-3da82155c296" rel="noopener follow" target="_blank"><div class="mr ab dw"><div class="ms ab mt cl cj mu"><h2 class="bd hy fi z dy mv ea eb mw ed ef hw bi translated">使用Ansible Automation在AWS上提供Kubernetes MNA、NFS服务器和Wordpress</h2><div class="mx l"><h3 class="bd b fi z dy mv ea eb mw ed ef dx translated">今天的世界是关于DevOps工具和技术的。但是为什么呢？了解如何整合AWS的所有知识…</h3></div><div class="my l"><p class="bd b fp z dy mv ea eb mw ed ef dx translated">raktimmidya.medium.com</p></div></div><div class="mz l"><div class="os l nb nc nd mz ne hp mq"/></div></div></a></div><blockquote class="ll lm ln"><p id="0497" class="lo lp lq kw b kx lr iy ls kz lt jb lu lv lw lx ly lz ma mb mc md me mf mg kt hb bi translated"><strong class="kw hy">需要3天时间&amp;启动50多个实例&amp;终止测试&amp;编写这些脚本。过去一年的持续学习。所以，如果你喜欢这个博客，请留下评论，为更多即将到来的博客鼓掌。</strong></p></blockquote><ul class=""><li id="1d01" class="ku kv hx kw b kx lr kz lt lb mh ld mi lf mj kt lh li lj lk bi translated"><strong class="kw hy">我试图让它尽可能简单。</strong>希望你从这里学到了一些东西。请随意查看下面提到的我的LinkedIn个人资料…</li></ul><div class="hh hi ez fb hj mq"><a href="https://www.linkedin.com/in/raktimmidya/" rel="noopener  ugc nofollow" target="_blank"><div class="mr ab dw"><div class="ms ab mt cl cj mu"><h2 class="bd hy fi z dy mv ea eb mw ed ef hw bi translated">Raktim Midya -微软学生学习大使(测试版)-微软| LinkedIn</h2><div class="mx l"><h3 class="bd b fi z dy mv ea eb mw ed ef dx translated">★我是一名技术爱好者，致力于更好地理解不同热门技术领域背后的核心概念…</h3></div><div class="my l"><p class="bd b fp z dy mv ea eb mw ed ef dx translated">www.linkedin.com</p></div></div><div class="mz l"><div class="ot l nb nc nd mz ne hp mq"/></div></div></a></div><p id="0037" class="pw-post-body-paragraph lo lp hx kw b kx lr iy ls kz lt jb lu lb lw lx ly ld ma mb mc lf me mf mg kt hb bi translated"><strong class="kw hy">感谢大家的阅读。就这样…结束…😊</strong></p><figure class="kf kg kh ki fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ou"><img src="../Images/5a7a34d0698d7f08687d261649b384d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r5VeD2fV04iDy8xfmaauHA.png"/></div></div></figure></div></div>    
</body>
</html>