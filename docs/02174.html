<html>
<head>
<title>Multiplayer Interaction with p5js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">与p5js的多人互动</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/multiplayer-interaction-with-p5js-f04909e13b87?source=collection_archive---------14-----------------------#2021-05-06">https://medium.com/geekculture/multiplayer-interaction-with-p5js-f04909e13b87?source=collection_archive---------14-----------------------#2021-05-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="3c7f" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">在这篇文章中，我将描述使用<a class="ae ix" href="https://p5js.org/" rel="noopener ugc nofollow" target="_blank"> p5js </a>、<a class="ae ix" href="https://socket.io/" rel="noopener ugc nofollow" target="_blank"> socket.io </a>和<a class="ae ix" href="https://expressjs.com/" rel="noopener ugc nofollow" target="_blank"> express </a>创建多人互动网站/游戏的基本设置。</h2></div><figure class="iz ja jb jc fd jd er es paragraph-image"><div role="button" tabindex="0" class="je jf di jg bf jh"><div class="er es iy"><img src="../Images/0df9b8bd5c7eb6feb4b8052056df9172.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*guMH1jMq6qEJ4YXqk0dv-A.png"/></div></div><figcaption class="jk jl et er es jm jn bd b be z dx">Screenshot of the video on my interactive website, reacting to the positions of participants interacting on my website.</figcaption></figure><p id="3d44" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这篇文章的目标是建立一个基本的系统，从这个系统你可以扩展创建你自己的多人互动/游戏。我们将讨论如何在客户端和服务器上使用socket.io来不断更新p5js中每个客户端的位置，这些位置可以代表一个玩游戏的玩家或与网站交互的人。</p><h1 id="3804" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">计算机网络服务器</h1><p id="617f" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">本教程假设您对node.js和npm有一些基本的了解。如果没有，尝试按照本教程先安装并获得npm的基本知识。</p><p id="b6c5" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我们只需要服务器上的两个依赖项:<code class="du lh li lj lk b">npm install express socket.io</code></p><figure class="iz ja jb jc fd jd"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="f79c" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这里发生了很多事情，所以让我们把它分解一下。</p><p id="471d" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">服务器代码的第一部分是导入express、http和socket.io。</p><p id="eede" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">Express用于创建主服务器，用户可以在那里访问一个url，它将返回一些内容。在这种情况下，我将它设置为当有人转到我网站的根目录时返回“index.html”。</p><pre class="iz ja jb jc fd ln lk lo lp aw lq bi"><span id="6ee0" class="lr kl hi lk b fi ls lt l lu lv">app.get(“/”, (req, res) =&gt; { res.render(‘index.html’); });</span></pre><p id="569b" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">socket.io是一个库，提供从每个客户端到服务器的实时更新。仅仅使用express服务器是无法做到这一点的，因为标准请求的处理时间太长。相反，socket.io主要在幕后使用W <a class="ae ix" href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API" rel="noopener ugc nofollow" target="_blank"> ebSockets </a>，这使得客户端、服务器和其他客户端之间的实时通信成为可能。</p><p id="f015" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">为了存储每个访问我网站的客户的位置，我只使用了一个普通的javascript对象。<code class="du lh li lj lk b">const positions = {}</code>每当新客户端通过访问我的网站进行连接时，就会触发“连接”事件。它们将被赋予一个唯一的id，作为该对象中的一个键。例如，如果1个客户端连接到位置对象，则该对象将如下所示:</p><pre class="iz ja jb jc fd ln lk lo lp aw lq bi"><span id="ac07" class="lr kl hi lk b fi ls lt l lu lv">{ unique_id1: {x: 0.5, y: 0.5} }</span></pre><p id="aa76" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">当第二个客户端连接时…</p><pre class="iz ja jb jc fd ln lk lo lp aw lq bi"><span id="df13" class="lr kl hi lk b fi ls lt l lu lv">{ <br/>  unique_id1: {x: 0.5, y: 0.5}<br/>  unique_id2: {x: 0.5, y: 0.5}<br/>}</span></pre><p id="8d70" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">例如，如果第一个人离开网站，该id将被删除，对象将如下所示:</p><pre class="iz ja jb jc fd ln lk lo lp aw lq bi"><span id="7436" class="lr kl hi lk b fi ls lt l lu lv">{ unique_id2: {x: 0.5, y: 0.5} }</span></pre><p id="492a" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">从客户端，人们可以用消息向服务器发送数据。在这种情况下，我们可以从客户端接收“updatePosition ”,这将更新该客户端的位置。例如，如果客户端2使用数据:<code class="du lh li lj lk b">{ x: 0.2, y: 0.6 }</code>调用“updatePosition”，它会将positions对象更新为:</p><pre class="iz ja jb jc fd ln lk lo lp aw lq bi"><span id="9ae6" class="lr kl hi lk b fi ls lt l lu lv">{ unique_id2: {x: 0.2, y: 0.6 }</span></pre><p id="4a5c" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">最后，我们将每个客户的位置发送给所有相关的人。我们可以用<code class="du lh li lj lk b">io.emit('positions', positions);</code>行来实现。它向每个客户端发送名为“positions”的消息以及positions对象。我们将它打包到一个<code class="du lh li lj lk b">setInterval</code>中，这样位置每秒发送30次。</p><p id="21f4" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在我们有了基本的服务器代码，我们可以开始查看客户端，以及如何设置网站以连接到服务器，并发送和接收与它们在我们将使用p5js创建的画布上的位置相关的消息。我们将从用p5js设置画布和定位开始，然后添加socket.io用法。</p><h1 id="d31e" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">客户端(p5js)</h1><p id="2e05" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">首先，我设置了一个导入代码的基本html页面，这样我们就可以在javascript文件中使用<strong class="jq hj"> socket.io </strong>和<strong class="jq hj"> p5js </strong>。它还设置了一些基本的样式，所以我们的<code class="du lh li lj lk b">canvas</code>元素将总是相同的长宽比，并充满屏幕。</p><figure class="iz ja jb jc fd jd"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="fec3" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在<code class="du lh li lj lk b">&lt;div id='sketch-container'&gt;</code>里面p5js会放画布。我们将在结束标签<code class="du lh li lj lk b">body</code>之前的索引文件的最后部分包含的<code class="du lh li lj lk b">script.js</code>中设置这一切。</p><p id="f777" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在，我们可以在画布中设置p5js，首先是代码，我们将在下面查看它:</p><figure class="iz ja jb jc fd jd"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="b706" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这段代码建立了一个非常基本的p5画布，它在画布的左上角画了一个圆。当客户端在画布上单击时，圆圈的位置会变为用户单击的位置。</p><p id="61c1" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">注意，我们在<a class="ae ix" href="https://p5js.org/examples/instance-mode-instantiation.html" rel="noopener ugc nofollow" target="_blank">实例模式</a>中使用p5js。这就是为什么我首先设置了一个将p5js作为参数的<code class="du lh li lj lk b">function sketch</code>。虽然p5js将此描述为使用p5的一种更高级的方式，但我发现这更容易，因为您可以很容易地看到哪些函数来自p5，因为所有的函数现在都绑定到sketch函数中给出的参数，所以我们调用<code class="du lh li lj lk b">p.setup</code>和<code class="du lh li lj lk b">p.draw</code>等..该函数立即在第<code class="du lh li lj lk b">new p5(sketch, sketchContainer);</code>行被调用。</p><h2 id="34ef" class="lr kl hi bd km lw lx ly kq lz ma mb ku jx mc md kw kb me mf ky kf mg mh la mi bi translated">从服务器获取位置</h2><p id="1fb8" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">和以前一样，让我们先看看代码，下面我们将讨论一些感兴趣的要点。</p><figure class="iz ja jb jc fd jd"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="a790" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在我们最后的<code class="du lh li lj lk b">script.js</code>文件中，我们现在用行<code class="du lh li lj lk b">const socket = io();</code>连接到服务器，我们初始化它只使用websockets作为连接，就像在服务器上一样。这使得使用旧浏览器的人无法使用我们的应用程序，但它确保了客户端和服务器之间的所有通信都是快速的，并且使用更少的带宽。</p><p id="da4e" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在我们的<code class="du lh li lj lk b">sketch</code>函数中，我们现在有了一个<code class="du lh li lj lk b">let positions = {}</code>对象，而不仅仅是一个位置。在这里，我们将存储连接到我们网站的每个客户的位置。我们通过用<code class="du lh li lj lk b">socket.on("positions", callback);</code>函数设置回调来获取位置。在回调中，我们接收数据，并简单地将positions对象设置为来自服务器的数据。请记住，这个“位置”消息每秒发送30次，因此我们的数据将不断更新。</p><p id="8fcb" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在我们的draw函数中，我们现在也要做一些改变。我们希望显示所有的圆圈，而不是一个，所以我们用一个<code class="du lh li lj lk b">for...in</code>循环遍历positions对象中的每个关键点。然后，对于每个位置，我们绘制我们的圆，注意我们现在必须在draw函数中将位置乘以宽度和高度，因为每个位置只是0和1之间的一个数字。</p><p id="f06a" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><em class="mj">这是必要的，因为我们无法在服务器上存储实际位置。例如，当一个客户在一个画布只有500像素宽的小屏幕上时，如果他们的x位置是中间位置(250像素)并存储在服务器上，它将只出现在观看宽度为1000像素的网站的人的四分之一处。</em></p><p id="c3ee" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">最后，我们必须调整我们的<code class="du lh li lj lk b">cnv.mousePressed</code>功能。我们想通过用<code class="du lh li lj lk b">updatePosition</code>发送新的位置到服务器来更新我们的位置。然后，服务器会通过我们之前已经设置好的<code class="du lh li lj lk b">“positions”</code>消息监听器将更新后的位置发送给我们和其他人。(连续发送位置的那个)。</p><p id="8e40" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">出于上述同样的原因，我们必须存储相对于服务器的位置值，而不是绝对像素值，所以我们用<code class="du lh li lj lk b">p.mouseX</code>除以<code class="du lh li lj lk b">p.width</code>，对于高度也是如此。</p><p id="ef20" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">就是这样！现在你有了一个实验多人互动或游戏的基本设置。从这里开始，你可以根据自己的喜好扩展代码，例如，你可以开始考虑给代表“我”的圆赋予不同的颜色或大小，这可以通过从服务器中查找套接字id来完成，可以使用<code class="du lh li lj lk b">socket.io.engine.id;</code>来获得，然后将它与在<code class="du lh li lj lk b">positions</code>对象中使用的所有id进行比较。</p><h1 id="56c9" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">完整项目</h1><figure class="iz ja jb jc fd jd"><div class="bz dy l di"><div class="mk lm l"/></div><figcaption class="jk jl et er es jm jn bd b be z dx">Multiplayer positioning with socket.io and p5js</figcaption></figure><p id="d963" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">感谢您的阅读！欢迎提出问题或建议！如果你感兴趣，这里有一个我用这个基本设置制作的艺术项目的视频和一个实时视频，它也对每个人的位置做出反应。</p><figure class="iz ja jb jc fd jd"><div class="bz dy l di"><div class="ml lm l"/></div></figure></div></div>    
</body>
</html>