<html>
<head>
<title>All Things Clock, Time and Order in Distributed Systems: Physical Time in Depth</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">分布式系统中的所有事物时钟、时间和顺序:深度物理时间</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/all-things-clock-time-and-order-in-distributed-systems-physical-time-in-depth-3c0a4389a838?source=collection_archive---------4-----------------------#2021-03-09">https://medium.com/geekculture/all-things-clock-time-and-order-in-distributed-systems-physical-time-in-depth-3c0a4389a838?source=collection_archive---------4-----------------------#2021-03-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/60f33bcc0587c210cedb39180faa25c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*g8Yv69LJ47qw9Q9w"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Photo by <a class="ae iu" href="https://unsplash.com/@jenskreuter?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Jens Kreuter</a> on <a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="3b46" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">介绍</h1><p id="457f" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">作为一个人，我们在童年(0岁)出生，开始上学(大约5岁)，大学毕业(大约18岁)，可能毕业后(大约22岁)，然后开始我们的职业生涯(大约22岁到24岁以上)，生活继续前进。整个事情按照一定的顺序发生:你可能无法在没有完成学业的情况下上大学——如果你是个神童，你可能会，但这只是一次性的。完成这一旅程平均需要20多年。一旦我们回顾这段旅程，我们会说<strong class="jv hj">随着时间的推移</strong>我们成长了这么多，哇！！。</p><p id="0663" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">只要观察，时间的概念是如何进入画面来定义一个时期，最重要的是<strong class="jv hj">来定义我们生活中事件的顺序</strong>。</p><p id="92e6" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">类似地，我们获得时间来定义事件的周期和顺序，以实现业务系统中事件的同步。让我们来看一些重要的跨行业订购和时间用例:</p><ol class=""><li id="08d3" class="kw kx hi jv b jw kr ka ks ke ky ki kz km la kq lb lc ld le bi translated">移动和数据网络使用精确的时间来实现它们之间的平滑同步，以便移动手机可以更有效地共享有限的无线电频谱。</li><li id="8eae" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated">航空业需要准确的天气信息，因此精确的时间用于同步分布在各地的气象站数据。</li><li id="eaf5" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated">地震监测网络通过使用网络上的精确时间，帮助研究人员快速定位地震和其他地震事件的震中。</li><li id="6bde" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated">为了检测电网中的电气异常，设备和公用事业需要使用精确的时间。它有助于工程师分析停电，并确定异常开始的确切位置。</li><li id="9444" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated">像好莱坞这样的行业正在采用精确的时间来控制音频、视频数据和多摄像机序列，以提供最终的用户体验。</li><li id="2f46" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated">应用和网络监控系统对时间敏感，有助于工程师有效检测性能问题。</li><li id="1fa1" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated">股票交易平台、在线游戏、即时通讯都有自己的排序和计时要求。</li></ol><p id="1d57" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">这些只是精确时间的一些重要例子，只是为了让你理解它在总体上有多重要。我们更感兴趣的是用低级分布式系统的术语来理解时间，本文的其余部分将重点讨论这个问题。</p><p id="8466" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">问:那么，首先，我们在分布式系统中哪里需要排序？</strong> <br/> <strong class="jv hj"> A. </strong>在计算中有许多需要某种排序概念的用例:<br/> <strong class="jv hj"> <em class="lk">例1: </em> </strong>你正在与你的团队进行一个每日站立仪式的在线会议，但是你收到了一大块完全无序的视频帧。这样会给你留下很好的用户体验的味道吗？<br/> <strong class="jv hj"> <em class="lk">例2: </em> </strong>你在一家电子商务公司调试一个关键问题，那里有很多连续的服务调用。当您跟踪这些电话时，您会发现一个客户订单甚至在付款之前就已经得到了确认。你对此有何感想？<br/> <strong class="jv hj"> <em class="lk">例3: </em> </strong>类似地，在无领导的数据库系统中，多台机器可以接受对同一对象的请求以获得更好的可用性，它们需要以这样的方式同步对象，即在该对象上发生的事件序列在系统和业务逻辑中保持可接受。<br/> <strong class="jv hj"> <em class="lk">举例4: </em> </strong>在运营中交易需要排序，甚至交易本身在某些情况下也需要在彼此之间排序。无论是金融机构、电子商务还是社交媒体平台，交易无处不在。</p><p id="061a" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">事实是，在许多系统中，我们无法避免排序的概念，但是，是的，并不是所有的系统都需要排序，这完全取决于手头的业务用例看起来如何。</p><p id="df3f" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">现在的问题是<strong class="jv hj">我们如何衡量排序？</strong></p><p id="f962" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">要在计算机运行的进程中排序数据样本<strong class="jv hj">，最简单的直觉是给它们分配单调递增的数字，并比较谁先谁后。我们可以在这个过程中管理一个计数器变量，并不断增加它，很简单！</strong></p><p id="854f" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">如果我们的样本数据受到在同一台计算机上运行的多个进程甚至多个线程的影响，该怎么办？我们仍然可以管理一个全局计数器(可能由锁保护),仍然可以实现排序，但显然是以多线程或进程同步为代价的。</p><p id="651e" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">有其他选择吗？既然一般来说计算机时钟是单调递增的，我们就不能简单地使用它吗？</p><p id="bdfb" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">管理计数器和时钟的想法起初看起来很直观，因为我们的基本直觉是它们是单调递增的。但是事情并没有看起来那么简单。</p><p id="d050" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">这里先讨论一下时钟能否拯救我们。</p><h1 id="d30e" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">计算机时钟和物理时间</h1><p id="1d32" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">每台电脑的主板上都装有一个硬件时钟，它由某种材料制成，依靠机械晶体振荡(T2)的机制工作。大多数<strong class="jv hj">石英钟</strong>是如此普遍，因为它们重量轻，价格便宜，现在它们是综合开发的。当一个特定的电压施加到石英晶体上时，石英晶体以精确的频率振荡，时钟对这些振荡进行计数。<strong class="jv hj">指定数量的振荡称为一个滴答。每一个刻度代表一个时间单位。</strong>时钟内部管理一个64位计数器，并对其进行递增以标记一个滴答。</p><p id="81d7" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">操作系统维护一个软件时钟，软件时钟反过来使用硬件时钟来计算当前时间。</p><p id="0762" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">注意:</strong>不仅是石英钟，任何时钟都要基于某种振荡来测量时间。在石英钟中，石英晶体是用来振荡的。</p><p id="d87a" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">使用计算机时钟来计算顺序起初看起来非常直观，但是对于包含多个节点的分布式系统来说，这就变得棘手了。</p><h2 id="6092" class="ll iw hi bd ix lm ln lo jb lp lq lr jf ke ls lt jj ki lu lv jn km lw lx jr ly bi translated">时钟的问题</h2><p id="e9b2" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated"><strong class="jv hj">分布式系统中没有单一的全局时钟</strong>。每台计算机<br/>(任何计算设备，但我们最关心的是服务器端)都有自己的时钟，它们的材料、物理属性、时钟频率都不同。此外，根据服务器所处位置的环境(物理条件),时钟的振荡可能会因温度变化而受到影响。因此<strong class="jv hj">没有两个时钟在测量时间方面是完全相同的</strong>。两个时钟之间可能有几毫秒甚至几秒的差异。</p><p id="53d3" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">时钟偏移(offset ): </strong>两个时钟上的时间之差称为时钟偏移。</p><p id="1065" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">时钟漂移:</strong>如上所述，没有两个时钟具有相同的时钟振荡速率，即:<strong class="jv hj">时钟速率会不同</strong>。时钟速率的差异称为时钟漂移。<strong class="jv hj">普通石英钟在11–12天</strong>内漂移~  <code class="du lz ma mb mc b"><strong class="jv hj">1 second</strong></code> <strong class="jv hj">。漂移速率因时钟而异。</strong></p><p id="9809" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">问:服务器(计算机)的时钟总是单调递增的吗？<br/>答:在基于Linux的系统中，通常有两种非常不同的时钟，这里有一个详尽的列表<a class="ae iu" href="https://man7.org/linux/man-pages/man2/clock_getres.2.html" rel="noopener ugc nofollow" target="_blank"/>:</p><p id="a078" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">实时时钟或挂钟:</strong>这是我们在电脑上看到的滴答作响的时钟。时钟可以与NTP同步(稍后我们将讨论NTP ),并相应地向前或向后<strong class="jv hj">跳跃</strong>以调整其当前时间。Linux <code class="du lz ma mb mc b"><strong class="jv hj">CLOCK_REALTIME</strong></code>是提供<code class="du lz ma mb mc b"><strong class="jv hj">get_time()</strong></code>和<code class="du lz ma mb mc b"><strong class="jv hj">set_time()</strong></code>API的实现。<code class="du lz ma mb mc b"><strong class="jv hj">System.currentTimeMillis()</strong></code>是Java的实时时钟实现。所以这个时间无论如何都不适合点事件。</p><p id="05ba" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">单调时钟:</strong>单调时钟时间表示从过去某个任意固定点开始的绝对经过时间。这种类型的时钟不会跳跃，而是在与NTP同步后，如果它发现本地时钟落后或领先NTP，它可以相应地调整时钟速率。它以服务器启动时间or或任何参考时间(Epoch)作为基准时间，并且<strong class="jv hj">严格地单调递增</strong>。<code class="du lz ma mb mc b"><strong class="jv hj">CLOCK_MONOTONIC</strong></code>是以服务器启动时间为基数的Linux实现，如果服务器重启，时钟也会重置。时钟不提供<code class="du lz ma mb mc b"><strong class="jv hj">set_time()</strong></code> API。<code class="du lz ma mb mc b"><strong class="jv hj">System.nanoTime()</strong></code>是单调时钟的Java实现。如果需要计算流程中两点之间的绝对时间差，可以使用单调时钟时间。然而，跨进程的单调时钟也不是彼此同步的，因此简单地说，它也不能用于在分布式系统中排序事件。</p><h2 id="9cc3" class="ll iw hi bd ix lm ln lo jb lp lq lr jf ke ls lt jj ki lu lv jn km lw lx jr ly bi translated">石英钟的准确度</h2><p id="3180" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">根据NASA的这篇文章<a class="ae iu" href="https://www.nasa.gov/feature/jpl/what-is-an-atomic-clock" rel="noopener ugc nofollow" target="_blank"/>，<strong class="jv hj">一个石英钟可以通过</strong> <code class="du lz ma mb mc b"><strong class="jv hj">1 nanosecond</strong></code> <strong class="jv hj">漂移一个小时后，</strong> <code class="du lz ma mb mc b"><strong class="jv hj">1 millisecond</strong></code> <strong class="jv hj">漂移六个星期后</strong>。因此漂移实现得相当快，使得<strong class="jv hj">石英钟对于超精密用例</strong>来说不可靠。</p><h1 id="410a" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">更精确的时钟:原子钟</h1><p id="8d8d" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">在原子钟中，某种形式的能量(如激光)被施加到某种特定元素的原子上(如<strong class="jv hj">铯</strong>)。这使得原子中的亚原子粒子，如电子，从一个能级移动到稍高的能级(称为<strong class="jv hj">超精细基态</strong>，并在不久后回到之前的能级，从而释放出之前在<code class="du lz ma mb mc b"><strong class="jv hj">9,192,631,770 Hz</strong></code>获得的额外能量。</p><p id="0f51" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><code class="du lz ma mb mc b">‘Hz’</code>，赫兹是频率的国际单位制单位，定义为‘每秒’。SI单位将<strong class="jv hj">秒</strong>定义为“<strong class="jv hj">对应于铯-133原子基态两个超精细能级之间跃迁的9192631770个辐射周期的持续时间。</strong>”</p><p id="4cc0" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">因此，当检测到来自铯原子的9192631770个微波发射波时，一秒钟就过去了。这种测量非常精确，以至于<strong class="jv hj">原子钟被认为是迄今为止最精确的时钟</strong>。</p><p id="a1d7" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">任何时钟都有三个通用高级组件:</p><p id="0b60" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">能量源:</strong>在原子钟中，比方说一个激光源(取决于设计，该激光源可能有所不同)，它被应用于原子上，使它们在设计的能量状态之间振动。在石英钟中，电池(在计算机CMOS电池的情况下)作为电源工作。</p><p id="a6d4" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">谐振腔:</strong>在原子钟中，原子释放的辐射就是谐振腔。在石英钟中，以周期性方式运动的机械齿轮起着谐振器的作用。</p><p id="b602" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">能源和谐振器合称为<strong class="jv hj">振荡器</strong>。</p><p id="c73a" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">计数器:</strong>在原子钟中，测量微波辐射周期的探测器。在石英钟中，显示器是计数器。</p><h2 id="82aa" class="ll iw hi bd ix lm ln lo jb lp lq lr jf ke ls lt jj ki lu lv jn km lw lx jr ly bi translated">原子钟的精确度</h2><p id="ab93" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">一般来说，原子钟每天精确到十亿分之一秒。</p><p id="cbd3" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">位于美国科罗拉多州博尔德的国家标准与技术研究院(NIST)维护着一个铯原子钟，名为NIST-F1，作为美国的主要时间和频率标准。</p><blockquote class="md me mf"><p id="5ac8" class="jt ju lk jv b jw kr jy jz ka ks kc kd mg kt kg kh mh ku kk kl mi kv ko kp kq hb bi translated">NIST-F1铯原子钟可以产生非常精确的频率，其每天的时间误差约为0.03纳秒，这意味着该钟在1亿年内会慢一秒钟。</p></blockquote><p id="779a" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">更多原子钟的细节可以在<a class="ae iu" href="https://www.livescience.com/32660-how-does-an-atomic-clock-work.html" rel="noopener ugc nofollow" target="_blank">这里</a>、<a class="ae iu" href="https://news.softpedia.com/news/How-Does-An-Atomic-Clock-Keep-Track-of-Time-51345.shtml" rel="noopener ugc nofollow" target="_blank">这里</a>和<a class="ae iu" href="https://science.thewire.in/the-sciences/india-optical-atomic-clocks-iucaa-iiser-quantum-technologies/" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="5bc0" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">但是，原子钟不适合商用服务器和计算机。它们看起来比冰箱还大，极其昂贵，需要特殊维护。看看下面的NIST-F1铯原子钟就知道了:</p><figure class="mk ml mm mn fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mj"><img src="../Images/0c2ec82de3d777455eacce26c11d89b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vanmr2JvKVdjc9xksuoRoA.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Figure: 1, Courtesy: <a class="ae iu" href="https://news.softpedia.com/news/How-Does-An-Atomic-Clock-Keep-Track-of-Time-51345.shtml" rel="noopener ugc nofollow" target="_blank">news.softpedia</a></figcaption></figure><h1 id="10c5" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">GPS时钟</h1><p id="d160" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">卫星上的GPS时钟是较小的原子钟装置，精度非常高，但不如上面描述的巨型地面原子钟精确。当然，它们背后的能源或技术与地面原子钟不同。下面这个GPS时钟很有意思:</p><p id="30b0" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">美国宇航局喷气推进实验室开发了<strong class="jv hj">深空原子钟</strong>，这是一种非常先进的GPS时钟，可以帮助其卫星在深空导航，最大限度地减少来自地球的干扰。到火星或任何其他星球的长距离任务都是由这种技术驱动的。</p><p id="fc50" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">这个原子钟比其他在太空中飞行的GPS时钟稳定50倍(稳定意味着时钟测量单位时间的一致性)</strong>。</p><p id="3b8b" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">关于深空原子钟的更多细节，<a class="ae iu" href="https://www.nasa.gov/feature/jpl/what-is-an-atomic-clock/" rel="noopener ugc nofollow" target="_blank">请看这里</a>。</p><h2 id="f2ab" class="ll iw hi bd ix lm ln lo jb lp lq lr jf ke ls lt jj ki lu lv jn km lw lx jr ly bi translated">GPS时钟的精确度</h2><blockquote class="md me mf"><p id="beea" class="jt ju lk jv b jw kr jy jz ka ks kc kd mg kt kg kh mh ku kk kl mi kv ko kp kq hb bi translated">美国宇航局的深空原子钟将在4天后误差不到1纳秒，10年后误差不到1微秒(百万分之一秒)。这相当于每1000万年只差一秒。</p></blockquote><div class="mk ml mm mn fd ab cb"><figure class="mo ij mp mq mr ms mt paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><img src="../Images/f6052fde69b00fcf931c838e9062f794.png" data-original-src="https://miro.medium.com/v2/resize:fit:1070/format:webp/1*yT-yS_ZJly77PKhryBYEBw.jpeg"/></div></figure><figure class="mo ij mu mq mr ms mt paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><img src="../Images/8b5014dfe4f3819812473f8b425eee4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:932/format:webp/1*2KGiFaTp780Nn9eLE-x3UA.jpeg"/></div><figcaption class="iq ir et er es is it bd b be z dx mv di mw mx">Figure: 2, Courtesy: <a class="ae iu" href="https://www.nasa.gov/mission_pages/tdm/clock/images.html" rel="noopener ugc nofollow" target="_blank">Deep Space Atomic Clock Images</a></figcaption></figure></div></div><div class="ab cl my mz gp na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="hb hc hd he hf"><p id="404b" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">现在让我们看看如何使用上述时间源来计算服务器和其他设备每天使用的实际时间。</p><h1 id="93b0" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">UTC(协调世界时)时间</h1><p id="d8b3" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">我相信每个人都知道UTC。它是全球时间标准，不同时区的本地时间都是根据它来计算的。UTC有以下两个部分:</p><h2 id="a1b1" class="ll iw hi bd ix lm ln lo jb lp lq lr jf ke ls lt jj ki lu lv jn km lw lx jr ly bi translated">世界时</h2><p id="38f1" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">世界时是一种计算时间的天文方法，由国际地球自转和参考系统服务(IERS)测量。它不同于通常的时钟时间。</p><blockquote class="md me mf"><p id="a6a3" class="jt ju lk jv b jw kr jy jz ka ks kc kd mg kt kg kh mh ku kk kl mi kv ko kp kq hb bi translated">世界时是反映地球自转平均速度的太阳时标准。使用本初子午线0°经度作为参考点，它显示了地球上平均太阳日的实际长度，即从一个太阳正午到下一个太阳正午的时间。在一个太阳日期间，我们的星球绕着它相对于太阳的轴完成一次完整的旋转。</p></blockquote><p id="d9e3" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">由于太空中围绕地球的几个天体的存在，地球的形状发生了变化，例如:月球的引力在地球上引起潮汐，这反过来又改变了地球的形状。这导致了地球完成一天的总时间的一些调整。所以通常一个地球日比<code class="du lz ma mb mc b">24</code>小时多几毫秒，在一些罕见的情况下，它也可能比<code class="du lz ma mb mc b">24</code>小时少几毫秒。</p><p id="8e84" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">根据写作日期，下表显示了最近几年的平均太阳日长度。如果你想知道今天的太阳日长度是多少，请查看<a class="ae iu" href="https://www.timeanddate.com/time/earth-rotation.html" rel="noopener ugc nofollow" target="_blank">本页</a>。</p><figure class="mk ml mm mn fd ij er es paragraph-image"><div class="er es nf"><img src="../Images/6ed76ef32516e40b0392f4e91f361b5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1276/format:webp/1*oasqCiwWzIUZ07mxZ_TntA.png"/></div><figcaption class="iq ir et er es is it bd b be z dx">Figure 3, Average solar day length as per March 7, 2021</figcaption></figure><p id="b624" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">世界时有不同的格式:UT0，UT1，UT2。UT1很流行，其他很少用。</p><blockquote class="md me mf"><p id="64f4" class="jt ju lk jv b jw kr jy jz ka ks kc kd mg kt kg kh mh ku kk kl mi kv ko kp kq hb bi translated">UT1是通过使用长基线干涉测量技术确定遥远的<a class="ae iu" href="https://en.wikipedia.org/wiki/Quasar" rel="noopener ugc nofollow" target="_blank">类星体</a>的位置，对月球和人造卫星进行激光测距，以及确定<a class="ae iu" href="https://en.wikipedia.org/wiki/Global_Positioning_System" rel="noopener ugc nofollow" target="_blank"> GPS </a>卫星轨道来计算的。<strong class="jv hj"> UT1在地球上各处都一样</strong>，与地球相对于遥远类星体的旋转角度成正比，具体来说就是<a class="ae iu" href="https://en.wikipedia.org/wiki/International_Celestial_Reference_Frame" rel="noopener ugc nofollow" target="_blank">国际天体参考系</a> (ICRF)，忽略一些小的调整。</p></blockquote><p id="78ac" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">在甚长基线干涉测量技术中，多个射电望远镜相隔数千英里放置以观察类星体。将所有这些数据结合起来，有效地发挥了一个数千英里大小的大型望远镜的作用，分辨率更高，能够以不到千分之一秒的精度确定行星的自转速度。观看以下视频，了解更多信息:</p><figure class="mk ml mm mn fd ij"><div class="bz dy l di"><div class="ng nh l"/></div></figure><h2 id="76bd" class="ll iw hi bd ix lm ln lo jb lp lq lr jf ke ls lt jj ki lu lv jn km lw lx jr ly bi translated">国际原子时</h2><p id="427c" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">TAI是一种时间刻度，使用全球69个国家实验室的大约400个高精度原子钟的组合输出。</p><blockquote class="md me mf"><p id="63aa" class="jt ju lk jv b jw kr jy jz ka ks kc kd mg kt kg kh mh ku kk kl mi kv ko kp kq hb bi translated">它提供了我们时钟滴答的准确速度。时间尺度是加权的，优先考虑由保持初级铯最高质量的机构提供的时间信号。</p></blockquote><p id="2b40" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">国际原子时不考虑地球缓慢的自转，但通用时间考虑</strong>。所以两者之间总是有时间差的。</p><h2 id="bb03" class="ll iw hi bd ix lm ln lo jb lp lq lr jf ke ls lt jj ki lu lv jn km lw lx jr ly bi translated">闰秒</h2><p id="f471" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">不仅是月球引力引起的潮汐效应，还有地震、地球熔融外核质量分布变化、两极附近大块冰的运动、地球大气密度和角动量变化等现象都会影响地球自转。总的观察是<strong class="jv hj">地球变得越来越慢</strong>，目前它每世纪每天慢<code class="du lz ma mb mc b">0.002</code>秒。这个速率不是恒定的，只是一个平均数字，并且这个速率也随着时间缓慢增长。</p><p id="8cb2" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">问:那又怎样？这个数字很小，何必在意呢？是的，虽然很小，但是日差会随着时间的推移而累积。以这种速度，今天是<code class="du lz ma mb mc b">0.002</code>，大约一年半后是<code class="du lz ma mb mc b">1</code>第二，大约<code class="du lz ma mb mc b">5000</code>年后是<code class="du lz ma mb mc b">1</code>小时。这意味着<strong class="jv hj">如果我们不在乎这种偏差，我们的时钟将在未来的某个时刻与天文时间或地球的实际自转速率不同步</strong>。为了补偿这种偏差，闰秒被引入。</strong></p><p id="3889" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">闰秒是额外的一秒，通常在6月或12月的最后一天(通常在<code class="du lz ma mb mc b">23:59</code>小时后)添加，此时原子钟(如NIST-F1)和世界时之间的时差变为<code class="du lz ma mb mc b">≥ 0.9</code>秒(读作<code class="du lz ma mb mc b">1</code>秒)。</p><p id="fb98" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">闰秒的发生没有确切的时间，但是根据地球运动的快慢，互联网上的计时器会相应地公布下一个闰秒。2016年12月31日(或2017年1月1日)添加了最后一个闰秒。到目前为止闰秒的完整列表可以在<a class="ae iu" href="https://www.ietf.org/timezones/data/leap-seconds.list" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="eb41" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">添加闰秒是一件棘手的事情，<a class="ae iu" href="https://www.wired.com/2012/07/leap-second-glitch-explained/" rel="noopener ugc nofollow" target="_blank">阅读</a>2012年网络崩溃仅仅是因为Linux的一个错误不能处理闰秒。</p><p id="7aab" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">问:闰秒可以是负数吗？<br/> A. 如果地球自转速度持续加快(2020年，<a class="ae iu" href="https://www.timeanddate.com/time/earth-faster-rotation.html" rel="noopener ugc nofollow" target="_blank">地球自转速度加快</a> 28倍:O)，平均一天将比24小时少几毫秒(可能是毫秒的几分之一)。在这种情况下，闰秒可以是负数。但是自从1973年这个概念出现以来，它从未发生过。</p><h2 id="9e16" class="ll iw hi bd ix lm ln lo jb lp lq lr jf ke ls lt jj ki lu lv jn km lw lx jr ly bi translated">闰秒涂抹</h2><p id="4a1f" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">尽管服务器和系统在没有闰秒的情况下仍然可以运行，但如上所述，时差会变得很大，从而在未来造成更多的混乱。给时钟添加闰秒似乎很简单，但这是一个繁琐的过程。有几项工作，比如在那一秒钟停止/暂停时钟(技术上是将时钟倒推)，以欺骗他们，好像没有额外的一秒钟，或者实际上给时钟增加了额外的一秒钟。这些都是非常错误的伎俩。</p><p id="7d48" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">谷歌推出了一种更好的方法，称为<a class="ae iu" href="https://developers.google.com/time/smear" rel="noopener ugc nofollow" target="_blank">闰涂抹</a>—<strong class="jv hj">将多出来的一秒钟分成几毫秒，在很长一段时间内持续添加到闰前后的时钟中</strong>，而不是一次性添加。这是一个聪明的解决方案，但还不是标准。谷歌通过其NTP服务器发布这些时间。</p><p id="9c5f" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">事实:</strong> <strong class="jv hj"> GPS时钟不在乎闰秒</strong>，所以GPS时间与地球真实自转不同步。他们在GPS信号中传输额外的偏移信息，让接收器知道他们需要调整多少偏移。</p><p id="49dc" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj"> UTC时间是使用UT和原子时得出的。</strong></p><blockquote class="md me mf"><p id="0361" class="jt ju lk jv b jw kr jy jz ka ks kc kd mg kt kg kh mh ku kk kl mi kv ko kp kq hb bi translated">协调世界时的速率基于原子频率标准，但协调世界时的纪元是同步的，以保持接近天文世界时。</p></blockquote></div><div class="ab cl my mz gp na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="hb hc hd he hf"><p id="fc39" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">现在我们知道普通的设备时钟不可靠，很容易漂移，而且原子钟非常昂贵，甚至一些最大的公司也不愿意在它们上面投资，问题是<strong class="jv hj">我们如何在日常设备和商用服务器上同步时钟？</strong></p><h1 id="555f" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">6.网络时间协议(NTP)</h1><p id="6e3a" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">NTP来此救援:)Yayyy！！！！</p><p id="44b2" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><a class="ae iu" href="https://en.wikipedia.org/wiki/Network_Time_Protocol" rel="noopener ugc nofollow" target="_blank"> NTP </a>通常是一种基于UDP的协议，旨在通过考虑网络延迟选择合适的时间服务器来同步可变延迟分组交换网络中的时钟。NTP在UTC时间的几毫秒内将时钟与<strong class="jv hj">同步。</strong></p><p id="00fb" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">NTP有一个被称为<strong class="jv hj">层</strong>的概念，它只不过是时间服务器的层次结构。从<code class="du lz ma mb mc b">0</code>到<code class="du lz ma mb mc b">15</code>有<code class="du lz ma mb mc b">16</code>这样的层次。<strong class="jv hj">地层</strong> <code class="du lz ma mb mc b"><strong class="jv hj">n + 1</strong></code> <strong class="jv hj">与地层</strong> <code class="du lz ma mb mc b"><strong class="jv hj">n</strong></code>同步。层<code class="du lz ma mb mc b">0</code>是最精确的级别，层<code class="du lz ma mb mc b">1</code>不如层<code class="du lz ma mb mc b">0</code>精确，以此类推，层<code class="du lz ma mb mc b">15</code>是上限，级别<code class="du lz ma mb mc b">16</code>代表完全不同步的设备。</p><p id="7fa9" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">任何计算机都可以通过这种NTP时间服务器层次结构将其时钟与互联网参考时钟同步(参见下面的stratum <code class="du lz ma mb mc b">0</code>时钟)。</p><figure class="mk ml mm mn fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ni"><img src="../Images/50a11c41abe33a83cda2c6400b3f1b55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7-Pj7Ejme8p6aMqylSDbqA.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Figure: 4, Courtesy: <a class="ae iu" href="https://www.ntp-zeit.de/index-en.htm" rel="noopener ugc nofollow" target="_blank">https://www.ntp-zeit.de/index-en.htm</a></figcaption></figure><p id="7a57" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">代表最准确(高精度)的时钟，如GPS时钟、原子钟、电波钟等。<strong class="jv hj">地层</strong> <code class="du lz ma mb mc b"><strong class="jv hj">0</strong></code> <strong class="jv hj">时钟与自身不同步</strong>。它们被称为<strong class="jv hj">参考时钟</strong>，这是一个非常特殊的类别，<strong class="jv hj">NTP中没有其他时钟可以自称为地层</strong> <code class="du lz ma mb mc b"><strong class="jv hj">0</strong></code> <strong class="jv hj">时钟</strong>。</p><p id="0090" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">层1 </strong>设备保持<strong class="jv hj">与层</strong>T13】的直接连接。上图中的黄色箭头代表了这一点。他们可能比地层 <code class="du lz ma mb mc b"><strong class="jv hj">0</strong></code> <strong class="jv hj">时钟</strong>晚<strong class="jv hj">几微秒。它们还可以作为备用时钟，在stratum <code class="du lz ma mb mc b">0</code>服务器不可用时相互同步。地层<code class="du lz ma mb mc b">1</code>设备被称为<strong class="jv hj">主时钟或主时间服务器</strong>。</strong></p><p id="3d91" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">层2 </strong>设备通过网络与层<code class="du lz ma mb mc b">1</code>设备<strong class="jv hj">同步(如上图蓝色箭头所示)。他们的精度在地层</strong> <code class="du lz ma mb mc b"><strong class="jv hj">1</strong></code>的几毫秒之内。Stratum <code class="du lz ma mb mc b">2</code>设备可以查询多个stratum 1设备，甚至可以与自身同步，以获得更高的准确性。</p><p id="3c16" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">同样，层<code class="du lz ma mb mc b">3</code>设备的工作机制与层<code class="du lz ma mb mc b">2</code>相似，其他层也是如此。</p><p id="b6fb" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">问:为什么NTP是时间服务器的分级结构？<br/> A. </strong>处理水垢。有数百万台设备异步连接到NTP服务器来调整时间。让它们都连接到同一个NTP层是不可行的。因此就有了等级制度。通常任何设备，比如说我们的计算机时钟，都会查询不同级别的多个时间服务器，选择最好的一个来调整时间。</p><p id="c8fa" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">已经有数以千计的地层<code class="du lz ma mb mc b">2</code>服务器。大多数大公司管理自己的NTP时间服务器，让成千上万的设备同步时间——其中一台计算机连接到NTP stratum <code class="du lz ma mb mc b">2</code>服务器，所有其他服务器或设备连接到这个内部服务器(从而形成stratum <code class="du lz ma mb mc b">3</code>)来同步自己的时间。</p><p id="c9eb" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">问:计算机如何与NTP同步？<br/>答:</strong>计算机运行类似<a class="ae iu" href="http://doc.ntp.org/4.1.0/ntpd.htm" rel="noopener ugc nofollow" target="_blank"> ntpd </a>(主要在*unix机器中)或<a class="ae iu" href="https://opensource.com/article/18/12/manage-ntp-chrony" rel="noopener ugc nofollow" target="_blank"> chrony </a>的守护进程，它们与NTP服务器同步——基本上它们按照配置文件中定义的间隔定期轮询NTP时间服务器。它们都实现了NTP协议，但一般来说，chrony比ntpd更准确、更好，因为它使用了<a class="ae iu" href="https://tools.ietf.org/html/draft-ietf-ntp-interleaved-modes-01" rel="noopener ugc nofollow" target="_blank">扩展的NTP协议</a>。</p><p id="4d27" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">问:NTP如何处理闰秒？<br/>答</strong>。NTP服务器可以配置为涂抹闰秒并将调整后的偏移传播到下游设备。谷歌的NTP服务器就是这样做的。</p><h2 id="3fe0" class="ll iw hi bd ix lm ln lo jb lp lq lr jf ke ls lt jj ki lu lv jn km lw lx jr ly bi translated">NTP池</h2><p id="d3b3" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated"><a class="ae iu" href="https://www.ntppool.org/en/" rel="noopener ugc nofollow" target="_blank"> NTP池</a>是一个虚拟的(不是由任何公司管理的真实集群，如果你有合理的互联网连接并且服务器有静态ip，你可以注册一个在你家运行的服务器)时间服务器集群，托管在<strong class="jv hj">pool.ntp.org</strong>的子域下。目前，NTP池下有4300多台时间服务器。</p><h2 id="38bf" class="ll iw hi bd ix lm ln lo jb lp lq lr jf ke ls lt jj ki lu lv jn km lw lx jr ly bi translated">NTP的准确性</h2><p id="83e6" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">准确性取决于许多因素，如地层级别(级别越高，您的时钟离参考时钟越远，因此准确性可能越低)、拥塞或设备导致的网络延迟、网络延迟的可变性、请求采用的网络路径、网络速度和质量等。此外，ntpd或chrony守护程序会根据提到的参数来测量估计时间。</p><p id="a31f" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">自己测量NTP延迟并不容易，需要特殊的硬件设置。脸书有自己的NTP服务器(<code class="du lz ma mb mc b">time.facebook.com</code>服务器)，你可以通过<a class="ae iu" href="https://engineering.fb.com/2020/03/18/production-engineering/ntp-service/" rel="noopener ugc nofollow" target="_blank">这篇文章</a>了解他们是如何为他们的实验测量NTP偏移量的。</p><p id="435e" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">很难引用任何数字，但总体来看取决于多个因素，<a class="ae iu" href="https://www.eecis.udel.edu/~mills/ntp.html" rel="noopener ugc nofollow" target="_blank"><strong class="jv hj"/></a><strong class="jv hj">NTP准确性可以在范围</strong> <code class="du lz ma mb mc b"><strong class="jv hj">0.1 ms</strong></code> <strong class="jv hj">与快速局域网</strong> <code class="du lz ma mb mc b"><strong class="jv hj">10 ms</strong></code> <strong class="jv hj">或更多(对于洲际网络</strong>)。</p><p id="9eb7" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">关于NTP准确性的精彩讨论可在<a class="ae iu" href="https://serverfault.com/questions/508586/is-there-research-material-on-ntp-accuracy-available" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><h2 id="7f76" class="ll iw hi bd ix lm ln lo jb lp lq lr jf ke ls lt jj ki lu lv jn km lw lx jr ly bi translated">公共NTP服务器</h2><p id="de20" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">如果感兴趣，请查看这里的<a class="ae iu" href="https://gist.github.com/mutin-sa/eea1c396b1e610a2da1e5550d94b0453" rel="noopener ugc nofollow" target="_blank"/>是免费的公共NTP服务器列表。</p><p id="6fc2" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">问:回到分布式系统中排序的原始问题，如果我们使用NTP同步时钟来排序事件，我们的问题应该解决吗？<br/>答:</strong>最小<code class="du lz ma mb mc b">10 ms</code>(最坏的情况下可能更高)内的精度看起来显然很小。但是对于一个大规模可扩展的系统，每微秒到纳秒都很重要。所以这种准确性并不适合大多数面向消费者的大型科技公司。</p><p id="8e7c" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">物理时间戳有可能<strong class="jv hj">严格排序事件</strong>。例如:假设有两个物理时间差为<code class="du lz ma mb mc b">1 millisecond</code>的节点，第一个节点运行事务<code class="du lz ma mb mc b">A</code>，第二个节点<strong class="jv hj">同时</strong>运行另一个事务<code class="du lz ma mb mc b">B</code>。<code class="du lz ma mb mc b">A</code>发生在时间戳<code class="du lz ma mb mc b">1614308336728</code>的<strong class="jv hj"> </strong>，而<code class="du lz ma mb mc b">B</code>发生在时间戳<code class="du lz ma mb mc b">1614308336727</code>——注意<code class="du lz ma mb mc b">A</code>和<code class="du lz ma mb mc b">B</code>之间的<code class="du lz ma mb mc b">1 ms</code>时间差。尽管事务实际上是并发的，但是当您通过降序时间戳检索它们时，<code class="du lz ma mb mc b">B</code>出现在<code class="du lz ma mb mc b">A</code>之前。如果此时此刻有数以千计的此类交易发生，想象一下排序会有多混乱。因此，使用物理时间，我们只是在这个特殊的例子中失去了并发的概念。类似地，如果两个事务甚至不应该是并发的，它们可能会因为时间戳的不同而看起来是并发的。根据系统和业务需求，这种场景可能会导致难以跟踪的错误。</p><p id="facc" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">这是物理时间的普遍问题，尽管时钟看起来高度同步。</p><p id="da70" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">问:我们现在如何解决这个问题？<br/> A. 我们有两种方法可以在高层解决这个:<br/> <strong class="jv hj">选项一:</strong>忘记真实时钟的存在，取一个更简单的机制来定义顺序。数字，是的！！！使用单调递增的普通整数计数器。这个机制叫做<strong class="jv hj">逻辑时钟或者逻辑时间戳</strong>。</p><p id="b4d6" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">选项2: </strong>使用真实时钟—定义一种机制，使时钟精度尽可能最高—定义<strong class="jv hj">在给定时刻跨节点观察到的最小可能最大时间偏差</strong>。这很难实现。我们将在以后的文章中回顾时钟的这一部分。</p><h1 id="b6eb" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">结论</h1><p id="48fa" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">我希望现在物理时间源和时间同步对我们所有人都很清楚。我们已经看到了物理时间在我们生活中的重要性，以及它与空间科学的关系。我们现在知道，在大规模分布式系统中，并不总是能够使用物理时间来对事件进行排序。</p><p id="acd5" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">在本系列的下一篇文章中，我们将深入讨论逻辑时钟。在那之前，请消化这篇文章，感谢科学家和工程师对时间和时钟做了这么多令人敬畏的研究，并为了人类的利益创造了如此美丽的系统。</p><p id="908c" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">如果你喜欢它，请给<strong class="jv hj">多次鼓掌</strong>并在Twitter和LinkedIn等社交媒体上与更广泛的观众分享它。</p><h1 id="f2f3" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">参考</h1><ol class=""><li id="2978" class="kw kx hi jv b jw jx ka kb ke nj ki nk km nl kq lb lc ld le bi translated">https://aphyr.com/posts/299-the-trouble-with-timestamps<a class="ae iu" href="https://aphyr.com/posts/299-the-trouble-with-timestamps" rel="noopener ugc nofollow" target="_blank"/></li><li id="6578" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated">【https://www.nasa.gov/feature/jpl/what-is-an-atomic-clock T4】</li><li id="07d0" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated"><a class="ae iu" href="https://www.gps.gov/applications/timing/" rel="noopener ugc nofollow" target="_blank">https://www.gps.gov/applications/timing/</a></li><li id="704a" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated"><a class="ae iu" href="https://engineering.fb.com/2020/03/18/production-engineering/ntp-service/" rel="noopener ugc nofollow" target="_blank">https://engineering . FB . com/2020/03/18/production-engineering/NTP-service/</a></li><li id="e2db" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated"><a class="ae iu" href="https://science.thewire.in/the-sciences/india-optical-atomic-clocks-iucaa-iiser-quantum-technologies/" rel="noopener ugc nofollow" target="_blank">https://science . the wire . in/the-sciences/India-optical-atomic-clocks-iucaa-iiser-quantum-technologies/</a></li><li id="d57d" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated"><a class="ae iu" href="https://earthsky.org/human-world/leap-second-june-30-december-31-why-need-controversy" rel="noopener ugc nofollow" target="_blank">https://EarthSky . org/human-world/leap-second-June-30-December-31-why-need-contention</a></li><li id="faf0" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated"><a class="ae iu" href="https://gist.github.com/mutin-sa/eea1c396b1e610a2da1e5550d94b0453" rel="noopener ugc nofollow" target="_blank">https://gist . github . com/mutin-sa/EEA 1c 396 B1 e 610 a2 da 1e 5550d 94b 0453</a></li><li id="7d74" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated"><a class="ae iu" href="https://www.ntppool.org/en/" rel="noopener ugc nofollow" target="_blank">https://www.ntppool.org/en/</a></li><li id="af23" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated"><a class="ae iu" href="https://en.wikipedia.org/wiki/Network_Time_Protocol" rel="noopener ugc nofollow" target="_blank">https://en.wikipedia.org/wiki/Network_Time_Protocol</a></li><li id="399c" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated"><a class="ae iu" href="https://netcraftsmen.com/ntp-accuracy/" rel="noopener ugc nofollow" target="_blank">https://netcraftsmen.com/ntp-accuracy/</a></li><li id="863f" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated"><a class="ae iu" href="http://www.ciol.com/leap-second-how-google-saved-websites/" rel="noopener ugc nofollow" target="_blank">http://www.ciol.com/leap-second-how-google-saved-websites/</a></li><li id="e710" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated"><a class="ae iu" href="https://en.wikipedia.org/wiki/Leap_second" rel="noopener ugc nofollow" target="_blank">https://en.wikipedia.org/wiki/Leap_second</a></li><li id="ba01" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated"><a class="ae iu" href="https://www.wired.com/2012/07/leap-second-glitch-explained/" rel="noopener ugc nofollow" target="_blank">https://www.wired.com/2012/07/leap-second-glitch-explained/</a></li><li id="adcb" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated"><a class="ae iu" href="https://queue.acm.org/detail.cfm?id=2745385" rel="noopener ugc nofollow" target="_blank">https://queue.acm.org/detail.cfm?id=2745385</a></li><li id="fbb8" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated"><a class="ae iu" href="http://people.cs.aau.dk/~bnielsen/DS-E08/material/clock.pdf" rel="noopener ugc nofollow" target="_blank">http://people.cs.aau.dk/~bnielsen/DS-E08/material/clock.pdf</a></li><li id="1e7c" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated"><a class="ae iu" href="http://www.cs.cmu.edu/~srini/15-446/S09/lectures/08-phy_time.pdf" rel="noopener ugc nofollow" target="_blank">http://www . cs . CMU . edu/~ srini/15-446/S09/lectures/08-phy _ time . pdf</a></li><li id="13f8" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated">http://www.ntp.org/ntpfaq/NTP-s-sw-clocks.htm<a class="ae iu" href="http://www.ntp.org/ntpfaq/NTP-s-sw-clocks.htm" rel="noopener ugc nofollow" target="_blank"/></li><li id="b758" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated">【https://www.eecis.udel.edu/~mills/ntp/html/warp.html T4】</li><li id="1243" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated"><a class="ae iu" href="https://blog.selectel.com/synchronizing-servers-ntp/" rel="noopener ugc nofollow" target="_blank">https://blog.selectel.com/synchronizing-servers-ntp/</a></li><li id="d9c2" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated"><a class="ae iu" href="http://tornado.sfsu.edu/geosciences/classes/m356/UTC/UTC.html" rel="noopener ugc nofollow" target="_blank">http://tornado . sfsu . edu/geosciences/classes/m356/UTC/UTC . html</a></li></ol></div></div>    
</body>
</html>