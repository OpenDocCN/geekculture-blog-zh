<html>
<head>
<title>When MACD couples with BB in Elasticsearch, …</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">当MACD和BB在《弹性搜索》中搭档时，…</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/when-macd-couples-with-bb-in-elasticsearch-3cca987c0678?source=collection_archive---------36-----------------------#2021-07-05">https://medium.com/geekculture/when-macd-couples-with-bb-in-elasticsearch-3cca987c0678?source=collection_archive---------36-----------------------#2021-07-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="9cfa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">移动平均线收敛发散(MACD)是基于趋势和动量的指标，而布林线(BB)是基于波动的指标。当MACD和BB成双成对时，一些专业人士称之为MACD BB，另一些人称之为BB MACD。在这篇文章中，MACD BB的名字被使用。两个技术分析指标的结合继承了两个指标的能力，并提供了对市场趋势的洞察力。从我密集的网络搜索来看，无处可说是谁发明了这个指标。如果有人知道，请分享出处。但是很多交易平台和论坛都提供这个指标作为高级功能。建议读者阅读我之前的两篇文章，以快速对这两个指标及其使用Elasticsearch的实现有一个基本的了解。<br/>根据《<a class="ae jd" href="https://wtwong316.medium.com/construct-macd-histogram-with-elasticsearch-ecd6b627457e" rel="noopener">用弹性搜索构建MACD直方图</a>》一文中描述的方程，MACD涉及一个短期和一个长期的指数加权移动平均线(EWMA)。这两个术语的常见用法是12和26。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/df69cf5a5a042018d2f09fe2bb9897d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nMJ7B2C2rFfT5jawNIeH9w.jpeg"/></div></div></figure><p id="7779" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在文章《<a class="ae jd" href="https://wtwong316.medium.com/calculate-bollinger-band-width-through-elasticsearch-39f7f3a1ceff" rel="noopener">通过弹性搜索</a>计算布林线宽度》中，BB是基于每日价格的简单移动平均线(SMA)和标准差(SD)来构造上波段(BBU)和下波段(BBL)。BB的中线就是SMA。从MACD BB的术语来看，它使用MACD而不是价格。BBL和BBU的计算解释如下，其中滑动窗口(window)是20或26，标准偏差(n)在通常实践中是1或2。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/5bf3f03912a38edf5ea772be57549732.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0q3oVCayU3QzAH3Wl1HoDw.jpeg"/></div></div></figure><p id="810a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">基本上，MACD、BBU和BBL将被绘制在一张图表上，用户可以观察MACD和这两个波段的交叉点。当MACD突破BBU时，它显示出强烈的上升信号。同样，当MACD突破BBL时，它显示了强烈的向下信号。用图表来描述意思要容易得多。在本文中，我们尝试将MACD和BB应用于免佣金的交易所交易基金(ETF ),并将弹性搜索作为分析工具。下面的例子随机选择“富达国际多因子ETF”。它的股票代码是FDEV。数据选自IEX投资者交易所提供的2021年2月1日至2021年5月31日的时间范围。MACD最常用的参数短期为12，长期为26。根据很多互联网文章，计算BB时，SMA的周期为10，BB的标准差为1。在下图中，绘制了MACD及其BBL、BBU和SMA。如果MACD值高于BBU，并且与前面时间戳中的值相比是一个增量，则它是一个水蓝色的点。如果MACD值高于BBU，并且是一个减量，它就是一个蓝点。如果MACD值低于BBL，并且是一个减量，它就是一个红点。如果MACD值低于BBL，并且是一个增量，则它是一个橙色点。对于其他情况，它是一个灰点。读者很容易观察到红色/橙色线在BBL下方，蓝色/水蓝色线在BBU上方。此外，当MACD值从零以下上升并穿过零时(考虑一个来自MACD的看涨信号)，在大多数情况下，有一个相应的蓝点紧随其后。同样，当MACD值从零以上下降并穿过零时(考虑MACD产生的看跌信号)，相应的红点也会随之出现。直线的斜率表示趋势的动量。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es jq"><img src="../Images/f0086031d093f0c6897daccded52d15c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oVugvPnnGeVNXscP2oqcgw.jpeg"/></div></div></figure><p id="2610" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是，当我们试图结合典型值解释MACD值从BBU或BBL突破的点时，它似乎与价格的上升或下降趋势不匹配，如下图所示。波动性增加的潜在迹象和未来可能的交易机会不容易捕捉，有时方向是相反的。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es jr"><img src="../Images/ee0e14d2d6578048ecb7d4c66ecdaa64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3z1YI8hPzIXpNvAyeQjj1Q.jpeg"/></div></div></figure><p id="aeae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">虽然大多数交易平台都提供了MACD BB指标，并给出了相同的评论“不适合新手交易者”，但其Elasticsearch实现显示了无缝集成，易于理解。假设有一个用数据填充的Elasticsearch索引，其使用的数据映射与上一篇论文中描述的相同。以下步骤演示了REST API请求体的代码。</p><blockquote class="js jt ju"><p id="df9a" class="if ig jv ih b ii ij ik il im in io ip jw ir is it jx iv iw ix jy iz ja jb jc hb bi translated">通过搜索操作收集所有相关文件</p></blockquote><p id="3616" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用带有“must”子句的“bool”查询来收集符号为FDEV且日期在2021年2月1日和2021年5月31日之间的文档。由于26个交易日移动平均线的计算，额外数据调整为1.5个月(从2021年12月15日至2021年2月1日)</p><pre class="jf jg jh ji fd jz ka kb kc aw kd bi"><span id="3b3d" class="ke kf hi ka b fi kg kh l ki kj">{<br/>    "query": {<br/>        "bool": {<br/>            "must": [<br/>                {"range": {"date": {"gte": "2020-12-15", "lte": "2021-05-31"}}},<br/>                {"term": {"symbol": "FDEV"}}<br/>            ]<br/>        }<br/>    },</span></pre><blockquote class="js jt ju"><p id="9f20" class="if ig jv ih b ii ij ik il im in io ip jw ir is it jx iv iw ix jy iz ja jb jc hb bi translated">计算基金的每日典型价值</p></blockquote><p id="7fec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用名为MACD的“date_histogram”聚合，其中参数“field”为“date ”,参数“interval”为“1d ”,以提取每天的基金价格。然后是名为TP的“scripted_metric”聚合，以计算典型价格，该价格等于最高价、最低价和收盘价的平均价格。</p><pre class="jf jg jh ji fd jz ka kb kc aw kd bi"><span id="bfd3" class="ke kf hi ka b fi kg kh l ki kj">    "aggs": {<br/>        "MACD_BB": {<br/>            "date_histogram": {<br/>                "field": "date",<br/>                "interval": "1d",<br/>                "format": "yyyy-MM-dd"<br/>            },<br/>            "aggs": {<br/>                "TP": {<br/>                    "scripted_metric": {<br/>                        "init_script": "state.totals=[]",<br/>                        "map_script": "state.totals.add((doc.high.value+doc.low.value+doc.close.value)/3)",<br/>                        "combine_script": "double total=0; for (t in state.totals) {total += t} return total",<br/>                        "reduce_script": "return states[0]"<br/>                    }<br/>                },</span></pre><blockquote class="js jt ju"><p id="a487" class="if ig jv ih b ii ij ik il im in io ip jw ir is it jx iv iw ix jy iz ja jb jc hb bi translated">提取桶的日期</p></blockquote><p id="cd24" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于存在额外的数据，后续操作需要稍后过滤掉超出范围的部分。一个名为“DateStr”的“min”聚合将获取存储桶的日期。在Elasticsearch服务器中，日期以纪元时间存储。时间单位是毫秒，时区是UTC。</p><pre class="jf jg jh ji fd jz ka kb kc aw kd bi"><span id="a2ba" class="ke kf hi ka b fi kg kh l ki kj">            "DateStr": {<br/>                "min": {"field": "date"}<br/>            },</span></pre><blockquote class="js jt ju"><p id="7018" class="if ig jv ih b ii ij ik il im in io ip jw ir is it jx iv iw ix jy iz ja jb jc hb bi translated">选择包含1个以上文档的存储桶</p></blockquote><p id="ba8e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了过滤掉空的时段(非交易日)，使用一个名为STP的“bucket_selector”聚合来选择文档计数大于0的时段。</p><pre class="jf jg jh ji fd jz ka kb kc aw kd bi"><span id="c669" class="ke kf hi ka b fi kg kh l ki kj">            "STP": {<br/>                "bucket_selector": {<br/>                    "buckets_path": {"count":"_count"},<br/>                    "script": "params.count &gt; 0"<br/>                }<br/>            },</span></pre><blockquote class="js jt ju"><p id="e729" class="if ig jv ih b ii ij ik il im in io ip jw ir is it jx iv iw ix jy iz ja jb jc hb bi translated">计算每日12个交易日和26个交易日EWMA的典型值</p></blockquote><p id="822e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用名为EWMA12的“移动_fn”聚合，参数window为12，参数“buckets_path”为TP.value，计算典型值的12个交易日EWMA。EWMA是通过使用函数MovingFunctions.ewma和参数alpha为2/(window+1)来计算的。EWMA26聚合可以用同样的方式完成。</p><pre class="jf jg jh ji fd jz ka kb kc aw kd bi"><span id="9350" class="ke kf hi ka b fi kg kh l ki kj">            "EWMA12": {<br/>                "moving_fn": {"script": "MovingFunctions.ewma(values, 2/(12+1))", "window": 12, "buckets_path": "TP.value"}<br/>            },<br/>            "EWMA26": {<br/>                "moving_fn" : {"script": "MovingFunctions.ewma(values, 2/(26+1))", "window": 26, "buckets_path": "TP.value"}<br/>            },</span></pre><blockquote class="js jt ju"><p id="6594" class="if ig jv ih b ii ij ik il im in io ip jw ir is it jx iv iw ix jy iz ja jb jc hb bi translated">计算MACD</p></blockquote><p id="1f28" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用名为macd的“bucket_script”聚合和参数“buckets _ path”来指定来自EWMA12和EWMA26的结果。然后根据脚本中的等式计算MACD指标。</p><pre class="jf jg jh ji fd jz ka kb kc aw kd bi"><span id="f068" class="ke kf hi ka b fi kg kh l ki kj">            "MACD": {<br/>                "bucket_script": {<br/>                    "buckets_path": {<br/>                        "EWMA12": "EWMA12",<br/>                        "EWMA26": "EWMA26"<br/>                    },<br/>                    "script": "params.EWMA12 - params.EWMA26"<br/>                }<br/>            },</span></pre><blockquote class="js jt ju"><p id="fb3c" class="if ig jv ih b ii ij ik il im in io ip jw ir is it jx iv iw ix jy iz ja jb jc hb bi translated">计算每日10天简单移动平均值的典型值</p></blockquote><p id="f08e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用名为SMA10的“移动_fn”聚集，参数窗口为10，参数“桶_路径”为MACD，来计算MACD值的10天SMA。SMA是使用未加权平均函数(MovingFunctions.unweightedAvg)计算的。</p><pre class="jf jg jh ji fd jz ka kb kc aw kd bi"><span id="242d" class="ke kf hi ka b fi kg kh l ki kj">            "SMA10": {<br/>                 "moving_fn" :{"script": "MovingFunctions.unweightedAvg(values)", "window":10, "buckets_path":"MACD"}<br/>            },</span></pre><blockquote class="js jt ju"><p id="5ce5" class="if ig jv ih b ii ij ik il im in io ip jw ir is it jx iv iw ix jy iz ja jb jc hb bi translated">计算典型值的每日10天标准偏差</p></blockquote><p id="2e02" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用名为SD10的“移动_fn”聚合，参数窗口为10，参数“桶_路径”为MACD，来计算10天的MACD标准差。SD是使用标准差函数(MovingFunctions.stdDev)计算的。</p><pre class="jf jg jh ji fd jz ka kb kc aw kd bi"><span id="0d9c" class="ke kf hi ka b fi kg kh l ki kj">            "SD10": {<br/>                "moving_fn": {"script":"MovingFunctions.stdDev(values, MovingFunctions.unweightedAvg(values))", "window":10, "buckets_path":"MACD"}<br/>            },</span></pre><blockquote class="js jt ju"><p id="1627" class="if ig jv ih b ii ij ik il im in io ip jw ir is it jx iv iw ix jy iz ja jb jc hb bi translated">计算MACD BB</p></blockquote><p id="140d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用两个名为BBU10和BBL10的“bucket_script”聚合，并使用参数“buckets _ path”来指定SMA10聚合和SD10聚合的结果。然后，BBL10和BBU10通过SMA10加上或减去SD10的值来计算。</p><pre class="jf jg jh ji fd jz ka kb kc aw kd bi"><span id="454f" class="ke kf hi ka b fi kg kh l ki kj">            "BBU10": {<br/>                "bucket_script": {<br/>                    "buckets_path": {<br/>                        "SMA": "SMA10",<br/>                        "SD": "SD10"<br/>                    },<br/>                    "script": "params.SMA + params.SD"<br/>                }<br/>            },<br/>            "BBL10": {<br/>                "bucket_script": {<br/>                    "buckets_path": {<br/>                        "SMA": "SMA10",<br/>                        "SD": "SD10"<br/>                    },<br/>                    "script": "params.SMA - params.SD"<br/>                }<br/>            },</span></pre><blockquote class="js jt ju"><p id="aa43" class="if ig jv ih b ii ij ik il im in io ip jw ir is it jx iv iw ix jy iz ja jb jc hb bi translated">确定MACD值的类型</p></blockquote><p id="65b0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">a)使用名为“MACD _差异”的“衍生”聚合，并使用参数“桶_路径”来指定MACD的值，以确定它是从前面时间戳处的MACD增加还是减少。</p><pre class="jf jg jh ji fd jz ka kb kc aw kd bi"><span id="b50b" class="ke kf hi ka b fi kg kh l ki kj">            "MACD_Diff": {<br/>                "derivative": {<br/>                    "buckets_path": "MACD" <br/>                }<br/>            },</span></pre><p id="25c2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">b)使用名为macdType的“bucket_script”聚合，并带有参数“buckets_path”来指定BBL10、BBU10、MACD和macd迪夫聚合的结果，以对MACD值的类型进行分类。</p><p id="5309" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">➤类型1如果macd_Diff是减量和macd值&lt; BBL<br/> ➤类型2如果MACD_Diff是增量和MACD值&lt; BBL <br/> ➤类型3如果MACD_Diff是增量和MACD值&gt; BBU <br/> ➤类型4如果MACD_Diff是减量和MACD值&gt; BBU <br/> ➤类型0其他情况</p><pre class="jf jg jh ji fd jz ka kb kc aw kd bi"><span id="4c6f" class="ke kf hi ka b fi kg kh l ki kj">            "MACDType": {<br/>                "bucket_script": {<br/>                    "buckets_path": {<br/>                        "BBL": "BBL10",<br/>                        "BBU": "BBU10",<br/>                        "MACD": "MACD",<br/>                        "MACD_Diff": "MACD_Diff"<br/>                    },<br/>                   "script": "(params.MACD &gt; params.BBU) ? (params.MACD_Diff &gt; 0 ? 3:4) : (params.MACD &lt; params.BBL) ? (params.MACD_Diff &gt; 0 ? 2:1):0"<br/>                }<br/>            },</span></pre><blockquote class="js jt ju"><p id="2afd" class="if ig jv ih b ii ij ik il im in io ip jw ir is it jx iv iw ix jy iz ja jb jc hb bi translated">筛选出要输出的附加文档</p></blockquote><p id="868a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用名为SMACD_BB的“bucket_selector”聚合，使用参数“buckets_path”作为“DateStr”来选择“script”语句中指定的正确存储桶。选择标准是那些日期在2021年2月1日或之后的存储桶(纪元时间1612137600000毫秒)。</p><pre class="jf jg jh ji fd jz ka kb kc aw kd bi"><span id="1c60" class="ke kf hi ka b fi kg kh l ki kj">            "SMACD_BB": {<br/>                "bucket_selector": {<br/>                    "buckets_path": {"DateStr":"DateStr"},<br/>                    "script": "params.DateStr &gt;= 1612137600000L"<br/>                }<br/>            }<br/>         } <br/>      }<br/>   },<br/>   "size": 0<br/>}</span></pre><blockquote class="js jt ju"><p id="4649" class="if ig jv ih b ii ij ik il im in io ip jw ir is it jx iv iw ix jy iz ja jb jc hb bi translated">收集完结果后，我们就可以画出如图所示的图形了。类型3的点颜色是水蓝色，类型4是蓝色，类型1是红色，类型2是橙色，其他是灰色。</p></blockquote><p id="7573" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">读者可以进一步参考GitHub上的开源项目(<a class="ae jd" href="https://github.com/wtwong316/MACD_BB" rel="noopener ugc nofollow" target="_blank"> MACD_BB </a>)</p><p id="4afe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">备注:</p><p id="72fd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一、感谢IEX(投资者交易所)提供ETF数据，也感谢GitHub提供开源项目存储。</p><p id="5888" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">二。本文基于一种技术思路，不构成任何投资建议。读者在使用时必须承担自己的责任。</p><p id="b132" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">三。文章可能还有错误，恳请读者指正。</p><p id="2fc1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">四。感兴趣的读者可以参考作者写的关于弹性搜索基本技巧的书。《高级弹性搜索7.0》，2019年8月，Packt，ISBN: 9781789957754。</p></div></div>    
</body>
</html>