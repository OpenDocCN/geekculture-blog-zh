<html>
<head>
<title>The Curious Case of Autoscaling: How-to Scale Unpredictable Flash Traffic</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">自动扩展的奇特案例:如何扩展不可预测的闪存流量</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/autoscaling-how-to-scale-unpredictable-flash-traffic-899cebaa3934?source=collection_archive---------14-----------------------#2021-03-09">https://medium.com/geekculture/autoscaling-how-to-scale-unpredictable-flash-traffic-899cebaa3934?source=collection_archive---------14-----------------------#2021-03-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="70c4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">由Jo De Coninck (CDN产品负责人)、Kenneth De Win(开发人员)和Gert Leenders(云解决方案架构师)撰写</em></p><p id="71eb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Flash流量是自动伸缩的陷阱之一。这种流量最著名的例子就是黑色星期五。如何解决扩展困难？让我们找出答案。</strong></p><p id="9265" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">与您的正常流量基线相比，flash流量属于异常值；它通常比你平均收到的流量高很多倍。另一个特点是其陡峭的曲线。通常，从活动开始的那一刻起，流量就开始激增。这些特征使得很难将它们整合到自动缩放算法中。在DPG媒体，我们也会遇到突发事件，但我们是在实时新闻更新中体验到的。下面是我们的旅程，描述了我们如何解决闪存流量的扩展难题。</p><h1 id="80bf" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">什么是DPG媒体的直播服务</h1><p id="a76a" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">这篇关于自动缩放的文章围绕DPG媒体的(微)服务展开，为数字新闻媒体提供实时新闻更新。为了简单起见，在本文的剩余部分，我们称这个服务为“实时服务”。</p><p id="a19e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">其核心是，直播服务提供各种事件的实时更新:体育比赛、灾难、恐怖袭击、投票结果等。从事件列表中，您可能已经猜到直播服务在大多数时间都提供非常受欢迎的内容。它既是高浏览量的病毒式内容，也是持续更新的实时内容。</p><h1 id="7d42" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">拥挤的车流</h1><p id="0d49" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">如果您不久前看了一下live-service的内部，您会发现几个ECS Fargate容器正在运行一个Spring Boot应用程序。在容器的前面，一个应用负载平衡器充当了我们的内容交付网络(CDN)的起源。</p><p id="e139" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">事实上，直播服务的流量是如此之大，如果没有CDN在它面前，它将无法生存。虽然大多数情况下，将CDN放在内容之前是简单明了的，但直播服务却不是这样。</p><p id="fc2d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们的第一个教训是，尽管我们实现了非常高的CDN卸载百分比，但每次CDN缓存被清除时，实时服务的压力都太大了。<strong class="ih hj">这是一种有趣的模式:只要CDN从缓存中提供服务，后端就不会感到压力。然而，CDN缓存一失效，大量的请求就像流量山洪爆发一样袭击了直播服务。</strong>在一瞬间，流量激增根本没有时间扩展或做出反应——直播服务就这样被淹没了。😓</p><p id="c34b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">到达起点(实时服务)的流量如下:</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es kh"><img src="../Images/d2c99042530732ca7e381ecc0c56ab71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1158/0*JtgksOpuXpV7PBwG"/></div></figure><p id="4905" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于实时服务，每次CDN缓存清除都感觉像是针对它发动了DDoS攻击。问题是双重的:太多的请求到达了后端，所有的请求都是在同一瞬间发出的。</p><h1 id="2869" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">模糊的视觉:在意想不到的地方寻找解决方案</h1><p id="8de0" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">现在可能已经很清楚，flash流量对于自动扩展来说是一种糟糕的模式。加上新闻更新的不可预测的时间，你可能会想是否有自动缩放的空间。有！所以让我们带你经历一下。</p><h1 id="713a" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">快速失败</h1><p id="09c9" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">要解决的第一个问题是在非常高的流量泛滥的情况下完全失败——实时服务变得完全没有响应，并且无法再提供缓存更新。为了克服这一点，实施<a class="ae kp" href="https://dev.to/aws-builders/the-curious-case-of-autoscaling-4lb6" rel="noopener ugc nofollow" target="_blank">快速失效模式</a>。<strong class="ih hj">最终，一个CDN所需要的只是一个刷新其缓存的单一响应；其他请求全部失败</strong>也没关系。</p><h1 id="c83e" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">异步刷新缓存</h1><p id="87cb" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">然而，仅仅快速失败是不够的。是时候仔细看看我们的CDN的功能了，在这种情况下是Akamai。为了帮助降低负载，我们首先启用了<a class="ae kp" href="https://learn.akamai.com/en-us/webhelp/api-gateway/api-gateway-user-guide/GUID-C08A2F17-BC1E-4F9E-89AE-09CF435C4F2D.html" rel="noopener ugc nofollow" target="_blank">缓存预刷新</a>，这是减轻原点压力的第一个巧妙技巧。</p><p id="00cc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Akamai预刷新允许您始终从缓存提供内容，并异步调用origin进行缓存刷新。它避免了当缓存过期时向客户端提供较慢的响应。这是通过消除对始发转发刷新调用的等待来实现的。</p><p id="2d38" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里有一个预刷新的例子:</p><p id="1222" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">假设一个对象的缓存生存时间(TTL)设置为10分钟。一旦填充了缓存，接下来10分钟内的所有后续请求都将由缓存提供服务。但是，当预刷新设置为TTL的90%时，在第9分钟后到达的请求将返回缓存的对象。Akamai还将向源异步转发一个刷新请求，让缓存再热10分钟。</em></p><h1 id="de18" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">避免请求泛滥</h1><p id="748d" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">我们必须承认，异步缓存刷新并不能解决所有问题。对于流行的内容，预计许多客户端会同时请求相同的内容；预取并不能解决这个问题。以上面的例子为例，想象成千上万的并发请求在第9分钟到达。Akamai将从缓存中为所有这些请求提供服务，但它也会为其中的每一个请求向源发起一个请求。这就是我们前面提到的交通闪食。</p><p id="4139" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了避免山洪爆发，Akamai有一个隐藏的功能，叫做“公开-早期”。Akamai只能根据请求打开的这一功能，只将一个刷新调用转发给源，并告诉其他请求等待该响应。该功能也被称为<a class="ae kp" href="https://www.akamai.com/uk/en/multimedia/documents/product-brief/cloud-wrapper-product-brief.pdf" rel="noopener ugc nofollow" target="_blank">请求折叠</a>，其目的是减少到原点的行程。</p><h1 id="e82f" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">缓存标签</h1><p id="2b79" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">关于缓存标签的一点小注意:缓存标签在实时服务中很方便。使用缓存标签，您可以将对象链接在一起，以便对它们应用相同的缓存逻辑。假设有一篇文章、一个实时博客和一个自动收报机，每个都发布了一场特定足球比赛的当前比分。通过向所有这些项目添加相同的cache-tag(例如，match-id ),您可以无限期地缓存它们，并在分数发生变化时使用一个purge-command清除所有项目的缓存。</p><h1 id="8922" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">起源2.0: AWS S3拯救</h1><p id="1e92" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">虽然CDN设置解决了这个问题，但是根据我们一路走来学到的一切，我们找到了一个更好的解决方案。如果你看看现在的实时服务，你会发现它使用了不同的来源，需要不同的扩展方法。虽然我们的大多数服务使用AWS自动扩展原则进行扩展，但实时服务完全通过CDN来处理扩展。在其目前的设置中，live-services只负责保持CDN的来源新鲜。为此，每当有新闻更新时，它就在S3上创建静态资产。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es kq"><img src="../Images/0cb778c5842bd3fe6d01154d54fbd927.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-lqxNNEb7MTCbTkz"/></div></div></figure><p id="a6f5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">S3再一次感觉像是瑞士军队的多功能工具。随着live-services将其静态资产放在S3，CDN只需指出S3的来源。S3的可用性和持久性确保我们可以安心睡觉。</strong>然而，这还不够吗，Akamai总是提供不新鲜的食物。</p><h1 id="d367" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">数十亿次请求</h1><p id="206e" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">总而言之，直播服务是格特(本文作者之一)开始为DPG媒体工作的一个完美例子。格特:“我有相当好的记录，但从未遇到过像DPG媒体服务大军那样高的流量。在DPG媒体，我学会了在另一个层面上应对流量，在直播服务中，以及它的每个其他方面，从大数据和机器学习到数据库交易和消息。这很有趣，也很有挑战性。因为高流量会带来高影响，有时也会带来高压力。”</p></div></div>    
</body>
</html>