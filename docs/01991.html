<html>
<head>
<title>Get Started with AWS SAM and ASP.NET Core</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">开始使用AWS SAM和ASP.NET核心</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/get-started-with-aws-sam-and-asp-net-core-6d4eddddbb93?source=collection_archive---------5-----------------------#2021-05-01">https://medium.com/geekculture/get-started-with-aws-sam-and-asp-net-core-6d4eddddbb93?source=collection_archive---------5-----------------------#2021-05-01</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/34d8c56884bc542d2583b31c0dd74b43.png" data-original-src="https://miro.medium.com/v2/resize:fit:586/format:webp/1*DboPfss0XSkKCVymAng72w.png"/></div></figure><p id="f54b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><a class="ae jk" href="https://aws.amazon.com/serverless/sam/" rel="noopener ugc nofollow" target="_blank"> AWS无服务器应用模型</a>，又名SAM，是Lambda、APIGateway、DynamoDB等AWS服务的捆绑。此外，AWS还提供工具来帮助开发人员轻松开发无服务器应用程序。AWS SAM支持nodejs、go、python等多种编程语言。然而，在本文中，我使用了。NET及其web框架ASP.NET核心来演示。</p><p id="822d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我选择的原因。NET不仅我很熟悉，而且AWS还为. NET提供了其他工具，这些工具使得开发比其他编程语言更容易(至少我是这么感觉的)。</p><p id="58ca" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">为什么要使用无服务器应用？</strong></p><p id="8a62" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">无服务器应用程序有很多好处，比如更便宜。不像普通的web应用程序必须全天候运行。无服务器应用程序只能按需运行。如果没有人使用你的网络应用，你几乎不用支付任何费用。以下数字基于每月付款的<a class="ae jk" href="https://calculator.aws/" rel="noopener ugc nofollow" target="_blank"> AWS定价计算器</a>:</p><p id="fb3f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">无服务器应用</strong></p><ul class=""><li id="956e" class="jl jm hi io b ip iq it iu ix jn jb jo jf jp jj jq jr js jt bi translated">0个请求，付款约为0美元</li><li id="b995" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated">10，000个请求，付款约为1美元</li><li id="de5d" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated">1，000，000个请求，报酬约为10美元</li></ul><p id="c051" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">EC2上的应用</strong></p><ul class=""><li id="f238" class="jl jm hi io b ip iq it iu ix jn jb jo jf jp jj jq jr js jt bi translated">0个请求，1个t2.micro的付款约为10美元</li><li id="1c62" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated">10，000个请求，1个t2.micro的报酬约为10美元</li><li id="957f" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated">1，000，000个请求，1个t4g的付款约为100美元</li></ul><p id="2fb2" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">对于一个小的web应用程序来说，这是一个巨大的削减。</p><blockquote class="jz ka kb"><p id="6f57" class="im in kc io b ip iq ir is it iu iv iw kd iy iz ja ke jc jd je kf jg jh ji jj hb bi translated"><em class="hi">注:这些数字仅将Lambda和APIGateway与EC2进行了比较。可能还有其他费用，比如53路和S3。此外，lambda被设置为运行2000 MS并使用256 MB内存。</em></p></blockquote><h1 id="4280" class="kg kh hi bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated"><strong class="ak">要求</strong></h1><p id="12a7" class="pw-post-body-paragraph im in hi io b ip le ir is it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj hb bi translated">这些是要求</p><ul class=""><li id="37f7" class="jl jm hi io b ip iq it iu ix jn jb jo jf jp jj jq jr js jt bi translated">AWS帐户</li></ul><p id="91c1" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">您不需要安装AWS-CLI来运行SAM，但是您需要将AWS凭证放在环境变量或~/中。AWS/凭据</p><ul class=""><li id="e50f" class="jl jm hi io b ip iq it iu ix jn jb jo jf jp jj jq jr js jt bi translated">AWS桶</li></ul><p id="eb51" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">代码将被推到桶中</p><ul class=""><li id="f448" class="jl jm hi io b ip iq it iu ix jn jb jo jf jp jj jq jr js jt bi translated"><a class="ae jk" href="https://dotnet.microsoft.com/download" rel="noopener ugc nofollow" target="_blank">。网芯3.1 SDK </a></li></ul><p id="c3a0" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在我写这篇文章的时候，AWS Lambda还不支持。NET 5或6，除非你使用容器，但这是出了题。</p><ul class=""><li id="f359" class="jl jm hi io b ip iq it iu ix jn jb jo jf jp jj jq jr js jt bi translated"><a class="ae jk" href="https://github.com/aws/aws-lambda-dotnet" rel="noopener ugc nofollow" target="_blank">亚马逊。λ工具和模板</a></li></ul><p id="e064" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">之后。NET SDK，运行下面的命令来安装lambda工具和模板。</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="279c" class="ls kh hi lo b fi lt lu l lv lw"># install lambda tools</span><span id="81c6" class="ls kh hi lo b fi lx lu l lv lw">dotnet tool install --global Amazon.Lambda.Tools<br/></span><span id="f446" class="ls kh hi lo b fi lx lu l lv lw"># install templates</span><span id="fb4d" class="ls kh hi lo b fi lx lu l lv lw">dotnet new -i "Amazon.Lambda.Templates::*"<br/></span><span id="305d" class="ls kh hi lo b fi lx lu l lv lw"># you can run this command to list the lambda templates</span><span id="65e5" class="ls kh hi lo b fi lx lu l lv lw">dotnet new serverless --list</span></pre><p id="ec5e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这些是无服务器的模板</p><figure class="lj lk ll lm fd ij er es paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="er es ly"><img src="../Images/443202484af91c704dd99fedcb97c8cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IYHRI_g8tLGZ7a7gJA_MLA.png"/></div></div></figure><h1 id="09c9" class="kg kh hi bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">创建无服务器应用程序</h1><p id="2661" class="pw-post-body-paragraph im in hi io b ip le ir is it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj hb bi translated">我们将使用<code class="du md me mf lo b">serverless.AspNetCoreWebAPI</code>模板，因为它不会生成太多或太少的文件。我们可以运行这个命令来创建MyFirstSAM项目。</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="9c90" class="ls kh hi lo b fi lt lu l lv lw">dotnet new serverless.AspNetCoreWebAPI --name MyFirstSAM<br/>cd MyFirstSAM</span></pre><figure class="lj lk ll lm fd ij er es paragraph-image"><div class="er es mg"><img src="../Images/684542e741975aa89fe10f783b696d41.png" data-original-src="https://miro.medium.com/v2/resize:fit:572/format:webp/1*pPKS189Zhfsuzrxpft0UGQ.png"/></div></figure><p id="3c5e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这些是生成的文件。它与<code class="du md me mf lo b">webapi</code>模板几乎完全相同。它有三个新文件和一个重命名。</p><ul class=""><li id="9e98" class="jl jm hi io b ip iq it iu ix jn jb jo jf jp jj jq jr js jt bi translated"><strong class="io hj">AWS-lambda-tools-defaults . JSON</strong>:当使用<code class="du md me mf lo b">dotnet lambda</code>命令时，如果我们不给出具体的选项值，它将使用这个文件中的值。</li><li id="caf0" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated">cs:lambda的入口点。</li><li id="2f21" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated"><strong class="io hj"> serverless.template </strong>:创建资源的AWS CloudFormation模板。</li><li id="7ba0" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated"><strong class="io hj"> LocalEntryPrint.cs </strong>:是Program.cs的重命名，用于在本地运行应用程序。</li></ul><p id="fb2a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><code class="du md me mf lo b">serverless.AspNetCoreWebAPI</code>模板的好处是</p><ul class=""><li id="3f9c" class="jl jm hi io b ip iq it iu ix jn jb jo jf jp jj jq jr js jt bi translated">它创建LambdaEntryPoint.cs来隐式地将Lambda事件转换为ASP.NET上下文。我们可以编写一个普通的APS.NET应用程序的应用程序，没有额外的工作人员采用。(我们甚至可以在AWS SAM之外部署应用，比如Azure)</li><li id="c234" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated">该应用程序可以在本地运行。如果用其他模板比如<code class="du md me mf lo b">serverless.EmptyServerless</code>。代码不能开箱即用地在本地运行。</li></ul><p id="b870" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">既然是常规的ASP.NET，我们可以自己添加支持MVC或者Razor页面。例如，将服务更改为下面的代码。</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="be4b" class="ls kh hi lo b fi lt lu l lv lw">// Startup.cs<br/>public void ConfigureServices(IServiceCollection services) {<br/>  services<br/>    .AddRazorPages() // support Razor Pages<br/>    .AddControllersWithViews(); // support MVC<br/>}</span></pre><h1 id="8404" class="kg kh hi bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated"><strong class="ak"> serverless.template </strong></h1><p id="c288" class="pw-post-body-paragraph im in hi io b ip le ir is it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj hb bi translated">AWS为SAM创建了类型<code class="du md me mf lo b">AWS::Serverless::Function</code>。该类型在部署时会被转换为<code class="du md me mf lo b">AWS::Lambda::Function</code>和<code class="du md me mf lo b">AWS::ApiGatewayV2::Api</code>等资源，可以阅读官方文档了解更多<a class="ae jk" href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-resource-function.html" rel="noopener ugc nofollow" target="_blank">AWS::server less::Function</a>。</p><p id="116c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">默认情况下，模板通过定义<code class="du md me mf lo b">Events</code>包含一个APIGateway资源。类型<code class="du md me mf lo b">Api</code>是旧版本的REST API，它为stage生成了一个无用的路径<code class="du md me mf lo b">/Prod</code>。因为很难在一个SAM中创建阶段。所以我们可以将类型改为<code class="du md me mf lo b">HttpAPi</code>并做如下修改。</p><figure class="lj lk ll lm fd ij er es paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="er es mh"><img src="../Images/ac9c1ffcfb255dfcf1218d57891ee070.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fQUONdLotSd50_iL701Tkg.png"/></div></div></figure><p id="5a57" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">serverless.template支持JSON和YAML格式。所以我通常把它从JSON转换成YAML，以便更好地读写。但是，您仍然可以使用JSON格式。</p><p id="e38a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果更改为<code class="du md me mf lo b">HttpApi</code>，还需要更改LambdaEntryPoint.cs中的继承类型</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="0711" class="ls kh hi lo b fi lt lu l lv lw">- LambdaEntryPoint : Amazon.Lambda.AspNetCoreServer.APIGatewayProxyFunction</span><span id="6bed" class="ls kh hi lo b fi lx lu l lv lw">+ LambdaEntryPoint : Amazon.Lambda.AspNetCoreServer.APIGatewayHttpApiV2ProxyFunction</span></pre><h1 id="efea" class="kg kh hi bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">部署</h1><p id="3052" class="pw-post-body-paragraph im in hi io b ip le ir is it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj hb bi translated">lambda工具还包括部署命令<code class="du md me mf lo b">dotnet lambda deploy-serverless &lt;stack-name&gt;</code>。这个命令将</p><ul class=""><li id="2f3a" class="jl jm hi io b ip iq it iu ix jn jb jo jf jp jj jq jr js jt bi translated">构建代码</li><li id="9e8b" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated">Zip输出文件</li><li id="b777" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated">把拉链推到S3</li><li id="e6f6" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated">将模板推至云形成</li><li id="a975" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated">然后CloudFormation会为我们创建堆栈。</li></ul><p id="dfa2" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">由于HttpApi不支持stage，我们可以创建不同的栈作为stage。比如下面的命令。</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="6efb" class="ls kh hi lo b fi lt lu l lv lw">cd "src/MyFirstSAM" <br/>dotnet lambda deploy-serverless MyFirstSAMProd <br/>dotnet lambda deploy-serverless MyFirstSAMStaging</span></pre><p id="f3f3" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">输出将显示url。你现在可以在SAM上测试这个应用了。</p><h1 id="e191" class="kg kh hi bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">设置环境变量</h1><p id="37ac" class="pw-post-body-paragraph im in hi io b ip le ir is it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj hb bi translated">您还可以定义如何设置应用程序的环境变量(lambda)。有两种方法。</p><ul class=""><li id="9fa9" class="jl jm hi io b ip iq it iu ix jn jb jo jf jp jj jq jr js jt bi translated">via <a class="ae jk" href="https://aws.amazon.com/systems-manager/" rel="noopener ugc nofollow" target="_blank"> AWS SSM </a></li><li id="414e" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated">当执行<code class="du md me mf lo b">deploy-serverless</code>命令时，通过<code class="du md me mf lo b">--template-parameter</code>选项。</li></ul><p id="14f0" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">例如，我们可以在serverless.template上添加参数来支持它们。</p><figure class="lj lk ll lm fd ij er es paragraph-image"><div class="er es mi"><img src="../Images/6f2c361b5d87462752c95da72960a0d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:876/format:webp/1*xJnyQUOT7Ffb_6AQ-zHLSQ.png"/></div></figure><p id="3d09" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在JSON中！裁判是<code class="du md me mf lo b">{ "Ref" : "MyTPENV" }</code></p><p id="4385" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">展开时通过<code class="du md me mf lo b">--template-parameter</code>或<code class="du md me mf lo b">-tp</code>传递数值</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="cdda" class="ls kh hi lo b fi lt lu l lv lw">dotnet lambda deploy-serverless $STACK -tp "MyTPEnv=$VALUE;"</span></pre><h1 id="370a" class="kg kh hi bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">结论</h1><p id="a1cd" class="pw-post-body-paragraph im in hi io b ip le ir is it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj hb bi translated">在我看来，AWS SAM是一个很好的云托管解决方案。NET开发人员。它既便宜又好用。</p></div></div>    
</body>
</html>