<html>
<head>
<title>Mysql table to aws S3 as parquet file and querying using aws athena</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Mysql表到aws S3作为拼花文件和使用aws雅典娜查询</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/mysql-table-to-aws-s3-as-parquet-file-and-querying-using-aws-athena-bfaa809d2f53?source=collection_archive---------2-----------------------#2020-02-18">https://medium.com/geekculture/mysql-table-to-aws-s3-as-parquet-file-and-querying-using-aws-athena-bfaa809d2f53?source=collection_archive---------2-----------------------#2020-02-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/></div><div class="ab cl if ig gp ih" role="separator"><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik"/></div><div class="hb hc hd he hf"><figure class="in io ip iq fd ir er es paragraph-image"><div role="button" tabindex="0" class="is it di iu bf iv"><div class="er es im"><img src="../Images/0d03568e3ebb5ba4da3db4a0ac53b7e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y9rN9LBOp3fDp_LyuJWiKQ.jpeg"/></div></div><figcaption class="iy iz et er es ja jb bd b be z dx">Photo by <a class="ae jc" href="https://unsplash.com/@lukechesser?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Luke Chesser</a> on <a class="ae jc" href="https://unsplash.com/s/photos/graphs?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="fc96" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">对于分析大数据集和制作报告来说，mysql并不是一个自然的选择，因为它的架构。由于数据在mysql中是以基于行的格式存储的，所以聚合和分组等常用函数在大型数据集上可能表现不佳。</p><p id="f6e1" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">像Apache parquet(<a class="ae jc" href="https://parquet.apache.org/" rel="noopener ugc nofollow" target="_blank">https://parquet.apache.org</a>/)这样的柱状存储系统来拯救我们了。但接下来的问题是，我们如何像sql一样使用基于文件的系统进行查询和报告。幸运的是，aws S3和雅典娜在这种情况下非常有用。</p><h1 id="9458" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated"><strong class="ak">架构</strong></h1><figure class="in io ip iq fd ir er es paragraph-image"><div role="button" tabindex="0" class="is it di iu bf iv"><div class="er es kz"><img src="../Images/c03cafcb4cb4eccd1b936428d22fed0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H3t9fO05uXOAOB-GYEFQ0g.jpeg"/></div></div><figcaption class="iy iz et er es ja jb bd b be z dx">figure 1: Transfer data from mysql to s3 as parquet file and build a querying engine with athena</figcaption></figure><p id="6cd0" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">在这里，我使用python、sqlalchemy、pandas和pyarrow来完成这项任务</p><p id="c60a" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我已经有了要运行的查询，因为我已经在django rest-framework中构建了一个元数据库类型的应用程序。现在，在查询之后，我希望将数据存储为一个parquet文件以供进一步处理，我没有显示查询构建器代码。</p><p id="c809" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">现在我有了要在下面代码中的<code class="du la lb lc ld b">sql_quey</code>中运行的查询，引擎是sqlalchemy连接。</p><figure class="in io ip iq fd ir"><div class="bz dy l di"><div class="le lf l"/></div></figure><p id="e93f" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">这里，organisation _ id和report.id是S3位置的两个唯一标识符。</p><pre class="in io ip iq fd lg ld lh li aw lj bi"><span id="16c8" class="lk kc hi ld b fi ll lm l ln lo">table = pa.Table.from_pandas(df,preserve_index=False)</span></pre><p id="c56d" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">上面的代码行将创建用于创建athena表的数据类型，但是我们仍然需要对它进行一些小的正则表达式处理来修复一些问题。</p><p id="8283" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><code class="du la lb lc ld b">create_athena_database</code>、<code class="du la lb lc ld b">drop_athena_table</code>、<code class="du la lb lc ld b">create_athena_table</code>的功能如下</p><figure class="in io ip iq fd ir"><div class="bz dy l di"><div class="le lf l"/></div></figure><p id="7366" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">因此，使用从查询中获得的数据类型，我们将使用<code class="du la lb lc ld b">create_athena_table</code>函数在athena中创建一个表，这样athena就可以读取变量<code class="du la lb lc ld b">s3_url</code>中的parquet文件。</p><p id="8108" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">与S3的连接是使用sqlalchemy完成的。如果查询发生变化，我不会修改表，而是使用drop table并创建一个新的表定义。</p></div></div>    
</body>
</html>