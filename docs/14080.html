<html>
<head>
<title>AWS Cross Account User Pool Migration — Seamless login</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS跨帐户用户池迁移—无缝登录</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/aws-cross-account-user-pool-migration-seamless-login-2002b5c726d2?source=collection_archive---------6-----------------------#2022-08-14">https://medium.com/geekculture/aws-cross-account-user-pool-migration-seamless-login-2002b5c726d2?source=collection_archive---------6-----------------------#2022-08-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/106ddb133037363768e673dea7b2fef2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*jmE6dtRSeiIUS3JR.png"/></div></div></figure><p id="9f7b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">AWS引入了两种方法将现有的cognito用户池迁移到新的用户池</p><ol class=""><li id="3fd3" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">使用用户迁移Lambda触发器将用户导入用户池(无缝用户迁移)</li><li id="70f1" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">将用户从CSV文件导入用户池</li></ol><p id="e28c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在第一种方法中，我们可以通过触发用户迁移lambda触发器，在用户首次登录时将用户迁移到新用户池。在这种方法中，用户可以使用用于登录旧用户池的相同的现有用户密码。登录和忘记密码都会触发迁移Lambda触发器。这是一个无缝的用户迁移。</p><p id="3b2d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在第二种方法中，我们可以通过上传包含所有用户的用户配置文件属性的CSV文件来批量迁移用户。在这种方法中，用户必须在首次登录时重置密码。</p><p id="e8d0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">本文将详细讨论第一种方法。</p><p id="1deb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">用户迁移lambda的基本场景是，它将承担旧用户池帐户中的角色，以便使用旧用户池对用户进行身份验证。</p><p id="4d60" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">用户迁移lambda的基本场景是，它将承担旧用户池帐户中的角色，以便使用旧用户池对用户进行身份验证。</p><ol class=""><li id="2bfd" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">用户尝试登录或验证新用户池</li><li id="f2d3" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">如果在新用户池中找不到用户，将触发用户迁移lambda函数</li><li id="762e" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">用户迁移lambda函数承担旧用户池帐户中的角色</li><li id="ee21" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">用户迁移lambda函数使用交叉帐户承担角色对旧用户池中的用户进行身份验证，并获取用户的属性。</li><li id="7ca7" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">成功通过身份验证的用户被迁移到新用户池</li></ol><blockquote class="kc kd ke"><p id="9100" class="iq ir kf is b it iu iv iw ix iy iz ja kg jc jd je kh jg jh ji ki jk jl jm jn hb bi translated"><strong class="is hj">先决条件:</strong></p></blockquote><p id="eb6f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">需要有一个使用<strong class="is hj">AWS CognitoIdentityServiceProvider</strong><strong class="is hj"><em class="kf">adminInitiateAuth</em></strong>或<strong class="is hj"> <em class="kf"> initiateAuth </em> </strong>的登录方法。当在用户池中找不到用户时，这两种登录方法将触发迁移lambda功能。</p><p id="6951" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">例如:-</p><figure class="kj kk kl km fd ij"><div class="bz dy l di"><div class="kn ko l"/></div><figcaption class="kp kq et er es kr ks bd b be z dx">adminInitiateAuth.js</figcaption></figure><p id="847a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">或者</p><figure class="kj kk kl km fd ij"><div class="bz dy l di"><div class="kn ko l"/></div><figcaption class="kp kq et er es kr ks bd b be z dx">initiateAuth.js</figcaption></figure><p id="ddcc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du kt ku kv kw b"><em class="kf">AdminInitiateAuth</em></code>支持以下认证流程:</p><ul class=""><li id="129b" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn kx ju jv jw bi translated">用户_服务请求_授权</li><li id="66b3" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn kx ju jv jw bi translated">刷新令牌身份验证</li><li id="5e7b" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn kx ju jv jw bi translated">自定义身份验证</li><li id="d070" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn kx ju jv jw bi translated">管理_无_服务_授权</li><li id="bbed" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn kx ju jv jw bi translated">用户密码认证</li></ul><p id="2a40" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du kt ku kv kw b"><em class="kf">InitiateAuth</em></code>支持以下认证流程:</p><ul class=""><li id="20cf" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn kx ju jv jw bi translated">用户_服务请求_授权</li><li id="8a7a" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn kx ju jv jw bi translated">刷新令牌身份验证</li><li id="a2af" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn kx ju jv jw bi translated">用户密码认证</li><li id="6b1c" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn kx ju jv jw bi translated">自定义身份验证</li></ul><blockquote class="kc kd ke"><p id="90bf" class="iq ir kf is b it iu iv iw ix iy iz ja kg jc jd je kh jg jh ji ki jk jl jm jn hb bi translated"><strong class="is hj">配置:</strong></p></blockquote><p id="7a79" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在整个配置中，将使用以下符号:</p><p id="3932" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">“旧用户池”—用户从中迁移的现有用户池，也是AWS帐户11111111111中的源用户池</p><p id="2402" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">“新用户池”——用户将迁移到的新用户池，也是AWS帐户2222222222中的目标用户池</p><p id="5955" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">旧用户池配置:</strong></p><p id="0a98" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="kf">第一步</em> </strong> <em class="kf"> : </em></p><p id="6887" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为管理API启用用户名密码验证以进行验证(ALLOW_ADMIN_USER_PASSWORD_AUTH)。这使得程序化的用户认证更加容易。用户迁移后应禁用此选项，以强制执行不通过网络发送密码的安全SRP流。</p><ol class=""><li id="e602" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">登录Cognito用户池控制台，在左侧导航菜单中，单击“App Clients”。</li><li id="e2b9" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">在应用程序客户端页面上，单击将用于验证用户的应用程序客户端的“显示详细信息”按钮。</li><li id="62bd" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">确保选择了“为管理API启用用户名密码验证以进行验证(ALLOW_ADMIN_USER_PASSWORD_AUTH)”选项。</li><li id="464c" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">如果进行了任何更改，保存应用程序客户端更改。</li></ol><p id="c872" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">或者，我们可以使用CLI命令:</p><p id="b10e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"><em class="kf">$ AWS cogn ITO-IDP update-USER-pool-client-USER-pool-id&lt;value&gt;-client-id&lt;value&gt;-explicit-AUTH-flows ALLOW _ ADMIN _ USER _ PASSWORD _ AUTH</em></strong></p><p id="3686" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="kf">第二步</em> </strong> <em class="kf"> : </em></p><p id="72ae" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建一个可以用来对现有用户进行身份验证的角色。</p><ol class=""><li id="9e99" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">登录IAM控制台，在左侧导航菜单中选择“角色”,然后选择“创建角色”。</li><li id="de47" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">选择“另一个AWS帐户”角色类型。</li><li id="ff8c" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">对于帐户ID，键入新的用户池帐户ID。在这种背景下，会是22222222222。</li><li id="0148" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">选择“下一页”按钮，浏览下一页，直至查看页面。</li><li id="610a" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">在“审阅”页面上，添加角色名称。对于本指南，它将是“CognitoCrossAccountMigrationRole”。</li><li id="1fb6" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">选择“创建角色”。</li><li id="b606" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">一旦创建了角色，就授予角色进行API调用的权限— <em class="kf"> adminInitiateAuth </em>和<em class="kf"> adminGetUser </em>。为此，请使用以下策略向该角色添加内联策略:</li></ol><pre class="kj kk kl km fd ky kw kz la aw lb bi"><span id="7a09" class="lc ld hi kw b fi le lf l lg lh">{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Sid": "VisualEditor0",<br/>            "Effect": "Allow",<br/>            "Action": [<br/>                "cognito-idp:AdminInitiateAuth",<br/>                "cognito-idp:AdminGetUser"<br/>            ],<br/>            "Resource": "*"<br/>        }<br/>    ]<br/>}</span></pre><p id="65b8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为简单起见，该策略允许API调用所有资源。我们可以通过指定旧用户池ARN来限制旧用户池的资源。或者，我们还可以将角色的信任策略主体限制为新用户池的执行角色ARN。</p><p id="9f24" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">新用户池配置:</strong></p><p id="6a3f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="kf">第一步:</em> </strong></p><p id="6f34" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">启用基于用户名和密码的身份验证(ALLOW_USER_PASSWORD_AUTH)。这一步是将用户密码传递给触发的Lambda函数所必需的，以便可以使用用户身份验证凭证对旧用户池进行身份验证，在本例中，旧用户池是帐户11111111111中的旧用户池。</p><p id="819d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">迁移后，建议禁用ALLOW_USER_PASSWORD_AUTH选项，以便验证用户的唯一选项是不通过网络发送密码的安全SRP流..</p><ol class=""><li id="abf0" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">登录Cognito用户池控制台，在左侧导航菜单中，单击“App Clients”。</li><li id="67bf" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">在应用程序客户端页面上，单击将用于验证用户的应用程序客户端的“显示详细信息”按钮。</li><li id="520c" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">确保选择了“启用基于用户名和密码的身份验证(ALLOW_USER_PASSWORD_AUTH)”选项。</li><li id="4432" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">如果进行了任何更改，保存应用程序客户端更改。</li></ol><p id="c555" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">或者，我们可以使用CLI命令:</p><p id="51c4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"><em class="kf">$ AWS cogn ITO-IDP update-USER-pool-client-USER-pool-id&lt;value&gt;-client-id&lt;value&gt;-explicit-AUTH-flows ALLOW _ USER _ PASSWORD _ AUTH</em>T3】</strong></p><p id="e922" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="kf">第二步:</em> </strong></p><p id="26ed" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建用户迁移Lambda函数，该函数将承担旧用户池帐户中的角色并迁移用户属性。</p><ol class=""><li id="b574" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">登录Lambda控制台，在左侧导航菜单中，单击“功能”。</li><li id="71d4" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">点击“创建功能”按钮创建一个新功能</li><li id="2af0" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">在create function页面上，选择“Author from scratch ”,在Basic information部分下，给它一个函数名，并选择Node.js 16.x作为运行时。我们假设函数名为“migrationLambdaFunction”。然后点击“创建功能”按钮。</li><li id="30ee" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">在Lambda函数的“代码”选项卡上，将默认函数代码替换为以下代码:</li></ol><p id="ae4d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">总之，代码需要UserMigration_Authentication触发源的用户名和密码，或者UserMigration_ForgotPassword触发源的用户名。返回有效用户的属性。这些属性用于迁移用户。</p><figure class="kj kk kl km fd ij"><div class="bz dy l di"><div class="kn ko l"/></div><figcaption class="kp kq et er es kr ks bd b be z dx">index.js</figcaption></figure><figure class="kj kk kl km fd ij"><div class="bz dy l di"><div class="kn ko l"/></div><figcaption class="kp kq et er es kr ks bd b be z dx">createNewUser.js</figcaption></figure><p id="13ab" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">注意:如果你的app客户端有秘密，请使用“<a class="ae li" href="https://github.com/shamilasallay/aws-cross-account-userpool-migration/tree/main/withAppClientSecret" rel="noopener ugc nofollow" target="_blank"> withAppClientSecret </a>”中附带的Lambda函数来代替。</p><p id="f684" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">5.用有效值替换以下值:</p><blockquote class="kc kd ke"><p id="767f" class="iq ir kf is b it iu iv iw ix iy iz ja kg jc jd je kh jg jh ji ki jk jl jm jn hb bi translated"><strong class="is hj">role arn</strong>’—将采用我们之前设置的旧用户池帐户角色ARN。例如:-arn:AWS:iam::11111111111:role/cognotocrossactionmigrationrole</p><p id="b6c5" class="iq ir kf is b it iu iv iw ix iy iz ja kg jc jd je kh jg jh ji ki jk jl jm jn hb bi translated"><strong class="is hj">区域</strong>’—旧用户池区域。例如:-'美国东部-1 '</p><p id="3c93" class="iq ir kf is b it iu iv iw ix iy iz ja kg jc jd je kh jg jh ji ki jk jl jm jn hb bi translated"><strong class="is hj">用户池ID</strong>’—旧用户池id。例如:-'美国东部-1 _示例'</p><p id="0b58" class="iq ir kf is b it iu iv iw ix iy iz ja kg jc jd je kh jg jh ji ki jk jl jm jn hb bi translated"><strong class="is hj">app clientID</strong>’—旧用户池app客户端id。例如:-' t 8 pkkgexmapleq 1t 1 vex sampler '</p><p id="717c" class="iq ir kf is b it iu iv iw ix iy iz ja kg jc jd je kh jg jh ji ki jk jl jm jn hb bi translated"><strong class="is hj">LAMBDAROLEARN</strong>’—migration lambda function角色的角色ARN。例如:-arn:AWS:iam::<em class="hi">222222222222</em>:角色/服务-角色/迁移LambdaFunction-role-gbcihgtr</p><p id="6a56" class="iq ir kf is b it iu iv iw ix iy iz ja kg jc jd je kh jg jh ji ki jk jl jm jn hb bi translated"><strong class="is hj">'<em class="hi">λrole</em>'</strong>-migrationλfunction角色的角色名称。例如:-migrationLambdaFunction-role-gbcihgtr</p><p id="af7d" class="iq ir kf is b it iu iv iw ix iy iz ja kg jc jd je kh jg jh ji ki jk jl jm jn hb bi translated"><strong class="is hj">'<em class="hi">DESTINATIONUSERPOOLID</em>'</strong>-新用户池ID。例如:-'美国东部-1_fgythsng '</p></blockquote><p id="adad" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">6.点击“部署”</p><p id="2ae3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">7.授予Lambda函数执行角色权限，以承担旧用户池帐户中的角色。lambda执行角色可以通过导航到“Permissions”选项卡找到(新控制台中的<em class="kf">:配置&gt;权限</em>)。角色名称位于“权限”选项卡的“执行角色”部分。单击角色名称直接转到IAM控制台上的角色设置，并向该角色添加内联策略以承担跨帐户迁移角色:</p><pre class="kj kk kl km fd ky kw kz la aw lb bi"><span id="75b7" class="lc ld hi kw b fi le lf l lg lh">{<br/>"Version": "2012-10-17",<br/>"Statement": [<br/>    { <br/>       "Sid": "PermissionToAssumeRole",<br/>       "Effect": "Allow",<br/>       "Action": "sts:AssumeRole",<br/>       "Resource":    "arn:aws:iam::111111111111:role/CognitoCrossAccountMigrationRole"</span><span id="ff82" class="lc ld hi kw b fi lj lf l lg lh">    }<br/>  ]<br/>}</span></pre><p id="19c6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建另一个内联策略来授予cognito权限:</p><pre class="kj kk kl km fd ky kw kz la aw lb bi"><span id="b9cd" class="lc ld hi kw b fi le lf l lg lh">{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Sid": "VisualEditor0",<br/>            "Effect": "Allow",<br/>            "Action": [<br/>                "cognito-idp:AdminCreateUser",<br/>                "cognito-idp:AdminSetUserPassword"<br/>            ],<br/>            "Resource": "*"<br/>        }<br/>    ]<br/>}</span></pre><p id="69fb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后，允许lambda信任策略主体承担lambda角色。</p><pre class="kj kk kl km fd ky kw kz la aw lb bi"><span id="fc1e" class="lc ld hi kw b fi le lf l lg lh">{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Effect": "Allow",<br/>            "Principal": {<br/>                "AWS": "arn:aws:iam::222222222222:role/service-role/migrationLambdaFunction-role-gbcihgtr",<br/>                "Service": "lambda.amazonaws.com"<br/>            },<br/>            "Action": "sts:AssumeRole"<br/>        }<br/>    ]<br/>}</span></pre><p id="f901" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">确保将策略中的资源替换为具有正确AWS帐户ID的正确角色ARN。</p><p id="a845" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="kf">第三步:</em> </strong></p><p id="2022" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在用户迁移触发器选项中设置Lambda函数</p><ol class=""><li id="3650" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">登录Cognito用户池控制台，在左侧导航菜单中，单击“Triggers”。</li><li id="4d22" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">在触发器页面上，将“用户迁移”设置为刚刚在新用户池帐户中创建的Lambda函数。在这个例子中，它被命名为<strong class="is hj"><em class="kf">migration lambda function</em></strong>。</li></ol><p id="54cd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">注意:如果没有找到创建的lambda函数，请确保创建的lambda函数与新用户池位于同一区域。您可能还想重新加载触发器页面。</p><p id="1267" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.保存更改。</p><blockquote class="kc kd ke"><p id="04df" class="iq ir kf is b it iu iv iw ix iy iz ja kg jc jd je kh jg jh ji ki jk jl jm jn hb bi translated"><strong class="is hj"> <em class="hi">注</em> </strong></p></blockquote><ol class=""><li id="b6f5" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">在无缝用户迁移中，确保用户不会收到任何电子邮件邀请或电子邮件或手机号码的验证码非常重要。因此，MessageAction被设置为<strong class="is hj"> <em class="kf"> SUPPRESS </em> </strong>，如果在cognito用户池中启用了验证，则需要将其移除。在新用户池中转至cognito用户池，在左侧导航菜单中单击<strong class="is hj"> MFA和验证</strong> <em class="kf"> </em>，并在<strong class="is hj">中选择<strong class="is hj"> <em class="kf">无验证</em> </strong>您要验证哪些属性？</strong></li><li id="0f36" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">在新用户池中选择App客户端安全配置中的<strong class="is hj"> <em class="kf">遗留</em> </strong>当登录函数返回<em class="kf"> UserNotFound </em>错误时触发用户迁移Lambda</li></ol><p id="4b93" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这些配置需要在用户迁移期后回滚。</p><p id="1de5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">github repo:—<a class="ae li" href="https://github.com/shamilasallay/aws-cross-account-userpool-migration" rel="noopener ugc nofollow" target="_blank">https://github . com/shamilasallay/AWS-cross-account-user pool-migration</a></p></div></div>    
</body>
</html>