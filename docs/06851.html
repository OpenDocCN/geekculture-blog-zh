<html>
<head>
<title>Set up a TimescaleDB hypertable with Prisma</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Prisma设置时间刻度超表</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/set-up-a-timescaledb-hypertable-with-prisma-9550652cfe97?source=collection_archive---------9-----------------------#2021-08-31">https://medium.com/geekculture/set-up-a-timescaledb-hypertable-with-prisma-9550652cfe97?source=collection_archive---------9-----------------------#2021-08-31</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/e94d993a675c367b8ed86800da930192.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zAjgvwtI0_tzEO0mckbrMA.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Photo by <a class="ae iu" href="https://unsplash.com/@groove328?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Andrey Novik</a> on <a class="ae iu" href="https://unsplash.com/s/photos/prisma?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="5f1e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一个月前，我试图在NodeJS + <a class="ae iu" href="https://www.prisma.io/" rel="noopener ugc nofollow" target="_blank"> Prisma </a>上设置TimescaleDB。在TimescaleDB <a class="ae iu" href="https://docs.timescale.com/timescaledb/latest/quick-start/node/" rel="noopener ugc nofollow" target="_blank"> site </a>上有一个教程，但是它使用了我不喜欢的类型。然后我发现了这个<a class="ae iu" href="https://gist.github.com/janpio/2a425f22673f2de54469772f16af8118" rel="noopener ugc nofollow" target="_blank">指南</a>，它非常有帮助，但是我发现了一些小错误。我花了一整天。我终于创建了一个超表。<br/>今天，我试图再次创建一个超表格，我的时间被错误占满了。在我把它们整理好之后。我刚刚意识到我事先知道所有的陷阱，但是我把它们都忘了！所以我决定写这篇教程。</p></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><h1 id="28ce" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">警告</h1><blockquote class="ky kz la"><p id="532a" class="iv iw lb ix b iy iz ja jb jc jd je jf lc jh ji jj ld jl jm jn le jp jq jr js hb bi translated">据Prisma的工程主管Jan Piotrowski所说，“Prisma不正式支持TimescaleDB，这些非常手动的步骤使它工作，但是当然仍然存在不相关的事情出错的危险。”</p></blockquote><ol class=""><li id="74ad" class="lf lg hi ix b iy iz jc jd jg lh jk li jo lj js lk ll lm ln bi translated">在PostgresSQL和TimescaleDB上，<code class="du lo lp lq lr b">""</code>(双引号)内的任何内容都<em class="lb">区分大小写</em>，而<code class="du lo lp lq lr b">''</code>(单引号)内的任何内容都被认为<em class="lb">转换成小写</em>。</li><li id="ced4" class="lf lg hi ix b iy ls jc lt jg lu jk lv jo lw js lk ll lm ln bi translated">当你用<code class="du lo lp lq lr b">SELECT create_hypertable('[table]', '[field]');</code>命令创建一个超表时，它会创建一个索引，如果一个索引已经存在，创建失败。<em class="lb"> [ </em> <a class="ae iu" href="https://stackoverflow.com/questions/61205063/error-cannot-create-a-unique-index-without-the-column-date-time-used-in-part" rel="noopener ugc nofollow" target="_blank"> <em class="lb">来源</em> </a> <em class="lb"> ] </em> <br/>所以先删除索引，然后创建唯一键，因为Prisma至少需要一个唯一键或索引，然后创建一个超表。</li><li id="30bf" class="lf lg hi ix b iy ls jc lt jg lu jk lv jo lw js lk ll lm ln bi translated">据我所知，<code class="du lo lp lq lr b">SELECT create_hypertable('[table]', '[field]');</code> <em class="lb"> </em>命令接受表名作为<em class="lb">区分大小写</em> e，但不接受字段名。请考虑用小写字母命名要用作超表键的字段名。</li></ol></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><h1 id="5697" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">辅导的</h1><p id="a9e5" class="pw-post-body-paragraph iv iw hi ix b iy lx ja jb jc ly je jf jg lz ji jj jk ma jm jn jo mb jq jr js hb bi translated"><strong class="ix hj"> 1 </strong>。初始化NodeJS项目并安装prisma。</p><pre class="mc md me mf fd mg lr mh mi aw mj bi"><span id="c32d" class="mk kb hi lr b fi ml mm l mn mo">mkdir timescale-prisma &amp;&amp; cd timescale-prisma</span><span id="af58" class="mk kb hi lr b fi mp mm l mn mo">npm init -y</span><span id="1bf3" class="mk kb hi lr b fi mp mm l mn mo">npm install prisma typescript ts-node @types/node --save-dev</span></pre><p id="93e0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> 2 </strong>。<strong class="ix hj"> </strong>创建Prisma模式。</p><pre class="mc md me mf fd mg lr mh mi aw mj bi"><span id="ed56" class="mk kb hi lr b fi ml mm l mn mo">npx prisma init</span></pre><p id="977f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这个命令创建了一个名为<em class="lb"> prisma </em>的新目录，其中包含一个名为<code class="du lo lp lq lr b">schema.prisma</code>的文件和一个位于项目根目录下的<code class="du lo lp lq lr b">.env</code>文件。</p><p id="73fa" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> 3 </strong>。编辑<code class="du lo lp lq lr b">.env</code>文件以指向您的数据库。</p><pre class="mc md me mf fd mg lr mh mi aw mj bi"><span id="056a" class="mk kb hi lr b fi ml mm l mn mo">DATABASE_URL=”postgresql://johndoe:randompassword@localhost:5432/mydb”</span></pre><p id="2d14" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">以上是:</p><ul class=""><li id="b51c" class="lf lg hi ix b iy iz jc jd jg lh jk li jo lj js mq ll lm ln bi translated">用户名— <code class="du lo lp lq lr b">johndoe</code></li><li id="eb54" class="lf lg hi ix b iy ls jc lt jg lu jk lv jo lw js mq ll lm ln bi translated">密码— <code class="du lo lp lq lr b">randompassword</code></li><li id="d42e" class="lf lg hi ix b iy ls jc lt jg lu jk lv jo lw js mq ll lm ln bi translated">主机URL — <code class="du lo lp lq lr b"> localhost</code></li><li id="a046" class="lf lg hi ix b iy ls jc lt jg lu jk lv jo lw js mq ll lm ln bi translated">港口— <code class="du lo lp lq lr b">5432</code>(默认)</li><li id="e250" class="lf lg hi ix b iy ls jc lt jg lu jk lv jo lw js mq ll lm ln bi translated">数据库名称— <code class="du lo lp lq lr b">mydb</code></li></ul><p id="6d5e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> 4 </strong>。然后编辑<code class="du lo lp lq lr b">schema.prisma</code>。它可能看起来像下面。</p><pre class="mc md me mf fd mg lr mh mi aw mj bi"><span id="ba10" class="mk kb hi lr b fi ml mm l mn mo">datasource db {<br/>  provider = "postgresql"<br/>  url      = env("DATABASE_URL")<br/>}</span><span id="d382" class="mk kb hi lr b fi mp mm l mn mo">model Node {<br/>  id        Int      <em class="lb">@id @default</em>(autoincrement())<em class="lb"><br/>  </em>nodeName  String<br/><br/>  log       Log[]<br/>}<br/>model Log {<br/>  id           Int      <em class="lb">@id @default</em>(autoincrement())<em class="lb"><br/>  </em>loggedAt     DateTime <em class="lb">@default</em>(now())<br/>  temperature  Float<br/><br/>  node         Node     <em class="lb">@relation</em>(fields: [nodeId], references: [id])<br/>  nodeId       Int<br/>}</span></pre><p id="cff9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你需要稍微修改一下。</p><pre class="mc md me mf fd mg lr mh mi aw mj bi"><span id="9f3c" class="mk kb hi lr b fi ml mm l mn mo">datasource db {<br/>  provider = "postgresql"<br/>  url      = env("DATABASE_URL")<br/>}</span><span id="83ef" class="mk kb hi lr b fi mp mm l mn mo">model Node {<br/>  id        Int      @id <em class="lb">@default</em>(autoincrement())<em class="lb"><br/>  </em>nodeName  String<br/><br/>  log       Log[]<br/>}<br/>model Log {<br/>  id           Int      <em class="lb">@default</em>(autoincrement())<em class="lb"><br/>  </em>logged_at    DateTime <em class="lb">@default</em>(now())<br/>  temperature  Float<br/><br/>  node         Node     <em class="lb">@relation</em>(fields: [nodeId], references: [id])<br/>  nodeId       Int</span><span id="03b2" class="mk kb hi lr b fi mp mm l mn mo"><em class="lb">  @@unique</em>([id,  logged_at])<br/>}</span></pre><p id="688d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">按照说明，我将<code class="du lo lp lq lr b">loggedAt</code>字段重命名为<code class="du lo lp lq lr b">logged_at</code>，并将<code class="du lo lp lq lr b">@id</code>从<code class="du lo lp lq lr b">Log</code>、<br/>的<code class="du lo lp lq lr b">id</code>字段中移除，然后添加<code class="du lo lp lq lr b"><em class="lb">@@unique</em>([id, logged_at])</code>作为唯一键。</p><blockquote class="ky kz la"><p id="92bd" class="iv iw lb ix b iy iz ja jb jc jd je jf lc jh ji jj ld jl jm jn le jp jq jr js hb bi translated">我之所以将<code class="du lo lp lq lr b">id</code>和<code class="du lo lp lq lr b">logged_at</code>组合在一起，是因为我不认为只有时间戳是唯一的，因为来自其他节点的数据可能同时到达</p></blockquote><p id="eeaa" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> 5 </strong>。通过迁移生成<code class="du lo lp lq lr b">.sql</code>文件；<code class="du lo lp lq lr b">--create-only</code>表示您还不想对数据库进行更改。</p><pre class="mc md me mf fd mg lr mh mi aw mj bi"><span id="6a6c" class="mk kb hi lr b fi ml mm l mn mo">npx prisma migrate dev --create-only</span></pre><p id="1906" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">提示符将要求输入迁移名称，您可以键入任何名称。在这种情况下，我输入<em class="lb"> init。</em></p><pre class="mc md me mf fd mg lr mh mi aw mj bi"><span id="74bd" class="mk kb hi lr b fi ml mm l mn mo">$ <strong class="lr hj">npx prisma migrate dev --create-only</strong><br/>Environment variables loaded from .env<br/>Prisma schema loaded from db\schema.prisma<br/>Datasource “db”: PostgreSQL database “mydb”, schema “public” at “localhost:5432”</span><span id="cbdb" class="mk kb hi lr b fi mp mm l mn mo">√ Enter a name for the new migration: … <strong class="lr hj">init</strong><br/>Prisma Migrate created the following migration without applying it 20210831083903_init</span></pre><p id="d7d8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你会在<code class="du lo lp lq lr b">Prisma/migrations/</code>下的<code class="du lo lp lq lr b">20210831083903_init</code>文件夹中看到<code class="du lo lp lq lr b">migration.sql</code>。</p><pre class="mc md me mf fd mg lr mh mi aw mj bi"><span id="b855" class="mk kb hi lr b fi ml mm l mn mo">-- CreateTable<br/>CREATE TABLE "Node" (<br/>    "id" SERIAL NOT NULL,<br/>    "nodeName" TEXT NOT NULL,<br/><br/>    PRIMARY KEY ("id")<br/>);<br/><br/>-- CreateTable<br/>CREATE TABLE "Log" (<br/>    "id" SERIAL NOT NULL,<br/>    "logged_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,<br/>    "temperature" DOUBLE PRECISION NOT NULL,<br/>);<br/><br/>-- CreateIndex<br/>CREATE UNIQUE INDEX "Log.id_logged_at_unique" ON "Log"("id", "logged_at");<br/><br/>-- AddForeignKey<br/>ALTER TABLE "Log" ADD FOREIGN KEY ("nodeId") REFERENCES "Node"("id") ON DELETE CASCADE ON UPDATE CASCADE;</span></pre><p id="824d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> 5。</strong>在第一行插入<code class="du lo lp lq lr b">CREATE EXTENSION IF NOT EXISTS timescaledb CASCADE; </code>以确保安装了TimescaleDB扩展。<br/>在最后一行添加<code class="du lo lp lq lr b">SELECT create_hypertable('"Log"', 'logged_at');</code>，在<code class="du lo lp lq lr b">Log</code>表上创建超表。</p><p id="982a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">注1 </strong>:如果你的表名包含大写字母，你需要把它们放在<code class="du lo lp lq lr b">""</code>之间，如上所述，但是如果你的表名是<code class="du lo lp lq lr b">log</code>，命令将是<code class="du lo lp lq lr b">SELECT create_hypertable('log', 'logged_at');</code>。<br/> <strong class="ix hj">注2: </strong>看来我们用来创建超表的字段必须是<code class="du lo lp lq lr b">lower case</code>。因为我已经试过了<code class="du lo lp lq lr b">SELECT create_hypertable('"Log"', '"loggedAt"')</code>但是出错了。</p><p id="106f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最后，你的<code class="du lo lp lq lr b">migration.sql</code>看起来会像:</p><pre class="mc md me mf fd mg lr mh mi aw mj bi"><span id="951c" class="mk kb hi lr b fi ml mm l mn mo">CREATE EXTENSION IF NOT EXISTS timescaledb CASCADE;<br/>-- CreateTable<br/>CREATE TABLE "Node" (<br/>    "id" SERIAL NOT NULL,<br/>    "nodeName" TEXT NOT NULL,<br/><br/>    PRIMARY KEY ("id")<br/>);<br/><br/>-- CreateTable<br/>CREATE TABLE "Log" (<br/>    "id" SERIAL NOT NULL,<br/>    "logged_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,<br/>    "temperature" DOUBLE PRECISION NOT NULL,<br/>);<br/><br/>-- CreateIndex<br/>CREATE UNIQUE INDEX "Log.id_logged_at_unique" ON "Log"("id", "logged_at");<br/><br/>-- AddForeignKey<br/>ALTER TABLE "Log" ADD FOREIGN KEY ("nodeId") REFERENCES "Node"("id") ON DELETE CASCADE ON UPDATE CASCADE;</span><span id="45d6" class="mk kb hi lr b fi mp mm l mn mo">SELECT create_hypertable('"Log"', 'logged_at');</span></pre><p id="6f1d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> 6 </strong>。然后对数据库应用sql命令。</p><pre class="mc md me mf fd mg lr mh mi aw mj bi"><span id="eb71" class="mk kb hi lr b fi ml mm l mn mo">npx prisma migrate dev</span></pre><p id="5cca" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">提示会再次询问迁移名称，我输入<em class="lb"> hypertable </em>。</p><pre class="mc md me mf fd mg lr mh mi aw mj bi"><span id="17cf" class="mk kb hi lr b fi ml mm l mn mo">$ <strong class="lr hj">npx prisma migrate dev</strong><br/>Environment variables loaded from .env<br/>Prisma schema loaded from db\schema.prisma<br/>Datasource “db”: PostgreSQL database “mydb”, schema “public” at “localhost:5432”</span><span id="44e8" class="mk kb hi lr b fi mp mm l mn mo">The following migration(s) have been applied:</span><span id="b0db" class="mk kb hi lr b fi mp mm l mn mo">migrations/<br/> └─ 20210831083903_hypertable/<br/> └─ migration.sql<br/>√ Enter a name for the new migration: …<strong class="lr hj">hypertable</strong></span><span id="dc1c" class="mk kb hi lr b fi mp mm l mn mo">The following migration(s) have been created and applied from new schema changes:</span><span id="1edf" class="mk kb hi lr b fi mp mm l mn mo">migrations/<br/> └─ 20210831083958_hypertable/<br/> └─ migration.sql</span><span id="0738" class="mk kb hi lr b fi mp mm l mn mo">Your database is now in sync with your schema.</span><span id="5716" class="mk kb hi lr b fi mp mm l mn mo">✔ Generated Prisma Client (2.30.2) to .\node_modules\<a class="ae iu" href="http://twitter.com/prisma" rel="noopener ugc nofollow" target="_blank">@prisma</a>\client in 181ms</span></pre><p id="8291" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">搞定了。现在您的超表格已经准备好了。请参见TimescaleDB <a class="ae iu" href="https://docs.timescale.com/timescaledb/latest/quick-start/node/#insert_rows" rel="noopener ugc nofollow" target="_blank">文档</a>如何向其中插入行并执行查询。</p></div></div>    
</body>
</html>