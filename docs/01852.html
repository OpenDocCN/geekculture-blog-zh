<html>
<head>
<title>React Proxied via Lambda</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过Lambda代理反应</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/react-proxied-via-lambda-785bf44a20b3?source=collection_archive---------15-----------------------#2021-04-26">https://medium.com/geekculture/react-proxied-via-lambda-785bf44a20b3?source=collection_archive---------15-----------------------#2021-04-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/fa84b9873b2e8159e0adb1ee12acfa02.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*eTutHgSMCE5B6U1oqU9BsQ.png"/></div></figure><h1 id="de2f" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">概观</h1><p id="1c5c" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">React与Angular和Vue等许多其他框架一样，似乎在为web开发的未来铺平道路。使用普通CSS的静态HTML的时代已经一去不复返了，取而代之的是在网站第一次加载时就加载整个网站。这增强了用户体验，实现了页面之间的快速转换，导入了覆盖大量前端难题的自定义库，并引入了复杂的逻辑。React是令人兴奋的，它允许有框架经验的开发人员更容易地进行创新。</p><p id="690b" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">现在让我们假设你的好奇心达到了顶点，你已经制作了一个本地网站，并准备发布，那么下一步该怎么做呢？特别关注React，该框架将创建应用程序的优化生产版本，通常调用yarn build。然后你可以将它部署在各种网络托管服务上，比如Github pages、Netlify和S3等等。</p><p id="e172" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">所以你问的是什么问题。为什么要通过Lambda来代理它？嗯，你看，虽然S3是一个了不起的服务，它不是每个人的解决方案。可能有各种原因阻止它的使用，例如，拒绝在S3上托管内容，因为这要求bucket是公共的，而CloudFront可能不被允许，这需要一个替代的解决方案。</p><h1 id="678a" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">那么解决办法是什么呢？</h1><p id="2aa8" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">在本文中，我将向您展示一种通过AWS Lambda服务托管React单页面应用程序的方法。我们将使用S3、Lambda和应用负载平衡器(ALB)这三种资源，通过S3为用户提供我们构建的React站点。</p><figure class="ko kp kq kr fd ij er es paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="er es kn"><img src="../Images/f3fa83e54ad1d0dd58d495921215fae6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CHPax3jIP_WeY9wBCQPrBA.png"/></div></div><figcaption class="kw kx et er es ky kz bd b be z dx">Basic Architectural Diagram</figcaption></figure><p id="6cfc" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">在研讨会结束时，我们的架构将是上面演示的架构。所以，事不宜迟，让我们开始吧！</p><h1 id="adaf" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">第一步:创建-反应-应用</h1><p id="ecd3" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">研讨会的第一步是创建一个react应用程序，并在本地测试它，以确保在部署它之前一切就绪。幸运的是，npx提供了一个反应发生器。在执行以下命令之前，请确保进入工作目录:</p><pre class="ko kp kq kr fd la lb lc ld aw le bi"><span id="88f4" class="lf in hi lb b fi lg lh l li lj">npx create-react-app &lt;REPLACE WITH PROJECT NAME&gt;</span></pre><p id="b7fe" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">随意给你的项目起任何名字，只要全是小写字母。</p><p id="d277" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">几分钟后，这个项目就可以用你提供的名字命名了。您可以使用在本地运行该应用程序。</p><pre class="ko kp kq kr fd la lb lc ld aw le bi"><span id="3099" class="lf in hi lb b fi lg lh l li lj">cd &lt;REPLACE WITH PROJECT NAME&gt;<br/>yarn start</span></pre><p id="5d22" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">这将在您的端口3000上启动一个本地服务器(<a class="ae ll" href="http://localhost:3000/" rel="noopener ugc nofollow" target="_blank"> http://localhost:3000/ </a>)。就这样，你有了一个运行的React应用程序。</p><h1 id="0ccb" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">步骤2:配置AWS架构/环境</h1><h2 id="ea88" class="lf in hi bd io lm ln lo is lp lq lr iw jv ls lt ja jz lu lv je kd lw lx ji ly bi translated">S3</h2><p id="df3f" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">现在，您已经在本地测试了您的网站，现在让我们将它投入使用。我们将把它放在S3桶上。首先，我们需要创建一个存储桶，所以让我们从cli开始。</p><pre class="ko kp kq kr fd la lb lc ld aw le bi"><span id="664d" class="lf in hi lb b fi lg lh l li lj">aws s3 mb s3://react-serverless-spa-site-&lt;YOUR NAME HERE&gt;</span></pre><ul class=""><li id="6df8" class="lz ma hi jm b jn ki jr kj jv mb jz mc kd md kh me mf mg mh bi translated"><em class="lk">注:把这里的&lt;你的名字&gt;换成你的名字。</em></li><li id="f221" class="lz ma hi jm b jn mi jr mj jv mk jz ml kd mm kh me mf mg mh bi translated"><em class="lk">您还需要将</em><a class="ae ll" href="https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html" rel="noopener ugc nofollow" target="_blank"><em class="lk">aws CLI</em></a><em class="lk"/><a class="ae ll" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html" rel="noopener ugc nofollow" target="_blank"><em class="lk"/></a><em class="lk">正确安装到您的AWS帐户。</em></li></ul><p id="9c13" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">既然我们已经建立了我们的桶，让我们建立和推动它。运行以下命令:</p><pre class="ko kp kq kr fd la lb lc ld aw le bi"><span id="4c67" class="lf in hi lb b fi lg lh l li lj">yarn build &amp;&amp; aws s3 sync build/ s3://react-serverless-spa-site-&lt;YOUR NAME HERE&gt; --delete</span></pre><p id="975b" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated"><em class="lk">注意:记住将&lt;你的名字替换为你的名字。</em></p><p id="a114" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">一旦终端结束其操作，您现在应该能够找到您的React构建包，它被上传到您刚刚创建的bucket中。</p><h2 id="04d0" class="lf in hi bd io lm ln lo is lp lq lr iw jv ls lt ja jz lu lv je kd lw lx ji ly bi translated">希腊字母的第11个</h2><p id="985f" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">接下来，我们将在Lambda上设置我们的后端。我们的目标是创建一个函数，将代码推送到这个函数，它将指向并服务于我们的S3桶的内容。为此，让我们跳到AWS控制台。</p><p id="53d8" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">在AWS吊顶上导航至<strong class="jm hj">λ&gt;创建功能。</strong></p><figure class="ko kp kq kr fd ij er es paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="er es mn"><img src="../Images/2203ddf70c46e6cbe0eb8878abca56b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8vyaa2Xris0qpZHRvtwVuQ.png"/></div></div><figcaption class="kw kx et er es ky kz bd b be z dx">Create Lambda</figcaption></figure><p id="5c5d" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">将项目配置为使用您选择的函数名运行Node.js。</p><p id="4196" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">一旦创建了函数，我们就可以注入代码了。复制下面的代码并将其粘贴到新创建的函数index.js中。</p><p id="2c99" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated"><em class="lk">*确保在第4行添加您的存储桶名称。</em></p><pre class="ko kp kq kr fd la lb lc ld aw le bi"><span id="541a" class="lf in hi lb b fi lg lh l li lj">const AWS = require('aws-sdk');</span><span id="6e0c" class="lf in hi lb b fi mo lh l li lj">const s3 = new AWS.S3();<br/>const bucketName = "&lt;REPLACE WITH YOUR BUCKET NAME&gt;"</span><span id="ae62" class="lf in hi lb b fi mo lh l li lj">exports.handler = async (event) =&gt; {<br/>    try {<br/>        let params;<br/>        if (event.path === '/') {<br/>            params = {<br/>                Bucket: bucketName,<br/>                Key: 'index.html'<br/>            }<br/>         } else {<br/>            params = {<br/>                Bucket: bucketName,<br/>                Key: event.path.substring(1)<br/>            }<br/>         }<br/>        let data = await s3.getObject(params).promise()<br/>        return {<br/>            statusCode: 200,<br/>            headers: {'Content-Type': data.ContentType},<br/>            body: data.Body.toString()<br/>        };<br/>    } catch (err) {<br/>        if (err.code === 'NoSuchKey') {<br/>            let param;<br/>            param = {<br/>                Bucket: bucketName,<br/>                Key: 'index.html'<br/>                }<br/>            let data = await s3.getObject(param).promise()<br/>            return {<br/>                statusCode: 200,<br/>                headers: {'Content-Type': data.ContentType},<br/>                body: data.Body.toString()<br/>            };        <br/>        }<br/>    }<br/>};</span></pre><p id="c66f" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">一旦你粘贴了代码，确保<strong class="jm hj">部署</strong>你的函数。</p><p id="e30c" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">太棒了，你现在有一个后端设置。使我们的Lambda完全起作用的最后一步是给我们的Lambda读权限给S3服务。为此，我们需要找到Lambda的执行角色。</p><p id="6057" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">你可以在Lambda函数的<strong class="jm hj">权限</strong>标签下找到这个。</p><figure class="ko kp kq kr fd ij er es paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="er es mp"><img src="../Images/8dffe472e03191beb42c513695546f65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pq1gXjESvAFUIEW-FrV4ZQ.png"/></div></div></figure><p id="f2fe" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">单击角色名称，这会将您重定向到<strong class="jm hj"> IAM服务</strong>。</p><p id="d07e" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">您将看到唯一附加的策略应该是Lambda基本执行。单击蓝色的<strong class="jm hj"> Attach policies </strong>按钮，您可以选择将许多AWS的托管策略添加到您的执行角色中。</p><figure class="ko kp kq kr fd ij er es paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="er es mn"><img src="../Images/6e0935a0f25b6e89800bf9bf8f81392c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OU-SAYIYOi1IH9aMEZJgVQ.png"/></div></div></figure><p id="f722" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">在过滤器中搜索S3，然后选择AmazonS3FullAccess。附加策略。</p><p id="671a" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">现在你已经设置好了你的后端，是时候公开它了。</p><h2 id="c709" class="lf in hi bd io lm ln lo is lp lq lr iw jv ls lt ja jz lu lv je kd lw lx ji ly bi translated">应用负载平衡器</h2><p id="be73" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">最后一步是通过http向客户端公开您的后端。为此，我们将使用应用程序负载平衡器，但是您也可以在此步骤中使用API Gateway。</p><p id="4c4f" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">要创建负载平衡器，我们需要在AWS控制台中导航到EC2服务。在左侧菜单中，靠近底部是负载平衡器的位置。</p><figure class="ko kp kq kr fd ij er es paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="er es mn"><img src="../Images/82a45daa27606a1787a6ff65d854cd85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BX4rZNZqpiExdsyi577wXg.png"/></div></div></figure><p id="a378" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">选择<strong class="jm hj">创建负载平衡器</strong>后，您应该选择应用程序负载平衡器选项，并填写界面以匹配下图。您可以随意命名负载平衡器，但要确保它是面向互联网的，侦听器是HTTP，并将其添加到您的默认VPC中，同时选择所有子网。</p><figure class="ko kp kq kr fd ij er es paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="er es mn"><img src="../Images/6361fd87854f4137044b45baef9737ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yhp2WE-_bVPfb_JQjg0ckQ.png"/></div></div></figure><p id="26f8" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">对于步骤3，选择创建新的安全组，除非您已经有一个允许端口80入站的现有安全组，否则您可以使用该组。</p><figure class="ko kp kq kr fd ij er es paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="er es mn"><img src="../Images/aaf0f62550f5c3699e6a8652778d6714.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j2LGCaVWn8XqH4fFOKna_w.png"/></div></div></figure><p id="feea" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">为了配置路由，我们将创建一个新的目标组，并指定目标为Lambda。</p><figure class="ko kp kq kr fd ij er es paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="er es mn"><img src="../Images/f98b96492e6b50951e6169911ba85c89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OBKeOp5caoq5WESXvoGnsQ.png"/></div></div></figure><p id="cf8f" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">在目标注册页面上，会询问我们希望ALB指向哪个Lambda。在这里，我们将从下拉菜单中选择我们之前创建的功能。</p><p id="c1d0" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">在审查页面上，确保一切都在检查中，如果是这样，然后<strong class="jm hj">创建。</strong></p><h1 id="c89d" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">完成的</h1><p id="b289" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">这就是了。如果你现在转到你的负载均衡器，将DNS粘贴到你的浏览器中，你的站点应该会呈现出来。</p><p id="9544" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">您的负载平衡器可能需要一些时间来调配，所以请稍等片刻，然后再次尝试DNS。</p><h2 id="693a" class="lf in hi bd io lm ln lo is lp lq lr iw jv ls lt ja jz lu lv je kd lw lx ji ly bi translated">承认</h2><p id="c530" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">这要归功于<a class="mq mr ge" href="https://medium.com/u/5a57ccca3a9?source=post_page-----785bf44a20b3--------------------------------" rel="noopener" target="_blank">保罗·库基尔</a>，他提出了这个方法的基本单元。他在这种方法上的工作证明了通过Lambda代理呈现内容是可能的，这为我在React应用程序上进行构建奠定了基础。</p></div></div>    
</body>
</html>