<html>
<head>
<title>How to Run NodeJS app on AWS App Runner Using Amazon ECR</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用亚马逊ECR在AWS App Runner上运行NodeJS app</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/how-to-run-nodejs-app-on-aws-app-runner-using-amazon-ecr-50698436fa47?source=collection_archive---------4-----------------------#2022-11-19">https://medium.com/geekculture/how-to-run-nodejs-app-on-aws-app-runner-using-amazon-ecr-50698436fa47?source=collection_archive---------4-----------------------#2022-11-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="bc57" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">具有GitHub操作的AWS云CI/CD管道</p><p id="18c5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，本文建立在我发表的上一篇教程的基础上。我建议您在开始之前先完成它们:</p><ol class=""><li id="049b" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated"><a class="ae jm" href="https://blog.devgenius.io/how-to-build-and-run-a-nodejs-app-with-docker-github-actions-59eb264dfef5" rel="noopener ugc nofollow" target="_blank">如何使用Docker &amp; GitHub Actions </a>构建并运行NodeJS应用</li><li id="dc19" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated"><a class="ae jm" href="https://blog.devgenius.io/how-to-deploy-to-kubernetes-heroku-using-docker-c2556a9584df" rel="noopener ugc nofollow" target="_blank">如何使用Docker </a>部署到Kubernetes &amp; Heroku</li></ol><blockquote class="js jt ju"><p id="14c1" class="if ig jv ih b ii ij ik il im in io ip jw ir is it jx iv iw ix jy iz ja jb jc hb bi translated"><strong class="ih hj">假设&amp;先决条件</strong></p></blockquote><p id="2b91" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">出于本文的目的，我假设您已经完成了前面的教程，并且已经设置了AWS帐户。或者至少对NodeJS、Docker和GitHub动作有所了解。</p><h1 id="342f" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">入门指南</h1><p id="3c2a" class="pw-post-body-paragraph if ig hi ih b ii kx ik il im ky io ip iq kz is it iu la iw ix iy lb ja jb jc hb bi translated">我们将执行两个非常简单的任务来让我们的应用程序托管在AWS上:</p><ol class=""><li id="08b3" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">在Amazon Elastic Container Registry(又名Amazon ECR)上构建并推送我们的nodeJS应用程序的docker映像</li><li id="6833" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated">然后，我们将获取ECR中的docker映像，并使用AWS App Runner服务在一个容器中运行它。</li></ol><blockquote class="js jt ju"><p id="d693" class="if ig jv ih b ii ij ik il im in io ip jw ir is it jx iv iw ix jy iz ja jb jc hb bi translated"><strong class="ih hj">什么是AWS ECR服务？</strong></p></blockquote><figure class="ld le lf lg fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lc"><img src="../Images/41943250405f3f8c14110f50804f5b3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1xD0sMyZKoVur4a3tKImGw.png"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx">Source: <a class="ae jm" href="https://aws.amazon.com/ecr/" rel="noopener ugc nofollow" target="_blank">aws.amazon.com/ecr</a></figcaption></figure><p id="26d0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Amazon Elastic Container Registry(<strong class="ih hj">ECR</strong>)是一个完全托管的Docker容器注册表，可以轻松存储、共享和部署容器映像。它和Docker Hub差不多，只是一个你可以存储Docker图片的地方。</p><blockquote class="js jt ju"><p id="aebe" class="if ig jv ih b ii ij ik il im in io ip jw ir is it jx iv iw ix jy iz ja jb jc hb bi translated"><strong class="ih hj">什么是AWS App Runner服务？</strong></p></blockquote><figure class="ld le lf lg fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es ls"><img src="../Images/e3d50ddd8375e6d03e56f455f40df66b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zbcK9DRtHwC7dMHGilbt5Q.png"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx">Source: <a class="ae jm" href="https://aws.amazon.com/apprunner/" rel="noopener ugc nofollow" target="_blank">aws.amazon.com/apprunner</a></figcaption></figure><p id="5850" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jm" href="https://console.aws.amazon.com/apprunner/home" rel="noopener ugc nofollow" target="_blank"> AWS App Runner </a>是在AWS中构建和运行容器化web应用程序的最简单方式。App Runner为您提供完全托管的容器原生服务。不需要配置协调器，不需要建立管道，不需要优化负载平衡器，也不需要轮换TLS证书。当然，也没有需要管理的服务器。</p><p id="35e5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在托管和运行容器化的应用程序方面，它在某种程度上做了和Heroku差不多的事情。</p></div><div class="ab cl lt lu gp lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="hb hc hd he hf"><h1 id="31b9" class="jz ka hi bd kb kc ma ke kf kg mb ki kj kk mc km kn ko md kq kr ks me ku kv kw bi translated">1.创建AWS ECR报告</h1><p id="fcb9" class="pw-post-body-paragraph if ig hi ih b ii kx ik il im ky io ip iq kz is it iu la iw ix iy lb ja jb jc hb bi translated">要创建一个新的回购，我们将在其中推广我们的应用程序docker映像:</p><ol class=""><li id="49cd" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">转到ECR服务—点击<strong class="ih hj">创建存储库</strong></li><li id="efe5" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated">选择可见性下的<strong class="ih hj"> <em class="jv">私有</em></strong>—为您的回购起一个有意义的名字。我将我的名字命名为:<strong class="ih hj"> <em class="jv"> nodejs-demo — </em> </strong>，点击<strong class="ih hj">创建库</strong>。</li></ol><figure class="ld le lf lg fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es mf"><img src="../Images/8927509feff849b97c502981d9b7d892.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*jUbcFDqoV5RVS6nR3Sef-g.gif"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx">Create ECR repo</figcaption></figure><h1 id="40d4" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">2.使用AWS IAM创建服务帐户用户</h1><p id="9ef2" class="pw-post-body-paragraph if ig hi ih b ii kx ik il im ky io ip iq kz is it iu la iw ix iy lb ja jb jc hb bi translated">因此，让我们从将GitHub操作与AWS帐户集成开始。这是为了允许GitHub动作将构建映像上传到ECR中的repo。我们实际上是创建一个服务帐户用户，该用户拥有将映像推送到ECR所需的访问和权限。</p><blockquote class="js jt ju"><p id="d80b" class="if ig jv ih b ii ij ik il im in io ip jw ir is it jx iv iw ix jy iz ja jb jc hb bi translated"><strong class="ih hj">什么是AWS IAM服务？</strong></p></blockquote><figure class="ld le lf lg fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es mg"><img src="../Images/53acf546349d6525dd00fae02cd7a7da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AAkbPcScAv2gVDt672GRAw.png"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx">source: <a class="ae jm" href="https://aws.amazon.com/iam/" rel="noopener ugc nofollow" target="_blank">aws.amazon.com/iam</a></figcaption></figure><p id="bf7a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">借助AWS身份和访问管理(IAM)，您可以<strong class="ih hj">指定谁或什么可以访问AWS中的服务和资源，集中管理细粒度的权限，并分析访问以细化AWS中的权限</strong>。</p><p id="9b11" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，要创建新的服务帐户用户:</p><ol class=""><li id="ecd8" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">转到IAM服务并选择<strong class="ih hj">用户</strong></li><li id="0eea" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated">在用户下，点击<strong class="ih hj">添加用户</strong>并按照提示进行操作</li><li id="2daa" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated">给一个有意义的名字。在我的例子中，我将其命名为:<strong class="ih hj"><em class="jv">GitHub-Action-user-ECR</em></strong>，并检查<strong class="ih hj">编程访问(</strong>允许创建密钥对)——点击<strong class="ih hj"> Next: Permissions </strong></li><li id="4b9d" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated">在下一个屏幕上，选择“<strong class="ih hj"> <em class="jv">直接附加现有策略</em> </strong>”选项卡。搜索“<strong class="ih hj"> <em class="jv">亚马逊2c containerregistryfullacess</em></strong>”并查看。</li><li id="466d" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated">点击<strong class="ih hj">下一步:标签</strong>跳过—点击<strong class="ih hj">下一步:查看— </strong>并确认<strong class="ih hj">创建用户。</strong></li><li id="284c" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated">确保将<strong class="ih hj">“访问密钥ID”</strong>和<strong class="ih hj">“秘密访问密钥”</strong>复制到某处。这些是我们要用来在GitHub Repo上添加秘密操作的细节。</li></ol><figure class="ld le lf lg fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es mf"><img src="../Images/8da4ba04f53b14e9c943060507cde599.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*69gcorktndC1866uBbwGAw.gif"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx">Create a Service Account User</figcaption></figure><h1 id="7a9b" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">3.将AWS服务帐户添加到Github</h1><ol class=""><li id="0dae" class="jd je hi ih b ii kx im ky iq mh iu mi iy mj jc ji jj jk jl bi translated">进入你的GitHub Repo——在设置下，点击<strong class="ih hj">秘密——操作</strong>。</li><li id="113d" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated">在secrets下，点击<strong class="ih hj"> New Repository Secret </strong>并添加以下变量及其各自的值。</li></ol><ul class=""><li id="d65c" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc mk jj jk jl bi translated">添加<strong class="ih hj"> AWS_ECR_REPO_NAME </strong> —在“值”部分，添加您的ECR repo的名称。我的是<strong class="ih hj"> nodejs-demo </strong></li><li id="97e5" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc mk jj jk jl bi translated">接下来，在value部分添加<strong class="ih hj">AWS _ ACCESS _ KEY _ ID</strong>—<strong class="ih hj"/>，粘贴您之前在创建服务帐户用户时复制的“<em class="jv">ACCESS KEY ID”</em>。</li><li id="0d2f" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc mk jj jk jl bi translated">在值部分添加<strong class="ih hj"> AWS_SECRET_ACCESS_KEY </strong>，粘贴“秘密访问密钥”。</li></ul><figure class="ld le lf lg fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es mf"><img src="../Images/c0b8fdac37a065e2df47568002ddb783.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*z1FX_ToiFg08ZBDRqnqFIg.gif"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx">Add GitHub Actions Secrets</figcaption></figure><h1 id="8788" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">4.在GitHub操作工作流程中添加作业</h1><p id="6b3f" class="pw-post-body-paragraph if ig hi ih b ii kx ik il im ky io ip iq kz is it iu la iw ix iy lb ja jb jc hb bi translated">现在，让我们添加将在Github操作管道中运行的作业，以CI/CD方式构建应用程序映像并将其推送到ECR:</p><ul class=""><li id="9933" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc mk jj jk jl bi translated">转到<strong class="ih hj">。github/workflows </strong>并将以下作业添加到您的生产工作流程<em class="jv">。yml </em>文件。我的名字叫main.yml:</li></ul><figure class="ld le lf lg fd lh"><div class="bz dy l di"><div class="ml mm l"/></div></figure><p id="f3da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你回顾一下<a class="ae jm" href="https://github.com/YannMjl/vanillaBEY/blob/main/.github/workflows/main.yml" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj"><em class="jv">my main . yml workflow</em></strong></a><strong class="ih hj"><em class="jv"/></strong>的全部内容，这样会更好的解释上面第6行和第7行关于我的工作。</p><ul class=""><li id="0308" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc mk jj jk jl bi translated">提交并推送代码——一旦更改被推送到存储库，检查<strong class="ih hj"> Actions </strong>选项卡——并检查构建应用程序的炊具图像并将其推送到AWS ECR的新工作。</li><li id="f8d4" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc mk jj jk jl bi translated">转到AWS ECR并进行审查，以确保docker图像已成功推送到您的ECR报告中</li></ul><h1 id="94fa" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">5.在AWS App Runner上设置新服务</h1><figure class="ld le lf lg fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es mn"><img src="../Images/a3f7e681a31004c2bc3218a861109fe3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Tf836-zU6c8pqbMYUCeI5w.png"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx">Source: <a class="ae jm" href="https://aws.amazon.com/blogs/containers/introducing-aws-app-runner/" rel="noopener ugc nofollow" target="_blank">aws.amazon.com</a></figcaption></figure><p id="27f8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">启动并运行我们的应用程序所需的最后一项任务是获取ECR中的docker映像，并使用AWS App Runner服务在一个容器中运行它:</p><ol class=""><li id="66b4" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">转到AWS App Runner——点击<strong class="ih hj">创建服务</strong>,并完成下一页配置。</li><li id="790e" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated">在<strong class="ih hj">仓库类型</strong>下，选择<em class="jv"/><strong class="ih hj"><em class="jv">容器注册表</em> </strong> —在<strong class="ih hj">提供者</strong>下，选择<strong class="ih hj"> <em class="jv">“亚马逊ECR”</em></strong></li><li id="bdec" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated">在<strong class="ih hj">容器图像URI </strong>下，浏览您的Amazon ECR注册表并选择您的图像存储库和标签。</li><li id="290b" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated">在<strong class="ih hj">展开设置</strong>和T <strong class="ih hj">装配工</strong>下——选择“手动”触发连续投放——选择“自动”触发连续展开</li><li id="9ec5" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated">在<strong class="ih hj"> ECR访问角色</strong>下，选择<strong class="ih hj"> <em class="jv">“创建新的服务角色”</em></strong>——(如果你是第一次这样做，你肯定没有现有的服务角色)</li><li id="2cd3" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated">保留默认设置，创建应用程序需要一些时间</li></ol><p id="8f43" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果一切顺利，您就大功告成了！</p><figure class="ld le lf lg fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es mf"><img src="../Images/2e2dd820402b0e311f24ff8b4eabb5d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*fyXc4j_RChiQZUrobERQ8Q.gif"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx">Creating App Runner Service</figcaption></figure><p id="0ffc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，对您的应用程序代码进行一些更改——将代码推送到您的GitHub存储库——观看GitHub工作流构建并以CI/CD方式将您的应用程序部署到ECR——App Runner。</p><blockquote class="js jt ju"><p id="82dc" class="if ig jv ih b ii ij ik il im in io ip jw ir is it jx iv iw ix jy iz ja jb jc hb bi translated">*你可以在这里查看完整的演示代码:<a class="ae jm" href="https://github.com/YannMjl/nodejs-demo-app" rel="noopener ugc nofollow" target="_blank"> github repo </a>。</p><p id="232b" class="if ig jv ih b ii ij ik il im in io ip jw ir is it jx iv iw ix jy iz ja jb jc hb bi translated">*我的网站是这样运行的:<a class="ae jm" href="https://5mf4qafkmw.us-east-1.awsapprunner.com/" rel="noopener ugc nofollow" target="_blank">https://5mf4qafkmw.us-east-1.awsapprunner.com/</a></p><p id="a2c9" class="if ig jv ih b ii ij ik il im in io ip jw ir is it jx iv iw ix jy iz ja jb jc hb bi translated">如果你喜欢这个，你可能也会喜欢:"<a class="ae jm" href="https://blog.devgenius.io/how-to-provision-configure-deploy-to-google-cloud-platform-97dbbe36fcde" rel="noopener ugc nofollow" target="_blank">使用Docker、Kubernetes、Terraform和GitHub动作部署到GCP</a>"</p></blockquote></div></div>    
</body>
</html>