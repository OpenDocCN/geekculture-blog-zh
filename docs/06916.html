<html>
<head>
<title>Continuous Delivery of AWS Config Rule in multi-account using Cloudformation or Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Cloudformation或Terraform在多帐户中持续交付AWS配置规则</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/continuous-delivery-of-aws-config-rule-in-multi-account-using-cloudformation-or-terraform-f0fd336ac078?source=collection_archive---------18-----------------------#2021-09-01">https://medium.com/geekculture/continuous-delivery-of-aws-config-rule-in-multi-account-using-cloudformation-or-terraform-f0fd336ac078?source=collection_archive---------18-----------------------#2021-09-01</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="06df" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过管道确保持续合规</p><p id="e5a1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">AWS Rule Development Kit (RDK)支持代码工作流合规性，允许您从工作站构建本地测试配置规则，将其部署到开发环境，并将其推广到生产环境。</p><p id="d607" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，我将把它部署到AWS多帐户配置中，其中使用Lambda的评估逻辑被部署到一个中心帐户中，例如，安全帐户和配置规则被部署到工作负载帐户中。</p><h1 id="d201" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">先决条件</h1><ol class=""><li id="7464" class="kb kc hi ih b ii kd im ke iq kf iu kg iy kh jc ki kj kk kl bi translated">AWS帐户将需要配置AWS配置存储桶、记录器和交付渠道。</li><li id="39ae" class="kb kc hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">rdk安装在开发工作站和Jenkins管道中。</li><li id="03cf" class="kb kc hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">AWS凭证在环境中配置。</li><li id="4754" class="kb kc hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">S3桶被创建到开发和安全帐户中以部署lambda代码。</li></ol><h1 id="5a44" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">解决方案概述</h1><p id="bd3b" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">下图显示了使用RDK开发AWS配置规则的工作流。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es ku"><img src="../Images/8d3709695945aea4326315a3502d27ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jPBy9VNvs0PILIXnL3eRjg.png"/></div></div></figure><p id="c988" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它是这样工作的:</p><ul class=""><li id="ab5f" class="kb kc hi ih b ii ij im in iq lg iu lh iy li jc lj kj kk kl bi translated">开发人员在他的工作站上使用rdk构建配置规则和单元测试。</li><li id="4721" class="kb kc hi ih b ii km im kn iq ko iu kp iy kq jc lj kj kk kl bi translated">开发人员将规则部署到开发帐户并测试它。</li><li id="7c5f" class="kb kc hi ih b ii km im kn iq ko iu kp iy kq jc lj kj kk kl bi translated">开发人员创建cloudformation/terraform清单文件。</li><li id="ced9" class="kb kc hi ih b ii km im kn iq ko iu kp iy kq jc lj kj kk kl bi translated">当代码被推送到git时，Jenkins pipeline开始工作并部署到安全和工作负载帐户。</li><li id="4f62" class="kb kc hi ih b ii km im kn iq ko iu kp iy kq jc lj kj kk kl bi translated">当配置规则在开发环境中工作时，它被提升为仅将该功能部署到安全帐户和工作负载帐户中的配置规则。</li></ul><h1 id="0e2f" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">开发和构建</h1><p id="fae2" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">让我们通过一个示例演练来创建一个配置规则，测试并部署它。</p><h2 id="a47e" class="lk je hi bd jf ll lm ln jj lo lp lq jn iq lr ls jr iu lt lu jv iy lv lw jz lx bi translated">在本地安装RDK和RDKlib</h2><pre class="kv kw kx ky fd ly lz ma mb aw mc bi"><span id="b5cd" class="lk je hi lz b fi md me l mf mg">pip3 install rdk<br/>pip3 install rdklib</span></pre><p id="236b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">只有当您想使用现有的lambda层来构建规则时，才需要rdklib。</p><h2 id="ad75" class="lk je hi bd jf ll lm ln jj lo lp lq jn iq lr ls jr iu lt lu jv iy lv lw jz lx bi translated"><strong class="ak">创建规则并部署到开发帐户</strong></h2><p id="bcb1" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">让我们创建一个规则来检查AWS安全组的符合性。</p><pre class="kv kw kx ky fd ly lz ma mb aw mc bi"><span id="500a" class="lk je hi lz b fi md me l mf mg">rdk create SG_CHECK  --runtime python3.8 --resource-types AWS::EC2::SecurityGroup</span></pre><p id="2f5f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它创建以下文件— SG_CHECK.py包含lambda代码，SG_CHECK_test.py包含rdk deploy使用的单元测试和参数。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div class="er es mh"><img src="../Images/dd56df968915e01f6938185c184b68f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:490/format:webp/1*cXPBJsnaytZNHHb7DOad8w.png"/></div></figure><p id="42e0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在SG_CHECK.py中的“Add your custom logic here”下添加您的自定义评估逻辑</p><p id="08cd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们运行一个本地测试，验证它是否正常。</p><pre class="kv kw kx ky fd ly lz ma mb aw mc bi"><span id="9ab2" class="lk je hi lz b fi md me l mf mg">rdk test-local SG_CHECK</span></pre><p id="9da1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们将资源部署到发展账户中。</p><pre class="kv kw kx ky fd ly lz ma mb aw mc bi"><span id="ce7d" class="lk je hi lz b fi md me l mf mg">rdk deploy SG_CHECK --custom-code-bucket my-lambda-bucket</span></pre><p id="7f87" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">部署完成后，让我们从AWS Cloudformation控制台验证Cloudformation堆栈是否完成。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es mi"><img src="../Images/3bbee6be72263998a0349278d35e57d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5NhRSSKbOKFi1NujI-F77g.png"/></div></div></figure><p id="08bd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">另外，从AWS配置控制台验证是否创建了规则。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es mj"><img src="../Images/3705c8f078a1dbcf64305a9338a701b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9rlTOTvwWhPFnrCQmowQQw.png"/></div></div></figure><p id="d3bb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要清理部署，请使用以下命令-</p><pre class="kv kw kx ky fd ly lz ma mb aw mc bi"><span id="090d" class="lk je hi lz b fi md me l mf mg">rdk undeploy SG_CHECK</span></pre><h1 id="b97e" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">部署</h1><p id="81e8" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">您可以通过Cloudformation或Terraform部署lambda和config规则。请根据您的需要按照步骤操作。</p><h2 id="3417" class="lk je hi bd jf ll lm ln jj lo lp lq jn iq lr ls jr iu lt lu jv iy lv lw jz lx bi translated">为部署创建云信息资源</h2><p id="ccc1" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">要使规则准备好通过Jenkins pipeline部署到安全和工作负载帐户中，我们需要遵循两个步骤-</p><ul class=""><li id="64a3" class="kb kc hi ih b ii ij im in iq lg iu lh iy li jc lj kj kk kl bi translated">部署到安全帐户—运行以下命令将lambda函数部署到安全帐户中。</li></ul><pre class="kv kw kx ky fd ly lz ma mb aw mc bi"><span id="460c" class="lk je hi lz b fi md me l mf mg">rdk deploy SG_CHECK --functions-only --custom-code-bucket my-lambda-bucket</span></pre><ul class=""><li id="8e8e" class="kb kc hi ih b ii ij im in iq lg iu lh iy li jc lj kj kk kl bi translated">为工作负载帐户创建云信息模板—运行以下命令创建包含配置规则的云信息模板。</li></ul><pre class="kv kw kx ky fd ly lz ma mb aw mc bi"><span id="2e34" class="lk je hi lz b fi md me l mf mg">rdk create-rule-template SG_CHECK --rules-only -o config-rule-template.json</span></pre><p id="6544" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它将创建一个json模板，但不会创建交叉帐户lambda角色。让我们将它转换为yaml，并添加lambda角色。</p><figure class="kv kw kx ky fd kz"><div class="bz dy l di"><div class="mk ml l"/></div></figure><p id="b39a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您想将其部署到多个工作负载帐户中，可以使用stackset来部署上述内容。</p><p id="e274" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此外，在将代码推送到git之前，确保将SG_CHECK.py文件改为asssume role为true。Lambda默认使用上面创建的名为config-role的IAM角色。</p><pre class="kv kw kx ky fd ly lz ma mb aw mc bi"><span id="0f62" class="lk je hi lz b fi md me l mf mg">ASSUME_ROLE_MODE = True</span></pre><h2 id="9cc2" class="lk je hi bd jf ll lm ln jj lo lp lq jn iq lr ls jr iu lt lu jv iy lv lw jz lx bi translated">创建用于部署的地形资源</h2><p id="abda" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">rdk还允许您将资源导出为terraform清单。您可以使用下面的命令将其导出为terraform清单。</p><pre class="kv kw kx ky fd ly lz ma mb aw mc bi"><span id="a0a3" class="lk je hi lz b fi md me l mf mg">rdk export SG_CHECK -f terraform -v 0.12</span></pre><p id="1a47" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以使用下面的命令测试它，以将其部署到开发环境中。但是要将它部署到安全和工作负载帐户中，您需要将它们分开。</p><pre class="kv kw kx ky fd ly lz ma mb aw mc bi"><span id="ebd1" class="lk je hi lz b fi md me l mf mg">terraform init</span><span id="3340" class="lk je hi lz b fi mm me l mf mg">terraform plan -var-file=sg_check.tfvars.json --var source_bucket=my-lambda-bucket</span></pre><p id="8a55" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您没有使用默认配置文件，您可能还需要在sg_check_rule.tf文件中更改提供程序。</p><pre class="kv kw kx ky fd ly lz ma mb aw mc bi"><span id="b503" class="lk je hi lz b fi md me l mf mg">provider "aws" {</span><span id="e880" class="lk je hi lz b fi mm me l mf mg">      profile    = "default"</span><span id="8233" class="lk je hi lz b fi mm me l mf mg">}</span></pre><h1 id="69f0" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">结论</h1><p id="abf8" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">总之，rdk提供了无缝的开发人员体验，同时在开发环境中构建配置规则并将其部署到各个阶段。本文将通过大规模构建配置规则，帮助您开始持续的法规遵从性之旅。</p><h1 id="3ac6" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">参考</h1><ol class=""><li id="c0df" class="kb kc hi ih b ii kd im ke iq kf iu kg iy kh jc ki kj kk kl bi translated"><a class="ae mn" href="https://aws.amazon.com/blogs/mt/how-to-develop-custom-aws-config-rules-using-the-rule-development-kit/" rel="noopener ugc nofollow" target="_blank">https://AWS . Amazon . com/blogs/mt/how-to-develop-custom-AWS-config-rules-using-the-rule-development-kit/</a></li><li id="22ee" class="kb kc hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated"><a class="ae mn" href="https://aws.amazon.com/blogs/devops/aws-config-rdk-deploying-the-custom-rules-using-the-terraform/" rel="noopener ugc nofollow" target="_blank">https://AWS . Amazon . com/blogs/devo PS/AWS-config-rdk-deploying-the-custom-rules-using-the-terra form/</a></li></ol></div></div>    
</body>
</html>