<html>
<head>
<title>How to Mock React-Native-Image-Picker Using Detox</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用解毒来模仿反应原生图像拾取器</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/how-to-mock-react-native-image-picker-using-detox-9f7ced41b67f?source=collection_archive---------3-----------------------#2021-04-18">https://medium.com/geekculture/how-to-mock-react-native-image-picker-using-detox-9f7ced41b67f?source=collection_archive---------3-----------------------#2021-04-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/431f9667e1564a1121ac5c41faf2178d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5aLafAqZX8bITxDCpMRVkA.png"/></div></div></figure><p id="76e9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当React原生项目开始增长时，建立端到端测试可能是明智的。你可以选择的解决方法之一是<a class="ae jo" href="https://github.com/wix/Detox" rel="noopener ugc nofollow" target="_blank">排毒</a>。</p><p id="0868" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Detox是测试你的应用程序UI的一个很好的工具，但是有些情况下你需要模拟你的应用程序的行为。这就是我们所说的模拟。</p><p id="022e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在我的例子中，我正在开发的应用程序使用了<a class="ae jo" href="https://github.com/react-native-image-picker/react-native-image-picker" rel="noopener ugc nofollow" target="_blank">react-native-image-picker</a>库，该库允许用户从他/她的手机中的文件中选取图像，或者用他/她的相机拍照。</p><p id="4d55" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">通过点击应用程序的一个按钮，用户被重定向到他/她的手机的文件系统或图库来选择图像。然而，由于这种重定向到手机的系统，排毒不再有互动的可能性。呈现的电话视图(例如他/她的电话的图库)在应用程序的UI层次之外。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jp"><img src="../Images/5daa0bc97cc176b2115291076939ccbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*8XG6RFFcYxluEAbW_EOWCA.gif"/></div></div></figure><p id="41ab" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在我的情况下，我寻找一种方法来保持测试这一部分与排毒。似乎唯一可靠的方法是使用react-native-image-picker库的模拟。至少，模仿在项目中有用的功能。在花了几个小时研究这个主题后，我得出结论，关于这个主题的例子严重缺乏。这篇文章之后，至少会有一篇！</p></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><p id="3325" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">出于本文的目的，我创建了一个非常基本的React本机应用程序。<br/>我已经设置了排毒配置，我想你已经在你的项目中设置好了。如果没有，我邀请你遵循这里的指示<a class="ae jo" href="https://github.com/wix/Detox/blob/master/docs/Introduction.GettingStarted.md" rel="noopener ugc nofollow" target="_blank"/>。你还应该有一个用Xcode构建的应用程序的调试版本。我的位于我的项目文件夹中，路径如下:<strong class="is hj">。/IOs/derived data/mockrnimagepickertox/Build/Products/Debug-iphone simulator/mockrnimagepickertox . app</strong></p><pre class="jq jr js jt fd kb kc kd ke aw kf bi"><span id="caf8" class="kg kh hi kc b fi ki kj l kk kl">//app.js</span><span id="259e" class="kg kh hi kc b fi km kj l kk kl">import React, {useState} from 'react';<br/>import {<br/>  SafeAreaView,<br/>  StatusBar,<br/>  TouchableOpacity,<br/>  useColorScheme,<br/>  Text,<br/>  StyleSheet,<br/>} from 'react-native';<br/>import {Colors} from 'react-native/Libraries/NewAppScreen';<br/>import launchImageLibrary from './ImagePickerProvider';</span><span id="0e84" class="kg kh hi kc b fi km kj l kk kl">const App = () =&gt; {<br/>  const [fileName, setFileName] = useState('N/A');</span><span id="7ac3" class="kg kh hi kc b fi km kj l kk kl">const isDarkMode = useColorScheme() === 'dark';<br/>  const backgroundStyle = {<br/>    backgroundColor: isDarkMode ? Colors.darker : Colors.lighter,<br/>  };</span><span id="893d" class="kg kh hi kc b fi km kj l kk kl">const options = {<br/>    mediaType: 'photo',<br/>    includeBase64: true,<br/>  };</span><span id="784b" class="kg kh hi kc b fi km kj l kk kl">return (<br/>    &lt;SafeAreaView style={[styles.container, backgroundStyle]}&gt;<br/>      &lt;StatusBar barStyle={isDarkMode ? 'light-content' : 'dark-content'} /&gt;</span><span id="24bf" class="kg kh hi kc b fi km kj l kk kl">      &lt;TouchableOpacity<br/>        testID="button"<br/>        style={styles.button}<br/>        onPress={() =&gt;<br/>          launchImageLibrary(options, res =&gt; {<br/>            setFileName(res.fileName ?? 'N/A');<br/>          })<br/>        }&gt;<br/>        &lt;Text style={styles.buttonText}&gt;Open Image Picker&lt;/Text&gt;<br/>      &lt;/TouchableOpacity&gt;<br/>      &lt;Text style={styles.text}&gt;{fileName}&lt;/Text&gt;<br/>    &lt;/SafeAreaView&gt;<br/>  );<br/>};</span><span id="dd8d" class="kg kh hi kc b fi km kj l kk kl">export default App;</span><span id="bcf2" class="kg kh hi kc b fi km kj l kk kl">const styles = StyleSheet.create({<br/>  container: {<br/>    flex: 1,<br/>    justifyContent: 'center',<br/>    alignItems: 'center',<br/>  },<br/>  button: {<br/>    backgroundColor: '#0000FF',<br/>    justifyContent: 'center',<br/>    alignItems: 'center',<br/>    width: 200,<br/>    padding: 10,<br/>  },<br/>  buttonText: {<br/>    color: '#FFFFFF',<br/>  },<br/>  text: {<br/>    marginTop: 20,<br/>  },<br/>});</span></pre><p id="a82e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">正如你所看到的，我们没有直接从react-native-image-picker库中导入<strong class="is hj"> launchImageLibrary </strong>函数，而是从我们为此专门创建的提供程序中导入。在接下来的几行中你会明白为什么。</p><pre class="jq jr js jt fd kb kc kd ke aw kf bi"><span id="2521" class="kg kh hi kc b fi ki kj l kk kl">//ImagePickerProvider.js</span><span id="3404" class="kg kh hi kc b fi km kj l kk kl">import {launchImageLibrary} from 'react-native-image-picker';<br/>export default launchImageLibrary;</span></pre><p id="632c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您将得到预期的结果(见上面的gif)，即被执行的react-native-image-picker的<strong class="is hj"> launchImageLibrary </strong>函数。当您想要测试应用程序时，您将不能在这个内部函数被执行后执行操作，因为您将离开应用程序的UI。这就是为什么我们定义了一个只在我们的e2e测试中使用的提供者:<strong class="is hj">image picker provider . e2e . js</strong></p><pre class="jq jr js jt fd kb kc kd ke aw kf bi"><span id="f473" class="kg kh hi kc b fi ki kj l kk kl">//ImagePickerProvider.e2e.js</span><span id="c7ce" class="kg kh hi kc b fi km kj l kk kl">const mockImageData = 'YOUR_BASE_64_FILE';</span><span id="18b7" class="kg kh hi kc b fi km kj l kk kl">function launchImageLibrary(options, callback) {<br/>  if (typeof options === 'function') {<br/>    callback = options;<br/>  }</span><span id="19d4" class="kg kh hi kc b fi km kj l kk kl">  callback({data: mockImageData, fileName: 'Your base 64 file'});<br/>}<br/>export default launchImageLibrary;</span></pre><p id="39f2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这就是事情变得有趣的地方，因为在这个文件中，我们模拟了<strong class="is hj"> launchImageLibrary </strong>函数的行为。这个函数的预期响应将是一个b64字符串(数据)和一个文件名(文件名)。你可以根据你的需要添加这个回调的参数，显然保持精确到<a class="ae jo" href="https://github.com/react-native-image-picker/react-native-image-picker#the-response-object" rel="noopener ugc nofollow" target="_blank">库</a>的初始函数。</p><p id="b5c5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们需要设置React Native Metro知道当我们运行e2e测试时，需要导入到<strong class="is hj"> app.js </strong>中的<strong class="is hj"> launchImageLibrary </strong>函数必须来自<strong class="is hj">image picker provider . e2e . js</strong>(不是。js)。为此，只需在<strong class="is hj"> metro.config.js </strong>文件中添加以下元素。</p><pre class="jq jr js jt fd kb kc kd ke aw kf bi"><span id="77a3" class="kg kh hi kc b fi ki kj l kk kl">//metro.config.js</span><span id="67e8" class="kg kh hi kc b fi km kj l kk kl">const defaultSourceExts = require('metro-config/src/defaults/defaults').sourceExts;</span><span id="5281" class="kg kh hi kc b fi km kj l kk kl">module.exports = {<br/>  resolver: {<br/>    sourceExts: process.env.RN_SRC_EXT<br/>      ? process.env.RN_SRC_EXT.split(',').concat(defaultSourceExts)<br/>      : defaultSourceExts,<br/>  },<br/>  transformer: {<br/>    getTransformOptions: async () =&gt; ({<br/>      transform: {<br/>        experimentalImportSupport: false,<br/>        inlineRequires: true,<br/>      },<br/>    }),<br/>  },<br/>};</span></pre><p id="5608" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后，当我们想要运行e2e排毒测试时，我们将使用以下命令启动React Native Metro:</p><p id="0242" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">RN _ SRC _ EXT = e2e . js react-native start</strong></p><p id="a741" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> launchImageLibrary </strong>函数将根据需要由<strong class="is hj">image picker provider . e2e . js</strong>提供。这张gif图向你展示了这次成功模仿的结果。</p></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><p id="0e10" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">资源:</strong></p><ul class=""><li id="5b50" class="kn ko hi is b it iu ix iy jb kp jf kq jj kr jn ks kt ku kv bi translated"><a class="ae jo" href="https://github.com/wix/Detox/blob/master/docs/Guide.Mocking.md" rel="noopener ugc nofollow" target="_blank">排毒嘲讽指南</a></li><li id="ec8f" class="kn ko hi is b it kw ix kx jb ky jf kz jj la jn ks kt ku kv bi translated"><a class="ae jo" href="https://github.com/react-native-image-picker/react-native-image-picker" rel="noopener ugc nofollow" target="_blank">react-native-image-picker</a>库</li><li id="1495" class="kn ko hi is b it kw ix kx jb ky jf kz jj la jn ks kt ku kv bi translated"><a class="ae jo" href="https://stackoverflow.com/a/55151119" rel="noopener ugc nofollow" target="_blank">堆栈溢出线程</a></li></ul><p id="b431" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">编码快乐！</p></div></div>    
</body>
</html>