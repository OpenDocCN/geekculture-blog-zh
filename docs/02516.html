<html>
<head>
<title>Three Ways to Use Secrets in Ansible</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Ansible中使用机密的三种方式</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/three-ways-to-use-secrets-in-ansible-922ae18df847?source=collection_archive---------2-----------------------#2021-05-18">https://medium.com/geekculture/three-ways-to-use-secrets-in-ansible-922ae18df847?source=collection_archive---------2-----------------------#2021-05-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><h2 id="1adc" class="hg hh hi bd b fp hj hk hl hm hn ho dx hp translated" aria-label="kicker paragraph">在Ansible中使用机密</h2><div class=""/><div class=""><h2 id="6abf" class="pw-subtitle-paragraph io hr hi bd b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf dx translated">GPG，安西布尔金库还是哈希科尔金库？解决同一个问题的三种方案。</h2></div><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es jg"><img src="../Images/20f6e16cd781604a70b2de4329892701.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GHAhEMtn_C6qV3Hc"/></div></div><figcaption class="js jt et er es ju jv bd b be z dx">Photo by <a class="ae jw" href="https://unsplash.com/@jankolar?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Jan Antonin Kolar</a> on <a class="ae jw" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="e472" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ix ki iy kj ja kk jb kl jd km je kn ko bi translated">介绍</h1><p id="9e63" class="pw-post-body-paragraph kp kq hi kr b ks kt is ku kv kw iv kx ky kz la lb lc ld le lf lg lh li lj lk hb bi translated">要用Ansible存储秘密、凭证、证书，有几种可能性。你可以使用Ansible Vault来加密你所有的敏感信息。Ansible提供的机制是内置的，可以满足各种用例。此外，您可以使用多个保管库，并将它们与您的库存组织在一起。</p><p id="6d08" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">这样做有助于您组织和约束与库存相关的秘密。我过去用它来存储我在GitHub中的不同剧本和角色。我们可以讨论在GitHub上存储加密文件是好是坏，但至少这比在这样的平台上存储带有凭证的明文文件要好得多😅。</p><p id="b003" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">你也可以用ansible var文件(yaml文件)构建你自己的解决方案，你可以用GPG这样的解决方案“简单地”加密这些文件。这很简单，不太难实现。当你没有成百上千的秘密时，这个解决方案就足够了。这是我们在我的工作中实现的。</p><p id="382c" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">最后，您可以找到其他解决方案，比如Ansible Vault，它们要完整得多，可以处理更大的用例。正如已经解释过的，对于我的实验室，我的目标是探索尽可能多的技术。我想使用HashiCorp Vault，因为它似乎是一个完整的解决方案，即使是社区版。</p><h1 id="7f3f" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ix ki iy kj ja kk jb kl jd km je kn ko bi translated">GPG解决方案</h1><p id="b360" class="pw-post-body-paragraph kp kq hi kr b ks kt is ku kv kw iv kx ky kz la lb lc ld le lf lg lh li lj lk hb bi translated">对于那些对这种可能性感兴趣的人，我将试着简要介绍一下GPG的解决方案。在Mac OS X上，我安装了以下工具:</p><ul class=""><li id="8918" class="lq lr hi kr b ks ll kv lm ky ls lc lt lg lu lk lv lw lx ly bi translated"><a class="ae jw" href="https://gnupg.org/" rel="noopener ugc nofollow" target="_blank"> gpg2 </a>(管理密钥和加密/解密文件的核心工具)</li><li id="13c3" class="lq lr hi kr b ks lz kv ma ky mb lc mc lg md lk lv lw lx ly bi translated"><a class="ae jw" href="https://gpgtools.org/" rel="noopener ugc nofollow" target="_blank"> GPGSuite </a>(用于管理密钥并轻松与Apple钥匙链集成的实用程序)</li></ul><h2 id="3ce0" class="me jy hi bd jz mf mg mh kd mi mj mk kh ky ml mm kj lc mn mo kl lg mp mq kn ho bi translated">装置</h2><p id="ea79" class="pw-post-body-paragraph kp kq hi kr b ks kt is ku kv kw iv kx ky kz la lb lc ld le lf lg lh li lj lk hb bi translated">为了安装工具，我简单地使用了<code class="du mr ms mt mu b">homebrew</code>。</p><pre class="jh ji jj jk fd mv mu mw mx aw my bi"><span id="f5d3" class="me jy hi mu b fi mz na l nb nc"># Start the generation of the key. I keep the RSA &amp; RSA default,<br/># 4096 for the key length and no expiration (update to your needs).<br/># Then fill a proper name and an email address.<em class="nd"><br/></em><strong class="mu hs">❯ brew cask install gpg-suite-no-mail</strong></span></pre><h2 id="4bf3" class="me jy hi bd jz mf mg mh kd mi mj mk kh ky ml mm kj lc mn mo kl lg mp mq kn ho bi translated">GPG关键一代</h2><p id="1e86" class="pw-post-body-paragraph kp kq hi kr b ks kt is ku kv kw iv kx ky kz la lb lc ld le lf lg lh li lj lk hb bi translated">下一步是生成一个GPG密钥。GPGSuite工具会提示您输入密码两次。为了简单起见，我选择不输入密码。拥有一个密码取决于你和你的安全需求。</p><pre class="jh ji jj jk fd mv mu mw mx aw my bi"><span id="98f2" class="me jy hi mu b fi mz na l nb nc"><em class="nd"># Start the generation of the key. I keep the RSA &amp; RSA default,<br/># 4096 for the key length and no expiration (feel free to update<br/># to your needs).<br/># Then, you have to fill a real name and an email address.<br/></em><strong class="mu hs">❯ gpg2 --full-generate-key</strong></span><span id="6acb" class="me jy hi mu b fi ne na l nb nc">gpg (GnuPG/MacGPG2) 2.2.20; Copyright (C) 2020 Free Software Foundation, Inc.<br/>This is free software: you are free to change and redistribute it.<br/>There is NO WARRANTY, to the extent permitted by law.</span><span id="de1e" class="me jy hi mu b fi ne na l nb nc">Please select what kind of key you want:<br/>   (1) RSA and RSA (default)<br/>   (2) DSA and Elgamal<br/>   (3) DSA (sign only)<br/>   (4) RSA (sign only)<br/>  (14) Existing key from card<br/>Your selection? 1<br/>RSA keys may be between 1024 and 4096 bits long.<br/>What keysize do you want? (2048) 4096<br/>Requested keysize is 4096 bits<br/>Please specify how long the key should be valid.<br/>         0 = key does not expire<br/>      &lt;n&gt;  = key expires in n days<br/>      &lt;n&gt;w = key expires in n weeks<br/>      &lt;n&gt;m = key expires in n months<br/>      &lt;n&gt;y = key expires in n years<br/>Key is valid for? (0) 0<br/>Key does not expire at all<br/>Is this correct? (y/N) y</span><span id="8076" class="me jy hi mu b fi ne na l nb nc">GnuPG needs to construct a user ID to identify your key.</span><span id="8efb" class="me jy hi mu b fi ne na l nb nc">Real name: &lt;realName&gt;<br/>Email address: <a class="ae jw" href="mailto:japan@prevole.ch" rel="noopener ugc nofollow" target="_blank">&lt;emailAddress&gt;</a><br/>Comment:<br/>You selected this USER-ID:<br/>    "&lt;realName&gt; &lt;<a class="ae jw" href="mailto:japan@prevole.ch" rel="noopener ugc nofollow" target="_blank">ema</a>ilAddress&gt;"</span><span id="9f5d" class="me jy hi mu b fi ne na l nb nc">Change (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit?</span><span id="9ad9" class="me jy hi mu b fi ne na l nb nc">We need to generate a lot of random bytes. It is a good idea to perform<br/>some other action (type on the keyboard, move the mouse, utilize the<br/>disks) during the prime generation; this gives the random number<br/>generator a better chance to gain enough entropy.<br/>gpg: key &lt;ID&gt; marked as ultimately trusted<br/>gpg: revocation certificate stored as '/Users/&lt;username&gt;/.gnupg/openpgp-revocs.d/&lt;anotherId&gt;.rev'<br/>public and secret key created and signed.</span><span id="c753" class="me jy hi mu b fi ne na l nb nc">pub   rsa4096 2020-10-05 [SC]<br/>      &lt;anotherId&gt;<br/>uid   &lt;realName&gt; &lt;emailAddress&gt;<br/>sub   rsa4096 2020-10-05 [E]</span></pre><p id="4082" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">要检查您的密钥是否已经生成，您可以列出它们。</p><pre class="jh ji jj jk fd mv mu mw mx aw my bi"><span id="97ae" class="me jy hi mu b fi mz na l nb nc"><em class="nd"># You can have other keys, I only kept in the output the one <br/># just created</em><br/><strong class="mu hs">❯ gpg2 --list-keys</strong></span><span id="5c19" class="me jy hi mu b fi ne na l nb nc">gpg: checking the trustdb<br/>gpg: marginals needed: 3  completes needed: 1  trust model: pgp<br/>gpg: depth: 0  valid:   4  signed:   0  trust: 0-, 0q, 0n, 0m, 0f, 4u<br/>/Users/&lt;username&gt;/.gnupg/pubring.kbx<br/>-----------------------------------------<br/>pub   rsa4096 2020-10-05 [SC]<br/>      &lt;anotherId&gt;<br/>uid           [ultimate] &lt;realName&gt; &lt;<a class="ae jw" href="mailto:japan@prevole.ch" rel="noopener ugc nofollow" target="_blank">emailAddress</a>&gt;<br/>sub   rsa4096 2020-10-05 [E]</span></pre><h2 id="f2cf" class="me jy hi bd jz mf mg mh kd mi mj mk kh ky ml mm kj lc mn mo kl lg mp mq kn ho bi translated">用GPG密钥加密</h2><p id="e283" class="pw-post-body-paragraph kp kq hi kr b ks kt is ku kv kw iv kx ky kz la lb lc ld le lf lg lh li lj lk hb bi translated">要使用您的密钥加密文件，您可以简单地使用以下命令。</p><pre class="jh ji jj jk fd mv mu mw mx aw my bi"><span id="f1fd" class="me jy hi mu b fi mz na l nb nc"># We trust our generated key. We identify the key with the email<br/># address and we give the file to <!-- -->cipher<br/><strong class="mu hs">❯ gpg --always-trust --yes --recipient "</strong><a class="ae jw" href="mailto:japan@prevole.ch" rel="noopener ugc nofollow" target="_blank"><strong class="mu hs">&lt;emailAddress&gt;</strong></a><strong class="mu hs">" --encrypt &lt;pathToTheFileToEncrypt&gt;</strong></span></pre><p id="9447" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">如果加密操作成功，控制台中没有特殊输出。该命令产生一个<code class="du mr ms mt mu b">gpg</code>文件。</p><h2 id="260e" class="me jy hi bd jz mf mg mh kd mi mj mk kh ky ml mm kj lc mn mo kl lg mp mq kn ho bi translated">用GPG密钥解密</h2><p id="c7b5" class="pw-post-body-paragraph kp kq hi kr b ks kt is ku kv kw iv kx ky kz la lb lc ld le lf lg lh li lj lk hb bi translated">要检索加密文件的明文内容，我们只需执行一个相反的命令。</p><pre class="jh ji jj jk fd mv mu mw mx aw my bi"><span id="dac7" class="me jy hi mu b fi mz na l nb nc"># To decrypt, we need to specify the input file, which is the<br/># encrypted file and the output file. GPG will automatically pick<br/># the right key to decrypt. The encrypted file contains the info.<br/><strong class="mu hs">❯ gpg --output &lt;pathToDecryptedFile&gt; --yes --decrypt &lt;pathToCryptedFile&gt;</strong></span><span id="595b" class="me jy hi mu b fi ne na l nb nc">gpg: encrypted with 4096-bit RSA key, ID &lt;ID&gt;, created 2020-10-05<br/>      "&lt;realName&gt; &lt;<a class="ae jw" href="mailto:japan@prevole.ch" rel="noopener ugc nofollow" target="_blank">emailAddress</a>&gt;"</span></pre><p id="fef4" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">就是这样。用GPG加密和解密的操作非常容易。我们已经准备好了处理秘密使用管理的所有可行任务。</p><h2 id="9eb7" class="me jy hi bd jz mf mg mh kd mi mj mk kh ky ml mm kj lc mn mo kl lg mp mq kn ho bi translated">安西布尔和GPG在一起</h2><p id="ee9d" class="pw-post-body-paragraph kp kq hi kr b ks kt is ku kv kw iv kx ky kz la lb lc ld le lf lg lh li lj lk hb bi translated">是时候把所有的碎片放在一起，写一个剧本了。剧本将包含解密部分和一些最后的清理工作。</p><figure class="jh ji jj jk fd jl"><div class="bz dy l di"><div class="nf ng l"/></div><figcaption class="js jt et er es ju jv bd b be z dx">Ansible Playbook with Encrypted Var File</figcaption></figure><p id="6911" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated"><strong class="kr hs"> ① </strong>我们解密包含秘密的var文件。</p><p id="b6a7" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated"><strong class="kr hs"> ② </strong>然后，很容易将var文件作为普通var文件包含在剧本中。</p><p id="c265" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">我们运行需要一些秘密(密码、令牌、证书等)的任务</p><p id="905e" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated"><strong class="kr hs"> ④ </strong>最后，我们只需删除clear文件。</p><h2 id="b4c8" class="me jy hi bd jz mf mg mh kd mi mj mk kh ky ml mm kj lc mn mo kl lg mp mq kn ho bi translated">GPG摘要</h2><p id="162a" class="pw-post-body-paragraph kp kq hi kr b ks kt is ku kv kw iv kx ky kz la lb lc ld le lf lg lh li lj lk hb bi translated">这种方法的主要缺点仍然是，如果剧本由于错误而中断，文件可能不会被清除。您可以使用不同的策略来缓解这个问题，比如通知/处理程序。</p><p id="57e4" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">在我的工作中，我继承了一个现有的设置，其中var文件加密/解密过程是在任何行动手册之外完成的。var文件被加密并存储在内部GitHub企业实例的git存储库中。然后，解密后的文件存储在<code class="du mr ms mt mu b">/etc/ansible/group_vars</code>中，就像一个用于<code class="du mr ms mt mu b">all</code>库存的全局var文件。</p><p id="d81c" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">最后，如果不考虑安全性，我不推荐这些方法。如果你不得不管理的秘密不是那么敏感或者对于家庭实验室来说是非常好的。对于真实的产品，我会增加一点安全性，比如在GPG密钥中加入一个密码。此外，我会尽可能避免使用明文。</p><h1 id="fa0f" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ix ki iy kj ja kk jb kl jd km je kn ko bi translated">可旋转拱顶</h1><p id="fd1a" class="pw-post-body-paragraph kp kq hi kr b ks kt is ku kv kw iv kx ky kz la lb lc ld le lf lg lh li lj lk hb bi translated">如前所述，Ansible本身提供了存储敏感数据的解决方案。我在Ansible的早期使用过这种机制。这也是一个伟大的解决方案，安全地存储您的敏感数据。</p><p id="cda1" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">Ansible文档警告您使用Ansible Vault的风险。</p><blockquote class="nh ni nj"><p id="819a" class="kp kq nd kr b ks ll is ku kv lm iv kx nk ln la lb nl lo le lf nm lp li lj lk hb bi translated">Ansible Vault加密仅保护“静态数据”。一旦内容被解密(“使用中的数据”)，play和插件作者有责任避免任何秘密泄露，有关隐藏输出的详细信息，请参见<a class="ae jw" href="https://docs.ansible.com/ansible/latest/reference_appendices/faq.html#keep-secret-data" rel="noopener ugc nofollow" target="_blank"> no_log </a>，有关与Ansible Vault一起使用的编辑器的安全注意事项，请参见<a class="ae jw" href="https://docs.ansible.com/ansible/latest/user_guide/vault.html#vault-securing-editor" rel="noopener ugc nofollow" target="_blank">保护编辑器的步骤</a>。— <a class="ae jw" href="https://docs.ansible.com/ansible/latest/user_guide/vault.html" rel="noopener ugc nofollow" target="_blank">可提供的文件</a></p></blockquote><h2 id="c459" class="me jy hi bd jz mf mg mh kd mi mj mk kh ky ml mm kj lc mn mo kl lg mp mq kn ho bi translated">使用Ansible Vault加密</h2><p id="2097" class="pw-post-body-paragraph kp kq hi kr b ks kt is ku kv kw iv kx ky kz la lb lc ld le lf lg lh li lj lk hb bi translated">使用保险库加密数据有两种可能性。一种是直接在行动手册中加密敏感信息。一次只能加密一个变量。第二种可能性是加密整个文件。我加密了一个完整的文件，就像我们之前和GPG做的一样。</p><p id="186a" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">Ansible Vault的优点是可以直接加密var文件。之后，当我们运行包含或引用var文件的剧本时，Ansible会自动提示您解密。</p><p id="f0e2" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">文件加密就像下面的命令一样简单。</p><pre class="jh ji jj jk fd mv mu mw mx aw my bi"><span id="d24b" class="me jy hi mu b fi mz na l nb nc"><em class="nd"># Encrypt an inventory var file</em><br/><strong class="mu hs">❯ ansible-vault encrypt all.yml</strong></span><span id="aff7" class="me jy hi mu b fi ne na l nb nc">New Vault password: <br/>Confirm New Vault password: <br/>Encryption successful</span></pre><p id="abcc" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">要查看加密文件的内容，只需运行以下命令。</p><pre class="jh ji jj jk fd mv mu mw mx aw my bi"><span id="1b56" class="me jy hi mu b fi mz na l nb nc"><strong class="mu hs">❯ ansible-vault view all.yml</strong>   </span><span id="1275" class="me jy hi mu b fi ne na l nb nc">Vault password:</span></pre><p id="ad36" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">要编辑加密文件，可以使用类似的命令。</p><pre class="jh ji jj jk fd mv mu mw mx aw my bi"><span id="c769" class="me jy hi mu b fi mz na l nb nc"><strong class="mu hs">❯ ansible-vault edit all.yml</strong></span><span id="d00d" class="me jy hi mu b fi ne na l nb nc">Vault password:</span></pre><h2 id="7311" class="me jy hi bd jz mf mg mh kd mi mj mk kh ky ml mm kj lc mn mo kl lg mp mq kn ho bi translated"><strong class="ak">用安全金库解密</strong></h2><p id="4037" class="pw-post-body-paragraph kp kq hi kr b ks kt is ku kv kw iv kx ky kz la lb lc ld le lf lg lh li lj lk hb bi translated">vault文件的解密也很容易。运行以下命令。</p><pre class="jh ji jj jk fd mv mu mw mx aw my bi"><span id="a820" class="me jy hi mu b fi mz na l nb nc"><em class="nd"># This command will decrypt the var file in place.</em><br/><strong class="mu hs">❯ ansible-vault decrypt all.yml</strong></span><span id="5356" class="me jy hi mu b fi ne na l nb nc">Vault password: <br/>Decryption successful</span></pre><h2 id="cd62" class="me jy hi bd jz mf mg mh kd mi mj mk kh ky ml mm kj lc mn mo kl lg mp mq kn ho bi translated">可转换和不可转换的拱顶在一起</h2><p id="1047" class="pw-post-body-paragraph kp kq hi kr b ks kt is ku kv kw iv kx ky kz la lb lc ld le lf lg lh li lj lk hb bi translated">是时候把所有的碎片放在一起了。我们知道如何加密一个变量文件。我们只需要把所有东西放好就可以使用加密文件了。</p><p id="e6bb" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">我用剧本和清单创建了一个简单的项目。我将加密的变量文件放在我的清单的<code class="du mr ms mt mu b">group_vars</code>中。</p><figure class="jh ji jj jk fd jl"><div class="bz dy l di"><div class="nf ng l"/></div><figcaption class="js jt et er es ju jv bd b be z dx">Ansible Vault — Demo Project</figcaption></figure><p id="a127" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated"><strong class="kr hs">①</strong>var文件用Ansible Vault加密。</p><figure class="jh ji jj jk fd jl"><div class="bz dy l di"><div class="nf ng l"/></div><figcaption class="js jt et er es ju jv bd b be z dx">Ansible Vault — Var File Encrypted</figcaption></figure><p id="d4e7" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated"><strong class="kr hs">①</strong>var文件只包含加密的内容和像算法一样解密文件的数据。</p><p id="18a8" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">②明确的内容在那里作为后面的参考。变量<code class="du mr ms mt mu b">test</code>被定义。</p><p id="0c31" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">宿主文件只是一个清单文件，用来链接<code class="du mr ms mt mu b">group_vars/test</code>变量。</p><figure class="jh ji jj jk fd jl"><div class="bz dy l di"><div class="nf ng l"/></div><figcaption class="js jt et er es ju jv bd b be z dx">Ansible Vault — Host File</figcaption></figure><p id="e3a9" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">最后，我们有了行动手册。剧本只包含一个任务，即在var文件中打印变量。</p><figure class="jh ji jj jk fd jl"><div class="bz dy l di"><div class="nf ng l"/></div><figcaption class="js jt et er es ju jv bd b be z dx">Ansible Vault — Demo Playbook</figcaption></figure><p id="5e64" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated"><strong class="kr hs"> ① </strong>它将在调试消息任务中打印出加密文件中的变量<code class="du mr ms mt mu b">test</code>。</p><p id="e072" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">为了运行剧本并查看加密变量的内容，我们运行以下命令。</p><pre class="jh ji jj jk fd mv mu mw mx aw my bi"><span id="07bc" class="me jy hi mu b fi mz na l nb nc"><em class="nd"># We have to specify the inventory file. We also need to specify <br/># to be asked for the vault password</em><strong class="mu hs"><br/>❯ ansible-playbook --ask-vault-password -i inventories/test playbooks/test.yml</strong></span><span id="a0d1" class="me jy hi mu b fi ne na l nb nc">Vault password:</span><span id="3a73" class="me jy hi mu b fi ne na l nb nc">PLAY [test] ********************************************************************</span><span id="f7f6" class="me jy hi mu b fi ne na l nb nc"><em class="nd"># ①</em><br/>TASK [Debug] ********************************************************************<br/>ok: [0.0.0.0] =&gt; <br/>  test: my super secret password</span><span id="ac03" class="me jy hi mu b fi ne na l nb nc">PLAY RECAP ********************************************************************<br/>0.0.0.0                    : ok=1    changed=0    unreachable=0<br/>                             failed=0    skipped=0    rescued=0<br/>                             ignored=0</span></pre><p id="e34b" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated"><strong class="kr hs"> ① </strong>调试任务从加密的var文件中输出密码。</p><p id="46ef" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">如果你忘记添加选项<code class="du mr ms mt mu b">--ask-vault-password</code>，你会得到以下错误。</p><pre class="jh ji jj jk fd mv mu mw mx aw my bi"><span id="6821" class="me jy hi mu b fi mz na l nb nc"><strong class="mu hs">❯ ansible-playbook -i inventories/test playbooks/test.yml</strong></span><span id="2922" class="me jy hi mu b fi ne na l nb nc">PLAY [test] ********************************************************************ERROR! Attempting to decrypt but no vault secrets found</span></pre><h2 id="4344" class="me jy hi bd jz mf mg mh kd mi mj mk kh ky ml mm kj lc mn mo kl lg mp mq kn ho bi translated">易变保险库摘要</h2><p id="9cd0" class="pw-post-body-paragraph kp kq hi kr b ks kt is ku kv kw iv kx ky kz la lb lc ld le lf lg lh li lj lk hb bi translated">这种方法非常适合处理秘密和密码。这是一个易于使用的金库。只是有一点麻烦，每次我们调用剧本时都要被迫输入密码。</p><p id="cfb9" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">使用<code class="du mr ms mt mu b">--vault-password-file</code>至少有一种可能性，即使用包含明文密码的文件。使用这种技术需要有其他安全机制来避免不允许的人看到密码。</p><p id="5b7f" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">这种机制的主要优点是Ansible中的内置特性。你不必安装和设置额外的东西。对我来说，最大的缺点是必须输入密码或者给出一个密码文件作为参数。</p><p id="ccde" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">还有一种方法可以用Ansible设置默认密码或密码文件。事实上，Ansible文档页面包含了所有的设置信息。</p><div class="nn no ez fb np nq"><a href="https://docs.ansible.com/ansible/latest/user_guide/vault.html#configuring-defaults-for-using-encrypted-content" rel="noopener  ugc nofollow" target="_blank"><div class="nr ab dw"><div class="ns ab nt cl cj nu"><h2 class="bd hs fi z dy nv ea eb nw ed ef hr bi translated">使用Ansible Vault加密内容- Ansible文档</h2><div class="nx l"><h3 class="bd b fi z dy nv ea eb nw ed ef dx translated">Ansible Vault加密变量和文件，因此您可以保护敏感内容，如密码或密钥，而不是…</h3></div><div class="ny l"><p class="bd b fp z dy nv ea eb nw ed ef dx translated">docs.ansible.com</p></div></div><div class="nz l"><div class="oa l ob oc od nz oe jq nq"/></div></div></a></div><h1 id="544f" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ix ki iy kj ja kk jb kl jd km je kn ko bi translated">哈希公司金库</h1><p id="7862" class="pw-post-body-paragraph kp kq hi kr b ks kt is ku kv kw iv kx ky kz la lb lc ld le lf lg lh li lj lk hb bi translated">我一直是像流浪者这样的产品的粉丝。我也在一些任务中使用Terraform。我听说跳马已经很久了。这些产品来自哈希公司。他们建立了一套产品来管理云/混合基础架构。</p><p id="2b9d" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">HashiCorp Vault的承诺是管理秘密和更多，但都与安全存储有关。这个解决方案提供了许多可能性，我鼓励你去看看。在本文中，我将只展示在Vault中使用键-值对存储的简单秘密管理。</p><h2 id="c71a" class="me jy hi bd jz mf mg mh kd mi mj mk kh ky ml mm kj lc mn mo kl lg mp mq kn ho bi translated">装置</h2><p id="1d1a" class="pw-post-body-paragraph kp kq hi kr b ks kt is ku kv kw iv kx ky kz la lb lc ld le lf lg lh li lj lk hb bi translated">我们需要安装哈希公司。在麦克·OS X的领导下，我们可以用<code class="du mr ms mt mu b">homebrew</code>来做到这一点。</p><pre class="jh ji jj jk fd mv mu mw mx aw my bi"><span id="5e79" class="me jy hi mu b fi mz na l nb nc"><em class="nd"># Install the cli tools and the server</em><br/><strong class="mu hs">❯ brew install hashicorp/tap/vault</strong></span></pre><p id="f57d" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated"><strong class="kr hs"> ‼️ </strong> <strong class="kr hs">免责声明:</strong>以下安装和设置步骤是您可以在HashiCorp Vault文档中找到的内容的精简版本。我强烈建议遵循他们的文档，而不是我的。在活动日志中查看我的安装过程😃。</p><p id="1d79" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">安装完成后，您将获得服务器和cli工具。HashiCorp Vault的文档提供了使用Vault的教程。这是一个重要的起点，但是服务器将以<code class="du mr ms mt mu b">dev</code>模式运行，将秘密存储在内存中。停止服务器意味着丢失你存储的秘密。</p><div class="nn no ez fb np nq"><a href="https://learn.hashicorp.com/tutorials/vault/getting-started-intro?in=vault/getting-started" rel="noopener  ugc nofollow" target="_blank"><div class="nr ab dw"><div class="ns ab nt cl cj nu"><h2 class="bd hs fi z dy nv ea eb nw ed ef hr bi translated">跳马简介</h2><div class="nx l"><h3 class="bd b fi z dy nv ea eb nw ed ef dx translated">Vault附带各种称为机密引擎的可插拔组件和身份验证方法，允许您…</h3></div><div class="ny l"><p class="bd b fp z dy nv ea eb nw ed ef dx translated">learn.hashicorp.com</p></div></div><div class="nz l"><div class="of l ob oc od nz oe jq nq"/></div></div></a></div><p id="3b57" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">完成后，我选择了部署保险库的部分。在同一个教程中，您有一个专门的部分来为“real”部署一个Vault。</p><p id="d529" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">我们需要创建一个文件夹来存储Vault数据。</p><pre class="jh ji jj jk fd mv mu mw mx aw my bi"><span id="f261" class="me jy hi mu b fi mz na l nb nc"><em class="nd"># Create the Vault working directory</em><br/><strong class="mu hs">❯ mkdir -p vault/data</strong></span></pre><p id="e1b7" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">在<code class="du mr ms mt mu b">vault</code>目录下，创建下面的配置文件<code class="du mr ms mt mu b">config.hcl</code>。</p><figure class="jh ji jj jk fd jl"><div class="bz dy l di"><div class="nf ng l"/></div><figcaption class="js jt et er es ju jv bd b be z dx">Vault Configuration File</figcaption></figure><p id="0d3f" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">我们准备启动服务器。我们在前台运行服务器，然后命令行提示符被运行的服务器阻塞。</p><pre class="jh ji jj jk fd mv mu mw mx aw my bi"><span id="78ac" class="me jy hi mu b fi mz na l nb nc"><em class="nd"># Start the server with the configuration file specified</em><br/><strong class="mu hs">❯ vault server -config=config.hcl</strong></span><span id="4ff7" class="me jy hi mu b fi ne na l nb nc">WARNING! mlock is not supported on this system! An mlockall(2)-like syscall to<br/>prevent memory from being swapped to disk is not supported on this system. For<br/>better security, only run Vault on systems where this call is supported. If<br/>you are running Vault in a Docker container, provide the IPC_LOCK cap to the<br/>container.<br/>==&gt; Vault server configuration:</span><span id="0d05" class="me jy hi mu b fi ne na l nb nc">Api Address: http://127.0.0.1:8200<br/>                     Cgo: disabled<br/>         Cluster Address: https://127.0.0.1:8201<br/>              Go Version: go1.14.7<br/>              Listener 1: tcp (addr: "127.0.0.1:8200", cluster address: "127.0.0.1:8201", max_request_duration: "1m30s", max_request_size: "33554432", tls: "disabled")<br/>               Log Level: info<br/>                   Mlock: supported: false, enabled: false<br/>           Recovery Mode: false<br/>                 Storage: raft (HA available)<br/>                 Version: Vault v1.5.4<br/>             Version Sha: 1a730771ec70149293efe91e1d283b10d255c6d1</span><span id="9d31" class="me jy hi mu b fi ne na l nb nc">==&gt; Vault server started! Log data will stream in below:</span></pre><p id="83ec" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">警告对我的概念验证并不重要。我不会让它运行太久的。麦克·OS X似乎并不完全支持哈希公司的保险库。它可以使用，但你会失去安全性。文档解释了此警告的原因。</p><div class="nn no ez fb np nq"><a href="https://learn.hashicorp.com/tutorials/vault/getting-started-deploy?in=vault/getting-started#starting-the-server" rel="noopener  ugc nofollow" target="_blank"><div class="nr ab dw"><div class="ns ab nt cl cj nu"><h2 class="bd hs fi z dy nv ea eb nw ed ef hr bi translated">部署保管库</h2><div class="nx l"><h3 class="bd b fi z dy nv ea eb nw ed ef dx translated">到目前为止，您已经与“dev”服务器进行了交互，它会自动解封Vault，设置内存存储…</h3></div><div class="ny l"><p class="bd b fp z dy nv ea eb nw ed ef dx translated">learn.hashicorp.com</p></div></div><div class="nz l"><div class="og l ob oc od nz oe jq nq"/></div></div></a></div><p id="d44a" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">我们需要初始化保险库。要连接到Vault服务器，我们需要配置一个环境变量。Vault cli将使用它来获取目标服务器。</p><pre class="jh ji jj jk fd mv mu mw mx aw my bi"><span id="3dae" class="me jy hi mu b fi mz na l nb nc"><em class="nd"># Run this command or add it to your bash/zsh profile</em><br/><strong class="mu hs">❯ export VAULT_ADDR=</strong><a class="ae jw" href="http://127.0.0.1:8200" rel="noopener ugc nofollow" target="_blank"><strong class="mu hs">http://127.0.0.1:8200</strong></a></span></pre><p id="23a5" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">然后我们可以初始化保险库。</p><p id="f998" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">⚠️ <strong class="kr hs">警告</strong>:在下面的输出中，你会看到我的本地演示解封密钥和根令牌。在我的演示之后，我破坏了我的服务器，密钥和令牌不再有效。<strong class="kr hs">千万不要在网上粘贴敏感信息</strong>。</p><pre class="jh ji jj jk fd mv mu mw mx aw my bi"><span id="5b11" class="me jy hi mu b fi mz na l nb nc"><em class="nd"># The initialisation will create the unseal keys and the root token.</em><br/><strong class="mu hs">❯ vault operator init</strong></span><span id="7a9e" class="me jy hi mu b fi ne na l nb nc">Unseal Key 1: 43w3kecmIM62Zlmg3OzEkR3vcFWavPXOSo9R5hSorNMG<br/>Unseal Key 2: sfdRpD2vYSeWbDD+pd4RT+2cuh+g7s4blUzhzm/FKoxZ<br/>Unseal Key 3: 026gP9barUPvsOH8AL7p/UMYqb2XLYT0m562tItcdjmf<br/>Unseal Key 4: XCFT60P4zWq6tFbSSb1RRjsjumt/iZGQ32Ei4Wni9q6m<br/>Unseal Key 5: uM2YN7oAMXDi9AgOqJbBndvamP9SZIHfWE5FEZjK1RlU</span><span id="f841" class="me jy hi mu b fi ne na l nb nc">Initial Root Token: s.KQ6acXT29MpSHzMqTAw4c51O</span><span id="15b0" class="me jy hi mu b fi ne na l nb nc">Vault initialized with 5 key shares and a key threshold of 3. Please securely<br/>distribute the key shares printed above. When the Vault is re-sealed,<br/>restarted, or stopped, you must supply at least 3 of these keys to unseal it<br/>before it can start servicing requests.</span><span id="0a6b" class="me jy hi mu b fi ne na l nb nc">Vault does not store the generated master key. Without at least 3 key to<br/>reconstruct the master key, Vault will remain permanently sealed!</span><span id="dfb3" class="me jy hi mu b fi ne na l nb nc">It is possible to generate new unseal keys, provided you have a quorum of<br/>existing unseal keys shares. See "vault operator rekey" for more information.</span></pre><h2 id="0669" class="me jy hi bd jz mf mg mh kd mi mj mk kh ky ml mm kj lc mn mo kl lg mp mq kn ho bi translated">验证安装</h2><p id="88fc" class="pw-post-body-paragraph kp kq hi kr b ks kt is ku kv kw iv kx ky kz la lb lc ld le lf lg lh li lj lk hb bi translated">是时候开启金库了。要打开保险库，我们需要5把钥匙中的3把。这背后的想法是在5个人之间共享密钥。需要5个人中的3个人才能打开保险库。避免独一无二的人启封金库，这是一个有趣的概念。</p><pre class="jh ji jj jk fd mv mu mw mx aw my bi"><span id="fd01" class="me jy hi mu b fi mz na l nb nc"><em class="nd"># We run three times the command to unseal the Vault</em><br/><strong class="mu hs">❯ vault operator unseal</strong></span><span id="6daa" class="me jy hi mu b fi ne na l nb nc">Unseal Key (will be hidden): &lt;key 1&gt;<br/>Key                Value<br/>---                -----<br/>Seal Type          shamir<br/>Initialized        true<br/>Sealed             true<br/>Total Shares       5<br/>Threshold          3<br/>Unseal Progress    1/3<br/>Unseal Nonce       adabe581-5284-bf2d-7aca-2952338eefd8<br/>Version            1.5.4<br/>HA Enabled         true</span><span id="d9b3" class="me jy hi mu b fi ne na l nb nc"><strong class="mu hs">❯ vault operator unseal</strong></span><span id="03bf" class="me jy hi mu b fi ne na l nb nc">Unseal Key (will be hidden): &lt;key 2&gt;<br/>Key                Value<br/>---                -----<br/>Seal Type          shamir<br/>Initialized        true<br/>Sealed             true<br/>Total Shares       5<br/>Threshold          3<br/>Unseal Progress    2/3<br/>Unseal Nonce       adabe581-5284-bf2d-7aca-2952338eefd8<br/>Version            1.5.4<br/>HA Enabled         true</span><span id="d386" class="me jy hi mu b fi ne na l nb nc"><strong class="mu hs">❯ vault operator unseal</strong><br/>Unseal Key (will be hidden): &lt;key 3&gt;<br/>Key                     Value<br/>---                     -----<br/>Seal Type               shamir<br/>Initialized             true<br/>Sealed                  false<br/>Total Shares            5<br/>Threshold               3<br/>Version                 1.5.4<br/>Cluster Name            vault-cluster-23bf4fd7<br/>Cluster ID              d4fd02c6-8935-8f50-4a6d-d445444249a8<br/>HA Enabled              true<br/>HA Cluster              n/a<br/>HA Mode                 standby<br/>Active Node Address     &lt;none&gt;<br/>Raft Committed Index    24<br/>Raft Applied Index      24</span></pre><p id="8f12" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">如果您尝试在存储库密封时登录，将会出现以下错误。</p><pre class="jh ji jj jk fd mv mu mw mx aw my bi"><span id="b198" class="me jy hi mu b fi mz na l nb nc"><em class="nd"># Login attempt on a sealed Vault</em><br/><strong class="mu hs">❯ vault login &lt;token&gt;</strong></span><span id="b143" class="me jy hi mu b fi ne na l nb nc">Error authenticating: error looking up token: Error making API request.</span><span id="4003" class="me jy hi mu b fi ne na l nb nc">URL: GET <a class="ae jw" href="http://127.0.0.1:8200/v1/auth/token/lookup-self" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:8200/v1/auth/token/lookup-self</a><br/>Code: 503. Errors:</span><span id="fef9" class="me jy hi mu b fi ne na l nb nc">* Vault is sealed</span></pre><p id="2bd1" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">登录以解封保管库</p><pre class="jh ji jj jk fd mv mu mw mx aw my bi"><span id="5078" class="me jy hi mu b fi mz na l nb nc"><em class="nd"># Login on an unsealed Vault</em><br/><strong class="mu hs">❯ vault login &lt;token&gt;</strong></span><span id="790f" class="me jy hi mu b fi ne na l nb nc">Success! You are now authenticated. The token information displayed below<br/>is already stored in the token helper. You do NOT need to run "vault login"<br/>again. Future Vault requests will automatically use this token.</span><span id="de75" class="me jy hi mu b fi ne na l nb nc">Key                  Value<br/>---                  -----<br/>token                &lt;token&gt;<br/>token_accessor       &lt;tokenAccessor&gt;<br/>token_duration       ∞<br/>token_renewable      false<br/>token_policies       ["root"]<br/>identity_policies    []<br/>policies             ["root"]</span></pre><p id="1a0e" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">我们准备好创造我们的秘密。我们启用一个秘密引擎来存储凭证。</p><pre class="jh ji jj jk fd mv mu mw mx aw my bi"><span id="3446" class="me jy hi mu b fi mz na l nb nc"><em class="nd"># Enable key value engine on the path ansible</em><br/><strong class="mu hs">❯ vault secrets enable -path=ansible kv</strong></span><span id="f9c8" class="me jy hi mu b fi ne na l nb nc">Success! Enabled the kv secrets engine at: ansible/</span></pre><p id="b47a" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">我们准备好储存我们的第一个秘密。让我们开始吧。</p><pre class="jh ji jj jk fd mv mu mw mx aw my bi"><span id="13f1" class="me jy hi mu b fi mz na l nb nc"><em class="nd"># We write the "password" with identifier "test" into a folder "demo"</em><br/><strong class="mu hs">❯ vault kv put ansible/demo test=password</strong></span><span id="ebe5" class="me jy hi mu b fi ne na l nb nc">Success! Data written to: ansible/demo</span></pre><p id="dc97" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">要读取数据，使用<code class="du mr ms mt mu b">get</code>命令。</p><pre class="jh ji jj jk fd mv mu mw mx aw my bi"><span id="0649" class="me jy hi mu b fi mz na l nb nc"><em class="nd"># Read command</em><br/><strong class="mu hs">❯ vault kv get  ansible/demo</strong></span><span id="bf60" class="me jy hi mu b fi ne na l nb nc">==== Data ====<br/>Key     Value<br/>---     -----<br/>test    password</span></pre><h2 id="0c56" class="me jy hi bd jz mf mg mh kd mi mj mk kh ky ml mm kj lc mn mo kl lg mp mq kn ho bi translated">HashiCorp金库和Ansible一起</h2><p id="578e" class="pw-post-body-paragraph kp kq hi kr b ks kt is ku kv kw iv kx ky kz la lb lc ld le lf lg lh li lj lk hb bi translated">将HashiCorp Vault集成到Ansible的一切都已就绪。有两种集成方式:</p><ul class=""><li id="fff2" class="lq lr hi kr b ks ll kv lm ky ls lc lt lg lu lk lv lw lx ly bi translated">在Ansible内部使用HashiCorp Vault</li><li id="6643" class="lq lr hi kr b ks lz kv ma ky mb lc mc lg md lk lv lw lx ly bi translated">从Ansible管理HashiCorp Vault。</li></ul><p id="aad9" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">我们需要使用从哈希公司保险库取回的秘密。<code class="du mr ms mt mu b">community.general</code>集合中的官方查找插件正是我们消费秘密所需要的。</p><p id="db01" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">使用HashiCorp Vault的演示项目的结构与我用于Ansible Vault的结构大致相同。我刚刚扔掉了<code class="du mr ms mt mu b">group_vars</code>文件夹。</p><figure class="jh ji jj jk fd jl"><div class="bz dy l di"><div class="nf ng l"/></div><figcaption class="js jt et er es ju jv bd b be z dx">HashiCorp Ansible Demo Project Structure</figcaption></figure><p id="c478" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">演示HashiCorp Vault用法的剧本非常简单。它只包含一个带有查找的调试任务。</p><figure class="jh ji jj jk fd jl"><div class="bz dy l di"><div class="nf ng l"/></div></figure><p id="f650" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated"><strong class="kr hs"> ① </strong>查找任务使用<code class="du mr ms mt mu b">hashi_vault</code>插件。我们指定秘密的路径、认证令牌和要连接的URL。</p><p id="5e6a" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">查找插件的文档显示了检索机密的可用选项。还可以使用环境变量来设置身份验证令牌和URL。它将避免在每个查找语句中指定。</p><div class="nn no ez fb np nq"><a href="https://docs.ansible.com/ansible/latest/collections/community/general/hashi_vault_lookup.html" rel="noopener  ugc nofollow" target="_blank"><div class="nr ab dw"><div class="ns ab nt cl cj nu"><h2 class="bd hs fi z dy nv ea eb nw ed ef hr bi translated">community.general.hashi_vault -从HashiCorp的vault - Ansible文档中检索机密</h2><div class="nx l"><h3 class="bd b fi z dy nv ea eb nw ed ef dx translated">注意env:AWS_SECRET_ACCESS_KEY对应于访问密钥的AWS秘密密钥。别名:aws_secret_access_key…</h3></div><div class="ny l"><p class="bd b fp z dy nv ea eb nw ed ef dx translated">docs.ansible.com</p></div></div><div class="nz l"><div class="oh l ob oc od nz oe jq nq"/></div></div></a></div><p id="a501" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">然后，我们可以运行剧本，看看集成是如何工作的。</p><pre class="jh ji jj jk fd mv mu mw mx aw my bi"><span id="2259" class="me jy hi mu b fi mz na l nb nc"><em class="nd"># Run the playbook with the inventory specified</em><br/><strong class="mu hs">❯ ansible-playbook -i inventories/test playbooks/test.yml</strong></span><span id="b166" class="me jy hi mu b fi ne na l nb nc">PLAY [test] ********************************************************************</span><span id="5624" class="me jy hi mu b fi ne na l nb nc"># <strong class="mu hs">①</strong><br/>TASK [Debug] ********************************************************************<br/>ok: [0.0.0.0] =&gt; <br/>  msg:<br/>    test: password</span><span id="eedf" class="me jy hi mu b fi ne na l nb nc">PLAY RECAP ********************************************************************<br/>0.0.0.0                    : ok=1    changed=0    unreachable=0   <br/>                             failed=0    skipped=0    rescued=0   <br/>                             ignored=0</span></pre><p id="daff" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated"><strong class="kr hs"> ① </strong>调试任务的输出是结构化数据。这意味着我们取回了一个物体。事实上，存储在Vault中的数据可以是多键/值对。</p><p id="09d3" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">要从对象中获取特定的数据，可以像这样使用查找插件。添加密钥<code class="du mr ms mt mu b">:test</code>将只获得我们正在寻找的密码的值。</p><pre class="jh ji jj jk fd mv mu mw mx aw my bi"><span id="ef54" class="me jy hi mu b fi mz na l nb nc">{{ lookup('hashi_vault', 'ansible/demo:test ...) }}</span></pre><p id="e1f3" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">输出将会是。</p><pre class="jh ji jj jk fd mv mu mw mx aw my bi"><span id="8acc" class="me jy hi mu b fi mz na l nb nc">TASK [Debug] ********************************************************************<br/>ok: [0.0.0.0] =&gt; <br/>  msg: password</span></pre><h2 id="8943" class="me jy hi bd jz mf mg mh kd mi mj mk kh ky ml mm kj lc mn mo kl lg mp mq kn ho bi translated">哈希公司保险库摘要</h2><p id="6305" class="pw-post-body-paragraph kp kq hi kr b ks kt is ku kv kw iv kx ky kz la lb lc ld le lf lg lh li lj lk hb bi translated">我对哈希公司的金库没什么经验。对于简单的用例，它似乎很容易使用和管理。与Ansible的集成并不比使用Ansible Vault更复杂。这两种解决方案配合得很好。</p><p id="16aa" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">在我看来，HashiCorp Vault集成了许多管理秘密(短暂秘密)的解决方案。这比那里介绍的其他两种解决方案要先进得多。</p><h1 id="1494" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ix ki iy kj ja kk jb kl jd km je kn ko bi translated">结论</h1><p id="00cd" class="pw-post-body-paragraph kp kq hi kr b ks kt is ku kv kw iv kx ky kz la lb lc ld le lf lg lh li lj lk hb bi translated">在本文中，我们探索了3种不同的解决方案来存储机密并在Ansible中使用它们。</p><ul class=""><li id="13dd" class="lq lr hi kr b ks ll kv lm ky ls lc lt lg lu lk lv lw lx ly bi translated">基于GPG的定制解决方案</li><li id="db7e" class="lq lr hi kr b ks lz kv ma ky mb lc mc lg md lk lv lw lx ly bi translated">Ansible Vault解决方案</li><li id="cdd8" class="lq lr hi kr b ks lz kv ma ky mb lc mc lg md lk lv lw lx ly bi translated">哈希公司金库解决方案</li></ul><p id="db18" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">对我来说，没有最好的解决方案。这始终是一个需要解决的权衡和用例的问题。例如，对于您完全信任运行Ansible的计算机的环境，GPG解决方案是可以接受的。它将允许您使用密钥管理秘密，而不必在每次运行剧本时输入密码。</p><p id="6014" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">Ansible Vault的解决方案也很简单，最重要的是嵌入在Ansible中。它不需要任何额外的设置。它可以在任何现成的计算机上运行。您也可以将Ansible Vault文件存储在库存的存储库中。</p><p id="d32f" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">最后，HashiCorp Vault需要更多的设置(尤其是生产设置)来安装和维护。此外，它还带来了最先进的功能和可能性。它与Ansible配合得很好。</p><p id="20ac" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">最终，由您来选择最符合您需求的解决方案。在我的情况下，我会继续使用HashiCorp Vault来发现关于这个工具的更多信息。</p><h1 id="aae2" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ix ki iy kj ja kk jb kl jd km je kn ko bi translated">参考</h1><p id="aa7a" class="pw-post-body-paragraph kp kq hi kr b ks kt is ku kv kw iv kx ky kz la lb lc ld le lf lg lh li lj lk hb bi translated">GPG和GPG套件工具。</p><div class="nn no ez fb np nq"><a href="https://gnupg.org/" rel="noopener  ugc nofollow" target="_blank"><div class="nr ab dw"><div class="ns ab nt cl cj nu"><h2 class="bd hs fi z dy nv ea eb nw ed ef hr bi translated">GNU隐私卫士</h2><div class="nx l"><h3 class="bd b fi z dy nv ea eb nw ed ef dx translated">GnuPG是由RFC4880(也称为PGP)定义的OpenPGP标准的完整免费实现。GnuPG…</h3></div><div class="ny l"><p class="bd b fp z dy nv ea eb nw ed ef dx translated">gnupg.org</p></div></div><div class="nz l"><div class="oi l ob oc od nz oe jq nq"/></div></div></a></div><div class="nn no ez fb np nq"><a href="https://gpgtools.org/" rel="noopener  ugc nofollow" target="_blank"><div class="nr ab dw"><div class="ns ab nt cl cj nu"><h2 class="bd hs fi z dy nv ea eb nw ed ef hr bi translated">GPG套房</h2><div class="nx l"><h3 class="bd b fi z dy nv ea eb nw ed ef dx translated">GPG套件包括30天的GPG邮件试用。要继续使用GPG邮件，请购买支持计划使用GPG…</h3></div><div class="ny l"><p class="bd b fp z dy nv ea eb nw ed ef dx translated">gpgtools.org</p></div></div><div class="nz l"><div class="oj l ob oc od nz oe jq nq"/></div></div></a></div><p id="7639" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">Ansible Vault文档</p><div class="nn no ez fb np nq"><a href="https://docs.ansible.com/ansible/latest/user_guide/vault.html" rel="noopener  ugc nofollow" target="_blank"><div class="nr ab dw"><div class="ns ab nt cl cj nu"><h2 class="bd hs fi z dy nv ea eb nw ed ef hr bi translated">使用Ansible Vault加密内容- Ansible文档</h2><div class="nx l"><h3 class="bd b fi z dy nv ea eb nw ed ef dx translated">Ansible Vault加密变量和文件，因此您可以保护敏感内容，如密码或密钥，而不是…</h3></div><div class="ny l"><p class="bd b fp z dy nv ea eb nw ed ef dx translated">docs.ansible.com</p></div></div><div class="nz l"><div class="ok l ob oc od nz oe jq nq"/></div></div></a></div><p id="6221" class="pw-post-body-paragraph kp kq hi kr b ks ll is ku kv lm iv kx ky ln la lb lc lo le lf lg lp li lj lk hb bi translated">哈希公司金库</p><div class="nn no ez fb np nq"><a href="https://www.vaultproject.io/" rel="noopener  ugc nofollow" target="_blank"><div class="nr ab dw"><div class="ns ab nt cl cj nu"><h2 class="bd hs fi z dy nv ea eb nw ed ef hr bi translated">哈希公司跳马</h2><div class="nx l"><h3 class="bd b fi z dy nv ea eb nw ed ef dx translated">Vault保护、存储并严格控制对令牌、密码、证书、API密钥和其他机密的访问…</h3></div><div class="ny l"><p class="bd b fp z dy nv ea eb nw ed ef dx translated">www.vaultproject.io</p></div></div><div class="nz l"><div class="ol l ob oc od nz oe jq nq"/></div></div></a></div></div></div>    
</body>
</html>