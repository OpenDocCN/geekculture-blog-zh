<html>
<head>
<title>Testing React MobX store? Cypress made it easy!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">测试React MobX store？赛普拉斯让它变得简单！</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/testing-mobx-store-with-react-cypress-made-it-easy-abc5b1571320?source=collection_archive---------14-----------------------#2021-06-24">https://medium.com/geekculture/testing-mobx-store-with-react-cypress-made-it-easy-abc5b1571320?source=collection_archive---------14-----------------------#2021-06-24</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/7b6a9c49dd879f0ece05357d50a32663.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mrxyOG-m1KGwlu62ywxfrA.png"/></div></div></figure><p id="dacc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这篇博文假设你已经<a class="ae jo" href="https://on.cypress.io/installing-cypress" rel="noopener ugc nofollow" target="_blank">安装了Cypress </a>，理解了react术语和状态管理机制。现在，如果你是一个不喜欢阅读的人，让我成为你的<a class="ae jo" href="https://marvelcinematicuniverse.fandom.com/wiki/Heimdall" rel="noopener ugc nofollow" target="_blank">海姆达尔</a>，打开<a class="ae jo" href="https://github.com/abhinaba-ghosh/cypress-react-mobx-component-testing" rel="noopener ugc nofollow" target="_blank">源代码</a>的入口。</p><h2 id="3cc5" class="jp jq hi bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">可爱的小反应应用程序</h2><p id="e700" class="pw-post-body-paragraph iq ir hi is b it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj ko jl jm jn hb bi translated">没有强大的ToDoList应用程序，任何演示都不会成功。别怪我，我有开发商迷信。</p><p id="9995" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该应用相当简单，由基本组件组成——接收用户输入的<Form/>组件、显示用户输入的<List/>组件和显示手头实时任务的任务<ListCounter/>组件。组件的源代码可以在<a class="ae jo" href="https://github.com/abhinaba-ghosh/cypress-react-mobx-component-testing/tree/main/src/components" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><figure class="kq kr ks kt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kp"><img src="../Images/1cf0501e7fff31090986c266fe445ee5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*hocAi13On58aDkYE0h6l_Q.gif"/></div></div></figure><p id="39c0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">有趣的事实！我相当懒，所以不要期望组件有任何花哨的样式。</p><h2 id="1e17" class="jp jq hi bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">Mobx的味道</h2><p id="fea9" class="pw-post-body-paragraph iq ir hi is b it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj ko jl jm jn hb bi translated"><code class="du ku kv kw kx b"><a class="ae jo" href="https://github.com/mobxjs/mobx" rel="noopener ugc nofollow" target="_blank">MobX</a></code>是一个可扩展的状态管理解决方案。如果你已经对Redux中的小规模应用程序的大量样板文件感到沮丧，那么试试MobX吧。我并不是说样板文件是你选择redux的唯一障碍。它也是一个很棒的图书馆。只是我容易受挫！嘿，redux vs mobx也不在本文的讨论范围之内，如果你感兴趣的话，可以看看史诗般的战斗。</p><p id="4bd3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">长话短说，MobX使用可观察的值、改变这些值的动作和对这些变化做出响应的反应函数来操作。</p><p id="d46f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们的商店相当简单。它观察项目，并根据用户对ToDo列表的操作采取行动。因此，当用户更新表单时，MobX将自动跟踪可观察的字段(items ),并根据用户输入采取行动(addItem/deleteItem)。<a class="ae jo" href="https://github.com/abhinaba-ghosh/cypress-react-mobx-component-testing/blob/aafea87afb85156dae168a3f39fee5155831fe72/src/App.js#L12" rel="noopener ugc nofollow" target="_blank">在应用入口点</a>，我们将应用组件与商店提供商绑定。provider组件省去了我们手动将store实例作为道具发送给每个组件的麻烦。</p><figure class="kq kr ks kt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ky"><img src="../Images/a3d784ccd120bc2fc05b9cb05b6dcb01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nYxl3ZGVy8mfFysgDnbW_w.png"/></div></div></figure><h2 id="16d7" class="jp jq hi bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">配置Cypress组件测试样板</h2><p id="d0ad" class="pw-post-body-paragraph iq ir hi is b it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj ko jl jm jn hb bi translated"><a class="ae jo" href="https://mobx.js.org/enabling-decorators.html" rel="noopener ugc nofollow" target="_blank"> MobX decorators </a>是一个未来派的特性，利用babel transpiler使代码浏览器可读。我使用了一个定制的<a class="ae jo" href="https://github.com/abhinaba-ghosh/cypress-react-mobx-component-testing/blob/main/webpack.config.js" rel="noopener ugc nofollow" target="_blank"> webpack配置</a>来添加特定的<code class="du ku kv kw kx b">babel-loader</code>规则。</p><p id="b0e0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae jo" href="https://www.cypress.io/blog/2021/04/06/cypress-component-testing-react/" rel="noopener ugc nofollow" target="_blank"> @cypress/react </a>库帮助你隔离测试react组件。它是开发单元和集成测试的可行解决方案之一。它安装目标组件并在浏览器环境中执行测试。最后，有一个更接近浏览器环境运行隔离测试的解决方案。</p><p id="b350" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">安装所需的依赖项-</p><pre class="kq kr ks kt fd kz kx la lb aw lc bi"><span id="b1e7" class="jp jq hi kx b fi ld le l lf lg">npm i -D @cypress/react @cypress/webpack-dev-server html-webpack-plugin webpack-dev-server webpack</span></pre><p id="8b86" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">由于我们使用定制的webpack配置，我们需要在调用cypress <code class="du ku kv kw kx b">dev-derver</code>时传递webpack和babel配置。快一点！让我们配置一下<code class="du ku kv kw kx b">cypress/plugins/index.js</code></p><figure class="kq kr ks kt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lh"><img src="../Images/a436da128d8dc2560abd2fe96b619e72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VJqrfGzQqu3NWCVgND0UqA.png"/></div></div></figure><p id="72c0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您需要指定的最后一件事是组件测试的位置。Cypress强制我们在组件本身所在的文件夹中编写组件测试。这就是我们的cypress配置在这个演示中的样子。</p><figure class="kq kr ks kt fd ij"><div class="bz dy l di"><div class="li lj l"/></div></figure><h2 id="3368" class="jp jq hi bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">用柏树测试商店</h2><p id="06ee" class="pw-post-body-paragraph iq ir hi is b it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj ko jl jm jn hb bi translated">在实际情况下，你可能需要验证一个部件与悬挂物或悬挂物之间的集成效果。考虑一个糟糕的sprint，其中负责开发<Form/>组件的团队没有交付组件(因为一个连线的阻断器。我知道，它发生了！).但是另一个团队交付了<ToDoLis/>组件。您应该为商店和列表组件编写集成测试。赛普拉斯，作为一个好朋友，可以在这里为你撑腰。</p><p id="705c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用@cypress/react挂载组件后，可以在Cypress的窗口实例中公开商店。</p><figure class="kq kr ks kt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lk"><img src="../Images/63a777471ab5d6c90c392156721d7857.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vx9ufM-OEv_dOPjgU4apNw.png"/></div></div></figure><p id="fe03" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，您可以通过cypress浏览器上下文访问store实例了。</p><pre class="kq kr ks kt fd kz kx la lb aw lc bi"><span id="de41" class="jp jq hi kx b fi ld le l lf lg">cy.window().its('store')</span></pre><p id="5f82" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以直接调用存储特定的可操作可执行文件，MobX将使用观察到的更改更新存储。</p><figure class="kq kr ks kt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ll"><img src="../Images/28438ad40dae6a8c3da6ad0066cb6172.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TZaARFET6YwZbjpRx7Jbxw.png"/></div></div></figure><p id="37b3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您还可以选择获取<code class="du ku kv kw kx b">computed</code>字段来断言所采取的动作。</p><figure class="kq kr ks kt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lm"><img src="../Images/9d8882c713ab535433407d8fbcb4adc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t9TO6HcmkzWveYQjOB1UqQ.png"/></div></div></figure><p id="1124" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，坐好，放松，让赛普勒斯表演所有的魔术-</p><figure class="kq kr ks kt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ln"><img src="../Images/a2ddeb1c67bad04947bc69cae691b9ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*wMeiLGRILplooq5dKXz0yg.gif"/></div></div></figure><p id="b8da" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你可以清楚地看到，我们正在通过调用MObX的内部动作来验证<List/>组件的结果。完全没有<Form/>成分。如果这没有让你吃惊，还有什么会让你吃惊呢？</p><h2 id="d94b" class="jp jq hi bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">我们可以对Mobx商店进行快照测试吗？</h2><p id="7388" class="pw-post-body-paragraph iq ir hi is b it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj ko jl jm jn hb bi translated">快照测试是评估嵌套对象变化的简单方法。当测试第一次运行时，它会呈现给定的组件，并将输出存储在与代码一起提交的快照文件中。每次重新运行测试时，都会将新的输出与存储的版本进行比较。如果两个版本不同，会显示一个<code class="du ku kv kw kx b">diff</code>，用户可以选择用新的输出更新已提交的快照文件。</p><p id="6638" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">快照测试已经席卷了JavaScript单元测试世界。快照测试是快速测试MobX存储嵌套计算值的非常方便的工具。这将避免您在嵌套的状态对象中创建样板代码和深层断言。</p><p id="e34c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我将利用<a class="ae jo" href="https://github.com/meinaart" rel="noopener ugc nofollow" target="_blank"> Meinaart van Straalen </a>的精彩插件<a class="ae jo" href="https://github.com/meinaart/cypress-plugin-snapshots" rel="noopener ugc nofollow" target="_blank">cypress-snapshot-plugin</a>进行演示。</p><p id="aa5c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">第一步，您需要将插件作为开发依赖项添加到您的项目中</p><pre class="kq kr ks kt fd kz kx la lb aw lc bi"><span id="3cae" class="jp jq hi kx b fi ld le l lf lg">npm i -D cypress-snapshot-plugin</span></pre><p id="e5e0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">加载<code class="du ku kv kw kx b">cypress/plugins/index.js</code>文件中的插件-</p><figure class="kq kr ks kt fd ij"><div class="bz dy l di"><div class="li lj l"/></div></figure><p id="f19a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">另外，你需要参考来自<code class="du ku kv kw kx b">cypress/support/index.js</code>文件的插件-</p><pre class="kq kr ks kt fd kz kx la lb aw lc bi"><span id="0aab" class="jp jq hi kx b fi ld le l lf lg">import 'cypress-plugin-snapshots/commands';</span></pre><p id="762d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，棘手的部分来了，当我们使用cypress-webpack-dev服务器捆绑应用程序并在浏览器环境中运行测试时，要使用这个神奇的插件，您需要进行一些额外的配置。如果您迁移到Webpack 5，您需要从<code class="du ku kv kw kx b">webpack.config.js</code>的适当的<code class="du ku kv kw kx b">plugins</code>部分添加一个引用<code class="du ku kv kw kx b">process/browser</code>，并为<code class="du ku kv kw kx b">crypto</code>添加browserify别名。</p><figure class="kq kr ks kt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lo"><img src="../Images/4412e34ee09f0836db7d9a8a9c447d34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d3h5Y2FRxAtPlViVsPdScA.png"/></div></div></figure><p id="7878" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在你已经准备好了！让我们编写第一个快照测试。</p><figure class="kq kr ks kt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lp"><img src="../Images/faa799ecd3b5f8bc2e988a4a218caf5f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wIIvS7luP7-jORxhB8Vl7A.png"/></div></div></figure><p id="0b0a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以清楚地看到快照测试带来的好处。在真实世界的大规模应用程序中，您将处理更复杂的嵌套对象，并断言正确的结果。快照机制会将该对象与先前存储的对象进行比较。它又快又省事。</p><p id="0b0b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，如果对象的状态被更新了会发生什么？</p><p id="ae05" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">显然，测试会失败。它用先前拍摄的快照来验证新的状态参考，并且存在差异。</p><figure class="kq kr ks kt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lq"><img src="../Images/15b3f01317133e877356f3d97a0bc5a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0HOj0Wo30zjR5RSCZDRmvg.png"/></div></div></figure><p id="bf24" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你必须确认这种差异是否是你想要的。如果没有，是时候关掉你的手机，开始讨厌的调试会话了。但是如果需要区别，您必须手动更新快照！</p><p id="f035" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">开个玩笑！Cypress将帮助您管理快照，只需点击一个按钮。点击<code class="du ku kv kw kx b">COMPARE SNAPSHOT</code>图标，然后点击<code class="du ku kv kw kx b">update snapshot</code>。仅此而已，真的。</p><figure class="kq kr ks kt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lr"><img src="../Images/c91cc84cba25f05ce5007e0419fecc33.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ljooSMtTswcoC_LpBi7TKw.png"/></div></div></figure><p id="8eff" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用cypress进行快照测试的整个开发体验非常有趣。如果您还没有尝试过，请尝试一下。</p><h2 id="7be2" class="jp jq hi bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">停车场！</h2><p id="f5e0" class="pw-post-body-paragraph iq ir hi is b it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj ko jl jm jn hb bi translated">我们生活在开源世界中，作为一个人，为任何问题寻找更简单、更有效的解决方案是我们的特点。关键是，MobX商店可以通过多种可能的方式进行测试。但是，如果您喜欢活在当下，并且想要测试更接近浏览器环境的应用程序及其基本组件，Cypress确实为您释放了可能性。我很想听听你的想法。</p><p id="8736" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">测试愉快！</p></div></div>    
</body>
</html>