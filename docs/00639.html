<html>
<head>
<title>Deploying Java/Spring Apps to Multiple Clouds with Kubernetes Cloud Manager</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Kubernetes云管理器将Java/Spring应用部署到多个云中</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/deploying-java-spring-apps-to-multiple-clouds-with-kubernetes-cloud-manager-87cc61275cb0?source=collection_archive---------21-----------------------#2021-03-08">https://medium.com/geekculture/deploying-java-spring-apps-to-multiple-clouds-with-kubernetes-cloud-manager-87cc61275cb0?source=collection_archive---------21-----------------------#2021-03-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="98ad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">能够轻松地将应用程序和工作负载部署到多个云中，这为您提供了灵活性和选择自由。您可以避免被云供应商锁定，持续购买低成本基础架构，随意迁移工作负载和数据，并在面对不断变化的提供商政策和临时决策时保持完全控制。在工程层面，对开发和运营实施多集群和多云方法也有好处。它增加了系统的可靠性和可伸缩性，促进了良好的架构设计实践，并强化了可移植性思维。</p><p id="da6d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一般来说，要真正做好多云准备，您需要两件事情:使用工具和运行时，为您提供跨不同云部署和管理工作负载的统一方法；并最小化或隔离对提供商特定服务的依赖性(例如，通过使用可部署在任何云中的便携式中间件服务，和/或通过使用隐藏提供商特定API的中间层)。在本文中，我将重点关注第一个需求。具体来说，我将展示如何使用<strong class="ih hj">Kubernetes Cloud Manager</strong><em class="jd">PaaS</em>在多个云中以完全统一的方式轻松部署和配置<strong class="ih hj"> Java </strong> / <strong class="ih hj"> SpringBoot </strong>应用程序。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/c45707c740807b035437cca41c0c96fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SFCwpdQF0sa288Y06PtjXg.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx"><strong class="bd ju">Deploying to Mutiple Clouds with Cloud Manager</strong></figcaption></figure><h1 id="a3d9" class="jv jw hi bd ju jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">贸易工具</h1><h2 id="7400" class="ks jw hi bd ju kt ku kv ka kw kx ky ke iq kz la ki iu lb lc km iy ld le kq lf bi translated">该应用程序</h2><p id="9086" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">多云努力的第一步是从一个应用程序开始。如果您已经有了一个带有Java后端的web应用程序，那么您可以按照我下面给出的提示和步骤来使用它。<br/>如果你没有，那么你有两个选择:使用其他人构建的示例项目，例如<strong class="ih hj"> EInnovator </strong>的<em class="jd">Startup Factory</em><a class="ae ll" href="https://einnovator.github.io/mvp-samples-catalog/" rel="noopener ugc nofollow" target="_blank">MVP/Samples目录</a>中的一个示例或MVP项目，或者用快速向导创建一个新项目，例如<a class="ae ll" href="https://start.spring.io/" rel="noopener ugc nofollow" target="_blank"> Spring Boot初始化器</a>。</p><p id="1a42" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在下面的例子中，我使用了示例应用程序<em class="jd">超级英雄</em>，其源代码可以在一个公共<a class="ae ll" href="https://github.com/einnovator/einnovator-sample-movies" rel="noopener ugc nofollow" target="_blank"> GitHub存储库</a>中获得，带有<a class="ae ll" href="https://www.apache.org/licenses/LICENSE-2.0" rel="noopener ugc nofollow" target="_blank"> Apache许可证</a>，并预先构建在一个<strong class="ih hj"> DockerHub </strong> <a class="ae ll" href="https://hub.docker.com/repository/docker/einnovator/einnovator-sample-superheros" rel="noopener ugc nofollow" target="_blank">映像存储库</a>中。对于您自己的应用程序，我假设您有一个<strong class="ih hj"> Docker </strong>图像。如果你没有，看看我之前发布的这篇文章，看看你如何用CI/CD管道为你的Java/Spring应用程序构建Docker镜像。</p><h2 id="df77" class="ks jw hi bd ju kt ku kv ka kw kx ky ke iq kz la ki iu lb lc km iy ld le kq lf bi translated">旋转库贝内特斯星团</h2><p id="3771" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">由于我们的目标是将一个应用部署到多个云提供商的多个集群中，显然下一步是供应集群。如今有很多云提供商允许你只需按一下按钮就可以运行一个<strong class="ih hj"> Kubernetes </strong>集群。对于低成本的实验和操作，我建议使用<strong class="ih hj"> DigitalOcean </strong>、<strong class="ih hj"> Linode </strong>和/或<strong class="ih hj"> Scaleway </strong>，或者受益于一些其他提供商提供的免费试用期，您可以考虑:<strong class="ih hj"> GCP </strong>、<strong class="ih hj"> AWS </strong>、<strong class="ih hj"> Azure </strong>、<strong class="ih hj"> IBM </strong>和<strong class="ih hj"> Oracle </strong>。</p><p id="5091" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">UX/用户界面详细说明了如何根据提供商供应集群。不过，最终结果应该是一样的——您将拥有一个<strong class="ih hj"> Kubernetes </strong>集群，其中有一个或多个虚拟机/节点可用于部署应用程序。对于每个集群，下载<em class="jd"> kubeconfig </em>配置文件，并用不同的文件名保存在您的本地文件系统中。这是一个YAML文件，描述了主服务器URL和对群集的访问凭据。各种工具都可以使用这个文件，包括:<code class="du lm ln lo lp b">kubectl</code>(<strong class="ih hj">Kubernetes</strong>native CLI)和<code class="du lm ln lo lp b">ei</code>(<strong class="ih hj">Kubernetes Cloud Manager</strong>CLI)，也可以上传到<strong class="ih hj"> Cloud Manager </strong> UI。</p><p id="3002" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">或者，您可以从<strong class="ih hj">云管理器</strong>的UI提供集群。<br/>这有利于使用相同的UX/用户界面和统一的方法来跨提供商配置集群。您只需输入您正在使用的每个提供商的凭证(例如，<strong class="ih hj"> DigitalOcean </strong>、<strong class="ih hj"> Linode </strong>、<strong class="ih hj"> Scaleway </strong>、用于<strong class="ih hj"> AWS </strong>的密钥-秘密对、用于<strong class="ih hj"> GCP </strong>的服务帐户JSON等)。).您也可以从<strong class="ih hj">云管理器</strong>菜单选项<code class="du lm ln lo lp b">Cluster &gt; Connect &gt; Kubeconfig</code>下载<em class="jd"> kubeconfig </em>配置文件。</p><p id="0eba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您已经在这些提供商或内部部署中拥有一个现有集群，您也可以使用它。此外，如果您的笔记本电脑上安装了<strong class="ih hj"> Docker Desktop </strong>，您可以将它用作一个<strong class="ih hj"> Kubernetes </strong>伪集群，其中包含一个用于开发目的的节点。最后一个选项的主要限制是您的笔记本电脑通常没有公共IP，因此DNS循环负载平衡不适用于该集群(将在下面讨论)。</p><h2 id="ea00" class="ks jw hi bd ju kt ku kv ka kw kx ky ke iq kz la ki iu lb lc km iy ld le kq lf bi translated">正在启动云管理器后端</h2><p id="2f5c" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">在本文中，我们将使用<code class="du lm ln lo lp b">ei </code> CLI工具，但在此之前，您需要运行一个<strong class="ih hj">云管理器</strong>服务的实例。如果您想在多用户模式下使用<strong class="ih hj">云管理器</strong>，您还需要启动<strong class="ih hj"> SSO网关</strong>服务。我已经在<a class="ae ll" rel="noopener" href="/swlh/cloud-manager-kubernetes-better-dashboard-d29cf91ac69e">其他文章</a>中介绍了这方面的细节，所以我会引导您阅读其中一篇。您还可以在底部的参考资料中找到文档的链接。</p><p id="a8fd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">云管理器</strong>打包成<em class="jd"> Docker镜像</em>，有几种安装选项，包括:带<code class="du lm ln lo lp b">kubectl</code>、<code class="du lm ln lo lp b">docker</code>、<code class="du lm ln lo lp b">helm</code>，多用户模式的助手脚本(基于YTT)。为了快速参考，我在下面显示了使用Docker在单用户模式下运行<strong class="ih hj">云管理器</strong>的命令。</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="4af9" class="ks jw hi lp b fi lu lv l lw lx">docker run -p5005:2500 einnovator/einnovator-devops cm -d</span></pre><p id="43b3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<code class="du lm ln lo lp b">http://localhost:5005</code>的网络浏览器中打开<strong class="ih hj">云管理器</strong> UI，注册为管理员。</p><p id="97c4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">或者，您可以使用<a class="ae ll" href="https://cloud.einnovator.org" rel="noopener ugc nofollow" target="_blank">cloud.einnovator.org</a>的<strong class="ih hj">云管理器</strong> (SaaS)的<strong class="ih hj">创新器</strong>安装。你只需要注册，并记住你的用户名/密码。</p><h2 id="ff2d" class="ks jw hi bd ju kt ku kv ka kw kx ky ke iq kz la ki iu lb lc km iy ld le kq lf bi translated">安装云管理器CLI</h2><p id="d4b0" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">设置的下一步是安装<code class="du lm ln lo lp b">ei</code> CLI工具。在<a class="ae ll" rel="noopener" href="/faun/a-cli-tool-for-multi-cluster-kubernetes-cloud-manager-rocks-af17124af2a6">另一篇文章</a>、<br/>中，我对CLI工具进行了深入的介绍。简而言之，要安装你需要下载一个如下的<code class="du lm ln lo lp b">.tgz</code>:</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="0d7c" class="ks jw hi lp b fi lu lv l lw lx">wget <a class="ae ll" href="https://cdn.einnovator.org/cli/ei-latest.tgz" rel="noopener ugc nofollow" target="_blank">https://cdn.einnovator.org/cli/ei-latest.tgz</a><br/>tar -xf ei-latest.tgz<br/>cd einnovator-cli<br/>chmod +x ei #linux/mac only<br/>./ei</span></pre><p id="b806" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，您需要使用您的用户名和密码通过CLI登录到服务器。使用适当的API端点:如果在<strong class="ih hj"> Docker </strong>上运行，则使用<strong class="ih hj"> EInnovator </strong>的SaaS安装，则使用<code class="du lm ln lo lp b">cloud.einnovator.org</code>。</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="79d2" class="ks jw hi lp b fi lu lv l lw lx"># login to local cloud manager API with username/password<br/>ei login -u username -p password <a class="ae ll" href="http://localhost:5050" rel="noopener ugc nofollow" target="_blank">http://localhost:5050</a></span><span id="eb4f" class="ks jw hi lp b fi ly lv l lw lx"># login to remote SaaS installation of cloud manager<br/>ei login -u username -p password <a class="ae ll" href="https://cloud.einnovator.org" rel="noopener ugc nofollow" target="_blank">https://cloud.einnovator.org</a></span></pre><h1 id="7b31" class="jv jw hi bd ju jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">设置集群</h1><h2 id="f5f1" class="ks jw hi bd ju kt ku kv ka kw kx ky ke iq kz la ki iu lb lc km iy ld le kq lf bi translated">导入Kubeconfig</h2><p id="e85e" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">您可以通过几种方式将集群访问细节导入到<strong class="ih hj">云管理器</strong>中，包括UI和CLI。使用CLI最简单的方法是使用带有选项<code class="du lm ln lo lp b">-f</code>的命令<code class="du lm ln lo lp b">cluster import</code>来指定每个集群的<em class="jd"> kubeconfig </em>文件的位置。您可以从任意数量的提供者导入任意数量的集群。<em class="jd"> kubeconfig </em>的格式始终相同。集群名称(和提供者细节)是从<em class="jd"> kubeconfig </em>文件中自动推断出来的。唯一的限制是使用<em class="jd"> kubeconfig </em>文件对单个集群进行配置。(如果在一个文件中定义了多个集群，您需要指定所选集群的名称作为<code class="du lm ln lo lp b">cluster import</code>的参数，否则将导入找到的第一个集群)。</p><p id="b81f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面，我从不同的云提供商导入几个集群作为例子。你应该适应你选择的实际的提供者和文件名。</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="6858" class="ks jw hi lp b fi lu lv l lw lx"># import clusters using kubeconfig files<br/>ei cluster import -f kubeconfig-digitalocean.yaml <br/>ei cluster import -f kubeconfig-linode.yaml <br/>ei cluster import -f kubeconfig-scaleway.yaml <br/>ei cluster import -f kubeconfig-gcp.yaml <br/>ei cluster import -f kubeconfig-aws.yaml <br/>ei cluster import -f kubeconfig-azure.yaml <br/>ei cluster import -f kubeconfig-ibm.yaml <br/>ei cluster import -f kubeconfig-oracle.yaml <br/>ei cluster import -f kubeconfig-alibaba.yaml </span></pre><p id="1f59" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要确认导入的集群，您可以使用命令<code class="du lm ln lo lp b">ls -c</code>。</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="f555" class="ks jw hi lp b fi lu lv l lw lx"># list configured clusters<br/>ei ls -c</span></pre><h2 id="6774" class="ks jw hi bd ju kt ku kv ka kw kx ky ke iq kz la ki iu lb lc km iy ld le kq lf bi translated">附加集群设置</h2><p id="e99e" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">当设置一个<strong class="ih hj"> Kubernetes </strong>集群并在实践中使用它时，有一些附加/扩展和工具通常是有用的或需要的。<br/>这包括一个<em class="jd">入口控制器</em>来管理<code class="du lm ln lo lp b">Ingresses</code>并支持DNS路由，比如<strong class="ih hj"> Nginx </strong>。CI/CD启用运行时，如<strong class="ih hj"> Tekton </strong>。以及从集群内部将市场解决方案安装到集群中的工具，例如<code class="du lm ln lo lp b">helm</code>和<code class="du lm ln lo lp b">kubectl</code>。云管理器支持轻松安装这些运行时扩展。这可以在<code class="du lm ln lo lp b">cluster import</code>期间使用选项<code class="du lm ln lo lp b">--ingress</code>、<code class="du lm ln lo lp b">--cicd</code>和<code class="du lm ln lo lp b">--tools</code>一步完成。如果您的一些集群已经安装了这些运行时，您可以省略其中的一些选项(例如，<strong class="ih hj"> Scaleway </strong> UI和API具有在集群创建时安装入口控制器的选项)。</p><p id="7516" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面，我再次展示了为安装<strong class="ih hj"> Nginx </strong>入口控制器(默认)而修改的导入命令，这是以后需要的。还安装了<strong class="ih hj">舵</strong>工具。</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="638a" class="ks jw hi lp b fi lu lv l lw lx"># import clusters and install add-ons<br/>ei cluster import -f kubeconfig-digitalocean.yaml --ingress=true --tools=true<br/>ei cluster import -f kubeconfig-linode.yaml --ingress=true --tools=true<br/>...</span></pre><h2 id="c339" class="ks jw hi bd ju kt ku kv ka kw kx ky ke iq kz la ki iu lb lc km iy ld le kq lf bi translated">创建空间</h2><p id="d5dd" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">接下来，您需要在每个集群中创建一个<strong class="ih hj"> <em class="jd">空间</em> </strong>(名称空间)来部署您的应用程序和支持资源。这是通过命令<code class="du lm ln lo lp b">space create</code>完成的。<strong class="ih hj">云管理器</strong>提供了一个平面空间列表，允许在不同集群和云的空间之间进行选择和切换，就像在相同集群或云中的空间一样容易。命名空间时，群集名称用作前缀。</p><p id="28ec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面，我在我们导入的每个集群中创建了一个名为<code class="du lm ln lo lp b">dev</code>的空间。我们可以在不同的集群中使用不同的空间名称，但是使用一个共同的名称简化了脚本，也更容易管理。</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="b0ab" class="ks jw hi lp b fi lu lv l lw lx"># import clusters using kubeconfig files<br/>ei create space do/dev<br/>ei create space linode/dev<br/>ei create space scaleway/dev<br/>ei create space gcp/dev<br/>ei create space aws/dev<br/>ei create space azure/dev<br/>ei create space ibm/dev<br/>ei create space oracle/dev<br/>ei create space alibaba/dev</span></pre><p id="8dc3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您有许多集群，您可能更喜欢使用带有<code class="du lm ln lo lp b">for</code>循环指令的<strong class="ih hj"> Bash </strong> shell脚本，如下所示:</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="9344" class="ks jw hi lp b fi lu lv l lw lx">export SPACES="do/dev linode/dev scaleway/dev gcp/dev aws/dev azure/dev ibm/dev oracle/dev alibaba/dev"<br/>for space in $SPACES ; do ei create space $space; done</span></pre><p id="ac05" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">提示:</strong>您应该使<code class="du lm ln lo lp b">SPACES</code>变量的值适应您所提供的实际集群。</p><p id="a669" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用命令<code class="du lm ln lo lp b">ls</code>确认在所有集群中创建了空间。</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="0b08" class="ks jw hi lp b fi lu lv l lw lx"># list created spaces<br/>ei ls</span></pre><h1 id="7718" class="jv jw hi bd ju jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">跨集群运行应用程序</h1><p id="4ef9" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">使用命令<code class="du lm ln lo lp b">run</code>只需一步即可完成应用部署。<br/>每个集群/空间都应该这样做。命令<code class="du lm ln lo lp b">cd</code>用于在集群/空间之间切换。</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="c567" class="ks jw hi lp b fi lu lv l lw lx"># run app as a deployment with a specified image in multiple cluster/spaces<br/>ei cd do/dev<br/>ei run superheros einnovator/einnovator-sample-superheros --port=80 --stack=boot -o<br/>ei cd linode/dev<br/>ei run superheros einnovator/einnovator-sample-superheros --port=80 --stack=boot -o<br/>...</span></pre><p id="a0a1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">命令<code class="du lm ln lo lp b">run</code>中的选项<code class="du lm ln lo lp b">--port</code>用于指定应用程序容器应该监听连接的端口。选项<code class="du lm ln lo lp b">--stack=boot</code>提示<strong class="ih hj">云管理器</strong>为<strong class="ih hj"> Spring Boot </strong> app自动配置应用的一些环境变量——即设置环境变量<code class="du lm ln lo lp b">SERVER_PORT</code>来配置embedeed HTTP/Servlet容器的端口。最终结果是在各自的<code class="du lm ln lo lp b">ReplicaSet</code>和<code class="du lm ln lo lp b">Pod(s)</code>中一起创建了<strong class="ih hj"> Kubernetes </strong>和<code class="du lm ln lo lp b">Service</code>。一些部署元数据也保存在<strong class="ih hj">云管理器</strong> DB中，这允许在不丢失配置的情况下停止集群中的应用程序。</p><p id="8910" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您有许多集群，那么使用一个<strong class="ih hj"> Bash </strong> shell脚本也很方便:</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="e58d" class="ks jw hi lp b fi lu lv l lw lx">for space in $SPACES ; do \<br/>  ei cd $space;\<br/>  ei run superheros einnovator/einnovator-sample-superheros --port=80 --stack=boot;\<br/>done</span></pre><p id="3558" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">每次需要在不同的集群/空间中部署或配置应用程序时，您可以使用选项<code class="du lm ln lo lp b">-n</code>来选择集群/空间，而不是使用命令<code class="du lm ln lo lp b">cd</code>显式地更改当前空间。如下所示:</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="d717" class="ks jw hi lp b fi lu lv l lw lx">for space in $SPACES ; do \<br/>  ei run -n=${space} superheros einnovator/einnovator-sample-superheros --port=80 --stack=boot;\<br/>done</span></pre><p id="2784" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用命令<code class="du lm ln lo lp b">ps</code>确认应用程序正在运行。</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="de23" class="ks jw hi lp b fi lu lv l lw lx"># list deployments in current space<br/>ei cd do/dev<br/>ei ps<br/>...</span></pre><p id="d89a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您想要列出其他集群/空间中的部署，而不是当前的部署，请使用选项<code class="du lm ln lo lp b">-n</code>。您也可以指定多个空格和逗号分隔的集群。</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="9187" class="ks jw hi lp b fi lu lv l lw lx"># list deployments in selected space<br/>ei ps -n=do/dev<br/>ID  NAME       DISPLAYNAME KIND       STATUS AVAIL DESIRED READY AGE<br/>587 superheros superheros  Deployment Running  1     1     1/1   1d</span><span id="7ef9" class="ks jw hi lp b fi ly lv l lw lx"># list deployments in several spaces<br/>ei ps -n=do/dev,linode/dev,scaleway/dev,aws/dev</span></pre><p id="7b78" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">或者，使用下面两个<strong class="ih hj"> Bash </strong>命令行之一来列出所有集群/空间:</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="0ddd" class="ks jw hi lp b fi lu lv l lw lx"># list deployments in all spaces (1)<br/>ei ps -n=${SPACES//[ ]/,}</span><span id="8677" class="ks jw hi lp b fi ly lv l lw lx"># list deployments in all spaces (2)<br/>for space in $SPACES ; do ei ps -n=${space}; done</span></pre><p id="a017" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">提示:</strong>语法<code class="du lm ln lo lp b">${string//[substring]/replacement</code>是<strong class="ih hj"> Bash </strong>习语进行字符串替换。这里用逗号替换变量<code class="du lm ln lo lp b">SPACES</code>中的空白分隔符。</p><p id="457f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果想快速导航到<strong class="ih hj">云管理器</strong> UI，可以使用命令<code class="du lm ln lo lp b">deploy view</code>。这将在默认的web浏览器中打开一个带有应用程序仪表板的窗口/选项卡(您需要首次登录)。这便于以简洁直观的方式对应用程序部署进行故障诊断(例如，通过查看日志、事件、生成的清单、配置和其他资源)。同样，您可以使用命令<code class="du lm ln lo lp b">space view</code>打开当前空间的仪表板。</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="6ed0" class="ks jw hi lp b fi lu lv l lw lx">#open app in browser<br/>ei cd do/dev<br/>ei deploy view superheros<br/>...</span></pre><p id="1da3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要使用所有集群/空间的应用程序仪表板打开浏览器选项卡，您可以使用脚本行:</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="3a60" class="ks jw hi lp b fi lu lv l lw lx">for space in $SPACES ; do ei deploy view superheros -n=$space; done</span></pre><h1 id="efe3" class="jv jw hi bd ju jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">应用程序管理和配置</h1><h2 id="27c6" class="ks jw hi bd ju kt ku kv ka kw kx ky ke iq kz la ki iu lb lc km iy ld le kq lf bi translated">扩展应用程序</h2><p id="ac70" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">如果你想在每个集群中有多个应用实例，你可以使用命令<code class="du lm ln lo lp b">run</code>中的选项<code class="du lm ln lo lp b">-k</code>。或者，你可以在程序运行后使用命令<code class="du lm ln lo lp b">deploy scale</code>。</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="4331" class="ks jw hi lp b fi lu lv l lw lx"># scale deployment to 10 replicas (horizontal scaling)<br/>ei cd do/dev<br/>ei deploy scale superheros 3<br/>ei cd linode/dev<br/>ei deploy scale superheros 5<br/>...</span></pre><p id="2c1a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要扩展分配给每个实例的资源(内存、临时磁盘存储和CPU共享)，请使用命令<code class="du lm ln lo lp b">deploy resources</code>。</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="c2e3" class="ks jw hi lp b fi lu lv l lw lx"># update resources (vertical scaling)<br/>ei cd do/dev<br/>ei deploy resources superheros — mem=2Gi — disk=3Gi<br/>ei cd linode/dev<br/>ei deploy resources superheros — mem=2Gi — disk=3Gi</span></pre><h2 id="a432" class="ks jw hi bd ju kt ku kv ka kw kx ky ke iq kz la ki iu lb lc km iy ld le kq lf bi translated">更新应用程序</h2><p id="5f8b" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">如果在某些时候你需要更新一个应用程序<em class="jd">镜像:版本</em>，你可以使用命令<code class="du lm ln lo lp b">deploy update</code>和选项<code class="du lm ln lo lp b">--image</code>，如下所示:</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="64b4" class="ks jw hi lp b fi lu lv l lw lx">ei deploy update superheros --image=einnovator/einnovator-sample-superheros:1.1 -n=do/dev<br/>ei deploy update superheros --image=einnovator/einnovator-sample-superheros:1.1 -n=do/linode<br/>...</span></pre><p id="e613" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要跨所有集群/空间轻松更新，请使用命令行:</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="9c71" class="ks jw hi lp b fi lu lv l lw lx">for space in $SPACES ; do ei deploy update superheros \<br/>--image=einnovator/einnovator-sample-superheros:1.1 -n=$space; done</span></pre><h2 id="1bcc" class="ks jw hi bd ju kt ku kv ka kw kx ky ke iq kz la ki iu lb lc km iy ld le kq lf bi translated">环境变量</h2><p id="90f1" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">您可能需要设置应用程序的环境变量来配置不同的设置。这可以通过命令<code class="du lm ln lo lp b">env add</code>、<code class="du lm ln lo lp b">env update</code>和<code class="du lm ln lo lp b">env rm</code>来完成。使用命令<code class="du lm ln lo lp b">env ls</code>检查应用程序的当前环境。使用命令<code class="du lm ln lo lp b">deploy restart</code>更新环境变量后，您需要重启应用程序。</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="b3e4" class="ks jw hi lp b fi lu lv l lw lx">ei cd aws/dev<br/>ei env add superheros SPRING_PROFILES_INCLUDE=mongodb<br/>ei env update superheros THEME=fantasy<br/>ei env rm superheros BROKER_URL<br/>ei env ls<br/>ei deploy restart superheros<br/>...</span></pre><p id="86af" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">像往常一样，您可以依靠<strong class="ih hj"> Bash </strong>脚本来更容易地跨所有集群/空间配置应用程序:</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="fb26" class="ks jw hi lp b fi lu lv l lw lx">for space in $SPACES ; do\<br/>  ei cd ${space};\<br/>  env add superheros SPRING_PROFILES_INCLUDE=mongodb;\<br/>  env update superheros THEME=fantasy;\<br/>  env rm superheros BROKER_URL;\<br/>  deploy restart superheros;\<br/>done</span></pre><h2 id="63d3" class="ks jw hi bd ju kt ku kv ka kw kx ky ke iq kz la ki iu lb lc km iy ld le kq lf bi translated">坚持</h2><p id="1110" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">到目前为止，我一直假设应用程序运行在嵌入式数据库中。对于本文中用作示例的示例应用程序<code class="du lm ln lo lp b">einnovator/einnovator-sample-superheros</code>,默认情况下是这样的。在后面的小节中，我将讨论一些部署独立数据库和将应用程序绑定到数据库的方法。</p><p id="5f63" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于一个嵌入式数据库，您可能希望考虑一个<strong class="ih hj"> Kubernetes </strong> pod的磁盘空间在默认情况下是短暂的(即，如果pod被终止，比如当应用程序关闭或更新时，它就会被丢弃)。为了拥有真正的持久性存储，您可以使用命令<code class="du lm ln lo lp b">mount add</code>为应用程序配置一个挂载点。<strong class="ih hj">云管理器</strong>自动创建一个<strong class="ih hj"> Kubernetes </strong> <strong class="ih hj">持久卷声明</strong>，并生成清单文件挂载到指定路径。您需要重新启动应用程序以使装载生效。您需要在每个集群/空间中执行此操作。</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="985c" class="ks jw hi lp b fi lu lv l lw lx"># mount volume in specified path<br/>ei cd do/dev<br/>ei mount add superheros data — mountPath=/data — size=3Gi<br/>ei deploy restart superheros<br/>...</span></pre><p id="5a20" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果使用<strong class="ih hj"> Bash </strong>脚本为所有集群/云进行配置:</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="7b58" class="ks jw hi lp b fi lu lv l lw lx">for space in $SPACES ; do\<br/>  ei cd $space;\<br/>  ei mount add superheros data --mountPath=/data --size=3Gi\<br/>  ei deploy restart superheros\<br/>done</span></pre><h1 id="d203" class="jv jw hi bd ju jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">通过DNS路由访问应用程序</h1><h2 id="b4c2" class="ks jw hi bd ju kt ku kv ka kw kx ky ke iq kz la ki iu lb lc km iy ld le kq lf bi translated">定义域</h2><p id="49cc" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">要使应用程序在每个集群中都可以访问，您有几种选择。对最终用户来说，最方便的是为应用程序提供一个DNS主机名。这假设集群中的节点有一个可到达的公共IP。要在<strong class="ih hj">云管理器</strong>中做到这一点，首先用命令<code class="du lm ln lo lp b">domain create</code>定义你的域名(例如<code class="du lm ln lo lp b">acme.com</code>)。对于安全的HTTPS访问，您需要一个包含证书的文件，以及相应的私钥和证书授权链，并使用选项<code class="du lm ln lo lp b">--crt</code>、<code class="du lm ln lo lp b">--key</code>、<code class="du lm ln lo lp b">--ca</code>来指定这些。</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="6776" class="ks jw hi lp b fi lu lv l lw lx"># create an (unsecure) domain<br/>ei domain create acme.com</span><span id="4823" class="ks jw hi lp b fi ly lv l lw lx"># create a secure domain<br/>ei domain create acme.com --crt=crt.pem --key=key.pem --ca=ca.pem</span></pre><p id="d96f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要使其成为以后的默认域，请使用命令<code class="du lm ln lo lp b">domain set</code>。<br/>您只需要这样做一次，因为域是由cloud <strong class="ih hj"> CloudManager </strong>管理的，可以用于所有集群。您可以使用命令<code class="du lm ln lo lp b">ls -d</code>列出所有域(如果您有多个域)。</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="bd0c" class="ks jw hi lp b fi lu lv l lw lx"># set current/default domain and list domains<br/>ei domain set acme.com<br/>ei ls -d</span></pre><h2 id="a10a" class="ks jw hi bd ju kt ku kv ka kw kx ky ke iq kz la ki iu lb lc km iy ld le kq lf bi translated">添加DNS路由</h2><p id="839c" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">接下来，您应该使用命令<code class="du lm ln lo lp b">route add</code>向每个集群中的应用程序添加一个或多个DNS路由。当增加一条路由时，<strong class="ih hj">云管理器</strong>自动创建一个<strong class="ih hj">Kubernetes</strong>T8】并用域证书配置一个<code class="du lm ln lo lp b">secret</code>。</p><p id="e7b1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将添加两条路由，一条用于唯一识别和到达特定集群(即云提供商安装)，另一条是可以全局负载平衡的共享路由(见下一节)。下面，我使用<code class="du lm ln lo lp b">heros</code>作为通用主机名，<br/>和<code class="du lm ln lo lp b">heros-{cluster}</code>作为集群特定的路由。</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="ce04" class="ks jw hi lp b fi lu lv l lw lx"># add routes to app<br/>ei cd do/dev<br/>ei route add superheros heros-do<br/>ei route add superheros heros<br/>ei cd linode/dev<br/>ei route add superheros heros-linode<br/>ei route add superheros heros</span></pre><p id="871d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果使用一个<strong class="ih hj"> Bash </strong> shell脚本:</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="2dff" class="ks jw hi lp b fi lu lv l lw lx">for space in $SPACES ; do \<br/>  ei cd $space;\<br/>  ei route add superheros heros-${space%/dev};\<br/>  ei route add superheros heros;\<br/>done</span></pre><p id="1f2e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">提示:</strong>表达式<code class="du lm ln lo lp b">${space%/dev}</code>是<strong class="ih hj"> Bash </strong>习语从字符串中删除后缀<code class="du lm ln lo lp b">/dev</code>。此处用于从限定的空间名中获取集群名。</p><p id="d949" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您还需要配置您的DNS服务器来路由到应用程序DNS主机名。为此，为<code class="du lm ln lo lp b">heros-{cluster}.domain</code>(例如<code class="du lm ln lo lp b">heros-do.acme.com</code>、<code class="du lm ln lo lp b">heros-linode.acme.com</code>等)创建<code class="du lm ln lo lp b">A</code>记录。)带有值的集群中某个节点的公共IP地址。要获得这个IP地址，您可以运行命令<code class="du lm ln lo lp b">node ls -b</code>并注意字段<code class="du lm ln lo lp b">addr</code>的值。识别公有IP地址(私有IP地址一般以<code class="du lm ln lo lp b">10.x.x.x</code>开头，所以是另一个)。您也可以使用<code class="du lm ln lo lp b">kubectl get nodes -o=yaml</code>来获取这些信息。</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="dacc" class="ks jw hi lp b fi lu lv l lw lx">ei cd do/dev<br/>ei nodes ls -b</span></pre><p id="bd14" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">添加路线后，您可以使用命令<code class="du lm ln lo lp b">deploy go</code>快速导航到应用程序。这将在应用程序主页中打开一个浏览器窗口(或选项卡)。</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="de5c" class="ks jw hi lp b fi lu lv l lw lx">#open app in browser<br/>ei deploy go superheros</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/961b8ad17bfb90602c08dc982e1fab2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MZnc_jJGR_DfBDHRVNh_AA.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx"><strong class="bd ju">Superheros Sample App</strong></figcaption></figure><h2 id="8189" class="ks jw hi bd ju kt ku kv ka kw kx ky ke iq kz la ki iu lb lc km iy ld le kq lf bi translated">跨集群/云的负载平衡</h2><p id="4479" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">通常，最终用户使用单个DNS <code class="du lm ln lo lp b">hostname.domain</code>地址访问应用程序很方便，即使应用程序有多个实例/副本。对于在同一个集群和空间中运行的实例，<strong class="ih hj"> Kubernetes </strong>通过在不同的实例之间进行流量负载平衡来自动处理这个问题。如果应用跨多个集群和云复制，就像我们在这里做的那样，我们需要一个额外的机制来跨集群执行负载平衡。最简单的方法(不一定总是最理想的)是使用DNS循环法，用相同的主机名和多个IP地址值配置多个<code class="du lm ln lo lp b">A</code>记录。下面，我展示了一个<code class="du lm ln lo lp b">heros.acme.com</code>的配置示例:</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="42cd" class="ks jw hi lp b fi lu lv l lw lx">A heros.acme.com 51.15.220.42 #do<br/>A heros.acme.com 71.12.120.22 #linode<br/>A heros.acme.com 91.14.142.14 #scaleway<br/>...</span></pre><h2 id="4c6c" class="ks jw hi bd ju kt ku kv ka kw kx ky ke iq kz la ki iu lb lc km iy ld le kq lf bi translated">完整脚本</h2><p id="a8f4" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">作为参考，我在下面展示了在多个集群/云中部署应用程序的完整的<strong class="ih hj"> Bash </strong>脚本，包括:空间创建、运行和扩展部署、创建域和路由。</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="e519" class="ks jw hi lp b fi lu lv l lw lx">export SPACES="do/dev linode/dev scaleway/dev gcp/dev aws/dev azure/dev ibm/dev oracle/dev alibaba/dev"<br/>for space in $SPACES ; do ei create space $space; done<br/>ei domain create acme.com --crt=crt.pem --key=key.pem --ca=ca.pem<br/>ei domain set acme.com<br/>for space in $SPACES ; do\<br/>  ei cd ${space};\<br/>  ei run superheros einnovator/einnovator-sample-superheros --port=80 --stack=boot;\<br/>  ei deploy resources superheros --mem=2Gi --disk=3Gi;\<br/>  ei deploy scale superheros 3;\<br/>  ei route add superheros heros-${space%/dev};\<br/>  ei route add superheros heros;\<br/>done</span></pre><p id="11fe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您想要清理所有集群/空间中的所有资源，可以运行以下脚本:</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="496d" class="ks jw hi lp b fi lu lv l lw lx">export SPACES="do/dev linode/dev scaleway/dev gcp/dev azure/dev ibm/dev oracle/dev alibaba/dev"<br/>for space in $SPACES ; do \<br/>  ei cd ${space};\<br/>  ei kill superheros -f;\<br/>  ei space rm ${space};\<br/>done</span></pre><h1 id="0d6e" class="jv jw hi bd ju jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">使用后端数据库运行应用程序</h1><p id="07ff" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">对于大多数应用程序，最好连接到独立的数据库，而不是使用嵌入式数据库。这需要两个步骤:部署数据库，并配置连接到它的应用程序。通常，您需要评估几种可能的体系结构，以便在集群间分发数据。我将一些关键问题和可能性总结如下:</p><ul class=""><li id="65d7" class="lz ma hi ih b ii ij im in iq mb iu mc iy md jc me mf mg mh bi translated">使用哪个数据库？RDBMS或NoSQL是我的用例的首选吗？</li><li id="1206" class="lz ma hi ih b ii mi im mj iq mk iu ml iy mm jc me mf mg mh bi translated">应该复制数据库还是单个实例就足够了？</li><li id="4d4c" class="lz ma hi ih b ii mi im mj iq mk iu ml iy mm jc me mf mg mh bi translated"><em class="jd">如果只有一个实例:</em></li><li id="b01f" class="lz ma hi ih b ii mi im mj iq mk iu ml iy mm jc me mf mg mh bi translated">它将在Kubernetes内部运行还是在某个外部环境中运行(例如专用虚拟机)？</li><li id="3de6" class="lz ma hi ih b ii mi im mj iq mk iu ml iy mm jc me mf mg mh bi translated">如果在<strong class="ih hj"> Kubernetes </strong>内部，它应该位于哪个集群中？</li><li id="da6c" class="lz ma hi ih b ii mi im mj iq mk iu ml iy mm jc me mf mg mh bi translated"><em class="jd">如果复制:</em></li><li id="325f" class="lz ma hi ih b ii mi im mj iq mk iu ml iy mm jc me mf mg mh bi translated">有单个写入副本(主副本)还是多个？</li><li id="bd7d" class="lz ma hi ih b ii mi im mj iq mk iu ml iy mm jc me mf mg mh bi translated">如何在不同的副本之间同步数据并保持一致性？</li><li id="1d68" class="lz ma hi ih b ii mi im mj iq mk iu ml iy mm jc me mf mg mh bi translated">数据库是否自动完成数据同步？</li><li id="3f91" class="lz ma hi ih b ii mi im mj iq mk iu ml iy mm jc me mf mg mh bi translated">如果是，如何设置适当的配置？</li><li id="6672" class="lz ma hi ih b ii mi im mj iq mk iu ml iy mm jc me mf mg mh bi translated">所选数据库是否有<strong class="ih hj"> Kubernetes </strong>运算符？如果是，它是否为多集群部署提供任何支持？(目前，对此的支持有限)</li><li id="08d6" class="lz ma hi ih b ii mi im mj iq mk iu ml iy mm jc me mf mg mh bi translated">是否需要定制的应用程序级逻辑来执行数据同步(例如，通过使用消息代理转发数据更新)？</li><li id="8788" class="lz ma hi ih b ii mi im mj iq mk iu ml iy mm jc me mf mg mh bi translated">多集群数据备份是如何协调的？</li></ul><p id="c772" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了简单起见，下面我假设了一个最简单的场景，其中示例应用程序连接到运行在同一个集群中的MySQL数据库，每个集群和应用程序部署都有自己的数据库。对于跨数据库的数据同步和一致性这一重要问题，我没有做出定论。</p><p id="82ed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此外，连接到独立集群或外部环境中的数据库原则上类似于连接到同一集群中的数据库，但可能需要一些配置调整。我将在以后的文章中讨论这些更高级的场景。</p><h2 id="7a5c" class="ks jw hi bd ju kt ku kv ka kw kx ky ke iq kz la ki iu lb lc km iy ld le kq lf bi translated">工具作业</h2><p id="20f5" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">您有几个工具选项可以在<strong class="ih hj"> Kubernetes </strong>集群中安装数据库，包括:<em class="jd"> Helm charts </em>、<code class="du lm ln lo lp b">kubectl</code>带清单文件(普通或<code class="du lm ln lo lp b">kustomize</code>合成)、特定于DB的操作符和CRD，以及几个基于UI的工具，包括<strong class="ih hj">云管理器</strong>。这里我将继续使用<code class="du lm ln lo lp b">ei</code> CLI工具。</p><p id="a34c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">命令<code class="du lm ln lo lp b">market</code>用于从配置的目录中列出和搜索市场解决方案。<strong class="ih hj">云管理器</strong>默认安装会自动设置几个现成的目录。这些目录定义了各种各样的解决方案，包括几个数据库。下面，我将展示如何搜索名称或关键字包含文本<code class="du lm ln lo lp b">sql</code>的所有解决方案。</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="1ae3" class="ks jw hi lp b fi lu lv l lw lx">#list all solutions in any catalog matching a query<br/>ei market sql</span></pre><h2 id="a53a" class="ks jw hi bd ju kt ku kv ka kw kx ky ke iq kz la ki iu lb lc km iy ld le kq lf bi translated">安装数据库</h2><p id="41b9" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">为了安装<strong class="ih hj"> MySQL </strong> DB，我使用命令<code class="du lm ln lo lp b">install</code>并选择目录<code class="du lm ln lo lp b">einnovator</code>中可用的<code class="du lm ln lo lp b">mysql</code>解决方案。</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="12c1" class="ks jw hi lp b fi lu lv l lw lx">ei install einnovator/mysql<br/>ei ps<br/><br/>ID  NAME       DISPLAYNAME KIND       STATUS AVAIL DESIRED READY AGE<br/>587 superheros superheros  Deployment  Running 1    1     1/1     1d<br/>589 mysql      MySql DB    StatefulSet Running 1    1     1/1     2h</span></pre><p id="d8a7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在启动数据库部署(实际上是一个<code class="du lm ln lo lp b">StatefulSet</code>)之后，您应该为应用程序数据创建数据库。为此，您可以在DB的pod中运行命令<code class="du lm ln lo lp b">mysql</code>并执行命令<code class="du lm ln lo lp b">create database</code>。这可以通过<code class="du lm ln lo lp b">ei</code>命令<code class="du lm ln lo lp b">deploy exec</code>轻松完成，默认情况下，它在部署的第一个pod中运行该命令。</p><p id="b0dc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了让<code class="du lm ln lo lp b">create database</code>命令工作，您需要查找并提供数据库密码和认证。对于我们安装的解决方案，这是在名为<code class="du lm ln lo lp b">mysql-credentials</code>的<code class="du lm ln lo lp b">secret</code>和数据字段<code class="du lm ln lo lp b">password</code>中设置的。下面，我使用带有选项<code class="du lm ln lo lp b">-d</code>和<code class="du lm ln lo lp b">--decode</code>的命令<code class="du lm ln lo lp b">secret get</code>来提取和解码密码，并将其分配给一个变量。</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="e3a4" class="ks jw hi lp b fi lu lv l lw lx">export PWD=`ei secret get mysql-credentials -d=password --decode`<br/>ei deploy exec mysql -- mysql -uroot -p$PWD -e "create database superheros"</span></pre><p id="ec99" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">或者，您可以使用<code class="du lm ln lo lp b">kubectl</code>加上util <code class="du lm ln lo lp b">jq</code>来提取解码的秘密值并创建数据库。</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="3b5e" class="ks jw hi lp b fi lu lv l lw lx">export PWD=`kubectl get secret mysql-credentials -o json | jq '.data|map_values(@base64d)'`<br/>ei exec mysql-0 — mysql -uroot -p$PWD -e "create database superheros"</span></pre><h2 id="a1b0" class="ks jw hi bd ju kt ku kv ka kw kx ky ke iq kz la ki iu lb lc km iy ld le kq lf bi translated">定义数据库连接器</h2><p id="797b" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">为了简化连接应用到后台服务的工作，例如DBs和消息代理以及其他微服务，<strong class="ih hj">云管理器</strong>提供了<strong class="ih hj"> <em class="jd">连接器</em> </strong>和<strong class="ih hj"> <em class="jd">绑定</em> </strong>的抽象。一个部署/服务可以公开一个或多个连接器，每个连接器定义一组用于将连接信息导出到应用程序的键-值对。它们是用JSON规范定义的，通常包括如下信息:用户名/密码凭证、服务主机/IP和访问URL。</p><p id="09f7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面，我使用命令<code class="du lm ln lo lp b">connector add</code>为服务<code class="du lm ln lo lp b">mysql</code>创建一个名为<code class="du lm ln lo lp b">superheros/root</code>的新连接器。选项<code class="du lm ln lo lp b">--spec </code>为连接器提供了一个JSON规范。这里导出几个变量，包括:从secret <code class="du lm ln lo lp b">mysql-credentials</code>中查找的<code class="du lm ln lo lp b">password</code>(语法前缀<code class="du lm ln lo lp b">^^</code>解析一个secret数据项，前缀<code class="du lm ln lo lp b">^</code>解析一个configmap数据项)，定义为<code class="du lm ln lo lp b">root</code>的<code class="du lm ln lo lp b">username</code>，引用变量<code class="du lm ln lo lp b">${host}</code>(自动设置为服务端点的IP)和数据库<code class="du lm ln lo lp b">superheros</code>。<br/>选项<code class="du lm ln lo lp b">--type</code>是一个可选提示，允许自动生成绑定规范(见下文)。</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="af5b" class="ks jw hi lp b fi lu lv l lw lx">ei connector add mysql superheros/root --type=mysql \<br/>--spec='{\"password\":\"^^mysql-credentials.password\",\"username\":\"root\",\"uri\":\"mysql:${host}/superheros\"}'</span></pre><p id="6176" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为从命令行用JSON设置连接器规范有点麻烦(因为需要对双引号进行转义)，所以通常最好使用逗号分隔的设置列表，如下所示:</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="7e7c" class="ks jw hi lp b fi lu lv l lw lx">ei connector add mysql superheros/root --type=mysql \<br/>--spec=password:^^mysql-credentials.password,\<br/>username:root,uri:mysql://\${host}/superheros</span></pre><h2 id="fe9c" class="ks jw hi bd ju kt ku kv ka kw kx ky ke iq kz la ki iu lb lc km iy ld le kq lf bi translated">绑定到数据库</h2><p id="69c9" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">一个<strong class="ih hj"> <em class="jd">绑定</em> </strong>是环境变量的设置集合，这些变量的值是从一个连接器中解析出来的。要设置的适当环境变量取决于用于实现应用程序的堆栈。我们的示例应用程序是用<strong class="ih hj"> Spring Boot </strong>实现的，我们连接到一个MySQL数据库，所以我们需要设置环境变量<code class="du lm ln lo lp b">SPRING_DATASOURCE_*</code>。</p><p id="f50d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面，我使用命令<code class="du lm ln lo lp b">binding add</code>为应用程序<code class="du lm ln lo lp b">superheros</code>创建一个新的绑定。选择器<code class="du lm ln lo lp b">mysql/superheros/root</code>指定我们绑定到服务<code class="du lm ln lo lp b">mysql</code>的名为<code class="du lm ln lo lp b">superheros/root </code>的连接器。选项<code class="du lm ln lo lp b">--spec</code>将需要设置的环境变量集合定义为JSON，包括JDBC URL、用户名和密码。这些值是从连接器变量中解析的。</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="aaa6" class="ks jw hi lp b fi lu lv l lw lx">ei binding add superheros mysql/superheros/root \<br/>--spec='{\"spring\":{\”datasource\”:{\"url\":\"jdbc:${uri}\",\"username\":\"${username}\",\"password\":\"${password}\"}}}'</span></pre><p id="6add" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一种简化的方法是要求由<strong class="ih hj">云管理器</strong>基于应用的堆栈和服务类型自动生成绑定规范。这是通过在创建绑定时指定选项<code class="du lm ln lo lp b">--auto</code>来完成的。因为我们在部署时使用选项<code class="du lm ln lo lp b">--stack=BOOT</code>设置了应用程序的堆栈，并且在创建时为连接器指定了连接器类型<code class="du lm ln lo lp b">mysql</code>，所以<strong class="ih hj">云管理器</strong>知道要生成什么样的适当规范。</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="a4ed" class="ks jw hi lp b fi lu lv l lw lx">ei binding add superheros mysql/superheros/root --auto<br/>ei restart superheros</span></pre><p id="a96b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦应用程序重新启动，它将运行和获取/存储数据在MySQL数据库，而不是嵌入式数据库。</p><h2 id="21ac" class="ks jw hi bd ju kt ku kv ka kw kx ky ke iq kz la ki iu lb lc km iy ld le kq lf bi translated">完整脚本</h2><p id="6d6b" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">作为参考，我在下面展示了完整的<strong class="ih hj"> Bash </strong>脚本，用于跨所有集群安装、配置和连接aMySQL DB。</p><pre class="jf jg jh ji fd lq lp lr ls aw lt bi"><span id="2974" class="ks jw hi lp b fi lu lv l lw lx">export SPACES="do/dev linode/dev scaleway/dev gcp/dev aws/dev azure/dev ibm/dev oracle/dev alibaba/dev"<br/>for space in $SPACES ; do\<br/>  ei cd ${space};\<br/>  ei install einnovator/mysql; \<br/>  ei connector add mysql superheros/root --type=mysql \<br/>--spec=password:^^mysql-credentials.password,\<br/>username:root,uri:mysql://\${host}/superheros ;<br/>  ei binding add superheros mysql/superheros/root --auto<br/>  ei deploy restart superheros<br/>done</span></pre><h1 id="7631" class="jv jw hi bd ju jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">摘要</h1><p id="366a" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">我概述了如何使用<strong class="ih hj"> Cloud Manager </strong> CLI工具跨多个集群部署应用程序，这些集群可能来自不同的云提供商。该方法的主要优势包括:跨云提供商的一致性，使用简单的脚本和与单个集群相同的抽象对多个集群进行部署和更新的能力，使用<strong class="ih hj">云管理器</strong>的简化配置模型——这可以说比<strong class="ih hj"> Kubernetes </strong>的普通配置(需要使用大量YAML清单文件)简单得多，并且可以增量完成。</p><p id="e914" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">显然，复制应用程序的无状态部分是比较容易的部分。分发和复制有状态服务，比如DBs，这本身就是一个问题，通常需要特定于服务和用例的方法。通常很难找到可扩展的通用解决方案。在本文中，出于说明的目的，我将重点放在最简单的方法上，并让读者去研究适合您的应用程序和用例的更高级的多集群/多云数据架构。在我们这边，我们将继续探索一些选项，并在未来的帖子中回到这个主题。</p><h1 id="2bea" class="jv jw hi bd ju jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">了解更多信息</h1><ul class=""><li id="b2e0" class="lz ma hi ih b ii lg im lh iq mn iu mo iy mp jc me mf mg mh bi translated"><a class="ae ll" href="https://cms.einnovator.org/publication/cloud-manager-reference-manual/_/install.md" rel="noopener ugc nofollow" target="_blank">在本地安装<strong class="ih hj">云管理器</strong></a></li><li id="63b1" class="lz ma hi ih b ii mi im mj iq mk iu ml iy mm jc me mf mg mh bi translated"><a class="ae ll" href="https://cms.einnovator.org/publication/cloud-manager-reference-manual" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">云管理器</strong>参考手册</a></li><li id="c04d" class="lz ma hi ih b ii mi im mj iq mk iu ml iy mm jc me mf mg mh bi translated"><a class="ae ll" href="https://cms.einnovator.or/document/cloud-manager-tutorial" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">云管理器</strong>第一教程</a></li></ul></div></div>    
</body>
</html>