<html>
<head>
<title>How to Dynamically Create Apache Airflow DAG(s) Via Only JSON — Rationalize Tech</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何仅通过JSON动态创建Apache Airflow DAG合理化技术</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/how-to-dynamically-create-apache-airflow-dag-s-via-only-json-rationalize-tech-47f227071c78?source=collection_archive---------10-----------------------#2021-04-01">https://medium.com/geekculture/how-to-dynamically-create-apache-airflow-dag-s-via-only-json-rationalize-tech-47f227071c78?source=collection_archive---------10-----------------------#2021-04-01</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/b98b48e2140597eee9b8c73690f6bf9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:974/format:webp/0*TQNM-9i67bZ6TJlv.png"/></div></figure><p id="7a41" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们正在建立一个平台，用户可以来定义一个类似于<a class="ae jk" href="https://ifttt.com/explore/welcome_to_ifttt?utm_source=IFTTT&amp;utm_medium=Tout&amp;utm_campaign=Signedout_Audience" rel="noopener ugc nofollow" target="_blank"> IFTTT </a>的工作流，我们在内部将这些任务分配给各种工具，<a class="ae jk" href="https://airflow.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache airflow </a>就是其中之一。因为我们事先不知道工作流的定义是什么，所以我们需要在运行中创建气流DAG。让我们看看我们是如何做到这一点的。</p><h1 id="a92f" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">正在创建DAG对象</h1><p id="5783" class="pw-post-body-paragraph im in hi io b ip kj ir is it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj hb bi translated">由于Airflow考虑任何python文件(。py扩展名)作为潜在的DAG，并查找DAG的定义。我们所要做的就是动态创建DAGs对象。这可以通过下面的代码轻松实现。</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="476d" class="kx jm hi kt b fi ky kz l la lb">from airflow import DAG <br/>default_args = { <br/>   "owner": "airflow",<br/>   "start_date": datetime(2018, 1, 1),<br/>   "email": ["someEmail@gmail.com"],<br/>   "email_on_failure": False, <br/>} </span><span id="0949" class="kx jm hi kt b fi lc kz l la lb">with DAG( "DAG Name", schedule_interval=None,   default_args=default_args ) as dag:</span></pre><h1 id="6def" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">动态定义运算符</h1><p id="373f" class="pw-post-body-paragraph im in hi io b ip kj ir is it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj hb bi translated">一旦我们定义了<strong class="io hj"> DAG </strong>对象，第二个任务就是动态定义操作符，并将它们添加到创建的DAG中。我们现在需要的是所有相关操作符及其参数的表示。下面是可以用来做这件事的JSON。</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="b7b3" class="kx jm hi kt b fi ky kz l la lb">[ { <br/>    "name": "Start",<br/>    "_type": "airflow.operators.dummy_operator.DummyOperator",           "parameters": {},<br/> }, { <br/>   "name": "HTTPRequest",<br/>   "_type": "airflow.operators.http_operator.SimpleHttpOperator",   "parameters": { <br/>  "http_conn_id": "dummyapi",<br/>  "method": "GET", <br/>  "endpoint": "/api/users/2",<br/>  "headers": {},<br/>  "options": {},<br/>  "xcom_push": True, }<br/> }, { <br/>"name": "End",<br/>"_type": "airflow.operators.dummy_operator.DummyOperator", "parameters": {},<br/>}, { <br/>"name": "ExecuteCommand",<br/>"_type": "airflow.operators.bash_operator.BashOperator", "parameters": { "bash_command": "echo test" },<br/>} ]</span></pre><p id="573a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">{ "name": "HTTPRequest "，" _ type ":" air flow . operators . http _ operator。SimpleHttpOperator "，" position": [ 520，360 ]，" parameters ":{ " http _ conn _ id ":" dummy API "，" method": "GET "，" endpoint": "/api/users/2 "，" headers": {}，" options": {}，" xcom_push": True，} }，{ "name": "End "，" _ type ":" air flow . operators . dummy _ operator。DummyOperator "，"参数":{}，}，{ "name": "ExecuteCommand "，" _ type ":" air flow . operators . bash _ operator。BashOperator "，" parameters ":{ " bash _ command ":" echo test " }，} ]</p><p id="7724" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">一旦我们有了操作符及其类型的表示，我们就需要解释它并生成任务。下面提到的代码将为您做到这一点。</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="9b1d" class="kx jm hi kt b fi ky kz l la lb">def load_operator(name): <br/>  """Load operators dynamically""" <br/>  components = name.split('.') <br/>  mod = __import__(components[0])<br/>  for comp in components[1:]:<br/>     mod = getattr(mod, comp)<br/>  return mod </span><span id="5f04" class="kx jm hi kt b fi lc kz l la lb">tasks = {}<br/>for node in definition["nodes"]:<br/>   operator = load_operator(node["_type"])<br/>   params = node["parameters"]<br/>   node_name = node["name"].replace(" ", "")<br/>   params["task_id"] = node_name <br/>   params["dag"] = dag <br/>   tasks[node_name] = operator(**params)</span></pre><p id="fd33" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">上面的代码读取JSON并加载模块和操作符，然后通过从JSON传递参数来创建实例，并将在前面的实例中创建的DAG实例添加到这些任务中，以便将其链接到DAG。然后最终将其保存在字典中以备将来使用。</p><h1 id="7eee" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">动态创建任务关系</h1><p id="d035" class="pw-post-body-paragraph im in hi io b ip kj ir is it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj hb bi translated">现在我们已经有了DAG对象和操作符。最后一项任务是为DAG中的所有任务创建关系。例如，如果我们需要一个类似下图的DAG。</p><figure class="ko kp kq kr fd ij er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es ld"><img src="../Images/9284a98e95ca3a444fb49e000751b990.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*s-LOu-NPIGQJvXSR.jpg"/></div></div></figure><p id="b2d8" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在JSON中，我们可以使用一个对象来存储任务名称(作为键)和它们的值作为下游依赖项。</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="2bc6" class="kx jm hi kt b fi ky kz l la lb">{ <br/>  "Start": ["ExecuteCommand", "HTTPRequest"],<br/>  "HTTPRequest": ["End"],<br/>  "ExecuteCommand": ["End"] <br/>}</span></pre><p id="69d8" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">既然我们有了可以表示任务关系的数据。我们可以使用下面的代码为特定的DAG创建这些关系。</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="e846" class="kx jm hi kt b fi ky kz l la lb">for node_name, downstream_conn in definition["connections"].items(): for ds_task in downstream_conn: tasks[node_name] &gt;&gt; tasks[ds_task]</span></pre><p id="3316" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">对完整代码感兴趣的人，请访问这里的<a class="ae jk" href="https://gist.github.com/utkarsharma2/517797a7356c5168d5a99ee8b28fec00" rel="noopener ugc nofollow" target="_blank"/>。</p></div><div class="ab cl li lj gp lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="hb hc hd he hf"><p id="3f1a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><em class="lp">原载于2021年4月1日</em><a class="ae jk" href="https://rationalize.tech/apache-airflow/how-to-dynamically-create-apache-airflow-dags-via-only-json/" rel="noopener ugc nofollow" target="_blank"><em class="lp">https://rational . tech</em></a><em class="lp">。</em></p></div></div>    
</body>
</html>