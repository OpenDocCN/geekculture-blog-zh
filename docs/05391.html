<html>
<head>
<title>The Day My Mistake Brought Down Amazon.com</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我的错误让Amazon.com下台的那一天</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/the-multimillion-dollar-failure-that-changed-my-professional-life-for-the-better-2011-f96ad1afd9db?source=collection_archive---------1-----------------------#2021-07-20">https://medium.com/geekculture/the-multimillion-dollar-failure-that-changed-my-professional-life-for-the-better-2011-f96ad1afd9db?source=collection_archive---------1-----------------------#2021-07-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="9bf3" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">拥抱意外收获:有时一次尴尬的失败会让你走上一条意想不到的新路</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/451aed7a620198d8ef5b678ba0cedf2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bcPQ6pX9S7_e9PP6W3ehiA.png"/></div></div></figure><p id="3a3b" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">想象一下。你在亚马逊已经两年了。你克服了学习文化和内部工具的困难，最终变得富有成效，并开始追求晋升为高级工程师。生活是美好的。您负责Amazon.com关键路径服务的工程和运营卓越性。然而今天，一年中最繁忙、最重要的购物日，你的服务却出现了故障，造成了数百万美元的损失。分秒必争，全靠你了。这是将改变你一生的事件。</p><p id="e46b" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">对我来说，那天是我职业生涯的转折点。不知何故，这个毁灭性的、可怕的事件变成了一个出人意料的积极支点。这实际上让我意外地快速成为了亚马逊的首席工程师！</p><blockquote class="kf kg kh"><p id="430f" class="jj jk ki jl b jm jn ij jo jp jq im jr kj jt ju jv kk jx jy jz kl kb kc kd ke hb bi translated">我们的生活就像从山上流下的水，或多或少朝着一个方向流动，直到我们溅入一些迫使我们寻找新路线的东西。水从不等待。它改变形状，绕着东西流动，找到别人从未想过的秘密路径。—阿瑟·高顿</p></blockquote><p id="ac00" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">大多数零售网站，比如亚马逊，使用某种点击流服务，负责数百万次网站点击(用户X浏览了页面Y，然后浏览了页面Z，购买了商品P，等等)。这些数据用于分析、机器学习，有时甚至用于实时商业决策和行为调整。早在2011年，我的工作就是找出我们将如何测试它。在你太激动之前，我要告诉你:[a]我将跳过亚马逊内部的细节，用通用术语来描述它,[b]架构已经发生了很大的变化，今天看起来与十年前完全不同,[c]我们花了数年时间来识别和消除像我将要描述的瓶颈。</p><p id="3d2c" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我列出了一长串需要测试的东西，自动化和运行测试的成本，以及不测试特定东西的风险。我看了一下时间表，在我实际能完成的数量上画了一条硬线，然后让我的队友来执行。本质上:“这是我要测试的东西，这是我不会测试的东西。”正好落在这条线下面的是<em class="ki">负载测试服务</em>。这样做的成本很高，而且我认为这项服务不太可能遇到扩展瓶颈。我的服务在当时世界上最大的Hadoop集群之一中通过map/reduce愉快地处理了万亿字节的数据，使用AWS S3进行存储。Hadoop和S3都是高度可扩展的，对吗？</p><p id="5f66" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">Amazon.com在黑色星期五，或网络星期一，或黄金日的交通流量比一年中的任何一天都多，这可能并不奇怪。<a class="ae km" href="https://www.cnbc.com/2021/05/01/how-much-revenue-tech-giants-like-amazon-and-apple-make-per-minute.html?fbclid=IwAR3Lx_fdi4bDDZ_FvKSVbBmqYM9uXmlImLyJcabn5q71IPxfoTW-z_U2HmE" rel="noopener ugc nofollow" target="_blank">即使是几分钟的停机时间也意味着数百万美元的损失</a>。所以那些是你害怕的巅峰日子。以及为什么您真的应该负载测试您的产品，以确保它可以优雅地处理增加的吞吐量！</p><p id="2c05" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">随着2011年黑色星期五的流量激增，我开始注意到我的服务运行得有点热(CPU使用率、内存使用率、网络带宽指标都达到了阈值)。当我们进入高峰时段时，很明显我们没有足够的容量来处理预计的流量。今天，这个问题可能会通过AWS自动缩放自动解决，或者您可以通过请求更多的AWS EC2实例在一分钟内自己解决它。或者更好的方法是将整个问题交给无服务器解决(AWS Lambda或AWS ECS)。但这是在裸机时代:这项服务在实际的物理主机上执行。所以，我们几乎是绕着大楼跑，问半随机的人，如果他们有多余的主机，我们可以重新利用到我们的舰队，非常-请。我们确实找到了主机(很多)，我们确实重新调整了它们的用途，指标又回到了绿色。我觉得我们就像是在一部纪录片中的“T2，距离灾难只有几秒钟”。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es kn"><img src="../Images/f701f0c41a2f4690c4296336de59aea8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PNz5R1Bq8b2FhuTm8MBkQQ.png"/></div></div><figcaption class="ko kp et er es kq kr bd b be z dx">Failure#1: State 1 (normal, service metrics ok)</figcaption></figure><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ks"><img src="../Images/0bd6ba9747523e47ff1e2e6bfe67407c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5LMEXw4yKzuZ-QDZ28zJKw.png"/></div></div><figcaption class="ko kp et er es kq kr bd b be z dx">Failure#1: State 2 (service metrics indicate running out of capacity)</figcaption></figure><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es kn"><img src="../Images/9b33334e44cd587d238cd06c19709d1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ma5YLGC3JvVnNBQpkIoPMA.png"/></div></div><figcaption class="ko kp et er es kq kr bd b be z dx">Failure#1: State 3 (added capacity, service metrics ok again)</figcaption></figure><p id="5b34" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">不过，我们还没完。<em class="ki">我们只是把一个瓶颈移到了堆栈的更深处。我忽略了一个小细节。对于每个服务调用，我们刚刚扩展的服务还会向Oracle数据库写入一段元数据！这是你在当今世界不太可能遇到的那种问题，因为你可能用AWS DynamoDB运行这样的服务(或者甚至AWS RDS会拯救我们)。但是，这是在2011年，我们有一个实际的Oracle数据库，运行在一个实际的主机上，没有经过适当的扩展来处理一个小时前我们添加的额外容量。<a class="ae km" href="https://www.businessinsider.com/amazon-consumer-business-last-oracle-database-aws-2019-10" rel="noopener ugc nofollow" target="_blank">亚马逊最终从架构上彻底抛弃了甲骨文</a>，但我们还没到那一步。</em></p><p id="1a29" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我们完了(三小时内第二次)。数以千计的主机试图同时写入数据的争用最终到达了数据库。一旦数据库停止响应，那数千台主机就无法运行。重试开始起作用，使问题变得更糟，并导致不断升级的故障。最终，这成为了高吞吐量分布式系统失败的典型案例。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es kt"><img src="../Images/cd682b2b2b71894134517834ddac4dbe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R9TCPgxmA9WtEqWw1p_tFA.png"/></div></div><figcaption class="ko kp et er es kq kr bd b be z dx">Failure#2: State 1 (normal, after we scaled the service up)</figcaption></figure><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ku"><img src="../Images/2a122195018546eb26af821106282163.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qx9Z5x4vSX-5AeSmFt_QwQ.png"/></div></div><figcaption class="ko kp et er es kq kr bd b be z dx">Failure#2: State 2 (with newly added hosts, database has more traffic than expected, contention for writes)</figcaption></figure><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es kv"><img src="../Images/b4fe4b4796059a7653b30e27d49d0e31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IELyBalQ0iABRGGhlBo0eQ.png"/></div></div><figcaption class="ko kp et er es kq kr bd b be z dx">Failure#2: State 3 (with database down, the entire fleet can’t do anything, cascading failures)</figcaption></figure><p id="b95f" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">那天我学到了一些高层次的东西。首先也是最重要的是，<strong class="jl hj">您的系统的可伸缩性取决于您最不可伸缩的组件</strong>。我们拥有像Hadoop和S3这样的可水平扩展的构建模块并不重要。我们有一个伸缩性很差的数据库，它成了一个争用点，所以整个架构从一开始就注定要失败。其次，<strong class="jl hj">有时候，如果存在根本性的架构缺陷，快速解决方案只会拖延时间。我们摆脱了第一次失败，只是让问题进一步发展，直到我们遇到第二次失败。</strong></p><p id="1292" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">这太尴尬了。<a class="ae km" href="https://www.linkedin.com/in/peter-commons-b541a0/" rel="noopener ugc nofollow" target="_blank">导演彼得</a>约了我1:1见面。我吓坏了。彼得比我高4级，是一个严肃、直接的领导者。多年来，彼得和我成为了好朋友，他也成为了我的导师之一——我今天的很多风格都来自于他和其他像他一样的亚马逊领导者。但是，在2011年，我不在那里，所以我很害怕。彼得显然很沮丧，他花了很长时间问一些难题。但他更感兴趣的是我如何在未来防止这种情况，而不是责备我没有预见到这一点。</p><p id="9cb9" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">最终，我说了这样的话:<em class="ki">“Peter，我可以在一个测试环境中进行负载测试，这样可以找到一些bug。但实际上，我需要针对生产环境进行测试，以真正证明它能够处理我们预期的流量。任何针对非生产环境的测试都只是对生产实际行为的假设。”</em></p><p id="77d0" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">今天，针对prod的负载测试很常见。但在2011年，这有点像自杀。彼得迷惑地看了我一眼；我知道我已经激起了他的兴趣，所以我觉得大胆，并继续我的疯狂想法。我的想法是:<em class="ki">我将重放生产流量，并将生产处理的吞吐量提高三倍，同时运行真实客户的实时流量，以进行测试。如果它失败了，我宁愿它失败，因为我们都在关注它，并且已经有了恢复机制，可以随时运行，而且经济损失也不会那么高。另一个选择是在一年中最繁忙的购物日失败。</em></p><p id="04b5" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">彼得笑了笑，并以一个笑话结束了会议:“我喜欢这个！你要么被解雇，要么被提升！”我认为有50%的晋升机会对我来说已经足够冒险了。所以我开始研究如何实现这个疯狂的想法。我花了大量的时间来了解数据如何在服务之间流动，流量在正常情况下是如何分布的，负载等因素在实际高峰日是如何变化的，等等。我想出了如何修改生产环境来安全地接受测试流量，以及如何修改指标，以便我发送的测试流量不会污染生产指标。今天，我们认为这些机制是理所当然的；但是，在2011年，每一步都像是未知的领域。我研究了我的依赖项是否能够处理我将要引入的额外流量。我修改了我们的操作仪表板，这样我们就可以立即了解系统的任何部分何时会受到测试的影响。我想出了实现紧急停止的方法，以及在出现任何问题时将系统恢复到工作状态的计划。我协调了几十个上游和下游的服务。我抓起一个寻呼机，ssh到主测试主机，关掉负载生成器，屏住呼吸，让我新添加的Pb级合成数据进入系统。</p><p id="7f3a" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">几分钟之内，我可以看到我的服务的流量仪表板上升；和向上；向上(如预期)。事情进展顺利了几个小时，直到我注意到在我们的一个服务中磁盘使用量意外攀升。我做了一个粗略的计算，并预测在接下来的一两个小时内，我将有几千台主机用完磁盘空间！写在墙上；一旦这些主机用完了磁盘空间，真正的客户就会受到影响。我中止了测试，花了一下午的时间试图找出为什么会发生这种情况。您可以看到，该服务是CPU受限的，并且据我们所知没有使用本地磁盘。事实证明，我们的依赖之一是使用临时文件，它有一个错误，如果有效负载大于一兆字节，它会泄漏一个文件句柄。这个bug已经生产了几个月，但在正常的日子里，超过一兆字节的有效载荷并不常见，而且服务经常被反弹，泄漏永远不会积累。但在黑色星期五和网络星期一这一周，这项服务不会被反弹，大多数有效负载都将超过1兆字节，因为零售网站处理的流量明显更多。</p><p id="c207" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我发现了(并阻止了)一只金色的虫子！这个漏洞会在2012年造成另一次数百万美元的停机。我不认为我会在测试环境中发现这个bug我发现这一点是因为我坚持在生产规模上对生产进行测试，使用类似生产的数据来模拟实际高峰日的交通模式。</p><p id="36d0" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我得意洋洋地冲进彼得的办公室，告诉他。“我猜你不会被解雇了，是吗？”他对我报以微笑。在那一周的时间里，我发现并阻止了几个更重大的风险。2012年网络星期一进展顺利。我救赎了自己。</p><p id="93fc" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我把一次尴尬的失败变成了一个成功的故事。半年后，我被提升为高级工程师，那项工作与此有很大关系。两年半后，我被提升为首席工程师，这些事件也让我走上了这条道路。以高吞吐量对高度分布式系统进行负载测试的经历点燃了我的热情。<a class="ae km" href="https://carloarg02.medium.com/how-i-grew-an-engineering-productivity-tool-to-impact-thousands-of-engineers-at-amazon-and-how-28a990091207" rel="noopener"> <strong class="jl hj">我创建并发展了亚马逊的负载和性能测试平台(TPSGenerator)。</strong> </a>到2020年我离开亚马逊的时候，它已经被成千上万的工程师用于商业关键应用，以每秒数亿次的交易速度运行，并由一个了不起的工程师团队维护。它防止了数百起运营问题，并节省了数百万美元。这一切都始于2011年那个星期五早上的事件。</p><p id="9810" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我非常喜欢这句话，我将重复它来结束我的小故事…</p><blockquote class="kf kg kh"><p id="d5de" class="jj jk ki jl b jm jn ij jo jp jq im jr kj jt ju jv kk jx jy jz kl kb kc kd ke hb bi translated">我们的生活就像从山上流下的水，或多或少朝着一个方向流动，直到我们溅入一些迫使我们寻找新路线的东西。水从不等待。它改变形状，绕着东西流动，找到别人从未想过的秘密路径。—阿瑟·高顿</p></blockquote><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es kw"><img src="../Images/34af3941919c58fa879d224dade3d7dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SwfjgKdGCUchS0M_GMlB3A.png"/></div></div><figcaption class="ko kp et er es kq kr bd b be z dx"><strong class="bd kx">If you’re curious, </strong><a class="ae km" href="https://www.youtube.com/watch?v=pgnQQoTMBhI" rel="noopener ugc nofollow" target="_blank"><strong class="bd kx">I actually gave an external talk at AWS reInvent in 2013 about this</strong></a></figcaption></figure></div></div>    
</body>
</html>