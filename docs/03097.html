<html>
<head>
<title>Hunting down the mysterious case of keystroke-eating SSH sessions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">追捕吃击键SSH会话的神秘案例</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/hunting-down-the-mysterious-case-of-keystroke-eating-ssh-sessions-3ae7a9350200?source=collection_archive---------26-----------------------#2021-05-31">https://medium.com/geekculture/hunting-down-the-mysterious-case-of-keystroke-eating-ssh-sessions-3ae7a9350200?source=collection_archive---------26-----------------------#2021-05-31</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/ef4dc636a1f8413f62605da6c94e15e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*teWyJLnG5UAMVSgxwJDzMQ.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">Debugging SSH session with strace.</figcaption></figure><div class=""/><p id="1bfb" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">几周前，我的同事通知我，他在家里工作时，与其中一台服务器的SSH会话出现了问题。他解释说，当他用Putty连接到服务器时，他必须按几次字母才能在终端中显示出来。狩猎开始了。</p><h1 id="8e4b" class="js jt hx bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">核实事实</h1><p id="775d" class="pw-post-body-paragraph iu iv hx iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">他连接的服务器是CentOS 8。他使用LTE调制解调器连接，并使用DirectAccess连接到公司网络。他的连接有点慢且不稳定，但对于RDP和微软团队的会议来说已经足够了。这只发生在Putty上(检查版本0.71、0.73、0.74)，而来自Cygwin或cmd的ssh工作得很好。</p><h1 id="9082" class="js jt hx bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">假设#1 —网络相关问题</h1><p id="86e4" class="pw-post-body-paragraph iu iv hx iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">过去，我们在LTE连接方面遇到过问题(MTU大小、会话掉线……)，所以我检查了一下，看看是不是LTE的问题。我通过有线LTE连接将笔记本电脑和智能手机连接起来，确实遇到了同样的问题——按键丢失。我还尝试通过公司的WiFi和LAN(没有DirectAccess)连接到同一台服务器，我得到了相同的结果——击键丢失。我以前在使用CentOS 8服务器时没有遇到过这个问题，但我最近也没有使用它。</p><p id="4077" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">但是问题并不是一直存在的。它来来去去，或者看起来是这样。在DirectAccess上，它出现得更频繁。</p><h1 id="7540" class="js jt hx bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">被遗忘的事实</h1><p id="32e0" class="pw-post-body-paragraph iu iv hx iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">然后我开始检查服务器上的网络设置:两个网络设备连接到802.3ad <code class="du kv kw kx ky b">bond0</code>和<code class="du kv kw kx ky b">layer2</code>哈希。这应该不会引起任何问题。</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="00f7" class="lh jt hx ky b fi li lj l lk ll">Bonding Mode: IEEE 802.3ad Dynamic link aggregation<br/>Transmit Hash Policy: <strong class="ky hy">layer2</strong> (0)<br/>MII Status: up<br/>MII Polling Interval (ms): 1<br/>Up Delay (ms): 0<br/>Down Delay (ms): 0<br/>...</span></pre><h1 id="8a17" class="js jt hx bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">假设#2 —端到端数据包路径上的问题</h1><p id="2e2f" class="pw-post-body-paragraph iu iv hx iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">要检查两端的数据包，可以在Windows客户机上使用Wireshark，在服务器上使用tcpdump。</p><p id="f3e9" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在服务器上，我运行tcpdump，我可以看到流量。但这只是一半的流量，只是一个方向。当时我对tcpdump一无所知，所以我寻求帮助。事实证明，tcpdump只抓取它发现的第一个接口的流量。我不得不加上<code class="du kv kw kx ky b">-i bond0</code>。现在，我可以看到双向的数据包。</p><p id="fca3" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在客户端，我只有一些奇怪的TLSv1.2流量，没有SSH流量。嗯……这肯定是DirectAccess (IP-HTTPS隧道)。我在这里看不到任何东西，因为“所有东西”在到达npcap拦截流量的接口之前都进入了隧道。我还发现了微软的网络监视器，这是一个非常好的工具，但同样，它不能在IP-HTTPS隧道吸收它们之前得到数据包(没有双关语)。</p><p id="936b" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在被IP-HTTPS吃掉之前，在VirtualBox中运行一个Windows 10的实例并在那里捕获ttaffic怎么样？但是看起来这是不可能的，因为VirtualBox只部分支持IPv6。</p><h1 id="006c" class="js jt hx bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">新希望</h1><p id="d4aa" class="pw-post-body-paragraph iu iv hx iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">但我很幸运，击键掉落在WiFi上持续发生。这意味着没有直接访问，所以我终于可以用Wireshark嗅探数据包，但一切似乎都很好。因为我想做更多不同的包，我试图在Windows和Centos上得到相同的格式。所以我也在Centos上运行了Wireshark来比较数据包。</p><p id="f2e7" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">然后我找到了tcpdump for Windows的试用版，我终于可以做一些不同的和更仔细的检查。我所看到的是数据包从端到端传输没有任何问题。</p><p id="e0c5" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">有些事情我确实注意到了，但当时并不理解:</p><ul class=""><li id="8c12" class="lm ln hx iw b ix iy jb jc jf lo jj lp jn lq jr lr ls lt lu bi translated">CRC校验和仅用于装饰，以防实际的校验和计算被卸载到网络接口，</li><li id="7783" class="lm ln hx iw b ix lv jb lw jf lx jj ly jn lz jr lr ls lt lu bi translated">可以在末尾添加一些字节进行填充，但可以安全地忽略。</li></ul><p id="055a" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">除此之外，这些包裹看起来都很好，在运送途中也没有发生什么可怕的事情。不同之处被标记为<strong class="iw hy"> <em class="ma">粗体和斜体</em> </strong>(我更喜欢一些颜色，但medium.com在这个简单的编辑器中不允许)。</p><p id="646f" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">传输击键时客户端捕获正常—客户端:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="aa02" class="lh jt hx ky b fi li lj l lk ll">11:10:25.461774 IP 172.17.9.120.53014 &gt; 10.122.12.185.22: Flags [P.], seq 836074285:836074349, ack 725649935, win 2052, length 64<br/>0x0000:  4500 0068 7372 4000 <strong class="ky hy"><em class="ma">80</em></strong>06 <strong class="ky hy"><em class="ma">0000</em></strong><em class="ma"> </em>ac11 0978 # TTL and checksum<br/>0x0010:  0a7a 0cb9 cf16 0016 31d5 7b2d 2b40 8a0f<br/>0x0020:  5018 0804 <strong class="ky hy"><em class="ma">cd16 </em></strong>0000 09f1 28f1 f9cf 79e9 # checksum<br/>0x0030:  987d c52c c645 22d2 fdf1 5047 a68d 6aab<br/>0x0040:  70f1 6d58 b6d5 975e e019 858c 7394 f368<br/>0x0050:  8b29 cabd 3d86 8d58 40ae 9968 c794 1e52<br/>0x0060:  ea0e f537 de51 c27d</span></pre><p id="74f7" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">服务器端的相同数据包:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="3c19" class="lh jt hx ky b fi li lj l lk ll">12:10:25.448598 IP 172.17.9.120.53014 &gt; 10.122.12.185.ssh: Flags [P.], seq 836074285:836074349, ack 725649935, win 2052, length 64<br/>0x0000:  4500 0068 7372 4000 <strong class="ky hy"><em class="ma">7b</em></strong>06 <strong class="ky hy"><em class="ma">bf61 </em></strong>ac11 0978 # TTL and checksum<br/>0x0010:  0a7a 0cb9 cf16 0016 31d5 7b2d 2b40 8a0f<br/>0x0020:  5018 0804 <strong class="ky hy"><em class="ma">0281</em> </strong>0000 09f1 28f1 f9cf 79e9 # checksum<br/>0x0030:  987d c52c c645 22d2 fdf1 5047 a68d 6aab<br/>0x0040:  70f1 6d58 b6d5 975e e019 858c 7394 f368<br/>0x0050:  8b29 cabd 3d86 8d58 40ae 9968 c794 1e52<br/>0x0060:  ea0e f537 de51 c27d</span></pre><p id="1ab9" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">来自服务器的ACK服务器端:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="b6bf" class="lh jt hx ky b fi li lj l lk ll">12:10:25.448625 IP 10.122.12.185.ssh &gt; 172.17.9.120.53014: Flags [.], ack 64, win 406, length 0<br/>0x0000:  4548 0028 41e0 4000 4006 2bec 0a7a 0cb9<br/>0x0010:  ac11 0978 0016 cf16 2b40 8a0f 31d5 7b6d<br/>0x0020:  5010 0196 <strong class="ky hy"><em class="ma">ccd6 </em></strong>0000</span></pre><p id="bfcf" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在客户端:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="4923" class="lh jt hx ky b fi li lj l lk ll">11:10:25.463026 IP 10.122.12.185.22 &gt; 172.17.9.120.53014: Flags [.], ack 64, win 406, length 0<br/>0x0000:  4548 0028 41e0 4000 3c06 2fec 0a7a 0cb9<br/>0x0010:  ac11 0978 0016 cf16 2b40 8a0f 31d5 7b6d<br/>0x0020:  5010 0196 <strong class="ky hy"><em class="ma">afc3 </em></strong>0000 <strong class="ky hy"><em class="ma">0000 0000 0000</em></strong> (ACK packet gets another 6 bytes)</span></pre><p id="0989" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">TTL再次降低，校验和不匹配，因为计算被卸载到网卡。我们在目的地看到额外的6个字节，但它们只是表示填充，可以忽略。</p><p id="bfb3" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">然后服务器用SSH数据包响应，客户端用ACK响应。服务器端捕获这两个数据包:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="e135" class="lh jt hx ky b fi li lj l lk ll">12:10:25.448879 IP 10.122.12.185.ssh &gt; 172.17.9.120.53014: Flags [P.], seq 1:65, ack 64, win 406, length 64<br/>0x0000:  4548 0068 41e1 4000 <strong class="ky hy"><em class="ma">40</em></strong>06 <strong class="ky hy"><em class="ma">2bab </em></strong>0a7a 0cb9<br/>0x0010:  ac11 0978 0016 cf16 2b40 8a0f 31d5 7b6d<br/>0x0020:  5018 0196 <strong class="ky hy"><em class="ma">cd16 </em></strong>0000 c917 80ed e033 4956<br/>0x0030:  36cd af86 a407 67bc 226a 7f55 21a2 2341<br/>0x0040:  b0ef 1157 0163 46c0 1f70 ebbc 10dd 5d23<br/>0x0050:  5b00 9d9f f68f 1efa 81a4 9d65 997f 6348<br/>0x0060:  235d 2bb5 a95a a0af<br/>12:10:25.503202 IP 172.17.9.120.53014 &gt; 10.122.12.185.ssh: Flags [.], ack 65, win 2051, length 0<br/>0x0000:  4500 0028 7374 4000 7b06 bf9f ac11 0978<br/>0x0010:  0a7a 0cb9 cf16 0016 31d5 7b6d 2b40 8a4f<br/>0x0020:  5010 0803 <strong class="ky hy"><em class="ma">a916 </em></strong>0000 <strong class="ky hy"><em class="ma">0000 6d85 99ab</em></strong> </span></pre><p id="9944" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">客户端捕获:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="76db" class="lh jt hx ky b fi li lj l lk ll">11:10:25.463026 IP 10.122.12.185.22 &gt; 172.17.9.120.53014: Flags [P.], seq 1:65, ack 64, win 406, length 64<br/>0x0000:  4548 0068 41e1 4000 <strong class="ky hy"><em class="ma">3c</em></strong>06 <strong class="ky hy"><em class="ma">2fab </em></strong>0a7a 0cb9<br/>0x0010:  ac11 0978 0016 cf16 2b40 8a0f 31d5 7b6d<br/>0x0020:  5018 0196 <strong class="ky hy"><em class="ma">1c81 </em></strong>0000 c917 80ed e033 4956<br/>0x0030:  36cd af86 a407 67bc 226a 7f55 21a2 2341<br/>0x0040:  b0ef 1157 0163 46c0 1f70 ebbc 10dd 5d23<br/>0x0050:  5b00 9d9f f68f 1efa 81a4 9d65 997f 6348<br/>0x0060:  235d 2bb5 a95a a0af<br/>11:10:25.516565 IP 172.17.9.120.53014 &gt; 10.122.12.185.22: Flags [.], ack 65, win 2051, length 0<br/>0x0000:  4500 0028 7374 4000 8006 0000 ac11 0978<br/>0x0010:  0a7a 0cb9 cf16 0016 31d5 7b6d 2b40 8a4f<br/>0x0020:  5010 0803 <strong class="ky hy"><em class="ma">ccd6 </em></strong>0000</span></pre><p id="6ef0" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">数据包再次按照预期通过网络。客户端和服务器的时间相差一个小时(时区之类的)。</p><h2 id="9e15" class="lh jt hx bd ju mb mc md jy me mf mg kc jf mh mi kg jj mj mk kk jn ml mm ko mn bi translated">“丢失击键”数据包流</h2><p id="9d2d" class="pw-post-body-paragraph iu iv hx iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">击键未返回时客户端的数据包捕获:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="1ec6" class="lh jt hx ky b fi li lj l lk ll">11:01:18.689650 IP 172.17.9.120.53014 &gt; 10.122.12.185.22: Flags [P.], seq 836072861:836072925, ack 725648239, win 2050, length 64<br/>0x0000:  4500 0068 7359 4000 <strong class="ky hy"><em class="ma">80</em></strong>06 <strong class="ky hy"><em class="ma">0000 </em></strong>ac11 0978<br/>0x0010:  0a7a 0cb9 cf16 0016 31d5 759d 2b40 836f<br/>0x0020:  5018 0802 <strong class="ky hy"><em class="ma">cd16 </em></strong>0000 59f4 bbcf ada8 46a9<br/>0x0030:  e4b2 5b5e 1895 a84e d4f5 7228 22da e8cc<br/>0x0040:  4858 bc85 3582 5754 14f9 ebf0 b153 edd4<br/>0x0050:  59a9 9e64 0514 03d6 7fe3 2270 22d3 eb4a<br/>0x0060:  fa37 4a90 6fbc b902<br/>11:01:18.730792 IP 10.122.12.185.22 &gt; 172.17.9.120.53014: Flags [.], ack 64, win 383, length 0<br/>0x0000:  4548 0028 41d5 4000 <strong class="ky hy"><em class="ma">3c</em></strong>06 <strong class="ky hy"><em class="ma">2ff7 </em></strong>0a7a 0cb9<br/>0x0010:  ac11 0978 0016 cf16 2b40 836f 31d5 75dd<br/>0x0020:  5010 017f <strong class="ky hy"><em class="ma">bc0a </em></strong>0000 <strong class="ky hy"><em class="ma">0000 0000 0000 </em></strong></span></pre><p id="b0eb" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">…并在击键未返回时在服务器端捕获:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="b890" class="lh jt hx ky b fi li lj l lk ll">12:01:18.676514 IP 172.17.9.120.53014 &gt; 10.122.12.185.ssh: Flags [P.], seq 836072861:836072925, ack 725648239, win 2050, length 64<br/>0x0000:  4500 0068 7359 4000 <strong class="ky hy"><em class="ma">7b</em></strong>06 <strong class="ky hy"><em class="ma">bf7a </em></strong>ac11 0978<br/>0x0010:  0a7a 0cb9 cf16 0016 31d5 759d 2b40 836f<br/>0x0020:  5018 0802 <strong class="ky hy"><em class="ma">06f7 </em></strong>0000 59f4 bbcf ada8 46a9<br/>0x0030:  e4b2 5b5e 1895 a84e d4f5 7228 22da e8cc<br/>0x0040:  4858 bc85 3582 5754 14f9 ebf0 b153 edd4<br/>0x0050:  59a9 9e64 0514 03d6 7fe3 2270 22d3 eb4a<br/>0x0060:  fa37 4a90 6fbc b902<br/>12:01:18.717045 IP 10.122.12.185.ssh &gt; 172.17.9.120.53014: Flags [.], ack 64, win 383, length 0<br/>0x0000:  4548 0028 41d5 4000 <strong class="ky hy"><em class="ma">40</em></strong>06 <strong class="ky hy"><em class="ma">2bf7 </em></strong>0a7a 0cb9<br/>0x0010:  ac11 0978 0016 cf16 2b40 836f 31d5 75dd<br/>0x0020:  5010 017f <strong class="ky hy"><em class="ma">ccd6 </em></strong>0000 </span></pre><p id="281f" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">TTL和校验和正在做他们的事情，一些字节被添加，但除此之外一切看起来都很好。数据包流<strong class="iw hy"> <em class="ma">按预期运行</em> </strong>。</p><blockquote class="mo"><p id="2899" class="mp mq hx bd mr ms mt mu mv mw mx jr dx translated">嗯…看起来服务器因为某种原因没有返回数据包。</p></blockquote><p id="a2b7" class="pw-post-body-paragraph iu iv hx iw b ix my iz ja jb mz jd je jf na jh ji jj nb jl jm jn nc jp jq jr hb bi translated">这是我开始深入研究服务器上发生的事情的地方。</p><h1 id="25db" class="js jt hx bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">假设# 3——sshd进程中的角色不会到达bash进程并返回</h1><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="9a6b" class="lh jt hx ky b fi li lj l lk ll">root@baraba1: ~# tcpdump -v -i bond0 -n -nn -s 0 -x port 22<br/>dropped privs to tcpdump<br/>tcpdump: listening on bond0, link-type EN10MB (Ethernet), capture size 262144 bytes<br/>10:12:39.176304 IP (tos 0x0, ttl 123, id 5962, offset 0, flags [DF], proto TCP (6), length 104)<br/>    172.17.9.120.64157 &gt; 10.122.12.185.22: Flags [P.], cksum 0x2ef8 (correct), seq 219111870:219111934, ack 2302703198, win 2053, length 64<br/>        0x0000:  4500 0068 174a 4000 7b06 1b8a ac11 0978<br/>        0x0010:  0a7a 0cb9 fa9d 0016 0d0f 61be 8940 765e<br/>        0x0020:  5018 0805 2ef8 0000 0c3d 439e b8e6 226e<br/>        0x0030:  9534 843e 4643 4b4d 2eae a27d 38f4 e415<br/>        0x0040:  81ec 157e b252 a109 765e 8968 d477 bbb5<br/>        0x0050:  24f2 aeae bf10 3560 bf22 2d3a fd30 3234<br/>        0x0060:  6b64 50f0 c388 9fdc<br/>10:12:39.217046 IP (tos 0x48, ttl 64, id 39444, offset 0, flags [DF], proto TCP (6), length 40)<br/>    10.122.12.185.22 &gt; 172.17.9.120.64157: Flags [.], cksum 0xccd6 (incorrect -&gt; 0x788e), ack 64, win 298, length 0<br/>        0x0000:  4548 0028 9a14 4000 4006 d3b7 0a7a 0cb9<br/>        0x0010:  ac11 0978 0016 fa9d 8940 765e 0d0f 61fe<br/>        0x0020:  5010 012a ccd6 0000</span></pre><p id="923d" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">好的，客户端的TCP端口是64157。我们可以在服务器上找到负责这个连接的进程。</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="9bec" class="lh jt hx ky b fi li lj l lk ll">root@baraba1: ~# netstat --ip -n -p | grep 64157<br/>tcp        0      0 10.122.12.185:22        172.17.9.120:64157      ESTABLISHED 1276494/sshd: miha</span></pre><p id="e814" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">SSH服务器进程ID 1276494连接到我们的客户机。</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="847b" class="lh jt hx ky b fi li lj l lk ll">root@baraba1: ~# ps axl<br/>F   UID     PID    PPID PRI  NI    VSZ   RSS WCHAN  STAT TTY        TIME COMMAND<br/>...<br/>4     0 1276494 1102993  20   0 163700 10788 x64_sy Ss   ?          0:00 sshd: miha [priv]<br/>5  1003 1276496 1276494  20   0 163700  5600 core_s S    ?          0:00 sshd: miha@pts/9<br/>0  1003 1276497 1276496  20   0  25524  5348 core_s Ss+  pts/9      0:00 -bash<br/>...</span><span id="b212" class="lh jt hx ky b fi nd lj l lk ll">root@baraba1: ~# pstree -p 1276494<br/>sshd(1276494)───sshd(1276496)───bash(1276497)</span></pre><p id="76aa" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">但是<code class="du kv kw kx ky b">strace -p 1276494</code>没有给我们任何有用的见解。</p><p id="b7e5" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">下一个要检查的进程是1276496。让我们检查一下，当在Putty提示符下键入字母“a”时，服务器上会发生什么——在Putty终端中输入“a”的情况下:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="6f7c" class="lh jt hx ky b fi li lj l lk ll">strace -p 1276496<br/>) = 1 (in [5])<br/>rt_sigprocmask(SIG_BLOCK, [CHLD], [], 8) = 0<br/>rt_sigprocmask(SIG_SETMASK, [], NULL, 8) = 0<br/>clock_gettime(CLOCK_BOOTTIME, {tv_sec=35176799, tv_nsec=820994472}) = 0<br/>read(5, "\204\320\f\225\236\212N\355\340v\0\226s\20\266|\200\275\n`\320\343\376n\247hG/\320\242yP"..., 16384) = 64<br/>clock_gettime(CLOCK_BOOTTIME, {tv_sec=35176799, tv_nsec=821198622}) = 0<br/>select(21, [5 12 14 15 20], [16], NULL, NULL) = 1 (out [16])<br/>rt_sigprocmask(SIG_BLOCK, [CHLD], [], 8) = 0<br/>rt_sigprocmask(SIG_SETMASK, [], NULL, 8) = 0<br/>clock_gettime(CLOCK_BOOTTIME, {tv_sec=35176799, tv_nsec=821329327}) = 0<br/>write(16, "a", 1)                       = 1<br/>ioctl(16, TCGETS, {B38400 opost isig -icanon -echo ...}) = 0<br/>clock_gettime(CLOCK_BOOTTIME, {tv_sec=35176799, tv_nsec=821401615}) = 0<br/>select(21, [5 12 14 15 20], [], NULL, NULL) = 1 (in [20])<br/>rt_sigprocmask(SIG_BLOCK, [CHLD], [], 8) = 0<br/>rt_sigprocmask(SIG_SETMASK, [], NULL, 8) = 0<br/>clock_gettime(CLOCK_BOOTTIME, {tv_sec=35176799, tv_nsec=821482831}) = 0<br/>read(20, "a", 16384)                    = 1<br/>getpid()                                = 1276496<br/>clock_gettime(CLOCK_BOOTTIME, {tv_sec=35176799, tv_nsec=821532968}) = 0<br/>select(21, [5 12 14 15 20], [5], NULL, NULL) = 1 (out [5])<br/>rt_sigprocmask(SIG_BLOCK, [CHLD], [], 8) = 0<br/>rt_sigprocmask(SIG_SETMASK, [], NULL, 8) = 0<br/>clock_gettime(CLOCK_BOOTTIME, {tv_sec=35176799, tv_nsec=821600705}) = 0<br/>write(5, "\272v:\305\32\267\203\2329\363J\353\\6\vh\342\17\6\217\317\255\342\222a\3r[\376;\335\25"..., 64) = 64<br/>clock_gettime(CLOCK_BOOTTIME, {tv_sec=35176799, tv_nsec=821662407}) = 0<br/>select(21, [5 12 14 15 20], [], NULL, NULL</span></pre><p id="ecbd" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我们可以看到从fd 5中读取的加密字节片段:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="9d05" class="lh jt hx ky b fi li lj l lk ll">"\204\320\f\225\236\212N\355\340v\0\226s\20\266|\200\275\n`\320\343\376n\247hG/\320\242yP" ... -&gt;</span><span id="68e1" class="lh jt hx ky b fi nd lj l lk ll">                    <strong class="ky hy"><em class="ma">84d0 0c95 9e8a 4eed <br/>e076 0096 7310 b67c 80bd 0a60 d0e3 fe6e <br/>a768 472f d0a2 7950</em></strong> ...</span></pre><p id="27ed" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">…在服务器的tcpdump中:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="d500" class="lh jt hx ky b fi li lj l lk ll">11:33:38.224241 IP (tos 0x0, ttl 123, id 22407, offset 0, flags [DF], proto TCP (6), length 104)<br/>    172.17.9.120.64157 &gt; 10.122.12.185.22: Flags [P.], cksum 0x7ee8 (correct), seq 256:320, ack 65, win 2052, length 64<br/>        0x0000:  4500 0068 5787 4000 7b06 db4c ac11 0978<br/>        0x0010:  0a7a 0cb9 fa9d 0016 0d0f 934e 8940 b94e<br/>        0x0020:  5018 0804 7ee8 0000 <strong class="ky hy"><em class="ma">84d0 0c95 9e8a 4eed<br/>        0x0030:  e076 0096 7310 b67c 80bd 0a60 d0e3 fe6e<br/>        0x0040:  a768 472f d0a2 7950</em></strong> c353 1b78 318f 45b6<br/>        0x0050:  034f d039 1370 6268 30c6 9428 efa1 9be2<br/>        0x0060:  c81f aaa4 8582 79a3<br/>11:33:38.224267 IP (tos 0x48, ttl 64, id 39782, offset 0, flags [DF], proto TCP (6), length 40)<br/>    10.122.12.185.22 &gt; 172.17.9.120.64157: Flags [.], cksum 0xccd6 (incorrect -&gt; 0x03f7), ack 320, win 321, length 0<br/>        0x0000:  4548 0028 9b66 4000 4006 d265 0a7a 0cb9<br/>        0x0010:  ac11 0978 0016 fa9d 8940 b94e 0d0f 938e<br/>        0x0020:  5010 0141 ccd6 0000</span></pre><p id="30e8" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">lsof命令确认fd 5是TCP套接字:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="2902" class="lh jt hx ky b fi li lj l lk ll">root@baraba1: ~# lsof +E -p 1276496 | grep -v REG<br/>COMMAND       PID USER   FD   TYPE             DEVICE SIZE/OFF     NODE NAME<br/>...<br/>sshd      1276496 miha    5u  IPv4           45494368      0t0      TCP 10.122.12.185:22-&gt;172.17.9.120:64157 (ESTABLISHED)<br/>...</span></pre><p id="8919" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在跟踪中，我们看到字符“a”被写入bash的终端(fd 16 ),然后从bash进程的终端(fd 20)读取“a”。</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="9713" class="lh jt hx ky b fi li lj l lk ll">root@baraba1: ~# lsof +E -p 1276496<br/>COMMAND       PID USER   FD   TYPE             DEVICE SIZE/OFF     NODE NAME<br/>...<br/>sshd      1276496 miha   16u   CHR                5,2      0t0     1130 /dev/ptmx -&gt;/dev/pts/9 1276497,bash,0u 1276497,bash,1u 1276497,bash,2u 1276497,bash,255u 1276525,dbus-laun,0u<br/>sshd      1276496 miha   20u   CHR                5,2      0t0     1130 /dev/ptmx -&gt;/dev/pts/9 1276497,bash,0u 1276497,bash,1u 1276497,bash,2u 1276497,bash,255u 1276525,dbus-laun,0u<br/>...</span></pre><p id="db83" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">它被加密并通过TCP套接字fd 5发送。</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="edf7" class="lh jt hx ky b fi li lj l lk ll">"\272v:\305\32\267\203\2329\363J\353\\6\vh\342\17\6\217\317\255\342\222a\3r[\376;\335\25" ... -&gt;</span><span id="44ed" class="lh jt hx ky b fi nd lj l lk ll">                    <strong class="ky hy"><em class="ma">ba76 3ac5 1ab7 839a <br/>39f3 4aeb 5c36 0b68 e20f 068f cfad e292 <br/>6103 725b fe3b dd15</em></strong> ...</span></pre><p id="3ebe" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">…在tcpdump中:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="c502" class="lh jt hx ky b fi li lj l lk ll">11:33:38.225516 IP (tos 0x48, ttl 64, id 39783, offset 0, flags [DF], proto TCP (6), length 104)<br/>    10.122.12.185.22 &gt; 172.17.9.120.64157: Flags [P.], cksum 0xcd16 (incorrect -&gt; 0x6fb4), seq 65:129, ack 320, win 321, length 64<br/>        0x0000:  4548 0068 9b67 4000 4006 d224 0a7a 0cb9<br/>        0x0010:  ac11 0978 0016 fa9d 8940 b94e 0d0f 938e<br/>        0x0020:  5018 0141 cd16 0000 <strong class="ky hy"><em class="ma">ba76 3ac5 1ab7 839a<br/>        0x0030:  39f3 4aeb 5c36 0b68 e20f 068f cfad e292<br/>        0x0040:  6103 725b fe3b dd15</em></strong> 9276 979a 93d3 d94b<br/>        0x0050:  ff75 579e a2ac 8b9c 4eaa 4c88 ea5a 8d6a<br/>        0x0060:  36c2 29a4 4439 f639<br/>11:33:38.277762 IP (tos 0x0, ttl 123, id 22418, offset 0, flags [DF], proto TCP (6), length 40)<br/>    172.17.9.120.64157 &gt; 10.122.12.185.22: Flags [.], cksum 0xfcf3 (correct), ack 129, win 2052, length 0<br/>        0x0000:  4500 0028 5792 4000 7b06 db81 ac11 0978<br/>        0x0010:  0a7a 0cb9 fa9d 0016 0d0f 938e 8940 b98e<br/>        0x0020:  5010 0804 fcf3 0000 0000 3fc0 0c30</span></pre><p id="f11c" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">现在我们面前有了整个机制。</p><h1 id="2d61" class="js jt hx bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">当击键没有被传输时</h1><p id="b2e9" class="pw-post-body-paragraph iu iv hx iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">当字母“a”被压入油灰中时，我们在服务器上看到的是:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="0dc1" class="lh jt hx ky b fi li lj l lk ll">strace -p 1276496<br/>) = 1 (in [5])<br/>rt_sigprocmask(SIG_BLOCK, [CHLD], [], 8) = 0<br/>rt_sigprocmask(SIG_SETMASK, [], NULL, 8) = 0<br/>clock_gettime(CLOCK_BOOTTIME, {tv_sec=35176791, tv_nsec=444673388}) = 0<br/>read(5, "\"\241HT^\25\256\301\"\2473\315\\\244\346\354}\207g\251+S\256\252\256sL\30\330\243\205\241"..., 16384) = 64<br/>clock_gettime(CLOCK_BOOTTIME, {tv_sec=35176791, tv_nsec=444778523}) = 0<br/>select(21, [5 12 14 15 20], [16], NULL, NULL) = 1 (out [16])<br/>rt_sigprocmask(SIG_BLOCK, [CHLD], [], 8) = 0<br/>rt_sigprocmask(SIG_SETMASK, [], NULL, 8) = 0<br/>clock_gettime(CLOCK_BOOTTIME, {tv_sec=35176791, tv_nsec=444938940}) = 0<br/>write(16, "a", 1)                       = 1<br/>ioctl(16, TCGETS, {B38400 opost isig -icanon -echo ...}) = 0<br/>clock_gettime(CLOCK_BOOTTIME, {tv_sec=35176791, tv_nsec=445073242}) = 0<br/>select(21, [5 12 14 15 20], [], NULL, NULL</span></pre><p id="526c" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我们看到来自客户端的加密数据包被解密并写入终端。</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="d00d" class="lh jt hx ky b fi li lj l lk ll">"\"\241HT^\25\256\301\"\2473\315\\\244\346\354}\207g\251+S\256\252\256sL\30\330\243\205\241" ... -&gt;</span><span id="4e6b" class="lh jt hx ky b fi nd lj l lk ll">                    <strong class="ky hy"><em class="ma">22a1 4854 5e15 aec1 <br/>22a7 33cd 5ca4 e6ec 7d87 67a9 2b53 aeaa <br/>ae73 4c18 d8a3 85a1</em></strong> ...</span></pre><p id="91e5" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我们可以在tcpdump中看到加密的有效负载:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="7e04" class="lh jt hx ky b fi li lj l lk ll">11:33:29.848065 IP (tos 0x0, ttl 123, id 22383, offset 0, flags [DF], proto TCP (6), length 104)<br/>    172.17.9.120.64157 &gt; 10.122.12.185.22: Flags [P.], cksum 0xbea7 (correct), seq 192:256, ack 65, win 2052, length 64<br/>        0x0000:  4500 0068 576f 4000 7b06 db64 ac11 0978<br/>        0x0010:  0a7a 0cb9 fa9d 0016 0d0f 930e 8940 b94e<br/>        0x0020:  5018 0804 bea7 0000 <strong class="ky hy"><em class="ma">22a1 4854 5e15 aec1<br/>        0x0030:  22a7 33cd 5ca4 e6ec 7d87 67a9 2b53 aeaa<br/>        0x0040:  ae73 4c18 d8a3 85a1</em></strong> 0a4c 7a4d 6c23 69a7<br/>        0x0050:  70a2 b76f 5025 2645 13b6 198f 046a 45c1<br/>        0x0060:  a6c9 b8bc 1a51 2ac9<br/>11:33:29.848090 IP (tos 0x48, ttl 64, id 39781, offset 0, flags [DF], proto TCP (6), length 40)<br/>    10.122.12.185.22 &gt; 172.17.9.120.64157: Flags [.], cksum 0xccd6 (incorrect -&gt; 0x0437), ack 256, win 321, length 0<br/>        0x0000:  4548 0028 9b65 4000 4006 d266 0a7a 0cb9<br/>        0x0010:  ac11 0978 0016 fa9d 8940 b94e 0d0f 934e<br/>        0x0020:  5010 0141 ccd6 0000</span></pre><p id="df7b" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在向bash终端写入“a”之后，什么也没有发生。</p><h1 id="dc06" class="js jt hx bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">理论1——字符在伪终端中丢失</h1><p id="4638" class="pw-post-body-paragraph iu iv hx iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">然后，我开始查看按键过程中的bash过程。从<code class="du kv kw kx ky b">ps</code>和<code class="du kv kw kx ky b">pstree</code>我们知道，这个会话的bash进程ID是1276497。在Putty终端中键入“abcdefg”后，我们只看到:“beh”和</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="e4b8" class="lh jt hx ky b fi li lj l lk ll">root@baraba1: ~# strace -p 1276497<br/>strace: Process 1276497 attached<br/>pselect6(1, [0], NULL, NULL, NULL, {[], 8}) = 1 (in [0])<br/>read(0, "b", 1)                         = 1<br/>select(1, [0], NULL, [0], {tv_sec=0, tv_usec=0}) = 0 (Timeout)<br/>write(2, "b", 1)                        = 1<br/>pselect6(1, [0], NULL, NULL, NULL, {[], 8}) = 1 (in [0])<br/>read(0, "e", 1)                         = 1<br/>select(1, [0], NULL, [0], {tv_sec=0, tv_usec=0}) = 0 (Timeout)<br/>write(2, "e", 1)                        = 1<br/>pselect6(1, [0], NULL, NULL, NULL, {[], 8}) = 1 (in [0])<br/>read(0, "h", 1)                         = 1<br/>select(1, [0], NULL, [0], {tv_sec=0, tv_usec=0}) = 0 (Timeout)<br/>write(2, "h", 1)                        = 1<br/>pselect6(1, [0], NULL, NULL, NULL, {[], 8}</span></pre><p id="23e3" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">那么，剩下的角色在哪里迷失了呢？</p><p id="ce27" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">如果我们在最后再次检查<code class="du kv kw kx ky b">sshd</code>进程的<code class="du kv kw kx ky b">lsof</code>，它正在与另一个进程通信:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="77ef" class="lh jt hx ky b fi li lj l lk ll">root@baraba1: ~# lsof +E -p 1276496 <br/>COMMAND       PID USER   FD   TYPE             DEVICE SIZE/OFF     NODE NAME<br/>...<br/>sshd      1276496 miha   16u   CHR                5,2      0t0     1130 /dev/ptmx -&gt;/dev/pts/9 1276497,bash,0u 1276497,bash,1u 1276497,bash,2u 1276497,bash,255u 1276525,dbus-laun,0u<br/>sshd      1276496 miha   20u   CHR                5,2      0t0     1130 /dev/ptmx -&gt;/dev/pts/9 1276497,bash,0u 1276497,bash,1u 1276497,bash,2u 1276497,bash,255u 1276525,dbus-laun,0u<br/>sshd      1276496 miha   21u   CHR                5,2      0t0     1130 /dev/ptmx -&gt;/dev/pts/9 1276497,bash,0u 1276497,bash,1u 1276497,bash,2u 1276497,bash,255u 1276525,dbus-laun,0u<br/>...<br/>dbus-laun 1276525 miha    0u   CHR              136,9      0t0       12 /dev/pts/9 1276494,sshd,10u 1276496,sshd,16u 1276496,sshd,20u 1276496,sshd,21u</span></pre><p id="0ee1" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">看起来dbus-laun附属于同一个<code class="du kv kw kx ky b">/dev/pts/9</code>(伪终端从机)。实际上是ID为1276525的<code class="du kv kw kx ky b">dbus-launch</code>进程。</p><p id="1886" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">更好地查看<code class="du kv kw kx ky b">ps axl</code>输出会给我们更多的洞察力:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="69cc" class="lh jt hx ky b fi li lj l lk ll">UID     PID    PPID PRI  NI    VSZ   RSS WCHAN  STAT TTY        TIME COMMAND<br/>...<br/>4     0 1276494 1102993  20   0 163700 10788 x64_sy Ss   ?          0:00 sshd: miha [priv]<br/>5  1003 1276496 1276494  20   0 163700  5600 core_s S    ?          0:00 sshd: miha@pts/9<br/>0  1003 1276497 1276496  20   0  25524  5348 core_s Ss+  <strong class="ky hy"><em class="ma">pts/9</em></strong>      0:00 -bash<br/>1  1003 1276525       1  20   0  51804   404 -      S+   <strong class="ky hy"><em class="ma">pts/9</em></strong>      0:00 dbus-launch --sh-syntax --exit-with-session<br/>1  1003 1276526       1  20   0  76300   464 do_epo Ss   ?          0:00 /usr/bin/dbus-daemon --syslog --fork --print-pid 4 --print-address 6 --session<br/>...</span></pre><p id="9d79" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">所以两个进程都使用相同的<code class="du kv kw kx ky b">pts/9</code>。</p><h1 id="cb8a" class="js jt hx bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">Q.E.D .理论1</h1><p id="890c" class="pw-post-body-paragraph iu iv hx iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">让我们在<code class="du kv kw kx ky b">dbus-launch</code>流程上运行<code class="du kv kw kx ky b">strace</code>，并在Putty中键入‘abcdefg ’:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="2464" class="lh jt hx ky b fi li lj l lk ll">root@baraba1: ~# strace -p 1276525<br/>strace: Process 1276525 attached<br/>select(1, [0], NULL, [0], NULL)         = 1 (in [0])<br/>read(0, "c", 512)                       = 1<br/>select(1, [0], NULL, [0], NULL)         = 1 (in [0])<br/>read(0, "d", 512)                       = 1<br/>select(1, [0], NULL, [0], NULL)         = 1 (in [0])<br/>read(0, "f", 512)                       = 1<br/>select(1, [0], NULL, [0], NULL</span></pre><p id="5ca4" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">同时在<code class="du kv kw kx ky b">bash</code>:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="b773" class="lh jt hx ky b fi li lj l lk ll">root@baraba1: ~# strace -p 1276497<br/>strace: Process 1276497 attached<br/>read(0, "a", 1)                         = 1<br/>select(1, [0], NULL, [0], {tv_sec=0, tv_usec=0}) = 0 (Timeout)<br/>write(2, "a", 1)                        = 1<br/>pselect6(1, [0], NULL, NULL, NULL, {[], 8}) = 1 (in [0])<br/>read(0, "b", 1)                         = 1<br/>select(1, [0], NULL, [0], {tv_sec=0, tv_usec=0}) = 0 (Timeout)<br/>write(2, "b", 1)                        = 1<br/>pselect6(1, [0], NULL, NULL, NULL, {[], 8}) = 1 (in [0])<br/>read(0, "e", 1)                         = 1<br/>select(1, [0], NULL, [0], {tv_sec=0, tv_usec=0}) = 0 (Timeout)<br/>write(2, "e", 1)                        = 1<br/>pselect6(1, [0], NULL, NULL, NULL, {[], 8}) = 1 (in [0])<br/>read(0, "g", 1)                         = 1<br/>select(1, [0], NULL, [0], {tv_sec=0, tv_usec=0}) = 0 (Timeout)<br/>write(2, "g", 1)                        = 1<br/>pselect6(1, [0], NULL, NULL, NULL, {[], 8}</span></pre><p id="573d" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在终端中，我们看到了“abeg”——只有进入bash的字符才能返回Putty。</p><p id="fbb5" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi">■</p><h1 id="b1e5" class="js jt hx bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">为什么，什么，如何，何时…</h1><p id="6f4f" class="pw-post-body-paragraph iu iv hx iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">原来，当在Putty或任何其他客户端中启用带有X11转发的SSH连接时，<code class="du kv kw kx ky b">dbus-launch</code>是从<code class="du kv kw kx ky b">/etc/profile.d/ssh-x-forwarding.sh</code>运行的。</p><p id="2dc7" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">如果X11服务器(XMing或ReflectionX)运行在Windows 10上，这是没有问题的。如果没有运行，<code class="du kv kw kx ky b">dbus-launch</code>挂起并等待来自同一个伪终端的输入。</p><p id="57cc" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我发现包<code class="du kv kw kx ky b">dbus-x11.x86_64 1:1.12.8–12.el8_3</code>引入了一个变化，我在5月4日安装了系统升级，而我的同事在5月6日第一次抱怨。</p><p id="fdb5" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这个包来自于CentOS 8.3的Appstream repo，这让我很不爽。</p><h1 id="9da7" class="js jt hx bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">解决办法</h1><p id="3051" class="pw-post-body-paragraph iu iv hx iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">目前，我的服务器端解决方案是用<code class="du kv kw kx ky b">--exit-with-x11</code>替换选项<code class="du kv kw kx ky b">--exit-with-session</code>，如果X11没有准备好，现在<code class="du kv kw kx ky b">dbus-launch</code>将退出。</p><p id="be30" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">此刻工作文件<code class="du kv kw kx ky b">/etc/profile.d/ssh-x-forwarding.sh</code>:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="3e97" class="lh jt hx ky b fi li lj l lk ll"># DBus session bus over SSH with X11 forwarding<br/>[ -z "$SSH_CONNECTION" ] &amp;&amp; return<br/>[ -z "$DISPLAY" ] &amp;&amp; return<br/>[ "$SHLVL" -gt 1 ] &amp;&amp; return</span><span id="22f0" class="lh jt hx ky b fi nd lj l lk ll">GDK_BACKEND=x11; export GDK_BACKEND<br/>#eval $(dbus-launch --sh-syntax --exit-with-session)<br/>eval $(dbus-launch --sh-syntax --exit-with-x11)</span></pre><h1 id="c3bf" class="js jt hx bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">相关错误(RedHat/CentOS)</h1><p id="187a" class="pw-post-body-paragraph iu iv hx iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated"><a class="ae ne" href="https://bugzilla.redhat.com/show_bug.cgi?id=1940348" rel="noopener ugc nofollow" target="_blank"><strong class="iw hy">Bug 1940 348</strong></a><strong class="iw hy">—dbus-launch无意间消耗了stdin。</strong></p><p id="416d" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><a class="ae ne" href="https://bugzilla.redhat.com/show_bug.cgi?id=1940067" rel="noopener ugc nofollow" target="_blank"><strong class="iw hy">Bug 1940067</strong></a><strong class="iw hy">—与dbus 1 . 12 . 8–12 . el8 _ 3 ssh会话执行单命令hang【NEEDINFO】</strong></p><p id="6e53" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><a class="ae ne" href="https://bugzilla.redhat.com/show_bug.cgi?id=1874282" rel="noopener ugc nofollow" target="_blank"> <strong class="iw hy">错误1874282 </strong> </a> <strong class="iw hy"> —当用户执行ssh X11显示转发时，dbus-x11可以启动每连接会话总线</strong></p><h1 id="b1f7" class="js jt hx bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">经验教训</h1><p id="3ccb" class="pw-post-body-paragraph iu iv hx iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">在这个过程中，我学到了很多东西。</p><h2 id="69a5" class="lh jt hx bd ju mb mc md jy me mf mg kc jf mh mi kg jj mj mk kk jn ml mm ko mn bi translated">跟着字节走</h2><p id="5638" class="pw-post-body-paragraph iu iv hx iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">当调试像这个问题一样奇怪的东西时，慢慢地剥离处理层以接近问题的核心是一个好主意。要有效地做到这一点，您必须…</p><h2 id="5298" class="lh jt hx bd ju mb mc md jy me mf mg kc jf mh mi kg jj mj mk kk jn ml mm ko mn bi translated">…了解您的工具</h2><p id="4ba2" class="pw-post-body-paragraph iu iv hx iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">我用过并探索过<code class="du kv kw kx ky b">tcpdump</code>、<code class="du kv kw kx ky b">strace</code>、<code class="du kv kw kx ky b">ltrace</code>、<code class="du kv kw kx ky b">frida-trace</code>来自<a class="ae ne" href="https://frida.re/docs/home/" rel="noopener ugc nofollow" target="_blank"> Frida </a>、<code class="du kv kw kx ky b">gdb</code>、Wireshark、<a class="ae ne" href="https://www.microsoft.com/en-us/download/details.aspx?id=4865" rel="noopener ugc nofollow" target="_blank">微软网络监视器3.4 </a>(我发现它很好用但很遗憾它已经不开发了)、<code class="du kv kw kx ky b">lsof</code>。</p><h2 id="5f26" class="lh jt hx bd ju mb mc md jy me mf mg kc jf mh mi kg jj mj mk kk jn ml mm ko mn bi translated">阅读错误信息！</h2><p id="f4e5" class="pw-post-body-paragraph iu iv hx iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">如果我在Putty登录开始时阅读并更加注意错误消息，我会注意到工作会话和非工作会话之间的区别。调试可能会更顺利、更容易。</p></div></div>    
</body>
</html>