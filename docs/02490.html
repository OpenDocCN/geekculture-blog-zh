<html>
<head>
<title>How to Measure Purchases With gtag.js From iFrame</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用iFrame中的gtag.js衡量购买</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/how-to-measure-purchases-with-gtag-js-from-iframe-309932c19b6?source=collection_archive---------14-----------------------#2021-05-17">https://medium.com/geekculture/how-to-measure-purchases-with-gtag-js-from-iframe-309932c19b6?source=collection_archive---------14-----------------------#2021-05-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="0d6e" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">将beds24 iframe中的数据发送到Google Analytics</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/336ffa2ede04563e283ee25cea643e28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*L2ZAF8paMgIDSjfz"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Photo by <a class="ae jn" href="https://unsplash.com/@markuswinkler?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Markus Winkler</a> on <a class="ae jn" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="f05e" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">你可能会在你的网站上使用谷歌分析来跟踪你的访问者的一些信息——人口统计，他们的行为，他们使用什么技术等。</p><p id="dd7a" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">如果您在网站上使用第三方软件，让您的客户能够购买/预订某些东西，您可能需要跟踪更多信息—他们的购物行为是什么，他们购买了什么？</p><blockquote class="kk kl km"><p id="e74a" class="jo jp kn jq b jr js ij jt ju jv im jw ko jy jz ka kp kc kd ke kq kg kh ki kj hb bi translated">为了展示一个具体的例子，我将使用<a class="ae jn" href="https://beds24.com/" rel="noopener ugc nofollow" target="_blank"> beds24 </a>，这是一个财产管理和预订系统。您也可以将这里描述的内容应用于其他系统。<strong class="jq hj">但是你必须能够访问iframe。否则，您将无法从中发送必要的数据。</strong></p></blockquote><p id="5c04" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我将通过以下四个简单的步骤简要说明如何做到这一点:</p><ul class=""><li id="af9e" class="kr ks hi jq b jr js ju jv jx kt kb ku kf kv kj kw kx ky kz bi translated">设置Google分析</li><li id="83d6" class="kr ks hi jq b jr la ju lb jx lc kb ld kf le kj kw kx ky kz bi translated">从iframe发送数据(如beds24预订系统)</li><li id="c396" class="kr ks hi jq b jr la ju lb jx lc kb ld kf le kj kw kx ky kz bi translated">通过gtag(通用分析)接收和发送数据</li><li id="a137" class="kr ks hi jq b jr la ju lb jx lc kb ld kf le kj kw kx ky kz bi translated">设置Google标签管理器</li></ul></div><div class="ab cl lf lg gp lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="hb hc hd he hf"><h2 id="55ee" class="lm ln hi bd lo lp lq lr ls lt lu lv lw jx lx ly lz kb ma mb mc kf md me mf mg bi translated">1.设置Google分析</h2><p id="f204" class="pw-post-body-paragraph jo jp hi jq b jr mh ij jt ju mi im jw jx mj jz ka kb mk kd ke kf ml kh ki kj hb bi translated">我不会在这里进入更多的细节，但我假设你已经有你的谷歌分析帐户。为了收集某些电子商务信息，我们必须首先启用该功能。</p><p id="e73d" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">导航到您的帐户、酒店和视图，然后选择<a class="ae jn" href="https://support.google.com/analytics/answer/6032539" rel="noopener ugc nofollow" target="_blank">启用电子商务</a>。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es mm"><img src="../Images/66bd70a971b60d351191b54215bf3b81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1196/format:webp/1*9GyeTR4MC5skMbwv4NfJvg.png"/></div><figcaption class="jj jk et er es jl jm bd b be z dx">enable Ecommerce in Google Analytics</figcaption></figure><p id="210b" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">还要确保你的网站标题中包含了gtag:</p><pre class="iy iz ja jb fd mn mo mp mq aw mr bi"><span id="a053" class="lm ln hi mo b fi ms mt l mu mv">&lt;head&gt;<br/>  &lt;!-- Global site tag (gtag.js) - Google Analytics --&gt;<br/>  &lt;script async src="https://www.googletagmanager.com/gtag/js?id=UA-XXX"&gt;&lt;/script&gt;<br/>  &lt;script&gt;<br/>    window.dataLayer = window.dataLayer || [];<br/>    function gtag(){dataLayer.push(arguments);}<br/>    gtag('js', new Date());<br/> <br/>    gtag('config', 'UA-XXX');<br/>  &lt;/script&gt;<br/>&lt;/head&gt;</span></pre><p id="e3b1" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我们还必须在谷歌标签管理器中创建一个容器，但我们将稍后再做。</p></div><div class="ab cl lf lg gp lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="hb hc hd he hf"><h2 id="bca3" class="lm ln hi bd lo lp lq lr ls lt lu lv lw jx lx ly lz kb ma mb mc kf md me mf mg bi translated">2.从iframe发送数据</h2><p id="5dda" class="pw-post-body-paragraph jo jp hi jq b jr mh ij jt ju mi im jw jx mj jz ka kb mk kd ke kf ml kh ki kj hb bi translated">好吧，iframe是什么？为了确保我们知道我们在谈论什么，这里有一个MDN的定义:</p><blockquote class="kk kl km"><p id="42cf" class="jo jp kn jq b jr js ij jt ju jv im jw ko jy jz ka kp kc kd ke kq kg kh ki kj hb bi translated"><strong class="jq hj"> HTML内嵌框架元素(</strong> <code class="du mw mx my mo b"><strong class="jq hj">&lt;iframe&gt;</strong></code> <strong class="jq hj"> ) </strong>表示嵌套的<a class="ae jn" href="https://developer.mozilla.org/en-US/docs/Glossary/Browsing_context" rel="noopener ugc nofollow" target="_blank">浏览上下文</a>，将另一个HTML页面嵌入到当前页面中。</p></blockquote><p id="640c" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">因此，在我们的例子中，我们有一个网页，我们想插入另一个网页在那里(beds24.com)使用iframe元素。</p><pre class="iy iz ja jb fd mn mo mp mq aw mr bi"><span id="af19" class="lm ln hi mo b fi ms mt l mu mv">&lt;iframe src=”<a class="ae jn" href="https://www.beds24.com/booking2.php?propid=13437" rel="noopener ugc nofollow" target="_blank">https://www.beds24.com/booking2.php?propid=13437</a>” width=”100%” scrolling=”no”&gt;&lt;/iframe&gt;</span></pre><p id="3554" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">用户可以在iframe中浏览和预订属性。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mz"><img src="../Images/0f2d0b49ba41ba3e65bf64eed71d7e82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SEUBFw7dmeq-05pvgtyi1w.png"/></div></div></figure><p id="13a1" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">比方说，我们想要捕获该资产的预订。这意味着在用户到达确认页面后触发一个事件。在beds24中，我们可以访问各个属性的HTML设置，并向元素插入一个脚本。我们可以看到还有一个确认页面:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es na"><img src="../Images/ef7245e54b43b8157248af31917202c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:908/format:webp/1*lIahN6nRcDK_X_Q3--Byqg.png"/></div><figcaption class="jj jk et er es jl jm bd b be z dx">beds24 HTML settings</figcaption></figure><blockquote class="kk kl km"><p id="d82e" class="jo jp kn jq b jr js ij jt ju jv im jw ko jy jz ka kp kc kd ke kq kg kh ki kj hb bi translated">注意:如果您不直接控制iframe代码，并且您使用不同的服务，那么请寻找类似的选项，以便将Javascript代码插入到页面中。</p></blockquote><p id="78af" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在该字段中，我们必须插入如下所示的Javascript代码。</p><pre class="iy iz ja jb fd mn mo mp mq aw mr bi"><span id="ccc7" class="lm ln hi mo b fi ms mt l mu mv">&lt;script&gt;<br/>  try{ <br/>      var postObject = {<br/>        event: 'purchase',<br/>        data: {<br/>          "transaction_id": [BOOKID],<br/>          "value": [PRICE],<br/>          "currency": "EUR",<br/>          "coupon": "[GUESTVOUCHER]",<br/>          "items": [<br/>            {<br/>              "id": [PROPERTYID],<br/>              "name": "[PROPERTYNAME]",<br/>              "brand": "",<br/>              "quantity": 1,<br/>              "price": [PRICE]<br/>            },<br/>          ]<br/>        }<br/>      };    <br/>      <strong class="mo hj">parent.postMessage(postObject, '</strong><a class="ae jn" href="https://lisbonprimeaparts.com/booking'" rel="noopener ugc nofollow" target="_blank"><strong class="mo hj">https://example.com'</strong></a><strong class="mo hj">);</strong><br/>  } catch(e) {<br/>    window.console &amp;&amp; window.console.log(e);<br/>  }<br/>&lt;/script&gt;</span></pre><p id="a5a2" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这里重要的是<a class="ae jn" href="https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage" rel="noopener ugc nofollow" target="_blank"> <em class="kn"> postMessage() </em>方法</a>。它支持iframe和内嵌iframe的页面之间的通信。</p><blockquote class="kk kl km"><p id="d5fe" class="jo jp kn jq b jr js ij jt ju jv im jw ko jy jz ka kp kc kd ke kq kg kh ki kj hb bi translated"><code class="du mw mx my mo b"><strong class="jq hj">window.postMessage()</strong></code>方法安全地启用了<code class="du mw mx my mo b"><a class="ae jn" href="https://developer.mozilla.org/en-US/docs/Web/API/Window" rel="noopener ugc nofollow" target="_blank">Window</a></code>对象之间的跨原点通信；<em class="hi">例如，</em>在页面和它产生的弹出窗口之间，或者在页面和嵌入其中的iframe之间。</p></blockquote><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nb"><img src="../Images/90670ac9302099299b0c0599c3f5cea6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xlqpWxZGdSu4XSeBnZRH2w.png"/></div></div></figure><p id="b189" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我们传递给该方法的第一个参数是<strong class="jq hj"> <em class="kn">消息</em> </strong>。在上面的例子中，我们发送了一个Javascript对象，该对象的属性遵循<a class="ae jn" href="https://developers.google.com/analytics/devguides/collection/gtagjs/enhanced-ecommerce#measure_purchases" rel="noopener ugc nofollow" target="_blank">用于衡量购买的电子商务文档</a>中描述的结构(根据您的用例可能会有所不同)。好消息是，我们不必序列化数据，因为方法会处理这些。这些值是<a class="ae jn" href="https://wiki.beds24.com/index.php?title=Template_Variables" rel="noopener ugc nofollow" target="_blank"> beds24模板变量</a>，如价格、资产ID等。</p><p id="4262" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">第二个参数是<strong class="jq hj"> <em class="kn"> targetOrigin </em> </strong>，所以基本上是父URI。</p></div><div class="ab cl lf lg gp lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="hb hc hd he hf"><h2 id="656b" class="lm ln hi bd lo lp lq lr ls lt lu lv lw jx lx ly lz kb ma mb mc kf md me mf mg bi translated">3.接收数据并通过gtag发送</h2><p id="7ba3" class="pw-post-body-paragraph jo jp hi jq b jr mh ij jt ju mi im jw jx mj jz ka kb mk kd ke kf ml kh ki kj hb bi translated">当用户完成预订时，消息被发送，现在我们必须监听它。在iframe之外，我们必须在父页面中插入另一个脚本。</p><pre class="iy iz ja jb fd mn mo mp mq aw mr bi"><span id="be66" class="lm ln hi mo b fi ms mt l mu mv">&lt;script&gt;<br/>  window.addEventListener("message", (event) <em class="kn">=&gt;</em> {<br/>    <em class="kn">if</em> (event.data &amp;&amp; event.data.event === "purchase") {<br/>      <em class="kn">var</em> data = event.data;<br/>      dataLayer.push({ ecommerce: null });</span><span id="e642" class="lm ln hi mo b fi nc mt l mu mv">      gtag('event', 'purchase', {<br/>        "transaction_id": data.data.transaction_id,<br/>        "value": data.data.value,<br/>        "currency": "EUR",<br/>        "coupon": data.data.coupon,<br/>        "items":data.data.items<br/>      });<br/>    }<br/>  });<br/>&lt;/script&gt;</span></pre><p id="0998" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">同样，如<a class="ae jn" href="https://developers.google.com/analytics/devguides/collection/gtagjs/enhanced-ecommerce#measure_purchases" rel="noopener ugc nofollow" target="_blank"> GA文档</a>中所述，我们使用gtag和<em class="kn">‘购买’</em>事件来发送我们收到的数据。确保gtag已定义(参见步骤1)。</p></div><div class="ab cl lf lg gp lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="hb hc hd he hf"><h2 id="c4f0" class="lm ln hi bd lo lp lq lr ls lt lu lv lw jx lx ly lz kb ma mb mc kf md me mf mg bi translated">4.设置Google标签管理器(GTM)</h2><p id="c3a6" class="pw-post-body-paragraph jo jp hi jq b jr mh ij jt ju mi im jw jx mj jz ka kb mk kd ke kf ml kh ki kj hb bi translated">此时，我们仍然看不到GA中触发的任何事件。我们必须在谷歌标签管理器中定义它们。首先为你的网站创建一个容器。</p><p id="6e61" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">然后我们必须定义变量、触发器和标签。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es nd"><img src="../Images/b8958c71e9de908e3f6d8292a3b3b6c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:480/format:webp/1*_sjl8H3dhOehOdXMbyWrMg.png"/></div><figcaption class="jj jk et er es jl jm bd b be z dx">GTM menu</figcaption></figure><p id="8f5a" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">变量</strong></p><p id="d06d" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">转到用户定义的变量，点击新建，并选择谷歌分析设置</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ne"><img src="../Images/beb839d78f944ed56ab7b08b30106dbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MR-hDP1KBHaFMn5UsyiD7A.png"/></div></div></figure><p id="2acb" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">输入您的跟踪ID，并在更多设置中启用电子商务。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es nf"><img src="../Images/410936730999fe956a227d8019ef1b1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:652/format:webp/1*MWbuWH0-DoPXNrktqyBX4g.png"/></div></figure><p id="1aa8" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">触发器</strong></p><p id="4ce5" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">例如，创建一个名为“购买”的新触发器，并选择自定义事件</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es ng"><img src="../Images/04b7bd5b509ab317771141d1c0ec981c.png" data-original-src="https://miro.medium.com/v2/resize:fit:550/format:webp/1*1wmKIEYeVxilk4Il_4OkCA.png"/></div></figure><p id="5048" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">事件名称是purchase(正如我们在上面的代码示例中定义的那样),所以看起来像这样:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es nh"><img src="../Images/379cc77780a8183a5b6cefc60464be32.png" data-original-src="https://miro.medium.com/v2/resize:fit:562/format:webp/1*PaTspe6LULnltC0MLD1GrA.png"/></div></figure><p id="1fd1" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">标签</strong></p><p id="19c3" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">最后，我们必须定义一个标签。创建一个新的“购买标签”，并在标签配置中选择谷歌分析:通用分析。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es ni"><img src="../Images/ab64c5a4864b0855f03acf68370a725a.png" data-original-src="https://miro.medium.com/v2/resize:fit:786/format:webp/1*5mz0iXbI68Y71A9hCFnk6Q.png"/></div></figure><p id="53f1" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我们还必须选择一个触发器，这是我们之前定义的:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es nj"><img src="../Images/bb4a07a46008c1eaa698c498d507e09f.png" data-original-src="https://miro.medium.com/v2/resize:fit:568/format:webp/1*BCjijeHAHCNbkV82frKrHw.png"/></div></figure><p id="fa05" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">发布更改，刷新页面并进行预订。你应该能够看到谷歌分析中触发的新事件。</p></div><div class="ab cl lf lg gp lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="hb hc hd he hf"><h2 id="1703" class="lm ln hi bd lo lp lq lr ls lt lu lv lw jx lx ly lz kb ma mb mc kf md me mf mg bi translated">结论</h2><p id="852c" class="pw-post-body-paragraph jo jp hi jq b jr mh ij jt ju mi im jw jx mj jz ka kb mk kd ke kf ml kh ki kj hb bi translated">我描述了如何使用iframe中的gtag.js来度量购买。作为一个例子，我使用了beds24预订和财产管理系统。只要您可以访问iframe，您就可以将所描述的相同原则应用于其他系统，因为我们已经了解了父窗口和iframe之间的通信是如何工作的。</p><p id="3a72" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我们还学习了如何在GA中启用电子商务，然后我们按照gtag文档来衡量购买，尽管Google Analytics和GTM设置也会根据您的需求而有所不同。</p><p id="e044" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我希望这篇文章对你有用，即使它不完全符合你的项目标准，但它给了你一些指导。感谢阅读！</p></div></div>    
</body>
</html>