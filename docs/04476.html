<html>
<head>
<title>Deploying a Webserver with Terraform on GCP</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在GCP使用Terraform部署web服务器</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/terraform-on-gcp-creating-a-webserver-762a20bb5424?source=collection_archive---------16-----------------------#2021-06-28">https://medium.com/geekculture/terraform-on-gcp-creating-a-webserver-762a20bb5424?source=collection_archive---------16-----------------------#2021-06-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/7791757c1728f42d94abdb67c8e57d27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Umf2M6FqE69SIM1b.jpg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Picture by <a class="ae iu" href="https://hackersandslackers.com/author/david/" rel="noopener ugc nofollow" target="_blank">David Aquino</a></figcaption></figure><p id="649c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这个项目中，我们将学习如何使用GCP的Terraform，但也使用bash脚本在实例(f1-micro)上创建一个Apache服务器。</p><p id="1c43" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">本项目中使用的以下产品和服务概述:</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jt"><img src="../Images/cb4939faf168454bcc3b3350fe7261bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*0kXiIsDaeIktBncB.png"/></div></div></figure><blockquote class="jy jz ka"><p id="f6ef" class="iv iw kb ix b iy iz ja jb jc jd je jf kc jh ji jj kd jl jm jn ke jp jq jr js hb bi translated"><strong class="ix hj">地形</strong></p><p id="ccb4" class="iv iw kb ix b iy iz ja jb jc jd je jf kc jh ji jj kd jl jm jn ke jp jq jr js hb bi translated">Terraform是一款开源的云无关基础设施代码工具，提供一致的CLI工作流来<strong class="ix hj">管理数百项云供应商特定的服务</strong>。Terraform将云API编码成声明性的配置文件。大多数受欢迎的云提供商，如GCP|AWS|Azure，都提供了自己版本的基础架构代码工具:</p></blockquote><ul class=""><li id="ea45" class="kf kg hi ix b iy iz jc jd jg kh jk ki jo kj js kk kl km kn bi translated">云部署经理-GCP</li><li id="0c80" class="kf kg hi ix b iy ko jc kp jg kq jk kr jo ks js kk kl km kn bi translated">云的形成</li><li id="7f35" class="kf kg hi ix b iy ko jc kp jg kq jk kr jo ks js kk kl km kn bi translated">Azure资源管理器- Azure</li></ul><blockquote class="jy jz ka"><p id="74ed" class="iv iw kb ix b iy iz ja jb jc jd je jf kc jh ji jj kd jl jm jn ke jp jq jr js hb bi translated"><strong class="ix hj">其好处:</strong></p></blockquote><ul class=""><li id="90a3" class="kf kg hi ix b iy iz jc jd jg kh jk ki jo kj js kk kl km kn bi translated">它无缝调配基础架构</li><li id="4fe3" class="kf kg hi ix b iy ko jc kp jg kq jk kr jo ks js kk kl km kn bi translated">它可以轻松更新基础设施</li><li id="4852" class="kf kg hi ix b iy ko jc kp jg kq jk kr jo ks js kk kl km kn bi translated">它毫不费力地摧毁了基础设施</li><li id="1fd8" class="kf kg hi ix b iy ko jc kp jg kq jk kr jo ks js kk kl km kn bi translated">它只需点击一个按钮就可以检查代码错误</li><li id="a2d0" class="kf kg hi ix b iy ko jc kp jg kq jk kr jo ks js kk kl km kn bi translated">It部门在部署之前规划好基础架构</li><li id="f423" class="kf kg hi ix b iy ko jc kp jg kq jk kr jo ks js kk kl km kn bi translated">它跟踪状态文件中的记录</li></ul><p id="a1fb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你可以在这里找到所有相关的地形GCP模块。</p><h1 id="92cc" class="kt ku hi bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated"><strong class="ak">第一步:- </strong></h1><p id="6d7f" class="pw-post-body-paragraph iv iw hi ix b iy lr ja jb jc ls je jf jg lt ji jj jk lu jm jn jo lv jq jr js hb bi translated">有一些外部包管理器可以用来在Windows上安装Terraform。我最喜欢的是<a class="ae iu" href="https://chocolatey.org/" rel="noopener ugc nofollow" target="_blank">巧克力</a>。它使得安装、删除和更新软件像一行命令一样简单，Terraform也不例外。</p><p id="0246" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要用<a class="ae iu" href="https://adamtheautomator.com/install-chocolatey/" rel="noopener ugc nofollow" target="_blank">巧克力</a>安装Terraform，执行以下步骤:</p><ol class=""><li id="8ac8" class="kf kg hi ix b iy iz jc jd jg kh jk ki jo kj js lw kl km kn bi translated">以管理员身份打开CMD/PowerShell提示符，使用安装页面中的命令安装Chocolatey。</li><li id="0e95" class="kf kg hi ix b iy ko jc kp jg kq jk kr jo ks js lw kl km kn bi translated">一旦完成，运行最后的<code class="du lx ly lz ma b">choco install terraform -y</code>来自动同意在你的设备上安装它。</li></ol><p id="2994" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">该命令运行后，您将得到类似如下的内容:</p><pre class="ju jv jw jx fd mb ma mc md aw me bi"><span id="b80d" class="mf ku hi ma b fi mg mh l mi mj">Chocolatey v0.10.13<br/>2 validations performed. 1 success(es), 1 warning(s), and 0 error(s).<br/>Installing the following packages:<br/>terraform<br/>By installing you accept licenses for the packages.<br/>Progress: Downloading terraform 0.12.6... 100%<br/>terraform v0.12.6 [Approved]<br/>Downloading terraform 64 bit from 'https://releases.hashicorp.com/terraform/0.12.6/terraform_0.12.6_windows<br/>Download of terraform_0.12.6_windows_amd64.zip (15.32 MB) completed.<br/>--SNIP--</span></pre><h1 id="f635" class="kt ku hi bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">第二步:-</h1><p id="7d2f" class="pw-post-body-paragraph iv iw hi ix b iy lr ja jb jc ls je jf jg lt ji jj jk lu jm jn jo lv jq jr js hb bi translated">我们需要一个IDE来编写GCP的地形配置和模块。我将使用我最喜欢的<a class="ae iu" href="https://code.visualstudio.com/download" rel="noopener ugc nofollow" target="_blank"> Visual Studio代码</a> &amp;打开Ctrl + ~打开里面的终端，并创建一个名为“GCP地形”的文件夹</p><p id="b5ba" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi mk translated">P 先决条件:</p><ul class=""><li id="333b" class="kf kg hi ix b iy iz jc jd jg kh jk ki jo kj js kk kl km kn bi translated">GCP服务帐户密钥和路径位置中的文件</li><li id="c009" class="kf kg hi ix b iy ko jc kp jg kq jk kr jo ks js kk kl km kn bi translated">GCP项目ID，可以运行<em class="kb"> gcloud项目列表</em>来查找</li><li id="1f01" class="kf kg hi ix b iy ko jc kp jg kq jk kr jo ks js kk kl km kn bi translated">为使用terraform构建的资源设置默认区域</li><li id="aab5" class="kf kg hi ix b iy ko jc kp jg kq jk kr jo ks js kk kl km kn bi translated">为使用terraform构建的资源设置默认区域</li></ul><h1 id="42b8" class="kt ku hi bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">GCP服务帐户</h1><p id="153e" class="pw-post-body-paragraph iv iw hi ix b iy lr ja jb jc ls je jf jg lt ji jj jk lu jm jn jo lv jq jr js hb bi translated">我们将需要一个具有<strong class="ix hj">计算管理(角色/计算管理)</strong>权限的<strong class="ix hj"> GCP服务帐户</strong>，以及位于“GCP上的地形”文件夹中的服务帐户的<strong class="ix hj"> JSON文件。</strong></p><h1 id="459e" class="kt ku hi bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">Terraform后端铲斗</h1><p id="dfe2" class="pw-post-body-paragraph iv iw hi ix b iy lr ja jb jc ls je jf jg lt ji jj jk lu jm jn jo lv jq jr js hb bi translated">我们需要在GCP内部创建一个存储桶，以便将其用作远程后端，并在其中存储我们的状态文件。</p><h1 id="daf1" class="kt ku hi bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">云存储API已启用</h1><p id="a8af" class="pw-post-body-paragraph iv iw hi ix b iy lr ja jb jc ls je jf jg lt ji jj jk lu jm jn jo lv jq jr js hb bi translated">我们选择我们的根项目，在搜索框中键入<strong class="ix hj">云存储API </strong>，并选择<strong class="ix hj">云存储API &amp;计算引擎API </strong></p><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es mt"><img src="../Images/5acb3484c43dcfb5a73dc3f4b63d16ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:400/format:webp/0*q5lu43mLI0Cuv1uJ.png"/></div></figure><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mu"><img src="../Images/2c94cd46cd94b4a513cea8298496f15d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PDUyzdfqYHaTJ8riRFXfZg.png"/></div></div></figure><p id="a47b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果API被禁用，我们单击<strong class="ix hj">启用</strong>按钮将其启用。</p><p id="e7b3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">“GCP的地形”文件夹内:</p><p id="10bf" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">首先，我们将定义远程后端的配置:</p><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="mv mw l"/></div></figure><p id="5148" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们创建<code class="du lx ly lz ma b">provider.tf</code>,它帮助您定义您的terraform要使用哪个提供程序，我们还将定义默认区域&amp; zone，在我们的示例中，我们添加了以下内容:</p><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="mv mw l"/></div></figure><p id="e177" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们还需要</p><p id="7325" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这让Terraform知道要查询什么资源以及Terraform中资源的名称。</p><p id="2614" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">名称</strong>:GCP境内虚拟机的自定义名称。</p><p id="431b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> Machine_types </strong>:这基本上是CPU | RAM &amp; GPU的组合，帮助我们选择GCP上可用的不同类别的实例，完整列表可以在这里<a class="ae iu" href="https://cloud.google.com/compute/docs/machine-types" rel="noopener ugc nofollow" target="_blank">找到</a>。</p><p id="1959" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">标签:</strong>添加网络标签。</p><p id="e500" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> Boot_disk: </strong>选择要使用的映像(在我们的例子中，我们将使用缺省值)</p><p id="5886" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">metadata _ startup _ script:</strong>将您的启动脚本添加到自定义安装依赖项中。</p><p id="9f09" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">调度:因为这将是一个临时的机器，我把它变成了可抢占的。如果您决定这样做，automatic_restart必须等于false。</p><p id="3e9e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">网络接口:这有助于我们定义虚拟机应该使用的网络。</p><p id="3f3b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">网络:你的虚拟机应该使用什么VPC。</p><p id="9714" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> access_config </strong>:留空，因为它会自动创建一个外部临时ip。</p><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="mv mw l"/></div></figure><h1 id="dfce" class="kt ku hi bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">最后，我们需要一个启动脚本</h1><p id="4b2f" class="pw-post-body-paragraph iv iw hi ix b iy lr ja jb jc ls je jf jg lt ji jj jk lu jm jn jo lv jq jr js hb bi translated">启动脚本是非常简单的bash脚本。它允许实例更新包并安装Apache Web服务器，然后我将更改推送到startup.sh脚本。完成后，将文件路径添加到Terraform配置文件，如上例所示:</p><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="mv mw l"/></div></figure><h1 id="8b75" class="kt ku hi bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">是时候使用Terraform命令部署我们的资源了:</h1><pre class="ju jv jw jx fd mb ma mc md aw me bi"><span id="3561" class="mf ku hi ma b fi mg mh l mi mj">$ <strong class="ma hj">terraform init</strong></span></pre><p id="b451" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这将初始化和安装必要的插件，使terraform运行。</p><p id="9e6c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">确保<strong class="ix hj">验证</strong>您目录中所有terra form<strong class="ix hj">文件的语法</strong></p><pre class="ju jv jw jx fd mb ma mc md aw me bi"><span id="c04f" class="mf ku hi ma b fi mg mh l mi mj">$ <strong class="ma hj">terraform validate</strong><br/>Success! The configuration is valid.</span></pre><p id="c64c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，我们将规划我们的terraform基础设施，以确保使用此代码部署哪些资源，如下所示:</p><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="mv mw l"/></div></figure><p id="4b1f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">审查代码后，我们将最终做terraform应用-自动批准接受和部署在GCP上的上述terraform文件中声明的资源。</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mx"><img src="../Images/5e24e5b1db48f2c875fe5f46b672042f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Tq1wx7EPT4Dx2cfXanxUOw.png"/></div></div></figure><p id="25bb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">(可选)通过转到GCP控制台进行确认。</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es my"><img src="../Images/465782b577f7caf7061de0b45debc694.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q84vkD4Dx915HFsawWPCmw.png"/></div></div></figure><h1 id="9f20" class="kt ku hi bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">确认安装了Apache</h1><p id="70a5" class="pw-post-body-paragraph iv iw hi ix b iy lr ja jb jc ls je jf jg lt ji jj jk lu jm jn jo lv jq jr js hb bi translated">导航到“EXTERNAL_IP ”,如果启动脚本成功，您将看到您的web服务器！</p><p id="7cf1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">是时候摧毁我们用以下方式建造的一切了:</p><pre class="ju jv jw jx fd mb ma mc md aw me bi"><span id="7526" class="mf ku hi ma b fi mg mh l mi mj">$ <strong class="ma hj">terraform destroy</strong><br/>.<br/>.<br/>   Enter a value: yes</span></pre><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mz"><img src="../Images/faa2d20cd8195a8c9d9d854adee787e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aFQEw-QzpFJAjED4wFuGQA.png"/></div></div></figure></div><div class="ab cl na nb gp nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="hb hc hd he hf"><p id="78fa" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">谢谢你花时间看我的帖子，请鼓掌！如果你喜欢，评论和分享。我是一名DevOps爱好者，我练习技能，学习，努力帮助他人，共同成长&amp;你可以关注我:<a class="ae iu" href="https://www.linkedin.com/in/mynameisameed/" rel="noopener ugc nofollow" target="_blank">https://www.linkedin.com/in/mynameisameed/</a></p></div></div>    
</body>
</html>