<html>
<head>
<title>Angular Custom Environments Without Changing the Local Code or Repo.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">不改变本地代码或Repo的角度定制环境。</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/angular-custom-environments-without-changing-the-local-code-or-repo-effa69457edb?source=collection_archive---------1-----------------------#2021-03-20">https://medium.com/geekculture/angular-custom-environments-without-changing-the-local-code-or-repo-effa69457edb?source=collection_archive---------1-----------------------#2021-03-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/83fe65decb9ed12374e6f0560718e23c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*THM6AeyyVpg0lSc0Y_2tZw.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">The more frustrating problem you face in development, the more amazing solution you end up with.</figcaption></figure><p id="127b" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在这篇文章中，我们将讨论一个场景，当我们想通过既不改变本地代码也不推送到存储库来设置我们的定制环境。</p><h1 id="2cd9" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated"><strong class="ak">问题</strong></h1><p id="cd11" class="pw-post-body-paragraph iu iv hi iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">如你所知，Angular为我们提供了存储配置的环境文件。但是我们仍然通过静态写入我们的密钥或设置来填充这些文件。如果出于安全考虑，我们不想将我们的秘密密钥共享给存储库，该怎么办？或者，如果我们想要环境中的自定义设置，但又不想推动这些更改，该怎么办？我想到的第一个理想的解决方案是建立一个环境文件，它从系统环境变量(。env)如下图。</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="fb65" class="le jt hi la b fi lf lg l lh li">function getApiBasePath(): string {<br/>  return  (window as any).config.API_BASE_PATH ||  ${process.env.DEFAULT_API_URL}';<br/>}</span><span id="d12b" class="le jt hi la b fi lj lg l lh li">export const environment = {<br/> production: false,<br/> API_BASE_PATH: getApiBasePath(),<br/> MSAL: {<br/>  CLIENT_ID: ${process.env.MSAL_CLIENT_ID}',<br/>  AUTHORITY: ${process.env.MSAL_AUTHORITY}'',<br/>},<br/> debugStream: false,<br/>};</span></pre><p id="6fb8" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">不幸的是，上述解决方案根本行不通。因为我们通过<code class="du lk ll lm la b">process.env</code>访问系统环境变量，但是<code class="du lk ll lm la b">process.env</code>对<code class="du lk ll lm la b">Node</code>应用程序可用，而Angular应用程序不可用。</p><h1 id="14cd" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated"><strong class="ak">解决方案</strong> ✍</h1><p id="ccdb" class="pw-post-body-paragraph iu iv hi iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">使用<code class="du lk ll lm la b">dotenv</code>可以解决读取系统环境变量解的问题</p><ol class=""><li id="8c9a" class="ln lo hi iw b ix iy jb jc jf lp jj lq jn lr jr ls lt lu lv bi translated">安装<code class="du lk ll lm la b">dotenv</code></li></ol><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="d5f4" class="le jt hi la b fi lf lg l lh li">npm i dotenv --save-dev</span></pre><blockquote class="lw lx ly"><p id="2576" class="iu iv lz iw b ix iy iz ja jb jc jd je ma jg jh ji mb jk jl jm mc jo jp jq jr hb bi translated"><em class="hi"> Dotenv是一个零依赖模块，将环境变量从</em> <code class="du lk ll lm la b"><em class="hi">.env</em></code> <em class="hi">文件加载到</em> <code class="du lk ll lm la b"><a class="ae md" href="https://nodejs.org/docs/latest/api/process.html#process_process_env" rel="noopener ugc nofollow" target="_blank"><em class="hi">process.env</em></a></code></p></blockquote><p id="2509" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">2.在Angular应用程序的根目录下创建新文件(set-env.ts)。</p><p id="645f" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这将让我们处理系统环境变量(。env)，新建或替换名为environment . custom . ts(<em class="lz">target path</em>property)的文件。</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="80f5" class="le jt hi la b fi lf lg l lh li">const { writeFile } = require('fs');</span><span id="a8aa" class="le jt hi la b fi lj lg l lh li">// Your environment.custom.ts file. Will be ignored by git.</span><span id="4976" class="le jt hi la b fi lj lg l lh li">const targetPath = './src/environments/environment.custom.ts';</span><span id="5dab" class="le jt hi la b fi lj lg l lh li">// Load dotenv to work with process.env</span><span id="08ca" class="le jt hi la b fi lj lg l lh li">require('dotenv').config();</span><span id="b9c1" class="le jt hi la b fi lj lg l lh li">// environment.ts file structure</span><span id="5d8a" class="le jt hi la b fi lj lg l lh li">const envConfigFile = `<br/>  function getApiBasePath(): string {<br/>    return (window as any).config.API_BASE_PATH  || 'default-url';<br/>}</span><span id="0191" class="le jt hi la b fi lj lg l lh li">export const environment = {<br/> production: false,<br/> API_BASE_PATH: getApiBasePath(),<br/> MSAL: {<br/>  CLIENT_ID: '${process.env.MSAL_CLIENT_ID}',<br/>  AUTHORITY: '${process.env.MSAL_AUTHORITY}',<br/>},<br/> debugStream: '${process.env.DEBUG_STREAM}',<br/>};<br/>`;</span><span id="2fe1" class="le jt hi la b fi lj lg l lh li">writeFile(targetPath, envConfigFile, function (err) {<br/> if (err) {<br/>  throw console.error(err);<br/> } else {<br/>  console.log('Using custom environment');<br/>}<br/>});</span></pre><blockquote class="lw lx ly"><p id="ef79" class="iu iv lz iw b ix iy iz ja jb jc jd je ma jg jh ji mb jk jl jm mc jo jp jq jr hb bi translated">不要忘记设置您的环境变量。例如，在上面的例子中，在Windows中设置MSAL客户端ID，我们运行<code class="du lk ll lm la b"><em class="hi">set MSAL_CLIENT_ID="your-id"</em></code>。在MacOS或Linux中可以不同。</p></blockquote><p id="6c4b" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">3.将environment.custom.ts文件添加到<code class="du lk ll lm la b"><em class="lz">.gitignore</em></code> <em class="lz"> </em>中，以排除我们生成的environment.custom.ts被提交到repo。</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="efa6" class="le jt hi la b fi lf lg l lh li"># custom files<br/>/src/environments/environment.custom.ts</span></pre><p id="9542" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">4.默认情况下，Angular为我们提供了两个环境(environment.ts和environment.prod.ts)。现在我们应该让Angular知道我们有了新的定制环境文件和处理它的方法(用于服务、构建、测试)。将这个加粗的<strong class="iw hj">自定义</strong>条目添加到angular.json for building(在architect/build/configurations对象内部)</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="7a31" class="le jt hi la b fi lf lg l lh li">"your-projectName": {<br/>  ...<br/>  "architect": {<br/>    "build": {<br/>      ...<br/>      "configurations": {<br/>        "production": {<br/>          "fileReplacements": [<br/>            {<br/>              "replace": "src/environments/environment.ts",<br/>              "with": "src/environments/environment.prod.ts"<br/>            }<br/>          ]<br/>        },<br/>      <strong class="la hj">  "custom": {<br/>          "fileReplacements": [<br/>            {<br/>              "replace": "src/environments/environment.ts",<br/>              "with": "src/environments/environment.custom.ts"<br/>            }<br/>          ]<br/>        },</strong><br/>      }<br/>    ...<br/>    }<br/>    ...<br/>  }<br/>  ...<br/>}</span></pre><p id="aa91" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">5.为ng serve添加自定义条目(在architect/serve/configurations对象内)</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="7fd4" class="le jt hi la b fi lf lg l lh li">"serve": {<br/>   "builder": "@angular-devkit/build-angular:dev-server",<br/>   "options": {<br/>     "browserTarget": "your-project-name:build",<br/>     "proxyConfig": "proxy.conf.json"<br/>},<br/>"configurations": {<br/>  "production": {<br/>    "browserTarget": "your-project-name:build:production"<br/>},<br/>  <strong class="la hj">"custom": {<br/>    "browserTarget": "your-project-name:build:custom"<br/>  }<br/> }</strong><br/>},</span></pre><p id="b922" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">6.向e2e添加自定义条目(在建筑师/e2e/配置对象内)</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="36f4" class="le jt hi la b fi lf lg l lh li">"e2e": {<br/>"builder": "@angular-devkit/build-angular:protractor",<br/>    "options": {<br/>      "protractorConfig": "e2e/protractor.conf.js"<br/>      "devServerTarget": "your-project-name:serve"<br/>},<br/>"configurations": {<br/>  "production": {<br/>    "devServerTarget": "your-project-name:serve:production"<br/>},<br/>  <strong class="la hj">"custom": {<br/>    "devServerTarget": "your-project-name:serve:custom"<br/> }<br/> }</strong><br/>}</span></pre><p id="66e0" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">7.向package.json添加或修改我们的代码片段，以处理我们的set-env.ts文件。</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="61a1" class="le jt hi la b fi lf lg l lh li">{<br/>   ...<br/>   "scripts": {<br/>      "ng": "ng",<br/>      "config": "ts-node set-env.ts",<br/>      "start": "npm run config &amp;&amp; ng serve --configuration=custom",<br/>      "build": "npm run config &amp;&amp; ng build --configuration=custom",<br/>      ...<br/>   },<br/>   ...<br/>}</span></pre><p id="7912" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">好了，问题解决了。让我们总结一下运行<code class="du lk ll lm la b"><em class="lz">npm run start</em></code>时会发生什么。</p><p id="8106" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><code class="du lk ll lm la b"><em class="lz">ts-node</em></code>将运行<code class="du lk ll lm la b"><em class="lz">set-env.ts</em></code>，它将处理我们的系统环境变量并创建新文件，该文件的内容只是set-env.ts文件中的<code class="du lk ll lm la b"><em class="lz">envConfigFile</em></code>常量。最后，它将运行ng serve，该服务器将使用我们新的environment.custom.ts文件作为配置。同样重要的是，我们的承诺是干净的，因为我们将我们的环境和习惯排除在变更之外。</p><p id="e9e4" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">更多信息:参考资料<a class="ae md" rel="noopener" href="/@ferie/how-to-pass-environment-variables-at-building-time-in-an-angular-application-using-env-files-4ae1a80383c"> 1 </a>、<a class="ae md" href="https://dev.to/mikgross/set-up-multiple-environments-in-angular-376c" rel="noopener ugc nofollow" target="_blank"> 2 </a>。</p><p id="3216" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">就这些，希望你喜欢阅读并从中受益。☕</p><p id="d91b" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><em class="lz">关注我的</em> <a class="ae md" href="https://twitter.com/Vugar005" rel="noopener ugc nofollow" target="_blank"> <em class="lz">推特</em> </a></p></div></div>    
</body>
</html>