<html>
<head>
<title>Implement OAuth2 PKCE in Swift</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Swift中实施OAuth2 PKCE</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/implement-oauth2-pkce-in-swift-9bdb58873957?source=collection_archive---------2-----------------------#2021-12-18">https://medium.com/geekculture/implement-oauth2-pkce-in-swift-9bdb58873957?source=collection_archive---------2-----------------------#2021-12-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="3435" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇博文中，我将教授并分享一个用Swift编写的OAuth2 PKCE实现。这个实现可以用一个利用Auth0免费服务的iOS应用程序来测试。我将解释如何注册您自己的帐户，并修改测试应用程序以使用您的帐户。</p><p id="992f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意:我写这篇博文是出于研究目的。我鼓励你根据你所使用的服务来使用现有的SDK。</p><h1 id="d672" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">PKCE</h1><p id="954f" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">OAuth框架为不同的用例指定了几种授权类型。常见的有</p><ul class=""><li id="75cb" class="kg kh hi ih b ii ij im in iq ki iu kj iy kk jc kl km kn ko bi translated">授权码:机密客户端和公共客户端使用授权码来交换访问令牌。</li><li id="648d" class="kg kh hi ih b ii kp im kq iq kr iu ks iy kt jc kl km kn ko bi translated">客户端凭据:由客户端用来获取上下文之外的访问令牌</li></ul><p id="c3a1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是还有很多，包括OAuth公共客户端的<strong class="ih hj">P</strong>roof<strong class="ih hj">K</strong>ey for<strong class="ih hj">C</strong>ode<strong class="ih hj">E</strong>xchange。</p><p id="e5d3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">PKCE ( <a class="ae ku" href="https://tools.ietf.org/html/rfc7636" rel="noopener ugc nofollow" target="_blank"> RFC 7636 </a>)是对授权代码流的扩展，用于防止跨站点请求伪造(CSRF)和授权代码注入攻击。</p><p id="f467" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该技术包括客户端首先创建一个秘密，然后在用授权码交换访问令牌时再次使用该秘密。如果代码被截获，它就没有用了，因为令牌请求依赖于初始秘密。</p><p id="2f70" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">更熟悉相关步骤的一个好方法是使用OAuth 2.0平台上的<a class="ae ku" href="https://www.oauth.com/playground/authorization-code-with-pkce.html" rel="noopener ugc nofollow" target="_blank"> PKCE示例</a>。</p><p id="493e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是Auth0公布的的序列图<a class="ae ku" href="https://auth0.com/docs/authorization/flows/authorization-code-flow-with-proof-key-for-code-exchange-pkce" rel="noopener ugc nofollow" target="_blank">直观说明。</a></p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es kv"><img src="../Images/93e5c24767f06a690f38ffd241cc893b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*YZiwu-pKqwv1qcYz.png"/></div></div></figure><p id="00c3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Auth0还创建了一个关于构建您自己的解决方案的有用指南，作为使用PKCE的授权代码流添加登录指南的一部分。</p><h1 id="2206" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">快速实施</h1><p id="f6e4" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">我将在一个类中实现所有必要的步骤。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es lh"><img src="../Images/1f67be53da47c7f602ba43687807ec1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*10N_rC0TDMeJFxpHHBtQHw.png"/></div></div><figcaption class="li lj et er es lk ll bd b be z dx">Encapsulate OAuth 2.0 PKCE client handling in a single class</figcaption></figure><p id="9e2b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所有需要的参数都将作为结构传递给该类。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es lm"><img src="../Images/87f2c8c9d57f95745193f2e10eae0e06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4weNiUxqekl5PBgHHIAePQ.png"/></div></div><figcaption class="li lj et er es lk ll bd b be z dx">Encapsulate parameters in a struct</figcaption></figure><p id="a0ad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该函数应异步返回来自授权服务器的访问令牌响应或错误。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es ln"><img src="../Images/33692436a1b8a2a207f2a41e782e0446.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uUk1dpoUVSkrkvTECNP1Gw.png"/></div></div><figcaption class="li lj et er es lk ll bd b be z dx">Return types</figcaption></figure><p id="9011" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了将用户和<code class="du lo lp lq lr b">code_challenge.</code>一起重定向到授权服务器，我将使用苹果<code class="du lo lp lq lr b">AuthenticationServices</code>的<code class="du lo lp lq lr b">ASWebAuthenticationSession</code>。</p><p id="7371" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">完整的实现可以在<a class="ae ku" href="https://github.com/MarcoEidinger/pkce-ios-swift-auth0server/blob/main/AppUsingPKCE/OAuth2PKCEAuthenticator.swift" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><h1 id="2be3" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">iOS测试应用</h1><p id="c77e" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">我创建了一个iOS测试应用程序来验证PKCE实现。为了开始流动，用户将触摸一个按钮。然后将执行下面的代码。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es ls"><img src="../Images/41020e6b204b1b581d182bf460713816.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2mkNuYlUkoASQfvRHIPHpQ.png"/></div></div></figure><p id="2359" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">测试应用程序的完整代码可以在我的GitHub仓库中找到。</p><div class="lt lu ez fb lv lw"><a href="https://github.com/MarcoEidinger/pkce-ios-swift-auth0server" rel="noopener  ugc nofollow" target="_blank"><div class="lx ab dw"><div class="ly ab lz cl cj ma"><h2 class="bd hj fi z dy mb ea eb mc ed ef hh bi translated">GitHub-MarcoEidinger/pkce-IOs-swift-auth 0 server…</h2><div class="md l"><h3 class="bd b fi z dy mb ea eb mc ed ef dx translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="me l"><p class="bd b fp z dy mb ea eb mc ed ef dx translated">github.com</p></div></div><div class="mf l"><div class="mg l mh mi mj mf mk lf lw"/></div></div></a></div><p id="edb2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">应用程序用于测试的授权服务器来自Auth0。我将在下一章解释如何创建自己的账户。不用担心，这很简单，而且是免费的。</p><h1 id="413d" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">使用Auth0测试环境</h1><p id="8946" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">使用您现有的GitHub帐户注册Auth0(免费启动计划)既快速又简单</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es ml"><img src="../Images/871b025d774a02cf5747ba2afb4a1c55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*FubtM-c8NZ7Smeth"/></div></div><figcaption class="li lj et er es lk ll bd b be z dx">Sign Up for Auth0 account. It’s free</figcaption></figure><p id="1c4e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，您可以选择一个地区并创建您的Auth0帐户。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es ml"><img src="../Images/e8b5f4827d616ec2ed232f9e1e91b780.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*S6Hjdtiv35-jbFAH"/></div></div><figcaption class="li lj et er es lk ll bd b be z dx">Choose a region for your tenant</figcaption></figure><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es ml"><img src="../Images/ec6480d8911f86a081ebbf5b56b5546a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7XDAKCXt-eYbOR1e"/></div></div><figcaption class="li lj et er es lk ll bd b be z dx">Let’s get started in Auth0 cockpit</figcaption></figure><p id="29ac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们创建一个用户进行测试。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es ml"><img src="../Images/64c31fb9ad3c220869f6bcc301ab489d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LR1EOOK35iVw8LaM"/></div></div><figcaption class="li lj et er es lk ll bd b be z dx">You don’t have any users yet</figcaption></figure><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es ml"><img src="../Images/91b7789c67f80f22ac96a8313e79881f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LCvJJCM85crblzNU"/></div></div><figcaption class="li lj et er es lk ll bd b be z dx">Create the first user</figcaption></figure><p id="617e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们创建一个新的本机应用程序。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es ml"><img src="../Images/f49875509be43139d958a367182fc26c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qQUTBJdenfdx5XE-"/></div></div><figcaption class="li lj et er es lk ll bd b be z dx">A default app exist but we want our own!</figcaption></figure><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es ml"><img src="../Images/e43cf98626524c140dbc3753cdff81bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*DDbsLbHbXxAqnd-w"/></div></div><figcaption class="li lj et er es lk ll bd b be z dx">Create a native application</figcaption></figure><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es ml"><img src="../Images/ba794ed84bcba0bfeff62dc0ec2bf687.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qjaxYSkIyoxUMGUB"/></div></div><figcaption class="li lj et er es lk ll bd b be z dx">The app with its domain and client id</figcaption></figure><p id="d443" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">稍后您将需要在Swift中使用<code class="du lo lp lq lr b">Domain</code>和<code class="du lo lp lq lr b">Client ID</code>。</p><p id="9eb1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您必须根据iOS应用捆绑包标识符指定允许的回拨和注销URL(测试应用使用的是<code class="du lo lp lq lr b">us.eidinger.AppUsingPKCE</code>)。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es ml"><img src="../Images/abca82734e253f8793ca2f8ede462634.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*yFvdi8ebimYBncGc"/></div></div><figcaption class="li lj et er es lk ll bd b be z dx">Add Allowed Callback URLs</figcaption></figure><p id="04d9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们仔细检查一下是否设置了<code class="du lo lp lq lr b">Authorization Code</code> Grant(应该是默认设置),并保存更改。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es ml"><img src="../Images/debfa101eb8275004eaa8a8c073fbdd0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hpTd_Wq7Voy-KaR8"/></div></div><figcaption class="li lj et er es lk ll bd b be z dx">Authorization Code needs to be selected</figcaption></figure><h1 id="9d0b" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">运行测试应用程序</h1><p id="f79c" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">使用客户端id和域，我们可以检测演示应用程序</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es ls"><img src="../Images/e325c9cfd41b8cf5643ce792f26f2d3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O8mRFRdHMRvc6654i-vfPA.png"/></div></div><figcaption class="li lj et er es lk ll bd b be z dx">Replace values with your own account / app information</figcaption></figure><p id="95e5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">并在iOS模拟器上运行。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div class="er es mm"><img src="../Images/3eb56a9901b4469e6d660ca51736cef5.png" data-original-src="https://miro.medium.com/v2/resize:fit:828/0*ZtP4EseqjTXJyZKy"/></div><figcaption class="li lj et er es lk ll bd b be z dx">Touch “Sign In” to start the flow</figcaption></figure><p id="d7e5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">触摸Sing In按钮将触发<code class="du lo lp lq lr b">ASWebAuthenticationSession</code>将用户重定向到授权服务器。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div class="er es mm"><img src="../Images/5b951c8fda4069b31286bf3e002dd6df.png" data-original-src="https://miro.medium.com/v2/resize:fit:828/0*dOruD0qOdnJlFsSi"/></div><figcaption class="li lj et er es lk ll bd b be z dx">User gets redirected. So far so good</figcaption></figure><p id="8321" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们使用在Auth0中创建的用户凭证。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div class="er es mm"><img src="../Images/bead92bc3ba0d8211cd0fe44ba63cd4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:828/0*GhftgNBZkq12EU3H"/></div><figcaption class="li lj et er es lk ll bd b be z dx">Do you remember the password you set for the user you created earlier?</figcaption></figure><p id="dee8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">触摸继续按钮将控制返回到测试应用程序。流程将继续(即，利用从授权服务器和<code class="du lo lp lq lr b">code_verifier</code>接收到的代码获得访问令牌，并最终显示接收到的访问令牌。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div class="er es mm"><img src="../Images/3365ea265032c8574c4ef9ea5f7f810d.png" data-original-src="https://miro.medium.com/v2/resize:fit:828/0*6-XpGQ3dyGmdKwws"/></div><figcaption class="li lj et er es lk ll bd b be z dx">Yeah, it works :)</figcaption></figure><p id="d7f3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我希望本指南有助于您熟悉PKCE，并让您了解如何在Swift客户端上实施它。</p></div><div class="ab cl mn mo gp mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="hb hc hd he hf"><p id="55fb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="mu">最初发布于</em><a class="ae ku" href="https://blog.eidinger.info/implement-oauth2-pkce-in-swift-and-test-with-auth0-authorization-server" rel="noopener ugc nofollow" target="_blank"><em class="mu">https://blog . ei dinger . info</em></a><em class="mu">。</em></p></div></div>    
</body>
</html>