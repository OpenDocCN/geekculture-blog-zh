<html>
<head>
<title>Microservices in Rust: Publishing and Subscribing Messages in Redis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Rust中的微服务:在Redis中发布和订阅消息</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/implementing-pub-sub-pattern-in-rust-with-redis-publish-f0eeac3354b1?source=collection_archive---------7-----------------------#2021-03-28">https://medium.com/geekculture/implementing-pub-sub-pattern-in-rust-with-redis-publish-f0eeac3354b1?source=collection_archive---------7-----------------------#2021-03-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/147e8a4a590ffc2f4180c5fb16386738.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ubDPsDhzGdbg8-Q5"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Photo by <a class="ae iu" href="https://unsplash.com/@katemacate?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Kate Macate</a> on <a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="604a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">发布/订阅模式，也称为发布/订阅，是一种广泛使用的模式，它需要以异步和分离的方式在服务之间创建通信。</p><p id="19f7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如您所知，Redis是内存中的数据结构存储，主要用于缓存和存储数据，它还为我们提供了发布/订阅功能，这为这个令人惊叹的工具又增加了一个实用工具。</p><p id="9329" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在本文中，我们实现了发布消息的方法，并生成了一个线程来监听Redis中推送的消息。</p><p id="7943" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为此，我们将使用不可思议的、全世界都喜爱的语言:Rust！</p><p id="15c4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">完整代码是github 上的<a class="ae iu" href="https://github.com/paoloposso/rust_redis_pubsub/blob/main/src/redis_publisher.rs" rel="noopener ugc nofollow" target="_blank"> repo，如果有对你有用的部分欢迎克隆！</a></p><p id="3305" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我假设您的机器上安装了Redis、Rust和Cargo(软件包管理器)。但不管怎样，链接来了:</p><div class="jt ju ez fb jv jw"><a href="https://www.rust-lang.org/tools/install" rel="noopener  ugc nofollow" target="_blank"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hj fi z dy kb ea eb kc ed ef hh bi translated">安装铁锈</h2><div class="kd l"><h3 class="bd b fi z dy kb ea eb kc ed ef dx translated">关于Rust安装的注意事项如果您刚刚开始使用Rust，并且想要更详细的演示，请参见…</h3></div><div class="ke l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">www.rust-lang.org</p></div></div><div class="kf l"><div class="kg l kh ki kj kf kk io jw"/></div></div></a></div><div class="jt ju ez fb jv jw"><a href="https://redis.io/download" rel="noopener  ugc nofollow" target="_blank"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hj fi z dy kb ea eb kc ed ef hh bi translated">雷迪斯</h2><div class="kd l"><h3 class="bd b fi z dy kb ea eb kc ed ef dx translated">稳定版本完全遵循通常的major.minor.patch语义版本模式。不稳定这是所有的…</h3></div><div class="ke l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">redis.io</p></div></div><div class="kf l"><div class="kl l kh ki kj kf kk io jw"/></div></div></a></div><p id="d7ca" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要创建项目，请选择您的首选文件夹，打开终端(或cmd)并执行命令。</p><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="ec42" class="kv kw hi kr b fi kx ky l kz la">cargo new rust_pubsub --bin</span></pre><p id="e5ab" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">之后，将使用main.rs文件创建该结构。</p><p id="1f67" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">转到Cargo.toml文件并添加依赖项:</p><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="25dc" class="kv kw hi kr b fi kx ky l kz la">[dependencies]</span><span id="c56b" class="kv kw hi kr b fi lb ky l kz la">tokio = { version = "*", features = ["full"] }</span><span id="a4fb" class="kv kw hi kr b fi lb ky l kz la">redis = "*"</span><span id="c227" class="kv kw hi kr b fi lb ky l kz la">uuid = { version = "0.8.2", features = ["v4"] }</span><span id="5983" class="kv kw hi kr b fi lb ky l kz la">serde_json = "*"</span><span id="55d5" class="kv kw hi kr b fi lb ky l kz la">serde = {version = "*", features = ["derive"]}</span></pre><p id="7ef8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在让我们创建消息结构。这个结构将是发布在Redis上的消息。注意，我们有一个Order结构作为有效载荷。</p><figure class="km kn ko kp fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lc"><img src="../Images/3e3cfa54666347c7caa6c1ce816e1c23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SoUrvFF9HG9FIvAZTIiFZQ.png"/></div></div></figure><p id="7a2d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这种情况下，Message作为包装器工作，Order是有效负载。当然，在不同的项目中，我们可能有不同的有效载荷。泛型可以让事情变得更加灵活。</p><p id="b749" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">注意，该消息还有一个channel属性，用于标识要订阅的Redis通道并推送消息。</p><p id="f062" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Message还有一个自动生成的UUID，可用于跟踪、调试或识别消息。</p><p id="9203" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="ld">派生</em>属性对于序列化、反序列化和打印(调试)结构非常重要。</p><p id="f315" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下面的文件redis_publisher.rs包含发布功能。它连接到Redis，在本例中是在localhost上，并将消息发布到通道。</p><figure class="km kn ko kp fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es le"><img src="../Images/4c8a6ccfcee122face7be116d672d486.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w0cK2-gvKyf1pBaaiU505g.png"/></div></div></figure><p id="c7b8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这种情况下，我使用serde来序列化对象，因此它可以作为json发布。</p><p id="0643" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下面的代码在Redis上创建了一个频道订阅。</p><figure class="km kn ko kp fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lf"><img src="../Images/2acea40b9d94eba902cca45001406560.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0SuDUZNqBsw4h4e6-zGCVQ.png"/></div></div></figure><p id="69a9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">请注意，<a class="ae iu" href="https://tokio.rs/tokio/tutorial" rel="noopener ugc nofollow" target="_blank"> Tokio </a>在这里用于生成一个线程，该线程将监听Redis上“订单”频道上发布的每条消息。</p><p id="601b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">接收到的消息被反序列化为一个消息对象，并发送给消息处理程序，如下所示。</p><figure class="km kn ko kp fd ij er es paragraph-image"><div class="er es lg"><img src="../Images/77657cae28d130d1ee41376d468f5beb.png" data-original-src="https://miro.medium.com/v2/resize:fit:978/format:webp/1*bpqanSj2bkLPr2pNpai6jQ.png"/></div></figure><p id="7da0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这种情况下，我只打印对象信息，但是当然这对于订阅者来说是一个重要的部分，在这里接收到的消息将被处理、验证、记录等等…</p><p id="56e9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在让我们完成代码，使用main.rs文件来模拟微服务调用。</p><figure class="km kn ko kp fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lh"><img src="../Images/6b72b6515c09edc18052e52d8df92e9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1jlkDZNfl-eFr__xTlpT1Q.png"/></div></div></figure><p id="1382" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">tokio::main属性必须添加到main函数中，还有async标记，否则前面描述的async特性将不起作用，程序将会死机。</p><p id="c90d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在main函数中，我们调用subscribe函数，它将运行在前面看到的衍生线程上，然后我们调用<em class="ld"> publish_message </em>函数，创建一个消息对象并传递给该函数。</p><p id="a70e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，为了测试我们的程序，在您的终端中执行“货物运行”。订单应按其发布和接收的顺序显示。</p><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="53d5" class="kv kw hi kr b fi kx ky l kz la">Message { id: "2fa21d130e1042eba88d2611bb274aef", channel: "order", payload: Order { description: "T-Shirt", quantity: 3, total_price: 24.0 } }<br/>Message { id: "1b027c9dc6874c32ad8976b60b1f9a91", channel: "order", payload: Order { description: "Sneakers", quantity: 1, total_price: 230.0 } }<br/>published<br/>Message { id: "041b78207fb54939aa3ad4ebda7733ff", channel: "order", payload: Order { description: "Milka Bar", quantity: 10, total_price: 50.0 } }</span></pre><p id="c50e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">好了，就这些，希望你喜欢！</p></div></div>    
</body>
</html>