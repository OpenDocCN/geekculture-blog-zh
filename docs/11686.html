<html>
<head>
<title>Implement an Uptime Monitor Using AWS Lambda, EventBridge, SNS, and SQS.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS Lambda、EventBridge、SNS和SQS实现正常运行时间监控。</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/implement-an-uptime-monitor-using-aws-lambda-eventbridge-sns-and-sqs-cf35d1ba4c9d?source=collection_archive---------5-----------------------#2022-04-04">https://medium.com/geekculture/implement-an-uptime-monitor-using-aws-lambda-eventbridge-sns-and-sqs-cf35d1ba4c9d?source=collection_archive---------5-----------------------#2022-04-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/b9ed36f95634a985332a7e4c699103ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*u63mlIh8d_IFgfJw"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Photo by <a class="ae iu" href="https://unsplash.com/@altumcode?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">AltumCode</a> on <a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="0ae2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以使用AWS EventBridge规则来安排Lambda函数在特定时间或设定的时间间隔运行。将这两种服务结合起来，可以释放出大量的使用案例和工作负载。通过使用EventBridge规则调度Lambda函数，可以实现从常规web抓取作业到自动每日提醒的任何事情。</p><p id="494c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在本文中，我们将安排一个Lambda函数每5分钟运行一次，以检查网站的健康状况。Lambda函数将向网站服务器发送一个简单的HTTP请求，并检查响应代码。如果响应代码不是200，Lambda函数将向可以订阅的SNS主题发送一条警告消息。这就是我如何为我的SaaS监控和警报系统<a class="ae iu" href="https://komonitor.com" rel="noopener ugc nofollow" target="_blank"> Komonitor </a>实现正常运行时间监控的。</p><p id="5d0e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">本文的惟一先决条件是设置好AWS帐户和节点环境。</p><h1 id="837e" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">设置AWS资源</h1><p id="7004" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">本节将介绍如何通过AWS控制台设置所需的AWS资源。</p><h1 id="4773" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">λ函数</h1><p id="1e84" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">首先，我们需要创建一个Lambda函数，用于检查我们网站的健康状况。</p><p id="1233" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">导航到AWS Lambda控制台，创建一个新的Lambda函数并为其命名。</p><p id="1120" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建后，它应该在控制台中可见，如下所示:</p><figure class="kx ky kz la fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kw"><img src="../Images/437ccb67a1a06fb8c2aa17be96bfeb63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m1R2SSNj3nfQVbvjvnymBA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">AWS Lambda console with newly created Lambda function</figcaption></figure><p id="8dd6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">目前，该函数只有打印hello-world消息的模板代码。在本文的后面，我们将在Lambda函数中实现<br/>正常运行时间检查逻辑。</p><h1 id="1031" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">事件桥规则</h1><p id="f1c0" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">为了安排Lambda函数每5分钟运行一次，我们需要创建一个EventBridge规则。<br/>导航到AWS EventBridge控制台，点击<strong class="ix hj">创建规则</strong>按钮。</p><p id="dd4c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在<strong class="ix hj">定义规则细节</strong>步骤中，给规则命名并将<strong class="ix hj">规则类型</strong>设置为<strong class="ix hj">计划</strong>并继续下一步。</p><figure class="kx ky kz la fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kw"><img src="../Images/bdd30005250062146f62b0e773c5ed64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3MsSkSHEvg-Y0gtFIh9rOA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">AWS EventBridge console — Define rule detail</figcaption></figure><p id="e3ba" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下一步，定义日程模式，并将<strong class="ix hj">速率表达式</strong>设置为5分钟。</p><figure class="kx ky kz la fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kw"><img src="../Images/e7abdb75624e3d2d3de70a46bd2d7b92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TgxfRuKwX68QRcWBrJOErw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">AWS EventBridge console — Define schedule pattern</figcaption></figure><p id="4d79" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，选择该事件规则的目标。选择<strong class="ix hj"> AWS服务</strong>，然后选择<strong class="ix hj">λ功能</strong>。在下拉列表中，前面创建的Lambda函数名称应该是一个选项，选择它。</p><figure class="kx ky kz la fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kw"><img src="../Images/485e3fa8566f76bb895803be373ed846.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y4ZLasf5ggU2JU796wSOhQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">AWS EventBridge console — Select targets</figcaption></figure><p id="70ae" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这就是设置事件规则所需的全部配置，继续执行以下步骤并创建规则。</p><p id="9308" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了确认规则是针对Lambda函数创建和配置的，导航到Lambda控制台并查看函数概述<br/>。该规则应该在“功能概述和配置”选项卡中可见，如下所示:</p><figure class="kx ky kz la fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kw"><img src="../Images/d7924c3c4e2e3f77377bd0d4c44cd944.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8VUhyWSDXE55RJHktkCFfw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">AWS Lambda console with EventBridge rule listed as trigger</figcaption></figure><h1 id="4b11" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">SNS主题和Lambda权限</h1><p id="8a3f" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">我们的正常运行时间监视器将通过SNS主题捕捉警报，超过100个缔约方可以订阅。转到SNS控制台，创建一个新的FIFO主题。</p><figure class="kx ky kz la fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kw"><img src="../Images/0ada30b107e8fd42a86baf59c237d0ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*thNHPqyLUHPDPqBdNc2FlQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">AWS SNS console with newly created FIFO topic</figcaption></figure><p id="be27" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了让Lambda函数将消息发布到SNS主题，我们需要编辑Lambda函数的IAM角色，并授予它发布到主题的权限。</p><p id="46bf" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">回到Lambda控制台查看该功能，选择<strong class="ix hj">配置</strong>选项卡，然后选择<strong class="ix hj">权限</strong>。您将看到列出了<br/>执行角色。单击它可以导航到IAM控制台。</p><p id="0e55" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">点击<strong class="ix hj">添加权限</strong>，然后点击<strong class="ix hj">创建内嵌策略</strong>。</p><figure class="kx ky kz la fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kw"><img src="../Images/182c48d73ae489c3888bbaf68b57508f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G1EnVhlq0rZ_SHXaEPvB5g.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">IAM console for Lambda function execution role</figcaption></figure><p id="dd43" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在内联策略可视化编辑器中，将服务设置为SNS，并在actions下，筛选并选择<strong class="ix hj"> Publish </strong>。</p><figure class="kx ky kz la fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kw"><img src="../Images/3cab3ac99e3ca7df78156bece2e3ca0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PMKRLrHPFO1BI6reHS-D_Q.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Inline policy visual editor</figcaption></figure><p id="c84f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">对于<strong class="ix hj">资源</strong>，进入SNS话题ARN。保存内联策略，并确保它附加到Lambda执行角色。</p><h1 id="f120" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">SQS排队并订阅社交网站</h1><p id="0afc" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">每当Lambda向SNS主题发布消息时，我们都希望能够看到我们的警报，因此我们将创建一个SWS队列，订阅来自SNS主题的消息，并允许我们在AWS控制台中查看消息。</p><p id="8efb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">转到SQS控制台，创建一个新的FIFO队列，如下所示:</p><figure class="kx ky kz la fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kw"><img src="../Images/535c820ff130b761d7255494b7f24222.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EfwTLClzQtDmGDxUbaUjig.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">AWS SQS creation console</figcaption></figure><p id="8dd8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建队列后，您将看到队列的概述。<br/>点击<strong class="ix hj">订阅亚马逊SNS主题</strong>，选择您之前创建的SNS主题并创建订阅。</p><p id="204e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，每当我们向SNS主题发布警报消息时，这些消息就会出现在SQS队列中。</p><p id="b9d2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">所有必需的AWS资源现在都已经设置好了。在下一节中，我们将实现Lambda函数代码。</p><h1 id="da03" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">λ代码</h1><p id="a21b" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">现在，让我们编写Lambda函数执行正常运行时间检查的代码。我们将使用JavaScript编写Lambda函数，并在NPM中使用Node.js运行时。</p><p id="3c39" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在您的系统上创建一个新目录，并运行:</p><p id="d469" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后安装<strong class="ix hj"> AWS SDK </strong>和<strong class="ix hj">取</strong>包；</p><pre class="kx ky kz la fd lb lc ld le aw lf bi"><span id="2b23" class="lg ju hi lc b fi lh li l lj lk">npm install aws-sdk node-fetch</span></pre><p id="4fd6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要使用ESM模块，打开<code class="du ll lm ln lc b">package.json</code>并添加<code class="du ll lm ln lc b">"type": "module"</code>。</p><p id="6a63" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">打开<code class="du ll lm ln lc b">index.js</code>，写下面的代码(一定要填写自己的网站网址和SNS话题ARN。):</p><figure class="kx ky kz la fd ij"><div class="bz dy l di"><div class="lo lp l"/></div></figure><p id="8331" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">注意，在这个简单的实现中，我们硬编码了网站URL和SNS主题ARN。通常，我们希望从触发Lambda函数的事件或环境变量中读取这些值。</p><p id="a1a9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了将代码和依赖项上传到Lambda函数，我们需要压缩文件。<br/>在Linux上，这可以使用:</p><pre class="kx ky kz la fd lb lc ld le aw lf bi"><span id="ff6f" class="lg ju hi lc b fi lh li l lj lk">zip -r package.zip . *</span></pre><p id="8bd4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这个命令将在当前目录下创建一个<code class="du ll lm ln lc b">package.zip</code>文件，它将包含Lambda所需的一切。</p><p id="08a8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在Lambda function overview上，转到<strong class="ix hj"> Code </strong>选项卡，上传包含代码的zip文件。</p><h1 id="5f9c" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">确保一切正常</h1><p id="e908" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">我们可以在<strong class="ix hj">测试</strong>选项卡中手动运行Lambda。<br/>如果Lambda从它正在监控的网站收到200 OK状态码，它将<strong class="ix hj">而不是</strong>向SNS主题<br/>发布消息，而是记录该网站如下所示:</p><figure class="kx ky kz la fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kw"><img src="../Images/1a98972b07feafec36e43102072399c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HJK50qHc-5rn5XoPcRIvyg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Lambda function execution output</figcaption></figure><p id="8cc4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果我们想看到运行中的警报，将网站URL更改为<a class="ae iu" href="https://httpstat.us/400" rel="noopener ugc nofollow" target="_blank"><strong class="ix hj">https://httpstat.us/400</strong></a>，这样我们总是会得到一个400状态代码。<br/>重新加载一个新的zip文件到Lambda函数，然后再次测试。Lambda日志将指示该网站已关闭，它向SNS主题发布了一条消息。</p><p id="0338" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要查看消息，请到队列的SQS控制台，点击<strong class="ix hj">发送和接收消息</strong>。点击<strong class="ix hj">轮询消息</strong>，您应该能够看到队列中的消息。单击它以查看消息细节，它应该类似于这个JSON对象:</p><pre class="kx ky kz la fd lb lc ld le aw lf bi"><span id="8fb4" class="lg ju hi lc b fi lh li l lj lk">{</span><span id="6053" class="lg ju hi lc b fi lq li l lj lk">"Type": "Notification",</span><span id="e9de" class="lg ju hi lc b fi lq li l lj lk">"MessageId": "a44c27f8-9c68-507e-8ba9-7d3b45a76115",</span><span id="c171" class="lg ju hi lc b fi lq li l lj lk">"SequenceNumber": "10000000000000011000",</span><span id="6fa9" class="lg ju hi lc b fi lq li l lj lk">"TopicArn": "arn:aws:sns:us-east-1:060780781184:Website-Alert-Topic.fifo",</span><span id="922a" class="lg ju hi lc b fi lq li l lj lk">"Subject": "Website Down Alert",</span><span id="585f" class="lg ju hi lc b fi lq li l lj lk">"Message": "Received 400 status code from https://httpstat.us/400",</span><span id="cec7" class="lg ju hi lc b fi lq li l lj lk">"Timestamp": "2022-04-03T17:21:19.940Z",</span><span id="74bd" class="lg ju hi lc b fi lq li l lj lk">"UnsubscribeURL": "&lt;URL&gt;"</span><span id="224e" class="lg ju hi lc b fi lq li l lj lk">}</span></pre><p id="861b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果您在队列中看到类似上面的消息，您的正常运行时间监视器正在工作！尝试扩展这个简单的实现，以覆盖多个URL、地区等等。</p><h1 id="47dd" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">清除</h1><p id="0557" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">为了避免从AWS获得随机的账单，我们需要清理我们创建的资源。</p><p id="792a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">确保删除不再需要的Lambda函数、EventBridge规则、SNS主题和SQS队列。</p></div><div class="ab cl lr ls gp lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="hb hc hd he hf"><p id="48d3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="ly">原载于2022年4月4日</em><a class="ae iu" href="https://komonitor.com/blog/posts/implement-simple-uptime-monitor-in-aws" rel="noopener ugc nofollow" target="_blank"><em class="ly">https://</em>komonitor.com</a><em class="ly">。</em></p></div></div>    
</body>
</html>