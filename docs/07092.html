<html>
<head>
<title>Automate Gatsby Static Site Deployment to AWS S3 Using CodePipeline and CodeBuild</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用CodePipeline和CodeBuild自动将Gatsby静态站点部署到AWS S3</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/automate-gatsby-static-site-deployment-to-aws-s3-using-codepipeline-and-codebuild-d7ace2c9b08a?source=collection_archive---------14-----------------------#2021-09-07">https://medium.com/geekculture/automate-gatsby-static-site-deployment-to-aws-s3-using-codepipeline-and-codebuild-d7ace2c9b08a?source=collection_archive---------14-----------------------#2021-09-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/2e156b1ee5fd65ef52d4ae0db02a7577.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*P03cILsXiUOPOpWj"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Photo by <a class="ae iu" href="https://unsplash.com/@jstrippa?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">James Harrison</a> on <a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="2dd1" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">简介+先决条件</h1><p id="2d7f" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">Gatsby是一个非常棒的前端框架，可以快速开发和部署静态网站。有一个由漂亮的模板和插件组成的丰富的生态系统，适用于各种用例，如博客和作品集网站。</p><p id="5929" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">有几个服务，你可以很容易地部署便宜的静态网站，但是在这篇文章中，我们将讨论如何使用CodePipeline、CodeBuild和S3自动部署到AWS。我们将:</p><ol class=""><li id="ec74" class="kw kx hi jv b jw kr ka ks ke ky ki kz km la kq lb lc ld le bi translated">用我们的代码将CodePipeline管道连接到GitHub库。</li><li id="2b8a" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated">创建一个S3存储桶，并将其配置为托管一个面向公众的网站。</li><li id="8363" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated">创建一个CodeBuild项目，该项目将构建我们的代码并将其部署到我们的S3存储桶中。</li></ol><p id="082b" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><em class="lk">本文内容针对AWS初学者/中间用户。</em></p><h1 id="c7fb" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">先决条件</h1><ol class=""><li id="e889" class="kw kx hi jv b jw jx ka kb ke ll ki lm km ln kq lb lc ld le bi translated">包含您要部署的网站的GitHub存储库。如果你需要一个例子，你可以试着用<a class="ae iu" href="https://github.com/LekoArts/gatsby-themes/tree/master/themes/gatsby-theme-minimal-blog" rel="noopener ugc nofollow" target="_blank">这个博客主题</a>来开始。自述文件中的说明将告诉您如何开始使用它。</li><li id="f9a9" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated">AWS账户。</li></ol><h1 id="ac98" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">S3设置</h1><p id="8ecc" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">使用S3桶进行网站托管是一个常见的用例，其配置相对简单。</p><ol class=""><li id="1b88" class="kw kx hi jv b jw kr ka ks ke ky ki kz km la kq lb lc ld le bi translated">转到S3，创建一个新的存储桶。</li><li id="5d94" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated">输入存储桶名称。如果您将使用自定义域，您应该将存储桶命名为(example.com)。</li><li id="7e2f" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated">取消选中“阻止<em class="lk">所有</em>公共访问”。我们需要互联网上的人们能够访问我们的网站资产。</li><li id="21e1" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated">点击<strong class="jv hj">创建存储桶</strong></li></ol><p id="60ea" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">现在已经创建了存储桶，导航到它:</p><ol class=""><li id="603f" class="kw kx hi jv b jw kr ka ks ke ky ki kz km la kq lb lc ld le bi translated">进入<strong class="jv hj">属性</strong>标签，编辑“静态网站托管”</li><li id="2aba" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated">启用静态网站托管，为<strong class="jv hj">托管类型</strong>选择“托管静态网站”。</li><li id="d9f4" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated">对于<strong class="jv hj">索引文档</strong>和<strong class="jv hj">错误文档</strong>，分别输入“index.html”和“404.html”，或者您的站点构建的任何html文件作为索引和错误文档。</li><li id="2fc7" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated">点击<strong class="jv hj">保存更改</strong></li><li id="59c5" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated">最后，转到<strong class="jv hj">权限</strong>选项卡，将这个JSON输入到<strong class="jv hj">存储桶策略</strong>中:</li></ol><pre class="lo lp lq lr fd ls lt lu lv aw lw bi"><span id="2e30" class="lx iw hi lt b fi ly lz l ma mb">{<br/>  "Version": "2012-10-17",<br/>  "Statement": [<br/>    {<br/>      "Sid": "PublicReadForGetBucketObjects",<br/>      "Effect": "Allow",<br/>      "Principal": "*",<br/>      "Action": "s3:GetObject",<br/>      "Resource": "arn:aws:s3:::&lt;BUCKET_NAME&gt;/*"<br/>    }<br/>  ]<br/>}</span></pre><p id="b952" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">你的S3桶应该准备好了。</p><h1 id="e6ca" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">代码管道设置</h1><p id="336d" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">现在我们将创建一个代码管道，它将在我们每次推送至GitHub存储库时执行。导航到代码管道控制台，点击<strong class="jv hj">创建管道</strong>。在<strong class="jv hj">步骤1 </strong>中，选择一个名称，为管道选择<em class="lk">新服务角色</em>，进入下一步。</p><h2 id="59fe" class="lx iw hi bd ix mc md me jb mf mg mh jf ke mi mj jj ki mk ml jn km mm mn jr mo bi translated">GitHub源</h2><p id="617d" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">在<strong class="jv hj">步骤2 </strong>中，我们将连接到我们的GitHub帐户，并将我们的库作为源代码阶段添加到CodePipeline中。在<strong class="jv hj">源提供商</strong>下，选择GitHub(版本2)。这将打开以下更多选项:</p><ol class=""><li id="2a7a" class="kw kx hi jv b jw kr ka ks ke ky ki kz km la kq lb lc ld le bi translated">对于连接，选择一个现有的连接，或者，如果您以前从未将您的AWS帐户连接到GitHub，请单击<strong class="jv hj">连接到GitHub </strong>。这将提示您登录GitHub，并确认您想要创建一个连接。</li><li id="542a" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated">创建连接后，选择您想要使用的<strong class="jv hj">库名</strong>和<strong class="jv hj">分支名</strong>。</li><li id="91fc" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated">保留所有其他选项的默认值，因为此管道不需要它们。转到下一步。</li></ol><h2 id="fa6f" class="lx iw hi bd ix mc md me jb mf mg mh jf ke mi mj jj ki mk ml jn km mm mn jr mo bi translated">代码构建</h2><p id="8a82" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">在<strong class="jv hj">步骤3 </strong>中，选择CodeBuild作为构建提供者，然后点击<strong class="jv hj"> Create Project </strong>打开一个新窗口来创建一个新的CodeBuild项目。输入名称，暂时保留默认选项。我们将在下一节讨论代码构建步骤的细节。</p><p id="6831" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">步骤4 </strong>是代码管道中的“添加部署阶段”步骤。因为我们将在构建步骤中将静态站点构建文件复制到S3，所以我们可以跳过这个阶段，继续创建管道。</p><h1 id="ef31" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">代码构建设置</h1><p id="4be2" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">导航到CodeBuild控制台的<strong class="jv hj"> Build Projects </strong>部分，您应该看到在设置管道时创建的项目的名称。</p><p id="9144" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">选择构建项目并转到<strong class="jv hj">编辑</strong>，然后转到<strong class="jv hj">构建规范</strong>。</p><p id="d171" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">buildspec.yml文件包含在存储库中是很常见的，因此它也可以被版本控制，但是对于这个项目，我们将把我们的构建命令直接插入AWS控制台。</p><p id="7ce4" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">确保用您的S3桶的实际名称替换<code class="du mp mq mr lt b">BUCKET_NAME</code>。</p><h2 id="489e" class="lx iw hi bd ix mc md me jb mf mg mh jf ke mi mj jj ki mk ml jn km mm mn jr mo bi translated">buildspec.yml</h2><pre class="lo lp lq lr fd ls lt lu lv aw lw bi"><span id="ff29" class="lx iw hi lt b fi ly lz l ma mb">version: 0.2<br/><br/>phases:<br/>  install:<br/>    commands:<br/>      - "touch .npmignore"<br/>      - "npm install -g gatsby"<br/>  pre_build:<br/>    commands:<br/>      - "npm install"<br/>  build:<br/>    commands:<br/>      - "npm run build"<br/><br/>  post_build:<br/>    commands:<br/>      - 'aws s3 sync "public/" "s3://&lt;BUCKET_NAME&gt;" --delete --acl "public-read"'<br/><br/>artifacts:<br/>  base-directory: public<br/>  files:<br/>    - "**/*"<br/>  discard-paths: yes</span></pre><p id="f4f3" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">这是一个简单的构建规范。它安装我们的依赖项来构建一个Gatsby站点，然后运行将在package.json中定义的<code class="du mp mq mr lt b">npm run build</code>。在<em class="lk"> post_build </em>阶段，我们使用AWS CLI将静态站点资产(我们希望在public/ directory中)复制到我们用来托管站点的S3桶中。</p><h2 id="cb7c" class="lx iw hi bd ix mc md me jb mf mg mh jf ke mi mj jj ki mk ml jn km mm mn jr mo bi translated">附加策略以允许写入S3存储桶</h2><p id="1d7f" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">为了给予我们的构建项目访问我们的S3存储桶的许可，我们需要将一个适当的S3访问策略附加到构建项目的服务角色。为此:</p><ol class=""><li id="d80e" class="kw kx hi jv b jw kr ka ks ke ky ki kz km la kq lb lc ld le bi translated">导航到<strong class="jv hj"> Build details </strong>选项卡，找到项目的服务角色。服务角色列在<strong class="jv hj">环境</strong>下。单击服务角色链接打开IAM。</li><li id="5fdd" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated">将<code class="du mp mq mr lt b">AmazonS3FullAccess</code>策略附加到服务角色。请注意，在生产中不建议这样做，因为该策略允许访问所有存储桶和所有操作。您应该创建一个策略，仅定义对特定S3存储桶的写访问权限。</li></ol><p id="5c15" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">完成后，尝试执行管道，看看它是否运行完成。如果一切顺利，您应该能够在S3桶中看到您的构建文件，并且应该通过转到桶的URL来看到您的网站。</p><h1 id="75de" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">奖励:CloudFront分发+ AWS证书管理器+自定义域</h1><p id="8c56" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">我们应该做一些事情来使我们的网站更好地为生产做准备。</p><p id="9031" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">S3的网址并不完全漂亮，我们应该使用自定义域名。我们还希望能够使用SSL/TLS访问我们的网站，因此需要一个证书。最后，如果我们希望降低访客体验的延迟，我们应该将我们的资产托管在CDN中。以下部分将概述如何实现上述所有目标。</p><h2 id="2356" class="lx iw hi bd ix mc md me jb mf mg mh jf ke mi mj jj ki mk ml jn km mm mn jr mo bi translated">用于SSL/TLS +自定义域设置的AWS证书管理器</h2><p id="157d" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">如果您有自定义域，Amazon可以使用AWS证书管理器为其提供SSL/TLS证书。在证书管理器控制台中为您的域申请证书，并按照步骤验证您是否拥有您的域。</p><p id="46a4" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">验证完成后，如果你是<em class="lk">而不是</em>要创建一个CloudFront发行版，你可以添加一个指向S3 bucket URL的CNAME记录，这样你就可以使用HTTPS访问你的网站。</p><h2 id="b027" class="lx iw hi bd ix mc md me jb mf mg mh jf ke mi mj jj ki mk ml jn km mm mn jr mo bi translated">CloudFront分发设置</h2><p id="2f37" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">使用S3托管时，设置CloudFront CDN发行版很简单。</p><ol class=""><li id="c67e" class="kw kx hi jv b jw kr ka ks ke ky ki kz km la kq lb lc ld le bi translated">转到CloudFront控制台，点击<strong class="jv hj">创建发行版</strong></li><li id="fcae" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated">选择您的S3时段作为起始域，并输入起始域的名称。</li><li id="7bc2" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated">在<strong class="jv hj">默认缓存行为</strong>中，选择<strong class="jv hj">重定向HTTP到HTTPS </strong>如果您已经设置了SSL证书。</li><li id="a1c4" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated">在<strong class="jv hj">设置</strong>中，选择一个自定义SSL证书(如果已创建)并将<code class="du mp mq mr lt b">index.html</code>输入到<strong class="jv hj">默认根对象</strong>中。</li><li id="d32b" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated">点击<strong class="jv hj">创建分销</strong></li></ol><p id="c708" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">如果您在浏览器中转到分发域名，您应该能够看到您的网站(您可能需要等待几分钟)。</p><p id="03cd" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">最后，如果您使用自定义域名，您应该创建一个指向分发域名的CNAME记录，这样您就可以通过您的自定义域名访问CDN上的网站。</p><h2 id="9b50" class="lx iw hi bd ix mc md me jb mf mg mh jf ke mi mj jj ki mk ml jn km mm mn jr mo bi translated">结论</h2><p id="3968" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">在本文中，我们能够创建一个自动化管道来将静态Gatsby网站部署到S3。我们还能够添加一个自定义域，并在CloudFront发行版中托管我们的网站资产。一般来说，在AWS上托管任何静态网站都会遵循类似的基础设施模式。</p><p id="8864" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">将来，您可能希望在部署之前将测试阶段添加到您的管道中，进一步调整CDN等。希望这篇文章已经教了你足够的知识，让你开始在AWS上使用CI/CD和静态站点托管。</p></div></div>    
</body>
</html>