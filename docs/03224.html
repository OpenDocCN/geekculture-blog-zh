<html>
<head>
<title>SignUp Function with NodeJs and MongoDB(Final Version)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用NodeJs和MongoDB注册函数(最终版本)</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/signup-function-with-nodejs-and-mongodb-final-version-18caa017a3b?source=collection_archive---------34-----------------------#2021-06-03">https://medium.com/geekculture/signup-function-with-nodejs-and-mongodb-final-version-18caa017a3b?source=collection_archive---------34-----------------------#2021-06-03</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/df4b50b5de122810d943d2eb7791de77.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/0*RjyPJafJWZC57cKA.png"/></div></figure><p id="f7d1" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我写了这个函数和其他函数，但是在我写的时候这个项目还没有完成。所以，我完成了这个项目，并想解释如何去做。开始吧！</p><p id="ea70" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">首先，我们需要在MongoDB中创建一个数据库。为此，我们将使用模式。在这个项目中，我有三个数据库。我们将从用户模式开始。</p><p id="9772" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">为了创建一个模式，我们需要mongoose。然后我们就写这段代码行。</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="7293" class="jt ju hi jp b fi jv jw l jx jy">const UserSchema = <strong class="jp hj">new</strong> <em class="jz">mongoose</em>.Schema({})</span></pre><p id="a835" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在数据库中，我们有名称，电子邮件，密码，点，randomCode，登录，forgotCode，id，imageUrl和refreshToken。随机代码用于激活帐户，forgotCode用于重置密码，refreshToken用于进入帐户等其他页面。姓名，电子邮件和密码是必需的，我使用以下正则表达式检查电子邮件格式。</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="d5dc" class="jt ju hi jp b fi jv jw l jx jy">/^(([^&lt;&gt;()[\]\\.,;:\s@"]+(\.[^&lt;&gt;()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/</span></pre><p id="ec1a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在模式的结尾，我们将导出这样的模型:</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="5e60" class="jt ju hi jp b fi jv jw l jx jy"><em class="jz">module</em>.<em class="jz">exports</em> = <em class="jz">mongoose</em>.model('User', UserSchema);</span></pre><p id="797a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们将在其他页面中使用“用户”。我将创建一个名为controllers的文件夹，并在文件夹中创建一个名为auth.js的文件。Nodemailer用于向地址发送电子邮件。我们将为nodemailer创建一个名为transporter的变量。然后，我们将创建一个电子邮件地址，并将其用于nodemailer。</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="daf2" class="jt ju hi jp b fi jv jw l jx jy">var transporter = nodemailer.createTransport({</span><span id="281a" class="jt ju hi jp b fi ka jw l jx jy">service: 'hotmail',</span><span id="2758" class="jt ju hi jp b fi ka jw l jx jy">auth: {</span><span id="5ecc" class="jt ju hi jp b fi ka jw l jx jy">user: process.env.NODEMAILER_USER,  // in .env file</span><span id="a25b" class="jt ju hi jp b fi ka jw l jx jy">pass: process.env.NODEMAILER_PASS // in .env file</span><span id="c6c5" class="jt ju hi jp b fi ka jw l jx jy">}</span><span id="3759" class="jt ju hi jp b fi ka jw l jx jy">});</span></pre><p id="0c99" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在我们将创建异步寄存器函数。在这种情况下，我们将让一个令牌和6位数的随机数相等。</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="f07d" class="jt ju hi jp b fi jv jw l jx jy">let token = Math.floor(Math.random() * 999999);</span></pre><p id="5603" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">然后让refreshToken和定义const name，email和password等于req.body。req.body是请求的主体。之后，我们将创建一个名为data的变量。</p><p id="eb54" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在数据中，我们有from、to、subject和html部分。在html中，我发送我们创建的令牌。数据是这样的:</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="2304" class="jt ju hi jp b fi jv jw l jx jy">var data = {</span><span id="eae8" class="jt ju hi jp b fi ka jw l jx jy">from: process.env.NODEMAILER_USER,</span><span id="de1f" class="jt ju hi jp b fi ka jw l jx jy">to: email,</span><span id="3449" class="jt ju hi jp b fi ka jw l jx jy">subject: '',</span><span id="a35c" class="jt ju hi jp b fi ka jw l jx jy">html: `</span><span id="4862" class="jt ju hi jp b fi ka jw l jx jy">&lt;h1&gt;Hello ${name} ! Please copy token that sent.&lt;/h1&gt;</span><span id="2c88" class="jt ju hi jp b fi ka jw l jx jy">&lt;h1&gt;${token}&lt;/h1&gt;</span><span id="db78" class="jt ju hi jp b fi ka jw l jx jy">};</span></pre><p id="b492" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">然后，我们将控制用户是否存在给定的电子邮件，如果存在，我们将写:</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="1aaf" class="jt ju hi jp b fi jv jw l jx jy">const mailSucces = transporter.sendMail(data, async function (<em class="jz">error</em>, <em class="jz">info</em>) {}</span></pre><p id="ae21" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果有错误，我们将返回一个错误。否则，我们将像这样创建一个用户:</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="89ca" class="jt ju hi jp b fi jv jw l jx jy">const user = await User.create({</span><span id="8d60" class="jt ju hi jp b fi ka jw l jx jy">name,</span><span id="34eb" class="jt ju hi jp b fi ka jw l jx jy">email,</span><span id="345c" class="jt ju hi jp b fi ka jw l jx jy">password,</span><span id="4a37" class="jt ju hi jp b fi ka jw l jx jy">login: false,</span><span id="8560" class="jt ju hi jp b fi ka jw l jx jy">point: 0,</span><span id="4883" class="jt ju hi jp b fi ka jw l jx jy">randomCode: token,</span><span id="9870" class="jt ju hi jp b fi ka jw l jx jy">id: count,</span><span id="5b44" class="jt ju hi jp b fi ka jw l jx jy">refreshToken</span><span id="9e57" class="jt ju hi jp b fi ka jw l jx jy">});</span></pre><p id="d5cf" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们将定义rtoken并在用户模型中创建一个jwt令牌。代码在这里:</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="5840" class="jt ju hi jp b fi jv jw l jx jy">UserSchema.methods.getSignedJwtToken = function () {</span><span id="ba30" class="jt ju hi jp b fi ka jw l jx jy">return jwt.sign({ id: <em class="jz">this</em>._id }, process.env.JWT_SECRET, {</span><span id="a366" class="jt ju hi jp b fi ka jw l jx jy">expiresIn: "30d"</span><span id="dc4f" class="jt ju hi jp b fi ka jw l jx jy">})</span><span id="3f84" class="jt ju hi jp b fi ka jw l jx jy">};</span></pre><p id="eac6" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">有效期是30天，也就是token的销毁时间。</p><p id="3a4d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们将用户的refreshToken设置为rtoken，然后保存用户:</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="6b09" class="jt ju hi jp b fi jv jw l jx jy">const rtoken = user.getSignedJwtToken();</span><span id="e40f" class="jt ju hi jp b fi ka jw l jx jy">user.refreshToken = rtoken;</span><span id="2fce" class="jt ju hi jp b fi ka jw l jx jy">user.save()</span></pre><p id="56c1" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">最后，我们将返回一条消息并进行检查。</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="be75" class="jt ju hi jp b fi jv jw l jx jy">return <em class="jz">res</em>.json({</span><span id="e3e3" class="jt ju hi jp b fi ka jw l jx jy">message: "Email Gönderildi",</span><span id="df8a" class="jt ju hi jp b fi ka jw l jx jy">register: true,</span><span id="523e" class="jt ju hi jp b fi ka jw l jx jy">rtoken</span><span id="faa2" class="jt ju hi jp b fi ka jw l jx jy">});</span></pre><p id="dde9" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">就这样，我们将继续激活帐户。感谢阅读！</p></div></div>    
</body>
</html>