<html>
<head>
<title>Creating and deploying Express app to Lambda</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">创建Express应用程序并将其部署到Lambda</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/creating-and-deploying-express-app-to-lambda-811463ce7be2?source=collection_archive---------2-----------------------#2021-09-19">https://medium.com/geekculture/creating-and-deploying-express-app-to-lambda-811463ce7be2?source=collection_archive---------2-----------------------#2021-09-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="4124" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">大多数开发人员认为Lambda只是一个小函数。一个简单的句柄函数，在云中运行一些代码。但通常你需要的不止这些，比如几个不同的函数，或者一个完整的REST端点，幸运的是Lambda可以很好地运行它。虽然不建议将一个大的应用程序作为一个函数来运行，但这并不妨碍您创建和部署一个Lambda应用程序。</p><p id="38b0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">很多应用程序都是在ExpressJs框架上构建的。它简单而强大。它有许多为它编写的插件，对于任何以REST或<a class="ae jd" href="https://graphql.org/" rel="noopener ugc nofollow" target="_blank"> GraphQL </a>为端点的API来说，它都是一个很好的起点。</p><p id="ba5c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本教程中，我将展示如何创建一个完整的Express应用程序并将其部署到AWS Lambda。您将学习如何创建路由并在它们之间导航，设置一个简单的REST端点，最后与Bootstrap集成并提供静态内容。</p><p id="2d8a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本教程分为三个不同的部分:</p><ol class=""><li id="91df" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">创建ExpressJs应用程序</li><li id="67b3" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">配置AWS SAM</li><li id="17ec" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">配置API网关</li></ol><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es js"><img src="../Images/1148f94b69e67e34e6f246d1e5e97c65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O6UCMMNTOtmulKzM6HKe4g.png"/></div></div></figure><h2 id="9104" class="ke kf hi bd kg kh ki kj kk kl km kn ko iq kp kq kr iu ks kt ku iy kv kw kx ky bi translated">创建快速应用程序</h2><p id="e97c" class="pw-post-body-paragraph if ig hi ih b ii kz ik il im la io ip iq lb is it iu lc iw ix iy ld ja jb jc hb bi translated">让我们在一个名为“aws-app”的新文件夹中开始一个新项目。这将是根项目，因为我们将使用AWS SAM工具将应用程序部署到AWS，所以我们需要在“aws-app”中创建一个新文件夹，这将是我们的ExpressJs应用程序所在的位置。然后在内部运行“npm init -y”。现在您需要添加所需的包:expressjs、ejs、cors和serverless-http。<br/>` NPM I express ejs CORS server less-http`<br/>` NPM I node mon—save-dev `用于开发目的。</p><p id="23fa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本教程中，我不会试图解释所有关于Expressjs的东西，而是把重点放在正确的基础上。</p><pre class="jt ju jv jw fd le lf lg lh aw li bi"><span id="3d83" class="ke kf hi lf b fi lj lk l ll lm"><strong class="lf hj">app.<em class="ln">get</em>(“/”, getBasePath, (req, res) =&gt; {</strong></span><span id="cbed" class="ke kf hi lf b fi lo lk l ll lm"><strong class="lf hj">res.render(“index”, { title: “test”, page: req.basePath });</strong></span><span id="53fe" class="ke kf hi lf b fi lo lk l ll lm"><strong class="lf hj">});</strong></span></pre><p id="743c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建路线非常简单:</p><ol class=""><li id="206d" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">实例化express app:` const app = express()；`</li><li id="a4ed" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">使用你需要的http方法:<strong class="ih hj"> get、post、put、delete、head等</strong></li><li id="12b9" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">设置端点，可以是:'<strong class="ih hj"> / </strong>'，'/: <strong class="ih hj"> id </strong>'，'/ <strong class="ih hj"> new </strong>'等。</li></ol><p id="5f87" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来是用户，但是首先，我们需要组织一下，因为在同一个文件中有太多的路由可能会很混乱，所以对于用户来说，我们将使用一个快速路由器。快速路由器就像特定路由URL的微型应用程序。在我们的情况下'/用户'的路线:</p><ol class=""><li id="6144" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">在“用户”文件夹中创建一个名为users.js的单独文件</li><li id="4f05" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">实例化路由器:const router = express。路由器()；</li><li id="e771" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">就像一个快速应用程序一样，我们可以向它添加任意数量的路由</li><li id="ca33" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">另一个选项是创建一个路由，并将不同的方法链接到该路由:</li></ol><figure class="jt ju jv jw fd jx"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="6f6e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">ExpressJs的另一个特性是模板引擎的使用，在我们的例子中，我使用了<strong class="ih hj"> ejs </strong>，并使用这种格式呈现不同的页面。生成一个基本页面非常简单，你所要做的就是创建一个名为'<strong class="ih hj"> views </strong>'的新目录，然后创建`<strong class="ih hj"> users </strong>'文件夹，并在其中放入以下文件:</p><figure class="jt ju jv jw fd jx"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="d320" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以看到这与普通的HTML页面非常相似，但有一点需要注意:</p><pre class="jt ju jv jw fd le lf lg lh aw li bi"><span id="90de" class="ke kf hi lf b fi lj lk l ll lm">&lt;%= <strong class="lf hj">locals</strong>.page %&gt;</span></pre><p id="0e7b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在渲染时，中的内容将被替换为服务器发送的内容。<strong class="ih hj"> locals </strong>这是一个来自<strong class="ih hj"> ejs </strong>库的特殊对象，包含了我们传递给页面的所有对象，并且它总是被定义的。并且不发送自定义<strong class="ih hj">页面</strong>对象。并且不会抛出任何错误或警告。</p><p id="f720" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要将对象发送到页面，很简单，只需在模板旁边添加一个对象:</p><pre class="jt ju jv jw fd le lf lg lh aw li bi"><span id="6a0b" class="ke kf hi lf b fi lj lk l ll lm">router.get("/new", getBasePath, (<em class="ln">req</em>, <em class="ln">res</em>) =&gt; {<br/>   <em class="ln">res</em>.render("users/new", <strong class="lf hj">{<br/></strong>                      <strong class="lf hj">firstName</strong>: "post",<br/>                      <strong class="lf hj">basePath</strong>: <em class="ln">req</em>.basePath + "/home/users",<br/>   <strong class="lf hj">}</strong>);<br/>});</span></pre><p id="eae1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">ExpressJs中一个重要的关键特性是中间件功能的使用。中间件只不过是一个简单的带有一些参数(请求、响应、下一个)的JavaScript函数<br/>，最重要的是在<strong class="ih hj">进入</strong>你的代码之前被调用。在调用代码之前，您可以添加任意多的中间件函数。一个重要的警告是，您需要调用<strong class="ih hj"> next() </strong>来移动到下一个中间件函数<strong class="ih hj">。</strong> <br/>基本结构是:</p><figure class="jt ju jv jw fd jx"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="4df7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您需要传递任何信息，无论是身份验证还是关于请求的一些额外信息，都可以随意添加到请求对象中。这是将额外数据发送到下一个中间件或路由处理器的常用方式。</p><p id="ca81" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以在上面的例子中看到，我将<strong class="ih hj"> basePath </strong>信息添加到请求中，这样每个函数都可以使用它。</p><ul class=""><li id="36f2" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc lr jk jl jm bi translated">**额外提示:req.requestContext来自serverless-http包，当在Lambda中部署时，它为我们提供了有关events对象的额外信息。它给出了代表阶段的URL的最后一部分(例如生产、开发……)。</li></ul><p id="3521" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们把注意力集中在每个应用程序都必须拥有的静态资产上。这些资源可以是图像、样式、图标、字体或任何其他类型。使用ExpressJs服务任何静态资产非常简单，只需在我们的应用程序根目录下创建一个名为`<strong class="ih hj"> public </strong>的文件夹。</p><p id="dff9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要告诉express将请求传播到public内部的文件，我们只需编写:</p><pre class="jt ju jv jw fd le lf lg lh aw li bi"><span id="29a7" class="ke kf hi lf b fi lj lk l ll lm">app.use(express.static("public"));</span></pre><p id="d81a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，这将是一个没有显示REST端点的ExpressJs教程。在“users.js”文件中，我们可以看到我们已经定义了完整的CRUD，其中包含我们可以发送和接收数据的路由。在这种特殊情况下，我们使用Express Router，但是您也可以使用主要的ExpressJs函数来完成。下面是同样使用中间件<strong class="ih hj"> getBasePath </strong>的工作示例:</p><pre class="jt ju jv jw fd le lf lg lh aw li bi"><span id="f5ea" class="ke kf hi lf b fi lj lk l ll lm"><em class="ln">router</em>.route("/:id")<br/>.<strong class="lf hj"><em class="ln">get</em></strong>(getBasePath, (<em class="ln">req</em>, <em class="ln">res</em>) =&gt; {<br/>   <em class="ln"> const id = req.params.id;</em><br/><em class="ln">    res</em>.status(200).json({ user: { id } });<br/>})</span><span id="bfcd" class="ke kf hi lf b fi lo lk l ll lm">.<strong class="lf hj"><em class="ln">put</em></strong>(getBasePath, (<em class="ln">req</em>, <em class="ln">res</em>) =&gt; {<br/>    <em class="ln">const id = req.params.id;</em><br/>    <em class="ln">res</em>.status(200).json({ user: { id } });<br/>})</span><span id="2d93" class="ke kf hi lf b fi lo lk l ll lm">.<strong class="lf hj"><em class="ln">delete</em></strong>(getBasePath, (<em class="ln">req</em>, <em class="ln">res</em>) =&gt; {<br/>   <em class="ln"> const id = req.params.id;</em><br/>    <em class="ln">res</em>.status(200).json({ user: { id } });<br/>});</span></pre><ul class=""><li id="8eb5" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc lr jk jl jm bi translated">**为了处理发布请求，我们需要在主express应用程序中添加以下内容:</li></ul><pre class="jt ju jv jw fd le lf lg lh aw li bi"><span id="4a0a" class="ke kf hi lf b fi lj lk l ll lm">app.use(express.urlencoded({ extended: true }));<br/>app.use(express.json());<br/>app.use(cors());</span></pre><p id="65f1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们准备通过发送名称来创建一个新用户:</p><pre class="jt ju jv jw fd le lf lg lh aw li bi"><span id="be2b" class="ke kf hi lf b fi lj lk l ll lm">router.<strong class="lf hj">post</strong>("/", <em class="ln">getBasePath</em>, (<em class="ln">req</em>, <em class="ln">res</em>) =&gt; {<br/> <em class="ln">res</em>.status(200).json({ users: [{ id: 1, name: <strong class="lf hj"><em class="ln">req</em>.body.firstName </strong>}]      });<br/>});</span></pre><p id="b6d1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">完整Express应用程序的代码在GitHub库<a class="ae jd" href="https://github.com/BogdanNic/aws-lambda-docker/tree/express-app" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><h2 id="5389" class="ke kf hi bd kg kh ki kj kk kl km kn ko iq kp kq kr iu ks kt ku iy kv kw kx ky bi translated">设置AWS SAM</h2><p id="811f" class="pw-post-body-paragraph if ig hi ih b ii kz ik il im la io ip iq lb is it iu lc iw ix iy ld ja jb jc hb bi translated">我们将使用AWS SAM部署我们的应用程序。但是山姆是什么？</p><blockquote class="ls lt lu"><p id="7dfd" class="if ig ln ih b ii ij ik il im in io ip lv ir is it lw iv iw ix lx iz ja jb jc hb bi translated">AWS无服务器应用程序模型(SAM)是一个用于构建无服务器应用程序的开源框架。它提供了表达函数、API、数据库和事件源映射的简写语法。每个资源只有几行代码，您就可以定义您想要的应用程序，并使用YAML对其建模。在部署期间，SAM将SAM语法转换和扩展为AWS CloudFormation语法，使您能够更快地构建无服务器应用程序。</p></blockquote><p id="7407" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">基本上，它允许您非常容易地创建或更新资源，并且全部以可预测的方式从终端进行。</p><p id="6dd7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">***提示:即使使用从容器提供的，SAM CLI也会更新lambda。</p><p id="d8b1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我们需要创建一个Docker文件，并将它放在应用程序的其余部分旁边。</p></div><div class="ab cl ly lz gp ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="hb hc hd he hf"><figure class="jt ju jv jw fd jx"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="0148" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们现在需要转换我们的ExpressJs应用程序，以匹配Lambda所期望的，所以只是一个函数处理程序。为此，我们可以使用优秀的包provide <strong class="ih hj"> serverless-http </strong>来包装它。</p><figure class="jt ju jv jw fd jx"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="1525" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们需要额外的mime类型来允许我们提供图像和其他文件。如果您只想返回JSON格式，就不必添加mime类型。</p><p id="f08b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们首先需要安装AWS提供的几个免费工具:</p><ol class=""><li id="f577" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">适当用户的AWS CLI(关于AWS CLI的更多信息<a class="ae jd" rel="noopener" href="/@bogdan_nic100/setup-a-lambda-function-using-docker-72356e0a4f13">请点击这里</a></li><li id="9be2" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">来自<a class="ae jd" href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html" rel="noopener ugc nofollow" target="_blank">的AWS SAM在这里</a></li><li id="fe93" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">创建SAM的配置并将其添加到项目的主根目录。</li></ol><figure class="jt ju jv jw fd jx er es paragraph-image"><div class="er es mf"><img src="../Images/56fd396c0b8bb406916ff3c5fcc56b06.png" data-original-src="https://miro.medium.com/v2/resize:fit:510/format:webp/1*A83D6DBO1alIwCXtUv4p0A.png"/></div><figcaption class="mg mh et er es mi mj bd b be z dx">The structure of the project</figcaption></figure><p id="2dd2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就像我们对lambda所做的一样，我们必须包装我们的ExpressJs应用程序。将模板<strong class="ih hj">放在app文件夹的</strong>外，如图所示。</p><p id="4e0a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">SAM模板基本上是一个YAML文件，它允许我们配置函数名称、类型、内存，还创建API网关端点以及必要的角色和权限。</p><figure class="jt ju jv jw fd jx"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="918b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从模板中，您可以看到我们正在使用我们之前创建的Docker文件，以及它的位置“<strong class="ih hj">my-app”,</strong>最后的值只是让我们知道什么是应用程序的URL。</p><p id="72c5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">部署时，SAM会问你几个问题，比如容器注册表的位置在哪里(如果你像我一样使用Docker文件)。并且它创建了<strong class="ih hj"> samconfig </strong>。toml在成功部署后自动运行。</p><p id="5973" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有时，SAM无法部署应用程序，也无法创建文件，或者更糟的是，它创建了错误的数据。我不喜欢调试配置，所以我事先提供了一个。</p><figure class="jt ju jv jw fd jx"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="b510" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们需要将&lt;&gt;替换为真实的数据，如账户和地区。现在让我们创建一个存储桶:</p><pre class="jt ju jv jw fd le lf lg lh aw li bi"><span id="3890" class="ke kf hi lf b fi lj lk l ll lm">aws s3api create-bucket --bucket my-bucket-&lt;<strong class="lf hj">Random</strong>&gt; --region <strong class="lf hj">&lt;region&gt;</strong> --create-bucket-configuration LocationConstraint=<strong class="lf hj">&lt;region&gt;</strong></span></pre><ul class=""><li id="ca3b" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc lr jk jl jm bi translated">**提示:在名称中添加一些随机字符，因为它在整个s3中必须是唯一的。并设置区域。并将该名称放入samconfig.toml中。</li></ul><p id="d5cc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在ECR中创建存储库:</p><pre class="jt ju jv jw fd le lf lg lh aw li bi"><span id="e086" class="ke kf hi lf b fi lj lk l ll lm">aws ecr create-repository --repository-name hello-world</span></pre><p id="44a7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">完成所有这些后，我们准备将我们的功能部署到Lambda，但首先，我们必须构建它，然后部署它:</p><pre class="jt ju jv jw fd le lf lg lh aw li bi"><span id="58c5" class="ke kf hi lf b fi lj lk l ll lm">sam build<br/>sam deploy</span></pre><p id="8f60" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">重要的SAM命令:</p><ol class=""><li id="0f46" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">首先，需要构建函数<code class="du mk ml mm lf b">sam build</code></li><li id="e842" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">可选调用<code class="du mk ml mm lf b">sam validate</code>来验证模板</li></ol><p id="76ed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.本地测试<code class="du mk ml mm lf b">sam local invoke</code>或<code class="du mk ml mm lf b">sam local start-api</code></p><p id="666c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.最后通过运行<code class="du mk ml mm lf b">sam deploy</code>将函数发送到云端</p><p id="f1e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">5.使用<code class="du mk ml mm lf b">sam logs -n HelloWorldFunction — stack-name &lt;stack_app&gt; — tail</code>查看日志</p><p id="0372" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行sam构建的映像<code class="du mk ml mm lf b">docker run -p 9000:8080 helloworldfunction:rapid-1.30.0</code></p><h2 id="20f1" class="ke kf hi bd kg kh ki kj kk kl km kn ko iq kp kq kr iu ks kt ku iy kv kw kx ky bi translated">配置API网关</h2><p id="3ec4" class="pw-post-body-paragraph if ig hi ih b ii kz ik il im la io ip iq lb is it iu lc iw ix iy ld ja jb jc hb bi translated">现在我们应该有一个用于prod的API网关端点。如果我们转到该链接，它会显示一条JSON消息，文本为:Missing Authentication Token。</p><p id="24d0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">发生了什么事？让我们到API Gateway检查一下，在SAM配置中，我们添加了一个代理，允许所有方法映射到一个简单的函数处理程序。</p><p id="3cbb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">看这张图片，你应该看到类似的东西:</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div class="er es mn"><img src="../Images/1335e253fdf9f27a2a3e59554e0bedb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:424/format:webp/1*-tU1d5awovJMz72_BPDmFg.png"/></div></figure><p id="f4e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第一个“/”表示根端点，我们在这里没有任何集成。</p><p id="cc30" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">遗憾的是，SAM无法在此添加新资源，因此我们将手动更改它。但是当你重新部署的时候问题就出现了。</p><p id="5beb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">解决这个问题的最好方法是创建一个新的API网关端点。因为只有一次，所以让我们使用AWS网站来创建它。登录后导航到API网关。</p><ol class=""><li id="8a55" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">点击顶部的<strong class="ih hj">创建API </strong>按钮</li><li id="60d6" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">在<strong class="ih hj">中选择API </strong>类型:选择<strong class="ih hj"> REST API </strong>卡，点击<strong class="ih hj"> Build </strong></li><li id="ea18" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">为其命名:sam-test，然后单击create</li><li id="702c" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">现在我们看到空资源只是一个“/”</li><li id="4a5b" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">点击<strong class="ih hj">动作</strong>下拉菜单，然后选择<strong class="ih hj">创建方法</strong></li><li id="bde2" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">选择<strong class="ih hj">任意</strong>方法</li><li id="8c16" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">将Lambda Integration设置为true并选择您的地区，然后在<strong class="ih hj"> Lambda函数</strong>中选择我们的函数</li><li id="bcda" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">批准出现的关于权限的模式</li><li id="e7e0" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">点击“任何”方法，然后点击<strong class="ih hj">动作</strong>下拉列表，然后选择<strong class="ih hj">创建资源</strong></li><li id="a04d" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">点击<strong class="ih hj">配置为代理资源</strong>，然后创建资源</li><li id="b7d7" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">将Lambda Integration设置为true并选择您的地区，然后在<strong class="ih hj"> Lambda函数中选择我们的函数。</strong></li></ol><p id="8f1a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">完成设置后，您应该会看到如下所示的资源树:</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div class="er es mo"><img src="../Images/79a9bede570c10172263fe7300aa375c.png" data-original-src="https://miro.medium.com/v2/resize:fit:420/format:webp/1*gx4E6fgaqDLEvx7C9mvM7A.png"/></div></figure><p id="bf24" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你点击任何一个<strong class="ih hj">或者任何一个</strong>方法，你应该会看到lambda集成。</p><p id="6334" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们设置媒体类型，因为我们正在发送图像和文本。在中，导航至左侧的设置。向下滚动，直到找到二进制媒体类型</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div class="er es mp"><img src="../Images/a150ed248aed080f4c591dac66bfcd91.png" data-original-src="https://miro.medium.com/v2/resize:fit:756/format:webp/1*5qvsHIpSN28YoNFGC5R9AA.png"/></div></figure><p id="e02c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">并添加以下类型:</p><ul class=""><li id="7f4a" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc lr jk jl jm bi translated">图片/png</li><li id="050c" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc lr jk jl jm bi translated">图像/*</li><li id="b48a" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc lr jk jl jm bi">*/*</li><li id="36aa" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc lr jk jl jm bi translated">文本/css</li></ul><p id="a8aa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要查看它的运行情况，我们必须部署API。使用操作下拉菜单列表选择<strong class="ih hj">部署API。</strong>为名为dev的实例创建一个阶段，并单击<strong class="ih hj">将</strong>部署到dev。</p><p id="de48" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最好的事情是，如果我们改变或更新lambda函数，它将自动更新API以使用新版本。</p><p id="ddf3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要删除应用程序并释放AWS使用的所有资源，请在您的终端中编写以下命令:<code class="du mk ml mm lf b">aws cloudformation delete-stack — stack-name &lt;stack_app&gt;</code></p><p id="8802" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">完整的代码可以在GitHub <a class="ae jd" href="https://github.com/BogdanNic/aws-lambda-docker/tree/express-app" rel="noopener ugc nofollow" target="_blank">这里</a>找到。我还做了一个关于Lambda与自定义Docker映像集成的教程。</p><p id="dd0d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你对更多的教程感兴趣，请订阅并鼓掌！</p><h2 id="063d" class="ke kf hi bd kg kh ki kj kk kl km kn ko iq kp kq kr iu ks kt ku iy kv kw kx ky bi translated">助手链接:</h2><ol class=""><li id="eb4b" class="je jf hi ih b ii kz im la iq mq iu mr iy ms jc jj jk jl jm bi translated">AWS CLI配置指南:<a class="ae jd" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-quickstart.html#cli-configure-quickstart-creds" rel="noopener ugc nofollow" target="_blank">此处</a></li><li id="f83a" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">AWS SAM指南<a class="ae jd" href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-getting-started-hello-world.html" rel="noopener ugc nofollow" target="_blank">此处</a></li><li id="0ffa" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">创建S3铲斗的指南<a class="ae jd" href="https://awscli.amazonaws.com/v2/documentation/api/latest/reference/s3api/create-bucket.html" rel="noopener ugc nofollow" target="_blank">此处</a></li></ol></div></div>    
</body>
</html>