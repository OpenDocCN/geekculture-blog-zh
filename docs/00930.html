<html>
<head>
<title>Enabling Microservices Architecture: Synchronous Communication</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">启用微服务架构:同步通信</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/enabling-microservices-architecture-synchronous-communication-8093a42481ec?source=collection_archive---------3-----------------------#2021-03-20">https://medium.com/geekculture/enabling-microservices-architecture-synchronous-communication-8093a42481ec?source=collection_archive---------3-----------------------#2021-03-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="3269" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">如何利用Django的rest框架接口实现微服务同步协调？</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/bd9640c3679a599fd8df17d05a38177f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*00_HpANWCkRAfk81"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Michael Alfonso, Unsplash</figcaption></figure><p id="45ec" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">分离的服务，由业务能力驱动并独立部署。当然，我们谈论的是微服务。它们是当今最流行的架构风格，尤其是对于云原生应用程序。然而，在这个主题上积累的所有知识并没有使它变得不那么复杂或更容易实现。</p><p id="c6be" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">从一开始就使用微服务来发展系统的决定是一个重大的决定，任何打算走这条路的人无疑都将面临本末倒置的风险——在真正获得好处之前产生太多的开销。</p><p id="7ee3" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">根据定义，每个微服务都是一个更大的东西的一部分，只有通过有效的协调才能使努力取得成果——就像芭蕾舞演员跳舞一样。那么，为什么Reveal从一开始就采用这种架构，我们又是通过什么方式实现的呢？</p><h1 id="4856" class="kj kk hi bd kl km kn ko kp kq kr ks kt io ku ip kv ir kw is kx iu ky iv kz la bi translated">微服务对快速启动的优势</h1><p id="9a31" class="pw-post-body-paragraph jn jo hi jp b jq lb ij js jt lc im jv jw ld jy jz ka le kc kd ke lf kg kh ki hb bi translated">因为这个话题已经被广泛讨论，所以没有必要列出所有微服务的方法和优势。对于任何一个遵循其原则的人来说，他们应该真正看看架构在内心意味着什么，例如，正如著名的敏捷布道者马丁·福勒所说的<a class="ae lg" href="https://martinfowler.com/articles/microservices.html" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="ff09" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">不过，我们将强调一个被称为<strong class="jp hj">进化设计</strong>的好处:</p><p id="4c1d" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated"><em class="lh">“微服务从业者[…]将服务分解视为进一步的工具，使应用程序开发人员能够控制应用程序的变化，而不会减缓变化。”</em></p><p id="e22d" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated"><strong class="jp hj">马丁福勒</strong></p><p id="8b78" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">“控制”一词的准确使用绝非偶然。这并不意味着或暗示减少变更——无论是在范围上还是频率上——而是说，只要你保持正确的态度，它们可以是快速的、频繁的和风险较小的。</p><p id="2447" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">换句话说，我们承认，对于一家成功的初创公司来说，它需要不断调整自己的道路——转向它认为合适的新方向，完全知道这将再次发生。更重要的是，我们需要我们的代码足够解耦，以便大部分代码在一次转换后被完全删除，就像我们过去对两个不同的微服务所做的那样。我们在Reveal建立了我们的系统。</p><h1 id="d330" class="kj kk hi bd kl km kn ko kp kq kr ks kt io ku ip kv ir kw is kx iu ky iv kz la bi translated">微服务的复杂性和开销</h1><p id="9f72" class="pw-post-body-paragraph jn jo hi jp b jq lb ij js jt lc im jv jw ld jy jz ka le kc kd ke lf kg kh ki hb bi translated">听起来熟悉吗？</p><p id="9667" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">"我期望数据是那种格式，但是这一个不适合！"</p><p id="7263" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">该请求产生了N+1个查询；这就是我们的应用程序宕机的原因。”</p><p id="8ecf" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">“缓存还能用吗？”</p><p id="aab1" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">“我们如何在这个微服务领域为一家公司寻找合作伙伴？”</p><ul class=""><li id="3303" class="li lj hi jp b jq jr jt ju jw lk ka ll ke lm ki ln lo lp lq bi translated"><strong class="jp hj">开发人员使用微服务</strong></li></ul><p id="f64e" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">尽管这些引语有些夸张，但对于在这片海域航行的人来说，它们并不少见。我们知道我们需要构建满足我们发展需求的工具。</p><p id="ca5c" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">尽管Reveal的开发人员主要使用Django和PostgreSQL，但最终目标是构建能够简化处理不同堆栈的工具——毕竟，为每个场景选择最佳方案是这种架构的优势之一。除此之外，我们的目标是:</p><ul class=""><li id="4f6e" class="li lj hi jp b jq jr jt ju jw lk ka ll ke lm ki ln lo lp lq bi translated">序列化的共享约定</li><li id="a6ba" class="li lj hi jp b jq lr jt ls jw lt ka lu ke lv ki ln lo lp lq bi translated">懒惰评估</li><li id="ca75" class="li lj hi jp b jq lr jt ls jw lt ka lu ke lv ki ln lo lp lq bi translated">高效缓存</li><li id="c747" class="li lj hi jp b jq lr jt ls jw lt ka lu ke lv ki ln lo lp lq bi translated">标准接口</li></ul><h1 id="8c22" class="kj kk hi bd kl km kn ko kp kq kr ks kt io ku ip kv ir kw is kx iu ky iv kz la bi translated">JSON API</h1><p id="370c" class="pw-post-body-paragraph jn jo hi jp b jq lb ij js jt lc im jv jw ld jy jz ka le kc kd ke lf kg kh ki hb bi translated">开发良好的微服务开发体验的一个关键主题是必须有定义良好的、一致的API。这不仅对后端有帮助，对单页面应用程序也有帮助。一般来说，一致的API将降低代码库的复杂性，以及外部用户在不了解底层系统的情况下使用代码库的复杂性。</p><p id="b43d" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">这就是为什么我们决定挑选一个标准规范，成为我们所有API的基础:<strong class="jp hj">JSON:API</strong>(【https://jsonapi.org】T2)。除了开源之外，它还包括一些强大的概念，如关系包含、标准分页和标准过滤。</p><p id="bf97" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">当然，保持高标准的规范并不意味着开发人员在实现变更时很容易跟踪它。我们需要一种无缝的方式来实施它并支持它的使用。</p><p id="6280" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">为了做到这一点，我们构建了一个内部库，它规定了同步通信如何在我们的服务之间工作，并且——除非用审视的眼光来看待——甚至可能让您感觉像是在一个大的单片应用程序中编码。实现这一点的秘诀是将这个规范与我们开发人员最常用的接口结合起来。</p><h1 id="6dc9" class="kj kk hi bd kl km kn ko kp kq kr ks kt io ku ip kv ir kw is kx iu ky iv kz la bi translated">使用其他微服务的模型</h1><p id="28ef" class="pw-post-body-paragraph jn jo hi jp b jq lb ij js jt lc im jv jw ld jy jz ka le kc kd ke lf kg kh ki hb bi translated">如果您熟悉Django，您可能会认为这一行代码是获取所有公司的一种方式:</p><p id="3070" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">Company.objects.all()</p><p id="25af" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">如果您从一个微服务中请求一个公司列表，而这个微服务的数据库中没有这些公司，那么您需要通过HTTP请求来请求负责的服务。在这样做的时候，要注意应用程序在与其他应用程序通信时可能面临的各种问题，比如请求超时时重试或者解析传入的数据。</p><p id="eab5" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">使用我们的内部库，所有这些都是通过完全相同的行来完成的。</p><p id="b8e1" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">为了理解潜在的魔力，让我们来看看Django模型的一个简单定义:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="lw lx l"/></div><figcaption class="jj jk et er es jl jm bd b be z dx">Example of Django model definition</figcaption></figure><p id="d4bb" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">如果你想将这个模型暴露给另一个微服务，你不应该使用这个定义，而应该使用我们内部库中的JSONAPIModel的定义，所有微服务都可以访问这个定义:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="lw lx l"/></div><figcaption class="jj jk et er es jl jm bd b be z dx">Example of django-json-api model definition</figcaption></figure><p id="a08c" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">JSONAPIModel在属性对象中包含一个JSONAPIManager，它将负责将一个查询——就像您使用Django的ORM编写它一样——转换成一个HTTP请求。Meta的内容足以识别请求的URL，并且通过在JSONAPIMeta中查找模型定义中的资源名称来获取正确的模型。</p><p id="f44e" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">然后，开发人员必须明确说明暴露了模型的哪些属性:有了这个定义，当一个公司被删除时，它就不会受到其他微服务的影响。</p><p id="d9ab" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">最后，不需要指定如何发送数据或解析传入的JSON。所有这些都是自动处理的——遵循JSON:API的规范——结果是一个行为很像Django模型的对象。您可以更新属性、保存属性等。</p><p id="bfee" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">事实上，由于微服务内部和外部的实体都被序列化为相同的，所以我们的API的任何消费者——例如，我们的web应用程序——将会看到看起来相同的格式化数据，不管它来自哪里。</p><h1 id="0132" class="kj kk hi bd kl km kn ko kp kq kr ks kt io ku ip kv ir kw is kx iu ky iv kz la bi translated">存储和操作与其他微服务中的实体的关系</h1><p id="bc07" class="pw-post-body-paragraph jn jo hi jp b jq lb ij js jt lc im jv jw ld jy jz ka le kc kd ke lf kg kh ki hb bi translated">如果一个公司与创建它的用户有关系，但用户模型驻留在另一个微服务中，会怎样？在其数据库中保存模型的人如何获取这种关系？</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="lw lx l"/></div></figure><p id="1d57" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">在Django.db.Model公司上重新定义“objects”管理器将为系统提供预取相关JSONAPIModel的能力，经历与上一节所述类似的过程。</p><p id="43a2" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">因为RelatedJSONAPIField扩展了IntegerField，所以关系通常按原样存储，在一个列中保存相关记录的主键。处理完请求后，访问该属性会用JSONAPIModel对象填充它，或者您也可以为整个查询集预取它，就像Django的ORM一样。</p><h1 id="ffaf" class="kj kk hi bd kl km kn ko kp kq kr ks kt io ku ip kv ir kw is kx iu ky iv kz la bi translated">性能考虑和缓存</h1><p id="2966" class="pw-post-body-paragraph jn jo hi jp b jq lb ij js jt lc im jv jw ld jy jz ka le kc kd ke lf kg kh ki hb bi translated">乍一看，JSON: API规范主要影响响应的格式，这是一种标准的做事方式，允许通用的工具并消除了bikeshedding情况，但它有性能优势。</p><p id="769c" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">根据构造，数据更改影响的资源更少。因此，当它发生时，无效的缓存更少。此外，因为资源是在具有相同序列化协议的微服务之间共享的，所以我们现在可以从集中式缓存中受益。</p><p id="3799" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">就像Django指定的那样，我们的库遵循一个执行过程来使用现有的缓存并获取缺失的记录。只产生精确所需的请求数量。如果被要求，它也将遵循递归关系，即使它们位于不同的数据库中。您还可以通过使用带有快速查找的智能预取来避开N+1个查询。</p><p id="ea55" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">我猜微服务之间的交流根本不必复杂。</p><h1 id="d277" class="kj kk hi bd kl km kn ko kp kq kr ks kt io ku ip kv ir kw is kx iu ky iv kz la bi translated">我们的内部库是开源的。</h1><p id="f92e" class="pw-post-body-paragraph jn jo hi jp b jq lb ij js jt lc im jv jw ld jy jz ka le kc kd ke lf kg kh ki hb bi translated">在Reveal，我们相信插入我们的解决方案所需的工作已经取得了回报。这种标准化得益于一致的行为、快速的入职、较少的冗余，以及最终加快的开发速度。</p><p id="ef79" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">如果这些让你兴奋的话，请知道我们是作为一个开源项目推出这个内部库的。尽管它还远非完美，但我们确信许多人能像我们一样从中受益。看一看:</p><p id="d2af" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">https://github.com/share-work/django-json-api/</p><p id="97d5" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated"><a class="ae lg" href="https://pypi.org/project/django-json-api/" rel="noopener ugc nofollow" target="_blank">https://pypi.org/project/django-json-api/</a></p><p id="c935" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">这只是冰山一角。我们正在打造一个非常复杂和强大的产品，这需要付出很多努力。如果你有兴趣从我们的经验中学习更多，请跟随我们，如果你想与我们一起解决各种问题，我们正在招聘！</p></div></div>    
</body>
</html>