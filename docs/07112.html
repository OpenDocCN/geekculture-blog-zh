<html>
<head>
<title>How to integrate Slack Notification with CircleCI Pipelines.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何将松弛通知与CircleCI管道集成？</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/custom-slack-notification-with-circleci-workflow-9f42d9b767d2?source=collection_archive---------5-----------------------#2021-09-08">https://medium.com/geekculture/custom-slack-notification-with-circleci-workflow-9f42d9b767d2?source=collection_archive---------5-----------------------#2021-09-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/3b9710627a1be155b2cf725b2d731ad2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*sNTI7HsXu1u2QJ9j"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">Photo by <a class="ae hv" href="https://unsplash.com/@sigmund?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Sigmund</a> on <a class="ae hv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><div class=""/><div class=""><h2 id="ee25" class="pw-subtitle-paragraph iv hx hy bd b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm dx translated">轻松实现与CircleCI的松散通知集成，支持更好的开发。</h2></div><p id="f903" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">在<a class="ae hv" rel="noopener" href="/geekculture/make-a-slack-app-for-your-slack-channel-95d3a30d2f8e">的前一篇文章</a>中，我写了关于Slack Incoming Webhook的文章，它向你指定的频道发布一个定制的通知。在本文中，我想向您展示如何用不同的方式发布一个时差通知，用CircleCI现代持续集成和持续交付(CI/CD)平台。</p><p id="3608" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">您可以用shell脚本创建一个程序，只在部署成功或失败时自动发送Slack通知，但为什么要用CircleCI呢？这是因为无需编写shell脚本，CircleIC就能提供这种功能和许多内置功能，你可以从所谓的<strong class="jp hz"> Orb </strong>中使用这些功能。</p><blockquote class="kj"><p id="0fe7" class="kk kl hy bd km kn ko kp kq kr ks ki dx translated">Orb是一个可重用的YAML配置包，它将重复的配置压缩成一行代码。</p></blockquote><p id="7595" class="pw-post-body-paragraph jn jo hy jp b jq kt iz js jt ku jc jv jw kv jy jz ka kw kc kd ke kx kg kh ki hb bi translated">可重用的代码片段帮助您自动化重复的过程，加快项目设置，并使其易于与第三方工具集成。</p></div><div class="ab cl ky kz gp la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="hb hc hd he hf"><h1 id="d1e0" class="lf lg hy bd lh li lj lk ll lm ln lo lp je lq jf lr jh ls ji lt jk lu jl lv lw bi translated">综合</h1><blockquote class="lx ly lz"><p id="f56c" class="jn jo ma jp b jq jr iz js jt ju jc jv mb jx jy jz mc kb kc kd md kf kg kh ki hb bi translated">如果你只是想要完整的源代码，请向下滚动:)</p></blockquote><h2 id="d394" class="me lg hy bd lh mf mg mh ll mi mj mk lp jw ml mm lr ka mn mo lt ke mp mq lv mr bi translated">设置</h2><p id="bf3b" class="pw-post-body-paragraph jn jo hy jp b jq ms iz js jt mt jc jv jw mu jy jz ka mv kc kd ke mw kg kh ki hb bi translated">首先，让我们给你的Slack应用一些从外部服务访问的权限。如果您还没有创建，您可以从这个<a class="ae hv" href="https://api.slack.com/apps" rel="noopener ugc nofollow" target="_blank">页面</a>创建一个。创建Slack应用程序后，转到应用程序的基本信息页面。您需要添加范围。</p><p id="d328" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">从<strong class="jp hz">功能</strong>部分，点击OAuth &amp;权限按钮。</p><figure class="my mz na nb fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mx"><img src="../Images/dfdcff276eefea9e0315bb13e847fed4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2MYGrkSTrSSxTmHCurMRWQ.png"/></div></div></figure><p id="c7e9" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">请从<strong class="jp hz">添加OAuth范围</strong>按钮添加这三个范围。</p><ol class=""><li id="339c" class="nc nd hy jp b jq jr jt ju jw ne ka nf ke ng ki nh ni nj nk bi translated">聊天:写作</li><li id="73d8" class="nc nd hy jp b jq nl jt nm jw nn ka no ke np ki nh ni nj nk bi translated">聊天:写:公开</li><li id="e3de" class="nc nd hy jp b jq nl jt nm jw nn ka no ke np ki nh ni nj nk bi translated">文件:写入</li></ol><p id="9e30" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">底部的传入webhook作用域在这里是不需要的，但是如果你想让你的应用程序使用传入Webhooks和CircleCi，那么应该启用它。</p><figure class="my mz na nb fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es nq"><img src="../Images/f112a220e9709ced936389734aaaef18.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VrPw3PyDnGTJKr5X3CZXVg.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">Add appropriate scopes</figcaption></figure><p id="8de0" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">启用webhook后，此作用域应该会自动添加到这里。</p><figure class="my mz na nb fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es nr"><img src="../Images/70496622e81b86b5aedf07e1c977aaee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ewrKSf5E5IX9W5PuXCPAQA.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">Enabling Incoming Webhook</figcaption></figure><p id="d89e" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">添加这些范围后，转到CircleCI项目设置页面。在左下方的<strong class="jp hz">环境变量</strong>中，添加两个变量；松弛访问令牌和通道id。分别调用它们<strong class="jp hz"> SLACK_ACCESS_TOKEN </strong>和<strong class="jp hz"> SLACK_DEFAULT_CHANNEL </strong>，<em class="ma">否则CircleCI不识别它们。请仔细检查你是否拼写正确。</em></p><figure class="my mz na nb fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ns"><img src="../Images/9fe8d5746e3dc2c4fc2c43c9064ebc28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0mWIf-vln3QHSuZVpXdlEw.png"/></div></div></figure><p id="7fb3" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated"><em class="ma"> SLACK_ACCESS_TOKEN </em>是一个以<code class="du nt nu nv nw b">xoxb-</code>开头的令牌，可以从我们之前看到的OAuth &amp;权限页面中找到。复制<strong class="jp hz"> Bot用户OAuth令牌</strong>并将其放入SLACK_ACCESS_TOKEN。</p><p id="aa8a" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated"><em class="ma"> SLACK_DEFAULT_CHANNEL </em>是一个Slack channel id，链接到您希望CircleCI发布通知的频道。当您右键单击Slack中的频道时，您可以<strong class="jp hz">复制链接。</strong>链接是这样的；https://$ {项目名称} . slack . com/archives/$ {频道id}。通道以C开头，因此复制它并将其放入SLACK_DEFAULT_CHANNEL。</p><p id="4431" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">很好，现在你完成了CircleCI的设置。</p><h2 id="711f" class="me lg hy bd lh mf mg mh ll mi mj mk lp jw ml mm lr ka mn mo lt ke mp mq lv mr bi translated">CircleCI开发</h2><p id="59aa" class="pw-post-body-paragraph jn jo hy jp b jq ms iz js jt mt jc jv jw mu jy jz ka mv kc kd ke mw kg kh ki hb bi translated">这个文件在名为. circleci的文件夹下创建为config.yml。</p><figure class="my mz na nb fd hk"><div class="bz dy l di"><div class="nx ny l"/></div></figure><p id="74af" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">让我们来看看每个步骤，让我将文件分成5个块。</p><figure class="my mz na nb fd hk"><div class="bz dy l di"><div class="nx ny l"/></div></figure><p id="9d2b" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">这意味着我们在4.3.0版中使用slack orb。正如我在本文第一部分中解释的，orb是YAML配置的可重用包。一行导入许多松弛特性。<code class="du nt nu nv nw b">circleci/slack@4.3.0</code>在文件中可以作为<code class="du nt nu nv nw b">slack</code>访问</p><p id="c736" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">接下来，我们来看看命令。正如该部分的标题所示，您可以在这里创建命令，这样您就可以通过在jobs部分指定命令名来运行它们，我们稍后将对此进行研究。</p><p id="77d2" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">这里，我们有两个命令，叫做notify_slack_error和notify_slack_pass。第一个命令在部署失败时触发，第二个命令在部署成功时触发。在这里，我们使用通知特性作为上面声明的<code class="du nt nu nv nw b">slack</code>的<code class="du nt nu nv nw b">slack/notify</code>。</p><figure class="my mz na nb fd hk"><div class="bz dy l di"><div class="nx ny l"/></div></figure><p id="068d" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">CircleCI提供了一个叫做<code class="du nt nu nv nw b">template</code>的便捷工具。只需指定模板名称，就可以轻松创建松弛通知UI。如果你想创建一个自定义的时差通知用户界面，是的，你可以。</p><div class="my mz na nb fd ab cb"><figure class="nz hk oa ob oc od oe paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><img src="../Images/d2045bbd0cb631c66d46327ab99c448f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1062/format:webp/1*bn1ejYh-hOBnnwB6i-ByKg.png"/></div></figure><figure class="nz hk of ob oc od oe paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><img src="../Images/8c497baab0ab4ee724828f596f4cbe01.png" data-original-src="https://miro.medium.com/v2/resize:fit:940/format:webp/1*_cBnFqweSdmudL6HC1nAdQ.png"/></div></figure></div><p id="ca15" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">正如我们在我的<a class="ae hv" rel="noopener" href="/geekculture/make-a-slack-app-for-your-slack-channel-95d3a30d2f8e">上一篇文章</a>中了解到的如何定制消息传递，您可以使用<code class="du nt nu nv nw b">custom</code>字段对<a class="ae hv" href="https://api.slack.com/reference/messaging/payload" rel="noopener ugc nofollow" target="_blank">消息有效负载</a>进行编程。例如，我们可以这样写来创建一个自定义的UI通知；</p><figure class="my mz na nb fd hk"><div class="bz dy l di"><div class="nx ny l"/></div></figure><p id="75a7" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">更多技术细节，请查看CircleCI的<a class="ae hv" href="https://circleci.com/developer/ja/orbs/orb/circleci/slack" rel="noopener ugc nofollow" target="_blank">页面</a>。</p><p id="edfe" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">接下来，让我们定义工作。它有一项名为部署的工作。它使用docker映像，因为它需要在执行中运行node.js。这里设置为中等，但你可以付费增加音量。</p><p id="f6bf" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">步骤由可运行脚本组成，每个步骤都有一个命令及其名称。正如我们在上面的命令部分中看到的，我们有两个自定义命令，称为notify_slack_error <strong class="jp hz"> </strong>和notify_slack_pass <strong class="jp hz">。</strong>这些命令在其他步骤运行后执行。</p><p id="060e" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">如果作业不成功，事件变为<code class="du nt nu nv nw b">fail</code>，这意味着仅触发notify_slack_error。相反，如果作业中没有错误，则忽略notify_slack_error并调用notify_slack_pass。就是因为事件变成了<code class="du nt nu nv nw b">pass</code>。如果你想一直触发，你也可以设置<code class="du nt nu nv nw b">always</code>。</p><figure class="my mz na nb fd hk"><div class="bz dy l di"><div class="nx ny l"/></div></figure><p id="4c69" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">最后，我们来看看工作流程。它有一个名为Firebase_Build_Deploy的工作流。我做了一个叫做部署的工作。我希望CircleCi只在开发部门有新的推动时才运行它。您可以通过这种方式添加过滤器来实现。</p><figure class="my mz na nb fd hk"><div class="bz dy l di"><div class="nx ny l"/></div></figure><p id="0621" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">如果我解释的所有内容都被正确集成，您应该会在下面看到相同的结果。</p><figure class="my mz na nb fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es og"><img src="../Images/9c153eee4db5bde6dc4f1a5db5bae1cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iP8nFlx4e-KrnMqcDBlrXQ.png"/></div></div></figure><h1 id="cd7c" class="lf lg hy bd lh li oh lk ll lm oi lo lp je oj jf lr jh ok ji lt jk ol jl lv lw bi translated">结束语</h1><p id="0d04" class="pw-post-body-paragraph jn jo hy jp b jq ms iz js jt mt jc jv jw mu jy jz ka mv kc kd ke mw kg kh ki hb bi translated">在我最近的项目中，我研究了Github Actions、云构建和CircleCI，以便在我们的项目中集成CI/CD，我最初想写一篇关于比较的文章，但因为我们决定集成CircleCI，我需要开发它，所以我写了我对实现的学习。</p><p id="fb85" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">随着CircleCI的采用，我们的项目环境变得更好了，我很喜欢它:)将来，也许我会再写一些关于CI/CD相关主题的文章。希望这篇文章也能帮助到别人！</p></div><div class="ab cl ky kz gp la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="hb hc hd he hf"><p id="0f90" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">我现在也正在撰写与电子商务和支付相关的其他文章，所以请随时关注我，以便在我未来的文章准备好时立即得到通知。我的账户主题是电子商务、支付和生产力。</p><p id="892e" class="pw-post-body-paragraph jn jo hy jp b jq jr iz js jt ju jc jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">(如果您希望向我发送提示🙂☕️) <br/> -以太坊地址<br/>0x 45 b 8 c 8712159 be fab 29 C3 B1 e 97 b 4534272 ADF 31</p></div></div>    
</body>
</html>