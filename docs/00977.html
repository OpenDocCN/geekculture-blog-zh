<html>
<head>
<title>Scaleable Authorization Management Made Easy With CASL.JS 😀</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">CASL使可扩展的授权管理变得简单。射流研究…😀</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/scaleable-authorization-management-made-easy-with-casl-js-bbfb75d18868?source=collection_archive---------19-----------------------#2021-03-22">https://medium.com/geekculture/scaleable-authorization-management-made-easy-with-casl-js-bbfb75d18868?source=collection_archive---------19-----------------------#2021-03-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/6e5f3d86305446b4b082481d49877571.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7rvkwW0E1NQ88vch"/></div></div></figure><h1 id="5a42" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">介绍</h1><p id="86bd" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated"><a class="ae km" href="https://casl.js.org/v5/en/" rel="noopener ugc nofollow" target="_blank"> CASL。JS </a>的核心是一个同构授权JavaScript库”。🤔</p><blockquote class="kn ko kp"><p id="7616" class="jo jp kq jq b jr kr jt ju jv ks jx jy kt ku kb kc kv kw kf kg kx ky kj kk kl hb bi translated"><em class="hi">“同构”这个有趣的词意味着你可以以完全相同的方式在前端和后端使用这个库。</em>——<em class="hi">塞尔吉·斯托茨基</em></p><p id="01ff" class="jo jp kq jq b jr kr jt ju jv ks jx jy kt ku kb kc kv kw kf kg kx ky kj kk kl hb bi translated">CASL(读作/ˈkæsəl/，像一座城堡)是一个同构的授权JavaScript库，它限制了给定客户端可以访问的资源。它被设计成可增量采用的，并且可以在简单的基于声明的和全功能的基于主题和属性的授权之间轻松扩展。它使得跨UI组件、API服务和数据库查询管理和共享权限变得容易。</p></blockquote><p id="9ac5" class="pw-post-body-paragraph jo jp hi jq b jr kr jt ju jv ks jx jy jz ku kb kc kd kw kf kg kh ky kj kk kl hb bi translated">CASL是多功能的，您可以从简单的基于角色的访问控制开始，并扩展您的应用程序，以包括全功能的基于属性的访问控制。</p><p id="7f19" class="pw-post-body-paragraph jo jp hi jq b jr kr jt ju jv ks jx jy jz ku kb kc kd kw kf kg kh ky kj kk kl hb bi translated">CASL是声明性的，它允许您使用几乎逐字匹配您的业务需求的领域特定语言来定义服务器端内存中的权限。</p><p id="6ba7" class="pw-post-body-paragraph jo jp hi jq b jr kr jt ju jv ks jx jy jz ku kb kc kd kw kf kg kh ky kj kk kl hb bi translated">CASL是类型安全的，它是用类型脚本编写的，这使得应用程序更安全，开发者体验更愉快。</p><p id="0409" class="pw-post-body-paragraph jo jp hi jq b jr kr jt ju jv ks jx jy jz ku kb kc kd kw kf kg kh ky kj kk kl hb bi translated">CASL很小，只有4.5KB左右，还可以更小，多亏了摇树！最小大小约为1.5KB。</p><h1 id="369c" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">背景</h1><p id="8c82" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">因此，在工作中使用Nodejs应用程序时；该团队花了数周时间研究和开发一个混合访问控制框架，该框架既可扩展，又可根据业务需求动态变化。</p><p id="85d3" class="pw-post-body-paragraph jo jp hi jq b jr kr jt ju jv ks jx jy jz ku kb kc kd kw kf kg kh ky kj kk kl hb bi translated">最近的发展表明，基于属性的访问控制(ABAC)可以在动态分布式系统和企业应用程序中提供灵活和细粒度的访问控制。由于只考虑主体、客体和环境的属性，典型的基于角色的访问控制(ABAC)方案的大多数当前解决方案不能为具有不同属性的一系列用户扩展对资源的许可。</p><p id="72d7" class="pw-post-body-paragraph jo jp hi jq b jr kr jt ju jv ks jx jy jz ku kb kc kd kw kf kg kh ky kj kk kl hb bi translated">同样在(ABAC)框架中，目标属性由资源本身在特定条件下获得或定义，例如时间、位置、IP地址等</p><p id="f135" class="pw-post-body-paragraph jo jp hi jq b jr kr jt ju jv ks jx jy jz ku kb kc kd kw kf kg kh ky kj kk kl hb bi translated">因此，在混合访问控制框架中，对资源的许可跨平台上用户的角色、声明、属性进行建模；例如由简档所有者指定的用户定义的属性，例如性别、姓名、工作、家乡、爱好等。</p><p id="e6db" class="pw-post-body-paragraph jo jp hi jq b jr kr jt ju jv ks jx jy jz ku kb kc kd kw kf kg kh ky kj kk kl hb bi translated">构建一个定制的混合访问控制框架，就像上面讨论的那样多才多艺，可能会耗费大量资源，尤其是对于小型团队🙄。</p><p id="327c" class="pw-post-body-paragraph jo jp hi jq b jr kr jt ju jv ks jx jy jz ku kb kc kd kw kf kg kh ky kj kk kl hb bi translated">我们发现<a class="ae km" href="https://github.com/stalniy/casl" rel="noopener ugc nofollow" target="_blank"> CASL JS </a>授权库非常棒，易于采用，维护量大，并且能够有效地随业务扩展，以动态管理对资源的许可😃。</p><p id="8165" class="pw-post-body-paragraph jo jp hi jq b jr kr jt ju jv ks jx jy jz ku kb kc kd kw kf kg kh ky kj kk kl hb bi translated"><strong class="jq hj">假设</strong>。我假设你已经对<a class="ae km" href="https://nodejs.org/en/" rel="noopener ugc nofollow" target="_blank"> Nodejs </a>和通过声明或角色管理应用程序中的权限有所了解😌。</p><h1 id="2744" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">开始行动——空谈是廉价的😆</h1><p id="79f9" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">1).将<a class="ae km" href="https://hashnode.com/@casl" rel="noopener ugc nofollow" target="_blank">@ casl</a>/能力作为一个依赖项安装在你的Nodejs应用程序中:</p><p id="4ce9" class="pw-post-body-paragraph jo jp hi jq b jr kr jt ju jv ks jx jy jz ku kb kc kd kw kf kg kh ky kj kk kl hb bi translated"><code class="du kz la lb lc b">npm i @casl/ability</code></p><p id="0a3e" class="pw-post-body-paragraph jo jp hi jq b jr kr jt ju jv ks jx jy jz ku kb kc kd kw kf kg kh ky kj kk kl hb bi translated">2).定义能力</p><p id="75fc" class="pw-post-body-paragraph jo jp hi jq b jr kr jt ju jv ks jx jy jz ku kb kc kd kw kf kg kh ky kj kk kl hb bi translated">有三种方法可以定义能力:</p><pre class="ld le lf lg fd lh lc li lj aw lk bi"><span id="358a" class="ll ir hi lc b fi lm ln l lo lp">- using defineAbility function<br/>- using AbilityBuilder class<br/>- using JSON objects</span></pre><p id="a350" class="pw-post-body-paragraph jo jp hi jq b jr kr jt ju jv ks jx jy jz ku kb kc kd kw kf kg kh ky kj kk kl hb bi translated">在这个例子中，我们将使用<code class="du kz la lb lc b">defineAbility function</code></p><p id="528f" class="pw-post-body-paragraph jo jp hi jq b jr kr jt ju jv ks jx jy jz ku kb kc kd kw kf kg kh ky kj kk kl hb bi translated">这个函数允许使用can和cannot方法创建一个能力实例。它允许在不写太多代码的情况下定义和使用能力实例。</p><pre class="ld le lf lg fd lh lc li lj aw lk bi"><span id="98d1" class="ll ir hi lc b fi lm ln l lo lp">//ability/defineAbility.js</span><span id="15f9" class="ll ir hi lc b fi lq ln l lo lp">const { AbilityBuilder, Ability } = require("<a class="ae km" href="http://twitter.com/casl/ability" rel="noopener ugc nofollow" target="_blank">@casl/ability</a>");</span><span id="498a" class="ll ir hi lc b fi lq ln l lo lp">/**<br/> * <a class="ae km" href="http://twitter.com/param" rel="noopener ugc nofollow" target="_blank">@param</a> user contains details about logged in user: its id, name, email, etc<br/> */<br/>// Define abilities for subjects here</span><span id="84a7" class="ll ir hi lc b fi lq ln l lo lp">// permissions on Organization<br/>exports.defineAbilitiesOnOrganizationFor = (user) =&gt; {<br/>  const { can, cannot, rules } = new AbilityBuilder(Ability);</span><span id="bb87" class="ll ir hi lc b fi lq ln l lo lp">// condition == True<br/>  if (user.isAdmin) {<br/>    // can manage (i.e., do anything) own Oganization<br/>    can(<br/>      "manage", // can do everything<br/>      "Oganization", //  Organization collection<br/>      ["email",<br/>        "phone",<br/>        "password",<br/>        "firstName", // feilds that can be managed<br/>        "lastName"<br/>      ],<br/>      { _id: user._id } // condition , if OrgId=user.Id (belongs to an Org)<br/>    );</span><span id="1941" class="ll ir hi lc b fi lq ln l lo lp">// But cannot delete Oganization<br/>    cannot(<br/>      "delete", // cannot delete Organization any Organization<br/>      "Organization" // collection Organization<br/>    );<br/>  }</span><span id="ceb9" class="ll ir hi lc b fi lq ln l lo lp">if (user.isSuperAdmin) {<br/>    // define the abilities for superAdmin on organization(subject)<br/>    can(<br/>      "manage",<br/>      "Organization"<br/>    );<br/>  }</span><span id="5620" class="ll ir hi lc b fi lq ln l lo lp">return new Ability(rules);<br/>};</span></pre><p id="21b8" class="pw-post-body-paragraph jo jp hi jq b jr kr jt ju jv ks jx jy jz ku kb kc kd kw kf kg kh ky kj kk kl hb bi translated">在上面的实现中，我们为“管理员”和“超级管理员”定义了权限，我们进一步为组织设置了条件，使其成为可由两个用户管理的资源。</p><p id="eda8" class="pw-post-body-paragraph jo jp hi jq b jr kr jt ju jv ks jx jy jz ku kb kc kd kw kf kg kh ky kj kk kl hb bi translated">CASL在能力级别上操作，这是用户在应用程序中实际可以做的事情。能力本身取决于4个参数(最后3个是可选的):</p><p id="eb36" class="pw-post-body-paragraph jo jp hi jq b jr kr jt ju jv ks jx jy jz ku kb kc kd kw kf kg kh ky kj kk kl hb bi translated"><strong class="jq hj">用户动作</strong>描述了用户在app中实际可以做的事情。用户动作是一个依赖于业务逻辑的词(通常是动词)(例如，延长、读取)。它通常是来自CRUD的单词列表——创建、读取、更新和删除。</p><p id="66aa" class="pw-post-body-paragraph jo jp hi jq b jr kr jt ju jv ks jx jy jz ku kb kc kd kw kf kg kh ky kj kk kl hb bi translated"><strong class="jq hj">主题</strong>要检查用户操作的主题或主题类型。通常，这是一个业务(或域)实体(例如，订阅、文章、用户、组织)。主题和主题类型之间的关系与对象实例和它的类之间的关系相同。</p><p id="e438" class="pw-post-body-paragraph jo jp hi jq b jr kr jt ju jv ks jx jy jz ku kb kc kd kw kf kg kh ky kj kk kl hb bi translated"><strong class="jq hj">字段</strong>可用于将用户操作仅限于匹配主题的字段(例如，允许管理员更新资源的字段，不允许更新某些字段)</p><p id="a82c" class="pw-post-body-paragraph jo jp hi jq b jr kr jt ju jv ks jx jy jz ku kb kc kd kw kf kg kh ky kj kk kl hb bi translated"><strong class="jq hj">条件</strong>将用户操作仅限于匹配主题的标准。当您需要授予特定主题的权限时(例如，允许用户管理他们自己的简档帐户)，这很有用</p><p id="c9b9" class="pw-post-body-paragraph jo jp hi jq b jr kr jt ju jv ks jx jy jz ku kb kc kd kw kf kg kh ky kj kk kl hb bi translated">有；业务需求可以很容易地转化为CASL规则🤩。</p><p id="76c2" class="pw-post-body-paragraph jo jp hi jq b jr kr jt ju jv ks jx jy jz ku kb kc kd kw kf kg kh ky kj kk kl hb bi translated">3).数据库集成CASL有一个补充包[<a class="ae km" href="https://hashnode.com/@casl" rel="noopener ugc nofollow" target="_blank">@ casl</a>/mongose]，它提供了与MongoDB和[mongose]的轻松集成。</p><p id="75ec" class="pw-post-body-paragraph jo jp hi jq b jr kr jt ju jv ks jx jy jz ku kb kc kd kw kf kg kh ky kj kk kl hb bi translated">安装依赖关系:<code class="du kz la lb lc b">npm install @casl/mongoose</code></p><pre class="ld le lf lg fd lh lc li lj aw lk bi"><span id="d243" class="ll ir hi lc b fi lm ln l lo lp">// Organization.js</span><span id="9d24" class="ll ir hi lc b fi lq ln l lo lp">import { AbilityBuilder } from '<a class="ae km" href="http://twitter.com/casl/ability" rel="noopener ugc nofollow" target="_blank">@casl/ability</a>';<br/>import { accessibleRecordsPlugin } from '<a class="ae km" href="http://twitter.com/casl/mongoose" rel="noopener ugc nofollow" target="_blank">@casl/mongoose</a>';<br/>import mongoose from 'mongoose';<br/>import {defineAbilitiesOnOrganizationFor} from 'ability/defineAbility.js'</span><span id="6a78" class="ll ir hi lc b fi lq ln l lo lp">mongoose.plugin(accessibleRecordsPlugin);</span><span id="522a" class="ll ir hi lc b fi lq ln l lo lp">const user = getUserLoggedInUser(); // app specific function</span><span id="2e2c" class="ll ir hi lc b fi lq ln l lo lp">const ability = defineAbilitiesOnOrganizationFor(user);</span><span id="9eaf" class="ll ir hi lc b fi lq ln l lo lp">const Organization = mongoose.model('Organization', mongoose.Schema({<br/>  email: String,<br/>  isAdmin: Boolean, <br/>  phone: Number,<br/>  password: String,<br/>  content: String,<br/>  createdAt: Date,<br/>  firstName: String,<br/>  lastName: String</span><span id="9efe" class="ll ir hi lc b fi lq ln l lo lp">}))</span><span id="7aed" class="ll ir hi lc b fi lq ln l lo lp">Organization.plugin(accessibleRecordsPlugin)</span><span id="f7bb" class="ll ir hi lc b fi lq ln l lo lp">module.exports = mongoose.model('Organization', Organization)</span></pre><p id="0e9e" class="pw-post-body-paragraph jo jp hi jq b jr kr jt ju jv ks jx jy jz ku kb kc kd kw kf kg kh ky kj kk kl hb bi translated">4).检查能力</p><pre class="ld le lf lg fd lh lc li lj aw lk bi"><span id="51a7" class="ll ir hi lc b fi lm ln l lo lp">// ../controllers/organizationController.js</span><span id="aa58" class="ll ir hi lc b fi lq ln l lo lp">const { NotFound, Unauthorized, InternalServerError } = require("http-errors");<br/>const Organizations = require("../models/organization");</span><span id="8c61" class="ll ir hi lc b fi lq ln l lo lp">async function permissionChecker(model, defineAbilitiesOnSubjectFor, userId) {<br/>  try {</span><span id="6b40" class="ll ir hi lc b fi lq ln l lo lp">// get user and all attributes<br/>    const user = await model.findOne({ _id: userId });<br/>    if (!user) {<br/>      throw new NotFound("user not found");<br/>    }<br/>    // get ability<br/>    const ability = defineAbilitiesOnSubjectFor(user);<br/>     return ability;</span><span id="078a" class="ll ir hi lc b fi lq ln l lo lp">} catch (error) {<br/>    throw new Unauthorized(error.message);<br/>  }<br/>}</span><span id="4dbb" class="ll ir hi lc b fi lq ln l lo lp">let action = "update" // specify the type of action on the resource, to check for<br/>let subject = "Organization"  // resource that needs permission and access control</span><span id="f8e7" class="ll ir hi lc b fi lq ln l lo lp">// check for permission using the permission checker<br/>    const ability = await permissionChecker(<br/>      Organization,<br/>      defineAbilitiesOnOrganizationFor,<br/>      user<br/>    );</span><span id="ffa2" class="ll ir hi lc b fi lq ln l lo lp">if(ability) {<br/>   try {<br/>        const organization = new Organization();<br/>        organization.set(data); // app specific data<br/>        ForbiddenError.from(ability).throwUnlessCan(action, organization);<br/>        await organization.save();<br/>   }catch(error){<br/>      throw new Unauthorized(error.message);<br/>   }<br/>} else{<br/>   throw new InternalServerError(error.message);<br/>}</span></pre><p id="0f3c" class="pw-post-body-paragraph jo jp hi jq b jr kr jt ju jv ks jx jy jz ku kb kc kd kw kf kg kh ky kj kk kl hb bi translated">是的，在你的<a class="ae km" href="https://nodejs.org/en/" rel="noopener ugc nofollow" target="_blank"> Nodejs </a>应用中用CASL实现可伸缩的内存权限管理和资源授权就是这么简单😊。</p><p id="12b6" class="pw-post-body-paragraph jo jp hi jq b jr kr jt ju jv ks jx jy jz ku kb kc kd kw kf kg kh ky kj kk kl hb bi translated">CASL的适应性越来越强，这意味着您可以从简单的基于角色的授权开始您的项目，并在以后随着您的应用程序功能的发展而发展。</p><p id="e075" class="pw-post-body-paragraph jo jp hi jq b jr kr jt ju jv ks jx jy jz ku kb kc kd kw kf kg kh ky kj kk kl hb bi translated">感谢观众，希望这篇文章对你有所帮助🤗。你可以随时在Github、T2、推特和T4的LinkedIn上联系我。一定要点赞、评论和分享😌。</p><h1 id="834a" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">了解更多信息</h1><ul class=""><li id="8ead" class="lr ls hi jq b jr js jv jw jz lt kd lu kh lv kl lw lx ly lz bi translated"><a class="ae km" href="https://casl.js.org/" rel="noopener ugc nofollow" target="_blank"> CASL JS文档</a></li></ul></div><div class="ab cl ma mb gp mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="hb hc hd he hf"><p id="6a2b" class="pw-post-body-paragraph jo jp hi jq b jr kr jt ju jv ks jx jy jz ku kb kc kd kw kf kg kh ky kj kk kl hb bi translated"><em class="kq">最初发布于</em><a class="ae km" href="https://blog.nextwebb.tech/scaleable-authorization-management-made-easy-with-casljs/" rel="noopener ugc nofollow" target="_blank"><em class="kq">https://blog . next Webb . tech</em></a><em class="kq">。</em></p></div></div>    
</body>
</html>