<html>
<head>
<title>AWS Cognito user pool journey</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS认知用户池之旅</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/aws-cognito-user-pool-journey-61ffb5f2750c?source=collection_archive---------21-----------------------#2021-08-26">https://medium.com/geekculture/aws-cognito-user-pool-journey-61ffb5f2750c?source=collection_archive---------21-----------------------#2021-08-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/92a327bfffc8cbbc05450c63bc6e3d06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Asc7cHLzkkGLYmnMZqCEdA.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Cognito</figcaption></figure><p id="15ec" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi js translated"><span class="l jt ju jv bm jw jx jy jz ka di">一个</span> lmighty AWS为我们提供了一个庞大的云服务生态系统。Cognito是AWS针对web服务的认证和授权问题的解决方案。以下是我在体验了Cognito用户池后的一些想法。</p><h1 id="b2d2" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">用户池与身份池</h1><p id="311f" class="pw-post-body-paragraph iu iv hi iw b ix kz iz ja jb la jd je jf lb jh ji jj lc jl jm jn ld jp jq jr hb bi translated">AWS Cognito有两种风格:用户池和身份池。起初，它们有些相似和令人困惑，但它们实际上是两种不同的服务。</p><p id="a006" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">用户池靠近用户表。假设您需要一个登录/注册功能，而不是在您的rails/laravel/whatever应用程序中实现一个身份验证系统，您可以使用Cognito用户池作为一个集中式身份验证系统，并让用户根据它进行身份验证。</p><p id="73ce" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">身份池主要用于控制对AWS服务的访问。假设一个用户需要访问一个私人S3桶，他可以通过一个应用服务器认证并通过该服务器访问S3，或者他可以向Cognito identity pool请求一个访客身份并直接访问S3。</p><p id="56fa" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在我的例子中，我需要一个认证系统，所以我选择了用户池。</p><h1 id="38cb" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">建筑</h1><p id="36e1" class="pw-post-body-paragraph iu iv hi iw b ix kz iz ja jb la jd je jf lb jh ji jj lc jl jm jn ld jp jq jr hb bi translated">经过一些研究，我是这样将Cognito用户池投入使用的:</p><figure class="lf lg lh li fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es le"><img src="../Images/52a2200e5696ae3ab4b35d1407454fd0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bVSUOrqyLhZki3Og_3fz6A.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">the architecture</figcaption></figure><p id="5fb1" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">移动应用程序使用用户池进行身份验证，以获得一个id令牌，然后将该令牌附加到每个传出请求的头部。API gateway检查请求头中的id令牌，如果令牌过期或无效，则返回401。授权的请求将被发送到应用服务器，在这里再次检查id令牌以确保它没有被篡改。</p><p id="7d67" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这是一个标准的设置，对我们来说很好，尽管我们在这个过程中遇到了一些小问题。</p><h1 id="281d" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">打嗝</h1><h2 id="846a" class="lj kc hi bd kd lk ll lm kh ln lo lp kl jf lq lr kp jj ls lt kt jn lu lv kx lw bi translated">更新-用户-池</h2><p id="46e1" class="pw-post-body-paragraph iu iv hi iw b ix kz iz ja jb la jd je jf lb jh ji jj lc jl jm jn ld jp jq jr hb bi translated">为了更新用户池配置，我们使用了<code class="du lx ly lz ma b">update-user-pool</code> api。然而，我们发现每次我们更新一个设置时，其他设置都会回滚到默认设置。这很令人困惑，直到我们在文档中发现了这个:</p><pre class="lf lg lh li fd mb ma mc md aw me bi"><span id="4d52" class="lj kc hi ma b fi mf mg l mh mi">update-user-pool<br/>Updates the specified user pool with the specified attributes. You can get a list of the current user pool settings using DescribeUserPool . If you don't provide a value for an attribute, it will be set to the default value.</span></pre><p id="a200" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">就是这样。更新一个设置还需要指定其他设置。干得好AWS。</p><h2 id="d3a3" class="lj kc hi bd kd lk ll lm kh ln lo lp kl jf lq lr kp jj ls lt kt jn lu lv kx lw bi translated">使用Sendgrid发送确认邮件</h2><p id="8d08" class="pw-post-body-paragraph iu iv hi iw b ix kz iz ja jb la jd je jf lb jh ji jj lc jl jm jn ld jp jq jr hb bi translated">Cognito与SES集成，用于发送电子邮件。这太神奇了，直到我们意识到我们想使用Sendgrid而不是SES发送确认电子邮件。</p><p id="6ee1" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">一开始我们以为<code class="du lx ly lz ma b">Custom message lambda trigger</code>就可以了，顾名思义。遗憾的是，这个触发器是用于定制消息内容，而不是电子邮件发送者。</p><p id="fc7d" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">经过更多的研究，我们发现<code class="du lx ly lz ma b">Custom sender lambda trigger</code>正是我们想要的。这个lambda触发器在控制台中是不可见的，所以我们设法使用CLI来设置它。我们非常高兴。</p><p id="343f" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">唯一的问题是，我们不能让它工作！出于某种原因，lambda没有得到应有的触发。经过广泛的研究，原因变成了这个家伙:</p><figure class="lf lg lh li fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mj"><img src="../Images/9d23981961312e7a1d972f5a20d14419.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*taT3VBzycSS7i7iOCJXudA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">cannot trust the console</figcaption></figure><p id="4827" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">为了让<code class="du lx ly lz ma b">Custom sender</code>工作，上面的设置必须设置在<code class="du lx ly lz ma b">Yes — Use Amazon SES</code>，这没有任何意义，因为我们根本就没想用SES。</p><p id="41ff" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在我们调换了选项后，它非常有效。有时你不能信任AWS控制台。</p><h2 id="64c2" class="lj kc hi bd kd lk ll lm kh ln lo lp kl jf lq lr kp jj ls lt kt jn lu lv kx lw bi translated">SDK和超额问题</h2><p id="f5b9" class="pw-post-body-paragraph iu iv hi iw b ix kz iz ja jb la jd je jf lb jh ji jj lc jl jm jn ld jp jq jr hb bi translated">我们需要在移动设备上实现该解决方案。iOS和Android的移动SDK已经在我们的掌控之中，但是它的文档却没有。可用的似乎是AWS Amplify，这是一个完全成熟的移动框架，使用Cognito进行身份验证。我们不想放大，我们想认知！</p><p id="1d2a" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">文档的缺乏不能阻止我们实施我们心爱的Cognito。我们还是实现了，应用程序通过了测试并发布了，耶！</p><p id="5117" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">然而，我们一发布，麻烦就来了。一个错误实现的方法产生了如此多的<code class="du lx ly lz ma b">initiate-auth</code>请求，超过了Cognito的用户认证配额，导致Cognito抑制所有认证请求，包括真正的刷新令牌请求。令牌无法刷新，这意味着没有人可以使用该应用程序。应用程序宕机了2天，数据受到影响，我们花了几天的时间进行持续调查以解决问题。我们当初的决心事与愿违！</p><p id="8fe5" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">回过头来看，如果我们更加小心，我们可以在实现SDK方面做得更好，如果我们更加关注配额警报，我们可以做得更好。然而，我们确实认为，一个更好的文件毕竟可以把我们从所有这些麻烦中拯救出来。</p><h1 id="38bd" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">结论</h1><p id="a41d" class="pw-post-body-paragraph iu iv hi iw b ix kz iz ja jb la jd je jf lb jh ji jj lc jl jm jn ld jp jq jr hb bi translated">Cognito是一项相对较新的服务，并且正在发展成为更好的服务，值得一试。小心对待它，就像对待AWS未来的任何其他新东西一样。</p></div></div>    
</body>
</html>