<html>
<head>
<title>Migrate Geometry and JsonB data from Postgres to ElasticSearch from logstash JDBC Input plugin</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将几何图形和JsonB数据从Postgres迁移到来自logstash JDBC输入插件的ElasticSearch</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/migrate-geometry-and-jsonb-data-from-postgres-to-elasticsearch-from-logstash-jdbc-input-plugin-d304a8ad47a6?source=collection_archive---------24-----------------------#2021-06-21">https://medium.com/geekculture/migrate-geometry-and-jsonb-data-from-postgres-to-elasticsearch-from-logstash-jdbc-input-plugin-d304a8ad47a6?source=collection_archive---------24-----------------------#2021-06-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="f992" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个故事解释了如何将Postgres表中的数据迁移到弹性搜索，包括使用logstash的几何和JSONB数据。最近，我开始对我们的应用用例使用弹性搜索，以避免来自微服务的交叉数据连接。</p><p id="c58a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Logstash帮助我们将不同来源的数据植入到弹性源索引中。这里，我们的源是Postgres DB实例。我们有广泛的用例，其中之一是将geometry和JSONB数据迁移到弹性搜索索引。</p><blockquote class="jd je jf"><p id="efff" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated">我必须花几个小时来破解这个，因为我是logstash的新手。花了几个小时来理解JDBC输入插件和其他过滤器。在迁移特殊类型(geometry和JSONB)方面，我还没有从google获得足够的支持。所以我想分享我的经历。</p></blockquote><p id="8486" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">什么是logstash？</strong></p><p id="af83" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Logstash动态地接收、转换和发送您的数据，而不管其格式或复杂性如何。使用grok从非结构化数据中导出结构，从IP地址中破译地理坐标，匿名化或排除敏感字段，并简化整体处理。</p><p id="1cc0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当数据从源传输到存储时，Logstash过滤器解析每个事件，识别命名字段以构建结构，并将它们转换为通用格式以实现更强大的分析和业务价值。</p><p id="cead" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Logstash可动态转换和准备您的数据，无论其格式或复杂性如何:</p><ul class=""><li id="8809" class="jk jl hi ih b ii ij im in iq jm iu jn iy jo jc jp jq jr js bi translated">用grok从非结构化数据中获取结构</li><li id="1290" class="jk jl hi ih b ii jt im ju iq jv iu jw iy jx jc jp jq jr js bi translated">从IP地址破译地理坐标</li><li id="e1a5" class="jk jl hi ih b ii jt im ju iq jv iu jw iy jx jc jp jq jr js bi translated">匿名化PII数据，完全排除敏感字段</li><li id="20b8" class="jk jl hi ih b ii jt im ju iq jv iu jw iy jx jc jp jq jr js bi translated">简化整体处理，独立于数据源、格式或模式。</li></ul><p id="b529" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是用例。</p><figure class="jz ka kb kc fd kd er es paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="er es jy"><img src="../Images/bdca2877df9b262ffc907997e5ac6312.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KQ6JzZncPfafi5z6nWKlxQ.png"/></div></div></figure><p id="5457" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">如何本地安装？</strong></p><p id="de75" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了在本地拥有它，我为ELK堆栈创建了一个docker-compose文件(弹性搜索和Kibana)。后来在本地安装了logstash。</p><p id="715b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">docker-为ES编写文件，为UI编写Kibana文件。</p><figure class="jz ka kb kc fd kd"><div class="bz dy l di"><div class="kk kl l"/></div></figure><p id="6105" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">es总共考虑了三个节点。</p><p id="22d8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我已经使用这个<a class="ae km" href="https://gist.github.com/ErikNovak/186e6021cf30db9160c673ee3145629f" rel="noopener ugc nofollow" target="_blank">链接</a>在我的本地安装并启用logstash。</p><p id="d348" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">将数据从Postgres迁移到弹性搜索</strong></p><p id="1cc1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为此，我们必须使用logstash。在此之前，让我们检查数据库。</p><p id="096e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我创建了一个名为<code class="du kn ko kp kq b"><strong class="ih hj">users</strong></code>的表，表中有一个几何图形和JSONB数据类型。</p><pre class="jz ka kb kc fd kr kq ks kt aw ku bi"><span id="51fb" class="kv kw hi kq b fi kx ky l kz la"><strong class="kq hj">CREATE</strong> <strong class="kq hj">TABLE</strong> public.users (<br/>   user_id uuid <strong class="kq hj">NOT</strong> <strong class="kq hj">NULL</strong> <strong class="kq hj">DEFAULT</strong> uuid_generate_v4(),<br/>   first_name <strong class="kq hj">text</strong> <strong class="kq hj">NOT</strong> <strong class="kq hj">NULL</strong>,<br/>   last_name <strong class="kq hj">text</strong> <strong class="kq hj">NULL</strong>,<br/>   date_of_birth <strong class="kq hj">date</strong> <strong class="kq hj">NULL</strong>,<br/>   city <strong class="kq hj">text</strong> <strong class="kq hj">NULL</strong>,<br/>   country <strong class="kq hj">text</strong> <strong class="kq hj">NOT</strong> <strong class="kq hj">NULL</strong>,<br/>   location <strong class="kq hj">geometry</strong> <strong class="kq hj">NOT</strong> <strong class="kq hj">NULL</strong>,<br/>   created_at <strong class="kq hj">timestamp</strong> <strong class="kq hj">NOT</strong> <strong class="kq hj">NULL</strong> <strong class="kq hj">DEFAULT</strong> <strong class="kq hj">now</strong>(),<br/>   updated_at <strong class="kq hj">timestamp</strong> <strong class="kq hj">NULL</strong>,<br/>   additional_data <strong class="kq hj">jsonb</strong> <strong class="kq hj">NOT</strong> <strong class="kq hj">NULL</strong> <strong class="kq hj">DEFAULT</strong> '{}'::<strong class="kq hj">jsonb</strong>,<br/>   <strong class="kq hj">CONSTRAINT</strong> users_pkey <strong class="kq hj">PRIMARY</strong> <strong class="kq hj">KEY</strong> (user_id)<br/>);</span></pre><p id="5869" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我插入了大约500条记录的测试数据，只是为了测试logstash和ES。</p><figure class="jz ka kb kc fd kd er es paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="er es lb"><img src="../Images/a0781abe2e4bdd5473282271decffca8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9adJwXPcYoCzJyT7FrCb-Q.png"/></div></div></figure><p id="d671" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">数据管道通常包含三个部分:输入、过滤和输出。对于我们的用例</p><blockquote class="jd je jf"><p id="21b7" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">输入→ RDBMS (JDBC插件)</strong></p><p id="b8f2" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj"> Filter →我们用的是Ruby，也是mutate filter。</strong></p><p id="54db" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">输出→弹性搜索</strong></p></blockquote><p id="fbfc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> JDBC输入插件</strong></p><p id="7287" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通常这个插件的用途是连接JDBC实例，执行一个查询，并获得数据传递到后期ie。，过滤输出。</p><p id="2980" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以在这里  <strong class="ih hj">找到JDBC外挂<a class="ae km" href="https://www.elastic.co/guide/en/logstash/current/plugins-inputs-jdbc.html" rel="noopener ugc nofollow" target="_blank">的所有选项。</a></strong></p><p id="85f0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">logstash的配置是conf文件。</p><pre class="jz ka kb kc fd kr kq ks kt aw ku bi"><span id="ed12" class="kv kw hi kq b fi kx ky l kz la">input {<br/>  jdbc {<br/>    jdbc_driver_library =&gt; "&lt;Path to&gt;/postgresql-42.2.19.jar"<br/>    jdbc_driver_class =&gt; "org.postgresql.Driver"<br/>    jdbc_connection_string =&gt; "jdbc:postgresql://localhost:5434/&lt;schema&gt;"<br/>    jdbc_user =&gt; &lt;username&gt;<br/>    jdbc_password =&gt; &lt;password&gt;<br/>    jdbc_paging_enabled =&gt; true<br/>    #schedule =&gt; "* * * * * *"<br/>    statement =&gt; "select user_id as userId, first_name as firstName, last_name as lastName, date_of_birth as dateOfBirth, city as city, country as country, st_asgeojson(location) as location, created_at as createdAt, updated_at as updatedAt, additional_data::text as additionalData from users"<br/>    use_column_value =&gt; true<br/>    tracking_column =&gt; "userId"<br/>  }<br/>}</span></pre><p id="cbd3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du kn ko kp kq b"><strong class="ih hj"><em class="jg">tracking_column</em></strong></code> <strong class="ih hj"> <em class="jg"> </em> </strong>对我来说是主键。</p><p id="4ce2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，让我们假设没有像Geometry和JSONB这样的特殊字段，只有文本、数字、布尔和日期字段。在这种情况下，不需要任何过滤器。可以直接有一个输出插件。</p><pre class="jz ka kb kc fd kr kq ks kt aw ku bi"><span id="f64c" class="kv kw hi kq b fi kx ky l kz la">output {<br/>  stdout {  <br/>        codec =&gt; json_lines  <br/>    } <br/>  elasticsearch {<br/>      hosts =&gt; ["localhost:9200"]<br/>      index =&gt; "users_test"<br/>      document_id =&gt; "%{userId}"<br/>  }<br/>}</span></pre><p id="877b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是，如果您的表有geometry、JSONB或任何其他特殊类型的数据类型，没有任何过滤器，您将得到下面的异常。</p><blockquote class="jd je jf"><p id="44a9" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><a class="ae km" href="https://discuss.elastic.co/t/jdbc-plugin-missing-converter-handling-for-full-class-name-org-postgresql-util-pgobject-simple-name-pgobject/163772" rel="noopener ugc nofollow" target="_blank"> JDBC插件—缺少完整类名的转换器处理=org.postgresql.util.PGobject，simple name=PGobject </a></p></blockquote><p id="ea80" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您遇到这种异常，那么您必须获取文本形式的数据，并根据您的要求解析它。</p><p id="20d9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">几何和JSONB如何解决这个问题？</strong></p><p id="b8c2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">PostGIS中的几何相当于geo_point或geo_shape。我会选择geo_point，因为我在PostGIS中选了point。</p><p id="9b7e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du kn ko kp kq b">geo_point</code>可以用5种不同的方式储存。<br/>请看这个<a class="ae km" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-point.html" rel="noopener ugc nofollow" target="_blank">链接</a></p><p id="8a14" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="jg">作为对象</em> </strong></p><pre class="jz ka kb kc fd kr kq ks kt aw ku bi"><span id="69a2" class="kv kw hi kq b fi kx ky l kz la">{<br/>   "point": { <br/>       "lat": 41.12,<br/>       "lon": -71.34<br/>    }<br/>}</span></pre><p id="dc31" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="jg">为字符串</em> </strong></p><pre class="jz ka kb kc fd kr kq ks kt aw ku bi"><span id="1e5e" class="kv kw hi kq b fi kx ky l kz la">{<br/>    "point": "41.12,-71.34"<br/>}</span></pre><p id="643c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="jg">为GEOHASH </em> </strong></p><pre class="jz ka kb kc fd kr kq ks kt aw ku bi"><span id="9561" class="kv kw hi kq b fi kx ky l kz la">{<br/>    "point": "drm3btev3e86"<br/>}</span></pre><p id="39b5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="jg">为数组</em> </strong></p><pre class="jz ka kb kc fd kr kq ks kt aw ku bi"><span id="abe8" class="kv kw hi kq b fi kx ky l kz la">{<br/>    "point": [ -71.34, 41.12 ]<br/>}</span></pre><p id="e206" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="jg">为WKT点图元</em> </strong></p><pre class="jz ka kb kc fd kr kq ks kt aw ku bi"><span id="918f" class="kv kw hi kq b fi kx ky l kz la">{<br/>    "point" : "POINT (-71.34 41.12)"<br/>}</span></pre><p id="2561" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我将在选项4和选项5中进行解释。</p><p id="38b0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">如何在ES中存储JSONB</strong></p><p id="6746" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">JSON数据可以存储为对象或扁平化类型。</p><p id="6557" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">为地理点应用过滤器</strong></p><p id="352e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有很多方法可以应用滤镜，但是使用ruby滤镜我们可以</p><pre class="jz ka kb kc fd kr kq ks kt aw ku bi"><span id="cca2" class="kv kw hi kq b fi kx ky l kz la">filter {<br/>    ruby {<br/>        code =&gt; "<br/>            require 'json'<br/>            begin<br/>                point_json = JSON.parse(event.get('location'))<br/>                event.set('lon', point_json['coordinates'][0])<br/>                event.set('lat', point_json['coordinates'][1])<br/>            rescue Exception =&gt; e<br/>                event.tag('invalide boundaries json')<br/>            end<br/>        "<br/>    }<br/>}</span></pre><p id="2ee4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">为JSON对象应用过滤器</strong></p><p id="52b6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用Ruby JSON函数，数据被解析为JSON对象。</p><pre class="jz ka kb kc fd kr kq ks kt aw ku bi"><span id="87da" class="kv kw hi kq b fi kx ky l kz la">filter {<br/>    ruby {<br/>        code =&gt; "<br/>            require 'json'<br/>            begin<br/>                data_json = JSON.parse(event.get('additionaldata').to_s || {})<br/>                event.set('data', data_json)<br/>            rescue Exception =&gt; e<br/>                event.tag('invalide boundaries json')<br/>            end<br/>        "<br/>    }<br/>}</span></pre><p id="34fc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们需要另一个过滤器来转换和替换字段名(通常在RDBMS中，列名由“_”分隔)。这将被替换为camelCase约定)。</p><pre class="jz ka kb kc fd kr kq ks kt aw ku bi"><span id="8766" class="kv kw hi kq b fi kx ky l kz la">filter {<br/>  mutate {<br/>      <strong class="kq hj"><em class="jg">rename =&gt; {<br/>        "data" =&gt; "additionalData"<br/>      }</em></strong><br/>      <strong class="kq hj"><em class="jg">replace =&gt; {<br/>        "location" =&gt; "POINT(%{lon} %{lat})"<br/>      }</em></strong><br/>      rename =&gt; {<br/>        "userid" =&gt; "userId"<br/>      }<br/>      rename =&gt; {<br/>        "firstname" =&gt; "firstName"<br/>      }<br/>      rename =&gt; {<br/>        "lastname" =&gt; "lastName"<br/>      }<br/>      rename =&gt; {<br/>        "dateofbirth" =&gt; "dateOfBirth"<br/>      }<br/>      rename =&gt; {<br/>        "createdat" =&gt; "createdAt"<br/>      }<br/>      rename =&gt; {<br/>        "updatedat" =&gt; "updatedAt"<br/>      }<br/>      remove_field =&gt; ["lat", "lon", "<a class="ae km" href="http://twitter.com/version" rel="noopener ugc nofollow" target="_blank">@version</a>", "<a class="ae km" href="http://twitter.com/timestamp" rel="noopener ugc nofollow" target="_blank">@timestamp</a>", "additionaldata", "data"]<br/>    }<br/>}</span></pre><p id="6119" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">根据RDBMS </strong>为索引创建映射</p><p id="8619" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果不创建映射，logstash将创建一个索引，并按照第一个记录数据类型创建映射。如果映射是自动创建的，可能会有一些偏差。所以总是建议创建一个映射。</p><figure class="jz ka kb kc fd kd"><div class="bz dy l di"><div class="kk kl l"/></div></figure><p id="13b5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">完整的日志存储配置文件</strong></p><figure class="jz ka kb kc fd kd"><div class="bz dy l di"><div class="kk kl l"/></div></figure><p id="118c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是日志文件。我已经截断了日志文件中的数据日志。</p><figure class="jz ka kb kc fd kd"><div class="bz dy l di"><div class="kk kl l"/></div></figure></div></div>    
</body>
</html>