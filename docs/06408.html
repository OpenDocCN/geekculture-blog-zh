<html>
<head>
<title>First-class push notifications for Expo apps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">世博应用的一级推送通知</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/first-class-push-notifications-for-expo-apps-4bd7bbb9a01a?source=collection_archive---------0-----------------------#2021-08-19">https://medium.com/geekculture/first-class-push-notifications-for-expo-apps-4bd7bbb9a01a?source=collection_archive---------0-----------------------#2021-08-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="9017" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以是时候让你的精彩世博应用程序开始发送推送通知了。你已经看了多种选择，但仍然不确定选择哪一种。不管你现在在哪里，在2021年8月在你管理的Expo应用上实现推送通知以及如何实现之前，你都需要知道这些。</p><h1 id="712f" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">介绍</h1><h2 id="5f2d" class="kb je hi bd jf kc kd ke jj kf kg kh jn iq ki kj jr iu kk kl jv iy km kn jz ko bi translated">通知网关</h2><p id="9731" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">最终，通知通过推送通知网关到达用户的设备:用于Android设备的FCM (Firebase Cloud Messaging)和用于iOS设备的APNs(Apple Push Notification service)。这两个网关都是公开Web API的服务，用于通过HTTP请求向用户发送推送通知。</p><p id="14d7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们不需要了解更多关于这些网关的信息，但是使用它们是向我们的用户发送推送通知的唯一方式。我们需要配置FCM和APNs凭证，并为我们的应用程序调用它们的API来成功交付通知。</p><h2 id="bb5e" class="kb je hi bd jf kc kd ke jj kf kg kh jn iq ki kj jr iu kk kl jv iy km kn jz ko bi translated">推送代币</h2><p id="de5c" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">推送令牌是唯一的密钥，用于标识特定设备中安装的应用程序。推送令牌由苹果或谷歌推送通知网关发布，只允许向预期的应用程序设备组合发送消息。它们的格式因操作系统而异，但看起来有点像<code class="du ku kv kw kx b">03df25c845d460b...f99cc3edcb63a85ea2ef2</code>。</p><h2 id="1af0" class="kb je hi bd jf kc kd ke jj kf kg kh jn iq ki kj jr iu kk kl jv iy km kn jz ko bi translated">服务器端要求</h2><p id="cd0c" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">任何形式的消息传递都涉及发送方和接收方，此外，发送方需要知道接收方的ID才能找到他们。对于推送通知，接收者的ID就是他们的推送令牌。</p><p id="764c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，在向用户发送通知之前，需要收集用户的推送令牌并将其存储在某个地方。虽然这并不一定意味着您需要一个后端服务器，但是您肯定需要一个可信的环境来存储推送令牌和调用通知网关API。</p><figure class="kz la lb lc fd ld er es paragraph-image"><div class="er es ky"><img src="../Images/6cf29d42da491444c17133bf7aebf113.png" data-original-src="https://miro.medium.com/v2/resize:fit:1330/format:webp/1*wFa4f-IHXvxkIDmZgsE3Lw.png"/></div><figcaption class="lg lh et er es li lj bd b be z dx">Push token collection</figcaption></figure><p id="5e58" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您已经在利用后端基础设施，它绝对是处理通知相关操作的好地方。如果您没有这样的基础设施，并且希望保持简单，您可以使用无服务器解决方案。</p><figure class="kz la lb lc fd ld er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es lk"><img src="../Images/bf1f24a3dd9810a7ea276c8b372a9393.png" data-original-src="https://miro.medium.com/v2/resize:fit:1256/format:webp/1*FcZ6EMDsIs4HMjgG6Ygpuw.png"/></div></div><figcaption class="lg lh et er es li lj bd b be z dx">Sending a push notification to a specific push token</figcaption></figure><p id="b0a7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="lp">通知也可以发送给应用程序的所有受众。如果您不需要向特定用户发送通知，则可以跳过收集推送令牌和设置服务器端环境来发送通知，而是使用图形通知编辑器工具(例如Firebase notification composer)。</em></p><h1 id="af31" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">技术考虑</h1><h2 id="170b" class="kb je hi bd jf kc kd ke jj kf kg kh jn iq ki kj jr iu kk kl jv iy km kn jz ko bi translated">推动代币收集:世博之路</h2><p id="2bc8" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">Expo为设置和处理推送通知提供了一个很棒的模块，它不仅工作起来很有魅力，而且还被很好地记录了:<code class="du ku kv kw kx b">expo-notifications</code>。这是我将用来在客户端处理推送通知的模块，它提供了两种不同的收集推送令牌的方法:</p><ul class=""><li id="ddc4" class="lq lr hi ih b ii ij im in iq ls iu lt iy lu jc lv lw lx ly bi translated"><a class="ae lz" href="https://docs.expo.dev/versions/latest/sdk/notifications/#getdevicepushtokenasync-devicepushtoken" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">getDevicePushTokenAsync</strong></a>:该方法返回设备原生推送令牌，对于iOS和Android不同，这是我们在与通知网关直接通信时需要使用的令牌。</li><li id="9526" class="lq lr hi ih b ii ma im mb iq mc iu md iy me jc lv lw lx ly bi translated"><a class="ae lz" href="https://docs.expo.dev/versions/latest/sdk/notifications/#getexpopushtokenasyncoptions-expotokenoptions-expopushtoken" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">getexpushtokensync</strong></a>:该方法返回一个Expo推送令牌(类似于<code class="du ku kv kw kx b">ExponentPushToken[lBc...ZsM]</code>)，这是一个定制令牌，Expo推送通知服务使用它来传递通知，而不是本地推送令牌。这是我们在使用Expo的服务时需要使用的方法。</li></ul><h2 id="3c60" class="kb je hi bd jf kc kd ke jj kf kg kh jn iq ki kj jr iu kk kl jv iy km kn jz ko bi translated">推送代币收集:Firebase方式</h2><p id="dd87" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">Firebase包括一个消息传递模块，可用于管理推送通知。根据<a class="ae lz" href="https://firebase.google.com/docs/cloud-messaging/js/client" rel="noopener ugc nofollow" target="_blank"> Firebase文档</a>，<code class="du ku kv kw kx b">messaging.getToken</code>是我们需要调用的函数，以便检索设备推送令牌，它将首先请求通知权限，以防它们尚未被授予。</p><p id="cea3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不幸的是，Firebase消息传递模块与React native不兼容💔长话短说，试图调用消息传递模块将导致无法处理的异常(关于此问题的更多详细信息，请参见本<a class="ae lz" href="https://stackoverflow.com/questions/61300018/typeerror-firebase-default-messaging-is-not-a-function-in-firebase-default-m/64855286#64855286" rel="noopener ugc nofollow" target="_blank"> stackoverflow问题</a>)。</p><pre class="kz la lb lc fd mf kx mg mh aw mi bi"><span id="f6e2" class="kb je hi kx b fi mj mk l ml mm">firebase.default.messaging is not a function. (In '_firebase.default.messaging()', '_firebase.default.messaging' is undefined)<br/>at App.tsx:34:4 in &lt;global&gt;<br/>at node_modules\metro\src\lib\polyfills\require.js:321:11 in loadModuleImplementation<br/>at node_modules\expo\AppEntry.js:3:0 in &lt;global&gt;<br/>- ... 4 more stack frames from framework internals</span></pre><h2 id="f172" class="kb je hi bd jf kc kd ke jj kf kg kh jn iq ki kj jr iu kk kl jv iy km kn jz ko bi translated">世博会推送通知服务</h2><p id="5a27" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">虽然直接与通知网关Web APIs通信是一种完全可以接受的发送推送通知的方式，但我将在本文中使用一种不同的方法。如<a class="ae lz" href="https://docs.expo.dev/push-notifications/sending-notifications-custom" rel="noopener ugc nofollow" target="_blank">世博会文件</a>中所述，通知网关直接沟通需要处理一定的复杂性:</p><ul class=""><li id="a0a1" class="lq lr hi ih b ii ij im in iq ls iu lt iy lu jc lv lw lx ly bi translated">区分原生iOS和Android设备令牌</li><li id="5d41" class="lq lr hi ih b ii ma im mb iq mc iu md iy me jc lv lw lx ly bi translated">要编写和维护的代码量增加了一倍</li><li id="6d9c" class="lq lr hi ih b ii ma im mb iq mc iu md iy me jc lv lw lx ly bi translated">FCM和APNs响应错误处理</li></ul><p id="af43" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们当然可以处理这种复杂性，但是Expo恰好提供了一个不依赖于iOS的推送通知服务，已经可以处理这种复杂性了。另外，我们将使用<code class="du ku kv kw kx b">expo-notifications</code>来处理客户端的通知，所以我觉得使用Expo推送通知服务很有意义(例如，通知<code class="du ku kv kw kx b">data</code>在两端都由Expo自动序列化和反序列化)。该服务是这样工作的:</p><figure class="kz la lb lc fd ld er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es mn"><img src="../Images/cb68d04ff3cc5a56384c3732df6a4d21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*erbU5gsHRINfIg_F.png"/></div></div></figure><h1 id="e1be" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">用例</h1><p id="e35a" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">在开始编码之前，我们需要一个推送通知的用例。假设我们将创建一个允许用户订阅每日天气通知的应用程序。为简单起见，我们将从一个城市开始(例如🕶️的巴塞罗纳)，通知将总是在同一时间发送(例如上午8:00)。</p><p id="eae9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">除了订阅/取消订阅按钮，该应用程序还将包括一个“发送”按钮，以接收用户需求的测试通知。用户将是匿名的:我们将只存储用户的ExpoPushToken，这样我们就可以确定在预定时间需要通知的设备。</p><p id="bdd9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">收到/点击通知后，应用程序将显示通知内容(出于演示目的，我将使用JSON查看器)和一个清除通知的按钮。ExpoPushToken也会显示，以便用户可以使用<a class="ae lz" href="https://expo.dev/notifications" rel="noopener ugc nofollow" target="_blank"> Expo通知工具</a>向自己的设备发送测试通知。</p><p id="9b24" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为这是一个演示应用程序，我们不需要花太多时间来设计它。</p><div class="kz la lb lc fd ab cb"><figure class="mo ld mp mq mr ms mt paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><img src="../Images/8d6475c0d20d0de1058e604e5233dcf7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*ZZz2cemQA-IBZjPUhxhTKA.png"/></div></figure><figure class="mo ld mp mq mr ms mt paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><img src="../Images/eec38e8cbe7967feef579d5bae35df25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*SgEUL42H2fa4WxQteKn-mg.png"/></div></figure></div><h1 id="6df4" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">实现:客户端</h1><p id="7244" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">在Expo上处理推送通知相当简单。让我们继续安装博览会通知模块。我们将使用本模块来:</p><pre class="kz la lb lc fd mf kx mg mh aw mi bi"><span id="6488" class="kb je hi kx b fi mj mk l ml mm">expo install expo-notifications</span></pre><ul class=""><li id="5e5b" class="lq lr hi ih b ii ij im in iq ls iu lt iy lu jc lv lw lx ly bi translated">显示收到的通知。当接收到通知时，Expo调用<code class="du ku kv kw kx b">handleNotification</code>函数参数，我们传递给<code class="du ku kv kw kx b">Notifications.setNotificationHandler</code>来决定通知是否必须显示给用户。</li><li id="e891" class="lq lr hi ih b ii ma im mb iq mc iu md iy me jc lv lw lx ly bi translated">收到通知时更新应用程序。只有当应用程序被<strong class="ih hj">前台</strong>接收到通知时，世博会才会运行通过<code class="du ku kv kw kx b">Notifications.addNotificationReceivedListener</code>提供的回调。</li><li id="3780" class="lq lr hi ih b ii ma im mb iq mc iu md iy me jc lv lw lx ly bi translated">点击通知时更新应用程序。当用户点击通知Expo将启动应用程序，并运行通过<code class="du ku kv kw kx b">Notifications.addNotificationResponseReceivedListener</code>提供的回调。</li><li id="da99" class="lq lr hi ih b ii ma im mb iq mc iu md iy me jc lv lw lx ly bi translated">获取设备推送令牌。</li></ul><p id="9cec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了使下面的代码片段尽可能简单，我在一个单独的文件中提取了与服务器相关的函数(即<code class="du ku kv kw kx b">server-operations.ts</code>)，并且省略了所有的样式标签。</p><figure class="kz la lb lc fd ld"><div class="bz dy l di"><div class="mu mv l"/></div></figure><p id="7cba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，我们需要通过添加<code class="du ku kv kw kx b">NOTIFICATIONS</code>权限并将<code class="du ku kv kw kx b">android.useNextNotificationsApi</code>设置为<code class="du ku kv kw kx b">true</code>来稍微调整一下<code class="du ku kv kw kx b">app.json</code>文件。</p><figure class="kz la lb lc fd ld"><div class="bz dy l di"><div class="mu mv l"/></div></figure><p id="f1f4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就是我们在Expo Go客户端上获得通知所需的全部内容🍾您现在可以通过使用<a class="ae lz" href="https://expo.dev/notifications" rel="noopener ugc nofollow" target="_blank"> Expo通知工具</a>来测试它们，提供将在应用程序中显示的ExpoPushToken。在我们实现服务器端之前，按下应用程序上的按钮将不起作用。</p><div class="kz la lb lc fd ab cb"><figure class="mo ld mw mq mr ms mt paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><img src="../Images/ec8809a780e3fe71798a9cc35b900b67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1568/format:webp/1*OPNbU4mhTFhwEwnhR0IBpA.png"/></div></figure><figure class="mo ld mx mq mr ms mt paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><img src="../Images/cb0c92f9091aebce5278ed0eebd25e1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:434/format:webp/1*TXFIlJvVjsPosHVi_L2bkA.png"/></div></figure></div><p id="c8b2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">关于<code class="du ku kv kw kx b">server-operations.ts</code>，请注意，与服务器相关的操作很大程度上取决于服务器端的选择。下面是在服务器端使用Firebase实时数据库和Firebase函数时的操作(省略了错误管理)。</p><figure class="kz la lb lc fd ld"><div class="bz dy l di"><div class="mu mv l"/></div></figure><p id="2cf2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们为发布做好准备🚀当在Expo Go客户端中测试通知时，我们使用Expo的FCM和APNs凭据，但在发布应用程序时，这不会起作用。我们需要做的下一件事是配置并向Expo应用程序添加FCM和APNs凭证，以使推送通知在我们应用程序的发布版本(例如独立版本)上工作。</p><h2 id="01a7" class="kb je hi bd jf kc kd ke jj kf kg kh jn iq ki kj jr iu kk kl jv iy km kn jz ko bi translated">配置APN</h2><p id="cc2a" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">因为我们是在Expo上构建的，所以配置APN变得非常容易。我们需要做的就是启动世博会证书管理器，并从列表中选择选项。</p><pre class="kz la lb lc fd mf kx mg mh aw mi bi"><span id="c1b0" class="kb je hi kx b fi mj mk l ml mm">expo credentials:manager</span><span id="3633" class="kb je hi kx b fi my mk l ml mm">Accessing credentials for &lt;…&gt; in project expo-notifications-tutorial</span><span id="da7d" class="kb je hi kx b fi my mk l ml mm">? Select platform › — Use arrow-keys. Return to submit.<br/>❯ ios<br/> android</span><span id="9b6b" class="kb je hi kx b fi my mk l ml mm">? What do you want to do? › - Use arrow-keys. Return to submit.<br/>❯   Use existing Push Notifications Key in current project<br/>    Use existing Distribution Certificate in current project<br/>    Remove Provisioning Profile<br/>    Add new Push Notifications Key<br/>    Remove Push Notification credentials<br/>    Update Push Notifications Key<br/>    Add new Distribution Certificate<br/>    Remove Distribution Certificate<br/>    Update Distribution Certificate</span></pre><p id="095a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="lp">如果您收到“命令错误:需要输入，但Expo CLI处于非交互模式。”错误，您需要使用不同的命令行实用程序。在我的例子中，在Windows 10上开发，Linux的Windows子系统是唯一成功的终端。</em></p><p id="4169" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你有Expo应用程序，你可以使用现有的推送通知键。请注意，同一个Apple开发者帐户只能有两个推送通知键，这些键将在您的所有应用程序中使用。</p><p id="1a02" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您当前的Apple Developer帐户没有推送通知密钥，请创建一个新的推送通知密钥。尝试创建第三个推送通知键将导致Expo凭证管理器和Apple开发者门户都出现错误消息。</p><pre class="kz la lb lc fd mf kx mg mh aw mi bi"><span id="af66" class="kb je hi kx b fi mj mk l ml mm">✖ Failed to create Apple push key<br/>CommandError:<br/>You can have only two Apple Keys generated on your Apple Developer account.<br/>Please revoke the old ones or reuse existing from your other apps.<br/>Please remember that Apple Keys are not application specific!</span></pre><figure class="kz la lb lc fd ld er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es mz"><img src="../Images/21591a3445968dde9815071b62151251.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P_FAOR1g35Zn8nCiwA_I_A.png"/></div></div><figcaption class="lg lh et er es li lj bd b be z dx">Apple Developer Portal error message</figcaption></figure><p id="9c9f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">无论是重用现有的密钥还是在过程结束时创建一个新的密钥，您都应该看到与下面类似的消息。您也可以在<a class="ae lz" href="https://expo.dev/" rel="noopener ugc nofollow" target="_blank">https://expo.dev/</a>中查看您应用程序的<strong class="ih hj">凭证</strong>部分。</p><pre class="kz la lb lc fd mf kx mg mh aw mi bi"><span id="6183" class="kb je hi kx b fi mj mk l ml mm">Successfully assigned Push Notifications Key to &lt;...&gt;/expo-notifications-tutorial (expo.notifications.tutorial)</span></pre><figure class="kz la lb lc fd ld er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es na"><img src="../Images/f682911b40b1ea1e170ce6262e1cffef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9vUSiB7-FpXYuP2BR5DRfw.png"/></div></div></figure><p id="8aeb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在添加推送通知键后，您需要至少重新构建一次iOS版应用程序<code class="du ku kv kw kx b">expo build:ios</code>，以使更改生效。</p><h2 id="8836" class="kb je hi bd jf kc kd ke jj kf kg kh jn iq ki kj jr iu kk kl jv iy km kn jz ko bi translated">配置FCM</h2><p id="aff0" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">如Expo文档中所述，我们需要将Firebase项目链接到Expo应用程序，以便使用FCM。这并不意味着您需要将应用程序迁移到Firebase，但是您需要创建一个Firebase项目，并将Firebase证书添加到Expo应用程序中。直接来自<a class="ae lz" href="https://docs.expo.dev/push-notifications/using-fcm/" rel="noopener ugc nofollow" target="_blank">本页面的世博文件</a>:</p><ul class=""><li id="03dc" class="lq lr hi ih b ii ij im in iq ls iu lt iy lu jc lv lw lx ly bi translated">选择您的Firebase项目。创建新项目或使用现有项目。在这两种情况下，您都需要将Firebase添加到您的Android应用程序中(使用您的<code class="du ku kv kw kx b">app.json</code>文件的<code class="du ku kv kw kx b">android.package</code>值)。</li></ul><figure class="kz la lb lc fd ld er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es nb"><img src="../Images/cd3794fccec1f4015ed7251c41ea3a0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3Od4LxSLqEy8H422WjjPcQ.png"/></div></div></figure><ul class=""><li id="5ceb" class="lq lr hi ih b ii ij im in iq ls iu lt iy lu jc lv lw lx ly bi translated">下载你的Firebase应用程序的<code class="du ku kv kw kx b">google-services.json</code>文件，放在你的Expo应用程序的根目录下。将该文件从源代码管理中排除是一个好主意。</li></ul><figure class="kz la lb lc fd ld er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es nc"><img src="../Images/b10f0a1255e7c16c1c22cf8c3eb7107b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ix7H7T01T-DeMAwsh1VS3A.png"/></div></div></figure><ul class=""><li id="49d7" class="lq lr hi ih b ii ij im in iq ls iu lt iy lu jc lv lw lx ly bi translated">在您的<code class="du ku kv kw kx b">app.json</code>文件中添加一个<code class="du ku kv kw kx b">android.googleServicesFile</code>字段，其中包含您刚刚下载的<code class="du ku kv kw kx b">google-services.json</code>文件的相对路径。</li></ul><figure class="kz la lb lc fd ld"><div class="bz dy l di"><div class="mu mv l"/></div></figure><ul class=""><li id="1691" class="lq lr hi ih b ii ij im in iq ls iu lt iy lu jc lv lw lx ly bi translated">为Android重建应用程序<code class="du ku kv kw kx b">expo build:android</code>，以使更改生效。</li></ul><p id="9f5e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="lp">如果您已经在应用程序中使用Firebase，并且之前已经添加了</em> <code class="du ku kv kw kx b"><em class="lp">google-services.json</em></code> <em class="lp">文件，请跳过前面的步骤。</em></p><p id="eef4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就是我们在Expo app端需要做的全部工作，但我们还需要完成一个步骤。因为我们使用Expo通知服务，而不是直接调用FCM，所以我们需要将Firebase项目服务器密钥上传到Expo的服务器，这样Expo的服务就可以在调用FCM时为我们提供密钥。</p><figure class="kz la lb lc fd ld er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es nd"><img src="../Images/3d501b59c0f3b6e758cdf79d070c800b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-cPcIhDUfmIfDKB09TRWuw.png"/></div></div></figure><p id="3742" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Firebase服务器密钥可以在<strong class="ih hj">项目设置</strong> &gt; <strong class="ih hj">云消息</strong> &gt; <strong class="ih hj">服务器密钥</strong>中找到。找到服务器密钥后，您需要运行以下命令将其上传到Expo的服务器:</p><pre class="kz la lb lc fd mf kx mg mh aw mi bi"><span id="950c" class="kb je hi kx b fi mj mk l ml mm">expo push:android:upload --api-key AAA…jbQ</span></pre><p id="08f1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">之后，您可以在<a class="ae lz" href="https://expo.dev/" rel="noopener ugc nofollow" target="_blank">https://expo.dev/</a>再次检查您应用程序的<strong class="ih hj">凭证</strong>部分，以确保服务器密钥已正确上传。</p><figure class="kz la lb lc fd ld er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es ne"><img src="../Images/98aee54b125211177c6430e94ea3b005.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nNnCHuWH0xYA-hCw4SeT6g.png"/></div></div></figure><h1 id="627e" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">实现:服务器端</h1><p id="46e7" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">服务器代码需要处理的最相关的任务是编写和发送推送通知。因为我们依赖于Expo推送通知服务，所以我们将使用Expo服务器SDK(因为我是用Typescript编码的，所以使用了<a class="ae lz" href="https://www.npmjs.com/package/expo-server-sdk" rel="noopener ugc nofollow" target="_blank"> Node.js版本</a>)。</p><p id="8c6c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du ku kv kw kx b">expo-server-sdk</code>公开了一个名为<code class="du ku kv kw kx b">sendPushNotificationAsync</code>的方法，该方法接收一组消息对象，并调度这些消息向相应通知网关的传递。消息对象必须根据Expo进行格式化。这两件事都可以在一个简单的函数中完成，如下所示(省略错误管理)。</p><figure class="kz la lb lc fd ld"><div class="bz dy l di"><div class="mu mv l"/></div></figure><p id="bf53" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">关于检索我们需要提供给函数的推送令牌，这也取决于服务器端的选择。坚持Firebase实时数据库和Firebase函数，可以这样做:</p><figure class="kz la lb lc fd ld"><div class="bz dy l di"><div class="mu mv l"/></div></figure><p id="c887" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这不是一个Firebase教程，所以我不打算详细解释上面的代码。我们只需要知道，创建一个每天运行的云调度程序作业，通知订阅的用户，并公开一个可用于随时发送单独通知的HTTPS端点。</p><p id="9389" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，唯一缺少的是获取天气数据的函数。如果你对此感到好奇，这种功能可以实现为对提供相应城市名称的<a class="ae lz" href="https://openweathermap.org/" rel="noopener ugc nofollow" target="_blank">开放天气</a> web API的HTTPS调用:</p><figure class="kz la lb lc fd ld"><div class="bz dy l di"><div class="mu mv l"/></div></figure><h1 id="ee49" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">包扎</h1><p id="cae5" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">给自己一点掌声👏如果你已经做到这一步，你的应用应该可以成功地在Android和iOS设备上发送推送通知。我将通过解决您在测试应用程序时可能会发现的几个问题来结束这篇文章。</p><h2 id="04bf" class="kb je hi bd jf kc kd ke jj kf kg kh jn iq ki kj jr iu kk kl jv iy km kn jz ko bi translated">未处理的Firebase composer通知单击</h2><p id="55a3" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">Firebase有一个通知编辑器，可以用来向应用程序的所有用户发送通知。通过这个图形工具发送通知确实会将通知传递给我们应用程序的所有用户(至少在Android设备上；我没有在iOS上测试过)。</p><div class="kz la lb lc fd ab cb"><figure class="mo ld nf mq mr ms mt paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><img src="../Images/ec0fa89bb8ce22ec1a672ffe1c7d8bc5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1584/format:webp/1*l5DYb03fC83XCrAUZJN9_w.png"/></div></figure><figure class="mo ld ng mq mr ms mt paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><img src="../Images/727821805399dbbcc43c1c5fc6948db6.png" data-original-src="https://miro.medium.com/v2/resize:fit:418/format:webp/1*9nWkW4Vhgl6bUJMFsk4B2w.png"/></div><figcaption class="lg lh et er es li lj bd b be z dx nh di ni nj">Firebase Cloud Messaging notification composer</figcaption></figure></div><p id="c362" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，当点击通知时，一个令人不快的惊喜出现了:应用程序打开了，但是Expo通知处理程序没有被触发，导致通知点击被错过😢起初，这可能看起来像一个博览会的错误，但在通读博览会的仓库问题后，我们发现这实际上是预期的行为。</p><p id="9933" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如本评论中<a class="ae lz" href="https://github.com/expo/expo/issues/10789#issuecomment-716624242" rel="noopener ugc nofollow" target="_blank">所解释的，有两种类型的FCM通知:数据消息和通知消息。查看</a><a class="ae lz" href="https://firebase.google.com/docs/cloud-messaging/concept-options#notifications_and_data_messages" rel="noopener ugc nofollow" target="_blank">提供的Firebase文档页面</a>，我们找到了问题的原因:</p><blockquote class="nk nl nm"><p id="ae1b" class="if ig lp ih b ii ij ik il im in io ip nn ir is it no iv iw ix np iz ja jb jc hb bi translated">使用FCM，您可以向客户端发送两种类型的消息:</p><p id="cf9c" class="if ig lp ih b ii ij ik il im in io ip nn ir is it no iv iw ix np iz ja jb jc hb bi translated">通知信息，有时被认为是“显示信息”这些由FCM SDK自动处理。</p><p id="4ea0" class="if ig lp ih b ii ij ik il im in io ip nn ir is it no iv iw ix np iz ja jb jc hb bi translated">数据消息，由客户端应用程序处理。</p></blockquote><p id="c9ac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以Expo没有空间来处理Firebase composer通知。我们将不得不接受这一点，并为我们需要通知应用程序的所有受众的情况编写更多的代码。</p><h2 id="06ec" class="kb je hi bd jf kc kd ke jj kf kg kh jn iq ki kj jr iu kk kl jv iy km kn jz ko bi translated">点击应用程序启动时出现未处理的通知(在Android上)</h2><p id="6112" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">在上面的代码中，我们从app组件内部的<code class="du ku kv kw kx b">useEffect</code>中定义了通知处理程序，因为我们需要React来更新App以显示收到的通知的内容。</p><p id="3f70" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这没有什么问题，但是，正如在<a class="ae lz" href="https://github.com/expo/expo/issues/6943#issuecomment-677901678" rel="noopener ugc nofollow" target="_blank">github问题</a>中解释的，如果在应用程序启动时没有尽快定义处理程序，当从关闭状态启动应用程序时，通知点击可能会被忽略。这正是当应用程序处于关闭状态时点击通知所发生的情况。</p><p id="f327" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">幸运的是，这个问题可以解决。一种简单的方法是在应用启动时，在任何组件之外定义存根通知处理程序，并在稍后定义实际处理程序的行为(例如，从组件内部的<code class="du ku kv kw kx b">useEffect</code>)。这种方法的要点是存根处理程序允许我们在定义实际处理程序的行为之前跟踪收到的通知。</p><p id="ee5a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">看起来比听起来容易，不管优雅与否，它确实有效💪：</p><figure class="kz la lb lc fd ld"><div class="bz dy l di"><div class="mu mv l"/></div></figure><p id="5751" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就这样结束了！您可以在<a class="ae lz" href="https://github.com/capelski/expo-notifications-tutorial" rel="noopener ugc nofollow" target="_blank">这个资源库</a>中找到您可能需要检查的所有源代码。快乐编码🥳</p></div></div>    
</body>
</html>