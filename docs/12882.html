<html>
<head>
<title>Snowflake — Time Travel</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">雪花——时间旅行</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/snowflake-time-travel-d7c8436f6ebe?source=collection_archive---------7-----------------------#2022-06-06">https://medium.com/geekculture/snowflake-time-travel-d7c8436f6ebe?source=collection_archive---------7-----------------------#2022-06-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/14a174b7d5a733433abe90695c8a2f17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OzCuyNC25q7K-kJto6AlpQ.jpeg"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">Photo by <a class="ae hv" href="https://unsplash.com/@aronvisuals?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Aron Visuals</a> on <a class="ae hv" href="https://unsplash.com/s/photos/time-tarvel?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><div class=""/><p id="62dd" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">回到过去查看当时的表状态。</p><blockquote class="jt"><p id="32c8" class="ju jv hy bd jw jx jy jz ka kb kc js dx translated">我想回到过去。不是改变什么，而是重新感受什么。—美世</p></blockquote><p id="ea91" class="pw-post-body-paragraph iv iw hy ix b iy kd ja jb jc ke je jf jg kf ji jj jk kg jm jn jo kh jq jr js hb bi translated">雪花时间旅行是一个有趣的工具，它允许我们访问过去某个特定时期内任何一点的历史数据(已被修改/删除的数据)。我们可以在保留期之前访问数据的历史版本，在此之后，数据将被移动到Snowflake Fail-safe。</p><figure class="kj kk kl km fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ki"><img src="../Images/3131712a5ba3abeff98670c478c919be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-dtJ7jIGAe4bDXrvF_0HRQ.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">Snowflake Time Travel</figcaption></figure><p id="a227" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">该功能有助于我们实现以下目标:</p><ul class=""><li id="9068" class="kn ko hy ix b iy iz jc jd jg kp jk kq jo kr js ks kt ku kv bi translated">用“当时看起来的”数据调试ETL</li><li id="ea3e" class="kn ko hy ix b iy kw jc kx jg ky jk kz jo la js ks kt ku kv bi translated">还原可能已被修改/删除的数据库对象。</li><li id="4211" class="kn ko hy ix b iy kw jc kx jg ky jk kz jo la js ks kt ku kv bi translated">复制或备份过去关键点的数据。</li><li id="6ebd" class="kn ko hy ix b iy kw jc kx jg ky jk kz jo la js ks kt ku kv bi translated">分析指定时间段内的数据使用/操作情况。</li></ul><p id="2778" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当一个对象的保留期到期时，历史数据被移动到雪花故障保护。在此期间:</p><ul class=""><li id="449a" class="kn ko hy ix b iy iz jc jd jg kp jk kq jo kr js ks kt ku kv bi translated">我们不能再查询历史数据</li><li id="5fe9" class="kn ko hy ix b iy kw jc kx jg ky jk kz jo la js ks kt ku kv bi translated">我们不能再从过去的状态克隆对象</li><li id="147a" class="kn ko hy ix b iy kw jc kx jg ky jk kz jo la js ks kt ku kv bi translated">我们不能再恢复被丢弃的物体</li></ul><h2 id="d1da" class="lb lc hy bd ld le lf lg lh li lj lk ll jg lm ln lo jk lp lq lr jo ls lt lu lv bi translated">保持期和参数</h2><p id="c9f2" class="pw-post-body-paragraph iv iw hy ix b iy lw ja jb jc lx je jf jg ly ji jj jk lz jm jn jo ma jq jr js hb bi translated">基于雪花版本和对象类型，我们对不同的数据库对象有不同的保留期。下表总结了这些值:</p><pre class="kj kk kl km fd mb mc md me aw mf bi"><span id="9420" class="lb lc hy mc b fi mg mh l mi mj">Object         | Retention period            | Fail-Safe days<br/>---------------+-----------------------------+------------------Temporary      | 0 or 1 (default - 1)        |    0<br/>Transient      | 0 or 1 (default - 1)        |    0<br/>Permanent(Std) | 0 or 1 (default - 1)        |    7<br/>Permanent(Ent) | 0-90 (default configurable) |    7</span></pre><p id="32db" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们可以用<code class="du mk ml mm mc b">SHOW PARAMETERS</code>来寻找雪花状物体的时间旅行保持期。</p><pre class="kj kk kl km fd mb mc md me aw mf bi"><span id="126a" class="lb lc hy mc b fi mg mh l mi mj">SHOW PARAMETERS in DATABASE db_name;</span></pre><h2 id="2a24" class="lb lc hy bd ld le lf lg lh li lj lk ll jg lm ln lo jk lp lq lr jo ls lt lu lv bi translated">设置保留期</h2><p id="a816" class="pw-post-body-paragraph iv iw hy ix b iy lw ja jb jc lx je jf jg ly ji jj jk lz jm jn jo ma jq jr js hb bi translated">创建对象时，我们可以指定所需的保留期</p><pre class="kj kk kl km fd mb mc md me aw mf bi"><span id="f17c" class="lb lc hy mc b fi mg mh l mi mj">CREATE TABLE &lt;TABLE_NAME&gt;(...) data_retention_time_in_days=30;</span></pre><p id="4e37" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">对于现有对象，可以使用ALTER更改保留时间，如下所示:</p><pre class="kj kk kl km fd mb mc md me aw mf bi"><span id="dc3e" class="lb lc hy mc b fi mg mh l mi mj">ALTER TABLE &lt;TABLE_NAME&gt; set data_retention_time_in_days=15;</span></pre><figure class="kj kk kl km fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mn"><img src="../Images/99710bc7fb748eb6e09fdd2cd950bbd9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Fx6Bs7TO2S0lCrblS04Uzg.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">Inheritance of retention property</figcaption></figure><p id="098b" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">更改我们的帐户或单个对象的保留期会更改所有未明确设置保留期的低级对象的值。例如，如果我们在帐户级别更改保留期，所有没有明确保留期的数据库、模式和表都会自动继承新的保留期。</p><p id="8558" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">删除数据库时，如果子对象的数据保持期被显式设置为不同于数据库的保持期，则不会考虑该保持期。子对象的保留时间与数据库相同。为了保证这些子对象的数据保持期，我们需要在删除数据库之前显式地删除它们。</p><h2 id="4a0c" class="lb lc hy bd ld le lf lg lh li lj lk ll jg lm ln lo jk lp lq lr jo ls lt lu lv bi translated">时间旅行的存储成本</h2><p id="23ff" class="pw-post-body-paragraph iv iw hy ix b iy lw ja jb jc lx je jf jg ly ji jj jk lz jm jn jo ma jq jr js hb bi translated">存储成本是从数据更改开始每24小时(即1天)计算一次。此外，雪花通过只维护恢复被更新或删除的单个表行所需的信息，最大限度地减少了历史数据所需的存储量。我们可以通过以下查询来查看时间旅行的存储成本:</p><pre class="kj kk kl km fd mb mc md me aw mf bi"><span id="fefb" class="lb lc hy mc b fi mg mh l mi mj">SELECT * FROM "snowflake"."account_usage"."table_storage_mterics" WHERE schema = &lt;schema_name&gt;;</span></pre><p id="461e" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">对于上面的select语句，下面的属性是感兴趣的。</p><blockquote class="mo mp mq"><p id="5ce4" class="iv iw mr ix b iy iz ja jb jc jd je jf ms jh ji jj mt jl jm jn mu jp jq jr js hb bi translated"><em class="hy">活动_字节</em> —实际表开销<br/> <em class="hy">时间_行程_字节</em> —时间行程开销<br/> <em class="hy">故障_安全_字节</em> —故障安全开销</p></blockquote><h2 id="46dd" class="lb lc hy bd ld le lf lg lh li lj lk ll jg lm ln lo jk lp lq lr jo ls lt lu lv bi translated">时间旅行在行动</h2><p id="e4f5" class="pw-post-body-paragraph iv iw hy ix b iy lw ja jb jc lx je jf jg ly ji jj jk lz jm jn jo ma jq jr js hb bi translated">雪花时间旅行SQL扩展提供了两个带有FROM子句的子子句(AT &amp; BEFORE)。</p><ul class=""><li id="a9de" class="kn ko hy ix b iy iz jc jd jg kp jk kq jo kr js ks kt ku kv bi translated"><strong class="ix hz">在</strong> —包括时间戳/语句运行时间</li><li id="10ea" class="kn ko hy ix b iy kw jc kx jg ky jk kz jo la js ks kt ku kv bi translated"><strong class="ix hz"> BEFORE </strong> —指定日期时间或语句运行时间之前的点</li></ul><p id="f3d1" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">上述分条款有三个不同的论点</p><blockquote class="mo mp mq"><p id="5bb2" class="iv iw mr ix b iy iz ja jb jc jd je jf ms jh ji jj mt jl jm jn mu jp jq jr js hb bi translated"><strong class="ix hz">偏移量</strong> —与当前时间的秒数差<br/> <strong class="ix hz">时间戳</strong> <br/> <strong class="ix hz">语句</strong> —语句标识符(ID)</p></blockquote><pre class="kj kk kl km fd mb mc md me aw mf bi"><span id="7ae5" class="lb lc hy mc b fi mg mh l mi mj">-- Query the table at a particular timestamp<br/>SELECT * <br/>FROM &lt;table_name&gt;<br/>at(timestamp =&gt; 'Sat, 06 June 2022 01:00:00 +0200'::timestamp_tz);</span><span id="5112" class="lb lc hy mc b fi mv mh l mi mj">-- Query the table at 10 minutes before<br/>SELECT * <br/>FROM &lt;table_name&gt;<br/>at(offset =&gt; -60*10);</span><span id="9242" class="lb lc hy mc b fi mv mh l mi mj">-- Query the table before a statement is executed<br/>SELECT *<br/>FROM &lt;table_name&gt; <br/>before(statement =&gt; '8e5d0ca9-005e-44e6-b858-a8f5b37c5726');</span><span id="8294" class="lb lc hy mc b fi mv mh l mi mj">SELECT * <br/>FROM &lt;table_name&gt;<br/>before(timestamp =&gt; '2022-06-05 13:31:56.786'::timestamp)</span><span id="533c" class="lb lc hy mc b fi mv mh l mi mj">-- Create a clone from previous data using timestamp<br/>CREATE TABLE &lt;NEW_TABLE_NAME&gt; <br/>CLONE &lt;CURRENT_TABLE_NAME&gt; <br/>AT(timestamp =&gt; 'Sat, 05 June 2022 14:00:00 +0200'::timestamp_tz);</span><span id="c275" class="lb lc hy mc b fi mv mh l mi mj">-- Create a clone from previous data using statement<br/>CREATE TABLE &lt;NEW_TABLE_NAME&gt; <br/>CLONE &lt;CURRENT_TABLE_NAME&gt; <br/>AT(statement =&gt; '8e5d0ca9-005e-44e6-b858-a8f5b37c5726');</span><span id="8630" class="lb lc hy mc b fi mv mh l mi mj">-- Create a clone from previous data using offset<br/>CREATE TABLE &lt;NEW_TABLE_NAME&gt; <br/>CLONE &lt;CURRENT_TABLE_NAME&gt; <br/>AT(offset=&gt;-60*10);</span><span id="1d5a" class="lb lc hy mc b fi mv mh l mi mj">-- Create a clone from previous data using query_id<br/>CREATE TABLE &lt;NEW_TABLE_NAME&gt; <br/>CLONE &lt;CURRENT_TABLE_NAME&gt; <br/>BEFORE(statement =&gt; '8e5d0ca9-005e-44e6-b858-a8f5b37c5726');</span></pre><h2 id="443e" class="lb lc hy bd ld le lf lg lh li lj lk ll jg lm ln lo jk lp lq lr jo ls lt lu lv bi translated">恢复丢弃的对象</h2><p id="e5c9" class="pw-post-body-paragraph iv iw hy ix b iy lw ja jb jc lx je jf jg ly ji jj jk lz jm jn jo ma jq jr js hb bi translated">我们可以检查历史表，找出被删除的表。活动表的行将把列<code class="du mk ml mm mc b">is_active</code>设置为真。对于删除的表，我们为列<code class="du mk ml mm mc b">dropped_on</code>设置了一个值。</p><pre class="kj kk kl km fd mb mc md me aw mf bi"><span id="de92" class="lb lc hy mc b fi mg mh l mi mj">-- Check table history <br/>SHOW TABLES HISTORY; </span><span id="6483" class="lb lc hy mc b fi mv mh l mi mj">-- is_current &amp; dropped_on column<br/>UNDROP TABLE &lt;TABLE_NAME&gt;;</span></pre><p id="ff3f" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">数据仓库快乐！！</p></div></div>    
</body>
</html>