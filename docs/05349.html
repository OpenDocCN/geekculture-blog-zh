<html>
<head>
<title>Warp WebSockets and Tokio Actors</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Warp WebSockets和Tokio Actors</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/warp-websockets-and-tokio-actors-de44c106d599?source=collection_archive---------6-----------------------#2021-07-19">https://medium.com/geekculture/warp-websockets-and-tokio-actors-de44c106d599?source=collection_archive---------6-----------------------#2021-07-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div class="er es hg"><img src="../Images/cc9f8974fc4459b7057c7fca15758ccd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*GD1gBN2VnzfIe9vEH2BQhw.png"/></div></figure><div class=""/><p id="bb81" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我在我的项目中使用了很多warp，并且经常需要通过websockets公开一些服务。warp项目有一个关于如何使用web sockets的很好的例子，而且非常容易使用。然而，我认为在这里使用演员使事情变得更干净和更容易。</p><p id="7ab0" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">下面是一个关于如何使用Warp websockets的actors的小例子。为了跟进，您必须将以下依赖项包含到您的<code class="du jl jm jn jo b">Cargo.toml</code>中:</p><pre class="jp jq jr js fd jt jo ju jv aw jw bi"><span id="39fc" class="jx jy hp jo b fi jz ka l kb kc">[dependencies]<br/>tiny-tokio-actor = "0.2"<br/>tokio = { version = "1", features = ["full"] }<br/>futures = "0.3"<br/>tokio-stream = "0.1"<br/>uuid = { version = "0.8", features = ["v4"] }<br/>warp = "0.3"<br/>env_logger = "0.9"<br/>dotenv = "0.15.0"</span></pre><h1 id="a3d9" class="kd jy hp bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">回声演员</h1><p id="170c" class="pw-post-body-paragraph im in hp io b ip la ir is it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj hb bi translated">为了创建能够回应任何消息的actor，我使用了我在tokio上创建的一个名为<a class="ae jk" href="https://github.com/fdeantoni/tiny-tokio-actor" rel="noopener ugc nofollow" target="_blank"> tiny-tokio-actor </a>的小库。演员很简单:</p><figure class="jp jq jr js fd hk er es paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="er es lf"><img src="../Images/1e955e5a52e3fd26be8981ff894c73ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xwuWvuzPQj16hCt0Nci_gA.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx">To copy/paste use the <a class="ae jk" href="#4ebf" rel="noopener ugc nofollow">complete code</a> at the bottom</figcaption></figure><p id="3e43" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">除了actor之外，我们还创建了一个名为<code class="du jl jm jn jo b">ServerEvent</code>的结构，并为其实现了<code class="du jl jm jn jo b">SystemEvent</code>特征。这将被我们稍后会看到的actor系统使用。现在让我们把注意力放在演员身上。</p><p id="b348" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">参与者拥有一个属性，那就是websocket消息的无边界发送者。参与者将通过这个发送者发回回显消息。</p><p id="4337" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">接下来，我们创建我们的<code class="du jl jm jn jo b">EchoActor</code>将接收的消息:</p><figure class="jp jq jr js fd hk er es paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="er es lo"><img src="../Images/df9e2aa536944f22b87030147aec9f68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3AOXDzIBpKT487yVMl2Rag.png"/></div></div></figure><p id="ce4f" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如您所见，这个消息只是一个warp websocket消息的包装。处理该消息的参与者处理程序只是记录一条调试消息，并使用参与者的<code class="du jl jm jn jo b">sender</code>属性将其发回。</p><p id="3304" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们的echo服务完成了！我们现在要做的就是把它连接到曲速的其他部分。</p><h1 id="05a0" class="kd jy hp bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">曲速服务器</h1><p id="b33a" class="pw-post-body-paragraph im in hp io b ip la ir is it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj hb bi translated">要运行我们的服务器，我们需要用tokio运行时创建一个主函数。在这个主函数中，我们还将启动我们的actor系统:</p><figure class="jp jq jr js fd hk er es paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="er es lp"><img src="../Images/e7ece6cf05b008c95118a06299519d93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-0jpBeuSDtrVzAdC2lZFiw.png"/></div></div></figure><p id="5861" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">接下来，我们创建可以服务websocket连接的warp服务器:</p><figure class="jp jq jr js fd hk er es paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="er es lq"><img src="../Images/5b9bf874347345cb5b97579a101b9330.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zK8UFQOcwuIlpgAafE6nYQ.png"/></div></div></figure><p id="a22d" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们让warp route获取我们的actor系统、连接客户端的远程地址、warp websocket处理程序，并将其全部传递给<code class="du jl jm jn jo b">start_echo</code>函数。</p><p id="7721" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在<code class="du jl jm jn jo b">start_echo</code>函数中，我们将为连接的客户端创建一个<code class="du jl jm jn jo b">EchoActor</code>，使用客户端的地址作为参与者名称的一部分。当我们的actor使用<code class="du jl jm jn jo b">UnboundedSender&lt;warp::ws::Message&gt;</code>时，我们将需要构建必要的通道来链接到传出的websocket接收器。为了获得接收器，我们<code class="du jl jm jn jo b">split</code>web socket连接:</p><figure class="jp jq jr js fd hk er es paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="er es lq"><img src="../Images/075274c6cd6769f337de3d0fed2ae5f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5Oaqz--edwseFV_Yf6zPkQ.png"/></div></div></figure><p id="a70c" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们首先将websocket分成一个<code class="du jl jm jn jo b">ws_out</code>接收器和一个<code class="du jl jm jn jo b">ws_in</code>流，以接收来自连接的websocket客户端的消息。<code class="du jl jm jn jo b">ws_out</code>接收器用于将消息发送回客户端。</p><p id="e523" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们创建一个连接到<code class="du jl jm jn jo b">ws_out</code>接收器的无界通道。这个通道的发送者将通过<code class="du jl jm jn jo b">ws_out</code>接收器将消息发送回websocket客户端。</p><p id="b10e" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">接下来我们创建<code class="du jl jm jn jo b">EchoActor</code>，并传入我们刚刚创建的通道的发送者。我们使用从远程客户机地址(主机名&amp;端口)生成的惟一名称在我们的actor系统上运行这个actor。如果由于某种原因，我们无法检索远程地址，我们只是使用一个随机生成的UUID。</p><p id="2862" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在我们可以从<code class="du jl jm jn jo b">ws_in</code>流中获取消息，并将它们发送到我们的<code class="du jl jm jn jo b">EchoActor</code>:</p><figure class="jp jq jr js fd hk er es paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="er es lq"><img src="../Images/4ab3872b1549a07449d159926ca105a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fSjhdesdxtYFcY74SXqoSQ.png"/></div></div></figure><p id="4c1d" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们循环从<code class="du jl jm jn jo b">ws_in</code>流接收的消息，直到我们得到一个错误。如果有错误发生，我们会记录下来并退出循环。当循环结束时，我们也停止我们的<code class="du jl jm jn jo b">EchoActor</code>。</p><p id="bc73" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">就是这样！当您运行服务器时，您应该能够通过类似于<a class="ae jk" href="https://github.com/vi/websocat" rel="noopener ugc nofollow" target="_blank"> websocat </a>的东西连接到它，例如:</p><pre class="jp jq jr js fd jt jo ju jv aw jw bi"><span id="7a90" class="jx jy hp jo b fi jz ka l kb kc">$ websocat ws://127.0.0.1:9000/echo</span></pre><p id="4ebf" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">完整代码:</p><figure class="jp jq jr js fd hk"><div class="bz dy l di"><div class="lr ls l"/></div></figure><p id="5115" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这段代码也是<a class="ae jk" href="https://github.com/fdeantoni/tiny-tokio-actor" rel="noopener ugc nofollow" target="_blank"> tiny-tokio-actor </a>在<a class="ae jk" href="https://github.com/fdeantoni/tiny-tokio-actor/tree/main/examples" rel="noopener ugc nofollow" target="_blank"> examples </a>文件夹中的项目的一部分。</p></div></div>    
</body>
</html>