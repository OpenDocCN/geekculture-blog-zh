# 确定 DynamoDB 主键和辅键

> 原文：<https://medium.com/geekculture/determining-dynamodb-primary-and-secondary-keys-b686e106be0?source=collection_archive---------40----------------------->

2021 年 6 月 21 日

作者托马斯

![](img/929d82e5424c068c8d41810e09118181.png)

Photo by [Jaye Haych](https://unsplash.com/@jaye_haych?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) on [Unsplash](https://unsplash.com/s/photos/keys?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)

我最近开始潜入 DynamoDB 的广阔世界。我几乎立即被介绍到的一个领域是为 DynamoDB 建模数据，我想分享一下我刚刚遇到的关于我如何为一个项目建模一些数据的经验。由于 DynamoDB 是一个 NoSQL 数据库，数据存储和模型需要与传统的 SQL 数据库有所不同。为了从这种极其快速可靠的数据存储服务中获得最大收益，需要考虑和规划系统的数据和用例。规划数据模型是我几乎没有经验的事情，如果我没有在早期抓住自己，几乎将我的项目变成一团乱麻。

在我深入讨论太多细节之前，我想先说，我知道世界上有很多更聪明、更有经验的人在这个话题上。我正在看着[阿历克斯·德布里](https://www.alexdebrie.com/)和[里克·霍利汉](https://twitter.com/houlihan_rick)。有很多资源可以学习 DynamoDB 的最佳实践，但是这篇文章可能不在其中。只是一个半娱乐性的故事，可能是一个大的不幸。如果你想花一个小时听 DynamoDB，可以看看 Rick Houlihan 在 YouTube 上的关于发明的演讲。

在过去的几个月里，我一直在阅读关于 DynamoDB，它的力量，以及它时髦的数据建模最佳实践。重复数据删除的时代已经结束。我记得读到过使用主键和辅键来建模各种类型的关系，如一对一和一对多。我注意到主键通常是单个 ID、名称、类型等等，然后辅键是由散列(`#`)分隔的各种属性的集群。当时(在我的记忆中)我在阅读的时候不能足够近距离地看到一个模式，以理解其背后的推理。

不久前，我需要在一个名为[Crow authentic ation](https://crowauth.com/)的项目中重塑数据。Crow 是身份验证即服务，这意味着它存储用户凭证，但它也是一个多租户应用程序，因为我向公众提供它。最初，我的分区键是租户 ID 和他们的用户 ID 的散列。这类似于我在上一段中提到的阅读关于辅键的内容。退伍军人可能会对我的做法感到畏缩，所以让我解释一下为什么这是个坏主意。

如果我需要一个给定租户的所有记录，那么我需要在我的分区键上针对`begins_with`执行一个叫做`scan`的操作。`scan`的问题是它检查我表中的每一项。随着我的表的增长，每当我需要运行一个`scan`时，我的读请求单元就会增加，这是相当频繁的，因为我当时编写的数据访问模式会在用户每次访问时发生。花点时间读一下最后一句话。"随着我的桌子越来越大"而不是“随着我的租户的数据增长”随着时间的推移，`scan`将花费越来越多的时间和金钱，却没有太多的解决方案来减缓它。

在 DynamoDB 中收集多条记录的另一种方法是使用`query`而不是`scan`。一个`query`花费较少的时间和读取请求单元，但是反过来需要分区键。所以一个`query`是一个特定分区键的`scan`。这对我来说意味着我需要改造我的数据，使其基于分区键存在，然后将任何额外的排序信息存储在排序键中。这种模式听起来熟悉吗？它应该是，因为它与我在第三段中提到的模式完全相同。我不能告诉你为什么我没有从一开始就这样做，但我们在这里。在几处代码更改之后，使用分区键的单个 ID 和多部分排序键(由 hash `#`分隔的多条排序信息)来备份和运行服务。

以下是我从中学到的东西。分区键的范围应该大一些。我现在认为组合键是一系列信息，范围从最宽到最窄，直到到达一个特定的标识属性，该属性作为排序键的最后一部分存在。例如，我的分区键从一个广泛的范围(租户的 ID)和一个特定的标识属性(用户的 ID)变成了只有广泛范围的信息。如果需要知道某个实体的所有记录，我可以对该实体或分区键(在本例中是租户的 ID)发出查询。如果需要知道该实体记录的子集，我可以对该实体发出另一个查询，在排序关键字上为`begins_with`添加一个条件，包含我正在寻找的记录的更窄范围的标识信息。

当然，围绕访问模式和二级索引的使用可能还需要考虑其他因素，但我现在将把这些留给专业人士来解释。

*原载于 2021 年 6 月 21 日*[*【https://thomasstep.com】*](https://thomasstep.com/blog/determining-dynamodb-primary-and-secondary-keys)*。*