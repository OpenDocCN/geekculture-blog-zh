<html>
<head>
<title>Airflow, dbt, and Postgres</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">气流、dbt和Postgres</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/airflow-dbt-and-postgres-841c37f107ba?source=collection_archive---------6-----------------------#2022-11-08">https://medium.com/geekculture/airflow-dbt-and-postgres-841c37f107ba?source=collection_archive---------6-----------------------#2022-11-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/024113dad37b0c8e7d85e8f93554b6e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t49-NZsv-8SyG4iZcTiRdA.jpeg"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">Photo by <a class="ae hv" href="https://unsplash.com/@carrier_lost?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Ian Taylor</a> on <a class="ae hv" href="https://unsplash.com/s/photos/docker?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><div class=""/><div class=""><h2 id="1d13" class="pw-subtitle-paragraph iv hx hy bd b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm dx translated">厌倦了在数据工程中为PoC重新创建docker映像？我为你创造了一个。</h2></div><h1 id="1695" class="jn jo hy bd jp jq jr js jt ju jv jw jx je jy jf jz jh ka ji kb jk kc jl kd ke bi translated">介绍</h1><p id="589f" class="pw-post-body-paragraph kf kg hy kh b ki kj iz kk kl km jc kn ko kp kq kr ks kt ku kv kw kx ky kz la hb bi translated">不知道你怎么样，但我很喜欢做兼职项目。通常，他们会测试不同的技术/工具，它们是如何交互的，以及我是否能在我的工作中使用它们。</p><p id="85aa" class="pw-post-body-paragraph kf kg hy kh b ki lb iz kk kl lc jc kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">对我来说，流程是创建一些docker映像或docker-compose，如果它由交互应用程序组成，以拥有一个隔离和受控的环境。虽然我不是docker方面的专家，但有时创建环境占整个PoC工作的50%以上。我运行一个PoC，得到一些结果，很少将我的代码提交给GitHub。几个月过去了，一个新的想法突然出现在我的脑海里；突然，我找不到我把代码放在哪里了。几乎每次我这样做，我都有同样的问题。</p><p id="34c3" class="pw-post-body-paragraph kf kg hy kh b ki lb iz kk kl lc jc kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">为了防止这种情况发生在我身上，我将为人们创建多个存储库，他们可以随意使用不同的工具和交互。</p><h1 id="55aa" class="jn jo hy bd jp jq jr js jt ju jv jw jx je jy jf jz jh ka ji kb jk kc jl kd ke bi translated">气流</h1><p id="1c9e" class="pw-post-body-paragraph kf kg hy kh b ki kj iz kk kl km jc kn ko kp kq kr ks kt ku kv kw kx ky kz la hb bi translated">我事实上的计划者。从2019年开始使用它，从一个简单的dag创建者开始，到与一个团队一起从Airflow 1.10.X迁移到2.1.X并应用最佳实践。当我在家的时候，你可以在我的博客上读到:</p><div class="hh hi ez fb hj lg"><a href="https://engineering.hometogo.com/apache-airflow-at-hometogo-8f97a12b2be5" rel="noopener  ugc nofollow" target="_blank"><div class="lh ab dw"><div class="li ab lj cl cj lk"><h2 class="bd hz fi z dy ll ea eb lm ed ef hx bi translated">HomeToGo的阿帕奇气流</h2><div class="ln l"><h3 class="bd b fi z dy ll ea eb lm ed ef dx translated">HomeToGo让数据流与气流协调一致的旅程。我们遇到的困难和问题以及我们如何应对…</h3></div><div class="lo l"><p class="bd b fp z dy ll ea eb lm ed ef dx translated">engineering.hometogo.com</p></div></div><div class="lp l"><div class="lq l lr ls lt lp lu hp lg"/></div></div></a></div><p id="c98f" class="pw-post-body-paragraph kf kg hy kh b ki lb iz kk kl lc jc kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">我选择它是因为我是最熟悉的，但我以后不会只局限于此，所以还会有其他管弦乐队的资料库！</p><p id="3a03" class="pw-post-body-paragraph kf kg hy kh b ki lb iz kk kl lc jc kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">没有Redis和芹菜，我创建的气流图像会更加直观。我在做两台不同的机器，一台作为web服务器，一台作为调度器，当然还有后端DB。</p><figure class="lv lw lx ly fd hk"><div class="bz dy l di"><div class="lz ma l"/></div><figcaption class="hr hs et er es ht hu bd b be z dx">Dockerfile for Airflow</figcaption></figure><p id="6f14" class="pw-post-body-paragraph kf kg hy kh b ki lb iz kk kl lc jc kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">从Dockerfile可以看出，我用的是气流2.4.2搭配Python 3.9。我不打算撒谎；我选择这个Airflow版本是为了稍后测试他们的数据集调度，并熟悉他们的新UI。2.2.2以后我就不查其他版本了。</p><p id="226e" class="pw-post-body-paragraph kf kg hy kh b ki lb iz kk kl lc jc kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">代码本身非常简单。我正在安装多个包，即用于与Postgres DB交互的libpq-dev、用于dbt的git和用于python包的requirements。</p><p id="4804" class="pw-post-body-paragraph kf kg hy kh b ki lb iz kk kl lc jc kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">我创建了两个bash脚本来控制调度程序和web服务器的启动行为。</p><figure class="lv lw lx ly fd hk"><div class="bz dy l di"><div class="lz ma l"/></div><figcaption class="hr hs et er es ht hu bd b be z dx">scheduler entry point script</figcaption></figure><p id="4f69" class="pw-post-body-paragraph kf kg hy kh b ki lb iz kk kl lc jc kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">运行dbt clean和依赖项，如果数据库中不存在data_warehouse DB，则创建它。初始化气流数据库并启动调度程序。</p><p id="95b3" class="pw-post-body-paragraph kf kg hy kh b ki lb iz kk kl lc jc kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">现在，在你走之前，审判我:</p><ul class=""><li id="9cf5" class="mb mc hy kh b ki lb kl lc ko md ks me kw mf la mg mh mi mj bi translated">我从来不知道bash——欢迎所有的评论；乐于改进和学习更好的实践</li><li id="d3ab" class="mb mc hy kh b ki mk kl ml ko mm ks mn kw mo la mg mh mi mj bi translated">硬编码用户名、密码和IP——目前不确定如何用另一种方式，我想我可以使用一些环境变量，并在所有地方添加它们，但是我已经在这里花费了比我希望的更多的时间</li></ul><figure class="lv lw lx ly fd hk"><div class="bz dy l di"><div class="lz ma l"/></div></figure><p id="31b2" class="pw-post-body-paragraph kf kg hy kh b ki lb iz kk kl lc jc kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">网络服务器更简单:</p><ul class=""><li id="b59c" class="mb mc hy kh b ki lb kl lc ko md ks me kw mf la mg mh mi mj bi translated">创建管理员用户</li><li id="1965" class="mb mc hy kh b ki mk kl ml ko mm ks mn kw mo la mg mh mi mj bi translated">启动web服务器</li></ul><p id="2d74" class="pw-post-body-paragraph kf kg hy kh b ki lb iz kk kl lc jc kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">因为我已经从存储库中挂载了dags文件夹—将您的dags放在那里，调度程序将解析它们。</p><h1 id="50ce" class="jn jo hy bd jp jq jr js jt ju jv jw jx je jy jf jz jh ka ji kb jk kc jl kd ke bi translated">dbt</h1><p id="9907" class="pw-post-body-paragraph kf kg hy kh b ki kj iz kk kl km jc kn ko kp kq kr ks kt ku kv kw kx ky kz la hb bi translated">目前我转型的首选工具。安装相对容易——dbt-core包+ dbt-DATABASE包。</p><p id="f36b" class="pw-post-body-paragraph kf kg hy kh b ki lb iz kk kl lc jc kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">只有调整，使可持续发展，我写下了关于使用单独的配置文件。YAML文件的凭据，为PoC不干涉任何签子的事情。我还添加了一个提示，关于它应该如何寻找Postgres。</p><p id="211c" class="pw-post-body-paragraph kf kg hy kh b ki lb iz kk kl lc jc kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">像创建dbt项目一样，在transform/data_warehouse文件夹中创建您的模型。</p><figure class="lv lw lx ly fd hk"><div class="bz dy l di"><div class="lz ma l"/></div></figure><p id="0495" class="pw-post-body-paragraph kf kg hy kh b ki lb iz kk kl lc jc kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">如果你对dbt感兴趣，你也可以看看我关于入门的帖子。</p><div class="hh hi ez fb hj lg"><a href="https://towardsdatascience.com/oh-my-dbt-data-build-tool-ba43e67d2531" rel="noopener follow" target="_blank"><div class="lh ab dw"><div class="li ab lj cl cj lk"><h2 class="bd hz fi z dy ll ea eb lm ed ef hx bi translated">哦，我的dbt(数据构建工具)</h2><div class="ln l"><h3 class="bd b fi z dy ll ea eb lm ed ef dx translated">我的经验和使用这个超级工具一个月的一些注意事项</h3></div><div class="lo l"><p class="bd b fp z dy ll ea eb lm ed ef dx translated">towardsdatascience.com</p></div></div><div class="lp l"><div class="mp l lr ls lt lp lu hp lg"/></div></div></a></div><h1 id="a900" class="jn jo hy bd jp jq jr js jt ju jv jw jx je jy jf jz jh ka ji kb jk kc jl kd ke bi translated">Postgres</h1><p id="817c" class="pw-post-body-paragraph kf kg hy kh b ki kj iz kk kl km jc kn ko kp kq kr ks kt ku kv kw kx ky kz la hb bi translated">为局部气流发展创造docker-compose并不是第一次；很快就能掌握什么在哪里。为什么我现在谈论气流？我把这个段落命名为Postgres。我总是用Postgres作为气流的后端DB。我打心眼里讨厌MySQL，SQLite没有并行性(对于PoC来说是可以的，但是为什么要等待多个任务完成呢？).因为我已经决定让它也成为我的数据仓库DB，而不仅仅是作为气流后端，所以我必须做一些调整。尤其是使用dbt。我必须创建一个包含连接信息(也包括凭证)的YAML文件。问题来了——不知道如何做到这一点，所以我从stack overflow和我在谷歌上找到的其他一些帖子中拼凑了这个美丽的东西。</p><p id="c66a" class="pw-post-body-paragraph kf kg hy kh b ki lb iz kk kl lc jc kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">这非常简单——用相关信息创建一个网络对象，然后在您的服务中使用它。</p><figure class="lv lw lx ly fd hk"><div class="bz dy l di"><div class="lz ma l"/></div></figure><p id="628c" class="pw-post-body-paragraph kf kg hy kh b ki lb iz kk kl lc jc kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">所以每次我启动docker-compose时，我总是在同一个IP和端口上获取我的数据库。</p><h1 id="bd00" class="jn jo hy bd jp jq jr js jt ju jv jw jx je jy jf jz jh ka ji kb jk kc jl kd ke bi translated">运行它</h1><p id="3d70" class="pw-post-body-paragraph kf kg hy kh b ki kj iz kk kl km jc kn ko kp kq kr ks kt ku kv kw kx ky kz la hb bi translated">如果你熟悉docker-compose，跑步也相对容易。</p><pre class="lv lw lx ly fd mq mr ms mt aw mu bi"><span id="21a7" class="mv jo hy mr b fi mw mx l my mz">docker-compose build</span></pre><p id="7fb4" class="pw-post-body-paragraph kf kg hy kh b ki lb iz kk kl lc jc kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">来建立你的形象</p><pre class="lv lw lx ly fd mq mr ms mt aw mu bi"><span id="dbf8" class="mv jo hy mr b fi mw mx l my mz">docker-compose up</span></pre><p id="4a54" class="pw-post-body-paragraph kf kg hy kh b ki lb iz kk kl lc jc kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">经营它。</p><h1 id="8b03" class="jn jo hy bd jp jq jr js jt ju jv jw jx je jy jf jz jh ka ji kb jk kc jl kd ke bi translated">摘要</h1><p id="6dc8" class="pw-post-body-paragraph kf kg hy kh b ki kj iz kk kl km jc kn ko kp kq kr ks kt ku kv kw kx ky kz la hb bi translated">总的来说，乐趣和愉快的经历使这一切运行。我了解了一些网络知识，以及如何让至少一些应用程序使用静态IP来模拟现实生活。</p><p id="bbd6" class="pw-post-body-paragraph kf kg hy kh b ki lb iz kk kl lc jc kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">您可以找到这个存储库:</p><div class="hh hi ez fb hj lg"><a href="https://github.com/TomasPel/airflow_dbt_postgres" rel="noopener  ugc nofollow" target="_blank"><div class="lh ab dw"><div class="li ab lj cl cj lk"><h2 class="bd hz fi z dy ll ea eb lm ed ef hx bi translated">GitHub-to maspel/air flow _ dbt _ postgres</h2><div class="ln l"><h3 class="bd b fi z dy ll ea eb lm ed ef dx translated">当运行一些PoC或尝试不同的工具如何一起玩时，通常我会创建docker映像或创建…</h3></div><div class="lo l"><p class="bd b fp z dy ll ea eb lm ed ef dx translated">github.com</p></div></div><div class="lp l"><div class="na l lr ls lt lp lu hp lg"/></div></div></a></div></div></div>    
</body>
</html>