<html>
<head>
<title>AKS with Cert Manager</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带证书管理器的AKS</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/aks-with-cert-manager-f24786e87b20?source=collection_archive---------0-----------------------#2021-06-28">https://medium.com/geekculture/aks-with-cert-manager-f24786e87b20?source=collection_archive---------0-----------------------#2021-06-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/1869a5f45ab8ed5ffc37de7db8903ec0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e_h47YM0M9_YTI6Nz3f8KQ.png"/></div></div></figure><div class=""/><div class=""><h2 id="7345" class="pw-subtitle-paragraph iq hs ht bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh dx translated">将cert-manager插件与AKS一起使用</h2></div><p id="83a6" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">本文详细介绍了如何使用<a class="ae ke" href="https://en.wikipedia.org/wiki/Transport_Layer_Security" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> TLS </strong> </a>和来自可信<a class="ae ke" href="https://en.wikipedia.org/wiki/Certificate_authority" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> CA </strong> </a>和公共域的证书来保护web流量。这就要用到<a class="ae ke" href="https://letsencrypt.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu">让我们通过一个流行的<a class="ae ke" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu">Kubernetes</strong></a>add-on<a class="ae ke" href="https://cert-manager.io" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu">cert-manager</strong></a>。</strong></a></p><p id="8f04" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">在本文中，我们将使用以下组件:</p><ul class=""><li id="e9f7" class="kf kg ht jk b jl jm jo jp jr kh jv ki jz kj kd kk kl km kn bi translated">Azure资源:<a class="ae ke" href="https://azure.microsoft.com/en-us/services/kubernetes-service/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> AKS </strong> </a>，<a class="ae ke" href="https://azure.microsoft.com/services/dns/" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu">Azure DNS</strong></a>zone</li><li id="3fbe" class="kf kg ht jk b jl ko jo kp jr kq jv kr jz ks kd kk kl km kn bi translated">Kubernetes附加组件:<a class="ae ke" href="https://cert-manager.io" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu">证书管理器</strong> </a>，<a class="ae ke" href="https://github.com/kubernetes-sigs/external-dns" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu">外部-dns </strong> </a>，<a class="ae ke" href="https://github.com/kubernetes/ingress-nginx" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu">入口-nginx </strong> </a></li><li id="dc47" class="kf kg ht jk b jl ko jo kp jr kq jv kr jz ks kd kk kl km kn bi translated">应用示例:<a class="ae ke" href="https://github.com/paulbouwer/hello-kubernetes" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu">hello-kubernetes</strong></a>，<a class="ae ke" href="https://dgraph.io/" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu">Dgraph</strong></a><strong class="jk hu"/>(<a class="ae ke" href="https://artifacthub.io/packages/helm/dgraph/dgraph" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu">Dgraph掌舵图</strong> </a>)</li></ul><p id="d76e" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">⚠️ <strong class="jk hu">警告</strong>:这使用kublet身份，一个分配给集群中所有节点的身份或主体，来访问Azure DNS。这意味着群集上的所有容器都有权读取/写入域的DNS记录。虽然这对于有限的测试环境可能没什么问题，但是这种<strong class="jk hu">永远不应该用于生产</strong>。这违反了<a class="ae ke" href="https://en.wikipedia.org/wiki/Principle_of_least_privilege" rel="noopener ugc nofollow" target="_blank">最小特权原则</a>。配置访问的备选方案是<a class="ae ke" href="https://github.com/Azure/aad-pod-identity" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> AAD Pod标识</strong> </a>或更近的<a class="ae ke" href="https://azure.github.io/azure-workload-identity/docs/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu">工作负载标识</strong> </a>。</p><h2 id="d598" class="kt ku ht bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln bi translated">证书管理器概述</h2><p id="a6d5" class="pw-post-body-paragraph ji jj ht jk b jl lo iu jn jo lp ix jq jr lq jt ju jv lr jx jy jz ls kb kc kd hb bi translated">保护web应用程序或服务的一个常见场景是使用<a class="ae ke" href="https://en.wikipedia.org/wiki/Transport_Layer_Security" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> TLS </strong> </a>证书加密流量，加密将在负载平衡器处终止。在<a class="ae ke" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> Kubernetes </strong> </a>到来之前，<a class="ae ke" href="https://www.nginx.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> nginx </strong> </a>是这一过程的流行解决方案。</p><p id="fc38" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">在<a class="ae ke" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> Kubernetes </strong> </a>平台上，<a class="ae ke" href="https://kubernetes.io/docs/concepts/services-networking/ingress/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> ingress </strong> </a>资源通过<a class="ae ke" href="https://github.com/kubernetes/ingress-nginx" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu">ingress-nginx</strong></a>控制器执行<a class="ae ke" href="https://en.wikipedia.org/wiki/TLS_termination_proxy" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> TLS终止</strong> </a>。这允许从用户到端点的安全通信，而端点后面的一切都没有加密，从而允许更容易的配置、监控和调试。</p><figure class="lu lv lw lx fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lt"><img src="../Images/5f912a6d2e712014153e88c73ee86c0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mx6EBxp0sE3VVzCidPmqSw.png"/></div></div><figcaption class="ly lz et er es ma mb bd b be z dx"><strong class="bd kv">cert-manager process</strong></figcaption></figure><p id="3df6" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><a class="ae ke" href="https://cert-manager.io" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu">证书管理器</strong> </a>插件将监控<a class="ae ke" href="https://kubernetes.io/docs/concepts/services-networking/ingress/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu">入口</strong> </a>事件，然后安装或更新证书以用于网络流量加密。这发生在以下步骤中:</p><ol class=""><li id="85d9" class="kf kg ht jk b jl jm jo jp jr kh jv ki jz kj kd mc kl km kn bi translated"><a class="ae ke" href="https://cert-manager.io" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> cert-manager </strong> </a>向由<a class="ae ke" href="https://letsencrypt.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu">管理的<a class="ae ke" href="https://en.wikipedia.org/wiki/Automated_Certificate_Management_Environment" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> ACME </strong> </a> CA提交订单，让我们加密</strong> </a>。</li><li id="e52d" class="kf kg ht jk b jl ko jo kp jr kq jv kr jz ks kd mc kl km kn bi translated">在Azure DNS上进行挑战(<code class="du md me mf mg b">DNS01</code>)以读取/写入DNS记录，从而证明用户拥有该域。</li><li id="1476" class="kf kg ht jk b jl ko jo kp jr kq jv kr jz ks kd mc kl km kn bi translated">当挑战被满足时，由一个<a class="ae ke" href="https://en.wikipedia.org/wiki/Automated_Certificate_Management_Environment" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> ACME </strong> </a> CA发布一个证书。</li><li id="a3f8" class="kf kg ht jk b jl ko jo kp jr kq jv kr jz ks kd mc kl km kn bi translated"><a class="ae ke" href="https://cert-manager.io" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu">证书管理器</strong> </a>随后将使用证书创建秘密，入口控制器将使用该秘密来保护web流量。</li></ol><h1 id="798e" class="mh ku ht bd kv mi mj mk kz ml mm mn ld iz mo ja lg jc mp jd lj jf mq jg lm mr bi translated">系列文章</h1><p id="c114" class="pw-post-body-paragraph ji jj ht jk b jl lo iu jn jo lp ix jq jr lq jt ju jv lr jx jy jz ls kb kc kd hb bi translated">这些文章是系列文章的一部分，下面是系列文章的列表。</p><ol class=""><li id="5be7" class="kf kg ht jk b jl jm jo jp jr kh jv ki jz kj kd mc kl km kn bi translated"><a class="ae ke" href="https://joachim8675309.medium.com/extending-aks-with-external-dns-3da2703b9d52" rel="noopener">带外部dns的AK</a>:<code class="du md me mf mg b">service</code>带<code class="du md me mf mg b">LoadBalancer</code>类型</li><li id="4528" class="kf kg ht jk b jl ko jo kp jr kq jv kr jz ks kd mc kl km kn bi translated"><a class="ae ke" href="https://joachim8675309.medium.com/aks-with-ingress-nginx-7c51da500f69" rel="noopener">带ingress-nginx的AK</a>:<code class="du md me mf mg b">ingress</code>(HTTP)</li><li id="0de8" class="kf kg ht jk b jl ko jo kp jr kq jv kr jz ks kd mc kl km kn bi translated"><a class="ae ke" rel="noopener" href="/geekculture/aks-with-cert-manager-f24786e87b20"> <strong class="jk hu">带证书管理器的AKS</strong></a><strong class="jk hu">:</strong><code class="du md me mf mg b"><strong class="jk hu">ingress</strong></code><strong class="jk hu">【HTTPS】</strong></li><li id="1ef8" class="kf kg ht jk b jl ko jo kp jr kq jv kr jz ks kd mc kl km kn bi translated"><a class="ae ke" href="https://joachim8675309.medium.com/aks-with-grpc-and-ingress-nginx-32481a792a1" rel="noopener">带GRPC和ingress-nginx的AK</a>:<code class="du md me mf mg b">ingress</code>(GRPC和HTTPS)</li></ol><h2 id="5bec" class="kt ku ht bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln bi translated">以前的文章</h2><p id="fb7b" class="pw-post-body-paragraph ji jj ht jk b jl lo iu jn jo lp ix jq jr lq jt ju jv lr jx jy jz ls kb kc kd hb bi translated"><strong class="jk hu"><em class="ms">AKS+ingress-ginx+external-DNS</em>:</strong>在上一篇文章中我介绍了如何部署<a class="ae ke" href="https://github.com/kubernetes/ingress-nginx" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu">ingress-nginx</strong></a>以及<a class="ae ke" href="https://github.com/kubernetes-sigs/external-dns" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> external-dns </strong> </a>:</p><div class="hh hi ez fb hj mt"><a href="https://joachim8675309.medium.com/aks-with-ingress-nginx-7c51da500f69" rel="noopener follow" target="_blank"><div class="mu ab dw"><div class="mv ab mw cl cj mx"><h2 class="bd hu fi z dy my ea eb mz ed ef hs bi translated">带入口的AKS-nginx</h2><div class="na l"><h3 class="bd b fi z dy my ea eb mz ed ef dx translated">将ingress-nginx插件与Azure LB和AKS一起使用</h3></div><div class="nb l"><p class="bd b fp z dy my ea eb mz ed ef dx translated">joachim8675309.medium.com</p></div></div><div class="nc l"><div class="nd l ne nf ng nc nh hp mt"/></div></div></a></div><p id="3a0e" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu"> <em class="ms"> AKS +外部dns </em> : </strong>在本系列的第一篇文章中，我介绍了如何部署<a class="ae ke" href="https://github.com/kubernetes-sigs/external-dns" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu">外部dns </strong> </a>以用于<code class="du md me mf mg b">LoadBalancer</code>类型的服务。</p><div class="hh hi ez fb hj mt"><a href="https://joachim8675309.medium.com/extending-aks-with-external-dns-3da2703b9d52" rel="noopener follow" target="_blank"><div class="mu ab dw"><div class="mv ab mw cl cj mx"><h2 class="bd hu fi z dy my ea eb mz ed ef hs bi translated">带外部DNS的AK</h2><div class="na l"><h3 class="bd b fi z dy my ea eb mz ed ef dx translated">将外部dns插件与Azure DNS和AKS一起使用</h3></div><div class="nb l"><p class="bd b fp z dy my ea eb mz ed ef dx translated">joachim8675309.medium.com</p></div></div><div class="nc l"><div class="ni l ne nf ng nc nh hp mt"/></div></div></a></div><h1 id="767b" class="mh ku ht bd kv mi mj mk kz ml mm mn ld iz mo ja lg jc mp jd lj jf mq jg lm mr bi translated">要求</h1><p id="6931" class="pw-post-body-paragraph ji jj ht jk b jl lo iu jn jo lp ix jq jr lq jt ju jv lr jx jy jz ls kb kc kd hb bi translated">本文的一些逻辑和工具需求如下:</p><h2 id="3459" class="kt ku ht bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln bi translated">注册域名</h2><p id="68c9" class="pw-post-body-paragraph ji jj ht jk b jl lo iu jn jo lp ix jq jr lq jt ju jv lr jx jy jz ls kb kc kd hb bi translated">当使用受信任的<a class="ae ke" href="https://en.wikipedia.org/wiki/Transport_Layer_Security" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> TLS </strong> </a>证书(或者换句话说，由受信任的<a class="ae ke" href="https://en.wikipedia.org/wiki/Certificate_authority" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> CA </strong> </a>颁发的证书)来保护web流量时，您需要拥有一个<em class="ms">公共域名</em>，它可以从提供商那里购买，每年大约2到20美元。</p><p id="9f2c" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">将使用一个虚构的域<code class="du md me mf mg b">example.com</code>作为示例。因此，根据所使用的示例，可能会有<code class="du md me mf mg b">hello.example.com</code>、<code class="du md me mf mg b">ratel.example.com</code>和<code class="du md me mf mg b">alpha.example.com</code>。</p><h2 id="e5f8" class="kt ku ht bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln bi translated">所需工具</h2><figure class="lu lv lw lx fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es nj"><img src="../Images/a1d02e3b62758a6868ca4b6217aac2ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hLryfJOgFjXHsLUG1T4Pyw.png"/></div></div></figure><p id="8676" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">本文需要这些工具:</p><ul class=""><li id="7b45" class="kf kg ht jk b jl jm jo jp jr kh jv ki jz kj kd kk kl km kn bi translated"><a class="ae ke" href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> Azure CLI工具</strong> </a> ( <code class="du md me mf mg b">az</code>):与Azure API交互的命令行工具</li><li id="9e2b" class="kf kg ht jk b jl ko jo kp jr kq jv kr jz ks kd kk kl km kn bi translated"><a class="ae ke" href="https://kubernetes.io/docs/tasks/tools/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> Kubernetes客户端工具</strong> </a> ( <code class="du md me mf mg b">kubectl</code>):与Kubernetes API交互的命令行工具</li><li id="b119" class="kf kg ht jk b jl ko jo kp jr kq jv kr jz ks kd kk kl km kn bi translated"><a class="ae ke" href="https://helm.sh/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> Helm </strong> </a> ( <code class="du md me mf mg b">helm</code>):命令行工具，用于“<em class="ms">模板化和共享Kubernetes清单</em>”，捆绑为Helm chart包。</li><li id="6ac8" class="kf kg ht jk b jl ko jo kp jr kq jv kr jz ks kd kk kl km kn bi translated"><a class="ae ke" href="https://github.com/databus23/helm-diff" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> helm-diff </strong> </a>插件:允许您在应用更改之前查看用<code class="du md me mf mg b">helm</code>或<code class="du md me mf mg b">helmfile</code>所做的更改。</li><li id="851e" class="kf kg ht jk b jl ko jo kp jr kq jv kr jz ks kd kk kl km kn bi translated"><a class="ae ke" href="https://github.com/roboll/helmfile" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu">Helm file</strong></a>(<code class="du md me mf mg b">helmfile</code>):命令行工具，使用“<em class="ms">声明性规范在多种环境中部署舵图</em>”。</li></ul><h2 id="3f53" class="kt ku ht bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln bi translated">可选工具</h2><figure class="lu lv lw lx fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es nk"><img src="../Images/d8cb2ed0b3aa43553d23e931d6e50d3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YBMvFQE5uLfrdn2CrpIhSg.png"/></div></div></figure><p id="b349" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">我强烈推荐这些工具:</p><ul class=""><li id="5aab" class="kf kg ht jk b jl jm jo jp jr kh jv ki jz kj kd kk kl km kn bi translated"><a class="ae ke" href="https://pubs.opengroup.org/onlinepubs/9699919799/utilities/V3_chap02.html" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu">POSIX shell</strong></a><strong class="jk hu"/>(<code class="du md me mf mg b">sh</code>)如<a class="ae ke" href="https://www.gnu.org/software/bash/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> GNU Bash </strong> </a> ( <code class="du md me mf mg b">bash</code>)或<a class="ae ke" href="https://www.zsh.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> Zsh </strong> </a> ( <code class="du md me mf mg b">zsh</code>):本指南中的这些脚本已经在macOS和Ubuntu Linux上使用这些shell中的任何一个进行了测试。</li><li id="8d21" class="kf kg ht jk b jl ko jo kp jr kq jv kr jz ks kd kk kl km kn bi translated"><a class="ae ke" href="https://curl.se/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> curl </strong> </a> ( <code class="du md me mf mg b">curl</code>):从命令行与web服务交互的工具。</li><li id="e977" class="kf kg ht jk b jl ko jo kp jr kq jv kr jz ks kd kk kl km kn bi translated"><a class="ae ke" href="https://stedolan.github.io/jq/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> jq </strong> </a> ( <code class="du md me mf mg b">jq</code>):一个JSON处理器工具，可以从JSON中转换和提取对象，并为彩色JSON输出提供更好的可读性。</li></ul><h1 id="0701" class="mh ku ht bd kv mi mj mk kz ml mm mn ld iz mo ja lg jc mp jd lj jf mq jg lm mr bi translated">项目设置</h1><p id="b18d" class="pw-post-body-paragraph ji jj ht jk b jl lo iu jn jo lp ix jq jr lq jt ju jv lr jx jy jz ls kb kc kd hb bi translated">由于这个项目有几个活动部分(<a class="ae ke" href="https://docs.microsoft.com/azure/dns/dns-overview" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> Azure DNS </strong> </a>，<a class="ae ke" href="https://azure.microsoft.com/en-us/services/kubernetes-service/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> AKS </strong> </a>，<a class="ae ke" href="https://cert-manager.io" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> cert-manager </strong> </a>，<a class="ae ke" href="https://github.com/kubernetes-sigs/external-dns" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> external-dns </strong> </a>，<a class="ae ke" href="https://github.com/kubernetes/ingress-nginx" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu">inginx</strong></a>)以及示例应用<a class="ae ke" href="https://dgraph.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> Dgraph </strong> </a>和<a class="ae ke" href="https://github.com/paulbouwer/hello-kubernetes" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu">你好</strong></a></p><h2 id="1e0f" class="kt ku ht bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln bi translated">项目文件结构</h2><p id="7096" class="pw-post-body-paragraph ji jj ht jk b jl lo iu jn jo lp ix jq jr lq jt ju jv lr jx jy jz ls kb kc kd hb bi translated">将使用以下结构:</p><pre class="lu lv lw lx fd nl mg nm nn aw no bi"><span id="d369" class="kt ku ht mg b fi np nq l nr ns">~/azure_cert_manager/<br/>├── env.sh<br/>├── examples<br/>│   ├── dgraph<br/>│   │   └── helmfile.yaml<br/>│   └── hello<br/>│       └── helmfile.yaml<br/>└── helmfile.yaml</span></pre><p id="bdb3" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">使用<a class="ae ke" href="https://www.gnu.org/software/bash/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> Bash </strong> </a>或<a class="ae ke" href="https://www.zsh.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> Zsh </strong> </a>，您可以使用以下命令创建文件结构:</p><pre class="lu lv lw lx fd nl mg nm nn aw no bi"><span id="b535" class="kt ku ht mg b fi np nq l nr ns"><strong class="mg hu">mkdir</strong> -p ~/azure_cert_manager/examples/{dgraph,hello} &amp;&amp; \<br/>  <strong class="mg hu">cd</strong> ~/azure_cert_manager<br/>  <br/><strong class="mg hu">touch</strong> \<br/>  env.sh \<br/>  helmfile.yaml \<br/>  ./examples/{dgraph,hello}/helmfile.yaml</span></pre><p id="426c" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">这些指令从这一点开始将假设您在<code class="du md me mf mg b">~/azure_ingress_nginx</code>目录中，所以当有疑问时:</p><pre class="lu lv lw lx fd nl mg nm nn aw no bi"><span id="29eb" class="kt ku ht mg b fi np nq l nr ns"><strong class="mg hu">cd</strong> ~/azure_cert_manager</span></pre><h2 id="66a4" class="kt ku ht bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln bi translated">项目环境变量</h2><p id="09e8" class="pw-post-body-paragraph ji jj ht jk b jl lo iu jn jo lp ix jq jr lq jt ju jv lr jx jy jz ls kb kc kd hb bi translated">在下面设置这些环境变量，以保持各种工具之间的一致性:<code class="du md me mf mg b"><a class="ae ke" href="https://helm.sh/" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu">helm</strong></a></code>、<code class="du md me mf mg b"><a class="ae ke" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu">helmfile</strong></a></code>、<code class="du md me mf mg b"><a class="ae ke" href="https://kubernetes.io/docs/tasks/tools/#kubectl" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu">kubectl</strong></a></code>、<code class="du md me mf mg b"><a class="ae ke" href="https://stedolan.github.io/jq/" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu">jq</strong></a></code>、<code class="du md me mf mg b"><a class="ae ke" href="https://docs.microsoft.com/cli/azure/install-azure-cli" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu">az</strong></a></code>、<strong class="jk hu">。</strong></p><p id="5dd6" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">如果您使用的是一个<a class="ae ke" href="https://pubs.opengroup.org/onlinepubs/9699919799/utilities/V3_chap02.html" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> POSIX shell </strong> </a>，您可以将它们保存到一个脚本中，并在需要时获取该脚本。复制该源脚本并另存为<code class="du md me mf mg b">env.sh</code>:</p><figure class="lu lv lw lx fd hk"><div class="bz dy l di"><div class="nt nu l"/></div></figure><h1 id="f229" class="mh ku ht bd kv mi mj mk kz ml mm mn ld iz mo ja lg jc mp jd lj jf mq jg lm mr bi translated">Azure组件</h1><p id="b880" class="pw-post-body-paragraph ji jj ht jk b jl lo iu jn jo lp ix jq jr lq jt ju jv lr jx jy jz ls kb kc kd hb bi translated">下面是需要的<a class="ae ke" href="https://azure.microsoft.com" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> Azure </strong> </a>具体配置。您可以使用下面的内容，以前文章中的材料，或者您自己的自动化提供的资源。</p><p id="2fcc" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">如果您使用自己的自动化来供应<a class="ae ke" href="https://azure.microsoft.com" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> Azure </strong> </a>云资源，您将需要记住这些要求:</p><ul class=""><li id="2c57" class="kf kg ht jk b jl jm jo jp jr kh jv ki jz kj kd kk kl km kn bi translated"><em class="ms">域控制</em>:域控制必须从您的域提供商传递到<a class="ae ke" href="https://docs.microsoft.com/azure/dns/dns-overview" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> Azure DNS </strong> </a>域，或者如果使用子域，将NS记录指向托管子域的<a class="ae ke" href="https://docs.microsoft.com/azure/dns/dns-overview" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> Azure DNS </strong> </a>名称服务器。</li><li id="55bc" class="kf kg ht jk b jl ko jo kp jr kq jv kr jz ks kd kk kl km kn bi translated"><em class="ms">具有托管身份的AK</em>:<a class="ae ke" href="https://azure.microsoft.com/services/kubernetes-service/" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu">AK</strong></a>(<a class="ae ke" href="https://azure.microsoft.com/services/kubernetes-service/" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu">Azure Kubernetes服务</strong> </a>)必须为<a class="ae ke" href="https://docs.microsoft.com/azure/virtual-machine-scale-sets/overview" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu">【VMSS】</strong></a>(<a class="ae ke" href="https://docs.microsoft.com/azure/virtual-machine-scale-sets/overview" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu">虚拟机规模集</strong> </a>)创建的Kubernetes工作节点启用托管身份</li></ul><h2 id="febb" class="kt ku ht bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln bi translated">资源组</h2><p id="53a0" class="pw-post-body-paragraph ji jj ht jk b jl lo iu jn jo lp ix jq jr lq jt ju jv lr jx jy jz ls kb kc kd hb bi translated">在<a class="ae ke" href="https://azure.microsoft.com" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> Azure </strong> </a>中，资源被组织在资源组下。</p><pre class="lu lv lw lx fd nl mg nm nn aw no bi"><span id="3da6" class="kt ku ht mg b fi np nq l nr ns"><strong class="mg hu">source</strong> env.sh</span><span id="089c" class="kt ku ht mg b fi nv nq l nr ns"><strong class="mg hu">az</strong> group create <strong class="mg hu">\<br/>  --resource-group</strong> <strong class="mg hu">${AZ_RESOURCE_GROUP}</strong> \<br/>  <strong class="mg hu">--location</strong> <strong class="mg hu">${AZ_LOCATION}</strong></span></pre><h2 id="0419" class="kt ku ht bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln bi translated">云资源</h2><p id="0ba2" class="pw-post-body-paragraph ji jj ht jk b jl lo iu jn jo lp ix jq jr lq jt ju jv lr jx jy jz ls kb kc kd hb bi translated">为简单起见，您可以使用以下内容创建该项目所需的资源:</p><pre class="lu lv lw lx fd nl mg nm nn aw no bi"><span id="ae56" class="kt ku ht mg b fi np nq l nr ns"><strong class="mg hu">source</strong> env.sh</span><span id="169b" class="kt ku ht mg b fi nv nq l nr ns"><strong class="mg hu">az</strong> network dns zone create <strong class="mg hu">\<br/>  --resource-group</strong> <strong class="mg hu">${AZ_RESOURCE_GROUP}</strong> \<br/>  <strong class="mg hu">--name</strong> <strong class="mg hu">${AZ_CLUSTER_NAME}az</strong> aks create \<br/>  <strong class="mg hu">--resource-group</strong> <strong class="mg hu">${AZ_RESOURCE_GROUP}</strong> \<br/>  <strong class="mg hu">--name</strong> <strong class="mg hu">${AZ_CLUSTER_NAME}</strong> \<br/>  <strong class="mg hu">--generate-ssh-keys</strong> \<br/>  <strong class="mg hu">--vm-set-type</strong> VirtualMachineScaleSets \<br/>  <strong class="mg hu">--node-vm-size</strong> <strong class="mg hu">${AZ_VM_SIZE</strong>:-Standard_DS2_v2<strong class="mg hu">}</strong> \<br/>  <strong class="mg hu">--load-balancer-sku</strong> standard \<br/>  <strong class="mg hu">--enable-managed-identity</strong> \<br/>  <strong class="mg hu">--node-count</strong> 3 \<br/>  <strong class="mg hu">--zones</strong> 1 2 3</span><span id="5b82" class="kt ku ht mg b fi nv nq l nr ns"><strong class="mg hu">az</strong> aks get-credentials \<br/>  <strong class="mg hu">--resource-group</strong> <strong class="mg hu">${AZ_RESOURCE_GROUP}</strong> \<br/>  <strong class="mg hu">--name</strong> <strong class="mg hu">${AZ_CLUSTER_NAME}</strong> \<br/>  <strong class="mg hu">--file</strong> <strong class="mg hu">${KUBECONFIG</strong>:-<strong class="mg hu">$HOME</strong>/.kube/config<strong class="mg hu">}</strong></span></pre><p id="1618" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">对于像<code class="du md me mf mg b">example.com</code>这样的根域，您需要将域管理转移到<a class="ae ke" href="https://azure.microsoft.com/services/dns/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> Azure DNS </strong> </a>，或者如果您正在使用像<code class="du md me mf mg b">dev.example.com</code>这样的子域，您需要更新DNS名称空间记录以指向<a class="ae ke" href="https://azure.microsoft.com/services/dns/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> Azure DNS </strong> </a>名称服务器。在<a class="ae ke" href="https://joachim8675309.medium.com/azure-linux-vm-with-dns-e54076bab296" rel="noopener"><strong class="jk hu">Azure Linux VM with DNS</strong></a>一文中，详细介绍了这一过程以及如何使用Terraform进行配置。</p><p id="544e" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">有关更强大的配置脚本<a class="ae ke" href="https://azure.microsoft.com/services/kubernetes-service/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> Azure Kubernetes服务</strong> </a>，请参见文章<a class="ae ke" href="https://joachim8675309.medium.com/azure-kubernetes-service-b89cc52b7f02" rel="noopener"> <strong class="jk hu"> Azure Kubernetes服务:使用Azure CLI </strong> </a>配置AKS Kubernetes集群。</p><h2 id="14df" class="kt ku ht bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln bi translated">授权访问Azure DNS</h2><p id="f05e" class="pw-post-body-paragraph ji jj ht jk b jl lo iu jn jo lp ix jq jr lq jt ju jv lr jx jy jz ls kb kc kd hb bi translated">我们需要允许访问<a class="ae ke" href="https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> <em class="ms">托管身份</em> </strong> </a>安装在<a class="ae ke" href="https://docs.microsoft.com/azure/virtual-machine-scale-sets/overview" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu"/></a>节点池中的<a class="ae ke" href="https://azure.microsoft.com/services/dns/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> Azure DNS </strong> </a>区域的工作人员。这将允许任何运行<a class="ae ke" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu">Kubernetes</strong></a>worker节点的pod访问<a class="ae ke" href="https://azure.microsoft.com/services/dns/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> Azure DNS </strong> </a>区域。</p><p id="fe66" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu">注意</strong> : A <a class="ae ke" href="https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> <em class="ms">托管身份</em> </strong> </a>是服务主体的包装器，使管理更加简单。本质上，它们被映射到一个<a class="ae ke" href="https://azure.microsoft.com" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> Azure </strong> </a>资源，这样当<a class="ae ke" href="https://azure.microsoft.com" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> Azure </strong> </a>资源不再存在时，关联的<a class="ae ke" href="https://docs.microsoft.com/cli/azure/create-an-azure-service-principal-azure-cli" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu">服务主体</strong> </a>将被移除。</p><figure class="lu lv lw lx fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es nw"><img src="../Images/605751227e6c54ff709998b25eda5f93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hlk35pxjgovLAxMl00BhqQ.png"/></div></div><figcaption class="ly lz et er es ma mb bd b be z dx"><strong class="bd kv">Managed Identity authorized to access Azure DNS</strong></figcaption></figure><p id="8221" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">运行以下命令提取作用域和服务主体对象id，并使用这些命令授予访问权限:</p><pre class="lu lv lw lx fd nl mg nm nn aw no bi"><span id="085f" class="kt ku ht mg b fi np nq l nr ns"><strong class="mg hu">source</strong> env.sh</span><span id="cf78" class="kt ku ht mg b fi nv nq l nr ns"><strong class="mg hu">export AZ_DNS_SCOPE</strong>=$(<br/>  <strong class="mg hu">az</strong> network dns zone list \<br/>    <strong class="mg hu">--query</strong> "[?name=='<strong class="mg hu">$AZ_DNS_DOMAIN</strong>'].id" <strong class="mg hu">\<br/>    --output</strong> tsv<br/>)</span><span id="2f33" class="kt ku ht mg b fi nv nq l nr ns"><strong class="mg hu">export</strong> <strong class="mg hu">AZ_PRINCIPAL_ID</strong>=$(<br/>  az aks show <strong class="mg hu">\<br/>    --resource-group $AZ_RESOURCE_GROUP \<br/>    --name $AZ_CLUSTER_NAME</strong> \<br/>    <strong class="mg hu">--query</strong> "identityProfile.kubeletidentity.objectId" \<br/>    --output tsv<br/>)</span><span id="742d" class="kt ku ht mg b fi nv nq l nr ns"><strong class="mg hu">az</strong> role assignment create \<br/>  <strong class="mg hu">--assignee</strong> "<strong class="mg hu">$AZ_PRINCIPAL_ID</strong>" \<br/>  <strong class="mg hu">--role</strong> "DNS Zone Contributor" \<br/>  <strong class="mg hu">--scope</strong> "<strong class="mg hu">$AZ_DNS_SCOPE</strong>"</span></pre><h1 id="ca1e" class="mh ku ht bd kv mi mj mk kz ml mm mn ld iz mo ja lg jc mp jd lj jf mq jg lm mr bi translated">Kubernetes组件</h1><p id="2611" class="pw-post-body-paragraph ji jj ht jk b jl lo iu jn jo lp ix jq jr lq jt ju jv lr jx jy jz ls kb kc kd hb bi translated">可以使用下面的脚本安装<a class="ae ke" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> Kubernetes </strong> </a>附加组件。</p><h2 id="0352" class="kt ku ht bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln bi translated">安装证书管理器</h2><p id="b154" class="pw-post-body-paragraph ji jj ht jk b jl lo iu jn jo lp ix jq jr lq jt ju jv lr jx jy jz ls kb kc kd hb bi translated">复制以下脚本并另存为<code class="du md me mf mg b">helmfile.yaml</code>:</p><figure class="lu lv lw lx fd hk"><div class="bz dy l di"><div class="nt nu l"/></div></figure><p id="e29c" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">准备就绪后，只需运行:</p><pre class="lu lv lw lx fd nl mg nm nn aw no bi"><span id="c2d0" class="kt ku ht mg b fi np nq l nr ns"><strong class="mg hu">source</strong> env.sh</span><span id="863a" class="kt ku ht mg b fi nv nq l nr ns"><strong class="mg hu">helmfile</strong> apply</span></pre><h2 id="c91f" class="kt ku ht bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln bi translated">安装证书管理器群集颁发者</h2><p id="62d1" class="pw-post-body-paragraph ji jj ht jk b jl lo iu jn jo lp ix jq jr lq jt ju jv lr jx jy jz ls kb kc kd hb bi translated">复制以下内容并另存为<code class="du md me mf mg b">issuers.yaml</code>:</p><figure class="lu lv lw lx fd hk"><div class="bz dy l di"><div class="nt nu l"/></div></figure><p id="3efd" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">在<a class="ae ke" href="https://cert-manager.io" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu">证书管理器</strong> </a>容器准备就绪并上线之前，需要几秒钟时间。准备就绪后，运行以下命令:</p><pre class="lu lv lw lx fd nl mg nm nn aw no bi"><span id="7c1d" class="kt ku ht mg b fi np nq l nr ns"><strong class="mg hu">export ACME_ISSUER_EMAIL</strong>="&lt;your-email-goes-here&gt;"<strong class="mg hu"><br/>source</strong> env.sh<br/><strong class="mg hu">helmfile</strong> <strong class="mg hu">--file</strong> issuers.yaml apply</span></pre><h1 id="d750" class="mh ku ht bd kv mi mj mk kz ml mm mn ld iz mo ja lg jc mp jd lj jf mq jg lm mr bi translated">Kubernetes示例:hello-kubernetes</h1><p id="2631" class="pw-post-body-paragraph ji jj ht jk b jl lo iu jn jo lp ix jq jr lq jt ju jv lr jx jy jz ls kb kc kd hb bi translated"><a class="ae ke" href="https://github.com/paulbouwer/hello-kubernetes" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu">hello-kubernetes</strong></a>是一个打印pod名称的简单应用程序。下面的<a class="ae ke" href="https://github.com/roboll/helmfile" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> helmfile </strong> </a>脚本，就是简单地将raw<a class="ae ke" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu">Kubernetes</strong></a>清单折叠成一个helm图表以便我们可以使用动态值，将执行以下操作:</p><ul class=""><li id="e4bc" class="kf kg ht jk b jl jm jo jp jr kh jv ki jz kj kd kk kl km kn bi translated">部署一个<code class="du md me mf mg b">Deployment</code>来管理3个吊舱</li><li id="5a0a" class="kf kg ht jk b jl ko jo kp jr kq jv kr jz ks kd kk kl km kn bi translated">部署一个指向吊舱的<code class="du md me mf mg b">Service</code></li><li id="3347" class="kf kg ht jk b jl ko jo kp jr kq jv kr jz ks kd kk kl km kn bi translated">部署一个<code class="du md me mf mg b">Ingress</code>(使用<a class="ae ke" href="https://github.com/kubernetes/ingress-nginx" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu">inginx</strong></a><strong class="jk hu">)</strong>，配置一条路由将流量定向到<code class="du md me mf mg b">Service</code>。使用一个<a class="ae ke" href="https://en.wikipedia.org/wiki/Fully_qualified_domain_name" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> FQDN </strong> </a>主机名，例如<code class="du md me mf mg b">hello.example.com</code>。</li></ul><p id="bc84" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">入口资源还将执行以下神奇的自动化操作:</p><ul class=""><li id="076e" class="kf kg ht jk b jl jm jo jp jr kh jv ki jz kj kd kk kl km kn bi translated">指示<a class="ae ke" href="https://github.com/kubernetes-sigs/external-dns" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu">外部dns </strong> </a>在<a class="ae ke" href="https://azure.microsoft.com/services/dns/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> Azure DNS </strong> </a>区域建立记录，例如<code class="du md me mf mg b">hello.example.com</code>。</li><li id="ac48" class="kf kg ht jk b jl ko jo kp jr kq jv kr jz ks kd kk kl km kn bi translated">使用通过<a class="ae ke" href="https://cert-manager.io" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> cert-manager </strong> </a>指定的颁发者颁发证书以保护流量。</li></ul><figure class="lu lv lw lx fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es nx"><img src="../Images/90eddf53b7179927f28037b1dbf6018a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZSKyfPSqYkLGcoTOgajpKA.png"/></div></div><figcaption class="ly lz et er es ma mb bd b be z dx"><strong class="bd kv">Example</strong>: hello-kubernetes</figcaption></figure><p id="2e40" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">复制下面的文件并另存为<code class="du md me mf mg b">examples/hello/helmfile.yaml</code>:</p><figure class="lu lv lw lx fd hk"><div class="bz dy l di"><div class="nt nu l"/></div></figure><h2 id="0fdf" class="kt ku ht bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln bi translated">与临时发行者一起部署</h2><p id="321a" class="pw-post-body-paragraph ji jj ht jk b jl lo iu jn jo lp ix jq jr lq jt ju jv lr jx jy jz ls kb kc kd hb bi translated">要测试功能，请运行以下命令</p><pre class="lu lv lw lx fd nl mg nm nn aw no bi"><span id="2258" class="kt ku ht mg b fi np nq l nr ns"><strong class="mg hu">source</strong> env.sh<br/><strong class="mg hu">export ACME_ISSUER</strong>=letsencrypt-staging</span><span id="393d" class="kt ku ht mg b fi nv nq l nr ns"><strong class="mg hu">helmfile</strong> <strong class="mg hu">--file</strong>  ./examples/hello/helmfile.yaml apply</span></pre><p id="289e" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">然后验证资源是否已部署:</p><pre class="lu lv lw lx fd nl mg nm nn aw no bi"><span id="8ddf" class="kt ku ht mg b fi np nq l nr ns"><strong class="mg hu">kubectl</strong> get all,ing,certificate <strong class="mg hu">--namespace</strong> hello</span></pre><p id="e4e7" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">这应该是这样的:</p><figure class="lu lv lw lx fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ny"><img src="../Images/47003d9c8a215a22a24bb104193c3f80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5eYDEww3NmA6aVS9NmP5wA.png"/></div></div><figcaption class="ly lz et er es ma mb bd b be z dx">hello-kubernetes deploy</figcaption></figure><p id="f5e7" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">您可以查看事件以了解证书是否已成功颁发，或者是否发生了任何问题:</p><pre class="lu lv lw lx fd nl mg nm nn aw no bi"><span id="cba9" class="kt ku ht mg b fi np nq l nr ns"><strong class="mg hu">kubectl</strong> describe ingress <strong class="mg hu">--namespace</strong> hello<br/><strong class="mg hu">kubectl</strong> describe certificate <strong class="mg hu">--namespace</strong> hello</span></pre><p id="266f" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">当所有资源准备就绪时，使用(用<code class="du md me mf mg b">example.com</code>代替您的域)测试解决方案:</p><pre class="lu lv lw lx fd nl mg nm nn aw no bi"><span id="2945" class="kt ku ht mg b fi np nq l nr ns"><strong class="mg hu">curl --insecure --silent --include</strong> https://hello.<strong class="mg hu">${AZ_DNS_DOMAIN}</strong></span></pre><p id="e454" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu">注意</strong>:对于staging环境，将使用来自不受信任的私有CA的证书，因此需要参数<code class="du md me mf mg b">--insecure</code>或<code class="du md me mf mg b">-k</code>。</p><p id="4c83" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">完成后，删除现有解决方案:</p><pre class="lu lv lw lx fd nl mg nm nn aw no bi"><span id="d0ce" class="kt ku ht mg b fi np nq l nr ns"><strong class="mg hu">helm</strong> delete hello-kubernetes <strong class="mg hu">--namespace</strong> hello</span></pre><h2 id="f1f0" class="kt ku ht bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln bi translated">与产品发行者一起部署</h2><p id="7596" class="pw-post-body-paragraph ji jj ht jk b jl lo iu jn jo lp ix jq jr lq jt ju jv lr jx jy jz ls kb kc kd hb bi translated">当满意的解决方案是可行的，我们可以尝试生产发行者。我们这样做的原因是分两个阶段，因为ACME服务器对请求有一个极限。</p><p id="4638" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">使用生产发行者部署以下内容:</p><pre class="lu lv lw lx fd nl mg nm nn aw no bi"><span id="24c3" class="kt ku ht mg b fi np nq l nr ns"><strong class="mg hu">source</strong> env.sh<br/><strong class="mg hu">export ACME_ISSUER</strong>=letsencrypt-prod<br/><strong class="mg hu">helmfile</strong> <strong class="mg hu">--file</strong> ./examples/hello/helmfile.yaml apply</span></pre><p id="6a51" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">片刻之后，您可以检查结果<code class="du md me mf mg b">https://hello.example.com</code>(用<code class="du md me mf mg b">example.com</code>替换您的域)。</p><figure class="lu lv lw lx fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es nz"><img src="../Images/1cb3bfe143583240417e2fbec5855dc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bxULNtOEg2H4Z3KM1fmH3w.png"/></div></div></figure><h1 id="1697" class="mh ku ht bd kv mi mj mk kz ml mm mn ld iz mo ja lg jc mp jd lj jf mq jg lm mr bi translated">Kubernetes示例:Dgraph</h1><p id="3e02" class="pw-post-body-paragraph ji jj ht jk b jl lo iu jn jo lp ix jq jr lq jt ju jv lr jx jy jz ls kb kc kd hb bi translated"><a class="ae ke" href="https://dgraph.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> Dgraph </strong> </a>是一个分布式图形数据库，有一个掌舵图，可以用来将<a class="ae ke" href="https://dgraph.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> Dgraph </strong> </a>安装到<a class="ae ke" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> Kubernetes </strong> </a>集群中。您可以使用<code class="du md me mf mg b">helmfile</code>或<code class="du md me mf mg b">helm</code>两种方法安装<a class="ae ke" href="https://dgraph.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu">图</strong> </a>。</p><p id="ff9e" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">这个例子的好处在于它将通过一个入口部署两个端点:一个用于Dgraph Ratel图形用户界面客户端(<a class="ae ke" href="https://reactjs.org/" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu"/></a>)和数据库服务本身Dgraph Alpha。</p><figure class="lu lv lw lx fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es oa"><img src="../Images/b4cf3c8307e83b45894d733de36e1af1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lImQZLEpeovABW3elHhcxw.png"/></div></div><figcaption class="ly lz et er es ma mb bd b be z dx"><strong class="bd kv">Example</strong>: Dgraph Alpha + Dgraph Ratel</figcaption></figure><h2 id="4718" class="kt ku ht bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln bi translated">保护数据图表</h2><p id="31f5" class="pw-post-body-paragraph ji jj ht jk b jl lo iu jn jo lp ix jq jr lq jt ju jv lr jx jy jz ls kb kc kd hb bi translated">在生产场景中，公共端点应该受到保护，尤其是后端数据库，但是为了演示简单起见，端点不会受到保护。</p><p id="1ad0" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">我们可以通过添加一个<em class="ms">允许列表</em>(也称为<em class="ms">白名单</em>)来为<a class="ae ke" href="https://github.com/dgraph-io/dgraph" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu">图Alpha </strong> </a>服务本身增加一些安全级别:</p><pre class="lu lv lw lx fd nl mg nm nn aw no bi"><span id="4670" class="kt ku ht mg b fi np nq l nr ns"><em class="ms"># get AKS pod and service IP addresses</em><strong class="mg hu"><br/>DG_ALLOW_LIST</strong>=$(<strong class="mg hu">az</strong> aks show \<br/>  <strong class="mg hu">--name</strong> <strong class="mg hu">$AZ_CLUSTER_NAME</strong> \<br/>  <strong class="mg hu">--resource-group</strong> <strong class="mg hu">$AZ_RESOURCE_GROUP</strong> | \<br/>  <strong class="mg hu">jq</strong> -r '.networkProfile.podCidr,.networkProfile.serviceCidr' | \<br/>  tr '\n' ','<br/>)</span><span id="1a17" class="kt ku ht mg b fi nv nq l nr ns"><em class="ms"># append home office IP address<br/></em><strong class="mg hu">MY_IP_ADDRESS</strong>=$(<strong class="mg hu">curl</strong> --silent ifconfig.me)<br/><strong class="mg hu">DG_ALLOW_LIST</strong>="$<strong class="mg hu">{DG_ALLOW_LIST</strong>}${<strong class="mg hu">MY_IP_ADDRESS</strong>}/32"<br/><strong class="mg hu">export</strong> <strong class="mg hu">DG_ALLOW_LIST</strong></span></pre><h2 id="651a" class="kt ku ht bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln bi translated">部署数据图表</h2><p id="6bf1" class="pw-post-body-paragraph ji jj ht jk b jl lo iu jn jo lp ix jq jr lq jt ju jv lr jx jy jz ls kb kc kd hb bi translated">复制下面的文件并另存为<code class="du md me mf mg b">examples/dgraph/helmfile.yaml</code>:</p><figure class="lu lv lw lx fd hk"><div class="bz dy l di"><div class="nt nu l"/></div></figure><p id="595b" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">同样，我们可以先在试运行中测试解决方案，然后再尝试生产。</p><h2 id="c4d7" class="kt ku ht bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln bi translated">与临时发行者一起部署</h2><p id="98ad" class="pw-post-body-paragraph ji jj ht jk b jl lo iu jn jo lp ix jq jr lq jt ju jv lr jx jy jz ls kb kc kd hb bi translated">要测试功能，请运行以下命令</p><pre class="lu lv lw lx fd nl mg nm nn aw no bi"><span id="bcbf" class="kt ku ht mg b fi np nq l nr ns"><strong class="mg hu">source</strong> env.sh<br/><strong class="mg hu">export ACME_ISSUER</strong>=letsencrypt-staging</span><span id="a537" class="kt ku ht mg b fi nv nq l nr ns"><strong class="mg hu">helmfile --file </strong>./examples/dgraph/helmfile.yaml apply</span></pre><p id="0dc0" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">验证数据图表服务是否都处于运行状态。这可能需要大约一分钟:</p><pre class="lu lv lw lx fd nl mg nm nn aw no bi"><span id="ee40" class="kt ku ht mg b fi np nq l nr ns"><strong class="mg hu">kubectl </strong>get all,ing,certificate <strong class="mg hu">--namespace</strong> dgraph</span></pre><p id="874c" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">这应该会显示如下内容:</p><figure class="lu lv lw lx fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ob"><img src="../Images/ec7579c161b19790fe71019dcf6d2f16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h7H5nF1ixnapBVlJGH24xg.png"/></div></div><figcaption class="ly lz et er es ma mb bd b be z dx">Dgraph Deployment with Certificate</figcaption></figure><p id="5eef" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">验证域名可以访问<a class="ae ke" href="https://github.com/dgraph-io/dgraph" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu">d字母</strong> </a>(用<code class="du md me mf mg b">example.com</code>代替您的域):</p><pre class="lu lv lw lx fd nl mg nm nn aw no bi"><span id="9be4" class="kt ku ht mg b fi np nq l nr ns"><strong class="mg hu">curl --insecure --silent </strong>https://alpha.<strong class="mg hu">${AZ_DNS_DOMAIN}</strong>/health | <strong class="mg hu">jq</strong></span></pre><h2 id="03c5" class="kt ku ht bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln bi translated">与产品发行者一起部署</h2><p id="090e" class="pw-post-body-paragraph ji jj ht jk b jl lo iu jn jo lp ix jq jr lq jt ju jv lr jx jy jz ls kb kc kd hb bi translated">为了让prod测试功能，运行以下命令。</p><pre class="lu lv lw lx fd nl mg nm nn aw no bi"><span id="8474" class="kt ku ht mg b fi np nq l nr ns"><strong class="mg hu">source</strong> env.sh<br/><strong class="mg hu">export ACME_ISSUER</strong>=letsencrypt-prod<br/><strong class="mg hu">helmfile --file </strong>./examples/dgraph/helmfile.yaml apply</span></pre><p id="82b9" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">验证证书是否已更新为:</p><pre class="lu lv lw lx fd nl mg nm nn aw no bi"><span id="db86" class="kt ku ht mg b fi np nq l nr ns"><strong class="mg hu">kubectl</strong> describe ingress <strong class="mg hu">--namespace</strong> dgraph</span></pre><p id="9651" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">您应该会看到一条<code class="du md me mf mg b">updated Certificate</code>消息:</p><figure class="lu lv lw lx fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es oc"><img src="../Images/9f4035767f829ef837dad10ff8021b3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6JvJWwn0Vp6H2S0n2sqhxQ.png"/></div></div><figcaption class="ly lz et er es ma mb bd b be z dx">Ingress resource events</figcaption></figure><p id="844f" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">您还可以查看带有以下内容的证书事件:</p><pre class="lu lv lw lx fd nl mg nm nn aw no bi"><span id="455f" class="kt ku ht mg b fi np nq l nr ns"><strong class="mg hu">kubectl</strong> describe certificate <strong class="mg hu">--namespace</strong> dgraph</span></pre><p id="0755" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">这应该会显示类似如下的事件:</p><figure class="lu lv lw lx fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es od"><img src="../Images/73335bf9f1cb88d79b7285a117e76f8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Jc-8N9W5MWGSB8xQ10nRmw.png"/></div></div><figcaption class="ly lz et er es ma mb bd b be z dx">Certificate resource events</figcaption></figure><p id="ae21" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">验证域名可以访问<a class="ae ke" href="https://github.com/dgraph-io/dgraph" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu">d字母</strong> </a>(用<code class="du md me mf mg b">example.com</code>代替您的域):</p><pre class="lu lv lw lx fd nl mg nm nn aw no bi"><span id="097e" class="kt ku ht mg b fi np nq l nr ns"><strong class="mg hu">curl --silent </strong>https://alpha.<strong class="mg hu">${AZ_DNS_DOMAIN}</strong>/health | <strong class="mg hu">jq</strong></span></pre><p id="b0bc" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu">注意</strong>:现在我们使用的是公共可信证书，而不是暂存中的私有证书，因此不再需要<code class="du md me mf mg b">--insecure </code>(或<code class="du md me mf mg b">-k</code>)。</p><h1 id="bc07" class="mh ku ht bd kv mi mj mk kz ml mm mn ld iz mo ja lg jc mp jd lj jf mq jg lm mr bi translated">上传数据和模式</h1><p id="0172" class="pw-post-body-paragraph ji jj ht jk b jl lo iu jn jo lp ix jq jr lq jt ju jv lr jx jy jz ls kb kc kd hb bi translated">有一些改编自教程<a class="ae ke" href="https://dgraph.io/docs/get-started/" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu">https://dgraph.io/docs/get-started/</strong></a><strong class="jk hu"/>的脚本可以下载下来:</p><pre class="lu lv lw lx fd nl mg nm nn aw no bi"><span id="ba59" class="kt ku ht mg b fi np nq l nr ns"><strong class="mg hu">PREFIX</strong>=gist.githubusercontent.com/darkn3rd<br/><strong class="mg hu">RDF_GIST_ID</strong>=398606fbe7c8c2a8ad4c0b12926e7774<br/><strong class="mg hu">RDF_FILE</strong>=e90e1e672c206c16e36ccfdaeb4bd55a84c15318/sw.rdf<br/><strong class="mg hu">SCHEMA_GIST_ID</strong>=b712bbc52f65c68a5303c74fd08a3214<br/><strong class="mg hu">SCHEMA_FILE</strong>=b4933d2b286aed6e9c32decae36f31c9205c45ba/sw.schema</span><span id="8ec8" class="kt ku ht mg b fi nv nq l nr ns"><strong class="mg hu">curl</strong> -sO https://<strong class="mg hu">$PREFIX</strong>/<strong class="mg hu">$RDF_GIST_ID</strong>/raw/<strong class="mg hu">$RDF_FILE<br/>curl</strong> -sO https://<strong class="mg hu">$PREFIX</strong>/<strong class="mg hu">$SCHEMA_GIST_ID</strong>/raw/<strong class="mg hu">$SCHEMA_FILE</strong></span></pre><p id="e68b" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">下载完成后，您可以上传模式和数据:</p><pre class="lu lv lw lx fd nl mg nm nn aw no bi"><span id="127b" class="kt ku ht mg b fi np nq l nr ns"><strong class="mg hu">curl</strong> <strong class="mg hu">-s</strong> "https://alpha.<strong class="mg hu">$AZ_DNS_DOMAIN</strong>/mutate?commitNow=true" \<br/> <strong class="mg hu">--request</strong> POST \<br/> <strong class="mg hu">--header</strong> "Content-Type: application/rdf" \<br/> <strong class="mg hu">--data-binary</strong> @sw.rdf | jq</span><span id="75eb" class="kt ku ht mg b fi nv nq l nr ns"><strong class="mg hu">curl</strong> <strong class="mg hu">-s</strong> "https://alpha.<strong class="mg hu">$AZ_DNS_DOMAIN</strong>/alter" \<br/>  <strong class="mg hu">--request</strong> POST \<br/>  <strong class="mg hu">--data-binary</strong> @sw.schema | jq</span></pre><h1 id="2393" class="mh ku ht bd kv mi mj mk kz ml mm mn ld iz mo ja lg jc mp jd lj jf mq jg lm mr bi translated">连接到Ratel用户界面</h1><p id="1b41" class="pw-post-body-paragraph ji jj ht jk b jl lo iu jn jo lp ix jq jr lq jt ju jv lr jx jy jz ls kb kc kd hb bi translated">几分钟后，你可以检查结果<code class="du md me mf mg b">https://ratel.example.com</code>(用<code class="du md me mf mg b">example.com</code>代替你的域名)。</p><p id="aa9b" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">在<code class="du md me mf mg b"><strong class="jk hu">Dgraph Server Connection</strong></code>对话框中，配置域名，例如<code class="du md me mf mg b">https://alpha.example.com</code>(用<code class="du md me mf mg b">example.com</code>代替您的域名)</p><figure class="lu lv lw lx fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es oe"><img src="../Images/597f9fc34a3246a2bba07e7914483311.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QeQaAqtzEDJCJLrgdwXrjg.png"/></div></div></figure><h2 id="23ce" class="kt ku ht bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln bi translated">使用Ratel UI进行测试</h2><p id="6ebb" class="pw-post-body-paragraph ji jj ht jk b jl lo iu jn jo lp ix jq jr lq jt ju jv lr jx jy jz ls kb kc kd hb bi translated">在Ratel UI中，粘贴以下查询并单击run:</p><pre class="lu lv lw lx fd nl mg nm nn aw no bi"><span id="6330" class="kt ku ht mg b fi np nq l nr ns">{<br/>  <strong class="mg hu">me</strong>(func: allofterms(<strong class="mg hu">name</strong>, "Star Wars"),<br/>           orderasc: <strong class="mg hu">release_date</strong>) <br/>    @filter(ge(release_date, "1980")) {<br/>      <strong class="mg hu">name</strong><br/>      <strong class="mg hu">release_date</strong><br/>      <strong class="mg hu">revenue</strong><br/>      running_time<br/>      <strong class="mg hu">director</strong> {<br/>        <strong class="mg hu">name</strong><br/>      }<br/>      <strong class="mg hu">starring</strong> (orderasc: <strong class="mg hu">name</strong>) {<br/>        <strong class="mg hu">name</strong><br/>      }<br/>  }<br/>}</span></pre><p id="5533" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">您应该会看到类似这样的内容:</p><figure class="lu lv lw lx fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es of"><img src="../Images/aeb0352b2c0ce1a013b8169817409004.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_yM4AgEbDzpgLcKIYaOXKQ.png"/></div></div></figure><h1 id="7ecd" class="mh ku ht bd kv mi mj mk kz ml mm mn ld iz mo ja lg jc mp jd lj jf mq jg lm mr bi translated">清理项目</h1><p id="d3ab" class="pw-post-body-paragraph ji jj ht jk b jl lo iu jn jo lp ix jq jr lq jt ju jv lr jx jy jz ls kb kc kd hb bi translated">您可以使用以下方法清理会产生成本的资源:</p><h2 id="318c" class="kt ku ht bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln bi translated">移除外部磁盘</h2><p id="7ab3" class="pw-post-body-paragraph ji jj ht jk b jl lo iu jn jo lp ix jq jr lq jt ju jv lr jx jy jz ls kb kc kd hb bi translated">在删除<a class="ae ke" href="https://azure.microsoft.com/en-us/services/kubernetes-service/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> AKS </strong> </a>集群之前，请确保所有使用过的磁盘都已移除，否则，这些磁盘将会被留下并产生费用。</p><pre class="lu lv lw lx fd nl mg nm nn aw no bi"><span id="c8de" class="kt ku ht mg b fi np nq l nr ns"><em class="ms">############ <br/># Delete the Dgraph cluster <br/>############################################</em><strong class="mg hu"><br/>helm</strong> delete demo <strong class="mg hu">--namespace</strong> dgraph</span><span id="abaa" class="kt ku ht mg b fi nv nq l nr ns"><em class="ms">############ <br/># Delete external storage used by the Dgraph cluster<br/>############################################<br/></em><strong class="mg hu">kubectl</strong> delete pvc <strong class="mg hu">--namespace</strong> dgraph <strong class="mg hu">--selector</strong> release=demo</span></pre><p id="edd4" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu">注意</strong>:如果这些资源正在使用中，就不能删除。确保使用PVC资源的资源已被删除，即<code class="du md me mf mg b"><strong class="jk hu">helm</strong> delete demo <strong class="jk hu">--namespace</strong> dgraph</code>。</p><h2 id="e32e" class="kt ku ht bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln bi translated">移除Azure资源</h2><p id="50e3" class="pw-post-body-paragraph ji jj ht jk b jl lo iu jn jo lp ix jq jr lq jt ju jv lr jx jy jz ls kb kc kd hb bi translated">这将删除Azure资源:</p><pre class="lu lv lw lx fd nl mg nm nn aw no bi"><span id="7cbb" class="kt ku ht mg b fi np nq l nr ns"><em class="ms">############ <br/># Delete the AKS cluster <br/>############################################</em><strong class="mg hu"><br/>az</strong> aks delete \<br/>  <strong class="mg hu">--resource-group</strong> <strong class="mg hu">$AZ_RESOURCE_GROUP</strong> \<br/>  <strong class="mg hu">--name</strong> <strong class="mg hu">$AZ_CLUSTER_NAME</strong></span><span id="b20f" class="kt ku ht mg b fi nv nq l nr ns"><em class="ms">############ <br/># Delete the Azure DNS Zone <br/>############################################</em><strong class="mg hu"><br/>az</strong> network dns zone delete \<br/>  <strong class="mg hu">--resource-group</strong> <strong class="mg hu">$AZ_RESOURCE_GROUP</strong> \<br/>  <strong class="mg hu">--name</strong> <strong class="mg hu">$AZ_DNS_DOMAIN</strong></span></pre><h1 id="b64f" class="mh ku ht bd kv mi mj mk kz ml mm mn ld iz mo ja lg jc mp jd lj jf mq jg lm mr bi translated">资源</h1><p id="810b" class="pw-post-body-paragraph ji jj ht jk b jl lo iu jn jo lp ix jq jr lq jt ju jv lr jx jy jz ls kb kc kd hb bi translated">这里是我在这篇文章的开发过程中遇到的一些资源。</p><h2 id="20dc" class="kt ku ht bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln bi translated">博客源代码</h2><ul class=""><li id="475c" class="kf kg ht jk b jl lo jo lp jr og jv oh jz oi kd kk kl km kn bi translated"><strong class="jk hu">博客源代码</strong>:<a class="ae ke" href="https://github.com/darkn3rd/blog_tutorials/blob/master/kubernetes/aks/series_1_endpoint/part_3_cert_manager/" rel="noopener ugc nofollow" target="_blank">https://github . com/darkn 3 rd/Blog _ tutorials/blob/master/kubernetes/aks/series _ 1 _ endpoint/part _ 3 _ cert _ manager/</a></li></ul><h2 id="829d" class="kt ku ht bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln bi translated">文章</h2><ul class=""><li id="267e" class="kf kg ht jk b jl lo jo lp jr og jv oh jz oi kd kk kl km kn bi translated"><strong class="jk hu">如何在DigitalOcean Kubernetes上使用Cert-Manager设置Nginx Ingress</strong>:<a class="ae ke" href="https://www.digitalocean.com/community/tutorials/how-to-set-up-an-nginx-ingress-with-cert-manager-on-digitalocean-kubernetes" rel="noopener ugc nofollow" target="_blank">https://www . digital ocean . com/community/tutorials/How-to-setup-an-Nginx-Ingress-with-Cert-Manager-on-digital ocean-Kubernetes</a></li><li id="1287" class="kf kg ht jk b jl ko jo kp jr kq jv kr jz ks kd kk kl km kn bi translated"><strong class="jk hu">保护NGINX入口</strong>(教程):【https://cert-manager.io/docs/tutorials/acme/ingress/ T2】</li><li id="f8ec" class="kf kg ht jk b jl ko jo kp jr kq jv kr jz ks kd kk kl km kn bi translated">在Azure Kubernetes服务(AKS)上创建一个HTTPS入口控制器:<a class="ae ke" href="https://docs.microsoft.com/azure/aks/ingress-tls" rel="noopener ugc nofollow" target="_blank">https://docs.microsoft.com/azure/aks/ingress-tls</a></li><li id="4a30" class="kf kg ht jk b jl ko jo kp jr kq jv kr jz ks kd kk kl km kn bi translated"><strong class="jk hu">LetsEncrypt.org证书颁发</strong>:<a class="ae ke" href="https://azure.github.io/application-gateway-kubernetes-ingress/how-tos/lets-encrypt/" rel="noopener ugc nofollow" target="_blank">https://azure . github . io/application-gateway-kubernetes-ingress/how-tos/lets-encrypt/</a></li></ul><h2 id="55ce" class="kt ku ht bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln bi translated">舵图(证书管理器)</h2><ul class=""><li id="9103" class="kf kg ht jk b jl lo jo lp jr og jv oh jz oi kd kk kl km kn bi translated"><strong class="jk hu">artifact hub</strong>:<a class="ae ke" href="https://artifacthub.io/packages/helm/cert-manager/cert-manager" rel="noopener ugc nofollow" target="_blank">https://artifact hub . io/packages/helm/cert-manager/cert-manager</a></li><li id="bea6" class="kf kg ht jk b jl ko jo kp jr kq jv kr jz ks kd kk kl km kn bi translated"><strong class="jk hu">values . YAML</strong>:<a class="ae ke" href="https://github.com/jetstack/cert-manager/blob/master/deploy/charts/cert-manager/values.yaml" rel="noopener ugc nofollow" target="_blank">https://github . com/jet stack/cert-manager/blob/master/deploy/charts/cert-manager/values . YAML</a></li></ul><h2 id="9825" class="kt ku ht bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln bi translated">文档(证书管理器)</h2><ul class=""><li id="a781" class="kf kg ht jk b jl lo jo lp jr og jv oh jz oi kd kk kl km kn bi translated"><strong class="jk hu">配置【https://cert-manager.io/docs/configuration/acme/】:<a class="ae ke" href="https://cert-manager.io/docs/configuration/acme/" rel="noopener ugc nofollow" target="_blank"/></strong></li></ul><h2 id="cd7b" class="kt ku ht bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln bi translated">示例实现</h2><ul class=""><li id="349e" class="kf kg ht jk b jl lo jo lp jr og jv oh jz oi kd kk kl km kn bi translated"><strong class="jk hu"> CloudPosse的cert-manager helm file</strong>:<a class="ae ke" href="https://github.com/cloudposse/helmfiles/blob/master/releases/cert-manager/helmfile.yaml#L135-L156" rel="noopener ugc nofollow" target="_blank">https://github . com/cloud posse/helm files/blob/master/releases/cert-manager/helm file . YAML</a></li></ul><h1 id="a6d9" class="mh ku ht bd kv mi mj mk kz ml mm mn ld iz mo ja lg jc mp jd lj jf mq jg lm mr bi translated">结论</h1><p id="8f82" class="pw-post-body-paragraph ji jj ht jk b jl lo iu jn jo lp ix jq jr lq jt ju jv lr jx jy jz ls kb kc kd hb bi translated">这篇文章的重点是保护一个面向公众的网站或应用程序，它有一个使用<a class="ae ke" href="https://letsencrypt.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu">的web接口，让我们用一个<a class="ae ke" href="https://cert-manager.io/docs/configuration/acme/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> ACME发行者</strong> </a>来加密</strong> </a>。这个旅程的一部分包括安装所需的带有<a class="ae ke" href="https://github.com/kubernetes/ingress-nginx" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu">ingress-nginx</strong></a>(<a class="ae ke" href="https://openresty.org/en/" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu">OpenResty</strong></a>)的ingress控制器和带有<a class="ae ke" href="https://github.com/kubernetes-sigs/external-dns" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> external-dns </strong> </a>的DNS记录更新自动化。</p><p id="3316" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">关于安全性的最后一个注意事项是，在集群上运行的所有pods将能够更新<a class="ae ke" href="https://azure.microsoft.com/services/dns/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> Azure DNS </strong> </a>区域中的记录，并颁发证书，这也验证了使用<a class="ae ke" href="https://azure.microsoft.com/services/dns/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> Azure DNS </strong> </a>区域(用于<code class="du md me mf mg b">DNS01</code>挑战)的有效性。您可以使用<a class="ae ke" href="https://azure.github.io/aad-pod-identity/" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu">aad-pod-identity</strong></a>进一步保护这些，以便只有pod具有适当的凭证，从而允许应用最小特权 原则。请注意，该功能目前是与<a class="ae ke" href="https://azure.microsoft.com/services/kubernetes-service/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> AKS </strong> </a>集成的预览版。</p><p id="68e3" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">有了<a class="ae ke" href="https://cert-manager.io" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu">证书管理器</strong> </a>，就有了这么多的配置选项。与本文中使用的<a class="ae ke" href="https://cert-manager.io/docs/configuration/acme/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu">极致</strong> <strong class="jk hu">发布者</strong> </a>不同，本文中使用的<a class="ae ke" href="https://cert-manager.io/docs/configuration/acme/dns01/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> DNS01 </strong> </a>挑战<a class="ae ke" href="https://azure.microsoft.com/services/dns/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu">天蓝DNS </strong> </a>，但你绝不限于此，如<a class="ae ke" href="https://cert-manager.io/docs/configuration/acme/dns01/route53/" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu">route 53</strong></a><a class="ae ke" href="https://cert-manager.io/docs/configuration/acme/dns01/google/" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu">云DNS</strong><strong class="jk hu"/>和</a><a class="ae ke" href="https://cert-manager.io/docs/configuration/acme/dns01/cloudflare/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu">除了<a class="ae ke" href="https://cert-manager.io/docs/configuration/acme/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> ACME </strong> </a>之外，你还可以尝试其他ca，比如<a class="ae ke" href="https://cert-manager.io/docs/configuration/vault/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> Vault </strong> </a>、<a class="ae ke" href="https://cert-manager.io/docs/configuration/venafi/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> Venafi </strong> </a>、cloud flare<a class="ae ke" href="https://github.com/cloudflare/origin-ca-issuer" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu">origin-ca-issuer</strong></a>、<a class="ae ke" href="https://www.freeipa.org" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> FreeIPA </strong> </a>等等。可能性是无限的。</strong></a></p><p id="a75b" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">出于上述和其他原因，毫不奇怪的是<a class="ae ke" href="https://github.com/jetstack/cert-manager" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> cert-manager </strong> </a>是迄今为止在<a class="ae ke" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> Kubernetes </strong> </a>上最流行的证书管理解决方案。</p></div></div>    
</body>
</html>