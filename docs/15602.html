<html>
<head>
<title>How To Calculate String Formulas At Runtime On .Net</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在运行时计算字符串公式？网</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/how-to-calculate-string-formulas-at-runtime-on-net-2cddfa8744d8?source=collection_archive---------2-----------------------#2022-11-10">https://medium.com/geekculture/how-to-calculate-string-formulas-at-runtime-on-net-2cddfa8744d8?source=collection_archive---------2-----------------------#2022-11-10</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/2f5295bc31daa84f44878b131f31e072.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_gEXFXNF42yD7NWOLoeboA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">NASA in 1961(Image credits: <a class="ae iu" href="http://images.google.com/hosted/life/8c9619c6f6ebf405.html" rel="noopener ugc nofollow" target="_blank">J. R. Eyerman, via LIFE</a>)</figcaption></figure><p id="58c5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">嗨，今天我们将讨论如何用C#在运行时计算字符串公式。</p><p id="1cc4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在一个项目中，我们必须运行数千个数学公式来计算产品的尺寸。这些公式以后可以更改，我们可以添加新的公式。因此，在类内部写一个静态公式是不正确的。当我们改变公式时，我们不必重新构建我们的解决方案。</p><p id="a821" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这是我们的示例公式。</p><blockquote class="jt"><p id="4c6f" class="ju jv hi bd jw jx jy jz ka kb kc js dx translated">CMIW*CCL*(FG+CG)/10⁶+1+sqrt(3)</p></blockquote><p id="56c9" class="pw-post-body-paragraph iv iw hi ix b iy kd ja jb jc ke je jf jg kf ji jj jk kg jm jn jo kh jq jr js hb bi translated">这是我们的示例公式模型:</p><p id="7cac" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> FormuleModel.cs: </strong>我们将把公式中的所有参数都声明为这个类中的属性。而我们在计算公式的时候，会通过使用<strong class="ix hj"> <em class="ki">反射</em> </strong>从这个类中获取属性值。</p><pre class="kj kk kl km fd kn ko kp kq aw kr bi"><span id="f838" class="ks kt hi ko b fi ku kv l kw kx">public  class FormuleModel:IFormuleModel<br/>{<br/>   public double CMIW { get; set; }<br/>   public int CCL { get; set; }<br/>   public int FG { get; set; }<br/>   public int CG { get; set; }<br/>}</span></pre><p id="a480" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> IFormuleModel.cs: </strong>我们可以用这个方法在FormuleModel类上使用<strong class="ix hj">反射</strong>库来获取属性的值。我们可以通过参数的字符串名称来获取参数的值。</p><pre class="kj kk kl km fd kn ko kp kq aw kr bi"><span id="711a" class="ks kt hi ko b fi ku kv l kw kx">public interface IFormuleModel<br/>{<br/>   public object this[string propertyName]<br/>   {<br/>      get { return this.GetType().GetProperty(propertyName).GetValue(this, null); }</span><span id="0cde" class="ks kt hi ko b fi ky kv l kw kx">      set { this.GetType().GetProperty(propertyName).SetValue(this, value, null); }<br/>   }<br/>}</span></pre></div><div class="ab cl kz la gp lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="hb hc hd he hf"><blockquote class="jt"><p id="53fc" class="ju jv hi bd jw jx jy jz ka kb kc js dx translated">每一个表达自然法则的公式都是对上帝的赞美诗。—玛丽亚·米切尔</p></blockquote><p id="007c" class="pw-post-body-paragraph iv iw hi ix b iy kd ja jb jc ke je jf jg kf ji jj jk kg jm jn jo kh jq jr js hb bi translated">现在我们将创建一个字符串扩展静态类。我们将用这个扩展来计算字符串公式。</p><blockquote class="lg lh li"><p id="2fa7" class="iv iw ki ix b iy iz ja jb jc jd je jf lj jh ji jj lk jl jm jn ll jp jq jr js hb bi translated">CalculateFormulas()方法有两个参数。其中一个是字符串公式，第二个是模型的参数。在调用这个扩展方法之前，我们必须填充模型。<strong class="ix hj"> <em class="hi">我们会用Regex找到公式中的所有参数。</em>T13】</strong></p></blockquote><p id="b50e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们必须从查找参数列表中删除一些特定的数学术语，如“sqrt，sin，cos，lim”。因为RegEx不能过滤这些单词，它的行为就好像这些定义是参数一样。因此，我们必须添加“Where”过滤条件，并删除本例中的这些特定数学术语“sqrt”。我们必须去除“罪恶、谭、cos、林”等..如果公式中有一项。</p><blockquote class="lg lh li"><p id="995f" class="iv iw ki ix b iy iz ja jb jc jd je jf lj jh ji jj lk jl jm jn ll jp jq jr js hb bi translated">在<strong class="ix hj"> regex </strong>确定了公式中传递的变量后，输出变量看起来是这样的= &gt; " <strong class="ix hj"> CMIW，CCL，FG，CG </strong>"</p><p id="6860" class="iv iw ki ix b iy iz ja jb jc jd je jf lj jh ji jj lk jl jm jn ll jp jq jr js hb bi translated"><strong class="ix hj">公式</strong>:cmiw*ccl*(fg+cg)/1⁰⁶+1+sqrt(3)</p></blockquote><figure class="kj kk kl km fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lm"><img src="../Images/ea4f57e9519e903ca047d2f76a9bf741.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jfH1M-Rn8pNM10qlQK9Ihw.png"/></div></div></figure><blockquote class="lg lh li"><p id="ff39" class="iv iw ki ix b iy iz ja jb jc jd je jf lj jh ji jj lk jl jm jn ll jp jq jr js hb bi translated">我们将在每个参数周围加上“{”和“}”，并替换公式。公式看起来是这样的= &gt;“<strong class="ix hj">{0}*{1}*({2}+{3})/10⁶+1+sqrt(3)</strong>我们用增量数代替了所有的参数。</p></blockquote><figure class="kj kk kl km fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ln"><img src="../Images/1f552b7c28a980a2e459259c14a6be86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GbrRPYBM9AzUmgawLUbeVA.png"/></div></div></figure><blockquote class="lg lh li"><p id="5f58" class="iv iw ki ix b iy iz ja jb jc jd je jf lj jh ji jj lk jl jm jn ll jp jq jr js hb bi translated">我们将使用Split('，')函数分隔所有参数。并且我们会用<strong class="ix hj">Reflection</strong>(" prms[index]=<strong class="ix hj">model[PRM]</strong>")找到参数的值，用foreach循环放入对象数组"<strong class="ix hj"> prms </strong>"中。查找参数的值来自于，IFormuleModel接口的“get”、“set”属性。我们将使用“字符串”将所有参数替换为它们自己的值。格式(公式，prms)”。最后公式看起来是这样的=&gt;<strong class="ix hj">4.5 * 1 *(4+3)/⁰⁶+1+sqrt(3)</strong>。最后，我们将用计算结果的公式设置实体。</p></blockquote><figure class="kj kk kl km fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lo"><img src="../Images/7fa8e3869dfcb6dab1235a8d1d458e0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QdGCQMq2mQ8I-nBlW5D7qQ.png"/></div></div></figure><blockquote class="lg lh li"><p id="2015" class="iv iw ki ix b iy iz ja jb jc jd je jf lj jh ji jj lk jl jm jn ll jp jq jr js hb bi translated">我们将用“<em class="hi">实体返回计算结果。eval numeric()</em>"方法的<strong class="ix hj"> AngouriMath </strong>库。</p></blockquote><blockquote class="jt"><p id="a13e" class="ju jv hi bd jw jx lp lq lr ls lt js dx translated">返回(十进制)表达式。EvalNumerical</p></blockquote><p id="724b" class="pw-post-body-paragraph iv iw hi ix b iy kd ja jb jc ke je jf jg kf ji jj jk kg jm jn jo kh jq jr js hb bi translated"><strong class="ix hj"> CalculateFormulas.cs: </strong>自定义字符串扩展类。</p><pre class="kj kk kl km fd kn ko kp kq aw kr bi"><span id="25c6" class="ks kt hi ko b fi ku kv l kw kx">public static decimal CalculateFormulas(this string formule, IFormuleModel model)<br/>{<br/>   String pattern = @"([A-Z]|[a-z])+([A-z]|[a-z]|\d|_)*";</span><span id="bf60" class="ks kt hi ko b fi ky kv l kw kx">   String output = String.Join(",",<br/>   Regex.Matches(formule, pattern)<br/>     .OfType&lt;Match&gt;()<br/>     .Where(item =&gt; item.Value != "sqrt")<br/>     .Select(item =&gt; item.Value));</span><span id="edb3" class="ks kt hi ko b fi ky kv l kw kx">   int i = 0;<br/>   output.Split(',').ToList().ForEach(item =&gt;<br/>   {<br/>      formule = formule.Replace(item, "{" + i.ToString() + "}");<br/>      i++;<br/>   });</span><span id="afd5" class="ks kt hi ko b fi ky kv l kw kx">   var varableArray = output.Split(',');<br/>   Object[] prms = new Object[varableArray.Length];<br/>   var index = 0;<br/>   varableArray.ToList().ForEach(prm =&gt;<br/>   {<br/>      prms[index] = model[prm];<br/>      index++;<br/>   });</span><span id="ad45" class="ks kt hi ko b fi ky kv l kw kx">   formule = String.Format(formule, prms);<br/>   Entity expr = formule;<br/>   return (decimal)expr.EvalNumerical();<br/>}</span></pre></div><div class="ab cl kz la gp lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="hb hc hd he hf"><blockquote class="lg lh li"><p id="09b5" class="iv iw ki ix b iy iz ja jb jc jd je jf lj jh ji jj lk jl jm jn ll jp jq jr js hb bi translated">这是我们的测试公式。我们将用测试数据填充我们的参数模型。</p></blockquote><figure class="kj kk kl km fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lu"><img src="../Images/27a730447808255969fc51be87c5cae3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*utuRMMXipoyWCDZP6OOvGQ.png"/></div></div></figure><blockquote class="lg lh li"><p id="e69e" class="iv iw ki ix b iy iz ja jb jc jd je jf lj jh ji jj lk jl jm jn ll jp jq jr js hb bi translated">我们可以把我们的扩展方法叫做“<strong class="ix hj"> CalculateFormulas </strong>”，毕竟字符串。为了计算公式，我们必须给这个方法一个参数。</p></blockquote><figure class="kj kk kl km fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lv"><img src="../Images/2335b4734cccd684b78fa9c230fe237c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3bbvJoKr-emMeqNrAJ3q0w.png"/></div></div></figure><p id="1edc" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> Program.cs: </strong></p><pre class="kj kk kl km fd kn ko kp kq aw kr bi"><span id="8ab9" class="ks kt hi ko b fi ku kv l kw kx">internal class Program<br/>{<br/>   static void Main(string[] args)<br/>   {<br/>      String source = "CMIW*CCL*(FG+CG)/10^6+1+sqrt(3)";<br/>      FormuleModel model = new FormuleModel() { CMIW = 4.5, CCL = 1, FG = 4, CG = 3 };</span><span id="632b" class="ks kt hi ko b fi ky kv l kw kx">      var result = source.CalculateFormulas(model);<br/>      Console.WriteLine(result);<br/>   }<br/>}</span></pre><p id="9431" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">结果画面:</strong>最终，我们得到了如下图所示的结果:</p><figure class="kj kk kl km fd ij er es paragraph-image"><div class="er es lw"><img src="../Images/ba7e2783938d0aed6cb3b1996ea09669.png" data-original-src="https://miro.medium.com/v2/resize:fit:1364/format:webp/1*Z17e-dzYXnxw1xP50z2RoA.png"/></div></figure><blockquote class="jt"><p id="3bba" class="ju jv hi bd jw jx lp lq lr ls lt js dx translated">成功有一个简单的公式:尽力而为，人们可能会喜欢。—山姆·尤因</p></blockquote><p id="b25c" class="pw-post-body-paragraph iv iw hi ix b iy kd ja jb jc ke je jf jg kf ji jj jk kg jm jn jo kh jq jr js hb bi translated"><strong class="ix hj">结论:</strong></p><p id="984b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在本文中，我们试图在不将特定的逻辑代码写入程序的情况下计算一个字符串公式。因为在课堂上写成千上万的公式是疯狂的，管理是不可能的。如果你改变了代码，你必须构建所有的项目并重新发布。但是，如果我们将所有公式作为字符串保存到SQLDB或任何地方，并动态计算公式，以后我们可以通过管理屏幕更改所有公式，而无需做任何额外的工作，我们可以看到所有结果的突然变化。</p><figure class="kj kk kl km fd ij"><div class="bz dy l di"><div class="lx ly l"/></div><figcaption class="iq ir et er es is it bd b be z dx">Goodbye</figcaption></figure><p id="6d3d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下一篇文章再见。</p><p id="fac8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="ki">“如果你读到现在，首先感谢你的耐心和支持。欢迎大家来我的博客</em><a class="ae iu" href="http://www.borakasmer.com/" rel="noopener ugc nofollow" target="_blank"><em class="ki"/><strong class="ix hj"><em class="ki"/></strong></a><strong class="ix hj"><em class="ki"/></strong><em class="ki">了解更多！”</em></p><p id="1e9e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">Github:</strong><a class="ae iu" href="https://github.com/borakasmer/CalculateFormulasDynamically" rel="noopener ugc nofollow" target="_blank"><strong class="ix hj">【https://github.com/borakasmer/CalculateFormulasDynamically】T42</strong></a></p><p id="cf08" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">来源:</strong></p><ul class=""><li id="f266" class="lz ma hi ix b iy iz jc jd jg mb jk mc jo md js me mf mg mh bi translated"><a class="ae iu" href="https://am.angouri.org" rel="noopener ugc nofollow" target="_blank"><strong class="ix hj">https://am.angouri.org</strong></a></li><li id="4596" class="lz ma hi ix b iy mi jc mj jg mk jk ml jo mm js me mf mg mh bi translated"><a class="ae iu" href="https://stackoverflow.com/questions/28208587/extracting-formula-from-string" rel="noopener ugc nofollow" target="_blank"><strong class="ix hj">https://stack overflow . com/questions/28208587/extracting-formula-from-string</strong>T3】</a></li></ul></div></div>    
</body>
</html>