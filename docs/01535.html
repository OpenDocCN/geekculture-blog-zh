<html>
<head>
<title>Predicate Pushdown for Apache Spark with Google BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Google BigQuery对Apache Spark进行谓词下推</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/predicate-pushdown-for-apache-spark-with-google-bigquery-2ad4f9e81e6?source=collection_archive---------9-----------------------#2021-04-14">https://medium.com/geekculture/predicate-pushdown-for-apache-spark-with-google-bigquery-2ad4f9e81e6?source=collection_archive---------9-----------------------#2021-04-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/833c596f909a98fb9535e0a50eb8e83e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*suei5gp3KodY80UKbrfQAA.png"/></div></div></figure><div class=""/><div class=""><h2 id="8c60" class="pw-subtitle-paragraph iq hs ht bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh dx translated">在Google Cloud上用BigQuery对数据块进行谓词下推可以吗？确实如此。这里是如何验证它。</h2></div><p id="077d" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">当我在谷歌云平台上测试最近发布的Databricks的功能时，我检查了BigQuery集成。Databricks正在为BigQuery 使用开源<a class="ae ke" href="https://cloud.google.com/dataproc/docs/tutorials/bigquery-connector-spark-example" rel="noopener ugc nofollow" target="_blank"> Google Spark连接器的一个分支。所以我想知道如何检查查询的某个谓词是否确实被下推到BigQuery(或者不是)。原来很简单！</a></p><p id="c76b" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">让我们以Google BigQuery中的出生率公共数据集为例。下面notebook单元格中的代码使用Spark storage API将表从BigQuery加载到dataframe，将filter()谓词下推到BigQuery。</p><figure class="kf kg kh ki fd hk"><div class="bz dy l di"><div class="kj kk l"/></div></figure><p id="212f" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">您可以获得查询的执行计划，包括使用explain()方法进行的优化。要获得更详细的输出，请使用explain("extended ")</p><pre class="kf kg kh ki fd kl km kn ko aw kp bi"><span id="cc39" class="kq kr ht km b fi ks kt l ku kv">df.explain()</span></pre><p id="53e0" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">上面的小例子是我笔记本的一部分，我用它进一步研究了GCP BigQuery测试的<a class="ae ke" href="https://github.com/fmunz/bigdata-intro/blob/main/DatabricksSparkBigQuery.ipynb" rel="noopener ugc nofollow" target="_blank">数据。explain()的完整输出包含执行计划并列出所有应用的优化。查找描述推送到BigQuery的谓词的部分，其中包含关键字<strong class="jk hu"> PushedFilters </strong>:</a></p><pre class="kf kg kh ki fd kl km kn ko aw kp bi"><span id="96a2" class="kq kr ht km b fi ks kt l ku kv"><strong class="km hu">PushedFilters: [*IsNotNull(state), *IsNotNull(weight_pounds), *EqualTo(state,CA), *GreaterThan(weight_pounds,11.0)]</strong></span></pre><p id="ccf0" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">上面的输出显示，下推到BigQuery的谓词正是Spark查询的条件。</p><p id="ef8d" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">GCP的Databricks Spark优化了</p><ul class=""><li id="9b5d" class="kw kx ht jk b jl jm jo jp jr ky jv kz jz la kd lb lc ld le bi translated">嵌套过滤器下推和嵌套列修剪</li><li id="3817" class="kw kx ht jk b jl lf jo lg jr lh jv li jz lj kd lb lc ld le bi translated">数组下推</li><li id="fb20" class="kw kx ht jk b jl lf jo lg jr lh jv li jz lj kd lb lc ld le bi translated">表达式下推</li></ul><p id="eca8" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">包含上述所有<a class="ae ke" href="https://docs.databricks.com/_static/notebooks/big-query-python.html" rel="noopener ugc nofollow" target="_blank"> Spark查询优化示例</a>的笔记本可以在Databricks文档中找到。</p><h1 id="bc7e" class="lk kr ht bd ll lm ln lo lp lq lr ls lt iz lu ja lv jc lw jd lx jf ly jg lz ma bi translated">从这里去哪里？</h1><p id="c5c7" class="pw-post-body-paragraph ji jj ht jk b jl mb iu jn jo mc ix jq jr md jt ju jv me jx jy jz mf kb kc kd hb bi translated">[1] <a class="ae ke" href="https://databricks.com/blog/2020/07/31/announcing-support-for-google-bigquery-in-databricks-runtime-7-1.html" rel="noopener ugc nofollow" target="_blank"> Databricks与BigQuery的集成</a>博文<br/>【2】<a class="ae ke" href="https://databricks.com/p/google-cloud-free-trial" rel="noopener ugc nofollow" target="_blank">Google Cloud上的Databricks免费试用</a><br/>【3】<a class="ae ke" href="https://docs.databricks.com/_static/notebooks/big-query-python.html" rel="noopener ugc nofollow" target="_blank">big query示例笔记本</a></p></div><div class="ab cl mg mh gp mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="hb hc hd he hf"><p id="ed63" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">如果你像我喜欢写这篇文章一样喜欢阅读它，请为这篇文章鼓掌。我在Twitter上花了太多时间——请随意连接:<a class="ae ke" href="https://twitter.com/search?q=frankmunz" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu">@ frankmunz</strong></a><strong class="jk hu">。</strong></p></div></div>    
</body>
</html>