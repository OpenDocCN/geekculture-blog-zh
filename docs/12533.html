<html>
<head>
<title>System Design Notes #2. Gradual Improvement. Part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">系统设计笔记#2。逐步改善。第二部分</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/system-design-notes-2-gradual-improvement-part-2-874447785c6c?source=collection_archive---------13-----------------------#2022-05-17">https://medium.com/geekculture/system-design-notes-2-gradual-improvement-part-2-874447785c6c?source=collection_archive---------13-----------------------#2022-05-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="a360" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">如何将系统从单个用户扩展到数百万活跃用户。第2部分:CDN，Web层架构，异步数据处理和共享状态存储。</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/ea6b13b242b598f1a30dce1fbeb8682b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yZQ-yh2LrfvSOw3_WbPUTA.jpeg"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Photo by <a class="ae jn" href="https://unsplash.com/@ed259" rel="noopener ugc nofollow" target="_blank">Ed 259</a> from <a class="ae jn" href="https://unsplash.com/photos/xcrI6CPkkJs" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="1ce3" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><a class="ae jn" rel="noopener" href="/geekculture/system-design-notes-1-gradual-improvement-part-1-e138a407dc4d">先前的</a></p></div><div class="ab cl kk kl gp km" role="separator"><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp"/></div><div class="hb hc hd he hf"><p id="c4a3" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这是系统设计系列的第二部分。今天，我们将了解CDN、Web Tear架构、异步数据处理和其他主题。</p><p id="2338" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这就是我们在上一篇文章中停下来的地方:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es kr"><img src="../Images/619a1dd5245d4972a3aa1d5c9a99b5ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3x3H4VndvFZxR74AgIO9xA.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Pic. 1. System Design Diagram</figcaption></figure><p id="e310" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">让我们继续下去，完善这个系统！</p><h1 id="4d4d" class="ks kt hi bd ku kv kw kx ky kz la lb lc io ld ip le ir lf is lg iu lh iv li lj bi translated">加拿大</h1><p id="fc66" class="pw-post-body-paragraph jo jp hi jq b jr lk ij jt ju ll im jw jx lm jz ka kb ln kd ke kf lo kh ki kj hb bi translated">CDN代表内容交付网络。我们可以把它想象成Web服务器的地理上稀疏的缓存。这对于交付静态内容非常有用，比如图像、音轨甚至JavaScript和HTML。下面你可以找到一张描述CDN主要原理的图片。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lp"><img src="../Images/5964b0a91430bd660a28ff6b2ef15bc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oVe3t0caZGq9nGhhLfIhoQ.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Pic. 2. CDN Principle</figcaption></figure><p id="a3de" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">您可能会发现，全球有多个cdn和一台服务器(包含原始静态内容)。当用户第一次获取某个内容项目时，它会在CDN中保存一段时间。然后，下一个请求由CDN处理，用户不需要再次等待太长时间。也就是说，这就像一个<a class="ae jn" rel="noopener" href="/geekculture/system-design-notes-1-gradual-improvement-part-1-e138a407dc4d">缓存</a>。</p><p id="1449" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">让我们再看一个例子，展示CDN的缓存特性。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lq"><img src="../Images/af7df7612b0e609699870e477ef5470a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yG-_42BeSYVj43ACXKTdrw.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Pic. 3. CDN Principle</figcaption></figure><p id="9ead" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这是Pic的描述。3:</p><ul class=""><li id="b74b" class="lr ls hi jq b jr js ju jv jx lt kb lu kf lv kj lw lx ly lz bi translated">用户1请求“index.html”。</li><li id="49f5" class="lr ls hi jq b jr ma ju mb jx mc kb md kf me kj lw lx ly lz bi translated">由于用户1是第一个请求该文件的用户，系统从Web服务器获取该文件，在CDN中保存一段时间，然后将其发送回请求者。</li><li id="9169" class="lr ls hi jq b jr ma ju mb jx mc kb md kf me kj lw lx ly lz bi translated">用户2请求相同的“index.html”。并且该用户与用户1在同一地区。</li><li id="e8ee" class="lr ls hi jq b jr ma ju mb jx mc kb md kf me kj lw lx ly lz bi translated">由于该文件已经保存在CDN中，因此该文件会被快速传递给请求者。</li></ul><p id="81d2" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">使用CDN需要考虑以下几点:</p><ul class=""><li id="57d8" class="lr ls hi jq b jr js ju jv jx lt kb lu kf lv kj lw lx ly lz bi translated">CDN是个很贵的东西。应该找到成本和利润之间的平衡点。</li><li id="d566" class="lr ls hi jq b jr ma ju mb jx mc kb md kf me kj lw lx ly lz bi translated">找到正确的<em class="mf">到期策略</em>和<em class="mf">到期超时</em>可能相当复杂。</li><li id="3cf3" class="lr ls hi jq b jr ma ju mb jx mc kb md kf me kj lw lx ly lz bi translated">当CN中断时，内容应该保持可用。</li></ul><h1 id="645b" class="ks kt hi bd ku kv kw kx ky kz la lb lc io ld ip le ir lf is lg iu lh iv li lj bi translated">有状态Web层</h1><p id="c9ce" class="pw-post-body-paragraph jo jp hi jq b jr lk ij jt ju ll im jw jx lm jz ka kb ln kd ke kf lo kh ki kj hb bi translated">有状态Web层在请求之间存储一些数据。在大多数情况下，这意味着存储会话数据。也许你还记得PHP中的“$__SESSION”？😅</p><p id="eca7" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这就是我们表示有状态Web层的方式:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mg"><img src="../Images/1653349766368ac71209c281a4a3adb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L2Hq2z6Sv6TTU9oblQRLRw.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Pic. 4. Stateful Web Tier</figcaption></figure><p id="d83d" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">您可能已经知道，有状态架构不是一个好的解决方案。这很难支持，而且容易出错。</p><h1 id="0e5e" class="ks kt hi bd ku kv kw kx ky kz la lb lc io ld ip le ir lf is lg iu lh iv li lj bi translated">无状态Web层</h1><p id="1d88" class="pw-post-body-paragraph jo jp hi jq b jr lk ij jt ju ll im jw jx lm jz ka kb ln kd ke kf lo kh ki kj hb bi translated">在这种架构中，Web层中没有请求间数据。这样的系统是健壮的和可扩展的。在需要一些状态数据的情况下，应该将其移出Web层。一个很好的例子——一个独立的NoSQL存储。下面你可以找到一个合适的图表来描述它。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mh"><img src="../Images/496bebd8daee846707261380ec3f9daf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6dqRuxnxpegb61Fz3CAYQA.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Pic. 5. Web Tier with a Shared State Storage</figcaption></figure><p id="f63b" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在，我们的系统可以轻松地独立扩展Web层和共享状态存储。对于快速增长的系统或流量意外增长的系统，这是一种很好的方法。</p><h1 id="6aa8" class="ks kt hi bd ku kv kw kx ky kz la lb lc io ld ip le ir lf is lg iu lh iv li lj bi translated">数据中心</h1><p id="dd99" class="pw-post-body-paragraph jo jp hi jq b jr lk ij jt ju ll im jw jx lm jz ka kb ln kd ke kf lo kh ki kj hb bi translated">在上一篇文章中，我们讨论了负载平衡器如何帮助我们平衡流量。在本节中，我们将向我们的系统添加一个geoDNS路由。这允许考虑用户的地理位置来平衡流量。下面你可以在图表上看到。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mi"><img src="../Images/96ef2c45329b88a75bc2cbdf4a19d8b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V1oKlqoJNh7FGX0Eh7A3DQ.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Pic. 6. GeoDNS Routing</figcaption></figure><p id="ee30" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">有一些问题:</p><ul class=""><li id="1f7a" class="lr ls hi jq b jr js ju jv jx lt kb lu kf lv kj lw lx ly lz bi translated">从技术角度来看，GeoDNS路由是一件复杂的事情。</li><li id="9aca" class="lr ls hi jq b jr ma ju mb jx mc kb md kf me kj lw lx ly lz bi translated">多个地区之间的数据同步可能是一个真正的痛苦。</li><li id="b632" class="lr ls hi jq b jr ma ju mb jx mc kb md kf me kj lw lx ly lz bi translated">部署到几个数据中心不是小事。</li></ul><p id="78a9" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">但是如果您的系统跨多个地区运行，这是一个值得考虑的方法。此外，如果您使用像AWS这样的服务，复杂性会降低。</p><h1 id="5435" class="ks kt hi bd ku kv kw kx ky kz la lb lc io ld ip le ir lf is lg iu lh iv li lj bi translated">异步任务</h1><p id="f684" class="pw-post-body-paragraph jo jp hi jq b jr lk ij jt ju ll im jw jx lm jz ka kb ln kd ke kf lo kh ki kj hb bi translated">想象一下，当您的系统具有处理大量商品销售统计数据并生成近期利润预测的功能。一项相当繁重的任务，不是吗？你会如何设计这个功能？</p><p id="c5a4" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这里的一个好主意是使用消息队列。它是一个允许生产者(请求数据处理)和消费者(处理数据和构建预测)之间异步通信的元素。让我们看一下图表。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mj"><img src="../Images/5f657b269d1ea765d3c8bcb5c5e0ebb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vlcsk6jAStgqeXByk4erWg.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Pic. 7. Data Processing Queue</figcaption></figure><p id="91bb" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我们不打算深入研究这种方法。对于你的具体问题，你可以在网上找到一些利弊。</p><h1 id="74ec" class="ks kt hi bd ku kv kw kx ky kz la lb lc io ld ip le ir lf is lg iu lh iv li lj bi translated">中间总结</h1><p id="29df" class="pw-post-body-paragraph jo jp hi jq b jr lk ij jt ju ll im jw jx lm jz ka kb ln kd ke kf lo kh ki kj hb bi translated">这是到目前为止的最终系统图。我们有GetDNS、数据中心、异步数据处理微服务、CDN和共享状态存储。看起来非常好！该系统能够根据请求的类型和演进向量进行部分和逐步的扩展。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mk"><img src="../Images/f9c1573b771b9d1af8ffa4ea9a388ec9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LE6veoVkxaMxW5bJpFgjdA.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Pic. 8. Intermediate System Design</figcaption></figure><p id="6263" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这是“逐步改进”论文的第二部分。在下一篇文章中，我们将了解系统指标和数据库扩展方法。</p><p id="ca72" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">未完待续…</p></div></div>    
</body>
</html>