<html>
<head>
<title>How to (Part 2 — Revised): Swap Registration Flow to a Live View With phx_gen_auth — Multi-step form with Live View 0.16+</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">How to(第2部分—修订版):使用phx_gen_auth将注册流程切换到实时视图—使用实时视图0.16+的多步骤表单</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/how-to-part-2-revised-swap-registration-flow-to-a-live-view-with-phx-gen-auth-multi-step-47172904b00a?source=collection_archive---------13-----------------------#2021-08-29">https://medium.com/geekculture/how-to-part-2-revised-swap-registration-flow-to-a-live-view-with-phx-gen-auth-multi-step-47172904b00a?source=collection_archive---------13-----------------------#2021-08-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/d35138b59bb344d8d315d8ef5439a47b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*27pFEe2df_Pzmb_jmXKPAw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Metamorphic Early Access registration page. © 2021 Moss Piglet. All rights reserved.</figcaption></figure><h1 id="b614" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">背景</h1><p id="5fdd" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">这次会很快，因为我现在在另一条海岸线上，已经过了睡觉时间。</p><p id="970a" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">但是，<strong class="ju hj">凤凰城实时取景0.16+ </strong>不久前被放弃了(为凤凰城1.6做准备)，我想更新多步表单以利用<a class="ae kv" href="https://github.com/phoenixframework/phoenix_live_view/blob/master/CHANGELOG.md" rel="noopener ugc nofollow" target="_blank">实时取景0.16 </a>中所有的精彩。</p><p id="3d24" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">如果你没有使用Live View 0.16或Phoenix 1.6+，那么跳到我的<a class="ae kv" rel="noopener" href="/swlh/how-to-part-2-swap-registration-flow-to-a-live-view-with-phx-gen-auth-multi-step-form-25371540fce1">原帖</a>来看看如何用Phoenix和Live View(分别是1.5和0.15+)轻松制作多步表单。</p><p id="0a49" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">在我们开始之前，让我们先了解一下实时视图0.16:</p><h1 id="a793" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">实时取景0.16初级</h1><p id="dd12" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">这个<a class="ae kv" href="https://github.com/phoenixframework/phoenix_live_view/blob/master/CHANGELOG.md" rel="noopener ugc nofollow" target="_blank">更新</a>很简单，<em class="kw">很神奇。</em></p><p id="b6a2" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">我注意到我的代码在不做任何改变的情况下性能得到了提高。但是，此外，<strong class="ju hj">他们添加了一个新的HTML引擎</strong>，它是从Marlus Saraiva的工作中找到的，使用了<a class="ae kv" href="https://surface-ui.org/" rel="noopener ugc nofollow" target="_blank"> Surface </a>库(预计还会有更多)。</p><p id="827e" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">在Live View 0.16+的所有伟大的新特性中，我们将主要利用<code class="du kx ky kz la b">.heex</code>模板来为你的HTML实现令人难以置信的调试特性。</p><p id="5b29" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">好了，事不宜迟，让我们开始吧！</p><h1 id="de76" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">先决条件</h1><p id="eff8" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">为了更容易理解，我们假设你已经阅读了<a class="ae kv" rel="noopener" href="/swlh/how-to-swap-registration-flow-to-a-live-view-with-phx-gen-auth-4966f80b412e">第1部分</a>，在那里我们将“死视图”转换为实时视图进行注册。我们将从第二部的结尾开始。</p><p id="cbc2" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">也就是说，与旧版本<a class="ae kv" rel="noopener" href="/swlh/how-to-swap-registration-flow-to-a-live-view-with-phx-gen-auth-4966f80b412e">第1部分</a>相同的基本先决条件适用于较小的更改(实时视图0.16+):</p><ul class=""><li id="5a96" class="lb lc hi ju b jv kq jz kr kd ld kh le kl lf kp lg lh li lj bi translated">你已经用<em class="kw"> live </em>生成器建立了一个工作的Elixir/Phoenix应用程序(或者添加适当的代码——参见<a class="ae kv" href="https://hexdocs.pm/phoenix_live_view/installation.html#content" rel="noopener ugc nofollow" target="_blank">文档</a>)。</li><li id="fa5b" class="lb lc hi ju b jv lk jz ll kd lm kh ln kl lo kp lg lh li lj bi translated">您已经使用<code class="du kx ky kz la b">mix phx.gen.auth Accounts Person people</code>(可以替换其他名称)安装并设置了<a class="ae kv" href="https://github.com/aaronrenner/phx_gen_auth" rel="noopener ugc nofollow" target="_blank"> phx_gen_auth </a>(版本0.6+)。</li><li id="fa89" class="lb lc hi ju b jv lk jz ll kd lm kh ln kl lo kp lg lh li lj bi translated">你在用<code class="du kx ky kz la b">phoenix_live_view 0.16+</code>。</li><li id="4b2a" class="lb lc hi ju b jv lk jz ll kd lm kh ln kl lo kp lg lh li lj bi translated">您正在使用<a class="ae kv" href="https://tailwindcss.com/" rel="noopener ugc nofollow" target="_blank"> tailwindcss </a>或了解您自己的css工具。</li><li id="9da4" class="lb lc hi ju b jv lk jz ll kd lm kh ln kl lo kp lg lh li lj bi translated">可选:您已经使用<a class="ae kv" href="https://github.com/thoughtbot/bamboo" rel="noopener ugc nofollow" target="_blank"> Bamboo </a>设置了电子邮件确认。</li><li id="ae4b" class="lb lc hi ju b jv lk jz ll kd lm kh ln kl lo kp lg lh li lj bi translated">注1:默认情况下，Phoenix 1.6+将包含phx.gen.auth生成器</li><li id="3dfe" class="lb lc hi ju b jv lk jz ll kd lm kh ln kl lo kp lg lh li lj bi translated">注2:如果你已经阅读了最初的<a class="ae kv" rel="noopener" href="/swlh/how-to-part-2-swap-registration-flow-to-a-live-view-with-phx-gen-auth-multi-step-form-25371540fce1">第2部分</a>，那么这将是一个快速更新。</li></ul><h1 id="1a38" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">步骤0</h1><p id="db2a" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">好了，让我们来回顾一下最初<a class="ae kv" rel="noopener" href="/swlh/how-to-part-2-swap-registration-flow-to-a-live-view-with-phx-gen-auth-multi-step-form-25371540fce1">第二部分</a>帖子中的<code class="du kx ky kz la b">person_registration_live/new.ex</code>:</p><figure class="lp lq lr ls fd ij"><div class="bz dy l di"><div class="lt lu l"/></div></figure><p id="9477" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">我们马上就要将我们的HTML直接添加到这个文件中，但在此之前，让我们看看我们最初的<a class="ae kv" rel="noopener" href="/swlh/how-to-part-2-swap-registration-flow-to-a-live-view-with-phx-gen-auth-multi-step-form-25371540fce1">第二部分</a>帖子在我们即将被否决的<code class="du kx ky kz la b">templates/person_registration/new.html.leex</code>中给我们留下了什么:</p><figure class="lp lq lr ls fd ij"><div class="bz dy l di"><div class="lt lu l"/></div></figure><p id="6f87" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">精彩！</p><p id="7cb9" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">以此为起点，我们将对实时视图0.16+进行更新，并在新的HTML引擎中使用精彩的<code class="du kx ky kz la b">~H</code>符号。</p><h2 id="c182" class="lv iv hi bd iw lw lx ly ja lz ma mb je kd mc md ji kh me mf jm kl mg mh jq mi bi translated">走小路</h2><p id="da35" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">本快速指南将指导我们完成以下工作:</p><ul class=""><li id="1a54" class="lb lc hi ju b jv kq jz kr kd ld kh le kl lf kp lg lh li lj bi translated">弃用我们的<code class="du kx ky kz la b">templates/person_registration/new.html.leex</code>文件，合并成一个简单的注册页面实时视图文件</li><li id="fdd3" class="lb lc hi ju b jv lk jz ll kd lm kh ln kl lo kp lg lh li lj bi translated">保持我们的路由器和第一部分的帖子一样</li><li id="dc13" class="lb lc hi ju b jv lk jz ll kd lm kh ln kl lo kp lg lh li lj bi translated">在我们的<code class="du kx ky kz la b">person_registration_live/new.ex</code>文件中更新我们现有的<code class="du kx ky kz la b">render/1</code>函数，以使用来自Live View 0.16+的新HTML引擎的<code class="du kx ky kz la b">~H</code>和<code class="du kx ky kz la b">.heex</code>语法</li><li id="5e5a" class="lb lc hi ju b jv lk jz ll kd lm kh ln kl lo kp lg lh li lj bi translated">(可选)使用正在运行的本地服务器会话快速确定下一行需要更新的HTML代码</li><li id="68d9" class="lb lc hi ju b jv lk jz ll kd lm kh ln kl lo kp lg lh li lj bi translated">简化我们的代码库，同时改善我们的开发人员体验和应用程序性能</li></ul><p id="3ddb" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">让我们开始吃吧。</p><h1 id="a945" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">第一步</h1><p id="6de6" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">启动一个本地服务器会话，<code class="du kx ky kz la b">iex -S mix phx.server</code>，打开浏览器，进入您将要编辑的注册页面(这是可选的，但在我看来，这样可以更容易地阅读错误消息)。</p><p id="5526" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">然后，跳转到您的<code class="du kx ky kz la b">templates/person_registration/new.html.leex</code>文件(您的文件的命名或组织可能稍有不同),将那里的所有HTML复制/粘贴回您的<code class="du kx ky kz la b">person_registration_live/new.ex</code>文件，在一个更新的<code class="du kx ky kz la b">render/1</code>函数中，看起来像这样:</p><pre class="lp lq lr ls fd mj la mk ml aw mm bi"><span id="9af6" class="lv iv hi la b fi mn mo l mp mq">#person_registration_live/new.ex<br/>...<br/>  def render(assigns) do<br/>    ~H"""<br/>      &lt;!-- copy/paste your html here --&gt;<br/>    """<br/>  end<br/>...</span><span id="c7db" class="lv iv hi la b fi mr mo l mp mq"># You updated your old render/1 function that used to point to your now deprecated templates/person_registration/new.html.leex file.</span></pre><p id="5f0e" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">您现在可以重命名您的<code class="du kx ky kz la b">templates/person_registration/new.html.leex</code>文件，以表明它现在已被弃用，并将很快被删除(<em class="kw">警告:只有在您测试了您的新代码正常工作后，才删除您的旧文件</em>)。</p><p id="8066" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">太棒了。我们现在已经将两个分散的<em class="kw">文件合并为一个<em class="kw">文件</em>。如果您正在运行本地服务器会话(这正是我们想要的)，那么您现在应该会在浏览器窗口中收到一些错误消息。</em></p><p id="dd02" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">接下来，我们将更新我们的HTML(更具体地说，我们将把我们的<code class="du kx ky kz la b">.leex</code>语法更新为新的<code class="du kx ky kz la b">.heex</code>语法)。</p><h1 id="f914" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">第二步</h1><p id="360a" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">好了，让我们开始更新吧(记住——这里所涉及的工作将根据HTML的大小和复杂性而有所不同):</p><ol class=""><li id="fdce" class="lb lc hi ju b jv kq jz kr kd ld kh le kl lf kp ms lh li lj bi translated">如果您还没有正在运行的本地服务器会话，那么启动一个(此时它很可能无法启动，但是现在您将在控制台和代码编辑器中得到您需要的错误消息)。</li><li id="b8ec" class="lb lc hi ju b jv lk jz ll kd lm kh ln kl lo kp ms lh li lj bi translated">一个错误接一个错误地更新你的HTML以遵循<a class="ae kv" href="https://github.com/phoenixframework/phoenix_live_view/blob/master/CHANGELOG.md" rel="noopener ugc nofollow" target="_blank">变更日志</a>中概述的格式(你也可以参考<a class="ae kv" href="https://hexdocs.pm/phoenix_live_view/Phoenix.LiveView.Helpers.html#form/1" rel="noopener ugc nofollow" target="_blank">实时视图文档</a>)——这是我发现在你的浏览器窗口和代码编辑器旁边阅读错误消息比在控制台窗口更容易的地方。</li><li id="9f1b" class="lb lc hi ju b jv lk jz ll kd lm kh ln kl lo kp ms lh li lj bi translated">注意:如果您收到一个有点可疑的错误消息，很可能是需要将HTML模板标签从<code class="du kx ky kz la b">&lt;%= %&gt;</code>语法切换到<code class="du kx ky kz la b">{}</code>语法。</li><li id="d77e" class="lb lc hi ju b jv lk jz ll kd lm kh ln kl lo kp ms lh li lj bi translated">注意:根据我的经验，关于缺少结束标签<code class="du kx ky kz la b">&lt;/div&gt;</code>或结束于标签<em class="kw">的错误信息，当系统期望标签<em class="kw">和标签</em>的时候，这是正确的(你可以在浏览器错误信息旁边的代码编辑器中使用错误行来清除恶意的HTML，比如额外的标签<code class="du kx ky kz la b">&lt;div&gt;</code>很难被发现)。</em></li></ol><p id="8b69" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">这是一个小小的<em class="kw">细节</em>但是你会从另一个方面得到更好的结果，你甚至可以改进你的HTML(新的HTML引擎不再让你写无效的HTML)。</p><p id="c276" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">在这个例子中，这就是我们涂上<code class="du kx ky kz la b">.heex</code>油漆后的样子:</p><figure class="lp lq lr ls fd ij"><div class="bz dy l di"><div class="lt lu l"/></div></figure><p id="b32a" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">这里值得注意的是:</p><ul class=""><li id="4585" class="lb lc hi ju b jv kq jz kr kd ld kh le kl lf kp lg lh li lj bi translated"><code class="du kx ky kz la b">&lt;.form let={f} for={@changeset} url="#" phx_change="validate phx_submit="save"&gt;</code>和<code class="du kx ky kz la b">&lt;/.form&gt;</code>标记。</li><li id="b2b0" class="lb lc hi ju b jv lk jz ll kd lm kh ln kl lo kp lg lh li lj bi translated">将HTML标签属性中的<code class="du kx ky kz la b">&lt;%= %&gt;</code>替换为<code class="du kx ky kz la b">{}</code>。比如<code class="du kx ky kz la b">&lt;div class={unless @current_step == 1, do: "hidden"}&gt; ... &lt;/div&gt;</code>。</li></ul><p id="d7ec" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">使用新的<code class="du kx ky kz la b">~H</code> sigil <code class="du kx ky kz la b">render/1</code>函数和<code class="du kx ky kz la b">.heex</code>模板语法，您的最终<code class="du kx ky kz la b">person_registration_live/new.ex</code>文件看起来会像这样:</p><figure class="lp lq lr ls fd ij"><div class="bz dy l di"><div class="lt lu l"/></div></figure><p id="5e7c" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">就是这样！</p><p id="0f90" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">你现在已经有了一个与 <strong class="ju hj">凤凰网Live View 0.16+ </strong>协同工作的<strong class="ju hj">多步表单(以及随之而来的所有其他精彩改进)——它可以告诉你你忘记了哪一行结束<code class="du kx ky kz la b">&lt;/div&gt;</code>或其他HTML标签<em class="kw">和</em>它可以防止你编写无效的HTML。</strong></p><h1 id="1283" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">结论</h1><p id="6788" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">嗯，就这样吧！</p><p id="4e0b" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">我们已经更新了我们的工作多步骤表单，以使用新的<strong class="ju hj"> Phoenix Live View 0.16 </strong> +并成功地从<a class="ae kv" rel="noopener" href="/swlh/how-to-swap-registration-flow-to-a-live-view-with-phx-gen-auth-4966f80b412e">第1部分</a>扩展了我们的注册流程。</p><p id="a0fa" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">您可以按照上面的逻辑轻松地添加更多的字段，并根据您的需要构建尽可能多或尽可能少的步骤。</p><p id="da37" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">如果你在你的表单步骤中遇到任何边缘情况，那么我建议查看我最初的<a class="ae kv" rel="noopener" href="/swlh/how-to-part-2-swap-registration-flow-to-a-live-view-with-phx-gen-auth-multi-step-form-25371540fce1">第二部分</a>帖子中的附录。</p><p id="a8ed" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">升级的便利性再次证明了Elixir/Phoenix团队和社区成员所做的大量工作——谢谢！</p><p id="2050" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">一如既往地欢迎改进和想法，特别感谢<a class="ae kv" href="https://www.markusbodner.com/til/2019/05/31/multi-step-form-using-phoenix-live-view/" rel="noopener ugc nofollow" target="_blank"> Markus </a>和<a class="ae kv" href="https://elixirforum.com/" rel="noopener ugc nofollow" target="_blank"> Elixir Forum </a>的社区。</p><h1 id="23ed" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">插头</h1><p id="3529" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">如果你还没看的话，<a class="ae kv" href="https://metamorphic.app" rel="noopener ugc nofollow" target="_blank">变形</a>现已上线，并接受我们早期发布的注册。</p><p id="53ab" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">看到人们注册并为更好的在线生活的可能性而兴奋，这真是太棒了——谢谢大家，敬请关注！</p><p id="6789" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">❤·马克</p></div></div>    
</body>
</html>