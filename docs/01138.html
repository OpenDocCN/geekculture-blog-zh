<html>
<head>
<title>Exploring Application Layer Protocol Negotiation (ALPN)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">探索应用层协议协商(ALPN)</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/exploring-application-layer-protocol-negotiation-alpn-c47b5ec3b419?source=collection_archive---------4-----------------------#2021-03-29">https://medium.com/geekculture/exploring-application-layer-protocol-negotiation-alpn-c47b5ec3b419?source=collection_archive---------4-----------------------#2021-03-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><h2 id="3309" class="hg hh hi bd b fp hj hk hl hm hn ho dx hp translated" aria-label="kicker paragraph"><a class="ae ge" href="https://www.0snet.com" rel="noopener ugc nofollow" target="_blank">第0根安全网络(0SNet) </a></h2><div class=""/><div class=""><h2 id="074f" class="pw-subtitle-paragraph io hr hi bd b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf dx translated">简单的TLS扩展，在单个端口上支持不同的应用程序</h2></div><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es jg"><img src="../Images/5fc79f4ea552be1c464093eacac45b53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*G3yAWyNiALpeIxaS"/></div></div><figcaption class="js jt et er es ju jv bd b be z dx">Photo by <a class="ae jw" href="https://unsplash.com/@juliusjansson?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Julius Jansson</a> on <a class="ae jw" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="c288" class="pw-post-body-paragraph jx jy hi jz b ka kb is kc kd ke iv kf kg kh ki kj kk kl km kn ko kp kq kr ks hb bi kt translated"><span class="l ku kv kw bm kx ky kz la lb di">互联网协议组是现代互联网的基础，它允许单个主机提供不同的服务。这些服务被分配了一个端口号，并且到该端口的任何连接都被认为是用于该服务的。举个例子，服务<em class="lc"> http </em>和<em class="lc"> https </em>分别使用端口号<strong class="jz hs"> 80 </strong>和<strong class="jz hs"> 443 </strong>。</span></p><p id="dce0" class="pw-post-body-paragraph jx jy hi jz b ka kb is kc kd ke iv kf kg kh ki kj kk kl km kn ko kp kq kr ks hb bi translated">这使得网络流量及其管理具有良好的可见性。然而，如果服务使用的协议已经改变并且不是向后兼容的，则需要使用新的端口号。当<strong class="jz hs"> HTTPS </strong>简单地建立一个<strong class="jz hs"> TLS </strong>会话并在其上运行<strong class="jz hs"> HTTP </strong>时，它使用端口<strong class="jz hs"> 443 </strong>而不是端口<strong class="jz hs"> 80 </strong>。</p><p id="0a2d" class="pw-post-body-paragraph jx jy hi jz b ka kb is kc kd ke iv kf kg kh ki kj kk kl km kn ko kp kq kr ks hb bi translated">这导致在部署中，运行在<em class="lc"> https </em>端口上的服务将只处理TLS终止，并将请求传递给处理<em class="lc"> http </em>的同一服务。否则，让服务在<em class="lc"> http </em>端口上运行，将请求重定向到<em class="lc"> https </em>服务，这是它唯一的功能。</p></div><div class="ab cl ld le gp lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="hb hc hd he hf"><h1 id="3164" class="lk ll hi bd lm ln lo lp lq lr ls lt lu ix lv iy lw ja lx jb ly jd lz je ma mb bi translated"><strong class="ak">应用层协议协商— ALPN </strong></h1><p id="973e" class="pw-post-body-paragraph jx jy hi jz b ka mc is kc kd md iv kf kg me ki kj kk mf km kn ko mg kq kr ks hb bi translated">HTTP/2的引入改善了这种情况。HTTP/2依靠TLS扩展<a class="ae jw" href="https://tools.ietf.org/html/rfc7301" rel="noopener ugc nofollow" target="_blank">应用层协议协商(ALPN) </a>来使用通过TLS提供HTTP/1.1服务的同一个<em class="lc"> https </em>端口。这可以无缝地工作，不会导致任何额外的网络延迟，也不需要任何额外的往返或升级机制。</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es mh"><img src="../Images/a1dc6d8793cf89db84c446f1151cf2e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SF8KfgG1QgxXRT5BZQwxNQ.png"/></div></div></figure><p id="bf6c" class="pw-post-body-paragraph jx jy hi jz b ka kb is kc kd ke iv kf kg kh ki kj kk kl km kn ko kp kq kr ks hb bi translated">一旦与服务器建立了连接，TLS要求客户端发送一个<strong class="jz hs"> ClientHello </strong>消息。该消息将包括扩展<em class="lc">应用层协议协商</em>，包含客户端支持的协议id列表。接收端的服务器可以忽略该扩展，或者选择一个协议，并将其作为其<strong class="jz hs"> ServerHello </strong>消息的一部分发送给客户端。</p><p id="62fc" class="pw-post-body-paragraph jx jy hi jz b ka kb is kc kd ke iv kf kg kh ki kj kk kl km kn ko kp kq kr ks hb bi translated">协议id可以是<a class="ae jw" href="https://www.iana.org/assignments/tls-extensiontype-values/tls-extensiontype-values.xhtml#alpn-protocol-ids" rel="noopener ugc nofollow" target="_blank">个注册id</a>中的一个，如<strong class="jz hs">“http/1.1”</strong>代表HTTP/1.1，<strong class="jz hs">“H2”</strong>代表HTTP/2。一旦TLS会话建立，客户机和服务器都将使用商定的应用程序协议。举个例子，如果客户端在其协议列表中发送<strong class="jz hs">【H2】</strong>，而服务器以<strong class="jz hs">【H2】</strong>响应，则客户端应该向服务器发送HTTP/2请求，而不是HTTP/1.1请求，即。，即使使用了<em class="lc"> https </em>端口。</p></div><div class="ab cl ld le gp lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="hb hc hd he hf"><h1 id="9ea0" class="lk ll hi bd lm ln lo lp lq lr ls lt lu ix lv iy lw ja lx jb ly jd lz je ma mb bi translated">TCP端口服务复用器— <strong class="ak"> TCPMUX </strong></h1><p id="1d32" class="pw-post-body-paragraph jx jy hi jz b ka mc is kc kd md iv kf kg me ki kj kk mf km kn ko mg kq kr ks hb bi translated">将单个端口用于多种服务的想法并不新鲜。事实上，端口号<strong class="jz hs"> 1 </strong>被分配给一个名为<a class="ae jw" href="https://tools.ietf.org/html/rfc1078" rel="noopener ugc nofollow" target="_blank"> TCP端口服务复用器(TCPMUX) </a>的服务。客户端可以连接到端口1并发送<strong class="jz hs">服务名&lt;CRLF&gt;T19】。<em class="lc"> tcpmux </em>服务会以<strong class="jz hs">+原因&lt; CRLF &gt; </strong>或<strong class="jz hs">-原因&lt; CRLF &gt; </strong>进行响应。如果得到肯定的响应，客户端就可以启动服务的协议，否则就关闭连接。</strong></p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es mi"><img src="../Images/18a57332497fdcb2b191419e77958736.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n7WSWFzpHA7NQtKP4l7FsA.png"/></div></div></figure><p id="a53d" class="pw-post-body-paragraph jx jy hi jz b ka kb is kc kd ke iv kf kg kh ki kj kk kl km kn ko kp kq kr ks hb bi translated">TCPMUX被<a class="ae jw" href="https://tools.ietf.org/html/rfc7805" rel="noopener ugc nofollow" target="_blank">弃用</a>。然而，我们可以用ALPN获得类似的功能。非HTTP TLS客户端有可能发送ALPN服务请求，服务器可以接受或拒绝该请求。请注意，ALPN确实为拒绝案例定义了致命警报<em class="lc">no _ application _ protocol</em>。</p><p id="3f73" class="pw-post-body-paragraph jx jy hi jz b ka kb is kc kd ke iv kf kg kh ki kj kk kl km kn ko kp kq kr ks hb bi translated">然而，没有任何单一的端口分配给ALPN连接到一个人希望的服务。即使有，也有缺点，人们可以从<a class="ae jw" href="https://tools.ietf.org/html/rfc7805#page-4" rel="noopener ugc nofollow" target="_blank"> TCPMUX弃用</a>中了解到，例如两台机器之间的最大连接数减少以及复杂的防火墙管理。</p></div><div class="ab cl ld le gp lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="hb hc hd he hf"><h1 id="641c" class="lk ll hi bd lm ln lo lp lq lr ls lt lu ix lv iy lw ja lx jb ly jd lz je ma mb bi translated">顶点</h1><p id="a675" class="pw-post-body-paragraph jx jy hi jz b ka mc is kc kd md iv kf kg me ki kj kk mf km kn ko mg kq kr ks hb bi translated">ALPN的另一个主要用途是自动证书颁发。在2018年初发现<a class="ae jw" href="https://tools.ietf.org/html/rfc8555" rel="noopener ugc nofollow" target="_blank">自动证书管理环境(ACME) </a>协议使用的基于SNI的方法通过<em class="lc"> https </em>端口进行域验证是不安全的。这促使一种新的挑战方法在ALPN上进行域名验证。</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es mj"><img src="../Images/9099b447428d5b25ccc97e3c171cd27e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bjYrm0ppybuoE0typAVFZg.png"/></div></div></figure><p id="3299" class="pw-post-body-paragraph jx jy hi jz b ka kb is kc kd ke iv kf kg kh ki kj kk kl km kn ko kp kq kr ks hb bi translated">为此目的分配了ALPN协议id<strong class="jz hs">“acme-TLS/1”</strong>。支持客户端和服务器将使用ALPN扩展中的<strong class="jz hs">“acme-TLS/1”</strong>来执行域验证。需要注意的一个有趣事实是，没有<a class="ae jw" href="https://tools.ietf.org/html/rfc8737#section-4" rel="noopener ugc nofollow" target="_blank">应用数据</a>。</p><blockquote class="mk ml mm"><p id="1ca2" class="jx jy lc jz b ka kb is kc kd ke iv kf mn kh ki kj mo kl km kn mp kp kq kr ks hb bi translated">该协议包括一个TLS握手，其中传输所需的验证信息。“acme-tls/1”协议不携带应用程序数据。握手完成后，客户端不能再与服务器交换任何数据，必须立即关闭连接。</p></blockquote></div><div class="ab cl ld le gp lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="hb hc hd he hf"><h2 id="ea65" class="mq ll hi bd lm mr ms mt lq mu mv mw lu kg mx my lw kk mz na ly ko nb nc ma ho bi translated">nginx配置</h2><p id="2e89" class="pw-post-body-paragraph jx jy hi jz b ka mc is kc kd md iv kf kg me ki kj kk mf km kn ko mg kq kr ks hb bi translated">实际上，可以配置代理服务器，根据ALPN将流量路由到相应的服务。使用<em class="lc"> nginx </em>，用户可以使用<a class="ae jw" href="http://nginx.org/en/docs/stream/ngx_stream_ssl_preread_module.html" rel="noopener ugc nofollow" target="_blank"><em class="lc">stream _ SSL _ preread _ module</em></a>并将ALPN协议id映射到其相应的上游服务。</p><pre class="jh ji jj jk fd nd ne nf ng aw nh bi"><span id="27d1" class="mq ll hi ne b fi ni nj l nk nl">stream {<br/>  map $ssl_preread_server_name $x_name {<br/>    hostnames;<br/>    default 10.0.3.11:443;<br/>  }</span><span id="6632" class="mq ll hi ne b fi nm nj l nk nl">  map $ssl_preread_alpn_protocols $x_up {<br/>    ~\bacme-tls/1\b 127.0.0.1:10443;<br/>    default         $x_name;<br/>  }</span><span id="13c0" class="mq ll hi ne b fi nm nj l nk nl">  server {<br/>    listen 443;<br/>    proxy_pass $x_up;<br/>    ssl_preread on;<br/>  }<br/>}</span></pre><p id="5090" class="pw-post-body-paragraph jx jy hi jz b ka kb is kc kd ke iv kf kg kh ki kj kk kl km kn ko kp kq kr ks hb bi translated">上面显示的示例配置可用于基于ALPN协议id和服务器名称(SNI)设置代理。它将协议id<strong class="jz hs">“acme-TLS/1”</strong>映射到本地服务127.0.0.1:10443，并将所有其他应用协议映射到基于服务器名称的映射。请注意，TLS终端将位于上游服务器上。</p></div><div class="ab cl ld le gp lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="hb hc hd he hf"><p id="d0a5" class="pw-post-body-paragraph jx jy hi jz b ka kb is kc kd ke iv kf kg kh ki kj kk kl km kn ko kp kq kr ks hb bi translated">随着ALPN的引入，术语<strong class="jz hs">超过<em class="lc"> https </em> </strong>可以有新的含义。因为只要客户端支持ALPN，就可以在https端口上提供几乎任何服务。这提供了很大的灵活性。而且，随着对ALPN的支持越来越广泛，我们可能会看到它的真正潜力。</p><h2 id="a1aa" class="mq ll hi bd lm mr ms mt lq mu mv mw lu kg mx my lw kk mz na ly ko nb nc ma ho bi translated">参考资料:</h2><ol class=""><li id="4b5d" class="nn no hi jz b ka mc kd md kg np kk nq ko nr ks ns nt nu nv bi translated"><strong class="jz hs">https://tools.ietf.org/html/rfc7301</strong>，<a class="ae jw" href="https://tools.ietf.org/html/rfc7301" rel="noopener ugc nofollow" target="_blank">ALPN</a></li><li id="cd07" class="nn no hi jz b ka nw kd nx kg ny kk nz ko oa ks ns nt nu nv bi translated"><strong class="jz hs"> TCPMUX </strong>，<a class="ae jw" href="https://tools.ietf.org/html/rfc1078" rel="noopener ugc nofollow" target="_blank">https://tools.ietf.org/html/rfc1078</a></li><li id="4f90" class="nn no hi jz b ka nw kd nx kg ny kk nz ko oa ks ns nt nu nv bi translated"><strong class="jz hs"> TLS-ALPN-01 </strong>，【https://tools.ietf.org/html/rfc8737】T2</li></ol></div><div class="ab cl ld le gp lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="hb hc hd he hf"><p id="5d0b" class="pw-post-body-paragraph jx jy hi jz b ka kb is kc kd ke iv kf kg kh ki kj kk kl km kn ko kp kq kr ks hb bi translated"><em class="lc">在第0根，我们提供解决方案</em> <a class="ae jw" href="https://www.0snet.com/" rel="noopener ugc nofollow" target="_blank"> <em class="lc">第0根安全网络— 0SNet </em> </a> <em class="lc">使用TLS客户端证书保护组织的内部web应用。请检查我们的产品，它易于部署，并可作为图像显示在</em><a class="ae jw" href="https://0snet.info/#install.aws" rel="noopener ugc nofollow" target="_blank"><em class="lc">AWS</em></a><em class="lc">，</em><a class="ae jw" href="https://0snet.info/#install.gcp" rel="noopener ugc nofollow" target="_blank"><em class="lc">GCP</em></a><em class="lc">和</em><a class="ae jw" href="https://0snet.info/#install.azu" rel="noopener ugc nofollow" target="_blank"><em class="lc">Azure</em></a><em class="lc">上。</em></p></div></div>    
</body>
</html>