<html>
<head>
<title>How Can Symlink Cause An Outage?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Symlink是如何导致停机的？</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/how-can-symlink-cause-an-outage-6863ac526172?source=collection_archive---------18-----------------------#2021-07-01">https://medium.com/geekculture/how-can-symlink-cause-an-outage-6863ac526172?source=collection_archive---------18-----------------------#2021-07-01</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="b8ba" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">一个小小的无害的便利会变成一个非常有害的不便。</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/12674d87217b350c7077d57dbbac34a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1b7sFaQeJogwMrPBsgrRQw.jpeg"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">A vector-based artwork showing a man with a bat trying to fight a huge insect coming off the computer screen</figcaption></figure><p id="f3c5" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">我在Monorepo的一个NodeJS Web服务器上工作。该项目有多个彼此相同的npm项目，每个项目都在一个可部署的。自制的网关/代理将用户请求转发到每个单独的服务中。</p><p id="628d" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">其中一个NPM模块(我们称之为"<strong class="jp hj"> PrincipalModule </strong>")包含了另一个兄弟模块<code class="du kj kk kl km b">npm install --save ../my-dependency</code>(我们称之为"<strong class="jp hj"> DependencyModule </strong>")。PrincipalModule使用NPM本地模块安装添加了依赖项:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es kn"><img src="../Images/856fde415df6c576f54899587b3ada5a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1220/format:webp/1*toTbrMglxhQ8vOMgTe9xnw.png"/></div></figure><p id="3ec0" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">这个问题始于对方便的需求。</p><p id="8c37" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">我做了一个更改，在DependencyModule中使用<code class="du kj kk kl km b"><a class="ae ko" href="https://www.npmjs.com/package/app-root-path" rel="noopener ugc nofollow" target="_blank">app-root-path</a></code>从其项目的根目录加载组件，比如<code class="du kj kk kl km b">const something = require(`${root}/src/path/to/something`);</code>。它导入了DependencyModule的一些公共类，这些类将在PrincipalModule的上下文中运行。</p><p id="6c13" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">在本地开发和整个CI流程中，一切都很好。包括UI测试在内的所有测试都是绿色的，这些测试会在部署之前将所有的服务器一起旋转起来。然而，在代码进入生产阶段后，我收到一条短信警告，说prod关闭了，并显示以下错误:“找不到模块x”。<code class="du kj kk kl km b">x</code>是代码使用<code class="du kj kk kl km b">app-root-path</code>解析根导入的一个类的名称。</p><p id="e593" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">这是一个用户数量很少的小项目。我们已经推迟了一些操作更改，这可以使系统在服务器启动失败时100%可用。由于这个原因，这个错误导致了停机。</p><p id="4c46" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">在这个项目中有大量的测试覆盖。如果您查看代码和部署过程，似乎不可能在一些代码更改后立即发生中断。在达到这一点之前，您可能会想到一些测试会失败。当然，仍有可能出现第三方欺诈或随后触发一些bug，考虑到业务环境，这是我们可以安全承担的风险。然而，在部署之后立即出现bug是不可预料的。这几乎是不可能的，到底发生了什么？</p><p id="b02a" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">我很困惑。集成测试是绿色的，所有使用真实服务器的UI测试也是绿色的。我尝试运行相同的CI命令来构建类似prod的应用程序。没有骰子。我无法重现这个问题。</p><p id="a86c" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">有趣的事情正在发生。</p><blockquote class="kp"><p id="5430" class="kq kr hi bd ks kt ku kv kw kx ky ki dx translated">该系统有体面的测试覆盖率和高于曲线的部署过程；似乎不可能在部署后立即观察到中断。发生了什么事？</p></blockquote><p id="1a11" class="pw-post-body-paragraph jn jo hi jp b jq kz ij js jt la im jv jw lb jy jz ka lc kc kd ke ld kg kh ki hb bi translated">我在恢复到工作提交后，通过部署一些日志记录，开始在prod中进行一些调试。以下是我的发现:</p><p id="e272" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">当在PrincipalModule的上下文中运行DependencyModule时，我希望<code class="du kj kk kl km b">app-root-path</code>将它解析为DependencyModule的根。然而，它被解析为主模的根。在本地开发模式和CI服务器中，行为是我所期望的:根是相对于DependencyModule的。</p><p id="e0e2" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">经过一些研究，我发现当你运行<code class="du kj kk kl km b">npm install ../dependency</code>时，NPM会自动在依赖项和主体之间创建一个符号链接；符号链接位于主体的<code class="du kj kk kl km b">node_modules</code>文件夹中。<code class="du kj kk kl km b">app-root-path</code>模块使用<code class="du kj kk kl km b">__dirname</code>寻找根，由于符号链接，解析为<code class="du kj kk kl km b">../dependency</code>的根。我试着删除所有的<code class="du kj kk kl km b">node_modules</code>、<code class="du kj kk kl km b">package-lock.json</code>文件，并在本地重新安装。NPM总是创建那个符号链接，所以我仍然不能在本地重现“找不到模块”的问题。</p><p id="4bbe" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">为什么代码的行为与prod中的不同？同样的节点版本，同样的NPM版本，同样的<code class="du kj kk kl km b">app-root-path</code>principal module和DependencyModule版本！我直接从管道生成的工件下载了zip文件中的代码，并尝试在本地运行它。</p><p id="6150" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">这时候我终于重现了bug！这是问题的根源:</p><p id="1516" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">代码在prod中找不到某个模块，因为主体和依赖项之间的符号链接已不存在。<code class="du kj kk kl km b">app-root-path</code>包在prod中从PrincipalModule模块解析根，但是在本地，它从DependencyModule模块解析根。与<code class="du kj kk kl km b">app-root-path</code>项目中报道的<a class="ae ko" href="https://github.com/inxilpro/node-app-root-path/issues/33" rel="noopener ugc nofollow" target="_blank">这个问题</a>相关的是不同的上下文。</p><blockquote class="kp"><p id="d2b3" class="kq kr hi bd ks kt ku kv kw kx ky ki dx translated">哦，好吧…你提到“压缩文件”了吗？</p></blockquote><p id="f27a" class="pw-post-body-paragraph jn jo hi jp b jq kz ij js jt la im jv jw lb jy jz ka lc kc kd ke ld kg kh ki hb bi translated">我用的是弹性豆茎(EBS)。EBS要求在运行<code class="du kj kk kl km b">eb</code>命令上传到服务器之前，将项目作为zip文件发送。</p><p id="47f7" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">在部署之前，构建过程使用macOS <code class="du kj kk kl km b">zip</code>命令行压缩所有代码并发送给EBS。然后，它将zip文件上传到prod服务器，并解压缩代码以调用<code class="du kj kk kl km b">npm start</code>。</p><p id="111e" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">如果你知道symlink是如何工作的，你现在可能已经找到了问题所在。</p><p id="8d5f" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">捆绑<code class="du kj kk kl km b">node_modules</code>，然后在构建过程中压缩，然后在不运行<code class="du kj kk kl km b">npm install</code>的情况下在prod中解压缩的行为删除了NPM自动创建的符号链接。由于符号链接消失了，<code class="du kj kk kl km b">app-root-path</code>解析了PrincipalModule的根路径，而不是DependencyModule的根路径。</p><p id="01e6" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">prod中导入的文件的位置是不正确的，并且当您在机器上安装该项目时也不可能再现。</p><p id="6ff0" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">这是不可思议的，直到你找到根本原因，然后变得愚蠢。</p><h2 id="f196" class="le lf hi bd lg lh li lj lk ll lm ln lo jw lp lq lr ka ls lt lu ke lv lw lx ly bi translated"><strong class="ak">我的一些收获</strong></h2><ul class=""><li id="5cd2" class="lz ma hi jp b jq mb jt mc jw md ka me ke mf ki mg mh mi mj bi translated">压缩会删除符号链接。是的，我不经常使用symlink，所以我不知道这件事。</li><li id="ffed" class="lz ma hi jp b jq mk jt ml jw mm ka mn ke mo ki mg mh mi mj bi translated">使用NPM时，要理解运行npm install时NPM背后的符号链接魔力。</li></ul><p id="0ea2" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">我开始使用<code class="du kj kk kl km b">app-root-path</code>只是为了方便从根目录导入我的所有模块。现在，我学会了不要太依赖这些东西，并结合依赖于环境的第三方依赖来对系统做出推断。依赖于这一点使得系统容易出现难以调试的边缘情况。</p><h2 id="8319" class="le lf hi bd lg lh li lj lk ll lm ln lo jw lp lq lr ka ls lt lu ke lv lw lx ly bi translated"><strong class="ak">对@npmjs的一些建议:</strong></h2><p id="04ec" class="pw-post-body-paragraph jn jo hi jp b jq mb ij js jt mc im jv jw mp jy jz ka mq kc kd ke mr kg kh ki hb bi translated">每当命令出现在文档中时，记录它们背后的魔力。</p><p id="7e42" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">在<code class="du kj kk kl km b">npm install</code>司令部的文件中确实有一行这样写道:</p><blockquote class="ms mt mu"><p id="651c" class="jn jo mv jp b jq jr ij js jt ju im jv mw jx jy jz mx kb kc kd my kf kg kh ki hb bi translated"><code class="du kj kk kl km b">npm install &lt;folder&gt;</code>:</p><p id="69f8" class="jn jo mv jp b jq jr ij js jt ju im jv mw jx jy jz mx kb kc kd my kf kg kh ki hb bi translated">将包安装在目录<strong class="jp hj">中，作为当前项目中的符号链接</strong>。</p><p id="ee9b" class="jn jo mv jp b jq jr ij js jt ju im jv mw jx jy jz mx kb kc kd my kf kg kh ki hb bi translated">—<a class="ae ko" href="https://docs.npmjs.com/cli/v7/commands/npm-install" rel="noopener ugc nofollow" target="_blank">https://docs.npmjs.com/cli/v7/commands/npm-install</a></p></blockquote><p id="b38d" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">然而，在研究这个问题的时候，我没有看那部分文档。这是有原因的。</p><p id="63a9" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">原因是在我运行<code class="du kj kk kl km b">npm install</code>安装DependencyModule之后问题并没有发生，所以查看<code class="du kj kk kl km b">install</code>命令的文档没有任何意义。相反，代码已经在PrincipalModule中安装了DependencyModule在代码试图使用<code class="du kj kk kl km b">_dirname</code>到<code class="du kj kk kl km b">app-root-path</code>之后，bug才暴露出来。</p><p id="dc9c" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">相反，我查看了NPM网站上的<a class="ae ko" href="https://docs.npmjs.com/cli/v7/configuring-npm/package-json#local-paths" rel="noopener ugc nofollow" target="_blank">本地路径文档</a>,那里没有任何东西说明有一个符号链接正在安装本地包。</p><blockquote class="kp"><p id="21ea" class="kq kr hi bd ks kt ku kv kw kx ky ki dx translated">今天我学到了:NPM在本地文件上安装会创建一个符号链接。默认情况下,“zip”命令行没有符号链接。</p></blockquote><p id="c12f" class="pw-post-body-paragraph jn jo hi jp b jq kz ij js jt la im jv jw lb jy jz ka lc kc kd ke ld kg kh ki hb bi translated">现在我可以:</p><ol class=""><li id="0c74" class="lz ma hi jp b jq jr jt ju jw mz ka na ke nb ki nc mh mi mj bi translated">停止使用<code class="du kj kk kl km b">app-root-path</code>。相反，相对于模块在文件系统中的位置来导入模块，而不考虑项目的根[1]。</li><li id="7c32" class="lz ma hi jp b jq mk jt ml jw mm ka mn ke mo ki nc mh mi mj bi translated">使用<code class="du kj kk kl km b">zip --symlink</code>压缩prod的代码，并给出明显的注释说明原因[2]。</li></ol><p id="a988" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">这个问题很好地展示了无害的便利何时会变成中断。</p><blockquote class="kp"><p id="6981" class="kq kr hi bd ks kt ku kv kw kx ky ki dx translated">一个小小的无害的便利会变成一个非常有害的不便。</p></blockquote><p id="045e" class="pw-post-body-paragraph jn jo hi jp b jq kz ij js jt la im jv jw lb jy jz ka lc kc kd ke ld kg kh ki hb bi translated">你对此有什么想法？你能防止这种错误发生吗？</p><p id="3c67" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">很高兴听到你的想法。</p></div><div class="ab cl nd ne gp nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="hb hc hd he hf"><p id="e6e7" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">1:这里的问题是，无论何时创建新目录，您都必须依赖IDE自动调整相对路径。另一个问题是，Git显示了从<code class="du kj kk kl km b">../</code>到<code class="du kj kk kl km b">../../</code>的目录变化，而不是更清晰的从<code class="du kj kk kl km b">${root}/src/book-payments/ConnectRepository.js</code>到<code class="du kj kk kl km b">${root}/src/book-payments/storage/ConnectRepository.js</code>的目录变化。</p><p id="fcf6" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">2:这是以将系统的一部分中使用的一个命令与另一部分中使用的一个命令耦合为代价的。当开发人员阅读代码时，各部分之间没有明确的因果关系。</p></div><div class="ab cl nd ne gp nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="hb hc hd he hf"><p id="f054" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">如果你的团队从我关于这篇文章或我正在进行的任何其他项目的谈话和/或问答中受益，请在<code class="du kj kk kl km b">contact at fagnermartins.com</code>给我写信。</p></div><div class="ab cl nd ne gp nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="hb hc hd he hf"><p id="2bfc" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">感谢<strong class="jp hj"> Marcel Silva、</strong>和<a class="ae ko" href="https://twitter.com/rradczewski" rel="noopener ugc nofollow" target="_blank"><strong class="jp hj">Raimo Radczewski</strong></a>对本文的深刻见解。</p><p id="b226" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">感谢阅读。如果您有任何反馈，请通过<a class="ae ko" href="https://twitter.com/FagnerBrack" rel="noopener ugc nofollow" target="_blank"> Twitter </a>、<a class="ae ko" href="https://www.facebook.com/fagner.brack" rel="noopener ugc nofollow" target="_blank">脸书</a>或<a class="ae ko" href="http://github.com/FagnerMartinsBrack" rel="noopener ugc nofollow" target="_blank"> Github </a>联系我。</p></div></div>    
</body>
</html>