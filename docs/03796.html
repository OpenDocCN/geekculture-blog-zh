<html>
<head>
<title>The Hardest Production Bug That I Faced During My Software Engineering Career.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我在软件工程职业生涯中遇到的最大的产品缺陷。</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/the-weirdest-bug-that-i-faced-during-my-software-engineering-career-4278fa40215f?source=collection_archive---------45-----------------------#2021-06-15">https://medium.com/geekculture/the-weirdest-bug-that-i-faced-during-my-software-engineering-career-4278fa40215f?source=collection_archive---------45-----------------------#2021-06-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/f0f5b4a6397d2663809b30f930277249.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DoBX7LLi0KKOvKHUOseUsQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">The unexpected “Not Modified” screen.</figcaption></figure><p id="07a3" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在这篇文章中，我将描述我一生中遇到的最奇怪的Internet Explorer错误，我们如何<strong class="iw hj">诊断它，</strong>以及我们如何在我的公司里设法<strong class="iw hj">纠正它</strong>。</p></div><div class="ab cl js jt gp ju" role="separator"><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx"/></div><div class="hb hc hd he hf"><p id="7d5e" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">当你读到这篇文章的时候，IE可能已经不存在了，因为微软已经宣布在2022年6月15日<a class="ae jz" href="https://blogs.windows.com/windowsexperience/2021/05/19/the-future-of-internet-explorer-on-windows-10-is-in-microsoft-edge/" rel="noopener ugc nofollow" target="_blank"/>之前放弃它，所以大多数公司和个人应该努力转移到另一个浏览器以保持安全，这对web开发人员来说是个好消息，因为他们知道Internet Explorer在web开发方面一直是个棘手的问题，主要是因为它的各种CSS和JavaScript不兼容，我们经常可以找到一些针对这类问题的补钉；<strong class="iw hj">我在本文中要描述的问题与JS或CSS无关，这是IE在收到外来HTTP响应时的一种非常奇怪的行为，所以这一次我们不能说这是IE的错。</strong></p></div><div class="ab cl js jt gp ju" role="separator"><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx"/></div><div class="hb hc hd he hf"><h2 id="0663" class="ka kb hi bd kc kd ke kf kg kh ki kj kk jf kl km kn jj ko kp kq jn kr ks kt ku bi translated">背景📃</h2><p id="7586" class="pw-post-body-paragraph iu iv hi iw b ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn kz jp jq jr hb bi translated">我在一家保险公司从事B2B项目，我们的一个客户在其所有IT基础设施中将IE部署为默认浏览器，因此我们需要确保我们的网站在IE上的运行与在其他浏览器上的运行一样完美，<strong class="iw hj">最近，我们的客户向我们报告了一个影响我们一个网站的严重错误，这个错误是如此奇特，以至于我决定就此写一篇博文。</strong></p><p id="b289" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">基本上，这个bug通过在我们网站的DOM开头添加多行“Not Modified”字符串后跟一些HTTP头来影响我们网站的显示。</strong></p><p id="81b8" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">是什么让这个bug如此奇特</strong>👽</p><ul class=""><li id="55d9" class="la lb hi iw b ix iy jb jc jf lc jj ld jn le jr lf lg lh li bi translated">这个错误是随机发生的。</li><li id="44c3" class="la lb hi iw b ix lj jb lk jf ll jj lm jn ln jr lf lg lh li bi translated">经过数千次尝试后，我们只能重现这个错误几次。</li><li id="57be" class="la lb hi iw b ix lj jb lk jf ll jj lm jn ln jr lf lg lh li bi translated">它只发生在IE和生产环境中。</li><li id="b98b" class="la lb hi iw b ix lj jb lk jf ll jj lm jn ln jr lf lg lh li bi translated">在bug报告之前，没有重大变更被推送到prod。</li></ul></div><div class="ab cl js jt gp ju" role="separator"><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx"/></div><div class="hb hc hd he hf"><h2 id="bc7d" class="ka kb hi bd kc kd ke kf kg kh ki kj kk jf kl km kn jj ko kp kq jn kr ks kt ku bi translated">复制Bug🐛</h2><p id="f9e8" class="pw-post-body-paragraph iu iv hi iw b ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn kz jp jq jr hb bi translated">由于错误的随机性，这是一项艰巨的任务，即使在我们客户端的相同生态系统上进行了数千次刷新后，我们也无法在我们的机器上重现错误，我们最终做的是创建一个Selenium程序来为我们刷新页面，并检查页面的DOM中的<strong class="iw hj">“Not Modified”</strong>字符串。</p><figure class="lp lq lr ls fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lo"><img src="../Images/bebf71d158a3adcc8143dca9e36fb3aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RXCYgmWzgxG4Z_3cK7z4xw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Python Script for reproducing the bug</figcaption></figure><p id="dff2" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">运行这个程序一段时间后，我们设法重现了这个错误，并导出了包含<strong class="iw hj">“Not Modified”</strong>字符串的HTML。</p><figure class="lp lq lr ls fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/f0f5b4a6397d2663809b30f930277249.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DoBX7LLi0KKOvKHUOseUsQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">The unexpected “Not Modified” screen.</figcaption></figure><blockquote class="lt lu lv"><p id="0595" class="iu iv lw iw b ix iy iz ja jb jc jd je lx jg jh ji ly jk jl jm lz jo jp jq jr hb bi translated">既然我们成功地重现了这个bug，我们就需要理解为什么我们会在页面顶部出现这个意想不到的内容。</p></blockquote><p id="c611" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">为此，我们必须从基础设施的角度来看待应用的架构:</p><figure class="lp lq lr ls fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ma"><img src="../Images/14aba09df5704bfb4067fb27266ac9a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D9iJvc3_8KQm3OpBCuJP6A.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">The Infrastructure Architecture of the app.</figcaption></figure><p id="d33d" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">从下面的架构中，我们确定了一些潜在的有问题的组件，并有一些假设。</p><p id="6b09" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj"> <em class="lw">哪些组件可以编辑HTML呈现的页面？</em>T3】</strong></p><ol class=""><li id="e431" class="la lb hi iw b ix iy jb jc jf lc jj ld jn le jr mb lg lh li bi translated">Mashup服务器负责服务器端的集成，它直接作用于HTML渲染，它可能在从CMS检索缓存资产时有一个错误，所以我们试图禁用CMS服务器上的缓存，但错误仍然存在。</li><li id="0b0e" class="la lb hi iw b ix lj jb lk jf ll jj lm jn ln jr mb lg lh li bi translated">Javascript可以在客户端编辑HTML在发送一些XHR请求后，我们逐个分析了XHR请求，但它们都没有304响应代码，但<strong class="iw hj">我们观察到“未修改”字符串不是第一个paint内容</strong>的一部分，因此我们强烈认为Javascript应该对这一点上的错误负责(后来我们知道我们错了)。</li></ol></div><div class="ab cl js jt gp ju" role="separator"><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx"/></div><div class="hb hc hd he hf"><h2 id="a71e" class="ka kb hi bd kc kd ke kf kg kh ki kj kk jf kl km kn jj ko kp kq jn kr ks kt ku bi translated">深入调试🧿</h2><blockquote class="lt lu lv"><p id="d639" class="iu iv lw iw b ix iy iz ja jb jc jd je lx jg jh ji ly jk jl jm lz jo jp jq jr hb bi translated">当时，我们当然知道问题发生在客户端，因为“未修改”字符串不是第一个paint内容的一部分。</p></blockquote><p id="6c99" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我们坚信一些JS负责在屏幕上打印这些奇怪的标题，我们分析了我们在传统JSF应用程序(应用程序后端)上使用的所有库，我们有许多JS库要分析，例如<a class="ae jz" href="https://sarissa.sourceforge.io/howtos.html" rel="noopener ugc nofollow" target="_blank"> Sarissa JS </a>，Sarissa很容易指出，因为它充当了XHR请求的包装器，我们审查了几乎所有的JS代码，只是意识到没有一行JS在我们应用程序的DOM上注入这些不需要的标题。</p><blockquote class="lt lu lv"><p id="5d96" class="iu iv lw iw b ix iy iz ja jb jc jd je lx jg jh ji ly jk jl jm lz jo jp jq jr hb bi translated">此时，我们知道错误发生在客户端，但Javascript对此没有责任。</p></blockquote><p id="d7fe" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">与Chrome和Firefox等最新的网络浏览器不同，IE没有一些像样的调试功能，IE上的网络选项卡误导了我们的调查，让我解释一下原因:</p><figure class="lp lq lr ls fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mc"><img src="../Images/58ecb2bd2c4b674e4723274418b57e92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lz8kAdNssyDorLGBOXg4xw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">IE — Network tab</figcaption></figure><p id="2e8d" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这里关于network选项卡的误导之处在于，HTTP 304响应与主体内容相关联，没有迹象表明主体是从本地缓存中检索的，而不是从实际的响应中检索的(应该没有主体内容与之相关联)，因此如果您没有真正注意，您很容易认为主体是通过304响应从服务器返回的。</p><p id="0445" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我们决定查看如何从我们的后端接收单个304资源，为此，我们使用了一个非常有趣的名为Fiddler的程序，这是一个调试代理服务器工具，用于记录、检查和更改web客户端和web服务器之间的HTTP甚至HTTPS流量。</p><figure class="lp lq lr ls fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es md"><img src="../Images/9d7414cd5e4af8bbfd3256e0fa31dd8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4XuTHDlzXJ4v9i5UemnbhA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">HTTP 304 response with a Body!</figcaption></figure><h2 id="30cd" class="ka kb hi bd kc kd ke kf kg kh ki kj kk jf kl km kn jj ko kp kq jn kr ks kt ku bi translated">答对了。</h2><p id="cfeb" class="pw-post-body-paragraph iu iv hi iw b ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn kz jp jq jr hb bi translated">通过使用Fiddler，我们发现了一个严重的问题，我们注意到我们的304响应有一个违反HTTP协议的主体内容(12字节)。</p><blockquote class="lt lu lv"><p id="cdd3" class="iu iv lw iw b ix iy iz ja jb jc jd je lx jg jh ji ly jk jl jm lz jo jp jq jr hb bi translated">304响应<a class="ae jz" href="https://httpstatuses.com/304" rel="noopener ugc nofollow" target="_blank">不能包含消息体</a>；它总是由标题字段后的第一个空行终止。</p></blockquote><p id="fbc0" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">查看以下文章，以正确的方式学习HTTP:)</p><div class="me mf ez fb mg mh"><a href="https://mecheri-akram.medium.com/before-learning-rest-soap-graphql-you-need-to-understand-http-9eb80de6cfbf" rel="noopener follow" target="_blank"><div class="mi ab dw"><div class="mj ab mk cl cj ml"><h2 class="bd hj fi z dy mm ea eb mn ed ef hh bi translated">在学习Rest / Soap / GraphQL /之前你需要了解HTTP！</h2><div class="mo l"><h3 class="bd b fi z dy mm ea eb mn ed ef dx translated">HTTP代表超文本传输协议，最初是为web浏览器/服务器通信而创建的，它有更多的…</h3></div><div class="mp l"><p class="bd b fp z dy mm ea eb mn ed ef dx translated">mecheri-akram.medium.com</p></div></div><div class="mq l"><div class="mr l ms mt mu mq mv io mh"/></div></div></a></div><p id="0f3e" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">现在我们知道，我们的服务器正在为缓存的资源返回一些奇特的HTTP响应，与Chrome和Firefox不同，IE不容忍这种违反协议的行为，并通过将这些响应的正文直接打印到DOM上来表现怪异。</p><h2 id="cf73" class="ka kb hi bd kc kd ke kf kg kh ki kj kk jf kl km kn jj ko kp kq jn kr ks kt ku bi translated">那么304 HTTP响应是从哪里得到正文的呢？</h2><p id="ad2a" class="pw-post-body-paragraph iu iv hi iw b ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn kz jp jq jr hb bi translated">当我们直接从Mashup服务器获取资源时，我们会收到一个没有主体内容的304响应(L.1)，但是当通过RP时，我们会收到一个有主体内容的304响应(L.2)。</p><figure class="lp lq lr ls fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mw"><img src="../Images/56f75daa120c0c55406e5475d0df8b0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hkZWk43fnCKtdWNQz25Pdw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Tomcat access log</figcaption></figure><p id="60e8" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">RP通过<a class="ae jz" href="https://en.wikipedia.org/wiki/Apache_JServ_Protocol" rel="noopener ugc nofollow" target="_blank"> AJP </a>协议连接到混搭服务器，我们对Tomcat服务器的AJP连接器做了一些研究，结果发现这个连接器确实存在<a class="ae jz" href="https://bz.apache.org/bugzilla/show_bug.cgi?id=55453" rel="noopener ugc nofollow" target="_blank">问题。</a></p><p id="3af0" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">Tomcat 7 . 0 . 43版修复了这个错误，所以我们只需升级我们的Tomcat服务器版本来纠正这个问题。</p></div><div class="ab cl js jt gp ju" role="separator"><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx"/></div><div class="hb hc hd he hf"><h2 id="6441" class="ka kb hi bd kc kd ke kf kg kh ki kj kk jf kl km kn jj ko kp kq jn kr ks kt ku bi translated">最终想法:</h2><p id="e1bb" class="pw-post-body-paragraph iu iv hi iw b ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn kz jp jq jr hb bi translated">我花时间写下这个特殊的经历有很多原因，首先，我希望面临类似错误的人可以在这里找到帮助，然后对于我的web开发同事，我想指出了解你的应用程序所有层的重要性，不要成为一个专属的前端或后端开发人员，否则，你将无法诊断一些严重的错误，就像本文中描述的那样，最后，产品经理，请停止使用/支持IE:)</p></div><div class="ab cl js jt gp ju" role="separator"><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx"/></div><div class="hb hc hd he hf"><p id="b9cf" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">就这样</strong>，如果你觉得这篇文章有趣，请不要犹豫，让我发表评论和/或点击👏下面的按钮。</p><h2 id="2870" class="ka kb hi bd kc kd ke kf kg kh ki kj kk jf kl km kn jj ko kp kq jn kr ks kt ku bi translated">参考资料:</h2><div class="me mf ez fb mg mh"><a href="https://httpstatuses.com/304" rel="noopener  ugc nofollow" target="_blank"><div class="mi ab dw"><div class="mj ab mk cl cj ml"><h2 class="bd hj fi z dy mm ea eb mn ed ef hh bi translated">304未修改</h2><div class="mo l"><h3 class="bd b fi z dy mm ea eb mn ed ef dx translated">已收到条件GET或HEAD请求，如果不是因为…</h3></div><div class="mp l"><p class="bd b fp z dy mm ea eb mn ed ef dx translated">httpstatuses.com</p></div></div></div></a></div><div class="me mf ez fb mg mh"><a href="https://bz.apache.org/bugzilla/show_bug.cgi?id=55453" rel="noopener  ugc nofollow" target="_blank"><div class="mi ab dw"><div class="mj ab mk cl cj ml"><h2 class="bd hj fi z dy mm ea eb mn ed ef hh bi translated">55453 - AJP发送状态为304的正文</h2><div class="mo l"><h3 class="bd b fi z dy mm ea eb mn ed ef dx translated">编辑描述</h3></div><div class="mp l"><p class="bd b fp z dy mm ea eb mn ed ef dx translated">bz.apache.org</p></div></div></div></a></div><div class="me mf ez fb mg mh"><a href="https://blogs.windows.com/windowsexperience/2021/05/19/the-future-of-internet-explorer-on-windows-10-is-in-microsoft-edge/" rel="noopener  ugc nofollow" target="_blank"><div class="mi ab dw"><div class="mj ab mk cl cj ml"><h2 class="bd hj fi z dy mm ea eb mn ed ef hh bi translated">Windows 10上的Internet Explorer的未来在微软Edge</h2><div class="mo l"><h3 class="bd b fi z dy mm ea eb mn ed ef dx translated">在过去的一年里，你可能已经注意到我们远离了对IE的支持，例如…</h3></div><div class="mp l"><p class="bd b fp z dy mm ea eb mn ed ef dx translated">blogs.windows.com</p></div></div><div class="mq l"><div class="mx l ms mt mu mq mv io mh"/></div></div></a></div></div></div>    
</body>
</html>