<html>
<head>
<title>How to Create a Pinterest Clone Part II: Image Classification</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何创建Pinterest克隆第二部分:图像分类</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/how-to-create-a-pinterest-clone-part-ii-image-classification-1ecf4cca0b20?source=collection_archive---------15-----------------------#2022-07-06">https://medium.com/geekculture/how-to-create-a-pinterest-clone-part-ii-image-classification-1ecf4cca0b20?source=collection_archive---------15-----------------------#2022-07-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="7070" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">使用TensorFlow和<strong class="ak"> Python </strong>影像库的基本影像分类工作流</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/dd56256af0c9cd5eb09326c7d818210c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9TlYWTEkEI9lAi-1wdWGaw.png"/></div></div></figure><p id="5909" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><strong class="jl hj">概述及目标</strong></p><p id="ac73" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">在<a class="ae kf" rel="noopener" href="/geekculture/how-to-create-a-pinterest-clone-part-i-upload-photos-a1f385812729">的上一篇博客</a>中，我们构建了一个可以上传图像的网页，并创建了一个API端点，可以接收这些图像，并将文件存储在MongoDB中，将元数据存储在TigerGraph中。在这篇博客中，我们将把使用TensorFlow和Python图像库构建的基本图像分类工作流集成到API端点中，以标记图像并将标记存储到TigerGraph中。这些标签可以用于搜索。</p><p id="1296" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><strong class="jl hj">第一节:使用TensorFlow的基本图像分类模型</strong></p><p id="dc49" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">Pinterest使用的实际图像分类算法很复杂，超出了本博客的范围。我们将按照本文档中的说明来训练一个简单的神经网络模型，该模型可以对服装图像进行分类。它使用了<a class="ae kf" href="https://github.com/zalandoresearch/fashion-mnist" rel="noopener ugc nofollow" target="_blank">时尚MNIST </a>数据集，该数据集包含10个类别的70，000幅灰度图像(28×28像素)。以下是一些例子:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es kg"><img src="../Images/6d69f990be0234a75d9805f76ef8672e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GNLB2jtcfb_xTqgQd9ntJA.png"/></div></div><figcaption class="kh ki et er es kj kk bd b be z dx"><a class="ae kf" href="https://github.com/zalandoresearch/fashion-mnist" rel="noopener ugc nofollow" target="_blank">Fashion-MNIST samples</a> (by Zalando, MIT License).</figcaption></figure><p id="1e51" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我们需要先安装TensorFlow。记得激活虚拟环境，这样就不会搞乱我们的本地环境。</p><pre class="iy iz ja jb fd kl km kn ko aw kp bi"><span id="3e97" class="kq kr hi km b fi ks kt l ku kv">$ cd photo_library/backend<br/>$ source venv/bin/activate</span></pre><p id="2588" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">然后我们可以运行这个命令来安装TensorFlow(仅限MacOS，其他系统请参考<a class="ae kf" href="https://www.tensorflow.org/install/pip#macos" rel="noopener ugc nofollow" target="_blank">本文档</a>)。</p><pre class="iy iz ja jb fd kl km kn ko aw kp bi"><span id="59ca" class="kq kr hi km b fi ks kt l ku kv"># the only package installed with pip<br/>$ <!-- -->python3 -m pip install tensorflow</span></pre><p id="3548" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">让我们开始创建一个Python程序来训练和保存模型！</p><pre class="iy iz ja jb fd kl km kn ko aw kp bi"><span id="0a9b" class="kq kr hi km b fi ks kt l ku kv"># <!-- -->photo_library/backend/ML.py<br/>import tensorflow as tf<br/>import numpy as np</span></pre><p id="73a0" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">导入模块后，我们将加载时尚-MNIST数据集。</p><pre class="iy iz ja jb fd kl km kn ko aw kp bi"><span id="d4de" class="kq kr hi km b fi ks kt l ku kv">fashion_mnist = tf.keras.datasets.fashion_mnist<br/>(train_images, train_labels), (test_images, test_labels) = fashion_mnist.load_data()<br/>class_names = ['T-shirt/top', 'Trouser', 'Pullover', 'Dress', 'Coat', 'Sandal', 'Shirt', 'Sneaker', 'Bag', 'Ankle boot']</span></pre><p id="d63d" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">有60，000个训练图像和10，000个测试图像。每个图像都有一个相应的标签，它是一个从0到9的数字，代表一个类别名称(例如，0代表t恤/上衣，9代表踝靴)。更准确地说，变量<code class="du kw kx ky km b">train_images</code>是一个大小为60000*28*28的numpy数组，代表60000张图像，每张图像的28*28像素的值为0到255，变量<code class="du kw kx ky km b">train_labels</code>是一个大小为60000的numpy数组，其中每个元素取0到9的值，代表每张图像的类名。</p><p id="65cb" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">由于神经网络模型最适用于从0到1的数字，因此我们需要将0–255到0–1的像素值标准化。</p><pre class="iy iz ja jb fd kl km kn ko aw kp bi"><span id="ba6a" class="kq kr hi km b fi ks kt l ku kv">train_images = train_images / 255.0<br/>test_images = test_images / 255.0</span></pre><p id="b11b" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">然后，我们可以训练并保存模型。</p><pre class="iy iz ja jb fd kl km kn ko aw kp bi"><span id="7f1a" class="kq kr hi km b fi ks kt l ku kv">model = tf.keras.Sequential([<br/>    tf.keras.layers.Flatten(input_shape=(28, 28)),<br/>    tf.keras.layers.Dense(128, activation='relu'),<br/>    tf.keras.layers.Dense(10)<br/>])<br/>model.compile(optimizer='adam', loss=tf.keras.losses.SparseCategoricalCrossentropy(from_logits=True), metrics=['accuracy'])<br/>model.fit(train_images, train_labels, epochs=10)<br/>model.save('my_model')</span></pre><p id="1caa" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">基本上，我们链接几个层来创建模型，用一些推荐的参数编译模型，拟合(或训练)模型，并将模型保存到给定的路径。有关每个组件的详细描述，请查看本文档。对于高层次的概念理解，我会强烈推荐3Blue1Brown的<a class="ae kf" href="https://youtu.be/aircAruvnKk" rel="noopener ugc nofollow" target="_blank">这个视频系列</a>。</p><p id="e0c0" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我们现在可以运行程序了。</p><pre class="iy iz ja jb fd kl km kn ko aw kp bi"><span id="1bcb" class="kq kr hi km b fi ks kt l ku kv"># a terminal at photo_library/backend<br/>$ python3 ML.py</span></pre><p id="d7fb" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">普通的Mac用不了30秒。不需要GPU！我们可以通过在程序末尾添加下面两行来评估带有测试数据集的模型。</p><pre class="iy iz ja jb fd kl km kn ko aw kp bi"><span id="f15f" class="kq kr hi km b fi ks kt l ku kv">test_loss, test_acc = model.evaluate(test_images, test_labels)<br/>print('\nTest accuracy:', test_acc)</span></pre><p id="46ad" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">该模型将用于预测每个测试图像的类别(从0到9的数字)，并将预测与实际标签进行比较，以获得大约90%的准确度。虽然我们用的是小数据集和简单模型，但是结果还是挺好的！</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es kz"><img src="../Images/5690ac5b2baa615765f1c826d9d71008.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NTUV-JSY5IIn61GkzD5Xvw.png"/></div></div><figcaption class="kh ki et er es kj kk bd b be z dx">The terminal output after we ran the program</figcaption></figure><p id="fb99" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我们现在有了一个基本的图像分类模型！作为本节的总结，我们将以下代码放在<code class="du kw kx ky km b">photo_library/backend/ML.py</code>并运行它，它训练了一个图像分类模型并将其保存在<code class="du kw kx ky km b">photo_library/backend/my_model</code>。</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="la lb l"/></div></figure><p id="bf94" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><strong class="jl hj">第二节:将图像分类模型集成到服务器中</strong></p><p id="a6c6" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">目前，我们有一个API端点，它将用户上传的照片文件存储到MongoDB中，生成一个对象ID，并将对象ID放入TigerGraph中。</p><pre class="iy iz ja jb fd kl km kn ko aw kp bi"><span id="0b37" class="kq kr hi km b fi ks kt l ku kv"># main.py<br/>@app.post("/uploadPhoto/")<br/>async def upload_photo(file: UploadFile):<br/>    contents = await file.read()<br/>    # add to MongoDB<br/>    data = { "photo": contents }<br/>    photoID = await add_photo_to_MongoDB(data)<br/>    # <strong class="km hj">TODO:</strong> tag the photo with the model<br/>    success = await add_photo_id_to_TigerGraph(photoID)<br/>    if success:<br/>        return { "code": 200, "message": "Photo uploaded"}<br/>    else:<br/>        return { "code": 401, "message": "Failed to add photo"}</span></pre><p id="4280" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">现在我们想用模型标记照片，并将元数据添加到TigerGraph数据库中。首先，我们需要将照片文件转换成一个<code class="du kw kx ky km b">Image</code>对象，并用Python图像库(PIL)对其进行处理。</p><pre class="iy iz ja jb fd kl km kn ko aw kp bi"><span id="c22d" class="kq kr hi km b fi ks kt l ku kv"># import uuid<br/># from PIL import Image<br/># import matplotlib.pyplot as plt</span><span id="253b" class="kq kr hi km b fi lc kt l ku kv"># All the code below is added to the <strong class="km hj">TODO</strong> position</span><span id="2b44" class="kq kr hi km b fi lc kt l ku kv">unique_file_path = str(uuid.uuid4()) + file.filename<br/>with open(unique_file_path, 'wb') as f:<br/>    f.write(contents)<br/>img=Image.open(unique_file_path)<br/>os.remove(unique_file_path)<br/># Show the image in a pop-up window<br/>plt.imshow(img)<br/>plt.show()</span></pre><p id="b263" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">添加完依赖项和代码后，我们可以运行项目并尝试上传图像。</p><pre class="iy iz ja jb fd kl km kn ko aw kp bi"><span id="ab74" class="kq kr hi km b fi ks kt l ku kv"># Start the frontend<br/>$ cd photo_library/frontend<br/>$ quasar dev</span><span id="cfe2" class="kq kr hi km b fi lc kt l ku kv"># Start the backend<br/>$ cd photo_library/backend<br/>$ source venv/bin/activate<br/>$ python3 main.py</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ld"><img src="../Images/9f228bad9b2d5ad3dc0f177d87cc4cd4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rhD76PxyOM2MTKKVT2Dx6Q.png"/></div></div><figcaption class="kh ki et er es kj kk bd b be z dx">Shirt Image from <a class="ae kf" href="https://pixabay.com/vectors/shirt-pink-t-shirt-jersey-tee-34238/" rel="noopener ugc nofollow" target="_blank">Pixabey</a></figcaption></figure><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es le"><img src="../Images/3de9ebbbb94fba6f0abc7f0745ee1fcf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PejskZbSs6Aq6eQkw9KG3A.png"/></div></div><figcaption class="kh ki et er es kj kk bd b be z dx">Shirt Image in a Pop-up Window</figcaption></figure><p id="db10" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">照片被加载为一个<code class="du kw kx ky km b">Image</code>对象，我们需要将它转换为28×28像素大小的灰度图像。</p><pre class="iy iz ja jb fd kl km kn ko aw kp bi"><span id="bdf0" class="kq kr hi km b fi ks kt l ku kv"># Resize the image to 28*28 with bilinear interpolation<br/>small_img=img.resize((28,28),Image.Resampling.BILINEAR)<br/># Show the image<br/>plt.imshow(small_img)<br/>plt.show()</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es le"><img src="../Images/4717caddcf69378306586354801fd01c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jZbFurfmE9x-cFAoNjTIHA.png"/></div></div><figcaption class="kh ki et er es kj kk bd b be z dx">Resized Shirt</figcaption></figure><pre class="iy iz ja jb fd kl km kn ko aw kp bi"><span id="fa91" class="kq kr hi km b fi ks kt l ku kv"># Turn the image into Black &amp; White<br/>BW_small_img=small_img.convert("L")<br/># Show the image<br/>plt.imshow(BW_small_img)<br/>plt.colorbar()<br/>plt.show()</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es le"><img src="../Images/6981b416f2d8d86168fbe8e9243f6ba1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KqesxpWnDerc6z-qWn5lxw.png"/></div></div><figcaption class="kh ki et er es kj kk bd b be z dx">Grayscale, 28 by 28 pixels image with pixel value from 0 to 255</figcaption></figure><p id="9946" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">然后，我们将图像像素转换成归一化的Numpy数组。</p><pre class="iy iz ja jb fd kl km kn ko aw kp bi"><span id="d6a2" class="kq kr hi km b fi ks kt l ku kv"># import numpy as np<br/>pix = np.array(BW_small_img)<br/>img = np.expand_dims(pix,0) / 255.0</span></pre><p id="5bdf" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我们加载训练好的模型，并用它来预测图像的类别。</p><pre class="iy iz ja jb fd kl km kn ko aw kp bi"><span id="4b52" class="kq kr hi km b fi ks kt l ku kv"># import tensorflow as tf<br/>model = tf.keras.models.load_model('my_model')<br/>probability_model = tf.keras.Sequential([model, tf.keras.layers.Softmax()])<br/>predictions = probability_model.predict(img)<br/>print(predictions)</span></pre><p id="3aca" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">删除显示image的代码后，让我们运行它并查看预测！</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lf"><img src="../Images/5d1af910284799df25b9888819290ef7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*blLtrB-ZnuOL4m1fGSJaow.png"/></div></div></figure><p id="458b" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">从0到1有10个数字，代表图像属于某一类的概率。回想一下，这10个类是:</p><pre class="iy iz ja jb fd kl km kn ko aw kp bi"><span id="5e59" class="kq kr hi km b fi ks kt l ku kv">class_names = ['T-shirt/top', 'Trouser', 'Pullover', 'Dress', 'Coat', 'Sandal', 'Shirt', 'Sneaker', 'Bag', 'Ankle boot']</span></pre><p id="5057" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我们可以看到‘衬衫’的概率最高为0.74，‘t恤/上衣’的概率第二高为0.26，这是合理的！</p><p id="5130" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">概括一下，你可以把下面的代码放在<code class="du kw kx ky km b">photo_library/backend/main.py</code>中。API端点现在将为每张上传的照片打印一个预测数组。</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="la lb l"/></div></figure><p id="887d" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><strong class="jl hj">第三节:在TigerGraph中存储元数据</strong></p><p id="9e64" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">在上一篇博客中，我们在TigerGraph中创建了“照片”顶点。现在，我们将添加一个“类型”顶点和一个边“照片类型”来存储元数据。</p><p id="c04e" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">让我们导航到<a class="ae kf" href="https://tgcloud.io/" rel="noopener ugc nofollow" target="_blank">https://tgcloud.io/</a>，使用凭据登录，然后转到“我的解决方案”选项卡。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lg"><img src="../Images/0a513b2f2c635f3306ea8ac55304218a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nqpapoHgnXC4gSFnjvH-Yw.png"/></div></div></figure><p id="904a" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">启动我们创建的解决方案，这大约需要一分钟，然后打开GraphStudio。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lg"><img src="../Images/5b0dba9c99173c2bcc3d319c30a964a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UnLNW8G_Yq_8NRjPHpT1rA.png"/></div></div></figure><p id="3903" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">切换到“照片”图形，导航到“设计模式”，并单击“+”按钮添加“类型”顶点，其主要id称为“名称”，具有类型字符串并存储为属性。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lh"><img src="../Images/a971061c9c0b302d36b5601241763bc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NNgOOcoTOdSQsVHI-DiXaQ.png"/></div></div></figure><p id="0086" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">然后，我们可以单击右箭头按钮来添加“照片类型”边缘。该配置包括源顶点“照片”、目标顶点“类型”和浮点类型的属性“概率”。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es li"><img src="../Images/47d5d1ad10ef88284af46cac3b1edcbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x3G0aEglb4xOZRYgvR6gEg.png"/></div></div></figure><p id="0d6f" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">最后，我们点击左上角的按钮“发布模式”，我们的TigerGraph解决方案就可以开始了！</p><p id="8bf1" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">在<code class="du kw kx ky km b">main.py</code>中，我们可以更新获取照片ID并将其插入TigerGraph的函数，以添加照片的元数据。</p><pre class="iy iz ja jb fd kl km kn ko aw kp bi"><span id="208d" class="kq kr hi km b fi ks kt l ku kv">async def add_photo_id_with_predictions_into_TigerGraph(id: str, predictions: list):<br/>    try:<br/>        class_names = ['T-shirt', 'Trouser', 'Pullover', 'Dress', 'Coat', 'Sandal', 'Shirt', 'Sneaker', 'Bag', 'Ankle-boot']<br/>        conn.upsertVertex("Photo", id, {})<br/>        # only need to insert type vertexes once<br/>        for name in class_names:<br/>            conn.upsertVertex("Type", name, {})<br/>        threshold = 0.01<br/>        for idx, probability in enumerate(predictions):<br/>            if probability &gt;= threshold:<br/>                conn.upsertEdge("Photo", id, "PHOTO_HAS_TYPE", "Type", class_names[idx], {"probability": probability})<br/>        return True<br/>    except:<br/>        return False</span></pre><p id="2255" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我们插入带有对象ID的“照片”顶点，该对象ID引用存储在MongoDB中的照片文件，添加所有“类型”顶点，并添加带有概率的边，该概率指示每张照片属于一个类的可能性。我们只需要插入一次“类型”顶点，所以插入“类型”顶点后，可以随意删除或注释掉两行代码。我们还包括一个减少冗余边的可能性阈值。</p><p id="25ba" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">让我们在API端点中使用这个函数，代码如下所示:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="la lb l"/></div></figure><p id="081a" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">如果我们运行项目并再次上传粉色衬衫照片，我们将在MongoDB中看到它。</p><pre class="iy iz ja jb fd kl km kn ko aw kp bi"><span id="abfc" class="kq kr hi km b fi ks kt l ku kv"># As a reminder of how to run the project<br/># Start the frontend<br/>$ cd photo_library/frontend<br/>$ quasar dev</span><span id="39eb" class="kq kr hi km b fi lc kt l ku kv"># Start the backend<br/>$ cd photo_library/backend<br/>$ source venv/bin/activate<br/>$ python3 main.py</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lj"><img src="../Images/a9de0ee922bbed2c538bb9ffa7aea19a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5LogbpO04NCk-mGkJEusGg.png"/></div></div></figure><p id="2d18" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我们可以复制它的对象ID并在TigerGraph中搜索它。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lh"><img src="../Images/80f07ebb35d47bd34ba0e6146a3db157.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*olyy37asfmXBrbPcEilkJw.png"/></div></div></figure><p id="ae59" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">它以0.74和0.26的概率连接到‘衬衫’和‘t恤’，这正是我们所期待的！</p><p id="63bf" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><strong class="jl hj">第四部分:后续步骤和资源</strong></p><p id="a7e8" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">这部分到此为止！所有的代码都上传到这里<a class="ae kf" href="https://github.com/JimChen2002/photo-library-part2" rel="noopener ugc nofollow" target="_blank">和运行它的指令</a>。如果你对本博客中使用的一些技术特别感兴趣，这里有它们文档的链接:<a class="ae kf" href="https://docs.tigergraph.com/cloud/start/overview" rel="noopener ugc nofollow" target="_blank"> TigerGraph Cloud </a>、<a class="ae kf" href="https://www.mongodb.com/docs/manual/administration/install-community/" rel="noopener ugc nofollow" target="_blank"> MongoDB Setup </a>、<a class="ae kf" href="https://fastapi.tiangolo.com" rel="noopener ugc nofollow" target="_blank"> FastAPI </a>和<a class="ae kf" href="https://quasar.dev" rel="noopener ugc nofollow" target="_blank"> Quasar </a>。</p><p id="2139" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我们将在下一部分通过完成前端搜索来总结它。如果你有任何问题，欢迎加入<a class="ae kf" href="https://discord.com/invite/tigergraph" rel="noopener ugc nofollow" target="_blank"> TigerGraph Discord </a>和<a class="ae kf" href="https://dev.tigergraph.com/forum/" rel="noopener ugc nofollow" target="_blank">开发者论坛</a>！</p></div></div>    
</body>
</html>