<html>
<head>
<title>REST API Login and Register Node.js with JWT</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">REST API登录并用JWT注册Node.js</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/rest-api-login-and-register-node-js-with-jwt-8cb6755f5a6b?source=collection_archive---------1-----------------------#2022-07-28">https://medium.com/geekculture/rest-api-login-and-register-node-js-with-jwt-8cb6755f5a6b?source=collection_archive---------1-----------------------#2022-07-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/8f34d741d1400c94a0bb0609767d83c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V_B5NW-zOjU-HktmkBbliQ.png"/></div></div></figure><p id="4f21" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你好，你好吗，朋友们，又回来了，泰曼·恩戈丁。在本次讨论中，我们将创建一个REST API登录，并使用Node.js向JWT注册。并且我会举一些例子来制作Rest API。</p><p id="0ec3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以学习其他教程:</p><p id="fd5a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae jo" href="https://temanngoding.com/format-number-otomatis-dengan-javascript-semua-negara/" rel="noopener ugc nofollow" target="_blank">自动数字格式带JavaScript所有国家</a></p><p id="e2a7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae jo" href="https://temanngoding.com/penanganan-eror-javascript/" rel="noopener ugc nofollow" target="_blank"> Javascript错误处理</a></p><p id="6767" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae jo" href="https://temanngoding.com/tutorial-javascript-convert-waktu-am-pm-to-24-jam/" rel="noopener ugc nofollow" target="_blank"> Javascript教程:将时间am pm转换为24小时</a></p><p id="0e16" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">注册和登录是任何web或应用程序中的常见模块。当用户在您的网站和应用程序上注册时，您将他们的数据存储在您的数据库中。因此，如果以后他想登录，他不需要再次注册。在本教程中，您将学习如何使用节点js + express + MySQL + JWT auth创建一个用户注册rest API。</p><h1 id="5306" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">1.创建Node.js快速登录应用程序</h1><p id="1e71" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">第一步是创建一个新项目。</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="2f55" class="lb jq hi kx b fi lc ld l le lf">$ mkdir api<br/>$ cd api</span></pre><p id="5334" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后，我们用package.json文件初始化Node.js应用程序:</p><figure class="ks kt ku kv fd ij er es paragraph-image"><div class="er es lg"><img src="../Images/f9c39a4b5151fe5c908f4118aca63265.png" data-original-src="https://miro.medium.com/v2/resize:fit:914/format:webp/0*ug-wuyT3yWcfW6Fh.png"/></div></figure><p id="3be6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来我们需要安装一些库:<code class="du lh li lj kx b">express</code>、<code class="du lh li lj kx b">cors</code>、<code class="du lh li lj kx b">cookie, session</code>、<code class="du lh li lj kx b">sequelize</code>、<code class="du lh li lj kx b">mysql2</code>、<code class="du lh li lj kx b">jsonwebtoken</code>和<code class="du lh li lj kx b">bcryptjs</code>。</p><p id="01fb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在command中运行以下命令:</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="c0f7" class="lb jq hi kx b fi lc ld l le lf">npm install express cookie-session sequelize mysql2 cors jsonwebtoken bcryptjs --save</span></pre><p id="7e72" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们可以看到我们的包:</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="3034" class="lb jq hi kx b fi lc ld l le lf">{<br/>  "name": "api",<br/>  "version": "1.0.0",<br/>  "description": "",<br/>  "main": "index.js",<br/>  "scripts": {<br/>    "test": "echo \"Error: no test specified\" &amp;&amp; exit 1"<br/>  },<br/>  "author": "",<br/>  "license": "ISC",<br/>  "dependencies": {<br/>    "bcryptjs": "^2.4.3",<br/>    "cookie-session": "^2.0.0",<br/>    "cors": "^2.8.5",<br/>    "express": "^4.18.1",<br/>    "jsonwebtoken": "^8.5.1",<br/>    "mysql2": "^2.3.3",<br/>    "sequelize": "^6.21.3"<br/>  }<br/>}</span></pre><h1 id="ee1c" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">2.安装Express web服务器</h1><p id="6637" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">在我们的根文件夹中，创建一个新的server.js文件:</p><p id="8c15" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我解释一下我们刚刚做了什么:<br/>–导入express、会话cookies和cors模块:</p><p id="59c5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Express用于构建REST API <br/> cookie-session有助于将客户端的会话数据存储在cookie中，而不需要服务器端的任何数据库/资源<br/> cors提供Express中间件来支持cors<br/>-创建Express应用程序，然后使用app.use()方法添加请求解析、基于cookie的会话中间件和CORS中间件。<br/>–为测试定义一个简单的获取路线。<br/>–在端口8080上监听传入的请求。</p><p id="0bc0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在在command:node server . js中运行这个命令</p><p id="f35b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在你的浏览器中打开<a class="ae jo" href="http://localhost:8080/" rel="noopener ugc nofollow" target="_blank"> http://localhost:8080/ </a>，然后我们会得到这样一个json:</p><figure class="ks kt ku kv fd ij er es paragraph-image"><div class="er es lk"><img src="../Images/36708b09ad734f85d1e14718ea2dc616.png" data-original-src="https://miro.medium.com/v2/resize:fit:712/format:webp/0*RfqqOQfLRerLtIaU.png"/></div></figure><h1 id="53d3" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">3.MySQL配置和序列</h1><p id="e746" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">使用db.config.js文件创建一个config文件夹，并编写以下代码:</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="936e" class="lb jq hi kx b fi lc ld l le lf">module.exports = {<br/>  HOST: "localhost",<br/>  USER: "root",<br/>  PASSWORD: "123456",<br/>  DB: "testdb",<br/>  dialect: "mysql",<br/>  pool: {<br/>    max: 5,<br/>    min: 0,<br/>    acquire: 30000,<br/>    idle: 10000<br/>  }<br/>};</span></pre><p id="2f5a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">前五个参数用于MySQL连接。<br/> pool是可选的，这将用于配置Sequelize连接池:</p><ul class=""><li id="20c5" class="ll lm hi is b it iu ix iy jb ln jf lo jj lp jn lq lr ls lt bi translated">max:池中的最大连接数</li><li id="cece" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated">min:池中的最小连接数</li><li id="89ab" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated">空闲:连接在被释放之前可以空闲的最长时间，以毫秒为单位</li><li id="4a43" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated">获取:池在抛出错误之前尝试获取连接的最长时间，以毫秒为单位</li></ul><h1 id="30e2" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">4.定义顺序模型</h1><p id="4520" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">我们准备采用顺序模型。在models文件夹中，创建一个用户和角色数据模型，代码如下:</p><p id="2efb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">型号</strong> / <em class="lz"> user.model.js </em></p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="9e27" class="lb jq hi kx b fi lc ld l le lf">module.exports = (sequelize, Sequelize) =&gt; {<br/>  const User = sequelize.define("users", {<br/>    username: {<br/>      type: Sequelize.STRING<br/>    },<br/>    email: {<br/>      type: Sequelize.STRING<br/>    },<br/>    password: {<br/>      type: Sequelize.STRING<br/>    }<br/>  });<br/>  return User;<br/>};</span></pre><p id="1d05" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">models</strong>/<em class="lz">role . model . js</em></p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="03fb" class="lb jq hi kx b fi lc ld l le lf">module.exports = (sequelize, Sequelize) =&gt; {<br/>  const Role = sequelize.define("roles", {<br/>    id: {<br/>      type: Sequelize.INTEGER,<br/>      primaryKey: true<br/>    },<br/>    name: {<br/>      type: Sequelize.STRING<br/>    }<br/>  });<br/>  return Role;<br/>};</span></pre><p id="4718" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在初始化Sequelize之后，我们不需要编写CRUD函数，Sequelize支持所有这些函数:</p><ul class=""><li id="2b14" class="ll lm hi is b it iu ix iy jb ln jf lo jj lp jn lq lr ls lt bi translated">创建新用户:创建(对象)</li><li id="ca19" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated">按id查找用户:findByPk(id)</li><li id="9dab" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated">通过电子邮件查找用户:findOne({ where: { email: … } })</li><li id="10af" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated">获取所有用户:findAll()</li><li id="06ae" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated">按用户名查找所有用户:findAll({其中:{用户名:… } })</li></ul><h1 id="1478" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">5.初始化序列</h1><p id="59ad" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">现在，使用以下代码创建app/models/index.js文件:</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="cf8f" class="lb jq hi kx b fi lc ld l le lf">const config = require("../config/db.config.js");<br/>const Sequelize = require("sequelize");<br/>const sequelize = new Sequelize(<br/>  config.DB,<br/>  config.USER,<br/>  config.PASSWORD,<br/>  {<br/>    host: config.HOST,<br/>    dialect: config.dialect,<br/>    operatorsAliases: false,<br/>    pool: {<br/>      max: config.pool.max,<br/>      min: config.pool.min,<br/>      acquire: config.pool.acquire,<br/>      idle: config.pool.idle<br/>    }<br/>  }<br/>);<br/>const db = {};<br/>db.Sequelize = Sequelize;<br/>db.sequelize = sequelize;<br/>db.user = require("../models/user.model.js")(sequelize, Sequelize);<br/>db.role = require("../models/role.model.js")(sequelize, Sequelize);<br/>db.role.belongsToMany(db.user, {<br/>  through: "user_roles",<br/>  foreignKey: "roleId",<br/>  otherKey: "userId"<br/>});<br/>db.user.belongsToMany(db.role, {<br/>  through: "user_roles",<br/>  foreignKey: "userId",<br/>  otherKey: "roleId"<br/>});<br/>db.ROLES = ["user", "admin", "moderator"];<br/>module.exports = db;</span></pre><p id="2fae" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">用户和角色的关系是多对多的关系:<br/>–一个用户可以有多个角色。<br/>–一个角色可以由多个用户担任。</p><p id="3494" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">并且不要忘记调用server.js中的sync()方法。</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="6725" class="lb jq hi kx b fi lc ld l le lf">...<br/>const app = express();<br/>app.use(...);<br/>const db = require("./app/models");<br/>const Role = db.role;<br/>db.sequelize.sync({force: true}).then(() =&gt; {<br/>  console.log('Drop and Resync Db');<br/>  initial();<br/>});<br/>...<br/><em class="lz">function</em> initial() {<br/>  Role.create({<br/>    id: 1,<br/>    name: "user"<br/>  });<br/> <br/>  Role.create({<br/>    id: 2,<br/>    name: "moderator"<br/>  });<br/> <br/>  Role.create({<br/>    id: 3,<br/>    name: "admin"<br/>  });<br/>}</span></pre><p id="d2b5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">initial()函数帮助我们在数据库中创建3行。在开发过程中，您可能需要删除现有的表并重新同步数据库。所以你可以使用force: true就像上面的代码一样。</p><p id="4921" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于生产，只需手动输入这一行，并使用不带参数的sync()来避免数据丢失:</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="7fc3" class="lb jq hi kx b fi lc ld l le lf">...<br/>const app = express();<br/>app.use(...);<br/>const db = require("./app/models");<br/>db.sequelize.sync();<br/>...</span></pre><h1 id="6914" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">6.配置授权密钥</h1><p id="5b87" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">像verify()或sign()这样的jsonwebtoken函数使用需要密钥(作为字符串)的算法来编码和解码令牌。</p><p id="58e2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在app/config文件夹中，使用以下代码创建一个auth.config.js文件:</p><h1 id="3a9b" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">7.创建中间件功能</h1><p id="7a55" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated"><strong class="is hj">中间件</strong> / <em class="lz"> verifySignUp.js </em></p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="4dd3" class="lb jq hi kx b fi lc ld l le lf">const db = require("../models");<br/>const ROLES = db.ROLES;<br/>const User = db.user;<br/>checkDuplicateUsernameOrEmail = async (req, res, next) =&gt; {<br/>  try {<br/>    // Username<br/>    let user = await User.findOne({<br/>      where: {<br/>        username: req.body.username<br/>      }<br/>    });<br/>    if (user) {<br/>      return res.status(400).send({<br/>        message: "Failed! Username is already in use!"<br/>      });<br/>    }<br/>    // Email<br/>    user = await User.findOne({<br/>      where: {<br/>        email: req.body.email<br/>      }<br/>    });<br/>    if (user) {<br/>      return res.status(400).send({<br/>        message: "Failed! Email is already in use!"<br/>      });<br/>    }<br/>    next();<br/>  } catch (error) {<br/>    return res.status(500).send({<br/>      message: "Unable to validate Username!"<br/>    });<br/>  }<br/>};<br/>checkRolesExisted = (req, res, next) =&gt; {<br/>  if (req.body.roles) {<br/>    for (let i = 0; i &lt; req.body.roles.length; i++) {<br/>      if (!ROLES.includes(req.body.roles[i])) {<br/>        res.status(400).send({<br/>          message: "Failed! Role does not exist = " + req.body.roles[i]<br/>        });<br/>        return;<br/>      }<br/>    }<br/>  }<br/>  <br/>  next();<br/>};<br/>const verifySignUp = {<br/>  checkDuplicateUsernameOrEmail,<br/>  checkRolesExisted<br/>};<br/>module.exports = verifySignUp;</span></pre><p id="4de1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">中间件</strong> / <em class="lz"> authJwt.js </em></p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="2997" class="lb jq hi kx b fi lc ld l le lf">const jwt = require("jsonwebtoken");<br/>const config = require("../config/auth.config.js");<br/>const db = require("../models");<br/>const User = db.user;<br/>verifyToken = (req, res, next) =&gt; {<br/>  let token = req.session.token;<br/>  if (!token) {<br/>    return res.status(403).send({<br/>      message: "No token provided!",<br/>    });<br/>  }<br/>  jwt.verify(token, config.secret, (err, decoded) =&gt; {<br/>    if (err) {<br/>      return res.status(401).send({<br/>        message: "Unauthorized!",<br/>      });<br/>    }<br/>    req.userId = decoded.id;<br/>    next();<br/>  });<br/>};<br/>isAdmin = async (req, res, next) =&gt; {<br/>  try {<br/>    const user = await User.findByPk(req.userId);<br/>    const roles = await user.getRoles();<br/>    for (let i = 0; i &lt; roles.length; i++) {<br/>      if (roles[i].name === "admin") {<br/>        return next();<br/>      }<br/>    }<br/>    return res.status(403).send({<br/>      message: "Require Admin Role!",<br/>    });<br/>  } catch (error) {<br/>    return res.status(500).send({<br/>      message: "Unable to validate User role!",<br/>    });<br/>  }<br/>};<br/>isModerator = async (req, res, next) =&gt; {<br/>  try {<br/>    const user = await User.findByPk(req.userId);<br/>    const roles = await user.getRoles();<br/>    for (let i = 0; i &lt; roles.length; i++) {<br/>      if (roles[i].name === "moderator") {<br/>        return next();<br/>      }<br/>    }<br/>    return res.status(403).send({<br/>      message: "Require Moderator Role!",<br/>    });<br/>  } catch (error) {<br/>    return res.status(500).send({<br/>      message: "Unable to validate Moderator role!",<br/>    });<br/>  }<br/>};<br/>isModeratorOrAdmin = async (req, res, next) =&gt; {<br/>  try {<br/>    const user = await User.findByPk(req.userId);<br/>    const roles = await user.getRoles();<br/>    for (let i = 0; i &lt; roles.length; i++) {<br/>      if (roles[i].name === "moderator") {<br/>        return next();<br/>      }<br/>      if (roles[i].name === "admin") {<br/>        return next();<br/>      }<br/>    }<br/>    return res.status(403).send({<br/>      message: "Require Moderator or Admin Role!",<br/>    });<br/>  } catch (error) {<br/>    return res.status(500).send({<br/>      message: "Unable to validate Moderator or Admin role!",<br/>    });<br/>  }<br/>};<br/>const authJwt = {<br/>  verifyToken,<br/>  isAdmin,<br/>  isModerator,<br/>  isModeratorOrAdmin,<br/>};<br/>module.exports = authJwt;</span></pre><p id="3503" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">中间件</strong> / <em class="lz"> index.js </em></p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="1573" class="lb jq hi kx b fi lc ld l le lf">const authJwt = require("./authJwt");<br/>const verifySignUp = require("./verifySignUp");<br/>module.exports = {<br/>  authJwt,<br/>  verifySignUp<br/>};</span></pre><h1 id="d0aa" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">8.创建控制器</h1><p id="2301" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated"><strong class="is hj">控制器</strong>/<em class="lz">auth . controller . js</em></p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="3d49" class="lb jq hi kx b fi lc ld l le lf">onst db = require("../models");<br/>const config = require("../config/auth.config");<br/>const User = db.user;<br/>const Role = db.role;<br/>const Op = db.Sequelize.Op;<br/>const jwt = require("jsonwebtoken");<br/>const bcrypt = require("bcryptjs");<br/>exports.signup = async (req, res) =&gt; {<br/>  // Save User to Database<br/>  try {<br/>    const user = await User.create({<br/>      username: req.body.username,<br/>      email: req.body.email,<br/>      password: bcrypt.hashSync(req.body.password, 8),<br/>    });<br/>    if (req.body.roles) {<br/>      const roles = await Role.findAll({<br/>        where: {<br/>          name: {<br/>            [Op.or]: req.body.roles,<br/>          },<br/>        },<br/>      });<br/>      const result = user.setRoles(roles);<br/>      if (result) res.send({ message: "User registered successfully!" });<br/>    } else {<br/>      // user has role = 1<br/>      const result = user.setRoles([1]);<br/>      if (result) res.send({ message: "User registered successfully!" });<br/>    }<br/>  } catch (error) {<br/>    res.status(500).send({ message: error.message });<br/>  }<br/>};<br/>exports.signin = async (req, res) =&gt; {<br/>  try {<br/>    const user = await User.findOne({<br/>      where: {<br/>        username: req.body.username,<br/>      },<br/>    });<br/>    if (!user) {<br/>      return res.status(404).send({ message: "User Not found." });<br/>    }<br/>    const passwordIsValid = bcrypt.compareSync(<br/>      req.body.password,<br/>      user.password<br/>    );<br/>    if (!passwordIsValid) {<br/>      return res.status(401).send({<br/>        message: "Invalid Password!",<br/>      });<br/>    }<br/>    const token = jwt.sign({ id: user.id }, config.secret, {<br/>      expiresIn: 86400, // 24 hours<br/>    });<br/>    let authorities = [];<br/>    const roles = await user.getRoles();<br/>    for (let i = 0; i &lt; roles.length; i++) {<br/>      authorities.push("ROLE_" + roles[i].name.toUpperCase());<br/>    }<br/>    req.session.token = token;<br/>    return res.status(200).send({<br/>      id: user.id,<br/>      username: user.username,<br/>      email: user.email,<br/>      roles: authorities,<br/>    });<br/>  } catch (error) {<br/>    return res.status(500).send({ message: error.message });<br/>  }<br/>};<br/>exports.signout = async (req, res) =&gt; {<br/>  try {<br/>    req.session = null;<br/>    return res.status(200).send({<br/>      message: "You've been signed out!"<br/>    });<br/>  } catch (err) {<br/>    this.next(err);<br/>  }<br/>};</span></pre><p id="b978" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">有4个函数:<br/>–/API/test/all用于公共访问<br/>–/API/test/user用于登录用户(角色:用户/版主/管理员)<br/>–/API/test/mod用于具有版主角色的用户<br/>–/API/test/admin用于具有管理员角色的用户</p><p id="708f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">控制器</strong> / <em class="lz">用户.控制器. js </em></p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="68d5" class="lb jq hi kx b fi lc ld l le lf">exports.allAccess = (req, res) =&gt; {<br/>  res.status(200).send("Public Content.");<br/>};<br/>exports.userBoard = (req, res) =&gt; {<br/>  res.status(200).send("User Content.");<br/>};<br/>exports.adminBoard = (req, res) =&gt; {<br/>  res.status(200).send("Admin Content.");<br/>};<br/>exports.moderatorBoard = (req, res) =&gt; {<br/>  res.status(200).send("Moderator Content.");<br/>};</span></pre><h1 id="1f7b" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">9.定义路线</h1><p id="98b1" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated"><strong class="is hj">认证:</strong></p><ul class=""><li id="2fc0" class="ll lm hi is b it iu ix iy jb ln jf lo jj lp jn lq lr ls lt bi translated">帖子<code class="du lh li lj kx b">/api/auth/signup</code></li><li id="4b9b" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated">帖子<code class="du lh li lj kx b">/api/auth/signin</code></li><li id="474b" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated">帖子<code class="du lh li lj kx b">/api/auth/signout</code></li></ul><p id="ba09" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">路线</strong> / <em class="lz"> auth.routes.js </em></p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="8dd1" class="lb jq hi kx b fi lc ld l le lf">const { verifySignUp } = require("../middleware");<br/>const controller = require("../controllers/auth.controller");<br/>module.exports = <em class="lz">function</em>(app) {<br/>  app.use(<em class="lz">function</em>(req, res, next) {<br/>    res.header(<br/>      "Access-Control-Allow-Headers",<br/>      "Origin, Content-Type, Accept"<br/>    );<br/>    next();<br/>  });<br/>  app.post(<br/>    "/api/auth/signup",<br/>    [<br/>      verifySignUp.checkDuplicateUsernameOrEmail,<br/>      verifySignUp.checkRolesExisted<br/>    ],<br/>    controller.signup<br/>  );<br/>  app.post("/api/auth/signin", controller.signin);<br/>  app.post("/api/auth/signout", controller.signout);<br/>};</span></pre><p id="22b7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">授权:</strong></p><ul class=""><li id="c206" class="ll lm hi is b it iu ix iy jb ln jf lo jj lp jn lq lr ls lt bi translated">获取<code class="du lh li lj kx b">/api/test/all</code></li><li id="01a4" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated">为登录用户(用户/版主/管理员)获取<code class="du lh li lj kx b">/api/test/user</code></li><li id="4ed0" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated">获取<code class="du lh li lj kx b">/api/test/mod</code>作为版主</li><li id="a4db" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated">获取管理员的<code class="du lh li lj kx b">/api/test/admin</code></li></ul><p id="09c5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">路线</strong> / <em class="lz"> user.routes.js </em></p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="003b" class="lb jq hi kx b fi lc ld l le lf">const { authJwt } = require("../middleware");<br/>const controller = require("../controllers/user.controller");<br/>module.exports = function(app) {<br/>  app.use(function(req, res, next) {<br/>    res.header(<br/>      "Access-Control-Allow-Headers",<br/>      "Origin, Content-Type, Accept"<br/>    );<br/>    next();<br/>  });<br/>  app.get("/api/test/all", controller.allAccess);<br/>  app.get(<br/>    "/api/test/user",<br/>    [authJwt.verifyToken],<br/>    controller.userBoard<br/>  );<br/>  app.get(<br/>    "/api/test/mod",<br/>    [authJwt.verifyToken, authJwt.isModerator],<br/>    controller.moderatorBoard<br/>  );<br/>  app.get(<br/>    "/api/test/admin",<br/>    [authJwt.verifyToken, authJwt.isAdmin],<br/>    controller.adminBoard<br/>  );<br/>};</span></pre><p id="d9c9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">不要忘记在server.js中添加以下代码:</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="e0d1" class="lb jq hi kx b fi lc ld l le lf">...<br/>// routes<br/>require('./app/routes/auth.routes')(app);<br/>require('./app/routes/user.routes')(app);<br/>// set port, listen for requests<br/>...</span></pre><h1 id="e301" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">10.运行和测试</h1><p id="3154" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">使用命令运行Node.js应用程序:node server.js</p><p id="833d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du lh li lj kx b">/signup</code></p><figure class="ks kt ku kv fd ij er es paragraph-image"><div class="er es ma"><img src="../Images/5abbcaa1be49c0695a895bcea0044ecc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/0*_wQQ5KBCPKf5YRLj.png"/></div></figure><p id="3258" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">/API/测试/全部</p><figure class="ks kt ku kv fd ij er es paragraph-image"><div class="er es mb"><img src="../Images/45f26e722e9a3c80f2bd92f35a21994d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1080/format:webp/0*P3V67fmqpzvpb4KO.png"/></div></figure><p id="47cb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">/API/测试/用户</p><figure class="ks kt ku kv fd ij er es paragraph-image"><div class="er es mb"><img src="../Images/aae2bbbb20eb9b3390b72d5f617aa9ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1080/format:webp/0*HCCyHZbfqUom_tqV.png"/></div></figure><p id="fcbe" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">/API/auth/登录</p><figure class="ks kt ku kv fd ij er es paragraph-image"><div class="er es mb"><img src="../Images/128ade190313a9f962181bcd818f5f1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1080/format:webp/0*Vrxh68V-GcmLjT9P.png"/></div></figure><figure class="ks kt ku kv fd ij er es paragraph-image"><div class="er es mc"><img src="../Images/b4f824cc43d335e993b3cb3ebdd7a802.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/format:webp/0*pcTVWzzOSdocLWpx.png"/></div></figure><p id="9dcf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">–获得<code class="du lh li lj kx b">/api/test/user</code><br/>–获得<code class="du lh li lj kx b">/api/test/mod</code><br/>–获得<code class="du lh li lj kx b">/api/test/admin</code></p><figure class="ks kt ku kv fd ij er es paragraph-image"><div class="er es md"><img src="../Images/1df1552deb2953f040aa95d75f8b9ef6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1082/format:webp/0*kD5ckGVknBfOTuXW.png"/></div></figure><p id="9205" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这就是我这次可以传达的教程，希望有用。</p><p id="47ff" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">谢了。</p><p id="50d8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae jo" href="https://temanngoding.com/en/rest-api-login-and-register-node-js-with-jwt/" rel="noopener ugc nofollow" target="_blank">https://temanngoding . com/en/rest-API-log in-and-register-node-js-with-jwt/</a></p></div></div>    
</body>
</html>