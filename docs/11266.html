<html>
<head>
<title>Webapp + Nginx and SSL in Docker Compose</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Docker中的Webapp + Nginx和SSL构成</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/webapp-nginx-and-ssl-in-docker-compose-6d02bdbe8fa0?source=collection_archive---------0-----------------------#2022-03-14">https://medium.com/geekculture/webapp-nginx-and-ssl-in-docker-compose-6d02bdbe8fa0?source=collection_archive---------0-----------------------#2022-03-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="2837" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Python+Flask中的一个简单例子，可以很容易地适应不同的上下文。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/f8469ba5d0bc07e412c52372cbf8d16a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hSJY9yln0Q5xbIU_qMapVA.jpeg"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Photo by <a class="ae jt" href="https://unsplash.com/@wocintechchat?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Christina @ wocintechchat.com</a> on <a class="ae jt" href="https://unsplash.com/s/photos/server?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="9f03" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本教程将解释如何创建一个简单的web应用程序，用Nginx创建一个代理，并用Docker Compose将它们连接在一起。web应用程序将在Python + Flask中，但很容易用另一种技术替换它。</p><h2 id="f9d8" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">网络应用</h2><p id="e046" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">web应用程序只不过是一个简单的例子，它将<code class="du ku kv kw kx b">/</code>链接到<code class="du ku kv kw kx b">hello()</code>以打印“hello world！”当用户调用它时。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="ky kz l"/></div></figure><h2 id="2aba" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">码头工人</h2><p id="5d33" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">Docker是一种虚拟化技术，它将应用程序及其依赖项打包在一个独立于平台的容器中。我建议安装包含所有必要组件的Docker桌面。</p><p id="a738" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一个<code class="du ku kv kw kx b">Dockerfile</code>是Docker用来构建一个<code class="du ku kv kw kx b">image</code>的一组指令，一个映像是Docker用来创建一个容器的只读包。</p><p id="201a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是本教程的docker文件:</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="ky kz l"/></div></figure><p id="fe37" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">简而言之，所有Dockerfiles都从一个基本映像(本例中是python 3.9)开始，复制一些文件，并运行一个或多个命令来设置和启动主进程。<code class="du ku kv kw kx b">setup.py</code>包含python应用程序的依赖关系，而<code class="du ku kv kw kx b">pip3</code>执行设置。最后一行以Flask开头。</p><h2 id="d18b" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">Nginx</h2><p id="57d0" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">Nginx是一个web服务器，通常用作负载平衡器或代理。在这种情况下，启用HTTPS的代理将对与客户端的通信进行加密。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="ky kz l"/></div></figure><p id="b561" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该配置启用SSL并配置<code class="du ku kv kw kx b">/</code>到<code class="du ku kv kw kx b"><a class="ae jt" href="http://app:5000" rel="noopener ugc nofollow" target="_blank">http://app:5000</a></code>的转发。证书和url <code class="du ku kv kw kx b"><a class="ae jt" href="http://appi" rel="noopener ugc nofollow" target="_blank">http://app</a></code>将在后面定义。</p><h2 id="0331" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">Docker撰写</h2><p id="b1b5" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">Docker Compose是一个定义多容器应用程序的工具。在这种情况下，它将在一个虚拟网络中连接Nginx和Flask，只暴露代理的端口。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="ky kz l"/></div></figure><p id="9e6e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个配置创建了两个容器，<code class="du ku kv kw kx b">app</code>和<code class="du ku kv kw kx b">nginx</code>。<code class="du ku kv kw kx b">app</code>是<code class="du ku kv kw kx b">flask</code>微服务的映像，<code class="du ku kv kw kx b">nginx</code>是Nginx的一个实例，有三个卷来映射上面提到的配置，以及用于加密的证书/密钥。请注意，以这种方式定义的<code class="du ku kv kw kx b">app</code>将可以在虚拟网络内通过<code class="du ku kv kw kx b"><a class="ae jt" href="http://app" rel="noopener ugc nofollow" target="_blank">http://app</a></code>到达。</p><h2 id="2c48" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">Run.sh</h2><p id="63a9" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">唯一缺少的部分是TLS证书和Docker映像的构建。这可以通过启动应用程序的脚本自动完成。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="ky kz l"/></div></figure><p id="e400" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第一行生成一个自签名证书。这可以由静态耦合证书/密钥来代替。第二行构建了<code class="du ku kv kw kx b">Dockerfile</code>中描述的docker映像，最后一行启动了<code class="du ku kv kw kx b">docker-compose.yml</code>中描述的Docker Compose。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lb"><img src="../Images/a2b1df05263aa78ec40ee2e4032f427b.png" data-original-src="https://miro.medium.com/v2/resize:fit:942/format:webp/1*NyPAm-A0P04FKLYjH09pFA.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx">The complete system</figcaption></figure><p id="35c9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上图描述了该系统。用户在到达Nginx的<code class="du ku kv kw kx b"><a class="ae jt" href="https://localhost" rel="noopener ugc nofollow" target="_blank">https://localhost</a></code>上连接，Nginx卸载加密并将未加密的调用转发给Flask微服务。</p><h1 id="4ae7" class="lc jv hi bd jw ld le lf ka lg lh li ke lj lk ll kh lm ln lo kk lp lq lr kn ls bi translated">试验</h1><p id="b639" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">打开<a class="ae jt" href="https://localhost" rel="noopener ugc nofollow" target="_blank"> https://localhost </a>可能会在大多数浏览器上出错，因为证书是自签名的。</p><p id="1ccb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在替代方案中<code class="du ku kv kw kx b">curl --insecure https://localhost</code>将简单地返回“hello world！”。详细输出显示了加密的用法。</p><pre class="je jf jg jh fd lt kx lu lv aw lw bi"><span id="c739" class="ju jv hi kx b fi lx ly l lz ma">$ curl --insecure https://localhost -v<br/>*   Trying ::1...<br/>* TCP_NODELAY set<br/>* Connected to localhost (::1) port 443 (#0)<br/>* ALPN, offering h2<br/>* ALPN, offering http/1.1<br/>* successfully set certificate verify locations:<br/>*   CAfile: /etc/ssl/cert.pem<br/>  CApath: none<br/>* TLSv1.2 (OUT), TLS handshake, Client hello (1):<br/>* TLSv1.2 (IN), TLS handshake, Server hello (2):<br/>* TLSv1.2 (IN), TLS handshake, Certificate (11):<br/>* TLSv1.2 (IN), TLS handshake, Server key exchange (12):<br/>* TLSv1.2 (IN), TLS handshake, Server finished (14):<br/>* TLSv1.2 (OUT), TLS handshake, Client key exchange (16):<br/>* TLSv1.2 (OUT), TLS change cipher, Change cipher spec (1):<br/>* TLSv1.2 (OUT), TLS handshake, Finished (20):<br/>* TLSv1.2 (IN), TLS change cipher, Change cipher spec (1):<br/>* TLSv1.2 (IN), TLS handshake, Finished (20):<br/>* SSL connection using TLSv1.2 / ECDHE-RSA-AES256-GCM-SHA384<br/>* ALPN, server accepted to use http/1.1<br/>* Server certificate:<br/>*  subject: C=GB; ST=London; L=London; O=Alros; OU=IT Department; CN=localhost<br/>*  start date: Mar 13 18:51:40 2022 GMT<br/>*  expire date: Mar 13 18:51:40 2023 GMT<br/>*  issuer: C=GB; ST=London; L=London; O=Alros; OU=IT Department; CN=localhost<br/>*  SSL certificate verify result: self signed certificate (18), continuing anyway.<br/>&gt; GET / HTTP/1.1<br/>&gt; Host: localhost<br/>&gt; User-Agent: curl/7.64.1<br/>&gt; Accept: */*<br/>&gt; <br/>&lt; HTTP/1.1 200 OK<br/>&lt; Server: nginx/1.21.6<br/>&lt; Date: Sun, 13 Mar 2022 18:53:47 GMT<br/>&lt; Content-Type: text/html; charset=utf-8<br/>&lt; Content-Length: 12<br/>&lt; Connection: keep-alive<br/>&lt; <br/>* Connection #0 to host localhost left intact<br/>hello world!* Closing connection 0</span></pre><h1 id="63d2" class="lc jv hi bd jw ld le lf ka lg lh li ke lj lk ll kh lm ln lo kk lp lq lr kn ls bi translated">密码</h1><p id="880d" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">完整代码可在<a class="ae jt" href="https://github.com/alros/docker-nginx-flask-demo" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上获得。</p></div></div>    
</body>
</html>