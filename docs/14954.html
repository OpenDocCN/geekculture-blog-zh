<html>
<head>
<title>Big Query for Day-to-Day Analytical workloads</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">日常分析工作负载的大查询</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/big-query-for-day-to-day-analytical-workloads-b5a7af58aefb?source=collection_archive---------12-----------------------#2022-10-04">https://medium.com/geekculture/big-query-for-day-to-day-analytical-workloads-b5a7af58aefb?source=collection_archive---------12-----------------------#2022-10-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="fb80" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">设计和优化</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/c41d60c8f8bd8ea948401635c8e128c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zEyE8OmyQMKLgZS0z3oBGg.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Photo by <a class="ae jn" href="https://harshkothari21.medium.com/" rel="noopener">Author</a></figcaption></figure><p id="d094" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">近一年来，我每天都在使用BigQuery，为组织的多个用例提供服务，包括仪表板、即席分析和报告以及数据科学用例(ML/AI)。我将分享我的经验、知识和一些设计想法。</p><h1 id="4330" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">⚜设计创意</h1><p id="9f69" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">组织通常使用包含开发(非生产)、试运行(生产前)和生产(生产)环境的部署环境结构。我认为它是组织企业数据的最佳方式之一，也是一个很有前途的运营环境。尤其是当你有一个/几个团队的数据工程师，每个人都处理多个用例的时候。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/d0e0150db492dc1b034f8d3dd1f9c797.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n9Ss54A7UjME_sBkmFGAjg.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Photo by <a class="ae jn" href="https://harshkothari21.medium.com/" rel="noopener">Author</a></figcaption></figure><p id="b561" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在BQ中实现相同的技术，您可以为每个环境拥有一个单独的项目，在其中您可以为每个用例创建一个数据集。这种情况的一个例子如下所示，</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lh"><img src="../Images/b5bedee959b20bf292741364aa20deb2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KLTZMHDxOItGLsTQE2a9Kg.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">BigQuery Projects and Datasets</figcaption></figure><p id="e397" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">⚡If一个团队需要一个隔离的地方来进行新的创新或实验，在这种情况下，你可以创建一个单独的项目，称之为“exp-project”，或者在开发环境中创建一个单独的数据集，如“sandbox_team1”或“sandbox_usecase1”。</p><blockquote class="li lj lk"><p id="0a91" class="jo jp ll jq b jr js ij jt ju jv im jw lm jy jz ka ln kc kd ke lo kg kh ki kj hb bi translated">N <!-- -->注意:-不需要复制在多个用例中广泛使用的多个数据集中的表(如发票表)。您可以将这些表存储在一个数据集中，并根据需要向团队提供读取权限。</p></blockquote><h2 id="52f9" class="lp kl hi bd km lq lr ls kq lt lu lv ku jx lw lx kw kb ly lz ky kf ma mb la mc bi translated">好处:</h2><ol class=""><li id="6f7b" class="md me hi jq b jr lc ju ld jx mf kb mg kf mh kj mi mj mk ml bi translated">数据隐私—您可以在数据集级别限制对数据的访问。例如:一个工作在用例上的团队可以有他们自己的数据集，对数据集的访问可以被限制在开发团队，这样其他用户就不能查看/访问数据集。</li><li id="7287" class="md me hi jq b jr mm ju mn jx mo kb mp kf mq kj mi mj mk ml bi translated">使团队能够独立地构建和测试基础设施和应用程序代码，并最终交付在生产中执行的高质量产品。</li><li id="1663" class="md me hi jq b jr mm ju mn jx mo kb mp kf mq kj mi mj mk ml bi translated">定价——我相信，对于GCP来说，定价的透明性从来都不是一个大挑战，对于上述设计来说，它不会变得复杂，此外，它还提供了按用例级别计算成本的能力。</li></ol><h1 id="7720" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">数据层📚</h1><p id="1a22" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated"><em class="ll">创建分层数据仓库</em></p><p id="fd03" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">它可以实现为三个简单的层:</p><ul class=""><li id="a52a" class="md me hi jq b jr js ju jv jx mr kb ms kf mt kj mu mj mk ml bi translated">数据层1 (DL1)，即原始数据:来自源的“原样”数据。</li><li id="f960" class="md me hi jq b jr mm ju mn jx mo kb mp kf mq kj mu mj mk ml bi translated">数据层2 (DL2)，即转换后的数据:这里应用了任何种类的聚合、合并表或业务逻辑/过滤器。</li><li id="b980" class="md me hi jq b jr mm ju mn jx mo kb mp kf mq kj mu mj mk ml bi translated">数据层3 (DL3)，即消费层:用于最终用户访问，包括联合视图。</li></ul><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/840564d14a07260be517f151bce39d69.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ndzqIOHCjlfLJKcap2iHcQ.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Data Layer | Photo by <a class="ae jn" href="https://harshkothari21.medium.com/" rel="noopener">Author</a></figcaption></figure><p id="7791" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在BQ中实现它的方法之一是在一个项目/环境下创建多个数据集。如下图所示，每个数据集上都使用了一个前缀来表示数据图层。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lh"><img src="../Images/dd206a43873a4fb58f4c5d2f032f6458.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YVvnKJ5ES3JA_MdEBQMN3A.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">BigQuery DL</figcaption></figure><h1 id="67a4" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">分区/聚类📦</h1><p id="18ce" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">google docs上关于<a class="ae jn" href="https://cloud.google.com/bigquery/docs/querying-partitioned-tables" rel="noopener ugc nofollow" target="_blank">分区</a> / <a class="ae jn" href="https://cloud.google.com/bigquery/docs/querying-clustered-tables#python" rel="noopener ugc nofollow" target="_blank">聚类</a>(初学者<strong class="jq hj"><em class="ll"/></strong>)的一些例子</p><p id="0f75" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">如果您使用过Big Query，那么您可能非常熟悉分区和集群。当您在一个表中存储大量数据(通常是数百GB和数TB)时，您的分区/集群策略会对性能和成本产生巨大影响。这是我的建议，</p><ul class=""><li id="ab03" class="md me hi jq b jr js ju jv jx mr kb ms kf mt kj mu mj mk ml bi translated"><strong class="jq hj">用例</strong> —数据随着时间的推移不断增加，或者每天包含大量数据。例如，每天生成的发票、库存的历史版本等。</li></ul><blockquote class="li lj lk"><p id="8959" class="jo jp ll jq b jr js ij jt ju jv im jw lm jy jz ka ln kc kd ke lo kg kh ki kj hb bi translated"><em class="hi">分区—每日分区</em></p></blockquote><ul class=""><li id="bda6" class="md me hi jq b jr js ju jv jx mr kb ms kf mt kj mu mj mk ml bi translated"><strong class="jq hj">用例</strong> —每天的记录数量相对较少，或者数据分布在很宽的日期范围内。</li></ul><blockquote class="li lj lk"><p id="12ab" class="jo jp ll jq b jr js ij jt ju jv im jw lm jy jz ka ln kc kd ke lo kg kh ki kj hb bi translated"><em class="hi">分区—月/年分区</em></p></blockquote><ul class=""><li id="ef2b" class="md me hi jq b jr js ju jv jx mr kb ms kf mt kj mu mj mk ml bi translated"><strong class="jq hj">用例</strong>——除了“日期”过滤器，当数据经常按Id(如项目编号和DC)过滤时。一般来说，当你需要一个“盒子里的盒子”的时候。</li></ul><blockquote class="li lj lk"><p id="679b" class="jo jp ll jq b jr js ij jt ju jv im jw lm jy jz ka ln kc kd ke lo kg kh ki kj hb bi translated"><em class="hi">聚类</em></p></blockquote><p id="235e" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">“日期”并不总是分区的最佳字段。我经常查找表的用法(如何使用/查询)，并查找用于过滤数据的字段(通常是“where”子句)。</p><p id="4e42" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">注意:-不要选择一个最终会有数千个分区的字段。您不能超过4000个分区的限制。Google建议每个BQ分区/集群应该至少有512 MB。【<a class="ae jn" href="https://cloud.google.com/bigquery/quotas#partitioned_tables" rel="noopener ugc nofollow" target="_blank">参考此处</a>！]</p><h1 id="10bf" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">实体化视图和调度查询🕒</h1><p id="a878" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">正如Google所推荐的，我使用物化视图来降低计算成本和提高查询性能。</p><blockquote class="mv"><p id="26da" class="mw mx hi bd my mz na nb nc nd ne kj dx translated">“您不仅可以直接查询这些物化表，而且BigQuery optimizer会使用它来处理对基表的查询”</p></blockquote><p id="87c5" class="pw-post-body-paragraph jo jp hi jq b jr nf ij jt ju ng im jw jx nh jz ka kb ni kd ke kf nj kh ki kj hb bi translated"><strong class="jq hj">概念</strong> —非常简单，考虑在中间级别存储计算结果，并在将来的查询中使用这些结果。</p><p id="23e9" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">实施</strong> —</p><ol class=""><li id="b18e" class="md me hi jq b jr js ju jv jx mr kb ms kf mt kj mi mj mk ml bi translated">确定对基表执行的查询集。</li><li id="9a81" class="md me hi jq b jr mm ju mn jx mo kb mp kf mq kj mi mj mk ml bi translated">提出一个查询，它的结果可以用来服务于多个这样的查询，就像一个表的聚合视图。例如:一个销售表，可以汇总到月度/年度，其统计数据被销售报告使用。</li><li id="022d" class="md me hi jq b jr mm ju mn jx mo kb mp kf mq kj mi mj mk ml bi translated">管理刷新并监控使用的性能和BQ插槽</li></ol><blockquote class="li lj lk"><p id="a2bd" class="jo jp ll jq b jr js ij jt ju jv im jw lm jy jz ka ln kc kd ke lo kg kh ki kj hb bi translated">注意:创建实体化视图时，不要试图为查询的每个排列创建实体化视图。相反，应该创建物化视图来服务更广泛的查询集。</p></blockquote><p id="a98d" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj"> <em class="ll">计划查询</em> </strong> —对于更复杂的查询，我经常使用计划查询来设置定期运行，并将结果存储在表中。</p><h1 id="78c3" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">资源</h1><ul class=""><li id="ebec" class="md me hi jq b jr lc ju ld jx mf kb mg kf mh kj mu mj mk ml bi translated"><a class="ae jn" href="https://cloud.google.com/bigquery/docs/materialized-views-create" rel="noopener ugc nofollow" target="_blank">谷歌文档:如何创建物化视图</a></li><li id="39b4" class="md me hi jq b jr mm ju mn jx mo kb mp kf mq kj mu mj mk ml bi translated">谷歌文档:<a class="ae jn" href="https://cloud.google.com/bigquery/docs" rel="noopener ugc nofollow" target="_blank"> Bigquery </a></li><li id="b75a" class="md me hi jq b jr mm ju mn jx mo kb mp kf mq kj mu mj mk ml bi translated">向我提问— <a class="ae jn" href="https://www.linkedin.com/in/harsh-kothari21/" rel="noopener ugc nofollow" target="_blank">我的LinkedIn </a></li></ul><p id="c622" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">按下鼓掌按钮👏如果你觉得这个有用！😊</p></div></div>    
</body>
</html>