<html>
<head>
<title>Microservices as Functions in BigQuery — Offline IP Address Lookup using SQL (Part 2)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">微服务作为BigQuery中的函数——使用SQL进行离线IP地址查找(第2部分)</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/microservices-as-functions-in-bigquery-offline-ip-address-lookup-using-sql-part-2-7b0b91fa5700?source=collection_archive---------17-----------------------#2022-12-19">https://medium.com/geekculture/microservices-as-functions-in-bigquery-offline-ip-address-lookup-using-sql-part-2-7b0b91fa5700?source=collection_archive---------17-----------------------#2022-12-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="b4b0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">了解如何使用SQL检索IP地址的地理位置信息。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/5976dfa46ac5f41141a6e66a771d5245.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*EUpq_GrmHTXImhld"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Photo by <a class="ae jt" href="https://unsplash.com/@stijnswinnen?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Stijn Swinnen</a> on <a class="ae jt" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="7a11" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">动机</h1><p id="e6ee" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">在<a class="ae jt" rel="noopener" href="/geekculture/microservices-as-functions-in-bigquery-language-translation-using-sql-part-1-bd875b291338">第1部分</a>中，我们确定了BigQuery中用户定义函数(UDF)的局限性，并探索了一种称为远程函数的解决方案，它允许我们克服这些局限性。</p><p id="7cae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">简而言之，UDF允许我们定义用SQL或JavaScript编写的自定义SQL来处理BigQuery中的数据。虽然它们是执行复杂数据转换(参见<a class="ae jt" rel="noopener" href="/mlearning-ai/extend-bigquery-nlp-armory-with-stemmers-995fae853b0e">这里</a>的一个例子)或操作的强大工具，但是它们有一些限制。它们不能用于对外部服务进行API调用，只能用SQL或JavaScript编写。为了克服这些限制，谷歌推出了远程功能，让你使用云功能。</p><p id="2764" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">作为一个实际的例子，在本教程的<a class="ae jt" rel="noopener" href="/geekculture/microservices-as-functions-in-bigquery-language-translation-using-sql-part-1-bd875b291338">第1部分</a>中，我们构建了一个使用Azure Translator API获取文本输入并将其翻译成所需语言的web应用。</p><p id="8000" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在第2部分中，我们将构建一个更复杂的web应用程序，它使用MaxMind的免费离线数据库来获取IP地址作为输入，并检索地理位置信息，如国家、城市和邮政编码。</p><p id="eea5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这对于各种目的都非常有用，比如分析我们用户的地理分布。</p><h1 id="3d49" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">运行成本</h1><p id="4ae3" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">您可能对构建这种IP地址查找功能的成本感到好奇，因为批量执行这一任务的类似服务可能非常昂贵。然而，在这种情况下，我们不会破产。</p><p id="7077" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于网络应用，我们将使用谷歌的云功能，这比租用服务器更具成本效益，因为它们只在使用时收费。我们将使用免费层，目前每月免费提供200万次调用。点击阅读更多<a class="ae jt" href="https://cloud.google.com/functions/pricing" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="42fc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于IP地址查找，我们将使用免费的离线MaxMind数据集。由于它是免费的，某些信息如纬度和经度将不如付费版本的服务准确。此外，由于我们使用离线数据库，我们应该经常更新它。</p><h1 id="8e2f" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">IP地址查找功能</h1><p id="ee5f" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">完整的代码可以在<a class="ae jt" href="https://github.com/justdataplease/bigquery-iplookup" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><h1 id="9ca9" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">0.先决条件</h1><p id="3978" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">要继续，我们需要确保完成以下工作:</p><ul class=""><li id="bb9c" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lc ld le lf bi translated">启用谷歌云功能。点击阅读更多<a class="ae jt" href="https://cloud.google.com/functions/docs/create-deploy-gcloud" rel="noopener ugc nofollow" target="_blank">。</a></li><li id="1aee" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">本地安装和配置gcloud CLI。在这里阅读更多<a class="ae jt" href="https://cloud.google.com/sdk/docs/install" rel="noopener ugc nofollow" target="_blank"/>。</li><li id="7d07" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">(可选)在<a class="ae jt" href="https://dev.maxmind.com/geoip/geolite2-free-geolocation-data" rel="noopener ugc nofollow" target="_blank"> MaxMind </a>创建一个免费账户(以便更新数据集)。</li></ul><p id="4317" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此外，为了运行下面的代码片段，我们需要用我们自己的变量替换下面的变量:</p><ul class=""><li id="ebf9" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lc ld le lf bi translated"><your-project-id/></li><li id="013a" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">gcf-conn-name &gt;(步骤2)</li><li id="f34a" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">GCF-终点&gt;(步骤4)</li></ul><p id="521b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">遵循教程的一个简单方法是复制Readme.md并搜索——使用编辑器用你自己的值替换上面的值。</p><h1 id="df62" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">1.克隆存储库(CLI)</h1><p id="e292" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">我们将从克隆回购开始。</p><pre class="je jf jg jh fd lm ln lo bn lp lq bi"><span id="a9d7" class="lr jv hi ln b be ls lt l lu lv">git clone https://github.com/justdataplease/bigquery-iplookup.git</span></pre><pre class="lw lm ln lo bn lp lq bi"><span id="3c75" class="lr jv hi ln b be ls lt l lu lv">cd bigquery-iplookup</span></pre><p id="ca71" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">回购目录具有以下结构:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lx"><img src="../Images/88be2d5572d9a58ca6f26e41b4ae3c86.png" data-original-src="https://miro.medium.com/v2/resize:fit:718/format:webp/0*KyUC8BQqN3EHdwGU.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx">IP Address Lookup app structure, Photo by Author.</figcaption></figure><p id="5b9d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">。env_sample </strong>:包含带有一些样本值的环境变量。<br/>稍后，我们将从<em class="ll">开始对其进行重命名。env_sample - &gt;。env </em>并用我们自己的值替换样本值。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ly"><img src="../Images/5c9c5d7d006e7f5878161d4bdbdbae91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*3oNWqutapn9GV9YN.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Variables in .env file, Photo by Author.</figcaption></figure><p id="a9ef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> db </strong>文件夹:包含GeoLite2-City数据库，是MaxMind的geo GeoIP2-City数据库的免费版本(不太准确)。</p><p id="f772" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> iplookup.py </strong>:包含GeoLocation类，用于确定IP地址的地理位置(国家、州、城市、邮政编码、纬度和经度)。</p><p id="b92b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">update_db()方法用于下载和安装MaxMind GeoLite2数据库(如果系统中没有该数据库)。这是通过向MaxMind下载URL发送GET请求来实现的，该请求带有下载GeoLite2-City数据库的适当参数。然后，它提取下载的. tar.gz文件的内容，并将提取的文件夹重命名为“db”。<br/>要使用这种方法更新数据库，我们需要在我们的。env并删除位于repo中的现有数据库文件夹。</p><p id="8fbf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">lookup_ip()方法将一个ip地址作为参数，并返回一个包含该IP地址的位置信息(国家、州、城市、邮政编码、纬度和经度)的字典。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lz"><img src="../Images/9c8ca85a24cd234b7c0945738d3dc3bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*GUyzHBjNdYtQ1Pfg.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">MaxMind License key, Photo by Author.</figcaption></figure><p id="2011" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> main.py: </strong>包含我们的云函数的代码。</p><pre class="je jf jg jh fd lm ln lo bn lp lq bi"><span id="1798" class="lr jv hi ln b be ls lt l lu lv">import json<br/>import functions_framework<br/>from iplookup import GeoLocation<br/><br/>@functions_framework.http<br/>def iplookup(request):<br/>    """<br/>    Defines iplookup Google Cloud Function<br/>    :param request:<br/>    :return:<br/>    """<br/>    request_json = request.get_json()<br/>    calls = request_json['calls']<br/>    replies = []<br/>    lookup = GeoLocation()<br/>    for call in calls:<br/>        ip_address = call[0]<br/>        rs = lookup.lookup_ip(ip_address=ip_address)<br/>        # each reply is a STRING (JSON not currently supported)<br/>        replies.append(json.dumps(rs, ensure_ascii=False))    <br/>    return json.dumps({'replies': replies})</span></pre><p id="74f5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了使用BigQuery，这个函数有一个特殊的形式。它应该接受多行(调用)作为输入，并遍历每一行(<em class="ll">调用</em>)来执行翻译过程。对于每一行(<em class="ll"> call </em>)，它提取1列(<em class="ll"> call[0] </em>)，作为我们想要检索信息的IP地址。最后，我们将每个响应收集到一个名为<em class="ll"> replies </em>的列表中，并将这个列表转换成一个字符串。</p><p id="6bdb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> test_cloud_function.py: </strong>包含测试我们的云函数的代码。我们会在云功能部署后使用。</p><h1 id="dcc6" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">2.部署云功能(CLI)</h1><p id="59d2" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">首先，要部署我们的云功能，我们需要确保</p><ul class=""><li id="22c6" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lc ld le lf bi translated">我们位于<em class="ll"> bigquery- </em> iplookup目录的根目录下。</li><li id="42ac" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">(可选)我们已重命名。环境样本到。env和我们已经用我们自己的改变了MAXMIND _ license _ KEY<em class="ll">的样本值(我们将在部署云函数后指定<em class="ll"> CLOUD_FUNCTION_URL </em>)。</em></li></ul><p id="574f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，我们应该运行下面的命令，将我们的目录部署为云功能。要了解所用参数的更多信息，请阅读此处的<a class="ae jt" href="https://cloud.google.com/sdk/gcloud/reference/functions/deploy" rel="noopener ugc nofollow" target="_blank"/>。</p><pre class="je jf jg jh fd lm ln lo bn lp lq bi"><span id="a644" class="lr jv hi ln b be ls lt l lu lv">gcloud functions deploy bigquery-iplookup --gen2 --runtime python39 --trigger-http --project=&lt;your-project-id&gt; --entry-point=iplookup --source . --region=europe-west3 --memory=128Mi --max-instances=3 --allow-unauthenticated</span></pre><p id="4020" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">— allow-unauthenticated:为了简单起见，我们添加了这个参数，使我们的函数成为公共的。如果再现，最好避免使用该参数。</p><p id="f815" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从最后一条命令的输出中，我们应该注意到URI(即<a class="ae jt" href="https://bigquery-iplookup-xxxxxx.a.run.app)" rel="noopener ugc nofollow" target="_blank">https://big query-iplookup-XXXXXX . a . run . app)</a>或者访问<a class="ae jt" href="https://console.cloud.google.com/functions/list" rel="noopener ugc nofollow" target="_blank">谷歌云控制台功能</a>。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ma"><img src="../Images/5f9fe74f4bcd69d109669737da0b009a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-dktcUAcWLqD6pE_.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Cloud Function output when deployed successfully, Photo by Author.</figcaption></figure><p id="6cb5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在为了测试云函数，我们可以在我们的<em class="ll">中更新<em class="ll"> CLOUD_FUNCTION_URL </em>。env文件</em>并运行下面的代码。</p><pre class="je jf jg jh fd lm ln lo bn lp lq bi"><span id="675c" class="lr jv hi ln b be ls lt l lu lv">python test_cloud_function.py</span></pre><pre class="lw lm ln lo bn lp lq bi"><span id="ae7f" class="lr jv hi ln b be ls lt l lu lv"># Input<br/>{'calls': [['190.61.88.147'],['139.99.237.62'],<br/>['20.111.54.16'],['185.143.146.171'],['121.126.20.41']]}<br/><br/># Output<br/>{'replies': [<br/>'{"country": "Guatemala", "state": "Departamento de Guatemala", "city": "Guatemala City", "postal_code": "01010", "latitude": 14.6343, "longitude": -90.5155}', <br/>'{"country": "Australia", "state": "New South Wales", "city": "Sydney", "postal_code": "2000", "latitude": -33.8715, "longitude": 151.2006}', <br/>'{"country": "France", "state": "Paris", "city": "Paris", "postal_code": "75001", "latitude": 48.8323, "longitude": 2.4075}', <br/>'{"country": "Ukraine", "state": "Kyiv City", "city": "Kyiv", "postal_code": "03187", "latitude": 50.458, "longitude": 30.5303}', <br/>'{"country": "South Korea", "state": "Seoul", "city": "Guro-gu", "postal_code": "083", "latitude": 37.4975, "longitude": 126.8501}']}</span></pre><p id="d675" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从我们得到的输出中，我们可以看到我们的云功能正在工作！</p><p id="eb44" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">记住<strong class="ih hj">在部署之前，我们还可以通过运行下面的命令(target是main.py文件中定义的函数名)在本地测试我们的函数</strong></p><pre class="je jf jg jh fd lm ln lo bn lp lq bi"><span id="6b74" class="lr jv hi ln b be ls lt l lu lv">functions_framework --target=iplookup</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mb"><img src="../Images/593feafa0ba8fd4d227ec25f94d34162.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*fxmr4Q44cC69zNjk.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Local Cloud Function deployment, Photo by Author.</figcaption></figure><p id="b478" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">根据我们得到的输出，我们在我们的。具有适当本地主机的env文件(即<a class="ae jt" href="http://192.168.2.7:8080)" rel="noopener ugc nofollow" target="_blank">http://192 . 168 . 2 . 7:8080)</a></p><pre class="je jf jg jh fd lm ln lo bn lp lq bi"><span id="e6e0" class="lr jv hi ln b be ls lt l lu lv">python test_cloud_function.py</span></pre><p id="8b10" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我们将得到与上面相同的输出。</p><h1 id="107a" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">3.在BigQuery和云函数(CLI)之间创建连接</h1><p id="d00f" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">我们需要连接BigQuery和云函数，以便将云函数用作远程函数。</p><pre class="je jf jg jh fd lm ln lo bn lp lq bi"><span id="bf0a" class="lr jv hi ln b be ls lt l lu lv">gcloud components update<br/>bq mk --connection --display_name='my_gcf_conn' --connection_type=CLOUD_RESOURCE --project_id=&lt;your-project-id&gt; --location=EU gcf-conn<br/>bq show --project_id=&lt;your-project-id&gt; --location=EU --connection gcf-conn</span></pre><p id="d14e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从最后一个命令的输出(<em class="ll"> bq show </em>)中，我们应该记下这个名称(即xxxxxx.eu.gcf-conn)，因为我们稍后会用到它。</p><h1 id="62e1" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">4.创建玩具数据集(CLI)</h1><p id="ea97" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">为了测试我们的功能，我们将创建一个玩具数据集。这个数据集将包括我们的远程函数和一个包含一些测试数据的表。</p><pre class="je jf jg jh fd lm ln lo bn lp lq bi"><span id="8349" class="lr jv hi ln b be ls lt l lu lv">bq mk --dataset_id=&lt;your-project-id&gt;:iplookup --location=EU</span></pre><h1 id="108b" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">5.创建一个示例表(BigQuery)</h1><p id="88a5" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">为了测试我们的远程函数，我们将创建一个包含测试数据的表。</p><pre class="je jf jg jh fd lm ln lo bn lp lq bi"><span id="7a6a" class="lr jv hi ln b be ls lt l lu lv">CREATE OR REPLACE TABLE `&lt;your-project-id&gt;.iplookup.example_dataset` (<br/>ip_address STRING);<br/>    <br/>INSERT INTO `&lt;your-project-id&gt;.iplookup.example_dataset`(ip_address)<br/>VALUES ('190.61.88.147'),<br/>       ('139.99.237.62'),<br/>       ('20.111.54.16'),<br/>       ('185.143.146.171'),<br/>       ('121.126.20.41');</span></pre><h1 id="4a58" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">6.创建远程函数(BigQuery)</h1><p id="a21f" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">最后，我们将创建我们的远程函数。</p><pre class="je jf jg jh fd lm ln lo bn lp lq bi"><span id="227f" class="lr jv hi ln b be ls lt l lu lv">CREATE OR REPLACE FUNCTION `&lt;your-project-id&gt;.iplookup.lookup`(ip_address STRING)<br/>RETURNS STRING<br/>REMOTE WITH CONNECTION `&lt;gcf-conn-name&gt;`<br/>OPTIONS (<br/>-- change this to reflect the Trigger URL of your cloud function (look for the TRIGGER tab)<br/>endpoint = '&lt;gcf-endpoint&gt;'<br/>);</span></pre><h1 id="5d09" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">7.测试远程函数(BigQuery)</h1><p id="e328" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">为了测试我们的远程函数，我们将在测试数据上运行它。该函数的输出是一个字符串，所以我们需要解析它，将信息提取到列中。</p><pre class="je jf jg jh fd lm ln lo bn lp lq bi"><span id="c58a" class="lr jv hi ln b be ls lt l lu lv">WITH A AS (SELECT `&lt;your-project-id&gt;.iplookup.lookup`(ip_address) ip_address_location,ip_address <br/>FROM `&lt;your-project-id&gt;.iplookup.example_dataset`)<br/>    <br/>SELECT<br/>      ip_address,<br/>      json_value(ip_address_location, '$.country') country,<br/>      json_value(ip_address_location, '$.state') state,<br/>      json_value(ip_address_location, '$.city') city,<br/>      json_value(ip_address_location, '$.postal_code') postal_code,<br/>      json_value(ip_address_location, '$.latitude') latitude,<br/>      json_value(ip_address_location, '$.longitude') longitude<br/> FROM A;</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mc"><img src="../Images/0a02c7d22167d2f7bda838bff17fe843.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*tJZ_IW3hqsD1SSRM.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">IP Address Lookup using SQL, Photo by Admin.</figcaption></figure><p id="78d5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们做到了！我们的功能起作用了。</p><h1 id="abd5" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">8.删除所有内容(CLI)</h1><p id="544f" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">要删除云函数、远程函数和玩具数据集，我们需要运行以下命令:</p><pre class="je jf jg jh fd lm ln lo bn lp lq bi"><span id="c9b6" class="lr jv hi ln b be ls lt l lu lv"># Remove Cloud Function (gcf)<br/>gcloud functions delete bigquery-iplookup --region=europe-west3 --project=&lt;your-project-id&gt; --gen2<br/><br/># Remove DATASET<br/>bq rm -r -f -d &lt;your-project-id&gt;:iplookup<br/><br/># Remove connection between BigQuery and Cloud Functions (gcf-conn)<br/>bq rm --connection --location=EU &lt;gcf-conn-name&gt;Conclusion</span></pre><p id="17c7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本教程的第二部分，我们向您展示了如何使用远程函数来执行IP地址查找和检索地理位置信息。虽然这是我们关于BigQuery中微服务功能的教程的最后一部分，但我们也将在不久的将来探索其他高级功能。</p><p id="de04" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">敬请关注BigQuery Quest刚刚开始！</p></div><div class="ab cl md me gp mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="hb hc hd he hf"><p id="cd05" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您正在探索BigQuery的高级用例，请务必查看我的其他文章。</p><div class="mk ml ez fb mm mn"><a rel="noopener follow" target="_blank" href="/geekculture/microservices-as-functions-in-bigquery-language-translation-using-sql-part-1-bd875b291338"><div class="mo ab dw"><div class="mp ab mq cl cj mr"><h2 class="bd hj fi z dy ms ea eb mt ed ef hh bi translated">微服务作为BigQuery中的函数——使用SQL进行语言翻译(第1部分)</h2><div class="mu l"><h3 class="bd b fi z dy ms ea eb mt ed ef dx translated">了解如何在SQL查询中使用翻译API。</h3></div><div class="mv l"><p class="bd b fp z dy ms ea eb mt ed ef dx translated">medium.com</p></div></div><div class="mw l"><div class="mx l my mz na mw nb jn mn"/></div></div></a></div><div class="mk ml ez fb mm mn"><a rel="noopener follow" target="_blank" href="/mlearning-ai/extend-bigquery-nlp-armory-with-stemmers-995fae853b0e"><div class="mo ab dw"><div class="mp ab mq cl cj mr"><h2 class="bd hj fi z dy ms ea eb mt ed ef hh bi translated">用词干分析器扩展BigQuery NLP库</h2><div class="mu l"><h3 class="bd b fi z dy ms ea eb mt ed ef dx translated">使用Javascript UDFs实现英语、西班牙语和希腊语词干分析器。</h3></div><div class="mv l"><p class="bd b fp z dy ms ea eb mt ed ef dx translated">medium.com</p></div></div><div class="mw l"><div class="nc l my mz na mw nb jn mn"/></div></div></a></div></div><div class="ab cl md me gp mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="hb hc hd he hf"><p id="09c1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你喜欢阅读这样的故事，并想支持我作为一名作家，请考虑<strong class="ih hj">跟随我</strong>和<strong class="ih hj">砸那个拍手按钮</strong>。<br/>感谢您的支持！</p></div></div>    
</body>
</html>