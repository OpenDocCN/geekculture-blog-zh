<html>
<head>
<title>Angular VS Lighthouse — Part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">角度与灯塔—第二部分</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/angular-vs-lighthouse-part-2-1ae627ca9aab?source=collection_archive---------15-----------------------#2021-05-01">https://medium.com/geekculture/angular-vs-lighthouse-part-2-1ae627ca9aab?source=collection_archive---------15-----------------------#2021-05-01</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="87f6" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">提高分数的技巧和窍门。</h2></div><p id="1d5c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这是一些有用的技巧和诀窍的第二部分，可以提高Lighthouse的分数，从而减少首页的加载时间。你可以在这里找到第一部分<a class="ae jt" href="https://francesco-cantarella.medium.com/angular-vs-lighthouse-part-1-27a9ac6584f" rel="noopener"><strong class="iz hj"/></a>。</p><figure class="jv jw jx jy fd jz er es paragraph-image"><div class="er es ju"><img src="../Images/77865610fdd5a05374e88ec3912cdd46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*LtCLhVq2W4mfx8atI83FKw.png"/></div></figure></div><div class="ab cl kc kd gp ke" role="separator"><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh"/></div><div class="hb hc hd he hf"><h2 id="9e3b" class="kj kk hi bd kl km kn ko kp kq kr ks kt jg ku kv kw jk kx ky kz jo la lb lc ld bi translated"><strong class="ak">高</strong></h2><p id="0a18" class="pw-post-body-paragraph ix iy hi iz b ja le ij jc jd lf im jf jg lg ji jj jk lh jm jn jo li jq jr js hb bi translated">为了取得好成绩，我们必须尽可能地减少代码细化，比如繁重的任务或繁重的DOM操作。</p><p id="3f69" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">例如:如果我们有一个带有货币符号的价格列表，我们可以轻松地编写以下代码:</p><pre class="jv jw jx jy fd lj lk ll lm aw ln bi"><span id="66bd" class="kj kk hi lk b fi lo lp l lq lr"><strong class="lk hj">app.component.ts<br/></strong>...</span><span id="9a5d" class="kj kk hi lk b fi ls lp l lq lr">list = [{name: 'item 1', price: '50 &amp;euro;'}, {name: 'item 2', price: '70 &amp;euro;'}];</span><span id="579a" class="kj kk hi lk b fi ls lp l lq lr">app.component.html<br/>...<br/>&lt;div *ngFor="let item of list"&gt;<br/> &lt;div&gt;Price &lt;span [innerHTML]="item.price"&gt;&lt;/span&gt;&lt;/div&gt;<br/>&lt;/div&gt;</span></pre><p id="70f9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果我们有一个50个项目的列表，我们甚至会损失4-5个点！<br/>因此优化后的代码可以是:</p><pre class="jv jw jx jy fd lj lk ll lm aw ln bi"><span id="22cb" class="kj kk hi lk b fi lo lp l lq lr"><strong class="lk hj">app.component.ts</strong><br/>...</span><span id="efa2" class="kj kk hi lk b fi ls lp l lq lr">list = [{name: 'item 1', price: '50 <strong class="lk hj">€</strong>'}, {name: 'item 2', price: '70 <strong class="lk hj">€</strong>'}];</span><span id="d1ff" class="kj kk hi lk b fi ls lp l lq lr">app.component.html<br/>...<br/>&lt;div *ngFor="let item of list"&gt;<br/> &lt;div&gt;{{item.name}} - price &lt;span <strong class="lk hj">[textContent]</strong>="item.price"&gt;&lt;/span&gt;&lt;/div&gt;<br/>&lt;/div&gt;</span></pre><p id="fa0b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当我们使用<strong class="iz hj">【innerHTML】</strong>Angular必须解析一个模板并应用一个DOM杀毒器。当我们使用<strong class="iz hj">【text content】</strong>Angular时只插入一个文本，所以尽量避免使用‘innerHTML’。</p></div><div class="ab cl kc kd gp ke" role="separator"><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh"/></div><div class="hb hc hd he hf"><h2 id="904a" class="kj kk hi bd kl km kn ko kp kq kr ks kt jg ku kv kw jk kx ky kz jo la lb lc ld bi translated"><strong class="ak">低</strong></h2><p id="c7fc" class="pw-post-body-paragraph ix iy hi iz b ja le ij jc jd lf im jf jg lg ji jj jk lh jm jn jo li jq jr js hb bi translated">另一个例子:我们有一个列表，我们想为每个条目包含一个相对的JSON-ld脚本。</p><p id="175d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果我们使用SSR，那么我们可以避免计算2倍的JSON-ld。只需使用<a class="ae jt" href="https://angular.io/api/platform-browser/TransferState" rel="noopener ugc nofollow" target="_blank"><strong class="iz hj">TransferState</strong></a>。</p><pre class="jv jw jx jy fd lj lk ll lm aw ln bi"><span id="f6a8" class="kj kk hi lk b fi lo lp l lq lr"><strong class="lk hj">app.component.ts</strong><br/>const LIST_JSONLD = makeStateKey('LIST_JSONLD');</span><span id="38e7" class="kj kk hi lk b fi ls lp l lq lr">...<br/>constructor(private seoService: SeoService, private state: TransferState) {}</span><span id="433b" class="kj kk hi lk b fi ls lp l lq lr">ngOnInit() {<br/> if (this.isSSR) { // Calculate json-ld only in server side<br/>  // Long list<br/>  const list = [{field1: '...'}...];<br/>  this.listJsonLd = this.seoService.getListJsonLd(list);<br/>  this.state.set(LIST_JSONLD, this.listJsonLd as any);<br/> } else {<br/>  this.listJsonLd = this.state.get(LIST_JSONLD, null as any);<br/>  this.state.remove(LIST_JSONLD);<br/> }<br/>}</span><span id="3831" class="kj kk hi lk b fi ls lp l lq lr"><strong class="lk hj">seo.service.ts</strong><br/>...<br/>getListJsonLd(array) {<br/>    if (array) {<br/>      const jsonldArray = [];<br/>      forEach(array, (value) =&gt; {<br/>        if (value &amp;&amp; value.fields) {<br/>          const jsonld = this.getItemJsonLd(value);<br/>          if (jsonld)<br/>            jsonldArray.push(jsonld);<br/>        }<br/>      });<br/>      return jsonldArray;<br/>    }<br/>  }</span><span id="3891" class="kj kk hi lk b fi ls lp l lq lr">getItemJsonLd(value) {  <br/>...<br/>// Long calculations<br/>}<br/></span><span id="340e" class="kj kk hi lk b fi ls lp l lq lr"><strong class="lk hj">app.component.html</strong><br/>...<br/>&lt;app-json-ld [json]="listJsonLd"&gt;&lt;/app-json-ld&gt;</span></pre></div><div class="ab cl kc kd gp ke" role="separator"><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh"/></div><div class="hb hc hd he hf"><h2 id="ba74" class="kj kk hi bd kl km kn ko kp kq kr ks kt jg ku kv kw jk kx ky kz jo la lb lc ld bi translated"><strong class="ak">高</strong></h2><p id="941f" class="pw-post-body-paragraph ix iy hi iz b ja le ij jc jd lf im jf jg lg ji jj jk lh jm jn jo li jq jr js hb bi translated">通常情况下，角度应用程序会根据使用“loadChildren”参数的路线拆分成单独的文件。<br/>然后会先加载main.js文件，然后Angular会启动，然后路由器模块会加载相关的路由文件。</p><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="er es lt"><img src="../Images/b2407f308703fa451d213b87657f3bea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lAUoNmEfiDUVwQlhxdL4yQ.png"/></div></div><figcaption class="ly lz et er es ma mb bd b be z dx">Using loadChildren route with module not included into the main bundle</figcaption></figure><p id="cd80" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用这种方法，浏览器会执行一系列调用，使我们损失4-5个点。</p><p id="2afa" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这可以通过将路由模块包含到app.module中来避免，因此在编译时，main.js将包含路由模块文件。</p><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="er es mc"><img src="../Images/454835a143dc3a9c7e15522d203dfa83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*laZ_WbGpfJ9kjhJRd7h_Bg.png"/></div></div><figcaption class="ly lz et er es ma mb bd b be z dx">Using loadChildren route with the module included into the main bundle</figcaption></figure><p id="df09" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">但是这只能为一个路由模块完成，否则主模块会增长过多。怎样才能做到不止一条路线？</p><p id="c588" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">诀窍是为每条需要的路线编译不同的应用程序。</p><p id="c04f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这将大大增加编译时间，但这是进行这种优化的唯一选择。</p><p id="17f3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建将用于非优化路线的环境文件:</p><pre class="jv jw jx jy fd lj lk ll lm aw ln bi"><span id="6384" class="kj kk hi lk b fi lo lp l lq lr"><strong class="lk hj">environment_optimized.ts</strong></span><span id="1412" class="kj kk hi lk b fi ls lp l lq lr">export const environment_optimized = {<br/>  preloadedModule: false,<br/>  moduleName: undefined<br/>};</span></pre><p id="dd84" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为每个优化路线创建一个环境文件:</p><pre class="jv jw jx jy fd lj lk ll lm aw ln bi"><span id="d8a6" class="kj kk hi lk b fi lo lp l lq lr"><strong class="lk hj">env_my_module.ts</strong></span><span id="0acf" class="kj kk hi lk b fi ls lp l lq lr">import {MyModule} from '../app/my.module';</span><span id="b25f" class="kj kk hi lk b fi ls lp l lq lr">export const environment_optimized = {<br/>  preloadedModule: [MyModule],<br/>  moduleName: 'MyModule'<br/>};</span></pre><p id="291d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将其添加到应用程序模块导入:</p><pre class="jv jw jx jy fd lj lk ll lm aw ln bi"><span id="4bd1" class="kj kk hi lk b fi lo lp l lq lr"><strong class="lk hj">app.module.ts</strong></span><span id="34eb" class="kj kk hi lk b fi ls lp l lq lr">const imports: any = [<br/> BrowserModule.withServerTransition({ appId: 'my-app' }),<br/> HttpClientModule<br/> ...<br/> ];<br/> <br/>if (environment_optimized.preloadedModule)<br/>  imports.push(environment_optimized.preloadedModule);</span></pre><p id="88e6" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将“moduleName”属性添加到路由中，这在以后会很有用:</p><pre class="jv jw jx jy fd lj lk ll lm aw ln bi"><span id="1646" class="kj kk hi lk b fi lo lp l lq lr"><strong class="lk hj">app-routing.module.ts</strong></span><span id="ed92" class="kj kk hi lk b fi ls lp l lq lr">const routes = [<br/> {  path: 'my-route1',<br/>  loadChildren: import('./my.module').then(m =&gt; m.MyModule),,<br/>  data: {moduleName: 'MyModule'}<br/> }<br/> ...<br/>];</span></pre><p id="f525" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">添加将替换environment_optimized.ts文件的新配置:</p><pre class="jv jw jx jy fd lj lk ll lm aw ln bi"><span id="1554" class="kj kk hi lk b fi lo lp l lq lr"><strong class="lk hj">angular.json</strong></span><span id="118a" class="kj kk hi lk b fi ls lp l lq lr">...<br/>  "configurations": {<br/>            "production": {<br/>              ...<br/>            },<br/>            "mymodule": {<br/>              "outputPath": "dist/mymodule",<br/>              "index": {<br/>                "input": "src/index.html",<br/>                "output": "index_mymodule.html"<br/>              },<br/>              "optimization": true,<br/>              "outputHashing": "all",<br/>              "sourceMap": false,<br/>              "extractCss": true,<br/>              "namedChunks": false,<br/>              "aot": true,<br/>              "extractLicenses": true,<br/>              "vendorChunk": false,<br/>              "buildOptimizer": true,<br/>              "fileReplacements": [<br/>                {<br/>                  "replace": "src/environments/environment.ts",<br/>                  "with": "src/environments/environment.prod.ts"<br/>                },                {<br/>                  "replace": "src/environments/environment_optimized.ts",<br/>                  "with": "src/environments/env_my_module.ts"<br/>                }<br/>              ],<br/>              "serviceWorker": true<br/>            }<br/>          }<br/>...</span></pre><p id="df38" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建一个文件，其中保存要加载的相对于路线的索引文件:</p><pre class="jv jw jx jy fd lj lk ll lm aw ln bi"><span id="1834" class="kj kk hi lk b fi lo lp l lq lr"><strong class="lk hj">optimized_routes_config.js</strong><br/>/**<br/> *<br/> * routeRegex: regular expression for run specific optimized index<br/> * indexFileName: name of the specific index generated<br/> * folder: folder where retrieve relative optimized files<br/> */</span><span id="52b7" class="kj kk hi lk b fi ls lp l lq lr">module.exports = {<br/>  config: [<br/>    {<br/>      routeRegex: [/^\/my-route1\//],<br/>      indexFileName: 'index_mymodule.html',<br/>      folder: 'mymodule'<br/>    }<br/>  ]<br/>};</span></pre><p id="cf88" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">修改server.ts文件以加载所请求的优化路由的正确索引或默认索引:</p><pre class="jv jw jx jy fd lj lk ll lm aw ln bi"><span id="6ab2" class="kj kk hi lk b fi lo lp l lq lr"><strong class="lk hj">server.ts</strong></span><span id="b1a1" class="kj kk hi lk b fi ls lp l lq lr">import * as ORConfig from './optimized_routes_config';<br/>...<br/>const foundORIndex = [];</span><span id="c736" class="kj kk hi lk b fi ls lp l lq lr">app.get('*', (req, res) =&gt; {<br/>  let indexFileName = 'index';<br/>  <br/>  for (let i = 0; i &lt; ORConfig.config.length; i++) {<br/>    for (let j = 0; j &lt; ORConfig.config[i].routeRegex.length; j++) {<br/>      const pattern_index = new RegExp(ORConfig.config[i].routeRegex[j]);<br/>      if (pattern_index.test(req.url)) {<br/>        if (!foundORIndex[ORConfig.config[i].indexFileName])<br/>          foundORIndex[ORConfig.config[i].indexFileName] = fs.existsSync(ORConfig.config[i].indexFileName);<br/>        if (foundORIndex[ORConfig.config[i].indexFileName])<br/>          indexFileName = ORConfig.config[i].indexFileName;<br/>        break;<br/>      }<br/>    }<br/>  }</span><span id="7542" class="kj kk hi lk b fi ls lp l lq lr">res.render(indexFileName, {<br/>    req, res},<br/>    function (err, html) {<br/>      res.send(html);<br/>    }<br/>  );<br/>});</span></pre><p id="04d8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了便于部署，创建一个文件，该文件将复制所有优化的路线。js文件放到默认的dist目录中。只有。必须复制js文件和index_xxxx.html，因为ngsw.json(由angular service worker ngsw创建的文件)必须是默认编译的文件。</p><pre class="jv jw jx jy fd lj lk ll lm aw ln bi"><span id="efdb" class="kj kk hi lk b fi lo lp l lq lr"><strong class="lk hj">deploy_optimized_routes.js</strong></span><span id="af64" class="kj kk hi lk b fi ls lp l lq lr">const ORConfig = require('./optimized_routes_config');</span><span id="f386" class="kj kk hi lk b fi ls lp l lq lr">const fs = require('fs-extra');</span><span id="248c" class="kj kk hi lk b fi ls lp l lq lr">const path = require('path');</span><span id="6f30" class="kj kk hi lk b fi ls lp l lq lr">for (let i = 0; i &lt; ORConfig.config.length; i++) {<br/>  let dirPath = path.resolve('dist/' + ORConfig.config[i].folder); // path to your directory goes here<br/>  let filesList;<br/>  fs.readdir(dirPath, function(err, files){<br/>    filesList = files.filter(function(e){<br/>      return path.extname(e).toLowerCase() === '.js'<br/>    });<br/>    // console.log(filesList);<br/>    filesList.forEach(file =&gt; {<br/>      fs.copyFileSync(dirPath+ '/'+ file, 'dist/' + file, err =&gt; {<br/>        if (err)<br/>          console.log('error copying file', file, err);<br/>      });<br/>    });<br/>    fs.copyFileSync(dirPath + '/' + ORConfig.config[i].indexFileName, 'dist/' + ORConfig.config[i].indexFileName, err =&gt; {<br/>      if (err)<br/>        console.log('error copying file', file, err);<br/>    });<br/>    fs.removeSync(dirPath);<br/>  });<br/>}</span></pre></div><div class="ab cl kc kd gp ke" role="separator"><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh"/></div><div class="hb hc hd he hf"><p id="f2ba" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下周我将发布第3部分，那里会有更多有趣的提示和技巧。敬请关注并留下评论！</p><p id="762e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">更新</strong> : Part 3这里是<a class="ae jt" href="https://francesco-cantarella.medium.com/angular-vs-lighthouse-part-3-848761a629f0" rel="noopener"><strong class="iz hj"/></a>！</p></div></div>    
</body>
</html>