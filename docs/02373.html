<html>
<head>
<title>Observability on K8s — DataDog Autodiscovery and DogStatsD</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">K8s上的可观察性—数据狗自动发现和数据狗统计</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/observability-on-k8s-datadog-autodiscovery-and-dogstatsd-3404c605fcb7?source=collection_archive---------3-----------------------#2021-05-13">https://medium.com/geekculture/observability-on-k8s-datadog-autodiscovery-and-dogstatsd-3404c605fcb7?source=collection_archive---------3-----------------------#2021-05-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="c72d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<a class="ae jd" rel="noopener" href="/@tunguyen9889/observability-on-k8s-monitor-kubernetes-clusters-with-datadog-14c597def537">上一篇文章</a>中，我介绍了DataDog以及如何将它部署到Kubernetes集群。今天，我将分享DataDog中的自动发现功能，以及我们如何将自定义指标发送到DogStastD套接字。</p></div><div class="ab cl je jf gp jg" role="separator"><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj"/></div><div class="hb hc hd he hf"><h1 id="e434" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">要求</h1><ul class=""><li id="4a2c" class="kj kk hi ih b ii kl im km iq kn iu ko iy kp jc kq kr ks kt bi translated">K8s，Docker，DataDog的基础知识。</li><li id="1392" class="kj kk hi ih b ii ku im kv iq kw iu kx iy ky jc kq kr ks kt bi translated">正在运行的AWS EKS集群的管理员权限。你可以去https://eksworkshop.com的<a class="ae jd" href="https://eksworkshop.com" rel="noopener ugc nofollow" target="_blank">参观</a>，学习如何设置。</li><li id="5b2b" class="kj kk hi ih b ii ku im kv iq kw iu kx iy ky jc kq kr ks kt bi translated">管理K8s集群的<em class="kz">kube CTL</em>(<a class="ae jd" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" rel="noopener ugc nofollow" target="_blank">https://kubernetes.io/docs/tasks/tools/install-kubectl/</a>)。</li><li id="ff00" class="kj kk hi ih b ii ku im kv iq kw iu kx iy ky jc kq kr ks kt bi translated">DataDog代理被部署到K8s集群(查看本指南<a class="ae jd" rel="noopener" href="/@tunguyen9889/observability-on-k8s-monitor-kubernetes-clusters-with-datadog-14c597def537"/>)。</li></ul><h1 id="f249" class="jl jm hi bd jn jo la jq jr js lb ju jv jw lc jy jz ka ld kc kd ke le kg kh ki bi translated">DataDog自动发现？</h1><p id="73fa" class="pw-post-body-paragraph if ig hi ih b ii kl ik il im km io ip iq lf is it iu lg iw ix iy lh ja jb jc hb bi translated">根据DataDog <a class="ae jd" href="https://docs.datadoghq.com/getting_started/agent/autodiscovery/?tab=kubernetes#overview" rel="noopener ugc nofollow" target="_blank">官方文件</a>:</p><blockquote class="li lj lk"><p id="030e" class="if ig kz ih b ii ij ik il im in io ip ll ir is it lm iv iw ix ln iz ja jb jc hb bi translated">当您监控集装箱化的基础设施时，出现的一个挑战是集装箱可以从一个主机转移到另一个主机。集装箱化系统的动态特性使其难以人工监控。</p><p id="6e79" class="if ig kz ih b ii ij ik il im in io ip ll ir is it lm iv iw ix ln iz ja jb jc hb bi translated">要解决这个问题，您可以使用Datadog的自动发现功能来自动识别特定容器上运行的服务，并从这些服务中收集数据。每当一个容器启动时，Datadog代理就会识别这个新容器上正在运行哪些服务，查找相应的监控配置，并开始收集指标。</p></blockquote><p id="3453" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">DataDog的自动发现有助于:</p><ul class=""><li id="44fb" class="kj kk hi ih b ii ij im in iq lo iu lp iy lq jc kq kr ks kt bi translated">自动识别在特定容器上运行的服务，并从这些服务中收集详细的指标—无论它们可能在哪里运行。</li><li id="6c47" class="kj kk hi ih b ii ku im kv iq kw iu kx iy ky jc kq kr ks kt bi translated">持续监控您的所有服务，无论底层基础设施多么动态或短暂。</li><li id="e10a" class="kj kk hi ih b ii ku im kv iq kw iu kx iy ky jc kq kr ks kt bi translated">允许您为代理检查定义配置模板，并指定每个检查应应用于哪些容器。</li><li id="08d8" class="kj kk hi ih b ii ku im kv iq kw iu kx iy ky jc kq kr ks kt bi translated">持续监视Docker事件，如容器创建/销毁/启动/停止，然后针对此类事件启用/禁用/重新生成静态检查配置，并报告收集的指标。</li></ul><h1 id="05aa" class="jl jm hi bd jn jo la jq jr js lb ju jv jw lc jy jz ka ld kc kd ke le kg kh ki bi translated">设置自动发现</h1><p id="eee2" class="pw-post-body-paragraph if ig hi ih b ii kl ik il im km io ip iq lf is it iu lg iw ix iy lh ja jb jc hb bi translated">在Kubernetes中，DataDog Agent pods (daemonSet)默认启用自动发现，我们只需验证是否设置了以下环境变量:</p><pre class="lr ls lt lu fd lv lw lx ly aw lz bi"><span id="0f16" class="ma jm hi lw b fi mb mc l md me">➜  ~ kubectl --namespace monitoring exec -it datadog-ja4fx -- env | grep KUBERNETES<br/>...<br/>KUBERNETES=yes<br/>...</span></pre><p id="7516" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">启用该功能后，DataDog代理将根据默认自动发现配置文件，自动尝试自动发现多个服务<a class="ae jd" href="https://docs.datadoghq.com/agent/faq/auto_conf/" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="db75" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">集成模板可以以多种形式定义:Kubernetes pod注释、Docker标签、安装在代理中的配置文件、ConfigMap和键值存储。示例:</p><pre class="lr ls lt lu fd lv lw lx ly aw lz bi"><span id="19c6" class="ma jm hi lw b fi mb mc l md me">apiVersion: v1<br/>kind: Pod<br/># (...)<br/>metadata:<br/>  name: '&lt;POD_NAME&gt;'<br/>  annotations:<br/>    ad.datadoghq.com/&lt;CONTAINER_IDENTIFIER&gt;.check_names: '[&lt;INTEGRATION_NAME&gt;]'<br/>    ad.datadoghq.com/&lt;CONTAINER_IDENTIFIER&gt;.init_configs: '[&lt;INIT_CONFIG&gt;]'<br/>    ad.datadoghq.com/&lt;CONTAINER_IDENTIFIER&gt;.instances: '[&lt;INSTANCE_CONFIG&gt;]'<br/>    # (...)<br/>spec:<br/>  containers:<br/>    - name: '&lt;CONTAINER_IDENTIFIER&gt;'<br/># (...)</span></pre><p id="1533" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如所解释:</p><ul class=""><li id="06fd" class="kj kk hi ih b ii ij im in iq lo iu lp iy lq jc kq kr ks kt bi translated"><code class="du mf mg mh lw b">&lt;CONTAINER_IDENTIFIER&gt;</code>是指标公开的容器的名称。</li><li id="0bd8" class="kj kk hi ih b ii ku im kv iq kw iu kx iy ky jc kq kr ks kt bi translated"><code class="du mf mg mh lw b">&lt;INTEGRATION_NAME&gt;</code>是DataDog集成的名称，例如:apache、redis或openmetrics等。</li><li id="e384" class="kj kk hi ih b ii ku im kv iq kw iu kx iy ky jc kq kr ks kt bi translated"><code class="du mf mg mh lw b">&lt;INIT_CONFIG&gt;</code>是在您的<code class="du mf mg mh lw b">conf.yaml</code>中的<code class="du mf mg mh lw b">init_config:</code>下列出的配置参数，并且是您正在启用的任何集成所必需的。</li><li id="e969" class="kj kk hi ih b ii ku im kv iq kw iu kx iy ky jc kq kr ks kt bi translated"><code class="du mf mg mh lw b">&lt;INSTANCE_CONFIG&gt;</code>是<code class="du mf mg mh lw b">&lt;INIT_CONFIG&gt;</code>的一部分，这些是在<code class="du mf mg mh lw b">conf.yaml</code>中的<code class="du mf mg mh lw b">instances:</code>下列出的配置参数，是您正在启用的任何集成所必需的。</li></ul><p id="4eb3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于其他集成模板类型，可参考<a class="ae jd" href="https://docs.datadoghq.com/agent/kubernetes/integrations/?tab=kubernetes#configuration" rel="noopener ugc nofollow" target="_blank"> Kubernetes集成自动发现</a>。</p><p id="759e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要查看DataDog集成的样子，请参考其<a class="ae jd" href="https://github.com/DataDog/integrations-core" rel="noopener ugc nofollow" target="_blank">集成-核心GitHub </a>。</p><h1 id="9ca8" class="jl jm hi bd jn jo la jq jr js lb ju jv jw lc jy jz ka ld kc kd ke le kg kh ki bi translated">使用DataDog的自动发现功能发送指标</h1><p id="846f" class="pw-post-body-paragraph if ig hi ih b ii kl ik il im km io ip iq lf is it iu lg iw ix iy lh ja jb jc hb bi translated">在本例中，我将展示如何配置<a class="ae jd" href="https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler" rel="noopener ugc nofollow" target="_blank"> cluster-autoscaler </a> (CA)使用自动发现功能向DataDog发送指标:</p><p id="aae2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">集群自动缩放器(CA)通过度量端点以OpenMetrics格式公开<a class="ae jd" href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/proposals/metrics.md" rel="noopener ugc nofollow" target="_blank">其度量。我们将使用</a><a class="ae jd" href="https://docs.datadoghq.com/integrations/openmetrics/" rel="noopener ugc nofollow" target="_blank">DataDog open metrics integration</a>让代理从该端点收集指标，并转发给data dog。</p><p id="65b3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">按照本说明为CA准备必要的配置。</p><p id="5310" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后将这些配置块添加到部署的<code class="du mf mg mh lw b">values.yaml</code>中:</p><pre class="lr ls lt lu fd lv lw lx ly aw lz bi"><span id="a4c1" class="ma jm hi lw b fi mb mc l md me">...<br/>podAnnotations:<br/>  ad.datadoghq.com/aws-cluster-autoscaler.check_names: '["openmetrics"]'<br/>  ad.datadoghq.com/aws-cluster-autoscaler.init_configs: '[{}]'<br/>  ad.datadoghq.com/aws-cluster-autoscaler.instances: |<br/>    [<br/>      {<br/>        "prometheus_url": "http://%%host%%:8085/metrics",<br/>        "namespace": "kubernetes",<br/>        "metrics": ["*"],<br/>        "ignore_metrics":<br/>          [<br/>            "go_*"<br/>          ]<br/>      }<br/>    ]<br/>...<br/>serviceMonitor:<br/>  enabled: true<br/>...</span></pre><p id="0146" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在解释上述配置时，<em class="kz"> podAnnotations </em>将被渲染到<code class="du mf mg mh lw b">conf.yaml</code> ( <a class="ae jd" href="https://github.com/DataDog/integrations-core/blob/master/openmetrics/datadog_checks/openmetrics/data/conf.yaml.example" rel="noopener ugc nofollow" target="_blank">样本文件</a>):</p><ol class=""><li id="4cf9" class="kj kk hi ih b ii ij im in iq lo iu lp iy lq jc mi kr ks kt bi translated"><code class="du mf mg mh lw b">&lt;CONTAINER_IDENTIFIER&gt;</code>是<em class="kz"> aws-cluster-autoscaler </em>。</li><li id="30ea" class="kj kk hi ih b ii ku im kv iq kw iu kx iy ky jc mi kr ks kt bi translated"><code class="du mf mg mh lw b">&lt;INTEGRATION_NAME&gt;</code>是<em class="kz"> openmetrics </em>。</li><li id="f349" class="kj kk hi ih b ii ku im kv iq kw iu kx iy ky jc mi kr ks kt bi translated"><code class="du mf mg mh lw b">&lt;INIT_CONFIG&gt;</code>是<code class="du mf mg mh lw b">[{}]</code>，意思是<em class="kz">空</em>。</li><li id="49e3" class="kj kk hi ih b ii ku im kv iq kw iu kx iy ky jc mi kr ks kt bi translated"><code class="du mf mg mh lw b">&lt;INSTANCE_CONFIG&gt;</code>具有以下配置:</li></ol><ul class=""><li id="1e0d" class="kj kk hi ih b ii ij im in iq lo iu lp iy lq jc kq kr ks kt bi translated"><code class="du mf mg mh lw b">"prometheus_url": "http://%%host%%:8085/metrics"</code>:这是CA的度量端点，使用<code class="du mf mg mh lw b">%%host%%</code>模板变量将帮助自动检测网络并返回CA pod的IP地址。请查看<a class="ae jd" href="https://docs.datadoghq.com/agent/faq/template_variables/" rel="noopener ugc nofollow" target="_blank">自动发现模板变量</a>了解支持变量的完整列表。</li><li id="9999" class="kj kk hi ih b ii ku im kv iq kw iu kx iy ky jc kq kr ks kt bi translated"><code class="du mf mg mh lw b">"namespace": "kubernetes"</code>将为所有指标添加前缀<code class="du mf mg mh lw b">kubernetes.*</code>。</li><li id="a728" class="kj kk hi ih b ii ku im kv iq kw iu kx iy ky jc kq kr ks kt bi translated"><code class="du mf mg mh lw b">"metrics": ["*"]</code>和<code class="du mf mg mh lw b">"ignore_metrics": ["go_*"]</code>表示收集CA支持的所有指标，除了<code class="du mf mg mh lw b">go_*</code>。</li></ul><p id="5a97" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">5.<code class="du mf mg mh lw b">serviceMonitor.enabled: true</code>:创建Prometheus Operator service monitor，并为CA公开<code class="du mf mg mh lw b">/metrics</code>端点。</p><p id="f818" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行<code class="du mf mg mh lw b">helm install</code>将图表部署到集群中:</p><pre class="lr ls lt lu fd lv lw lx ly aw lz bi"><span id="e7a2" class="ma jm hi lw b fi mb mc l md me">➜  ~ helm repo add autoscaler https://kubernetes.github.io/autoscaler<br/>➜  ~ helm install autoscaler --namespace monitoring -f autoscaler-values.yaml autoscaler/cluster-autoscaler</span></pre><p id="fe39" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">验证部署:</p><pre class="lr ls lt lu fd lv lw lx ly aw lz bi"><span id="feb0" class="ma jm hi lw b fi mb mc l md me">➜  ~ kubectl --namespace monitoring get pods -l app.kubernetes.io/instance=autoscaler -o wide --no-headers<br/>autoscaler-aws-cluster-autoscaler-7bre6732d6-czpkf   1/1   Running   1     30s   10.123.45.67   ip-10-123-45-144.ap-southeast-1.compute.internal   &lt;none&gt;   &lt;none&gt;</span></pre><p id="affb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以看到CA已部署，pod正在节点<code class="du mf mg mh lw b">ip-10-123-45-144.ap-southeast-1.compute.internal</code>中运行。</p><p id="da47" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我将在这个例子中解释Kubernetes集成自动发现是如何工作的:</p><ul class=""><li id="ffff" class="kj kk hi ih b ii ij im in iq lo iu lp iy lq jc kq kr ks kt bi translated">由于OpenMetrics检查已与DataDog代理6.6.0版一起打包，代理pod将自动搜索该集成模板的所有pod注释。</li><li id="b9af" class="kj kk hi ih b ii ku im kv iq kw iu kx iy ky jc kq kr ks kt bi translated">在上面的CA Helm的<code class="du mf mg mh lw b">values.yaml</code>中，我们已经用<em class="kz">open metrics</em>integration的配置定义了它的<em class="kz"> podAnnotations </em>，所以代理现在可以开始检查和收集来自CA的指标。</li><li id="47e6" class="kj kk hi ih b ii ku im kv iq kw iu kx iy ky jc kq kr ks kt bi translated">首先，我们需要找到与CA pod在同一个节点上运行的DataDog代理pod:</li></ul><pre class="lr ls lt lu fd lv lw lx ly aw lz bi"><span id="012d" class="ma jm hi lw b fi mb mc l md me">➜  ~ kubectl get pods --all-namespaces -o wide --field-selector spec.nodeName=ip-10-123-45-144.ap-southeast-1.compute.internal | grep -E "autoscaler|datadog"<br/>monitoring     autoscaler-aws-cluster-autoscaler-7bre6732d6-czpkf   1/1     Running     1     120s     10.123.45.67   ip-10-123-45-144.ap-southeast-1.compute.internal   &lt;none&gt;     &lt;none&gt;<br/>monitoring     datadog-ja4fx                                        1/1     Running     0     1d       10.123.45.78   ip-10-123-45-144.ap-southeast-1.compute.internal   &lt;none&gt;     &lt;none&gt;</span></pre><ul class=""><li id="39b1" class="kj kk hi ih b ii ij im in iq lo iu lp iy lq jc kq kr ks kt bi translated">验证代理pod中的集成，在本例中为<code class="du mf mg mh lw b">datadog-ja4fx</code>。</li></ul><pre class="lr ls lt lu fd lv lw lx ly aw lz bi"><span id="a1d6" class="ma jm hi lw b fi mb mc l md me">➜  ~ kubectl --namespace monitoring exec -it datadog-ja4fx -- agent check openmetrics<br/>...<br/>=== Series ===<br/>{<br/>  "series": [<br/>    {<br/>      "metric": "kubernetes.cluster_autoscaler_function_duration_seconds.count",<br/>      "points": [<br/>        [<br/>          1620938471,<br/>          6001<br/>        ]<br/>      ],<br/>      "tags": [<br/>        "docker_image:k8s.gcr.io/autoscaling/cluster-autoscaler:v1.17.4",<br/>        "function:main",<br/>        "image_name:k8s.gcr.io/autoscaling/cluster-autoscaler",<br/>        "image_tag:v1.17.4",<br/>        "kube_app:aws-cluster-autoscaler",<br/>        "kube_app_instance:autoscaler",<br/>        "kube_app_name:aws-cluster-autoscaler",<br/>        "kube_container_name:aws-cluster-autoscaler",<br/>        "kube_deployment:autoscaler-aws-cluster-autoscaler",<br/>        "kube_namespace:monitorin",<br/>        "kube_replica_set:autoscaler-aws-cluster-autoscaler-7bre6732d6",<br/>        "kube_service:autoscaler-aws-cluster-autoscaler",<br/>        "pod_name:autoscaler-aws-cluster-autoscaler-7bre6732d6-czpkf",<br/>        "pod_phase:running",<br/>        "short_image:cluster-autoscaler",<br/>        "upper_bound:15.0"<br/>      ],<br/>      "host": "i-01234abcdxyz",<br/>      "type": "gauge",<br/>      "interval": 0,<br/>      "source_type_name": "System"<br/>    },<br/>...<br/>=== Service Checks ===<br/>[<br/>  {<br/>    "check": "kubernetes.prometheus.health",<br/>    "host_name": "i-01234abcdxyz",<br/>    "timestamp": 1620938470,<br/>    "status": 0,<br/>    "message": "",<br/>    "tags": [<br/>      "docker_image:k8s.gcr.io/autoscaling/cluster-autoscaler:v1.17.4",<br/>      "endpoint:<a class="ae jd" href="http://10.123.45.67:8085/metrics" rel="noopener ugc nofollow" target="_blank">http://10.123.45.67:8085/metrics</a>",<br/>      "image_name:k8s.gcr.io/autoscaling/cluster-autoscaler",<br/>      "image_tag:v1.17.4",<br/>      "kube_app:aws-cluster-autoscaler",<br/>      "kube_app_instance:autoscaler",<br/>      "kube_app_name:aws-cluster-autoscaler",<br/>      "kube_container_name:aws-cluster-autoscaler",<br/>      "kube_deployment:autoscaler-aws-cluster-autoscaler",<br/>      "kube_namespace:addons",<br/>      "kube_replica_set:autoscaler-aws-cluster-autoscaler-7bre6732d6",<br/>      "kube_service:autoscaler-aws-cluster-autoscaler",<br/>      "pod_name:autoscaler-aws-cluster-autoscaler-7bre6732d6-czpkf",<br/>      "pod_phase:running",<br/>      "short_image:cluster-autoscaler"<br/>    ]<br/>  }<br/>]<br/>...<br/>=========<br/>Collector<br/>=========<br/>  Running Checks<br/>  ==============<br/>    openmetrics (1.10.0)<br/>    --------------------<br/>      Instance ID: openmetrics:kubernetes:9c6a&lt;&gt;cac [OK]<br/>      Configuration Source: kubelet:docker://9782a&lt;&gt;20dc088<br/>      Total Runs: 1<br/>      Metric Samples: Last Run: 641, Total: 641<br/>      Events: Last Run: 0, Total: 0<br/>      Service Checks: Last Run: 1, Total: 1<br/>      Average Execution Time : 305ms<br/>      Last Execution Date : 2021-05-13 20:41:11.000000 UTC<br/>      Last Successful Execution Date : 2021-05-13 20:41:11.000000 UTC</span></pre><p id="5526" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">很好，我们可以看到DataDog代理可以检测和收集指标。让我们通过检查Metrics =&gt; Summary来看看指标是否发送到了DataDog:</p><figure class="lr ls lt lu fd mk er es paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="er es mj"><img src="../Images/62b8ccf8658aa30ff9b42b0720b5d9b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ys6O2_wJ0yfEZKyyDl1hsQ.jpeg"/></div></div><figcaption class="mr ms et er es mt mu bd b be z dx">Metrics Summary — Cluster Autoscaler</figcaption></figure></div><div class="ab cl je jf gp jg" role="separator"><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj"/></div><div class="hb hc hd he hf"><h1 id="0dc1" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">DogStatsD</h1><p id="418e" class="pw-post-body-paragraph if ig hi ih b ii kl ik il im km io ip iq lf is it iu lg iw ix iy lh ja jb jc hb bi translated">什么是自定义指标？</p><ul class=""><li id="cc4e" class="kj kk hi ih b ii ij im in iq lo iu lp iy lq jc kq kr ks kt bi translated">如果指标不是从<a class="ae jd" href="https://docs.datadoghq.com/integrations/" rel="noopener ugc nofollow" target="_blank"> 450+数据狗集成</a>之一提交的，则被视为自定义指标。</li><li id="ad50" class="kj kk hi ih b ii ku im kv iq kw iu kx iy ky jc kq kr ks kt bi translated">自定义指标可帮助您跟踪应用程序KPI:访问者数量、平均客户购物篮大小、请求延迟或自定义算法的性能分布。</li><li id="c6fd" class="kj kk hi ih b ii ku im kv iq kw iu kx iy ky jc kq kr ks kt bi translated">自定义指标由指标名称和标记值(包括主机标记)的唯一组合来标识。</li></ul><p id="fc3e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一般来说，您使用<em class="kz"> DogStatsD </em>或通过自定义代理检查发送的任何指标都是自定义指标。</p><p id="253b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">DogStatsD是一个与Datadog代理捆绑在一起的指标聚合服务。它实现了<a class="ae jd" href="https://github.com/etsy/statsd" rel="noopener ugc nofollow" target="_blank"> StatsD </a>协议，并添加了一些特定于数据狗的扩展:</p><ul class=""><li id="b5cb" class="kj kk hi ih b ii ij im in iq lo iu lp iy lq jc kq kr ks kt bi translated">直方图度量类型</li><li id="4dcf" class="kj kk hi ih b ii ku im kv iq kw iu kx iy ky jc kq kr ks kt bi translated">服务检查</li><li id="2999" class="kj kk hi ih b ii ku im kv iq kw iu kx iy ky jc kq kr ks kt bi translated">事件</li><li id="067a" class="kj kk hi ih b ii ku im kv iq kw iu kx iy ky jc kq kr ks kt bi translated">磨尖</li></ul><p id="3c67" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">DogStatsD如何工作？</p><ul class=""><li id="4ff0" class="kj kk hi ih b ii ij im in iq lo iu lp iy lq jc kq kr ks kt bi translated">DogStatsD通过UDP接受<a class="ae jd" href="https://docs.datadoghq.com/developers/metrics/custom_metrics/" rel="noopener ugc nofollow" target="_blank">自定义指标</a>、<a class="ae jd" href="https://docs.datadoghq.com/developers/events/dogstatsd/" rel="noopener ugc nofollow" target="_blank">事件</a>和<a class="ae jd" href="https://docs.datadoghq.com/developers/service_checks/dogstatsd_service_checks_submission/" rel="noopener ugc nofollow" target="_blank">服务检查</a>，并定期汇总和转发给Datadog。</li><li id="7829" class="kj kk hi ih b ii ku im kv iq kw iu kx iy ky jc kq kr ks kt bi translated">因为它使用UDP，所以您的应用程序可以向DogStatsD发送指标，并继续其工作，而无需等待响应。如果DogStatsD变得不可用，您的应用程序将不会遇到中断。</li><li id="5f5b" class="kj kk hi ih b ii ku im kv iq kw iu kx iy ky jc kq kr ks kt bi translated">默认情况下，DogStatsD监听UDP端口8125，但是您也可以配置DogStatsD使用一个<a class="ae jd" href="https://docs.datadoghq.com/developers/dogstatsd/unix_socket/" rel="noopener ugc nofollow" target="_blank"> Unix域套接字</a>。</li></ul><h1 id="1e80" class="jl jm hi bd jn jo la jq jr js lb ju jv jw lc jy jz ka ld kc kd ke le kg kh ki bi translated"><strong class="ak">设置DogStatsD </strong></h1><p id="780a" class="pw-post-body-paragraph if ig hi ih b ii kl ik il im km io ip iq lf is it iu lg iw ix iy lh ja jb jc hb bi translated">在<a class="ae jd" rel="noopener" href="/@tunguyen9889/observability-on-k8s-monitor-kubernetes-clusters-with-datadog-14c597def537">我之前的博客</a>中，<a class="ae jd" href="https://gist.github.com/tunguyen9889/e16db637de93c8b0c2026f800c3bc8de#file-datadog-k8s-values-yaml" rel="noopener ugc nofollow" target="_blank">data dog-k8s-values . YAML</a>已经包含了DogStatsD配置。我使用的是图表版本<strong class="ih hj"> 1.39.9 </strong>，所以配置看起来像:</p><pre class="lr ls lt lu fd lv lw lx ly aw lz bi"><span id="72b3" class="ma jm hi lw b fi mb mc l md me">...<br/>daemonset:<br/>  useHostPort: true<br/>...<br/>datadog:<br/>...<br/>  useDogStatsDSocketVolume: True<br/>  dogStatsDSocketPath: "/var/run/datadog/dsd.socket"<br/># This to expose UDP socket for some application not support UNIX socket<br/>  nonLocalTraffic: True<br/>...</span></pre><p id="6654" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您使用的是图表版本<strong class="ih hj"> 2.x.x </strong>，可以参考<a class="ae jd" href="https://docs.datadoghq.com/developers/dogstatsd/?tab=helm#agent" rel="noopener ugc nofollow" target="_blank">本指南</a>来启用DogStatsD。</p><h1 id="5abe" class="jl jm hi bd jn jo la jq jr js lb ju jv jw lc jy jz ka ld kc kd ke le kg kh ki bi translated">使用DogStatsD套接字发送指标</h1><p id="d071" class="pw-post-body-paragraph if ig hi ih b ii kl ik il im km io ip iq lf is it iu lg iw ix iy lh ja jb jc hb bi translated">应用程序或服务可以使用UDP或UNIX套接字将其指标发送到DogStatsD:</p><ul class=""><li id="88e3" class="kj kk hi ih b ii ij im in iq lo iu lp iy lq jc kq kr ks kt bi translated">UDP套接字:将此变量添加到您的应用程序Kubernetes部署中:</li></ul><pre class="lr ls lt lu fd lv lw lx ly aw lz bi"><span id="91bd" class="ma jm hi lw b fi mb mc l md me">env:<br/>- name: DD_AGENT_HOST<br/>  valueFrom:<br/>    fieldRef:<br/>      fieldPath: status.hostIP</span></pre><ul class=""><li id="b2b6" class="kj kk hi ih b ii ij im in iq lo iu lp iy lq jc kq kr ks kt bi translated">UNIX socket:将DogStatsD socket挂载到您的应用程序Kubernetes部署中:</li></ul><pre class="lr ls lt lu fd lv lw lx ly aw lz bi"><span id="9b26" class="ma jm hi lw b fi mb mc l md me">volumeMounts:<br/>  - name: dsdsocket<br/>    mountPath: /var/run/datadog<br/>    readOnly: true<br/>...<br/>volumes:<br/>- hostPath:<br/>    path: /var/run/datadog/<br/>  name: dsdsocket</span></pre><ul class=""><li id="0fef" class="kj kk hi ih b ii ij im in iq lo iu lp iy lq jc kq kr ks kt bi translated">使用端口<code class="du mf mg mh lw b">8125</code>将应用程序的StatD配置指向<code class="du mf mg mh lw b">/var/run/datadog/dsd.socket</code>或<code class="du mf mg mh lw b">$DD_AGENT_HOST</code>。</li></ul><p id="5870" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我编写了一个小部署来测试使用<code class="du mf mg mh lw b">netcat</code>向DogStatsD发送定制指标:</p><figure class="lr ls lt lu fd mk"><div class="bz dy l di"><div class="mv mw l"/></div></figure><p id="439d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将部署应用到集群中:</p><pre class="lr ls lt lu fd lv lw lx ly aw lz bi"><span id="dd04" class="ma jm hi lw b fi mb mc l md me">➜  ~ kubectl apply -f dogstatsd-demo.yaml<br/>configmap/custom-metrics-script created<br/>deployment.apps/dogstatsd-demo created</span></pre><p id="9627" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">等待pod运行，并在DataDog Metrics Explorer中验证:</p><figure class="lr ls lt lu fd mk er es paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="er es mx"><img src="../Images/d2a42b44ef0e7aa12ec43ee6afa0cc86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KrmYpI7AS0yqhHbV3rNq1g.jpeg"/></div></div><figcaption class="mr ms et er es mt mu bd b be z dx">Metrics Explorer — DogStatsD</figcaption></figure><p id="1759" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">删除部署以避免意外的<a class="ae jd" href="https://docs.datadoghq.com/account_management/billing/custom_metrics/?tab=countrategauge" rel="noopener ugc nofollow" target="_blank">自定义指标计费</a>:</p><pre class="lr ls lt lu fd lv lw lx ly aw lz bi"><span id="04b6" class="ma jm hi lw b fi mb mc l md me">➜  ~ kubectl delete -f dogstatsd-demo.yaml<br/>configmap/custom-metrics-script deleted<br/>deployment.apps/dogstatsd-demo deleted</span></pre></div><div class="ab cl je jf gp jg" role="separator"><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj"/></div><div class="hb hc hd he hf"><h1 id="220b" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">下一步是什么</h1><p id="79c9" class="pw-post-body-paragraph if ig hi ih b ii kl ik il im km io ip iq lf is it iu lg iw ix iy lh ja jb jc hb bi translated">这篇博客是基于我自己在现有的EKS系统上使用DataDog的经验。它可能在您现有的环境中工作，也可能不工作。可以访问<a class="ae jd" href="https://docs.datadoghq.com/agent/kubernetes/?tab=helm" rel="noopener ugc nofollow" target="_blank"> DataDog官方文档</a>了解更多信息。请随意留下评论或问题。</p><p id="d3f5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">希望你喜欢阅读我的博客。在下一篇文章中，我将分享如何使用自动发现将Spark on K8s指标发送到DataDog:</p><div class="my mz ez fb na nb"><a href="https://tunguyen9889.medium.com/spark-on-k8s-send-spark-jobs-metrics-to-datadog-using-autodiscovery-fc10488ecdc9" rel="noopener follow" target="_blank"><div class="nc ab dw"><div class="nd ab ne cl cj nf"><h2 class="bd hj fi z dy ng ea eb nh ed ef hh bi translated">K8s上的Spark—使用自动发现将Spark作业的指标发送到DataDog</h2><div class="ni l"><p class="bd b fp z dy ng ea eb nh ed ef dx translated">tunguyen9889.medium.com</p></div></div><div class="nj l"><div class="nk l nl nm nn nj no mp nb"/></div></div></a></div></div><div class="ab cl je jf gp jg" role="separator"><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj"/></div><div class="hb hc hd he hf"><div class="lr ls lt lu fd nb"><a href="https://about.me/tunguyen9889" rel="noopener  ugc nofollow" target="_blank"><div class="nc ab dw"><div class="nd ab ne cl cj nf"><h2 class="bd hj fi z dy ng ea eb nh ed ef hh bi translated">詹姆斯·nguyễn关于我</h2><div class="np l"><h3 class="bd b fi z dy ng ea eb nh ed ef dx translated">我是新加坡的云基础设施工程师。看我的博客。</h3></div><div class="ni l"><p class="bd b fp z dy ng ea eb nh ed ef dx translated">关于我</p></div></div><div class="nj l"><div class="nq l nl nm nn nj no mp nb"/></div></div></a></div></div></div>    
</body>
</html>