<html>
<head>
<title>My Experience Deploying an App With Streamlit Sharing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我部署具有Streamlit共享功能的应用的体验</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/my-experience-deploying-an-app-with-streamlit-sharing-471e49905247?source=collection_archive---------12-----------------------#2021-03-08">https://medium.com/geekculture/my-experience-deploying-an-app-with-streamlit-sharing-471e49905247?source=collection_archive---------12-----------------------#2021-03-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="88c1" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">构建一个具有良好内存管理和避免内存泄漏的多功能应用程序</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/8a6f841650e10904cec2995bc842801a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*TO178H4Cy_kWffb6"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Photo by <a class="ae jn" href="https://unsplash.com/@ademay?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Adem AY</a> on <a class="ae jn" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="6424" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这不是如何使用streamlit的教程，你可以在<a class="ae jn" href="https://docs.streamlit.io/en/stable/" rel="noopener ugc nofollow" target="_blank"> streamlit文档</a>和<a class="ae jn" rel="noopener" href="/search?q=streamlit%20tutorial">媒体文章</a>中找到很棒的教程。这是我在部署应用程序和调试streamlit共享最常见的错误时反复试验的总结。</p><p id="059c" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">对于那些不知道<a class="ae jn" href="https://streamlit.io/" rel="noopener ugc nofollow" target="_blank"> streamlit </a>的人来说，这是一个开源的应用框架，数据科学家可以用几行代码部署他们的数据应用。streamlit的使用非常简单。在这里，我们讨论的是构建应用程序，因为部署应用程序是另一回事。就像他们说的那样:简单得离谱。</p><blockquote class="kl"><p id="6845" class="km kn hi bd ko kp kq kr ks kt ku kj dx translated">N <!-- -->现在，让我们进入主题:<strong class="ak">如何调试您在使用streamlit构建和部署应用程序时遇到的最常见的错误？</strong></p></blockquote><p id="7fc9" class="pw-post-body-paragraph jo jp hi jq b jr kv ij jt ju kw im jw jx kx jz ka kb ky kd ke kf kz kh ki kj hb bi translated">我将分享的技巧对于有计算机科学背景的人来说可能是小菜一碟。然而，对于主要使用jupyter笔记本的数据科学家来说，<strong class="jq hj">他们是潜在的streamlit用户</strong>，这篇文章可能是有用的，因为它强调了面向对象编程在构建内存友好的干净管道中的重要性。</p></div><div class="ab cl la lb gp lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="hb hc hd he hf"><h1 id="d5d6" class="lh li hi bd lj lk ll lm ln lo lp lq lr io ls ip lt ir lu is lv iu lw iv lx ly bi translated">我的Web应用程序:</h1><p id="9a27" class="pw-post-body-paragraph jo jp hi jq b jr lz ij jt ju ma im jw jx mb jz ka kb mc kd ke kf md kh ki kj hb bi translated"><strong class="jq hj">App预测木薯植物病害:</strong> <a class="ae jn" href="https://share.streamlit.io/amiiney/cld-app-streamlit/main/app.py" rel="noopener ugc nofollow" target="_blank"> <strong class="jq hj"> Web App </strong> </a></p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es me"><img src="../Images/765bdcc5ac5416c527216fe004731f3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*kHumPoqbTtSgORFmSnvi9A.gif"/></div><figcaption class="jj jk et er es jl jm bd b be z dx"><strong class="bd lj">Figure 1.</strong> GIF of my App’s page: Select an image to discover the app’s features.</figcaption></figure><p id="54b4" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">上面的gif显示了我的应用程序的功能:<strong class="jq hj">你上传/选择一张木薯植物图像，深度学习模型预测植物图像中的疾病，并提供详细的报告。</strong></p><p id="0903" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj"> <em class="kk">这款应用背后的想法:</em> </strong>我参加了一个kaggle比赛:<a class="ae jn" href="https://www.kaggle.com/c/cassava-leaf-disease-classification" rel="noopener ugc nofollow" target="_blank">木薯叶疾病预测比赛</a>我们要训练模型来预测木薯植物中的疾病。我已经准备好了模型和权重，所以我决定创建我的第一个streamlit应用。</p><p id="861a" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">如果你想了解更多关于模型的训练过程，请查看我的文章:</p><div class="mf mg ez fb mh mi"><a href="https://aminey.medium.com/how-to-train-ml-models-with-mislabeled-data-cf4bb353b3d9" rel="noopener follow" target="_blank"><div class="mj ab dw"><div class="mk ab ml cl cj mm"><h2 class="bd hj fi z dy mn ea eb mo ed ef hh bi translated">如何用错误标记的数据训练ML模型</h2><div class="mp l"><h3 class="bd b fi z dy mn ea eb mo ed ef dx translated">当你的数据有噪音和标签错误时，如何有效地训练机器学习模型的3个技巧…</h3></div><div class="mq l"><p class="bd b fp z dy mn ea eb mo ed ef dx translated">aminey.medium.com</p></div></div><div class="mr l"><div class="ms l mt mu mv mr mw jh mi"/></div></div></a></div></div><div class="ab cl la lb gp lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="hb hc hd he hf"><h1 id="0357" class="lh li hi bd lj lk ll lm ln lo lp lq lr io ls ip lt ir lu is lv iu lw iv lx ly bi translated">演示应用选项</h1><p id="80b8" class="pw-post-body-paragraph jo jp hi jq b jr lz ij jt ju ma im jw jx mb jz ka kb mc kd ke kf md kh ki kj hb bi translated">为了获得灵感，我检查了<a class="ae jn" href="https://streamlit.io/gallery" rel="noopener ugc nofollow" target="_blank"> streamlit应用程序库</a>中的许多应用程序，并意识到作为用户，为用户提供演示选项来测试应用程序非常重要。</p><p id="217a" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">许多应用程序都很棒，但它们需要用户上传文件才能运行，大多数用户会直接跳过。然而，<strong class="jq hj">如果你给用户提供一个演示选项，那么用户很有可能会测试你的应用程序并发现它提供的所有功能。</strong></p><p id="3b2f" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我的应用程序的演示版本的一个例子。我为用户提供了3个内置图像供选择:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mx"><img src="../Images/8f5a921ebbff0e137d89f0586bae9c85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jJW1X1mabo4UQnx0ePSpKQ.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx"><strong class="bd lj">Figure 2. </strong>Demo app provides the user with 3 images to select for trial</figcaption></figure><p id="5563" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">向你的应用程序添加演示会增加你的内存消耗，这就是为什么学习如何有效地管理你的RAM以避免内存泄漏是很重要的。</p></div><div class="ab cl la lb gp lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="hb hc hd he hf"><h1 id="f910" class="lh li hi bd lj lk ll lm ln lo lp lq lr io ls ip lt ir lu is lv iu lw iv lx ly bi translated">内存管理:充分利用800MB内存</h1><p id="dddb" class="pw-post-body-paragraph jo jp hi jq b jr lz ij jt ju ma im jw jx mb jz ka kb mc kd ke kf md kh ki kj hb bi translated">通过streamlit共享，应用程序可以获得多达1个CPU、800 MB内存和800 MB内存。与Heroku只有512个RAM的自由层相比，这是一个很大的计算能力。内存是我们要优化的变量，尤其是多功能应用。<strong class="jq hj">我们希望我们的应用程序以最小的内存消耗拥有尽可能多的功能。</strong></p><p id="4dc3" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">您可以在<strong class="jq hj"> <em class="kk">图1 </em> </strong>中看到，我的应用程序有许多可能会消耗大量内存的元素:</p><ul class=""><li id="c9d8" class="my mz hi jq b jr js ju jv jx na kb nb kf nc kj nd ne nf ng bi translated"><strong class="jq hj">很多依赖:</strong> OpenCV，matplotlib和albumentations用于图像预处理，Pytorch和torchvision用于建模…</li><li id="2aa8" class="my mz hi jq b jr nh ju ni jx nj kb nk kf nl kj nd ne nf ng bi translated"><strong class="jq hj">图像:</strong>图像数据比文本或表格数据占用更多的RAM空间。</li><li id="5409" class="my mz hi jq b jr nh ju ni jx nj kb nk kf nl kj nd ne nf ng bi translated"><strong class="jq hj">深度学习模型:</strong>加载训练权重(大小100MB)。</li><li id="9204" class="my mz hi jq b jr nh ju ni jx nj kb nk kf nl kj nd ne nf ng bi translated"><strong class="jq hj">众多功能:</strong> <strong class="jq hj"> (1) </strong> <em class="kk">选择/上传图像</em> <strong class="jq hj"> (2) </strong> <em class="kk">显示图像</em> <strong class="jq hj"> (3) </strong> <em class="kk">打印预测结果</em> <strong class="jq hj"> (4) </strong> <em class="kk">显示grad-cam图像</em> <strong class="jq hj"> (5) </strong> <em class="kk">打印</em> <em class="kk">类预测表。</em> <strong class="jq hj">每执行一个特性都会导致一个对象存储在内存中。</strong></li></ul><p id="14ef" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">理想的内存使用应该如下图所示。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nm"><img src="../Images/25f4cf23921ce702573ab39a912f53fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZWza9IzVGoCamdTnryDm3A.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx"><strong class="bd lj">Figure 3.</strong> App memory usage: (1) Installing dependencies/Libraries (Exponential phase) (2) App running without memory consumption (plateau). [Image by Author]</figcaption></figure><p id="70f3" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">当你的应用程序启动时，当安装你在<a class="ae jn" href="https://github.com/Amiiney/cld-app-streamlit/blob/main/requirements.txt" rel="noopener ugc nofollow" target="_blank"> requirements.txt </a>文件中引用的依赖项时，它会消耗大量的内存，这些依赖项是你的应用程序运行所必需的。</p><p id="99af" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">指数阶段的快速增长之后是平台期，在平台期，你的应用程序在稳定点附近正确运行，而不会增加内存消耗。</p><blockquote class="kl"><p id="7f8d" class="km kn hi bd ko kp kq kr ks kt ku kj dx translated">您的内存限制(800MB)和稳定阶段之间的差异很重要。it停滞越低，您的应用程序可以同时处理的用户就越多。</p></blockquote><p id="03b4" class="pw-post-body-paragraph jo jp hi jq b jr kv ij jt ju kw im jw jx kx jz ka kb ky kd ke kf kz kh ki kj hb bi translated">关于<a class="ae jn" href="https://www.cloudbees.com/blog/debugging-a-memory-leak-on-heroku/" rel="noopener ugc nofollow" target="_blank">调试内存泄漏</a>的更多信息。</p></div><div class="ab cl la lb gp lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="hb hc hd he hf"><h1 id="7ac1" class="lh li hi bd lj lk ll lm ln lo lp lq lr io ls ip lt ir lu is lv iu lw iv lx ly bi translated"><strong class="ak">提示N 1:不要安装不必要的库</strong></h1><p id="5006" class="pw-post-body-paragraph jo jp hi jq b jr lz ij jt ju ma im jw jx mb jz ka kb mc kd ke kf md kh ki kj hb bi translated">如果你是一个jupyter笔记本用户，你可能总是通过导入几十个库来开始你的工作，有时你不会使用它们中的大多数，因为你在colab笔记本中有15GB的RAM，保留它们不会有什么坏处。如果你用streamlit <em class="kk"> </em>部署一个应用，你只有800MB的内存。</p><p id="9021" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">下面是我如何减少库数量的两个例子:</strong></p><ul class=""><li id="3af7" class="my mz hi jq b jr js ju jv jx na kb nb kf nc kj nd ne nf ng bi translated"><strong class="jq hj"> <em class="kk">避免“重复”库:</em> </strong>我同时使用Pillow和OpenCV库进行图像预处理。你可以和他们中的任何一个完美地合作。所以我必须转换所有的枕头代码，坚持使用OpenCV。</li><li id="d5b7" class="my mz hi jq b jr nh ju ni jx nj kb nk kf nl kj nd ne nf ng bi translated"><strong class="jq hj"> <em class="kk">避免“中介”库:</em> </strong>我使用<a class="ae jn" href="https://pypi.org/project/timm/" rel="noopener ugc nofollow" target="_blank"> Timm库</a>来导入我的pytorch模型。嗯，Timm库本身从<a class="ae jn" href="https://pytorch.org/vision/stable/index.html" rel="noopener ugc nofollow" target="_blank">火炬视觉库</a>引入了这个模型。所以，<strong class="jq hj">我完全可以删除Timm库，直接从Torchvision导入</strong>。</li></ul></div><div class="ab cl la lb gp lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="hb hc hd he hf"><h1 id="f15c" class="lh li hi bd lj lk ll lm ln lo lp lq lr io ls ip lt ir lu is lv iu lw iv lx ly bi translated">技巧2:避免内存泄漏</h1><p id="bf73" class="pw-post-body-paragraph jo jp hi jq b jr lz ij jt ju ma im jw jx mb jz ka kb mc kd ke kf md kh ki kj hb bi translated">我犯的错误，也是大多数jupyter笔记本用户会犯的错误，是在整个笔记本的许多变量中存储相同的数据，这转化为不必要的内存消耗。<strong class="jq hj">最理想的做法是将所有变量封装在python函数或类中</strong>,以确保每个变量只被读取和存储在内存中一次。</p><p id="0249" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这适用于单次使用，然而，我们的应用程序是指由多个用户多次使用。每次用户使用该应用程序时，你的python脚本在后台运行，你的python对象存储在内存中。</p><blockquote class="kl"><p id="a959" class="km kn hi bd ko kp kq kr ks kt ku kj dx translated">我意识到，在将我的应用程序发送给一些用户进行测试后，在第4个用户打开它之前，应用程序就崩溃了。</p></blockquote><figure class="nn no np nq nr jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nm"><img src="../Images/d13b6a02422b4dba7e96cf7c24aad40d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qkPWySxyZFFMgzJHdKenFw.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx"><strong class="bd lj">Figure 4. </strong>Memory leak: The accumulation of not deleted python objects by the users lead to a constant increase in memory consumption and exceeding the RAM limit. [Image by Author]</figcaption></figure><p id="44a8" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">正如我前面提到的，我的应用程序使用了一个沉重的深度学习模型，仅模型的权重就消耗了100MB的内存。因此，在内存中反复存储模型使得我的应用程序在3次尝试后崩溃。</p><p id="5d8d" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">解决这个问题的方法很简单，把所有的变量包装在一个函数或者一个类里面。代码执行后，<strong class="jq hj">删除每一个变量(图像、数据框、模型、重量……)。</strong></p><blockquote class="ns nt nu"><p id="a64c" class="jo jp kk jq b jr js ij jt ju jv im jw nv jy jz ka nw kc kd ke nx kg kh ki kj hb bi translated">可以查看我的<a class="ae jn" href="https://github.com/Amiiney/cld-app-streamlit/blob/main/app.py" rel="noopener ugc nofollow" target="_blank"> app.py脚本</a>中的代码。所有的变量都包裹在<strong class="jq hj"> <em class="hi"> deploy() </em> </strong>函数中。该函数执行后，用<strong class="jq hj"> <em class="hi"> del </em> </strong>关键字删除所有变量。</p></blockquote><p id="a83c" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">如果在使用完内存后不释放它，会导致内存泄漏。有时候删除使用过的变量是不够的，尤其是当你的变量是从一个类或者一个函数中复制过来的时候。从长远来看，这可能会影响你的应用。</p><p id="8fcb" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">为了确保所有使用过的数据都从内存中释放出来，<a class="ae jn" href="https://docs.python.org/3/library/gc.html" rel="noopener ugc nofollow" target="_blank">使用python中的垃圾收集模块</a>。运行垃圾收集进程会从内存中清除大量未使用的对象。</p><pre class="iy iz ja jb fd ny nz oa ob aw oc bi"><span id="c8a2" class="od li hi nz b fi oe of l og oh">#Import the garbage collection module<br/>Import gc</span><span id="3775" class="od li hi nz b fi oi of l og oh">#Enable garbage collection<br/>gc.enable()</span><span id="7f26" class="od li hi nz b fi oi of l og oh">#Clean up the memory from unused objects<br/>gc.collect()</span></pre><p id="b159" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">要了解更多关于垃圾收集的知识，我推荐阅读这篇文章:<a class="ae jn" href="https://stackify.com/python-garbage-collection/" rel="noopener ugc nofollow" target="_blank"> Python垃圾收集:什么是垃圾收集，它是如何工作的</a>。</p></div><div class="ab cl la lb gp lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="hb hc hd he hf"><h1 id="2f3f" class="lh li hi bd lj lk ll lm ln lo lp lq lr io ls ip lt ir lu is lv iu lw iv lx ly bi translated">最后的想法</h1><p id="6431" class="pw-post-body-paragraph jo jp hi jq b jr lz ij jt ju ma im jw jx mb jz ka kb mc kd ke kf md kh ki kj hb bi translated">我在本文中分享了一些改善Web应用程序内存管理的基本技巧。这是我的第一个应用程序，所以任何关于如何提高应用程序性能的建议或提示都非常受欢迎。你可以在<a class="ae jn" href="https://github.com/Amiiney/cld-app-streamlit" rel="noopener ugc nofollow" target="_blank">我的GitHub库</a>中找到代码，可以随时通过pull请求为项目做贡献。</p></div></div>    
</body>
</html>