<html>
<head>
<title>How to Authenticate From Scratch Using Node.JS and MongoDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Node从头开始认证？JS和MongoDB</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/how-to-authenticate-from-scratch-using-node-js-and-mongodb-505bdd05eec9?source=collection_archive---------4-----------------------#2021-03-27">https://medium.com/geekculture/how-to-authenticate-from-scratch-using-node-js-and-mongodb-505bdd05eec9?source=collection_archive---------4-----------------------#2021-03-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="2d2d" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">了解auth如何工作的基本知识，并制作一个没有passport或其替代品的基本系统。</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/0cf1361b0ca89e40b16dd0e7dc63d635.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*du_u_vZXxnHXiIIr"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Photo by <a class="ae jn" href="https://unsplash.com/@altumcode?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">AltumCode</a> on <a class="ae jn" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="04e8" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">有大量的库可用于在每个框架和数据库系统中实现身份验证。虽然其中一些完全能够满足任何一般的身份认证需求，但在某些情况下，我们可能希望对用户登录我们产品的方式进行更高级别的控制，在这种情况下，我们希望从头开始。</p><p id="f5f8" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">然而，在我们开始之前，请注意，如果您的需求是基本的，那么最好是使用像passport这样的库。JS，它由在web安全领域知识渊博的人不断更新。阅读本文将有助于您理解基础知识，但是让您的站点免受攻击是一个完全不同的话题。</p><h2 id="1e7d" class="kk kl hi bd km kn ko kp kq kr ks kt ku jx kv kw kx kb ky kz la kf lb lc ld le bi translated">一些重要的观点</h2><ol class=""><li id="bc38" class="lf lg hi jq b jr lh ju li jx lj kb lk kf ll kj lm ln lo lp bi translated">每一步给出的代码也包含前一步的代码。所以最好的方法是理解文章的所有内容，并最终在最后一步使用代码。但是，如果您希望并排编写代码，这也完全没问题。</li><li id="153f" class="lf lg hi jq b jr lq ju lr jx ls kb lt kf lu kj lm ln lo lp bi translated">假设您具备Node的基本知识。JS和MongoDB。虽然我会在后面解释一切，但是很难在一篇文章中介绍节点和身份验证。</li></ol><p id="e473" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">话虽如此，让我们继续这篇文章的目的。然而，在我们跳到代码之前，让我们把问题分成更小的子问题，我们可以一个一个地解决，最终解决所有问题。</p><ol class=""><li id="5437" class="lf lg hi jq b jr js ju jv jx lv kb lw kf lx kj lm ln lo lp bi translated">注册新用户</li><li id="2ea1" class="lf lg hi jq b jr lq ju lr jx ls kb lt kf lu kj lm ln lo lp bi translated">让用户登录</li><li id="559d" class="lf lg hi jq b jr lq ju lr jx ls kb lt kf lu kj lm ln lo lp bi translated">注销用户。</li><li id="ae7f" class="lf lg hi jq b jr lq ju lr jx ls kb lt kf lu kj lm ln lo lp bi translated">保持用户登录会话。</li></ol><p id="9040" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这里的前3点相当直接，它们的意义不需要太多的解释。然而，为了理解我们为什么需要第四点，我需要你想一想当你在笔记本电脑上登录脸书的时候。它是如何工作的？你每次刷新页面或者转到脸书境内的其他页面时都会被注销吗？如果你在新标签页打开脸书，你需要重新登录吗？不。那是那个点将帮助我们做的。这将有助于浏览器记住我们是否登录，并使用它直到会话过期。</p><h1 id="3ee8" class="ly kl hi bd km lz ma mb kq mc md me ku io mf ip kx ir mg is la iu mh iv ld mi bi translated">代码</h1><p id="0989" class="pw-post-body-paragraph jo jp hi jq b jr lh ij jt ju li im jw jx mj jz ka kb mk kd ke kf ml kh ki kj hb bi translated">我们现在可以开始逐一解决以上几点。但在此之前，让我们添加第0个步骤。</p><p id="90da" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">0.设置项目，并建立一个数据库，用户数据将被存储。</p><p id="049f" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">当然，我们将需要一个数据库，在那里登录的细节被使用。让我们先这样做。</p><h2 id="2698" class="kk kl hi bd km kn ko kp kq kr ks kt ku jx kv kw kx kb ky kz la kf lb lc ld le bi translated">设置项目和数据库</h2><p id="f7db" class="pw-post-body-paragraph jo jp hi jq b jr lh ij jt ju li im jw jx mj jz ka kb mk kd ke kf ml kh ki kj hb bi translated">注意默认情况下，以下步骤适用于Mac和Linux系统。如果您希望在Windows上运行它，请使用<a class="ae jn" href="https://git-scm.com/downloads" rel="noopener ugc nofollow" target="_blank"> Gitbash </a>来代替默认的PowerShell。</p><p id="0f6d" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">对于项目设置，请遵循以下步骤:</p><ol class=""><li id="7232" class="lf lg hi jq b jr js ju jv jx lv kb lw kf lx kj lm ln lo lp bi translated">打开系统上的终端。</li><li id="506f" class="lf lg hi jq b jr lq ju lr jx ls kb lt kf lu kj lm ln lo lp bi translated">移动到您想要创建项目的目录。</li><li id="20e2" class="lf lg hi jq b jr lq ju lr jx ls kb lt kf lu kj lm ln lo lp bi translated">运行<code class="du mm mn mo mp b">mkdir authDemo; cd authDemo.</code>这将在这里创建一个名为‘auth demo’的目录，并将我们移至其中。</li><li id="fa3d" class="lf lg hi jq b jr lq ju lr jx ls kb lt kf lu kj lm ln lo lp bi translated">运行<code class="du mm mn mo mp b">npm init -y.</code>这将在目录中创建节点所需的强制性package.json文件。</li><li id="784d" class="lf lg hi jq b jr lq ju lr jx ls kb lt kf lu kj lm ln lo lp bi translated">跑<code class="du mm mn mo mp b">npm i -S mongoose express bcrypt express-session</code>。所有在-S后面的名字都是我们项目需要的包。我们正在安装它们。</li><li id="7e80" class="lf lg hi jq b jr lq ju lr jx ls kb lt kf lu kj lm ln lo lp bi translated">运行<code class="du mm mn mo mp b">touch app.js</code>。这将创建一个app.js文件，其中包含我们所有的代码。在你最喜欢的代码编辑器中打开这个文件。</li></ol><p id="f057" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在我们的项目已经立项了。我们可以开始建立数据库了。在app.js文件中，编写以下代码:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mq mr l"/></div></figure><p id="67f6" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">让我们明白我们做了什么:</p><ol class=""><li id="b1df" class="lf lg hi jq b jr js ju jv jx lv kb lw kf lx kj lm ln lo lp bi translated">Require语句:第1行和第2行简单地将我们需要的包包含到我们的文件中。</li><li id="ac49" class="lf lg hi jq b jr lq ju lr jx ls kb lt kf lu kj lm ln lo lp bi translated">mongoose.connect:这将我们连接到我们的数据库，该数据库目前命名为“myapp”。</li><li id="a370" class="lf lg hi jq b jr lq ju lr jx ls kb lt kf lu kj lm ln lo lp bi translated">Schema:在mongo中，我们需要定义一个结构来定义集合中的条目的外观。这是模式。在这里，对于一个用户，我们已经说过我们将有一个<code class="du mm mn mo mp b">username</code>，它将是一个字符串，和<code class="du mm mn mo mp b">hashedPw</code>，它将是一个字符串。这两个字段都是必需的，即不能为空。我们为什么使用hashedPw(散列密码)而不仅仅是密码，这将在本文的后面部分解释清楚。</li><li id="c287" class="lf lg hi jq b jr lq ju lr jx ls kb lt kf lu kj lm ln lo lp bi translated">模型:在MongoDB中，我们使用模型通过代码完成所有的工作。因此，我们在第15行创建模型，并将其存储在<code class="du mm mn mo mp b">User</code>中。</li><li id="e010" class="lf lg hi jq b jr lq ju lr jx ls kb lt kf lu kj lm ln lo lp bi translated">App.listen:这一行告诉我们的代码在终端上运行<code class="du mm mn mo mp b">node app.js</code>来运行节点文件时，在端口3000上运行服务器。因此，现在我们将能够访问我们在localhost:3000/上创建的路由</li></ol><p id="3cf6" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">好了，现在我们的数据库也建立好了。让我们进入第一步，即注册。</p><h2 id="0e8c" class="kk kl hi bd km kn ko kp kq kr ks kt ku jx kv kw kx kb ky kz la kf lb lc ld le bi translated">注册新用户</h2><p id="e176" class="pw-post-body-paragraph jo jp hi jq b jr lh ij jt ju li im jw jx mj jz ka kb mk kd ke kf ml kh ki kj hb bi translated">要添加注册路径，请将app.js文件更改为:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mq mr l"/></div></figure><p id="8140" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">让我们在这里检查一下修改过的行:</p><ol class=""><li id="a77d" class="lf lg hi jq b jr js ju jv jx lv kb lw kf lx kj lm ln lo lp bi translated">第3行:我们需要一个新模块bcrypt。这将是我们将使用的哈希算法。我们将讨论更多关于散列的内容，但是让我们先了解所有其他的要点。</li><li id="08d0" class="lf lg hi jq b jr lq ju lr jx ls kb lt kf lu kj lm ln lo lp bi translated">第22–30行:这是我们注册用户的POST路径。这里，我们对用户名和密码的值进行了硬编码，这些值通常可以从表单中获得。接下来，我们生成散列密码，这将在后面讨论。一旦我们有了这两样东西，我们就用这些细节创建一个用户，并把它添加到我们的数据库中。我们现在返回刚刚创建的用户，作为来自路由的响应。</li></ol><h2 id="5f61" class="kk kl hi bd km kn ko kp kq kr ks kt ku jx kv kw kx kb ky kz la kf lb lc ld le bi translated">散列法</h2><p id="0967" class="pw-post-body-paragraph jo jp hi jq b jr lh ij jt ju li im jw jx mj jz ka kb mk kd ke kf ml kh ki kj hb bi translated">好的，现在让我们来理解什么是哈希，以及我们为什么要这么做。如果我们试图在这里完全详细地理解散列，这将花费大量的时间，而且在我们非常有限的场景中是不相关的。因此，散列简而言之就是对你的密码进行加密。我们为什么需要它？当然是安全。我知道我提到过我们不会处理安全问题，但是散列已经成为auth本身的基础之一，因此忽略它不是一个明智的决定。</p><p id="b53c" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">回到它是什么，散列只是一些文本的单向加密。那是什么意思？这意味着它将我们给它的一组字符转换成一个很长的随机字符串，这有两个你需要知道的主要特征:</p><ol class=""><li id="be09" class="lf lg hi jq b jr js ju jv jx lv kb lw kf lx kj lm ln lo lp bi translated">相同的字符串总是被转换成相同的随机字符串。</li><li id="a4e0" class="lf lg hi jq b jr lq ju lr jx ls kb lt kf lu kj lm ln lo lp bi translated">原始字符串不能从哈希后的字符串重新跟踪。</li></ol><p id="c998" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">以散列形式存储密码是常见的做法，绝对没有一家好公司会将密码存储为纯文本。如果你想了解更多关于哈希的知识，你可以点击查看<a class="ae jn" href="https://auth0.com/blog/hashing-in-action-understanding-bcrypt/" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="6518" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">也就是说，现在我们可以安全地进入下一步，即登录。</p><h2 id="4e54" class="kk kl hi bd km kn ko kp kq kr ks kt ku jx kv kw kx kb ky kz la kf lb lc ld le bi translated">让用户登录</h2><p id="336c" class="pw-post-body-paragraph jo jp hi jq b jr lh ij jt ju li im jw jx mj jz ka kb mk kd ke kf ml kh ki kj hb bi translated">要添加登录路由，请将您的文件更改为:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mq mr l"/></div></figure><p id="2f99" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">如果您看到这里，只添加了第33–46行。最初，我们采用用户名和密码的硬编码值，这与我们在注册路由中采用的值相同。然后，我们从我们的数据库中找到一个具有该用户名的用户，并将其存储在<code class="du mm mn mo mp b">user. </code>中。接下来，我们将给定用户的密码与我们收到的密码进行比较。请记住，我们存储的密码是哈希版本，因此我们不能直接比较这两个字符串的值。我们将使用<code class="du mm mn mo mp b">bcrypt.compare()</code>，它是库中用于比较的内置函数。</p><blockquote class="ms mt mu"><p id="d0c7" class="jo jp mv jq b jr js ij jt ju jv im jw mw jy jz ka mx kc kd ke my kg kh ki kj hb bi translated">注意:不要试图手动散列你收到的密码，然后比较字符串，这是行不通的。要理解为什么，请阅读上面链接中的盐的概念。</p></blockquote><p id="2b7f" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">接下来，我们在<code class="du mm mn mo mp b">matchstatus</code>变量中接收true或false，这告诉我们密码是否正确。我们根据它做我们的行动。</p><blockquote class="ms mt mu"><p id="0457" class="jo jp mv jq b jr js ij jt ju jv im jw mw jy jz ka mx kc kd ke my kg kh ki kj hb bi translated">注意:目前，我们只是在做console.log或res.send。这实际上并不是让我们登录。这只是检查细节对错的代码。当我们讨论会话时，实际的日志部分实际上发生在下面。发生这种情况时，我们将更新此路线。</p></blockquote><p id="1511" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在我们已经完成了登录路径，让我们转到会话。请注意，我们在登出之前讨论会话，因为没有它登出将没有任何意义。</p><h2 id="0c00" class="kk kl hi bd km kn ko kp kq kr ks kt ku jx kv kw kx kb ky kz la kf lb lc ld le bi translated">向站点添加会话</h2><p id="f5e2" class="pw-post-body-paragraph jo jp hi jq b jr lh ij jt ju li im jw jx mj jz ka kb mk kd ke kf ml kh ki kj hb bi translated">首先，可能有许多人不知道什么是会议，以及我们需要他们做什么。会话基本上就是这个词所暗示的。当您离开一个长时间登录而不使用它的网站时，您可能已经多次看到类似“会话到期”的短语。这就是我们正在进行的课程。</p><p id="035d" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">作为一种基本的理解，你可以把它理解为浏览器保存我们浏览的记忆。一般来说，HTTP请求没有内存。因此，即使您正确登录，也无法让网站的其他人知道您已经成功登录。这是会话在auth中出现的地方。由于会话内存是由浏览器存储的，所以无论我们将访问站点内的哪个URL，会话内的数据都将始终存在。</p><p id="2f41" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">因此，我们让某人登录的方法可能是这样的:我们在会话中创建一个名为<code class="du mm mn mo mp b">user </code>的变量(当然，您可以有任何变量名)。当用户输入正确的详细信息进行身份验证时，我们可以将会话中的<code class="du mm mn mo mp b">user</code>变量设置为用户详细信息。如果未登录，它将保持为空。因此，在任何时候，如果我们需要检查用户是否登录，我们只需要检查这个变量是否为空或是否有有效值。</p><p id="feef" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在让我们看看代码:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mq mr l"/></div></figure><p id="91bb" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">虽然解释让它看起来像是我们在做非常非常复杂的事情，但实际上它很容易编码。让我们看看上面代码的补充内容:</p><ol class=""><li id="aef1" class="lf lg hi jq b jr js ju jv jx lv kb lw kf lx kj lm ln lo lp bi translated">第4-10行:我们需要并配置express-session，这是我们用来创建和维护会话的库。这些行将在浏览器中配置会话，并使我们非常容易访问它，正如我们现在将看到的。</li><li id="0c93" class="lf lg hi jq b jr lq ju lr jx ls kb lt kf lu kj lm ln lo lp bi translated">第47行:<code class="du mm mn mo mp b">req.session.user = user;</code>:如上所述，我们在会话中设置了一个名为<code class="du mm mn mo mp b">user</code>的变量(我们通过<code class="du mm mn mo mp b">req.session)</code>对刚刚登录的用户进行访问)。</li></ol><p id="3243" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这成功地让我们登录，我们现在可以在以后访问登录用户的详细信息，无论我们在哪个页面上。</p><p id="4940" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在让我们看看最后也是最简单的路线，注销路线。</p><h2 id="5f33" class="kk kl hi bd km kn ko kp kq kr ks kt ku jx kv kw kx kb ky kz la kf lb lc ld le bi translated">将用户注销</h2><p id="d36d" class="pw-post-body-paragraph jo jp hi jq b jr lh ij jt ju li im jw jx mj jz ka kb mk kd ke kf ml kh ki kj hb bi translated">如上所述，要注销用户，我们可以将req.session.user设置为null。同样的代码如下:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mq mr l"/></div></figure><p id="57b5" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这里，我们刚刚在第55-58行添加了注销路线。我们将<code class="du mm mn mo mp b">req.session.user</code>设置为空，然后返回响应。</p><h2 id="3013" class="kk kl hi bd km kn ko kp kq kr ks kt ku jx kv kw kx kb ky kz la kf lb lc ld le bi translated">包扎</h2><p id="e8de" class="pw-post-body-paragraph jo jp hi jq b jr lh ij jt ju li im jw jx mj jz ka kb mk kd ke kf ml kh ki kj hb bi translated">好了，这就完成了基本认证的所有代码。现在，您可以(希望)轻松地从头开始实现注册、登录和注销功能。就像我前面提到的，这个设计本来可以有很多改进，主要是在安全性方面。请注意，这个系统在攻击面前一点也不安全，这当然是不可取的。然而，这完全是另外一个话题，改天再说。目前，这是我所能提供的一切。感谢您抽出时间阅读这篇文章，希望对您有所帮助。干杯！</p></div></div>    
</body>
</html>