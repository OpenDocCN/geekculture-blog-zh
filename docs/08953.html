<html>
<head>
<title>Defense by Design: Building Systems that Automatically React to External Attacks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">设计防御:构建自动应对外部攻击的系统</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/defense-by-design-building-systems-that-automatically-react-to-external-attacks-f981a02e0ccc?source=collection_archive---------26-----------------------#2021-11-20">https://medium.com/geekculture/defense-by-design-building-systems-that-automatically-react-to-external-attacks-f981a02e0ccc?source=collection_archive---------26-----------------------#2021-11-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/f3e3821ad50001a5f046a5aedf6fef6d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zUfhzkWpW59naZA4xzFCHg.jpeg"/></div></div></figure><h1 id="a6f3" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">互联网是一个充满敌意的地方</h1><p id="69cb" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">Web应用程序安全性是一个大话题，也是系统管理员的一个持续挑战，当您设置任何服务器并将其连接到互联网时，该服务器就会成为黑客、机器人和恶意用户请求的乐园。</p><h1 id="a5cd" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">监控与自动防御</h1><p id="7cf6" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">监控服务器是一项艰巨的任务，如果我们建立一个自动防御系统，对不同的攻击和威胁自动做出反应，而不是查看不同服务的日志并对不同的攻击做出反应，这不是更好吗？</p><p id="a095" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">在本文中，我将解释如何使用一些现有的工具来构建一个设计安全的系统。因此，大多数攻击都会被系统自动拒绝。</p><h1 id="2740" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">开始之前</h1><p id="20ef" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">首先，确保在首次设置服务器时遵循标准的安全建议和最佳实践，这包括禁用root访问和ssh密码登录，启用基本防火墙规则来阻止不必要的端口和服务等..</p><p id="bd34" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">下面是一个很好的入门参考:</p><div class="kr ks ez fb kt ku"><a href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-20-04" rel="noopener  ugc nofollow" target="_blank"><div class="kv ab dw"><div class="kw ab kx cl cj ky"><h2 class="bd hj fi z dy kz ea eb la ed ef hh bi translated">使用Ubuntu 20.04的初始服务器设置|数字海洋</h2><div class="lb l"><h3 class="bd b fi z dy kz ea eb la ed ef dx translated">当你第一次创建一个新的Ubuntu 20.04服务器时，你应该执行一些重要的配置步骤作为…</h3></div><div class="lc l"><p class="bd b fp z dy kz ea eb la ed ef dx translated">www.digitalocean.com</p></div></div><div class="ld l"><div class="le l lf lg lh ld li io ku"/></div></div></a></div><h1 id="ef01" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">使用Fail2ban进行自动防御</h1><p id="41d8" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated"><a class="ae lj" href="https://github.com/fail2ban/fail2ban" rel="noopener ugc nofollow" target="_blank"> <strong class="jq hj"> Fail2ban </strong> </a>是一个优秀的开源<strong class="jq hj">入侵检测</strong>/防御系统(IDS/IPS)，我们将依靠这个伟大的工具来构建我们的防御。</p><p id="50dc" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">您可以通过以下命令在Ubuntu上轻松安装这个库</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="ce1b" class="lt ir hi lp b fi lu lv l lw lx">$ sudo apt install fail2ban</span></pre><p id="6036" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated"><strong class="jq hj">fail 2 ban如何工作</strong></p><p id="7de9" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">fail2ban背后的基本思想是监视公共服务的日志以发现特定的模式(这是通过Fail2ban <strong class="jq hj">过滤器</strong>完成的)。</p><p id="ab2b" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">当发现特定模式时，可以执行特定的触发器(这是通过Fail2ban <strong class="jq hj">操作</strong>完成的)，默认操作是通过修改<code class="du ly lz ma lp b">iptables</code>防火墙规则来禁止违规主机/IP地址，如果您使用CloudFlare CDN来进一步优化和保护您的web应用程序，则可以使用自定义操作来禁止CloudFlare网络本身上的违规IP。</p><p id="85a4" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated"><code class="du ly lz ma lp b">jail.conf</code>是包含许多服务的jail配置的主配置文件。这个文件可以在更新中被覆盖，所以鼓励用户将这个文件复制到一个<code class="du ly lz ma lp b">jail.local</code>文件中，并在那里进行调整。</p><h1 id="fa7b" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">拦截99%的恶意机器人和暴力攻击</h1><p id="d867" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">感谢我们上面讨论的强大功能，阻止恶意请求从未如此简单。</p><p id="422a" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">下面我列出了一些示例过滤器，您可以使用它们来阻止常见类型的攻击。</p><p id="9be1" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated"><strong class="jq hj"> Nginx Bot搜索过滤器<br/> </strong>此过滤器随Fail2ban一起提供，将检测已知Bot使用的常见模式，您可以在<code class="du ly lz ma lp b">filters.d</code>目录中找到此过滤器。</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="818d" class="lt ir hi lp b fi lu lv l lw lx"># Fail2Ban filter to match web requests for selected URLs that don't exist</span><span id="5247" class="lt ir hi lp b fi mb lv l lw lx">#</span><span id="e407" class="lt ir hi lp b fi mb lv l lw lx">[INCLUDES]</span><span id="850f" class="lt ir hi lp b fi mb lv l lw lx"># Load regexes for filtering</span><span id="11db" class="lt ir hi lp b fi mb lv l lw lx">before = botsearch-common.conf</span><span id="e310" class="lt ir hi lp b fi mb lv l lw lx">[Definition]</span><span id="d439" class="lt ir hi lp b fi mb lv l lw lx">failregex = ^&lt;HOST&gt; \- \S+ \[\] \"(GET|POST|HEAD) \/&lt;block&gt; \S+\" 404 .+$</span><span id="360c" class="lt ir hi lp b fi mb lv l lw lx">^ \[error\] \d+#\d+: \*\d+ (\S+ )?\"\S+\" (failed|is not found) \(2\: No such file or directory\), client\: &lt;HOST&gt;\, server\: \S*\, request: \"(GET|POST|HEAD) \/&lt;block&gt; \S+\"\, .*?$</span><span id="bcb2" class="lt ir hi lp b fi mb lv l lw lx">ignoreregex =</span><span id="1a17" class="lt ir hi lp b fi mb lv l lw lx">datepattern = {^LN-BEG}%%ExY(?P&lt;_sep&gt;[-/.])%%m(?P=_sep)%%d[T ]%%H:%%M:%%S(?:[.,]%%f)?(?:\s*%%z)?</span><span id="b8e1" class="lt ir hi lp b fi mb lv l lw lx">^[^\[]*\[({DATE})</span><span id="4bf2" class="lt ir hi lp b fi mb lv l lw lx">{^LN-BEG}</span></pre><p id="bb31" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated"><strong class="jq hj"> Nginx字节攻击</strong></p><p id="7e9e" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">在filters.d目录中添加一个名为nginx-x00.conf的文件，结合nginx access.log使用该文件来检测字节攻击。</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="3782" class="lt ir hi lp b fi lu lv l lw lx">[Definition]<br/>failregex = ^&lt;HOST&gt; .* ".*\\x.*" .*$</span></pre><p id="9e61" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated"><strong class="jq hj"> Nginx 4xx扫描检测</strong></p><p id="7021" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">几乎所有扫描/暴力工具都会尝试攻击应用程序的随机端点来查找漏洞，该过滤器将帮助您对特定的4xx失败尝试序列做出反应，并相应地触发禁止操作。</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="559e" class="lt ir hi lp b fi lu lv l lw lx">[Definition]</span><span id="e9d5" class="lt ir hi lp b fi mb lv l lw lx">failregex = ^&lt;HOST&gt;.*"(GET|POST).*" (404|444|403|400) .*$</span><span id="9eac" class="lt ir hi lp b fi mb lv l lw lx">ignoreregex =</span></pre><p id="0d69" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated"><strong class="jq hj">检测直接访问脚本文件的企图</strong></p><p id="fc1b" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">如今，大多数web框架都避免使用直接请求脚本文件的URL。php/。py/。js等..)，因此，通过以下过滤器检测利用脚本文件的企图将非常方便:</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="8422" class="lt ir hi lp b fi lu lv l lw lx">[Definition]</span><span id="0942" class="lt ir hi lp b fi mb lv l lw lx">failregex = ^&lt;HOST&gt; -.*GET.*(\.php|\.py|\.asp|\.exe|\.pl|\.cgi|\scgi)</span><span id="ec2a" class="lt ir hi lp b fi mb lv l lw lx">ignoreregex =</span></pre><p id="46b5" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated"><strong class="jq hj">检测并阻止您自己的自定义URL模式</strong></p><p id="a57d" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">如果您了解自己的堆栈，那么阻止任何试图访问堆栈中不存在的特定URL模式的客户端会很有用。例如，Django/Ruby应用程序可以安全地阻止试图访问普通PHP/WordPress URL的客户端，你也可以阻止那些试图访问敏感配置/点文件的客户端。下面是一个过滤器示例:</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="3ed2" class="lt ir hi lp b fi lu lv l lw lx">[Definition]</span><span id="7f3c" class="lt ir hi lp b fi mb lv l lw lx">failregex = ^&lt;HOST&gt; -.*GET.*(phpmyadmin|wp-login|\.env*|\.git*)</span><span id="27b2" class="lt ir hi lp b fi mb lv l lw lx">ignoreregex =</span></pre><p id="6dc2" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated"><strong class="jq hj">检测并阻止DDOS攻击</strong></p><p id="e22e" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">除了搜索特定的模式，我们还可以将below过滤器与Nginx速率限制模块结合使用，以确定大量的请求并触发自动阻塞。</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="cd98" class="lt ir hi lp b fi lu lv l lw lx"># Fail2Ban configuration file<br/>#<br/># supports: ngx_http_limit_req_module module<br/><br/>[Definition]<br/><br/>failregex = limiting requests, excess:.* by zone.*client: &lt;HOST&gt;<br/><br/># Option: ignoreregex<br/># Notes.: regex to ignore. If this regex matches, the line is ignored.<br/># Values: TEXT<br/>#<br/>ignoreregex =</span></pre><h1 id="08cd" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">结论</h1><p id="b5b2" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">正如我们在上面的例子中看到的，Fail2ban是一个强大的框架，可以用来构建一个非常强大的自动防御触发器，可以定制配置以适应您希望保护的任何服务。</p></div></div>    
</body>
</html>