<html>
<head>
<title>Download an Object From a Google Cloud Storage Bucket in NodeJS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从NodeJS中的Google云存储桶下载一个对象</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/download-an-object-from-a-google-cloud-storage-bucket-in-nodejs-a69a293578ae?source=collection_archive---------1-----------------------#2021-03-03">https://medium.com/geekculture/download-an-object-from-a-google-cloud-storage-bucket-in-nodejs-a69a293578ae?source=collection_archive---------1-----------------------#2021-03-03</a></blockquote><div><div class="es gl gm gn go gp"/><div class="gq gr gs gt gu"><div class=""/><figure class="ec ee hv hw hx hy dy dz paragraph-image"><div role="button" tabindex="0" class="hz ia di ib bf ic"><div class="dy dz hu"><img src="../Images/d6ef78ccc586611fb3bdf5a0b5f2cc2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XicqLm7hdkCtPoeD"/></div></div><figcaption class="if ig ea dy dz ih ii bd b be z ft">Photo by <a class="ae ij" href="https://unsplash.com/@eklect?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Tony Mucci</a> on <a class="ae ij" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h2 id="6091" class="ik il gx bd im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh bi translated">概述</h2><p id="7d40" class="pw-post-body-paragraph ji jj gx jk b jl jm jn jo jp jq jr js iv jt ju jv iz jw jx jy jd jz ka kb kc gq bi translated"><strong class="jk gy"> <em class="kd">谷歌云平台</em> </strong> ( <em class="kd"> GCP </em>)是来自母体<em class="kd">谷歌</em>的云计算服务套件，是<em class="kd">亚马逊Web服务</em> ( <em class="kd"> AWS </em>)和<em class="kd">微软Azure </em>的劲敌。</p><p id="44d1" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated">我和GCP玩了一会儿，因为我正在做一个有趣的金融科技项目，而公司需要可伸缩性。)在一个类似谷歌的环境中。</p><p id="6d48" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated">谷歌云平台配有简单的用户界面和合理的价格。</p><p id="61f2" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated">但是<strong class="jk gy"> <em class="kd"> GCP </em>的文档有2个问题</strong>:</p><ul class=""><li id="356f" class="kj kk gx jk b jl ke jp kf iv kl iz km jd kn kc ko kp kq kr bi translated">有时令人困惑；</li><li id="a8df" class="kj kk gx jk b jl ks jp kt iv ku iz kv jd kw kc ko kp kq kr bi translated">它在<em class="kd">谷歌</em>上没有被很好地索引(是的，你理解正确——搜索引擎的<em class="kd">之王</em>没有正确地索引它自己的文档)。</li></ul><p id="624f" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated">我不得不从一个<em class="kd">谷歌云存储</em><em class="kd">GCP</em>的存储服务】<strong class="jk gy">桶</strong>中<strong class="jk gy">下载<em class="kd"> NodeJS </em>中的一些对象，所以我面临一些<em class="kd">摩擦</em>，我想用这个小指南来帮助你(也帮助我，以后阅读这篇文章)。</strong></p><h2 id="1827" class="ik il gx bd im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh bi translated">谷歌云存储客户端库</h2><p id="834f" class="pw-post-body-paragraph ji jj gx jk b jl jm jn jo jp jq jr js iv jt ju jv iz jw jx jy jd jz ka kb kc gq bi translated">为了从<em class="kd">谷歌云存储</em>桶中下载一个对象，你需要有<em class="kd">谷歌云存储</em>库。</p><p id="fe1d" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated">如果还没有完成，你需要安装<em class="kd">谷歌云存储客户端库</em>和<em class="kd"> npm </em>包管理器:</p><p id="2b5b" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated"><code class="eu kx ky kz la b">npm install @google-cloud/storage</code></p><h2 id="fd6b" class="ik il gx bd im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh bi translated">证明</h2><p id="cf39" class="pw-post-body-paragraph ji jj gx jk b jl jm jn jo jp jq jr js iv jt ju jv iz jw jx jy jd jz ka kb kc gq bi translated"><strong class="jk gy">客户端认证基于一个<em class="kd">服务账户密钥</em> </strong>，基本上是一个<em class="kd"> JSON </em>密钥。<br/>如果你没有任何键，你可以通过<a class="ae ij" href="https://console.cloud.google.com/apis/credentials/serviceaccountkey" rel="noopener ugc nofollow" target="_blank">链接</a>创建一个。<br/>关于密匙生成的更多细节，请参见<em class="kd">谷歌文档</em>T69】此处。</p><p id="83d3" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated">一旦您下载了包含<em class="kd">服务账户密钥</em>的<em class="kd"> JSON </em>文件，建议将其重命名(例如<em class="kd">my-Service-Account-Key . JSON</em>)并将其移动到适当的文件夹(一个以后不太可能被重命名或删除的文件夹)。</p><p id="057a" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated"><strong class="jk gy">设置环境变量</strong></p><p id="db62" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated">下载的<em class="kd">服务账户密钥</em>必须设置为环境变量。</p><p id="0450" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated"><strong class="jk gy"> &gt; Linux/MacOS </strong></p><pre class="lb lc ld le ek lf la lg lh aw li bi"><span id="f6cb" class="ik il gx la b ev lj lk l ll lm">export GOOGLE_APPLICATION_CREDENTIALS="/path/to/my-service-account-key.json"</span></pre><p id="82bd" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated"><strong class="jk gy"> &gt;视窗</strong></p><p id="0438" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated">记住<em class="kd">Windows</em><em class="kd">Powershell</em>和<em class="kd">命令提示符</em>使用反斜杠<code class="eu kx ky kz la b">\</code>来描述路径。</p><p id="d4a0" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated">&gt; &gt;【选项A】<em class="kd">Windows Powershell</em></p><pre class="lb lc ld le ek lf la lg lh aw li bi"><span id="bfd7" class="ik il gx la b ev lj lk l ll lm">$env:GOOGLE_APPLICATION_CREDENTIALS="C:\path\to\my-service-account-key.json"</span></pre><p id="2687" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated">&gt; &gt;【选项B】<em class="kd">Windows命令提示符</em></p><pre class="lb lc ld le ek lf la lg lh aw li bi"><span id="e98e" class="ik il gx la b ev lj lk l ll lm">set GOOGLE_APPLICATION_CREDENTIALS=C:\path\to\my-service-account-key.json</span></pre><p id="07c7" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated">&gt; &gt;【选项C】<em class="kd">Windows Linux子系统</em> ( <em class="kd"> WSL </em>)</p><p id="f97d" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated">如果您使用<em class="kd"> WSL </em>，也请在<em class="kd"> Linux </em>中配置环境变量，否则您将无法通过<em class="kd"> Linux CLI </em>运行代码(只有使用<em class="kd"> Windows命令提示符</em>才能运行)。</p><p id="80ab" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated">建议将<em class="kd">服务账号密钥</em>复制到Linux文件夹<code class="eu kx ky kz la b">/etc/profile.d/</code>中。</p><p id="3d79" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated">然后执行以下命令添加环境变量:</p><p id="7fed" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated"><code class="eu kx ky kz la b">export GOOGLE_APPLICATION_CREDENTIALS="/path/to/my-service-account-key.json"</code></p><h2 id="8cd5" class="ik il gx bd im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh bi translated">从GCS下载一个对象，这是一个工作示例</h2><p id="1889" class="pw-post-body-paragraph ji jj gx jk b jl jm jn jo jp jq jr js iv jt ju jv iz jw jx jy jd jz ka kb kc gq bi translated">使用下面的代码从<em class="kd"> Google云存储桶</em>中下载一个对象，用正确的值更改引用<code class="eu kx ky kz la b">bucketName</code>、<code class="eu kx ky kz la b">srcFilename</code>和<code class="eu kx ky kz la b">destFilename</code>。</p><figure class="lb lc ld le ek hy"><div class="bz ln l di"><div class="lo lp l"/></div></figure><p id="4070" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated"><strong class="jk gy">注1:对象名称</strong></p><p id="93bc" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated">请注意<strong class="jk gy"> <em class="kd">谷歌云存储</em>通过一个也包含路径</strong>的名称来标识一个<em class="kd">对象</em>。<br/>所以，<code class="eu kx ky kz la b">srcFilename</code>永远不应该以斜杠<code class="eu kx ky kz la b">/</code>开头，因为<em class="kd"> Google云存储客户端库</em>会自动将<code class="eu kx ky kz la b">srcFilename</code>转换成对象名。</p><p id="589b" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated">例如，下面的<code class="eu kx ky kz la b">srcFilename</code></p><p id="892f" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated"><code class="eu kx ky kz la b">const srcFilename = 'path/to/object/to/download/file.format';</code></p><p id="c6e7" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated">会被<em class="kd">谷歌云存储</em>这样解读</p><p id="3446" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated"><code class="eu kx ky kz la b"><a class="ae ij" href="https://storage.googleapis.com/storage/v1/b/bucket-name/o/path/to/object/to/download/file.format" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/storage/v1/b/bucket-name/o/path/to/object/to/download/file.format</a></code></p><p id="6a7a" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated">其中<code class="eu kx ky kz la b">b</code>标识<em class="kd">桶</em>名称，<code class="eu kx ky kz la b">o</code>标识对象名称。</p><p id="d86e" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated">但是如果在<code class="eu kx ky kz la b">srcFilename</code>前面有斜线<code class="eu kx ky kz la b">/</code></p><p id="b4ed" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated"><code class="eu kx ky kz la b">const srcFilename = '/path/to/object/to/download/file.format';</code></p><p id="1c79" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated">那么该名称将被转换成</p><p id="7ec0" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated"><code class="eu kx ky kz la b"><a class="ae ij" href="https://storage.googleapis.com/storage/v1/b/bucket-name/o//path/to/object/to/download/file.format" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/storage/v1/b/bucket-name/o//path/to/object/to/download/file.format</a></code></p><p id="ad9f" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated">导致一个错误</p><p id="1150" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated"><code class="eu kx ky kz la b">404 Error: No such object: bucket-name//path/to/object/to/download/file.format</code></p><p id="2b86" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated"><strong class="jk gy">注2:目的文件夹</strong></p><p id="c500" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated">如果你想把下载的<em class="kd">对象</em>放到一个特定的文件夹，记得在把值传递给<code class="eu kx ky kz la b">destFilename</code>之前<strong class="jk gy">创建目录。</strong></p><p id="3e97" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated"><strong class="jk gy">运行代码！</strong></p><p id="adad" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated">使用默认的<code class="eu kx ky kz la b">node</code>命令测试代码:</p><p id="ca80" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated"><code class="eu kx ky kz la b">node example-code.js</code></p></div><div class="ab cl lq lr ge ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="gq gr gs gt gu"><p id="16c3" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated">🙏感谢您的阅读！</p><p id="cd69" class="pw-post-body-paragraph ji jj gx jk b jl ke jn jo jp kf jr js iv kg ju jv iz kh jx jy jd ki ka kb kc gq bi translated">🔎你可以在<a class="ae ij" href="https://twitter.com/RapacciniM" rel="noopener ugc nofollow" target="_blank"><em class="kd">Twitter</em></a><em class="kd"/>和<a class="ae ij" href="https://www.linkedin.com/in/marco-rapaccini/?locale=en_US" rel="noopener ugc nofollow" target="_blank"> <em class="kd"> LinkedIn </em> </a>上找到我。</p></div></div>    
</body>
</html>