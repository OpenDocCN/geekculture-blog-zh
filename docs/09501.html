<html>
<head>
<title>How I built an E-commerce API with NodeJs, Express and MongoDB(Part 4)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我如何用NodeJs、Express和MongoDB构建电子商务API(第4部分)</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/how-i-built-an-e-commerce-api-with-nodejs-express-and-mongodb-part-4-318e3f494611?source=collection_archive---------1-----------------------#2021-12-14">https://medium.com/geekculture/how-i-built-an-e-commerce-api-with-nodejs-express-and-mongodb-part-4-318e3f494611?source=collection_archive---------1-----------------------#2021-12-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/3ccf40509849290ebc6614eeb62ff827.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kMMtO2szrWyPTQBZP4ns8w.jpeg"/></div></div></figure></div><div class="ab cl iq ir gp is" role="separator"><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv"/></div><div class="hb hc hd he hf"><p id="83eb" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">本文已经过更新，支持结帐功能。享受</p></div><div class="ab cl iq ir gp is" role="separator"><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv"/></div><div class="hb hc hd he hf"><p id="a97b" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">这是本系列的第四部分。如果你没有读过前面的，你可以使用下面的链接回去阅读。</p><div class="jv jw ez fb jx jy"><a rel="noopener follow" target="_blank" href="/geekculture/how-i-built-an-e-commerce-api-with-nodejs-express-and-mongodb-7b42b5253ffb"><div class="jz ab dw"><div class="ka ab kb cl cj kc"><h2 class="bd hj fi z dy kd ea eb ke ed ef hh bi translated">我如何用NodeJs、Express和MongoDB构建电子商务API</h2><div class="kf l"><h3 class="bd b fi z dy kd ea eb ke ed ef dx translated">第1部分:设置项目</h3></div><div class="kg l"><p class="bd b fp z dy kd ea eb ke ed ef dx translated">medium.com</p></div></div><div class="kh l"><div class="ki l kj kk kl kh km io jy"/></div></div></a></div><div class="jv jw ez fb jx jy"><a rel="noopener follow" target="_blank" href="/geekculture/how-i-built-an-e-commerce-api-with-nodejs-express-and-mongodb-part-2-c729b1e74336"><div class="jz ab dw"><div class="ka ab kb cl cj kc"><h2 class="bd hj fi z dy kd ea eb ke ed ef hh bi translated">我如何用NodeJs、Express和MongoDB构建电子商务API(第2部分)</h2><div class="kf l"><h3 class="bd b fi z dy kd ea eb ke ed ef dx translated">第2部分:构建模型</h3></div><div class="kg l"><p class="bd b fp z dy kd ea eb ke ed ef dx translated">medium.com</p></div></div><div class="kh l"><div class="ki l kj kk kl kh km io jy"/></div></div></a></div><div class="jv jw ez fb jx jy"><a rel="noopener follow" target="_blank" href="/geekculture/how-i-built-an-e-commerce-api-with-nodejs-express-and-mongodb-part-3-60150d354587"><div class="jz ab dw"><div class="ka ab kb cl cj kc"><h2 class="bd hj fi z dy kd ea eb ke ed ef hh bi translated">我如何用NodeJs、Express和MongoDB构建电子商务API(第3部分)</h2><div class="kf l"><h3 class="bd b fi z dy kd ea eb ke ed ef dx translated">第3部分:构建身份验证和路由</h3></div><div class="kg l"><p class="bd b fp z dy kd ea eb ke ed ef dx translated">medium.com</p></div></div><div class="kh l"><div class="ki l kj kk kl kh km io jy"/></div></div></a></div><p id="91f2" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">我们继续用推车路线来构建我们的路线</p><p id="72e7" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">3.<strong class="iz hj">推车路线</strong></p><p id="ac95" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">在我们的购物车路由文件中，我们将有三个端点来处理所有与购物车相关的请求，它们是:<strong class="iz hj">获取购物车、</strong>创建购物车和<strong class="iz hj">删除购物车中的商品。</strong></p><p id="c5f5" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">我们首先需要我们需要的所有模块，并实例化我们的路由器</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="2143" class="kw kx hi ks b fi ky kz l la lb">const express = require("express");<br/>const Cart = require("../models/cart");<br/>const Item = require("../models/item");<br/>const Auth = require("../middleware/auth");</span><span id="6f1c" class="kw kx hi ks b fi lc kz l la lb">const router = new express.Router();</span></pre><p id="1615" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">3.1 <strong class="iz hj">取车</strong></p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="a69a" class="kw kx hi ks b fi ky kz l la lb">router.get("/cart", Auth, async (<em class="ld">req</em>, <em class="ld">res</em>) =&gt; {</span><span id="de0e" class="kw kx hi ks b fi lc kz l la lb">const owner = req.user._id;</span><span id="225d" class="kw kx hi ks b fi lc kz l la lb">try {<br/>    const cart = await Cart.findOne({ owner });<br/>if (cart &amp;&amp; cart.items.length &gt; 0) {<br/>     res.status(200).send(cart);<br/>} else {<br/>      res.send(null);<br/>}<br/>} catch (error) {<br/>    res.status(500).send();<br/>}<br/>});</span></pre><p id="ac03" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">首先，我们在请求中从用户对象获取owner字段，然后使用它来查找该用户的购物车。如果购物车存在并且里面有一个商品，我们发送回购物车，否则我们发送回null，如果遇到任何错误，它触发catch块。</p><p id="a484" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">3.2 <strong class="iz hj">创建购物车</strong></p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="978b" class="kw kx hi ks b fi ky kz l la lb">router.post("/cart", Auth, async (<em class="ld">req</em>, <em class="ld">res</em>) =&gt; {<br/>const owner = req.user._id;</span><span id="ae4f" class="kw kx hi ks b fi lc kz l la lb">const { itemId, quantity } = req.body;</span><span id="6366" class="kw kx hi ks b fi lc kz l la lb">try {<br/>    const cart = await Cart.findOne({ owner });<br/>    const item = await Item.findOne({ _id: itemId });<br/>if (!item) {<br/>    res.status(404).send({ message: "item not found" });<br/>    return;<br/>}<br/>    const price = item.price;<br/>    const name = item.name;</span><span id="866f" class="kw kx hi ks b fi lc kz l la lb"><em class="ld">//If cart already exists for user,</em></span><span id="66e1" class="kw kx hi ks b fi lc kz l la lb">if (cart) {<br/>    const itemIndex = cart.items.findIndex((<em class="ld">item</em>) =&gt; item.itemId ==  itemId);</span><span id="d316" class="kw kx hi ks b fi lc kz l la lb"><em class="ld">//check if product exists or not</em></span><span id="e303" class="kw kx hi ks b fi lc kz l la lb">if (itemIndex &gt; -1) {<br/>    let product = cart.items[itemIndex];<br/>    product.quantity += quantity;<br/>    cart.bill = cart.items.reduce((<em class="ld">acc</em>, <em class="ld">curr</em>) =&gt; {<br/>       return acc + curr.quantity * curr.price;<br/>   },0)<br/>cart.items[itemIndex] = product;<br/>   await cart.save();<br/>   res.status(200).send(cart);<br/>} else {<br/>   cart.items.push({ itemId, name, quantity, price });<br/>   cart.bill = cart.items.reduce((<em class="ld">acc</em>, <em class="ld">curr</em>) =&gt; {<br/>   return acc + curr.quantity * curr.price;<br/>},0)<br/>   await cart.save();<br/>   res.status(200).send(cart);<br/>}<br/>} else {</span><span id="38c3" class="kw kx hi ks b fi lc kz l la lb"><em class="ld">//no cart exists, create one</em></span><span id="4b34" class="kw kx hi ks b fi lc kz l la lb">const newCart = await Cart.create({<br/>   owner,<br/>   items: [{ itemId, name, quantity, price }],<br/>    bill: quantity * price,<br/>});<br/>return res.status(201).send(newCart);<br/>}<br/>} catch (error) {<br/>   console.log(error);<br/>   res.status(500).send("something went wrong");<br/>}<br/>});</span></pre><p id="d1ad" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">首先，我们从用户对象获取所有者，并析构请求体以获取<strong class="iz hj"> itemId </strong>和<strong class="iz hj">数量。</strong></p><p id="6139" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">接下来，我们使用owner字段查找购物车，使用itemid查找商品。<br/>如果项目不存在，我们将终止流程并返回一个错误。如果是，我们从item对象中获取价格<strong class="iz hj">和名称<strong class="iz hj">的信息。</strong></strong></p><p id="c1a1" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">如果用户的购物车已经存在，我们将尝试获取购物车中商品的索引，如果索引大于-1(即商品已经在购物车中)，我们将获取商品，并按照请求正文中指定的数量增加其数量，然后保存购物车。如果在购物车中找不到产品，我们将它推入数组，同时提供所有必需的字段；<strong class="iz hj"> itemid，名称，数量，价格。然后，我们在数组上使用reduce方法计算新的账单。</strong></p><p id="6a7c" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">这使我们回到第一个if语句，现在，如果用户没有购物车，我们创建一个新的，计算账单，保存购物车并将其作为响应发送回来。</p><p id="8546" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">3.3 <strong class="iz hj">删除购物车中的商品。</strong></p><p id="8610" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">用户可能会选择删除购物车中的商品。我们可以提供如下功能</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="5c63" class="kw kx hi ks b fi ky kz l la lb">router.delete("/cart/", Auth, async (<em class="ld">req</em>, <em class="ld">res</em>) =&gt; {</span><span id="827b" class="kw kx hi ks b fi lc kz l la lb">const owner = req.user._id;</span><span id="daa2" class="kw kx hi ks b fi lc kz l la lb">const itemId = req.query.itemId;</span><span id="313f" class="kw kx hi ks b fi lc kz l la lb">try {<br/>   let cart = await Cart.findOne({ owner });<br/>   const itemIndex = cart.items.findIndex((<em class="ld">item</em>) =&gt; item.itemId == itemId);<br/>if (itemIndex &gt; -1) {<br/>     let item = cart.items[itemIndex];<br/>     cart.bill -= item.quantity * item.price;<br/>if(cart.bill &lt; 0) {<br/>      cart.bill = 0<br/>}<br/>     cart.items.splice(itemIndex, 1);<br/>     cart.bill = cart.items.reduce((<em class="ld">acc</em>, <em class="ld">curr</em>) =&gt; {<br/>return acc + curr.quantity * curr.price;<br/>},0)<br/>    cart = await cart.save();<br/>    res.status(200).send(cart);<br/>} else {<br/>    res.status(404).send("item not found");<br/>}<br/>} catch (error) {<br/>   console.log(error);<br/>   res.status(400).send();<br/>}<br/>});</span></pre><p id="c9ea" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">我们从用户对象获取所有者，但是itemid作为查询字符串传递。</p><p id="6b3a" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">我们找到购物车，并检查购物车中是否存在要删除的商品。如果是，我们从总账单中减去该商品的总价，并将其从购物车中的商品数组中删除，我们重新计算总账单，保存购物车并将其作为响应发送回去。</p><p id="b11c" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">我们最终的购物车路线应该是这样的</p><figure class="kn ko kp kq fd ij"><div class="bz dy l di"><div class="le lf l"/></div></figure><p id="bac8" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated"><strong class="iz hj"> 4.0订单路线</strong></p><p id="abb3" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated"><strong class="iz hj"> 4.1获得订单</strong></p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="025c" class="kw kx hi ks b fi ky kz l la lb">router.get('/orders', Auth, async (req, res) =&gt; {</span><span id="5e7b" class="kw kx hi ks b fi lc kz l la lb">const owner = req.user._id;</span><span id="cced" class="kw kx hi ks b fi lc kz l la lb">try {<br/>const order = await Order.find({ owner: owner }).sort({ date: -1 });<br/>res.status(200).send(order)<br/>} catch (error) {<br/>res.status(500).send()<br/>}<br/>})</span></pre><p id="6436" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">首先，我们在请求中从用户对象中获取owner字段，然后使用它为该用户查找订单。如果订单存在，我们将它们按降序返回，否则我们将返回一个404，表明没有找到订单，如果遇到任何错误，它将触发catch块。</p><p id="ce17" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated"><strong class="iz hj"> 4.2结账</strong></p><p id="cbd9" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">接下来，我们有结帐功能，我们将使用<a class="ae lg" href="https://developer.flutterwave.com/" rel="noopener ugc nofollow" target="_blank"> Flutterwave SDK </a>设置结帐功能。</p><p id="e693" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">如果您没有帐户，请转到上面提供的链接来设置您的帐户并获取您的测试密钥，因为这将是继续操作所必需的。</p><p id="5280" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">我们从身份验证中间件获得所有者字段，从请求体获得有效负载。这是有效载荷的样子。</p><figure class="kn ko kp kq fd ij"><div class="bz dy l di"><div class="le lf l"/></div></figure><p id="bf79" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">您可以从您的flutterwave仪表板复制您的“enckey”加密密钥、flutterwave公钥和私钥。</p><p id="2dac" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">接下来，我们使用用户的id找到用户的购物车。如果购物车存在，我们用账单和用户详细信息更新有效负载。然后，我们使用提供的详细信息从卡上扣费。</p><p id="bceb" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">一旦收费成功，我们就使用购物车中的商品和总账单创建订单。由于不再需要，购物车将被删除。然后订单被发送给客户。</p><p id="1446" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">这是订单路线的样子</p><figure class="kn ko kp kq fd ij"><div class="bz dy l di"><div class="le lf l"/></div></figure><p id="b0dc" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">这是整个系列的总结，我们已经建立了一个基本的电子商务API，您可以添加更多的功能。</p><p id="d1fc" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">这里是Github上这个项目的链接，以及用于测试目的的<a class="ae lg" href="https://documenter.getpostman.com/view/11784799/UVJhDEyt" rel="noopener ugc nofollow" target="_blank">文档</a>的链接。随意克隆和修改。</p><div class="jv jw ez fb jx jy"><a href="https://github.com/breellz/e-commerce-api" rel="noopener  ugc nofollow" target="_blank"><div class="jz ab dw"><div class="ka ab kb cl cj kc"><h2 class="bd hj fi z dy kd ea eb ke ed ef hh bi translated">GitHub - breellz/e-commerce-api:一个电子商务web API。产品、购物车和订单上有完整的CRUD</h2><div class="kf l"><h3 class="bd b fi z dy kd ea eb ke ed ef dx translated">这是一个用NodeJs构建的电子商务API。它的特点是认证，对产品，订单，购物车完全CRUD能力…</h3></div><div class="kg l"><p class="bd b fp z dy kd ea eb ke ed ef dx translated">github.com</p></div></div><div class="kh l"><div class="lh l kj kk kl kh km io jy"/></div></div></a></div><p id="9fa5" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">我希望你学到了一些新东西。</p><p id="fafe" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">谢谢你看完。</p></div></div>    
</body>
</html>