<html>
<head>
<title>How to Host a Personal Email Server on Google Cloud (for Free!): Part IV</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Google Cloud上托管个人邮件服务器(免费！):第四部分</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/how-to-host-a-personal-email-server-on-google-cloud-for-free-part-iv-1b5142cab9c?source=collection_archive---------3-----------------------#2022-01-11">https://medium.com/geekculture/how-to-host-a-personal-email-server-on-google-cloud-for-free-part-iv-1b5142cab9c?source=collection_archive---------3-----------------------#2022-01-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="f513" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">使用MariaDB和Postfixadmin管理虚拟邮箱</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/6b2e8f16b70af07c66f9c8ac6b6afd8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uZ5IoRx580iym_S42I5RpA.jpeg"/></div></div></figure><h1 id="ead2" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">本系列文章</h1><ol class=""><li id="72bb" class="kb kc hi kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated"><a class="ae kt" href="https://lp3.medium.com/how-to-host-a-personal-email-server-on-google-cloud-for-free-part-i-8124d65d1d25" rel="noopener">简介&amp; GCP设置</a></li><li id="30c1" class="kb kc hi kd b ke ku kg kv ki kw kk kx km ky ko kp kq kr ks bi translated"><a class="ae kt" href="https://lp3.medium.com/how-to-host-a-personal-email-server-on-google-cloud-for-free-part-ii-20aaeb0ae9eb" rel="noopener">配置后缀、邮件枪、&amp; DNS记录</a></li><li id="87c6" class="kb kc hi kd b ke ku kg kv ki kw kk kx km ky ko kp kq kr ks bi translated"><a class="ae kt" href="https://lp3.medium.com/how-to-host-a-personal-email-server-on-google-cloud-for-free-part-iii-15e2db1f1f8e" rel="noopener">配置鸽笼&amp;加密</a></li><li id="3726" class="kb kc hi kd b ke ku kg kv ki kw kk kx km ky ko kp kq kr ks bi translated"><strong class="kd hj"> <em class="kz">使用Maria db&amp;Postfixadmin</em></strong>管理虚拟邮箱</li><li id="8930" class="kb kc hi kd b ke ku kg kv ki kw kk kx km ky ko kp kq kr ks bi translated"><a class="ae kt" href="https://lp3.medium.com/how-to-host-a-personal-email-server-on-google-cloud-for-free-part-v-f9a4b3643622" rel="noopener">使用Roundcube托管网络邮件</a></li><li id="a88a" class="kb kc hi kd b ke ku kg kv ki kw kk kx km ky ko kp kq kr ks bi translated"><a class="ae kt" rel="noopener" href="/geekculture/how-to-host-a-personal-email-server-on-google-cloud-for-free-part-vi-6ea09f18d7df">用Rspamd &amp;筛子过滤垃圾邮件</a></li></ol><p id="1d00" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">如果您还没有阅读本系列的前几篇文章，请按照上面的链接进行阅读。此时，我们已经将运行在GCP上的服务器配置为通过SMTP协议发送和接收电子邮件，并允许IMAP连接，使用TLS加密流量。此外，我们的DNS记录配置正确，以确保电子邮件发送给我们和从我们这里发出。下一步是设置<em class="kz">虚拟邮箱</em>。为此，我们将安装<em class="kz"> MariaDB </em>数据库软件和<em class="kz"> Postfixadmin </em>，用于管理虚拟电子邮件域、用户、&amp;别名的软件。让我们开始吧！</p><h1 id="edf7" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">安装MariaDB</h1><p id="3784" class="pw-post-body-paragraph la lb hi kd b ke kf ij ld kg kh im lf ki lp lh li kk lq lk ll km lr ln lo ko hb bi translated">我们需要一个地方来存储我们的虚拟域、邮箱/用户和别名。为此，我们将建立一个数据库。我选择了MariaDB，因为它占用的内存很少，而且在我们的GCP自由层虚拟机上，RAM是一种很有价值的商品。如果您愿意，可以选择另一个数据库解决方案，并相应地调整下面的步骤。现在让我们安装MariaDB。</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="7bf3" class="lx jk hi lt b fi ly lz l ma mb">sudo apt install mariadb-server -y</span></pre><p id="bce8" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">然后，运行提供的安全脚本来保护我们的MariaDB安装。</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="d768" class="lx jk hi lt b fi ly lz l ma mb">sudo mysql_secure_installation</span></pre><p id="a305" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">当提示输入<em class="kz">根</em>的密码时，只需按Enter键，因为没有设置密码。系统会告诉您，您的<em class="kz"> root </em>帐户已经受到保护，因此您可以安全地回答下面两个问题的‘n’<em class="kz"/>。在MariaDB 10.4.3和更高版本中，默认情况下为<em class="kz"> root </em>启用<code class="du mc md me lt b">unix_socket</code>身份验证(一种无密码的身份验证机制)，因此对这些问题回答‘n’不会改变任何事情。对剩余的四个问题回答“y”以<em class="kz">移除匿名用户</em>、<em class="kz">不允许远程root登录</em>、<em class="kz">移除测试数据库并对其进行访问</em>，以及<em class="kz">重新加载特权表</em>。这将加强我们的安全性，并删除预安装的“测试”数据库。</p><h1 id="4b58" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">安装Postfixadmin</h1><p id="c978" class="pw-post-body-paragraph la lb hi kd b ke kf ij ld kg kh im lf ki lp lh li kk lq lk ll km lr ln lo ko hb bi translated">Postfixadmin是一个用PHP编写的门户网站，因此我们需要安装web服务器软件来托管它和PHP。我将使用<em class="kz"> Nginx </em>，但是如果你希望使用<em class="kz"> Apache </em>，你可以在学习过程中调整指令。让我们安装必要的软件。</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="2215" class="lx jk hi lt b fi ly lz l ma mb">sudo apt install nginx php-fpm -y</span></pre><p id="3b21" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">现在，我们可以在浏览器中输入我们的邮件子域名，迎接我们的是Nginx欢迎页面！</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mf"><img src="../Images/52ea2b1d0a92c483ccae9cb337567ca0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1fpl-DviFHUWHSnN0DLEEg.png"/></div></div></figure><p id="8bd7" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">Nginx创建了路由<code class="du mc md me lt b">/var/www/html/</code>。你通过Nginx托管的任何文件都应该位于<code class="du mc md me lt b">/var/www/</code>目录中。让我们继续前进，导航到<code class="du mc md me lt b">/var/www/</code>，并将<code class="du mc md me lt b">html</code>目录重命名为<code class="du mc md me lt b">mail</code>，因为我们将从这里只提供与电子邮件相关的文件。我们现在可以留下<code class="du mc md me lt b">index.nginx-debian.html</code>文件。</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="5236" class="lx jk hi lt b fi ly lz l ma mb">cd /var/www/<br/>sudo mv html/ mail/</span></pre><p id="2dcb" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">接下来，我们将从Github repo下载并安装Postfixadmin。为了下载文件，我们需要安装<code class="du mc md me lt b">wget</code>。</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="a963" class="lx jk hi lt b fi ly lz l ma mb">sudo apt install wget</span></pre><p id="9b98" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">然后，导航到<code class="du mc md me lt b">/srv/</code>目录并运行以下命令来下载、解压缩和解归档Postfixadmin文件。</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="19b7" class="lx jk hi lt b fi ly lz l ma mb">cd /srv/<br/>sudo wget -O postfixadmin.tgz https://github.com/postfixadmin/postfixadmin/archive/postfixadmin-3.3.10.tar.gz<br/>sudo tar -zxvf postfixadmin.tgz</span></pre><p id="8569" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated"><strong class="kd hj">注:</strong>在撰写本文时，Postfixadmin的最新版本是<em class="kz"> 3.3.10 </em>。您可能希望更新以前的命令，以下载您可以使用的最新版本。</p><p id="8eef" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">删除zip文件，并将文件夹重命名为<code class="du mc md me lt b">postfixadmin</code>。然后，在我们的<code class="du mc md me lt b">/var/www/mail/</code>目录中创建一个<em class="kz">符号链接</em>到<code class="du mc md me lt b">/srv/postfixadmin/public/</code>文件夹，以便在<em class="kz">mail.example.com/admin</em>托管我们的管理门户。</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="184e" class="lx jk hi lt b fi ly lz l ma mb">sudo rm postfixadmin.tgz<br/>sudo mv postfixadmin-postfixadmin-3.3.10/ postfixadmin/<br/>sudo ln -s /srv/postfixadmin/public/ /var/www/mail/admin</span></pre><h1 id="149b" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">设置数据库</h1><p id="6c32" class="pw-post-body-paragraph la lb hi kd b ke kf ij ld kg kh im lf ki lp lh li kk lq lk ll km lr ln lo ko hb bi translated">现在我们需要为所有的邮件软件创建一个数据库和用户。运行<code class="du mc md me lt b">mysql</code>。</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="9a1d" class="lx jk hi lt b fi ly lz l ma mb">sudo mysql</span></pre><p id="3bf8" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">然后，运行以下命令来创建我们的数据库和具有适当权限的用户。用你选择的密码替换<em class="kz">密码</em>。</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="e484" class="lx jk hi lt b fi ly lz l ma mb">CREATE DATABASE postfix;<br/>CREATE USER postfix@localhost IDENTIFIED BY '<em class="kz">password</em>';<br/>GRANT ALL PRIVILEGES ON postfix.* TO postfix@localhost;<br/>flush privileges;<br/>exit;</span></pre><h1 id="bb72" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">配置Postfixadmin</h1><p id="3775" class="pw-post-body-paragraph la lb hi kd b ke kf ij ld kg kh im lf ki lp lh li kk lq lk ll km lr ln lo ko hb bi translated">接下来，我们需要配置Postfixadmin来使用数据库。创建包含本地配置的文件<code class="du mc md me lt b">/srv/postfixadmin/config.local.php</code>。</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="f99a" class="lx jk hi lt b fi ly lz l ma mb">&lt;?php<br/>  $CONF['database_type'] = 'mysqli';<br/>  $CONF['database_host'] = 'localhost';<br/>  $CONF['database_user'] = 'postfix';<br/>  $CONF['database_password'] = '<em class="kz">password</em>';<br/>  $CONF['database_name'] = 'postfix';<br/>  $CONF['encrypt'] = 'dovecot:SHA512';<br/>  $CONF['configured'] = true;<br/>?&gt;</span></pre><p id="9e24" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">我们需要创建PostfixAdmin使用的<code class="du mc md me lt b">/srv/postfixadmin/templates_c/</code>目录。应该是Nginx ( <strong class="kd hj"> <em class="kz"> www-data </em> </strong>)创建的web服务器用户所有。</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="6c1f" class="lx jk hi lt b fi ly lz l ma mb">sudo mkdir /srv/postfixadmin/templates_c/ &amp;&amp; sudo chown -R www-data /srv/postfixadmin/templates_c/</span></pre><h1 id="45cc" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">配置Nginx</h1><p id="1795" class="pw-post-body-paragraph la lb hi kd b ke kf ij ld kg kh im lf ki lp lh li kk lq lk ll km lr ln lo ko hb bi translated">现在我们需要配置Nginx来服务于我们重命名的<code class="du mc md me lt b">mail</code>目录和PHP文件，因为默认情况下这是不活动的。我们还会将其配置为使用我们的TLS证书来强制加密流量，因为我们从不希望通过非加密的HTTP发送登录凭据。我们来编辑一下<code class="du mc md me lt b">/etc/nginx/sites-available/default</code>。</p><p id="9b6a" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">首先，注释掉下面几行:</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="3d81" class="lx jk hi lt b fi ly lz l ma mb">listen 80 default_server;<br/>listen [::]:80 default_server;</span></pre><p id="ba31" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">然后，取消对以下行的注释；</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="e37c" class="lx jk hi lt b fi ly lz l ma mb">listen 443 ssl default_server;<br/>listen [::]:443 ssl default_server;</span></pre><p id="fd7a" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">我们需要添加TLS证书和密钥的位置。</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="50a8" class="lx jk hi lt b fi ly lz l ma mb">ssl_certificate /etc/letsencrypt/live/<em class="kz">mail.example.com</em>/fullchain.pem;<br/>ssl_certificate_key /etc/letsencrypt/live/<em class="kz">mail.example.com</em>/privkey.pem;</span></pre><p id="83d8" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">然后，将<em class="kz">根文件夹位置</em>更新到我们重命名的<code class="du mc md me lt b">mail</code>目录，并将<code class="du mc md me lt b">index.php</code>添加到要服务的<em class="kz">索引</em>文件列表中。</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="b22d" class="lx jk hi lt b fi ly lz l ma mb">root /var/www/mail;</span><span id="cdce" class="lx jk hi lt b fi mg lz l ma mb"># Add index.php to the list if you are using PHP<br/>index index.php index.html index.htm index.nginx-debian.html;</span></pre><p id="9e56" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">取消对以下行的注释，以启用<em class="kz"> php-fpm </em>。</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="05db" class="lx jk hi lt b fi ly lz l ma mb">location ~ \.php$ {<br/>        include snippets/fastcgi-php.conf;<br/>        fastcgi_pass unix:/run/php/php7.4-fpm.sock;<br/>}</span></pre><p id="63a9" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">最后，我们将创建一个服务器配置来侦听端口80上的未加密HTTP请求，并将请求重定向到端口443，以强制只进行加密连接。将以下几行添加到文件中，然后保存并退出。</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="aded" class="lx jk hi lt b fi ly lz l ma mb">server {<br/>        listen 80;<br/>        listen [::]:80;</span><span id="9858" class="lx jk hi lt b fi mg lz l ma mb">        server_name _;</span><span id="2a98" class="lx jk hi lt b fi mg lz l ma mb">        return 301 <a class="ae kt" href="https://$host$request_uri;" rel="noopener ugc nofollow" target="_blank">https://$host$request_uri;</a><br/>}</span></pre><p id="b124" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">重新加载Nginx以使用我们的新配置。</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="7f14" class="lx jk hi lt b fi ly lz l ma mb">sudo service nginx reload</span></pre><p id="3a26" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">现在，通过导航到我们将在下一步中使用的设置页面(即<em class="kz">https://mail.example.com/admin/setup.php</em>)，确保我们可以通过HTTPS访问Postfixadmin。</p><h1 id="1ae8" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">配置后缀更多信息</h1><p id="fdcd" class="pw-post-body-paragraph la lb hi kd b ke kf ij ld kg kh im lf ki lp lh li kk lq lk ll km lr ln lo ko hb bi translated">在设置页面上生成一个设置密码，并将结果行添加到我们的<code class="du mc md me lt b">config.local.php</code>文件中。然后，刷新页面并使用设置密码登录。</p><p id="fa62" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">这一页非常方便。它向我们展示了什么可行，什么不可行。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mh"><img src="../Images/aa67aac2c4385b17b6e719dc5527d17a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vu7LnFapMjTmlDHL9MVpvw.png"/></div></div></figure><p id="f935" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">您可以忽略两个<strong class="kd hj">警告</strong>，因为它们与我们没有使用的丢失的数据库服务器和扩展相关。但是，最后一个警告应该得到纠正，因为我们希望为新邮箱自动创建默认文件夹。我们还必须纠正列在<strong class="kd hj">错误</strong>下的所有问题。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mi"><img src="../Images/f31748113f117ca770b30f51b96e7557.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y680AJS1f3bNxEMu4lx61Q.png"/></div></div></figure><p id="0233" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">请注意，在<strong class="kd hj">信息</strong>部分，我们得到一个勾号，表示有一个<em class="kz"> MySQL </em>数据库正在运行，但是我们缺少所需的扩展。我们将不得不在解决错误的同时安装它。</p><p id="4e0c" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">运行以下命令来安装缺失的PHP模块。</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="4dfa" class="lx jk hi lt b fi ly lz l ma mb">sudo apt install php-mysql php-imap php-mbstring -y</span></pre><p id="55bf" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">如果你现在刷新页面，你会发现剩下的唯一问题是一个<em class="kz">密码散列</em>错误。这是因为Postfixadmin无法访问我们的TLS证书，也无法访问Dovecot的<code class="du mc md me lt b"><em class="kz">stats-writer</em></code>。要解决这个问题，首先需要更新我们的<strong class="kd hj"> <em class="kz">访问控制列表</em> </strong>，为我们的<strong class="kd hj"> <em class="kz"> www-data </em> </strong>用户提供适当的权限。这将允许我们更好地控制文件权限。我们将需要<code class="du mc md me lt b">acl</code>包来完成这项工作。</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="ab0f" class="lx jk hi lt b fi ly lz l ma mb">sudo apt install acl</span></pre><p id="af75" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">现在，与其让<strong class="kd hj"> <em class="kz"> www-data </em> </strong>成为证书目录的所有者，我们可以简单地向<strong class="kd hj"><em class="kz"/></strong>用户提供<em class="kz">读取</em> &amp; <em class="kz">执行</em>的权限。我们必须对<code class="du mc md me lt b">live/</code>和<code class="du mc md me lt b">archive/</code>目录都这样做。</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="5a39" class="lx jk hi lt b fi ly lz l ma mb">sudo setfacl -R -m u:www-data:rx /etc/letsencrypt/live/ /etc/letsencrypt/archive/</span></pre><p id="9086" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">让我们加密证书只有3个月的有效期，但默认情况下，<code class="du mc md me lt b">certbot</code>会在到期前自动续订。当这种情况发生时，一个新的证书将被添加到<code class="du mc md me lt b">archive</code>目录，并从<code class="du mc md me lt b">live</code>目录链接。这将导致我们的<strong class="kd hj"> <em class="kz"> www-data </em> </strong>用户无法访问证书。幸运的是，我们可以很容易地提供一个<em class="kz">钩子</em>来在<code class="du mc md me lt b">certbot</code>成功更新&amp;部署新证书时运行。让我们创建文件<code class="du mc md me lt b">/etc/letsencrypt/renewal-hooks/deploy/mail-permissions</code>并添加我们刚刚运行的命令。之后，我们还将重启<code class="du mc md me lt b">dovecot</code>和<code class="du mc md me lt b">postfix</code>，以便它们加载并使用更新后的证书。</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="3bfb" class="lx jk hi lt b fi ly lz l ma mb">#!/bin/sh</span><span id="7de3" class="lx jk hi lt b fi mg lz l ma mb">setfacl -R -m u:www-data:rx /etc/letsencrypt/live/ /etc/letsencrypt/archive/<br/>service dovecot restart<br/>service postfix restart</span></pre><p id="2a42" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">现在，使文件可执行，以便<code class="du mc md me lt b">certbot</code>可以在更新我们的证书后运行它。</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="b4c9" class="lx jk hi lt b fi ly lz l ma mb">sudo chmod +x <!-- -->/etc/letsencrypt/renewal-hooks/deploy/<!-- -->mail-permissions</span></pre><p id="d4da" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">然后，我们需要编辑<code class="du mc md me lt b">/etc/dovecot/conf.d/10-master.conf</code>，将以下内容添加到文件的末尾。</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="cd0d" class="lx jk hi lt b fi ly lz l ma mb">service stats {<br/>  unix_listener stats-reader {<br/>    user = www-data<br/>    mode = 0660<br/>  }</span><span id="d3fc" class="lx jk hi lt b fi mg lz l ma mb">  unix_listener stats-writer {<br/>    user = www-data<br/>    mode = 0660<br/>  }<br/>}</span></pre><p id="73c2" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">最后，将<strong class="kd hj"> <em class="kz"> www-data </em> </strong>用户添加到<strong class="kd hj"> <em class="kz"> dovecot </em> </strong>组并重启dovecot。</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="2c72" class="lx jk hi lt b fi ly lz l ma mb">sudo usermod -aG dovecot www-data<br/>sudo service dovecot restart</span></pre><p id="6ae5" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">再次刷新页面，瞧！我们没有错误！😃现在我们需要添加一个用于登录Postfixadmin的管理员帐户。我喜欢使用一个<em class="kz">管理</em>地址，然后我将它设置为我的电子邮件地址的别名，但是你可以选择简单地使用你的电子邮件地址。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mj"><img src="../Images/8d728069987b9fd1703c3f399daeb48a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6nXHFg8tq_UW4Eawi6agWw.png"/></div></div></figure><p id="bccb" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">之后，我们可以导航到我们的管理门户网站(即<em class="kz">https://mail.example.com/admin</em>)并使用我们新创建的管理帐户登录。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mk"><img src="../Images/3fa6468b02b925b8a1f9014192c8fba8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rf1-N3tyw6nfdNpGV-mi1g.png"/></div></div></figure><h1 id="7d6a" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">创建虚拟域和邮箱</h1><p id="0ace" class="pw-post-body-paragraph la lb hi kd b ke kf ij ld kg kh im lf ki lp lh li kk lq lk ll km lr ln lo ko hb bi translated">现在，我们可以使用Postfixadmin出色的web界面来管理我们的域、邮箱/用户和别名。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ml"><img src="../Images/759854a920bc76eefb384ded595d0374.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-wlyGAFfdXSecZGrw82WVw.png"/></div></div></figure><p id="255e" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">选择<em class="kz">概述</em>然后<em class="kz">添加域</em>。键入您的域名，并根据您的需要调整设置。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mm"><img src="../Images/eb5b15e0de1ecf75bb26ace25807e71a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i8zB7qxQfHktOQEQUdlo9A.png"/></div></div></figure><p id="1e1e" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">然后，导航到<em class="kz">虚拟列表</em>并向下滚动到<em class="kz">邮箱</em>部分，选择<em class="kz">添加邮箱</em>。(我们将立即更新我们的默认邮件别名。)填写信息，选择<em class="kz">添加邮箱</em>。<em class="kz">用户名</em>将是您的电子邮件地址中通向您的域名的部分(即<em class="kz">some.user@example.com</em>)。</p><p id="6ed0" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">接下来，导航回<em class="kz">虚拟列表</em>并更新每个别名，将邮件转发到您新创建的地址。我们现在有了一个工作的虚拟邮箱！您可以使用新的管理门户网站随时根据需要添加/删除/编辑域、邮箱和别名。</p><p id="9c20" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">我们现在是如此接近！最后一步是配置Postfix和Dovecot，通过我们的MariaDB数据库使用虚拟邮箱。</p><h1 id="a368" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">配置Postfix以使用MariaDB</h1><p id="ab52" class="pw-post-body-paragraph la lb hi kd b ke kf ij ld kg kh im lf ki lp lh li kk lq lk ll km lr ln lo ko hb bi translated">首先，我们需要安装<code class="du mc md me lt b">postfix-mysql</code> <em class="kz"> </em>包，以便Postfix可以与我们的数据库通信。</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="ef31" class="lx jk hi lt b fi ly lz l ma mb">sudo apt install postfix-mysql</span></pre><p id="7447" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">创建一个目录来存储我们的SQL配置文件。</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="497c" class="lx jk hi lt b fi ly lz l ma mb">sudo mkdir /etc/postfix/sql/</span></pre><p id="3dbf" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">然后我们需要编辑<code class="du mc md me lt b">/etc/postfix/main.cf</code>，添加/编辑以下几行:</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="8fff" class="lx jk hi lt b fi ly lz l ma mb">#mailbox_transport = lmtp:unix:private/dovecot-lmtp</span><span id="4e10" class="lx jk hi lt b fi mg lz l ma mb">#mydestination = $mydomain, localhost</span><span id="84d6" class="lx jk hi lt b fi mg lz l ma mb">virtual_transport = lmtp:unix:private/dovecot-lmtp</span><span id="2311" class="lx jk hi lt b fi mg lz l ma mb">virtual_mailbox_domains =<br/>  proxy:mysql:/etc/postfix/sql/virtual_domains_maps.cf<br/>virtual_mailbox_maps =<br/>  proxy:mysql:/etc/postfix/sql/virtual_mailbox_maps.cf,<br/>  proxy:mysql:/etc/postfix/sql/virtual_alias_domain_mailbox_maps.cf<br/>virtual_alias_maps =<br/>  proxy:mysql:/etc/postfix/sql/virtual_alias_maps.cf,<br/>  proxy:mysql:/etc/postfix/sql/virtual_alias_domain_maps.cf,<br/>  proxy:mysql:/etc/postfix/sql/virtual_alias_domain_catchall_maps.cf</span></pre><p id="8fd9" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">让我们分解这些变量。</p><ul class=""><li id="4879" class="kb kc hi kd b ke lc kg le ki mn kk mo km mp ko mq kq kr ks bi translated"><code class="du mc md me lt b">virtual_mailbox_domains</code>告诉Postfix如何在数据库中查找虚拟域名</li><li id="b570" class="kb kc hi kd b ke ku kg kv ki kw kk kx km ky ko mq kq kr ks bi translated"><code class="du mc md me lt b">virtual_mailbox_maps</code>告诉Postfix如何在数据库中查找虚拟邮箱</li><li id="05c7" class="kb kc hi kd b ke ku kg kv ki kw kk kx km ky ko mq kq kr ks bi translated"><code class="du mc md me lt b">virtual_alias_maps</code>告诉Postfix如何在数据库中查找别名</li><li id="877d" class="kb kc hi kd b ke ku kg kv ki kw kk kx km ky ko mq kq kr ks bi translated"><code class="du mc md me lt b">virtual_transport</code>告诉Postfix使用Dovecot将邮件发送到我们的虚拟邮箱</li></ul><p id="5d0a" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated"><strong class="kd hj">注意:</strong>您可以注释掉或删除设置<code class="du mc md me lt b">mailbox_transport</code>和<code class="du mc md me lt b">mydestination</code>的行，因为我们正在使用虚拟域&amp;邮箱，所以不再需要它们，但这不是必需的，也不会对行为产生影响。</p><p id="1019" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">现在我们需要创建我们引用的配置文件。创建<code class="du mc md me lt b">/etc/postfix/sql/virtual_domains_maps.cf</code>，添加以下几行(用创建<strong class="kd hj"> <em class="kz">后缀</em> </strong>数据库用户时设置的密码替换<strong class="kd hj"> <em class="kz">密码</em> </strong>):</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="b00a" class="lx jk hi lt b fi ly lz l ma mb">user = postfix<br/>password = <em class="kz">password</em><br/>hosts = localhost<br/>dbname = postfix<br/>query = SELECT domain FROM domain WHERE domain='%s' AND active = '1'</span></pre><p id="5d65" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">创建<code class="du mc md me lt b">/etc/postfix/sql/virtual_mailbox_maps.cf</code>并写入:</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="8c54" class="lx jk hi lt b fi ly lz l ma mb">user = postfix<br/>password = <em class="kz">password</em><br/>hosts = localhost<br/>dbname = postfix<br/>query = SELECT maildir FROM mailbox WHERE username='%s' AND active = '1'</span></pre><p id="5755" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">创建<code class="du mc md me lt b">/etc/postfix/sql/virtual_alias_domain_mailbox_maps.cf</code>并写入:</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="2a5a" class="lx jk hi lt b fi ly lz l ma mb">user = postfix<br/>password = <em class="kz">password</em><br/>hosts = localhost<br/>dbname = postfix<br/>query = SELECT maildir FROM mailbox,alias_domain WHERE alias_domain.alias_domain = '%d' and mailbox.username = CONCAT('%u', '@', alias_domain.target_domain) AND mailbox.active = 1 AND alias_domain.active='1'</span></pre><p id="f7e8" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">创建<code class="du mc md me lt b">/etc/postfix/sql/virtual_alias_maps.cf</code>并写入:</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="bd77" class="lx jk hi lt b fi ly lz l ma mb">user = postfix<br/>password = <em class="kz">password</em><br/>hosts = localhost<br/>dbname = postfix<br/>query = SELECT goto FROM alias WHERE address='%s' AND active = '1'</span></pre><p id="33cb" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">创建<code class="du mc md me lt b">/etc/postfix/sql/virtual_alias_domain_maps.cf</code>并写入:</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="e814" class="lx jk hi lt b fi ly lz l ma mb">user = postfix<br/>password = <em class="kz">password</em><br/>hosts = localhost<br/>dbname = postfix<br/>query = SELECT goto FROM alias,alias_domain WHERE alias_domain.alias_domain = '%d' and alias.address = CONCAT('%u', '@', alias_domain.target_domain) AND alias.active = 1 AND alias_domain.active='1'</span></pre><p id="998a" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">创建<code class="du mc md me lt b">/etc/postfix/sql/virtual_alias_domain_catchall_maps.cf</code>并添加以下内容:</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="c76f" class="lx jk hi lt b fi ly lz l ma mb">user = postfix<br/>password = <em class="kz">password</em><br/>hosts = localhost<br/>dbname = postfix<br/>query = SELECT goto FROM alias,alias_domain WHERE alias_domain.alias_domain = '%d' and alias.address = CONCAT('@', alias_domain.target_domain) AND alias.active = 1 AND alias_domain.active='1'</span></pre><p id="0ecc" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">因为这些文件以纯文本的形式包含数据库密码，所以我们应该将访问权限仅限于我们的<em class="kz"> root </em>和<em class="kz"> postfix </em>用户。</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="7427" class="lx jk hi lt b fi ly lz l ma mb">sudo chmod 640 /etc/postfix/sql/*<br/>sudo setfacl -R -m u:postfix:r /etc/postfix/sql/*</span></pre><p id="632f" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">现在最后一次编辑<code class="du mc md me lt b">/etc/postfix/main.cf</code>。添加以下几行:</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="ac4c" class="lx jk hi lt b fi ly lz l ma mb">virtual_mailbox_base = /var/vmail<br/>virtual_minimum_uid = 2000<br/>virtual_uid_maps = static:2000<br/>virtual_gid_maps = static:2000</span></pre><p id="9e4d" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">这里，我们告诉Postfix在哪里存储我们的虚拟邮箱的邮件，以及哪个系统用户将拥有它们。现在我们需要创建<code class="du mc md me lt b">vmail</code>用户组&amp;和<code class="du mc md me lt b">/var/vmail</code>位置，将所有权赋予用户。我们将禁用登录并防止找到主文件夹。</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="a824" class="lx jk hi lt b fi ly lz l ma mb">sudo adduser vmail --system --group --uid 2000 --disabled-login --no-create-home</span><span id="4f95" class="lx jk hi lt b fi mg lz l ma mb">sudo mkdir /var/vmail/ &amp;&amp; sudo chown -R vmail:vmail /var/vmail/</span></pre><p id="b2f4" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">重启Postfix。</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="bd79" class="lx jk hi lt b fi ly lz l ma mb">sudo service postfix restart</span></pre><h1 id="aa09" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">配置Dovecot以使用MariaDB</h1><p id="19fb" class="pw-post-body-paragraph la lb hi kd b ke kf ij ld kg kh im lf ki lp lh li kk lq lk ll km lr ln lo ko hb bi translated">在能够通过电子邮件客户端从我们的服务器发送和接收邮件之前，我们已经到达了最后一步！我们必须配置Dovecot来通过MariaDB使用我们的虚拟邮箱。首先，我们必须为Dovecot安装MySQL支持。</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="b35c" class="lx jk hi lt b fi ly lz l ma mb">sudo apt install dovecot-mysql</span></pre><p id="e6e2" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">然后，编辑<code class="du mc md me lt b">/etc/dovecot/conf.d/10-mail.conf</code>。因为我们的虚拟邮箱没有连接到实际的本地用户，所以我们需要添加以下行:</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="7bd3" class="lx jk hi lt b fi ly lz l ma mb">mail_home = /var/vmail/%d/%n</span></pre><p id="cfd0" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">这将在<code class="du mc md me lt b"><em class="kz">domain</em>/<em class="kz">username</em>/</code>层级中的<code class="du mc md me lt b">/var/vmail/</code>下创建目录。</p><p id="3888" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">编辑<code class="du mc md me lt b">/etc/dovecot/conf.d/10-auth.conf</code>中的以下行，以使用我们数据库中的用户信息，并阻止<em class="kz">本地unix用户</em>发送电子邮件。</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="1a33" class="lx jk hi lt b fi ly lz l ma mb">#!include auth-system.conf.ext<br/>!include auth-sql.conf.ext</span></pre><p id="5cc3" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">现在编辑<code class="du mc md me lt b">/etc/dovecot/dovecot-sql.conf.ext</code>。取消注释/编辑以下行(或仅复制&amp;粘贴):</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="b7cc" class="lx jk hi lt b fi ly lz l ma mb">driver = mysql</span><span id="b4b2" class="lx jk hi lt b fi mg lz l ma mb">connect = host=localhost dbname=postfix user=postfix password=<em class="kz">password</em></span><span id="a980" class="lx jk hi lt b fi mg lz l ma mb">default_pass_scheme = SHA512</span><span id="5f1f" class="lx jk hi lt b fi mg lz l ma mb">password_query = SELECT username AS user,password FROM mailbox WHERE username = '%u' AND active='1'</span><span id="9df4" class="lx jk hi lt b fi mg lz l ma mb">user_query = SELECT maildir, 2000 AS uid, 2000 AS gid FROM mailbox WHERE username = '%u' AND active='1'</span><span id="ba42" class="lx jk hi lt b fi mg lz l ma mb">iterate_query = SELECT username AS user FROM mailbox</span></pre><p id="4cdb" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">重启鸽笼。</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="0b42" class="lx jk hi lt b fi ly lz l ma mb">sudo service dovecot restart</span></pre><h1 id="e713" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">通过电子邮件客户端连接</h1><p id="432f" class="pw-post-body-paragraph la lb hi kd b ke kf ij ld kg kh im lf ki lp lh li kk lq lk ll km lr ln lo ko hb bi translated">干得好！我们现在可以连接到我们的服务器，并通过桌面和移动电子邮件客户端发送/接收电子邮件。客户端之间的流程基本相同，但可能略有不同。这些是一般步骤:</p><ol class=""><li id="af12" class="kb kc hi kd b ke lc kg le ki mn kk mo km mp ko kp kq kr ks bi translated">选择<em class="kz">添加新账户</em>。</li><li id="c158" class="kb kc hi kd b ke ku kg kv ki kw kk kx km ky ko kp kq kr ks bi translated">如果选择<em class="kz">账户类型</em>，则选择<em class="kz">其他</em>或<em class="kz"> IMAP </em>。</li><li id="145e" class="kb kc hi kd b ke ku kg kv ki kw kk kx km ky ko kp kq kr ks bi translated">输入您的电子邮件地址(在Postfixadmin中设置)。</li><li id="3d76" class="kb kc hi kd b ke ku kg kv ki kw kk kx km ky ko kp kq kr ks bi translated">输入您的密码。</li><li id="825c" class="kb kc hi kd b ke ku kg kv ki kw kk kx km ky ko kp kq kr ks bi translated">将<em class="kz">传入</em> (IMAP) &amp; <em class="kz">传出</em> (SMTP)服务器设置到您的子域(即<em class="kz">mail.example.com</em>)<em class="kz">。</em></li><li id="0cbe" class="kb kc hi kd b ke ku kg kv ki kw kk kx km ky ko kp kq kr ks bi translated">如果需要，将<em class="kz">输入</em>端口设置为<em class="kz"> 993 </em>，将<em class="kz">输出</em>端口设置为<em class="kz"> 587 </em> ( <em class="kz"> STARTTLS </em>)或<em class="kz">465</em>(<em class="kz">SSL</em>/<em class="kz">TLS</em>)<em class="kz">。</em></li></ol><p id="2b51" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">如果您登录任何一个都有问题，您可以将以下行添加到<code class="du mc md me lt b">/etc/dovecot/conf.d/10-auth.conf</code>。这将把认证问题记录到<code class="du mc md me lt b">/var/log/mail.log</code>中。诊断完问题后，一定要注释掉或删除这些行。</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="d85a" class="lx jk hi lt b fi ly lz l ma mb">auth_debug = yes<br/>auth_debug_passwords = yes</span></pre><p id="3af6" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">现在给自己发一封电子邮件，享受你的成就吧！</p><p id="7d5d" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated"><strong class="kd hj">专业提示:</strong>你可以通过用<a class="ae kt" href="https://www.mail-tester.com" rel="noopener ugc nofollow" target="_blank">邮件测试器</a>测试你的配置来检查你的邮件是否会避开垃圾邮件文件夹！</p><h1 id="0f71" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">自动续订TLS证书</h1><p id="5375" class="pw-post-body-paragraph la lb hi kd b ke kf ij ld kg kh im lf ki lp lh li kk lq lk ll km lr ln lo ko hb bi translated">让我们加密90天后过期的证书。如果我们的过期，我们将无法从电子邮件客户端访问我们的邮箱。Let's Encrypt非常友好，包含了安装自动更新服务。但是，它是根据用于请求和安装证书的命令进行配置的。由于我们在安装Nginx之前安装了我们的证书，我们需要重新配置服务，以便在续订时使用Nginx插件。首先，安装Nginx插件。(如果你选择使用Apache，那么安装<code class="du mc md me lt b">python3-certbot-apache</code>代替。)</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="be44" class="lx jk hi lt b fi ly lz l ma mb">sudo apt install python3-certbot-nginx -y</span></pre><p id="3df6" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">然后，只需使用插件更新证书。因为证书实际上还没有到期，所以我们必须使用<code class="du mc md me lt b">--force-renewal</code>选项。</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="791e" class="lx jk hi lt b fi ly lz l ma mb">sudo certbot renew --nginx --force-renewal</span></pre><p id="21d4" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">现在，您的TLS证书将始终是最新的！😃</p><h1 id="fd88" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">结论</h1><p id="d390" class="pw-post-body-paragraph la lb hi kd b ke kf ij ld kg kh im lf ki lp lh li kk lq lk ll km lr ln lo ko hb bi translated">恭喜你！你正式拥有了一个托管在云中的私人电子邮件服务器，而且完全免费！这是一个不小的壮举，所以花一点时间来欣赏你所取得的成就。然后，让我们回顾一下本文中所涉及的内容。</p><ul class=""><li id="553a" class="kb kc hi kd b ke lc kg le ki mn kk mo km mp ko mq kq kr ks bi translated">我们设置MariaDB作为数据库来存储我们的虚拟邮箱。</li><li id="5cf4" class="kb kc hi kd b ke ku kg kv ki kw kk kx km ky ko mq kq kr ks bi translated">我们设置Nginx和PHP在web上服务Postfixadmin。</li><li id="d09f" class="kb kc hi kd b ke ku kg kv ki kw kk kx km ky ko mq kq kr ks bi translated">我们设置Postfixadmin来管理我们的虚拟域、邮箱和别名。</li><li id="4141" class="kb kc hi kd b ke ku kg kv ki kw kk kx km ky ko mq kq kr ks bi translated">我们通过MariaDB配置Postfix &amp; Dovecot来使用我们的虚拟邮箱。</li><li id="909a" class="kb kc hi kd b ke ku kg kv ki kw kk kx km ky ko mq kq kr ks bi translated">我们将我们的电子邮件客户端连接到我们的服务器，并确认我们可以发送和接收电子邮件。</li><li id="95e9" class="kb kc hi kd b ke ku kg kv ki kw kk kx km ky ko mq kq kr ks bi translated">我们配置了<code class="du mc md me lt b">certbot</code>来自动更新我们的TLS证书。</li></ul><p id="99e8" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">我们的系列就要结束了。只剩两篇文章了！在下一篇文章中，我们将安装<em class="kz"> Roundcube </em>来提供一个webmail客户端。然后，在最后一篇文章中，我们将安装<em class="kz">Rspamd</em>&amp;<em class="kz">Sieve</em>来检测垃圾邮件，并将其拒绝或发送到垃圾文件夹。</p><p id="6f84" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">感谢您的阅读！如果你觉得这篇文章很有帮助，并且有兴趣继续关注这个系列的其他部分，请鼓掌并关注即将发布的文章。</p></div></div>    
</body>
</html>