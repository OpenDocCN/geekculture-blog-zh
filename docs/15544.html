<html>
<head>
<title>EKS — Kubernetes — Not Ready nodes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">EKS —库贝内特斯—未就绪节点</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/eks-kubernetes-not-ready-nodes-dafb300ed299?source=collection_archive---------3-----------------------#2022-11-07">https://medium.com/geekculture/eks-kubernetes-not-ready-nodes-dafb300ed299?source=collection_archive---------3-----------------------#2022-11-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/261becdd8c3c9ad98fcbcba6d6f6e41f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xo8lUCFq7rvXF_Au"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Photo by <a class="ae iu" href="https://unsplash.com/@dominikhofbauer?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">dominik hofbauer</a> on <a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="f69d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">今天我要谈谈几天前我在开发EKS 1.21时遇到的一个问题。<br/> <em class="jt">如果你喜欢这个故事记得鼓掌并希望订阅，我真的很感激！</em></p><p id="db1a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我经常在Kubernetes工作，昨天晚上我看到几个Kubernetes节点在各种状态之间摆动。</p><figure class="jz ka kb kc fd ij er es paragraph-image"><div class="er es jy"><img src="../Images/dd939f84075ad31554ab79b9fa7e638a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1022/format:webp/1*TbvxZ5N2aaUVvTYI1l1-zQ.png"/></div><figcaption class="iq ir et er es is it bd b be z dx">Number of NotReady Events for a specific node</figcaption></figure><p id="9eb4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">告诉我某些东西工作不正常的症状有:</p><ul class=""><li id="a05e" class="kd ke hi ix b iy iz jc jd jg kf jk kg jo kh js ki kj kk kl bi translated">Pod处于<code class="du ju jv jw jx b">containerCreating</code>状态超过2分钟</li><li id="1872" class="kd ke hi ix b iy km jc kn jg ko jk kp jo kq js ki kj kk kl bi translated">更慢的<code class="du ju jv jw jx b">gitlab-runner</code>创作时间，由于上面的要点</li><li id="0945" class="kd ke hi ix b iy km jc kn jg ko jk kp jo kq js ki kj kk kl bi translated">Pod在<code class="du ju jv jw jx b">Terminating</code>中超过5分钟，没有pdb/奇怪的优雅终止</li><li id="e9e7" class="kd ke hi ix b iy km jc kn jg ko jk kp jo kq js ki kj kk kl bi translated">一些节点在<code class="du ju jv jw jx b">Ready/NotReady</code>状态之间翻转的警报</li></ul></div><div class="ab cl kr ks gp kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="hb hc hd he hf"><p id="0d6b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">所以我决定去看看是怎么回事。</p><pre class="jz ka kb kc fd ky jx kz la aw lb bi"><span id="941b" class="lc ld hi jx b fi le lf l lg lh">kubectl describe &lt;NODE-NAME&gt;</span></pre><p id="1c25" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在条件部分，我看到了错误:</p><figure class="jz ka kb kc fd ij er es paragraph-image"><div class="er es li"><img src="../Images/3eb6fc3264cbef2ca884538949e8bffd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*DEIc_1L2YiOwwQsyTeafug.png"/></div></figure><pre class="jz ka kb kc fd ky jx kz la aw lb bi"><span id="003b" class="lc ld hi jx b fi le lf l lg lh">KubeletNotReady  PLEG is not healthy: pleg was last seen active xx</span></pre><p id="fa0b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这是前所未见的，所以我开始寻求谷歌搜索的帮助。</p><p id="dde6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">第一篇文章已经:<a class="ae iu" href="https://developers.redhat.com/blog/2019/11/13/pod-lifecycle-event-generator-understanding-the-pleg-is-not-healthy-issue-in-kubernetes" rel="noopener ugc nofollow" target="_blank">https://developers . red hat . com/blog/2019/11/13/pod-life cycle-event-generator-understanding-the-pleg-is-not-healthy-issue-in-kubernetes</a></p><p id="7809" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这篇文章技术性很强，阅读和理解起来很酷，它解释了什么是PLEG及其背后的源代码。多亏了它，你可能明白为什么下面的问题会带来<code class="du ju jv jw jx b">PLEG is not healty.</code></p><p id="7ca8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">所以更好地搜索，我在GitHub/Reddit上看到了不止一两个问题:</p><ul class=""><li id="b057" class="kd ke hi ix b iy iz jc jd jg kf jk kg jo kh js ki kj kk kl bi translated">CNI/网络问题—旧版本—缺少IP</li><li id="30c5" class="kd ke hi ix b iy km jc kn jg ko jk kp jo kq js ki kj kk kl bi translated">由于特定的工作负载/自动扩展，在同一节点中调度的大量pod经常<code class="du ju jv jw jx b">created/terminated</code></li><li id="01b5" class="kd ke hi ix b iy km jc kn jg ko jk kp jo kq js ki kj kk kl bi translated">docker守护程序/容器的重新启动—版本不匹配…</li><li id="db7a" class="kd ke hi ix b iy km jc kn jg ko jk kp jo kq js ki kj kk kl bi translated">已装入卷的问题</li><li id="e002" class="kd ke hi ix b iy km jc kn jg ko jk kp jo kq js ki kj kk kl bi translated">其他原因一如既往..</li></ul><p id="29c8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">因此，我使用以下代码查看了EKS是否有新版本的CNI:</p><figure class="jz ka kb kc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lj"><img src="../Images/0d047a8aebf632c9f0b9c208a1db3c0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S5gfyj0dTREPAJSxclBgxA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Ref: <a class="ae iu" href="https://docs.aws.amazon.com/eks/latest/userguide/managing-vpc-cni.html" rel="noopener ugc nofollow" target="_blank">https://docs.aws.amazon.com/eks/latest/userguide/managing-vpc-cni.html</a></figcaption></figure><p id="c7db" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我使用的正是这里提到的版本。<br/>与此同时，我试图查看工作节点日志、EC2实例状态/监控、VPC配置以及我能想到的一切。</p><figure class="jz ka kb kc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lk"><img src="../Images/14e9b5122dbeb8bc0676f88138cf57f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*TNuXm5cjz5BS1IQ6"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Photo by <a class="ae iu" href="https://unsplash.com/@helloimnik?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Hello I'm Nik</a> on <a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="64d7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在某种程度上，我决定尝试一种不同的方法来比较一个<code class="du ju jv jw jx b">Healthy/NotHealhty</code>节点。<br/>该问题发生在两个完全不同的集群中，很明显，该问题仅在<code class="du ju jv jw jx b">cluster-autoscaler.</code>要求的<code class="du ju jv jw jx b">new worker nodes</code>给出</p><p id="3c23" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">所以我决定更仔细地看看<code class="du ju jv jw jx b">NodeGroup</code>和节点的系统信息:</p><pre class="jz ka kb kc fd ky jx kz la aw lb bi"><span id="ccd5" class="lc ld hi jx b fi le lf l lg lh">kubectl describe node &lt;NODE_NAME&gt; | grep -A 10 "System Info"</span><span id="284a" class="lc ld hi jx b fi ll lf l lg lh">System Info:   <br/>Machine ID:                 xxx   <br/>System UUID:                xxx   <br/>Boot ID:                    xxx   <br/>Kernel Version:             5.4.217-126.408.amzn2.x86_64   <br/>OS Image:                   Amazon Linux 2   <br/>Operating System:           linux   <br/>Architecture:               amd64   <br/>Container Runtime Version:  docker://20.10.17   <br/>Kubelet Version:            v1.21.14-eks-ba74326   Kube-Proxy Version:         v1.21.14-eks-ba74326</span></pre><p id="1803" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一个<code class="du ju jv jw jx b">Healthy/NotHealhty</code>节点之间的一切都是一样的。</p><p id="ec85" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在某种程度上，我想到了工作节点中使用的AMI。<br/> AWS经常为EKS工作节点发布新的AMI，最近一次发布AMI是在27/10/22。</p><figure class="jz ka kb kc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lm"><img src="../Images/8f603005cf953dd644bc891a212c865c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CY-1elI63a-EeC0NYrh8kQ.png"/></div></div></figure><p id="261c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">仔细观察，我发现遇到这个问题的两个工作节点使用的是同一个AMI。</p><pre class="jz ka kb kc fd ky jx kz la aw lb bi"><span id="d9ca" class="lc ld hi jx b fi le lf l lg lh">Name: amazon-eks-node-1.21-v20221027<br/>ID: ami-00c00a9bbe9b9301a</span></pre><p id="7a3e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">那怎么办呢？</p><ol class=""><li id="01e9" class="kd ke hi ix b iy iz jc jd jg kf jk kg jo kh js ln kj kk kl bi translated">回滚到以前的工作版本</li><li id="7474" class="kd ke hi ix b iy km jc kn jg ko jk kp jo kq js ln kj kk kl bi translated">筹集AWS的门票</li></ol><p id="a322" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">几个小时后，我从AWS支持中心回来了:</p><figure class="jz ka kb kc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lo"><img src="../Images/e23633a6294d5e4ffee27498596ce1ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Dfg1RMTY1VX_LIj3-0vbXA.png"/></div></div></figure><p id="e8ef" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">所以这个问题就是AMI。</p><h1 id="e602" class="lp ld hi bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">看了这个回复我的感觉很不好…</h1><p id="4246" class="pw-post-body-paragraph iv iw hi ix b iy mm ja jb jc mn je jf jg mo ji jj jk mp jm jn jo mq jq jr js hb bi translated">为什么没有人就这样的问题发送通知？</p></div><div class="ab cl kr ks gp kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="hb hc hd he hf"><p id="6e80" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="jt">“如果一棵树倒在森林里，没有人听到，它会发出声音吗？<br/>贝克莱认为物体只有在被感知时才存在。因此，如果一棵树在森林里倒下，没有人听到，它不会发出任何声音。‘</em></p></div><div class="ab cl kr ks gp kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="hb hc hd he hf"><p id="75aa" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">好好看我发现破版已经<br/> <code class="du ju jv jw jx b">[RECALLED] AMI Release v20221027</code></p><p id="0fc9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">..而且Github上还有一个官方问题:<a class="ae iu" href="https://github.com/awslabs/amazon-eks-ami/issues/1071" rel="noopener ugc nofollow" target="_blank"><em class="jt">https://github.com/awslabs/amazon-eks-ami/issues/1071</em></a></p><figure class="jz ka kb kc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mr"><img src="../Images/863b95f945b81e9a0bbde058d80df0a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c1LrNUlBXhYHB_HlYy0B6g.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx"><a class="ae iu" href="https://github.com/awslabs/amazon-eks-ami/releases" rel="noopener ugc nofollow" target="_blank">https://github.com/awslabs/amazon-eks-ami/releases</a></figcaption></figure><p id="9798" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我希望有人能从这篇博文中得到一些帮助，支持我的你可以<strong class="ix hj">c<em class="jt">lap</em></strong><em class="jt">&amp;</em><strong class="ix hj"><em class="jt">subscribe</em></strong><em class="jt"/>在接下来的几周得到更多<em class="jt">！</em></p></div><div class="ab cl kr ks gp kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="hb hc hd he hf"><figure class="jz ka kb kc fd ij er es paragraph-image"><div class="er es ms"><img src="../Images/5e942234f579c9081df2fc372dab8480.png" data-original-src="https://miro.medium.com/v2/resize:fit:1080/format:webp/1*BOuMEt5xHDy0yZE6mtKsFA.png"/></div></figure><blockquote class="mt"><p id="34d5" class="mu mv hi bd mw mx my mz na nb nc js dx translated"><a class="ae iu" href="https://pie-r.medium.com/" rel="noopener">关注我</a>和<a class="ae iu" href="https://pie-r.medium.com/subscribe" rel="noopener">订阅</a>来获取这个系列和下一个系列的更新！</p></blockquote></div></div>    
</body>
</html>