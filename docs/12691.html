<html>
<head>
<title>Netlify Identity protects Ably apps from hackers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">网络身份巧妙地保护应用程序免受黑客攻击</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/netlify-identity-protects-ably-apps-from-hackers-f1a9291231f6?source=collection_archive---------20-----------------------#2022-05-26">https://medium.com/geekculture/netlify-identity-protects-ably-apps-from-hackers-f1a9291231f6?source=collection_archive---------20-----------------------#2022-05-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/82b2b1bd84f5b0e4ea44fc17231ef317.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fhlmLOUTL3ZfGN6awuxC3w.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Authentication server with JWT and Netlify Identity</figcaption></figure><p id="5b28" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">几周前，我在Slack的内部支持频道上看到了这条消息，这让我很恼火。所以我停下来看了看，因为我们最不希望的就是顾客被利用。</p><p id="08c1" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">客户已回复703762824票据名称:xxxxxxxxxxxxxxxx-API密钥安全漏洞优先级:票据描述:由于……指示的安全报告而产生的票据，联系客户，让他们知道并采取行动，因为他们的API密钥暴露在Wayback机器中，并且仍然有效。</p><p id="0ae1" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">互联网上有人厚颜无耻地从你的账户上揩油，用光你的每月配额。更重要的是:你可能不知道它正在发生。</p><h1 id="eedd" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">如何确保你的应用程序被黑客攻击</h1><p id="4a8e" class="pw-post-body-paragraph iu iv hi iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">登录Ably，复制你的应用程序的API密钥并粘贴到你的代码中，就像这样:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="de91" class="le jt hi la b fi lf lg l lh li">const ably = new Ably.Realtime('aBCdeFg.ABcDEfG:abc123def456...789xyz');</span></pre><p id="004b" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">然后将这一行代码提交到git存储库，将其部署到生产环境中，wayback机器会将其冻结在琥珀中。就这么简单。它会在那里等待，直到一个热切的小哈比人在黑暗中找到它。您宝贵的sssss API密钥将会落入他人之手。</p><p id="0f75" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">幸运的是，在Ably，我们监控认证密钥泄漏并联系客户。</p><p id="fc6d" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">基本认证就像一个猫扑——任何一只老猫都可以进入你的房子。令牌认证就像那些有芯片阅读器的人一样:只有符合芯片编程的VIP客人名单的酷猫才能通过flap测试并进入。</p><h1 id="fa70" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">使用网络功能保护您的应用</h1><p id="4cb4" class="pw-post-body-paragraph iu iv hi iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">本文向您展示了如何毫不费力地设置令牌认证。我们将使用一个<a class="ae lj" href="https://docs.netlify.com/functions/overview/" rel="noopener ugc nofollow" target="_blank"> Netlify函数</a>创建一个端点，让您可以这样做。</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="aec5" class="le jt hi la b fi lf lg l lh li">const authUrl = ".netlify/functions/ably-jwt?id={user-id}";<br/>const ably = new Ably.Realtime({ authUrl });</span></pre><p id="34b2" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这看起来很棒，哪里都没有API，但是是什么阻止了互联网上的人获取认证URL并在其他地方使用它呢？没什么能阻止他们。令牌认证将隐藏API密钥，但仅此还不够。</p><p id="985a" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我们还需要一种只向合法用户发放令牌的方法。这就是Netfliy的用武之地，我们可以将他们的<a class="ae lj" href="https://docs.netlify.com/visitor-access/identity/" rel="noopener ugc nofollow" target="_blank">身份服务</a>与无服务器功能结合使用，这包括在免费层计划中(本文撰写时)。</p><h1 id="6457" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">TL；速度三角形定位法(dead reckoning)</h1><p id="af96" class="pw-post-body-paragraph iu iv hi iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">如果你只是想了解如何建立自己的Netlify应用程序，而不需要所有的解释，那就去看看<a class="ae lj" href="https://github.com/ably-labs/netlify-identity-auth" rel="noopener ugc nofollow" target="_blank"> ably-labs Github repo </a>，这里的README是这篇文章的浓缩版。</p><p id="e258" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">提醒</strong>:你会需要这些平台上的账号:<a class="ae lj" href="https://ably.com/sign-up" rel="noopener ugc nofollow" target="_blank">巧妙地</a>、<a class="ae lj" href="https://github.com" rel="noopener ugc nofollow" target="_blank"> Github </a>和<a class="ae lj" href="https://app.netlify.com/signup?ably-realtime" rel="noopener ugc nofollow" target="_blank"> Netlify </a>。</p><p id="369e" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">如果你只对经历实现步骤感兴趣，那就往下跳<a class="ae lj" href="#okay-okay-enough-lets-ship-it" rel="noopener ugc nofollow"> <strong class="iw hj">好了好了，够了……出货吧！</strong>T11】</a></p><h1 id="9bdf" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">什么是“巧妙地”JWT代币？</h1><blockquote class="lk ll lm"><p id="176d" class="iu iv ln iw b ix iy iz ja jb jc jd je lo jg jh ji lp jk jl jm lq jo jp jq jr hb bi translated">JSON Web Token (JWT)是一个开放标准(<a class="ae lj" href="https://tools.ietf.org/html/rfc7519" rel="noopener ugc nofollow" target="_blank"> RFC 7519 </a>)，它定义了一种紧凑且独立的方式，以JSON对象的形式在各方之间安全地传输信息。</p></blockquote><p id="bfef" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><em class="ln">(摘自</em><a class="ae lj" href="https://jwt.io/introduction/" rel="noopener ugc nofollow" target="_blank"><em class="ln">https://jwt.io/introduction/</em></a><em class="ln">)</em></p><p id="d247" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">通常，编码的JWT令牌如下所示:</p><figure class="kv kw kx ky fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lr"><img src="../Images/44788d3b54338e3d6a30f648feebba35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*frQXlSLkuasMSHOqF12IpA.png"/></div></div></figure><p id="8eea" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><em class="ln">试试看这里</em><a class="ae lj" href="https://jwt.io/" rel="noopener ugc nofollow" target="_blank"><em class="ln">https://jwt.io/</em></a><em class="ln">—民间制作于</em> <a class="ae lj" href="https://auth0.com/" rel="noopener ugc nofollow" target="_blank"> <em class="ln"> auth0 </em> </a></p><p id="8c23" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">令牌认证是安全的，原因有二:JWT令牌是数字签名的，并且定期过期。此外，每当令牌刷新时，您可以监控谁在使用您的应用程序。当JWT过期时，用户将通过您的验证服务器进行路由，您可以选择是否重新颁发他们的令牌。</p><p id="0dde" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">一个干练的JWT严格地说并不是一个干练地构造的，而是一个被构造成与干练地兼容的JWT。如果你想详细了解它是如何工作的，我们的<a class="ae lj" href="https://ably.com/documentation/best-practice-guide" rel="noopener ugc nofollow" target="_blank">最佳实践指南</a>将涵盖一切。</p><h1 id="baf7" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">Netlify无服务器功能和身份工作流</h1><p id="6da4" class="pw-post-body-paragraph iu iv hi iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">在我们的示例应用程序中，新用户需要注册并确认他们的电子邮件地址来激活自己，然后才能登录。登录时，我们用网络身份验证他们，并检查他们是否被标记为<strong class="iw hj">禁止</strong>。坏演员是不会得到JWT代币的。合法用户被颁发一个令牌，以便进行身份验证，并且auth URL中包含他们唯一的id。</p><figure class="kv kw kx ky fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ls"><img src="../Images/4d64e29f334c11718a58a69bf20079ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KYofK59iGTA9CTTsKAqkBQ.png"/></div></div></figure><p id="57c0" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">(1)用户登录(2)检查用户身份-有效用户获得JWT令牌并继续使用应用程序，无效用户被拒绝(3)使用令牌，等待其过期，然后重复。</p><p id="6059" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">网络身份允许我们通过编辑与用户帐户相关联的元数据来管理用户。标记一个坏演员就是通过Netlify仪表板给他们分配一个角色。</p><h1 id="0d23" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">作为无服务器功能的JWT令牌</h1><p id="1628" class="pw-post-body-paragraph iu iv hi iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">我们的JWT端点的关键部分是这个代码片段。不管你使用什么平台，这部分都是一样的。这是Ably JWT令牌的剖析，它不同于标准的JWT，因为我们需要在数据有效载荷中添加额外的键/值。</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="e970" class="le jt hi la b fi lf lg l lh li">function generateAblyJWT(props) {<br/>  const { apiKey, clientId, capability, ttlSeconds } = props;</span><span id="906b" class="le jt hi la b fi lt lg l lh li">  const [appId, keyId, keySecret] = apiKey.split(/[\.\:]/g);<br/>  const keyName = `${appId}.${keyId}`;</span><span id="5083" class="le jt hi la b fi lt lg l lh li">  const typ = "JWT"; // type<br/>  const alg = "HS256"; // algorithm sha256<br/>  const kid = keyName; // appId + keyId</span><span id="c629" class="le jt hi la b fi lt lg l lh li">  const currentTime = Math.floor(Date.now() / 1000);<br/>  const iat = currentTime; // initiated at (seconds)<br/>  const exp = currentTime + ttlSeconds; // expire after</span><span id="757f" class="le jt hi la b fi lt lg l lh li">  const header = { typ, alg, kid };<br/>  const claims = {<br/>    iat,<br/>    exp,<br/>    "x-ably-capability": capability,<br/>    "x-ably-clientId": clientId,<br/>  };</span><span id="b51c" class="le jt hi la b fi lt lg l lh li">  const base64Header = encryptObject(header);<br/>  const base64Claims = encryptObject(claims);</span><span id="f135" class="le jt hi la b fi lt lg l lh li">  const token = `${base64Header}.${base64Claims}`;<br/>  const signature = b64(SHA256(token, keySecret));</span><span id="f527" class="le jt hi la b fi lt lg l lh li">  const jwt = `${token}.${signature}`;</span><span id="0dda" class="le jt hi la b fi lt lg l lh li">  console.log({ header, claims, signature, jwt });<br/>  return jwt;<br/>}</span></pre><p id="1c49" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><code class="du lu lv lw la b">generateAblyJWT</code>函数与您通读Ably文档中关于<a class="ae lj" href="https://ably.com/documentation/core-features/authentication#ably-jwt" rel="noopener ugc nofollow" target="_blank">认证方法</a>的函数几乎相同。我们选择Netlify作为本文的平台，但是同样的想法可以应用于任何公开无服务器端点的平台。例如，你可以用一个<a class="ae lj" href="https://developers.cloudflare.com/pages/platform/functions" rel="noopener ugc nofollow" target="_blank"> <strong class="iw hj"> Cloudflare </strong>函数</a>，一个<a class="ae lj" href="https://runkit.com/home#endpoint" rel="noopener ugc nofollow" target="_blank"> <strong class="iw hj"> Runkit </strong>端点</a>，或者一个<a class="ae lj" href="https://www.heroku.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="iw hj"> Heroku </strong> dyno </a>来做同样的事情...等等。本质上，您可以使用任何在响应有效负载交付后“唤醒”、运行代码并进入休眠状态的服务。</p><h1 id="f91a" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">使用网络身份验证我们的用户</h1><p id="4cc6" class="pw-post-body-paragraph iu iv hi iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">下一个函数负责两件事。首先，它是端点本身，所以我们的认证URL将执行这个功能。其次，它与<a class="ae lj" href="https://docs.netlify.com/visitor-access/identity/" rel="noopener ugc nofollow" target="_blank">网络身份</a>连接，以验证调用端点的用户是否可信。</p><p id="9766" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我想请你注意下面突出显示的代码行。这是我们将用来获取具有该id的用户的Netlify端点。<strong class="iw hj"> id </strong>的值来自querystring，我们用它“烘焙”成我们的Ably JWT，作为<code class="du lu lv lw la b">clientId</code>属性。这意味着Ably和Netlify在它们各自的审计日志中将有相同的id 。</p><p id="9229" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">Netlify Identity的优点在于，一旦激活它，端点处理程序中的第二个参数就会有一个填充的用户上下文对象，这就是我们将前端客户端与底层后端连接起来的方式。</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="1e7d" class="le jt hi la b fi lf lg l lh li">const axios = require("axios");<br/>const generateAblyJWT = require("./generate-ably-jwt.js");</span><span id="b217" class="le jt hi la b fi lt lg l lh li">exports.handler = async function (event, context) {<br/>  const { queryStringParameters } = event;<br/>  const { id } = queryStringParameters || {};<br/>  const { clientContext } = context || {};</span><span id="db1d" class="le jt hi la b fi lt lg l lh li">  console.log({ queryStringParameters });<br/>  console.log({ clientContext });</span><span id="6f8a" class="le jt hi la b fi lt lg l lh li">  const { identity } = context.clientContext || {};<br/>  const { token, url } = identity || {};</span><span id="4468" class="le jt hi la b fi lt lg l lh li">  const userUrl = `${url}/admin/users/${id}`;  &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;<br/>  const Authorization = `Bearer ${token}`;</span><span id="2fd8" class="le jt hi la b fi lt lg l lh li">  console.log({ identity, id, token, url, userUrl, Authorization });</span><span id="68cb" class="le jt hi la b fi lt lg l lh li">  let response;</span><span id="3a13" class="le jt hi la b fi lt lg l lh li">  /*</span><span id="b78b" class="le jt hi la b fi lt lg l lh li">    We Use client context and querystring ID value<br/>    to check the user exists by retrieving their<br/>    User Identity object.</span><span id="ac65" class="le jt hi la b fi lt lg l lh li">    Then we inspect that accounts metadata for role flags,<br/>    which are added via the Identity dashboard,<br/>    if it contains "Banned" we do not reissue the token</span><span id="e4a3" class="le jt hi la b fi lt lg l lh li">  */</span><span id="2349" class="le jt hi la b fi lt lg l lh li">  await axios<br/>    .get(userUrl, { headers: { Authorization } })<br/>    .then(({ data }) =&gt; {<br/>      console.log("Success! User identity", data);</span><span id="c909" class="le jt hi la b fi lt lg l lh li">      const banned = /^banned/i;<br/>      const { roles = [] } = data.app_metadata;<br/>      const reject = roles.some((item) =&gt; banned.test(item));</span><span id="b5eb" class="le jt hi la b fi lt lg l lh li">      // delegate the error message to the catch clause.<br/>      if (reject) throw new Error(`User with id [${id}] has been banned`);</span><span id="7083" class="le jt hi la b fi lt lg l lh li">      const settings = {<br/>        clientId: id,<br/>        apiKey: process.env.ABLY_APIKEY,<br/>        capability: process.env.ABLY_CAPABILITY,<br/>        ttlSeconds: Number(process.env.ABLY_TTLSECONDS),<br/>      };</span><span id="5582" class="le jt hi la b fi lt lg l lh li">      response = {<br/>        statusCode: 200,<br/>        body: generateAblyJWT(settings),<br/>        headers: { "Content-Type": "application/jwt" },<br/>      };<br/>    })<br/>    .catch((error) =&gt; {<br/>      console.log("Failed to get user!");<br/>      response = {<br/>        statusCode: 500,<br/>        body: `Internal Error: ${error}`,<br/>        headers: { "Content-Type": "text/plain" },<br/>      };<br/>    });</span><span id="8734" class="le jt hi la b fi lt lg l lh li">  console.log("response payload", response);<br/>  return response;<br/>};</span></pre><p id="6523" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">导出的处理函数是<a class="ae lj" href="https://docs.netlify.com/functions/build-with-javascript/" rel="noopener ugc nofollow" target="_blank"> Netlify的《hello world》教程</a>的修改版。唯一的主要变化是:它与Identity集成在一起，并且返回(又名response)具有标题“Content-Type: application/jwt ”,示例主体最初是(JSON object ),现在是一个字符串。</p><p id="41a4" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">除了这两个主要函数之外，还有额外的样板代码来加载加密库，<a class="ae lj" href="https://www.npmjs.com/package/cryptojs" rel="noopener ugc nofollow" target="_blank"> CryptoJS </a>。哦，确保<strong class="iw hj">到期时间</strong>被转换为数字()。如果有任何不正确的地方，实时网络将提供一个诊断错误信息。</p><h1 id="2004" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">前端设置的摘要</h1><figure class="kv kw kx ky fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lx"><img src="../Images/881802ec5d01e74adfe10e186513d608.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T3CGXNtoXjpNpQQS2DdjMA.png"/></div></div></figure><p id="2f68" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">执行注册、登录和密码提醒操作的模态弹出窗口由一个<strong class="iw hj"> div </strong>和一个来自Netlify: <a class="ae lj" href="https://identity.netlify.com/v1/netlify-identity-widget.js" rel="noopener ugc nofollow" target="_blank"> Identity小部件</a>的JavaScript控制。</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="8e8a" class="le jt hi la b fi lf lg l lh li">&lt;main&gt;<br/>  &lt;div&gt;<br/>    &lt;a href="https://ably.com/" target="_blank"&gt;<br/>      &lt;img src="images/motif-red.svg?netlify-identity-jwt"<br/>        alt="Ably logo" /&gt;&lt;/a&gt;<br/>    &lt;h1&gt;<br/>      Ably JWT Authentication &lt;br /&gt;<br/>      using Netlify Identity and &lt;br /&gt;<br/>      serverless functions<br/>    &lt;/h1&gt;</span><span id="0363" class="le jt hi la b fi lt lg l lh li">    &lt;div data-netlify-identity-menu&gt;&lt;/div&gt; &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span><span id="f3fc" class="le jt hi la b fi lt lg l lh li">    &lt;span class="container"&gt;<br/>      &lt;button onclick="go(this)"&gt;authenticate&lt;/button&gt;<br/>      &lt;strong class="message"&gt;&lt;/strong&gt;<br/>    &lt;/span&gt;<br/>  &lt;/div&gt;<br/>&lt;/main&gt;</span></pre><p id="ec75" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">并且<strong class="iw hj">认证</strong>按钮执行该功能…</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="1cbc" class="le jt hi la b fi lf lg l lh li">function go(el) {<br/>  /*<br/>    get the user id from localstorage.<br/>    This is only created once the user logs in<br/>  */<br/>  const user = localStorage.getItem("gotrue.user") || null;</span><span id="77d3" class="le jt hi la b fi lt lg l lh li">  if (!user) {<br/>    showMessage("Can't access user ID, please log in first.");<br/>    return null;<br/>  }</span><span id="c72b" class="le jt hi la b fi lt lg l lh li">  /*<br/>     Add the User's identity ID to the authURL<br/>     to ensure the Ably token refresh has that credential<br/>     we are binding the authURL and the user<br/>  */</span><span id="f8d9" class="le jt hi la b fi lt lg l lh li">  const { id } = JSON.parse(user);<br/>  const { origin } = window.location;<br/>  const authUrl = `${origin}/.netlify/functions/ably-jwt?id=${id}`;</span><span id="b254" class="le jt hi la b fi lt lg l lh li">  console.log({ authUrl });</span><span id="de77" class="le jt hi la b fi lt lg l lh li">  window.ably = new Ably.Realtime({ authUrl });<br/>  window.ably.connection.on(handleConnection(el));<br/>}</span></pre><p id="a519" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">URL再次突出显示。这个值加上用户的ID用于将客户端连接到Ably realtime。发生这种情况时，根据环境变量中设置的TTL值，开始倒计时。当它过期时，URL(现在存储在Ably realtime中)将用于请求更新的令牌。</p><h1 id="0918" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">好了，好了，够了…出货吧！</h1><h1 id="2a44" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">准备</h1><p id="4812" class="pw-post-body-paragraph iu iv hi iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">我们需要做的第一件事是准备各自的平台。在这里，我们<a class="ae lj" href="https://ably.com/login" rel="noopener ugc nofollow" target="_blank">登录到我们的Ably帐户</a>并创建一个新的应用程序，稍后我们将需要API密钥。然后我们把回购从Ably Labs转到你自己的仓库。我们需要这样做，以便Netlify可以在下一步中导入我们的项目。</p><figure class="kv kw kx ky fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ly"><img src="../Images/adca74517cad83f5f314a0e9eda9ec81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*Dr02SDEwYUEkvX7fn29Z4w.gif"/></div></div></figure><h1 id="dc02" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">部署和设置网络服务</h1><p id="0e82" class="pw-post-body-paragraph iu iv hi iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">现在我们可以将源代码从Github导入Netlify，并部署应用程序。当应用程序启动并运行时，我们会遇到一些需要纠正的错误。当我们解决这些问题时，你将会对网络生活的工作原理有更多的了解。</p><figure class="kv kw kx ky fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ly"><img src="../Images/8fcea39f196770904351e23a65a89d50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*wRRtV88as1CrIqYmk2sJCg.gif"/></div></div></figure><p id="e12f" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">为了调节谁被允许使用我们的应用程序，我们需要一个用户注册过程。Netlify提供了一个非常好的小部件来创建用户，让他们登录，甚至发送密码提醒。此外，您可以使用SSO登录服务，如Google、Github等。对于这个项目，我用基本的电子邮件注册。在开始注册之前，您需要在仪表板中激活Netlify身份服务。</p><p id="4e20" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">用户只有在确认了他们的电子邮件地址后才被认为是有效的。如果您愿意，可以绕过这种完整性检查。用户完成确认后，您将看到该身份出现在控制面板中，并且您将能够编辑他们的元数据。</p><p id="559c" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">所以我们注册了一个用户，并使用他们的凭证登录，但是当我们尝试连接到Ably realtime时，仍然会看到一个错误。这是因为我们没有添加API键。</p><h1 id="2021" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">添加环境变量</h1><p id="bcf9" class="pw-post-body-paragraph iu iv hi iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">我们通过添加环境变量、重新部署应用程序和测试用户帐户的有效性来完成这个过程。在这一阶段，您应该最终看到authenticate按钮变成绿色，这表明该用户获得了一个JWT令牌，并成功连接到Ably realtime网络。</p><figure class="kv kw kx ky fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ly"><img src="../Images/e69c9abdfdf10e7f3834b96348793ff9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*K5p4qUY8pBs8GmJhsfgCEA.gif"/></div></div></figure><p id="ab9b" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">Key</strong><strong class="iw hj">Type</strong><strong class="iw hj">Description</strong>ABLY _ API Key String您Ably App的App ABLY _ CAPABILITY String或Null JSON string of permissions例如<code class="du lu lv lw la b">{"channel-name":["subscribe"]}</code> ABLY_TTLSECONDS数刷新率以秒为单位例如3600 (60sec)</p><p id="7cb1" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">能力</strong>与Ably APP权限相关。</p><p id="3def" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">您可能希望将操作限制为只订阅。要细化权限，请参考我们的文档:<a class="ae lj" href="https://ably.com/documentation/core-features/authentication#capabilities-explained" rel="noopener ugc nofollow" target="_blank">功能说明</a>。在本例中，<code class="du lu lv lw la b">{"channel-name": ["subscribe", "publish"]}</code>表示状态频道拥有<em class="ln">发布</em>和<em class="ln">订阅</em>权限。</p><p id="2fc1" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这个演示应用程序不使用通道，它的目的是测试身份验证，但是JWT需要在生成JWT时分配该值。</p><h1 id="517b" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">用户审核</h1><p id="e93d" class="pw-post-body-paragraph iu iv hi iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">在最后一部分中，我们将假设我们的主用户不再受欢迎，在Identity部分编辑他们的元数据，并在role属性中添加“Banned”。从那时起，我们的应用程序将拒绝向该特定用户重新发布JWT。</p><figure class="kv kw kx ky fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ly"><img src="../Images/2b5063d79eacb1538be75b2f6ad30576.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*ln99p7cG-Wb7Oaq8sknYsA.gif"/></div></div></figure><h1 id="fe77" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">结论</h1><p id="4d8d" class="pw-post-body-paragraph iu iv hi iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">现在，您对Ably的内部工作有了更多的了解，我们的团队积极地检查API密钥泄漏。外部标志确实会弹出来，如果有些东西看起来很奇怪，或者有潜在的危险，我们就会伸出援手。我们非常重视安全性，无论怎样推荐令牌认证都不为过。</p><p id="cccd" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在本文中，我们介绍了如何使用Netlify的免费层产品设置身份验证服务器，如何与身份服务集成，并展示了身份验证端点是多么简单。安全和适度控制确实值得努力。</p><p id="1044" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">有了Netlify，整个开发者体验都很顺畅，从入职到链接Github、导入项目和部署到生产。我唯一的慢下来的地方是将仪表板设置(UI值)转移到netlify.toml中，以确保使用这个repo的任何人都能获得同样简单的体验。</p><p id="6a07" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">TOML引导加载我的默认值，它标识了函数的位置和网站文件的位置。还有一个小问题。弄清楚如何为响应头创建应用程序/jwt内容类型。最初我使用的是纯文本(这就是JWT字符串)，但在这种情况下，标题必须将类型标识为“JWT”。</p><p id="a7d2" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">最后，我想说一下这个演示的开发过程。大部分工作都是使用Netlify CLI完成的，这是一款优秀的开发工具。它完美地模拟了无服务器环境，但是使用Identify要求您在线完成开发。我发现了一个关于提供给端点处理程序的上下文对象的错误，它总是缺少用户上下文。这一点在关于身份的Netlify文档中得到了强调，他们清楚地表明身份需要HTTPS，但是我错过了这一点，一天的大部分时间里我都闷闷不乐。(脸红)看文档！</p><h1 id="2fac" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">清理和拆卸</h1><p id="41e2" class="pw-post-body-paragraph iu iv hi iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">当您完成演示时，请确保通过密钥撤销或删除应用程序来安全地删除它。？</p><p id="61ef" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在最后这张GIF中，我们讨论了三件事:撤销一个API密钥(如果你已经受到威胁),这保留了应用程序，但破坏了密钥。完全删除应用程序，这将永久破坏与该应用程序相关的所有内容，最后是如何删除Netlify实例。</p><figure class="kv kw kx ky fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ly"><img src="../Images/fcb661e24087651ff7b043554937a545.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*KkgbfPbexzlFlEyb639nuQ.gif"/></div></div></figure></div><div class="ab cl lz ma gp mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="hb hc hd he hf"><h1 id="aaf7" class="js jt hi bd ju jv mg jx jy jz mh kb kc kd mi kf kg kh mj kj kk kl mk kn ko kp bi translated">简单地说</h1><p id="2126" class="pw-post-body-paragraph iu iv hi iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">巧妙地提供API来实现应用程序中实时特性的<a class="ae lj" href="https://ably.com/topic/pub-sub" rel="noopener ugc nofollow" target="_blank">发布/订阅</a>消息。您还可以获得现成的全球分布式可扩展基础架构，以及一套服务。</p><p id="c576" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这些功能包括像<a class="ae lj" href="https://ably.com/documentation/core-features/presence" rel="noopener ugc nofollow" target="_blank">出席</a>？其中显示了各种参与者的在线/离线状态、<a class="ae lj" href="https://knowledge.ably.com/connection-state-recovery" rel="noopener ugc nofollow" target="_blank">在间歇性网络问题的情况下自动重新连接和恢复消息</a>、<a class="ae lj" href="https://ably.com/four-pillars-of-dependability#integrity" rel="noopener ugc nofollow" target="_blank">消息排序和保证交付</a>，以及<a class="ae lj" href="https://ably.com/integrations" rel="noopener ugc nofollow" target="_blank">与第三方API</a>集成的简单方法。能够启用发布/订阅消息，主要通过<a class="ae lj" href="https://ably.com/topic/websockets" rel="noopener ugc nofollow" target="_blank"> WebSockets </a>。</p><p id="870f" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><a class="ae lj" href="https://ably.com/documentation/core-features/channels" rel="noopener ugc nofollow" target="_blank">通道</a>的概念允许您对数据进行分类，并决定哪些组件可以访问哪些通道。您还可以为这些通道上的各种参与者指定<a class="ae lj" href="https://ably.com/documentation/core-features/authentication#capabilities-explained" rel="noopener ugc nofollow" target="_blank">功能</a>，如仅发布、仅订阅、消息历史等。</p><p id="c0c2" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><a class="ae lj" href="https://ably.com/" rel="noopener ugc nofollow" target="_blank">了解更多关于Ably平台的信息</a></p></div><div class="ab cl lz ma gp mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="hb hc hd he hf"><h1 id="49cc" class="js jt hi bd ju jv mg jx jy jz mh kb kc kd mi kf kg kh mj kj kk kl mk kn ko kp bi translated">限制暴露的工具</h1><p id="e076" class="pw-post-body-paragraph iu iv hi iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated"><a class="ae lj" href="https://www.gitguardian.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="iw hj"> gitguardian </strong> </a>对你的源代码保密。它扫描您的源代码，以实时检测API密钥、密码、证书、加密密钥和其他敏感数据</p><p id="48b8" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><a class="ae lj" href="https://github.blog/changelog/2020-12-15-github-actions-environments-environment-protection-rules-and-environment-secrets-beta/" rel="noopener ugc nofollow" target="_blank"><strong class="iw hj">GitHub Actions</strong></a>—对环境保护规则和环境秘密(beta)非常有用</p><p id="e549" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><a class="ae lj" href="https://docs.github.com/en/code-security/secret-scanning/secret-scanning-partners" rel="noopener ugc nofollow" target="_blank"><strong class="iw hj">GitHub Secret Scanning Partners</strong></a>—列出支持的机密以及GitHub与之合作的合作伙伴，以防止对意外提交的机密进行欺诈性使用。</p><p id="a92e" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><a class="ae lj" href="https://git-scm.com/docs/gitignore" rel="noopener ugc nofollow" target="_blank"> <strong class="iw hj">全局。gitignore </strong> </a> —项目。gitignore文件是众所周知的，鲜为人知的更重要的<code class="du lu lv lw la b">.gitignore</code>文件可以在您的机器上建立并应用到您跟踪的每个git存储库中。<code class="du lu lv lw la b">git config --global core.excludesfile ~/.gitignore_global</code></p><p id="5901" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">JSON web token<a class="ae lj" href="https://jwt.io/" rel="noopener ugc nofollow" target="_blank"><strong class="iw hj"/></a>(JWT)和测试工具。</p></div></div>    
</body>
</html>