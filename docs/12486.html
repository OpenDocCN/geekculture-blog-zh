<html>
<head>
<title>YOLOv4 inference using OpenCV-DNN-CUDA on Windows</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Windows环境下基于OpenCV-DNN-CUDA的YOLOv4推理</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/yolov4-inference-using-opencv-dnn-cuda-on-windows-e7ca995bcacd?source=collection_archive---------5-----------------------#2022-05-15">https://medium.com/geekculture/yolov4-inference-using-opencv-dnn-cuda-on-windows-e7ca995bcacd?source=collection_archive---------5-----------------------#2022-05-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/12f64343ceb8f4f91a530e80c3950431.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6xQnpzseGw2towdOf9oHcw.png"/></div></div></figure><h1 id="4213" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">在Windows上使用OpenCV-DNN-CUDA模块运行YOLOv4推理。</h1><p id="fce4" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">在之前的博客<a class="ae km" href="https://techzizou.com/setup-opencv-dnn-cuda-module-for-windows/" rel="noopener ugc nofollow" target="_blank">“设置支持CUDA后端的OpenCV-DNN模块(用于Windows)”</a>中，我们在Windows上构建了支持CUDA后端的OpenCV-DNN模块。我们可以使用这个OpenCV模块在对象检测模型上运行推理。与没有CUDA后端的OpenCV相比，使用CUDA后端支持构建的OpenCV-DNN模块给出了更快的推断。我们需要做的就是将下面两行代码添加到我们的代码中，并使用它来推断模型。</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="f999" class="kw ir hi ks b fi kx ky l kz la">net.setPreferableBackend(cv2.dnn.DNN_BACKEND_CUDA)<br/>net.setPreferableTarget(cv2.dnn.DNN_TARGET_CUDA)</span></pre><p id="efcd" class="pw-post-body-paragraph jo jp hi jq b jr lb jt ju jv lc jx jy jz ld kb kc kd le kf kg kh lf kj kk kl hb bi translated">按照以下步骤，使用我们安装的OpenCV-DNN-CUDA模块运行推理:</p><ul class=""><li id="e65a" class="lg lh hi jq b jr lb jv lc jz li kd lj kh lk kl ll lm ln lo bi translated">首先，打开Anaconda提示符并激活您用来安装OpenCV-DNN-CUDA模块的虚拟环境。</li><li id="2347" class="lg lh hi jq b jr lp jv lq jz lr kd ls kh lt kl ll lm ln lo bi translated">接下来，下载下面的python <em class="lu"> opencv_dnn.py </em>脚本并使用python运行它。请注意，这使用了yolov4模型权重和配置文件。从<a class="ae km" href="https://github.com/AlexeyAB/darknet" rel="noopener ugc nofollow" target="_blank">这里</a>下载。</li></ul><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="bfe1" class="kw ir hi ks b fi kx ky l kz la">import cv2<br/>import time</span><span id="d8a3" class="kw ir hi ks b fi lv ky l kz la">CONFIDENCE_THRESHOLD = 0.2<br/>NMS_THRESHOLD = 0.4<br/>COLORS = [(0, 255, 255), (255, 255, 0), (0, 255, 0), (255, 0, 0)]</span><span id="86bb" class="kw ir hi ks b fi lv ky l kz la">class_names = []<br/>with open("classes.txt", "r") as f:<br/>    class_names = [cname.strip() for cname in f.readlines()]</span><span id="8db0" class="kw ir hi ks b fi lv ky l kz la">cap = cv2.VideoCapture("video.mp4")</span><span id="6e5b" class="kw ir hi ks b fi lv ky l kz la">net = cv2.dnn.readNet("yolov4.weights", "yolov4.cfg")<br/>net.setPreferableBackend(cv2.dnn.DNN_BACKEND_CUDA)<br/>net.setPreferableTarget(cv2.dnn.DNN_TARGET_CUDA_FP16)</span><span id="ba91" class="kw ir hi ks b fi lv ky l kz la">model = cv2.dnn_DetectionModel(net)<br/>model.setInputParams(size=(416, 416), scale=1/255, swapRB=True)</span><span id="66a2" class="kw ir hi ks b fi lv ky l kz la">while cv2.waitKey(1) &lt; 1:<br/>    (grabbed, frame) = cap.read()<br/>    if not grabbed:<br/>        exit()</span><span id="5a83" class="kw ir hi ks b fi lv ky l kz la">    start = time.time()<br/>    classes, scores, boxes = model.detect(frame, CONFIDENCE_THRESHOLD, NMS_THRESHOLD)<br/>    end = time.time()</span><span id="5768" class="kw ir hi ks b fi lv ky l kz la">    for (classid, score, box) in zip(classes, scores, boxes):<br/>        color = COLORS[int(classid) % len(COLORS)]<br/>        label = "%s : %f" % (class_names[classid[0]], score)<br/>        cv2.rectangle(frame, box, color, 2)<br/>        cv2.putText(frame, label, (box[0], box[1]-5), cv2.FONT_HERSHEY_SIMPLEX, 0.5, color, 2)<br/>    <br/>    fps = "FPS: %.2f " % (1 / (end - start))<br/>    cv2.putText(frame, fps, (0, 25), cv2.FONT_HERSHEY_SIMPLEX, 1, (255, 0, 255), 2)<br/>    cv2.imshow("output", frame)</span></pre><p id="ee54" class="pw-post-body-paragraph jo jp hi jq b jr lb jt ju jv lc jx jy jz ld kb kc kd le kf kg kh lf kj kk kl hb bi translated">在这里下载上面的脚本来测试OpenCV-DNN推理。</p><p id="68b1" class="pw-post-body-paragraph jo jp hi jq b jr lb jt ju jv lc jx jy jz ld kb kc kd le kf kg kh lf kj kk kl hb bi translated"><a class="ae km" href="https://techzizou.com/yolov4-inference-using-opencv-dnn-cuda-on-windows/#opencv_dnn_windows" rel="noopener ugc nofollow" target="_blank"> <strong class="jq hj">下载opencv_dnn.py </strong> </a></p></div><div class="ab cl lw lx gp ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="hb hc hd he hf"><p id="4c03" class="pw-post-body-paragraph jo jp hi jq b jr lb jt ju jv lc jx jy jz ld kb kc kd le kf kg kh lf kj kk kl hb bi translated"><strong class="jq hj">重要提示:</strong>OpenCV-DNN-CUDA模块只支持推理。因此，虽然你会从中获得更快的推理，但训练将与我们在没有CUDA后端支持的情况下设置的OpenCV相同。</p><p id="fb21" class="pw-post-body-paragraph jo jp hi jq b jr lb jt ju jv lc jx jy jz ld kb kc kd le kf kg kh lf kj kk kl hb bi translated">您还可以使用OpenCV-DNN-CUDA模块对来自TensorFlow、PyTorch等各种其他框架的模型进行推理。</p></div><div class="ab cl lw lx gp ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="hb hc hd he hf"><h1 id="2b51" class="iq ir hi bd is it md iv iw ix me iz ja jb mf jd je jf mg jh ji jj mh jl jm jn bi translated">我在YouTube上的视频！</h1><figure class="kn ko kp kq fd ij"><div class="bz dy l di"><div class="mi mj l"/></div></figure></div><div class="ab cl lw lx gp ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="hb hc hd he hf"><h1 id="51df" class="iq ir hi bd is it md iv iw ix me iz ja jb mf jd je jf mg jh ji jj mh jl jm jn bi translated">之前的教程:</h1><h2 id="5f47" class="kw ir hi bd is mk ml mm iw mn mo mp ja jz mq mr je kd ms mt ji kh mu mv jm mw bi translated">使用CUDA后端支持设置OpenCV-DNN模块(适用于Windows)</h2><div class="mx my ez fb mz na"><a href="https://techzizou007.medium.com/setup-opencv-dnn-module-with-cuda-backend-support-for-windows-7f1856691da3" rel="noopener follow" target="_blank"><div class="nb ab dw"><div class="nc ab nd cl cj ne"><h2 class="bd hj fi z dy nf ea eb ng ed ef hh bi translated">使用CUDA后端支持设置OpenCV-DNN模块(适用于Windows)</h2><div class="nh l"><h3 class="bd b fi z dy nf ea eb ng ed ef dx translated">在本教程中，我们将使用CUDA后端支持从源代码构建OpenCV(OpenCV-DNN-CUDA模块)。</h3></div><div class="ni l"><p class="bd b fp z dy nf ea eb ng ed ef dx translated">techzizou007.medium.com</p></div></div><div class="nj l"><div class="nk l nl nm nn nj no io na"/></div></div></a></div></div><div class="ab cl lw lx gp ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="hb hc hd he hf"><h2 id="c66e" class="kw ir hi bd is mk ml mm iw mn mo mp ja jz mq mr je kd ms mt ji kh mu mv jm mw bi translated">别忘了留下👏</h2><h2 id="c756" class="kw ir hi bd is mk ml mm iw mn mo mp ja jz mq mr je kd ms mt ji kh mu mv jm mw bi translated">祝您愉快！！！✌</h2><h1 id="363d" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">♕·特奇佐·♕</h1></div></div>    
</body>
</html>