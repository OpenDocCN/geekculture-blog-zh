<html>
<head>
<title>Lets Write MicroService With .Net 5</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让我们用。网络5</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/lets-write-microservice-with-net-5-d726d4fdedcc?source=collection_archive---------2-----------------------#2021-01-21">https://medium.com/geekculture/lets-write-microservice-with-net-5-d726d4fdedcc?source=collection_archive---------2-----------------------#2021-01-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="e0ca" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated"><strong class="ak">微服务</strong>这几天被提到很多。如果我们看看招聘启事。几乎都是想要微服务知识。</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/c3f84cd2eb468b962c7d0274a06af250.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2h7GQrw0ET0RcEJ9jL85CQ.png"/></div></div></figure><p id="382e" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">但是为什么呢？</p><p id="2ec4" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">让我们回顾一下过去，将我们项目的所有特性都集中在一个屋檐下曾经是很理想的。然而，这种情况产生了一些问题。这样的服务停机或维护问题</p><p id="9f99" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">但是在<strong class="jl hj">微服务</strong>理念之后，就变了。今天，我们将项目分成几个小部分。而这些部分是独立的。比如沃尔创！</p><p id="f27f" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">这种哲学的优点是什么？</p><ul class=""><li id="314d" class="kf kg hi jl b jm jn jp jq js kh jw ki ka kj ke kk kl km kn bi translated">维修费用</li><li id="c0d1" class="kf kg hi jl b jm ko jp kp js kq jw kr ka ks ke kk kl km kn bi translated">在服务崩溃的情况下，其余的服务继续处理</li><li id="fdcf" class="kf kg hi jl b jm ko jp kp js kq jw kr ka ks ke kk kl km kn bi translated">查找错误原因非常快</li><li id="2126" class="kf kg hi jl b jm ko jp kp js kq jw kr ka ks ke kk kl km kn bi translated">当您升级服务时，它可以继续运行</li><li id="473f" class="kf kg hi jl b jm ko jp kp js kq jw kr ka ks ke kk kl km kn bi translated">等等…</li></ul><p id="0bb4" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我们将编写一个微服务。净5。我将分享我的Git Hub帐户的完整代码。</p><p id="2b63" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我们需要什么？</p><ul class=""><li id="50cd" class="kf kg hi jl b jm jn jp jq js kh jw ki ka kj ke kk kl km kn bi translated"><strong class="jl hj"> Visual Studio代码或Visual studio </strong></li><li id="7b71" class="kf kg hi jl b jm ko jp kp js kq jw kr ka ks ke kk kl km kn bi translated"><strong class="jl hj"> OpenWeatherMap API键</strong></li><li id="47a7" class="kf kg hi jl b jm ko jp kp js kq jw kr ka ks ke kk kl km kn bi translated"><strong class="jl hj">。Net 5 SDK </strong></li></ul><p id="8254" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">开始编码吧。</p><p id="7a0d" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">首先，我们需要创建一个web API项目。净5。<br/>当你直接运行代码时，它将工作并从天气服务中获取天气信息。但是我们将会改变这种情况。</p><p id="0d95" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我们需要一个包含API主机和API密钥的类。我们把它命名为ServiceSettings吧。并在ApplicationSetting.json中定义它</p><pre class="iy iz ja jb fd kt ku kv kw aw kx bi"><span id="b8f0" class="ky kz hi ku b fi la lb l lc ld">"ServiceSettings":{<br/>    "OpenWeatherHost" : "api.openweathermap.org"<br/>  },</span></pre><p id="5529" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">如果我们向startup.js中的ConfigurationServices方法添加define，那么它将从JSON文件中获取数据。</p><pre class="iy iz ja jb fd kt ku kv kw aw kx bi"><span id="c597" class="ky kz hi ku b fi la lb l lc ld">services.Configure&lt;ServiceSettings&gt;(Configuration.GetSection(nameof(ServiceSettings)));</span></pre><p id="e4ee" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我们没有定义API键。</p><p id="bfd2" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">是啊！因为API密匙很重要，所以我们不能把密匙放在应用程序的JSON文件中。为此，有一种方法可以隐藏API关键数据</p><p id="e4fc" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">打开终端窗口并运行</p><pre class="iy iz ja jb fd kt ku kv kw aw kx bi"><span id="63e6" class="ky kz hi ku b fi la lb l lc ld">dotnet user-secrets init<br/>dotnet user-secrets set ServiceSettings:ApiKey 7d33f2b4d71b3c87139011b (this key should be you your key)</span></pre><p id="a80e" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">现在我们需要一个客户。让我们创造它。这堂课的目标。它会将我们的应用程序连接到OpenWeatherMap</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="le lf l"/></div></figure><p id="6767" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">你看到很酷的功能了吗？</p><p id="6f35" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">记录是附带的新功能。净5。之前。net 5我们不得不在我们的代码库中定义一个类似的输出类，但是现在有了record。我们可以在没有定义的情况下获得数据。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lg"><img src="../Images/e4d0016d67dd5d6f5aabebe35179e176.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gCc2YxmX8-IxL_g3wsAYmg.png"/></div></div></figure><p id="91ae" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">例如，在我们的类中，我们将从天气中获得描述，从main中获得temp，从date中获得</p><p id="cfd5" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">GetFromJsonAsync也是。它将获得一个JSON结果并将数据分配给预测记录类型。</p><p id="16d4" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">作为微服务，我们需要检查服务是否健康，为此有一个包</p><pre class="iy iz ja jb fd kt ku kv kw aw kx bi"><span id="6980" class="ky kz hi ku b fi la lb l lc ld"><strong class="ku hj">dotnet add package Microsoft.Extension.Http.Polly</strong></span></pre><p id="b0fb" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">安装之后，我们需要在配置服务中定义我们的客户端类。</p><pre class="iy iz ja jb fd kt ku kv kw aw kx bi"><span id="26f4" class="ky kz hi ku b fi la lb l lc ld">services.AddHttpClient&lt;WeatherClient&gt;().AddTransientHttpErrorPolicy(builder =&gt; builder.WaitAndRetryAsync(10, retryAtempt =&gt; TimeSpan.FromSeconds(Math.Pow(2, retryAtempt))));</span></pre><p id="4e9c" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">AddTransientHttpErrorPolicy附带Polly包。在客户端调用之后，如果没有返回响应，那么它将尝试10次。以指数级的速度。</p><p id="693f" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">但是停下来！有一个问题，它试图达到我们的服务，但我们需要检查API端。</p><p id="ce73" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我们需要编写一个从IHealtyCheck派生的类</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="le lf l"/></div></figure><p id="8226" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">当我们大摇大摆地提供服务时。我们的服务会完美的</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lh"><img src="../Images/190f9d6e36537e2c585d5119615de147.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xs1XLNy7B670vJje2-pvRg.png"/></div></div></figure><p id="10a2" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">通话后</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es li"><img src="../Images/414e801f3571cb5513b1e6f4a7b014b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1TkFqg6w9wYzDRm-n6VaCA.png"/></div></div></figure><p id="a5a5" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">如果要检查服务是否正常，只需在配置方法中定义地址。</p><p id="7392" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">终于，我们完成了第一个<strong class="jl hj">微服务</strong>。我将集中讨论这一点。保持联络</p><p id="b86e" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">你可以从<a class="ae lj" href="https://github.com/barkinkizilkaya/NetFiveMicroServis" rel="noopener ugc nofollow" target="_blank">这里</a>下载代码</p><p id="3c64" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">最诚挚的问候。</p><p id="a23d" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">来源:<a class="ae lj" href="https://docs.microsoft.com/tr-tr/dotnet/architecture/microservices/implement-resilient-applications/implement-http-call-retries-exponential-backoff-polly" rel="noopener ugc nofollow" target="_blank">波利</a>，。<a class="ae lj" href="https://docs.microsoft.com/tr-tr/dotnet/core/dotnet-five" rel="noopener ugc nofollow" target="_blank"> Net 5 Api </a>，<a class="ae lj" href="https://www.youtube.com/user/jcasalt" rel="noopener ugc nofollow" target="_blank"> YouTube </a></p></div></div>    
</body>
</html>