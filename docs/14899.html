<html>
<head>
<title>Detecting anomalies in time series based on the seasonal pattern</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基于季节模式检测时间序列中的异常</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/detecting-anomalies-in-time-series-based-on-the-seasonal-pattern-bc4734a2c45e?source=collection_archive---------7-----------------------#2022-10-01">https://medium.com/geekculture/detecting-anomalies-in-time-series-based-on-the-seasonal-pattern-bc4734a2c45e?source=collection_archive---------7-----------------------#2022-10-01</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="cd8a" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">介绍</h1><p id="c87f" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">大家好，在这篇文章中我想谈谈时间序列的季节性异常的检测。时间序列是描述一段时间内发生的过程的一系列值。这些值应该有固定的间隔，这是处理时间序列的强制性要求。</p><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es kb"><img src="../Images/8c6582975328c4a1b49c86f4e050b46f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YWz4ydYIgaGU6L-k"/></div></div><figcaption class="kn ko et er es kp kq bd b be z dx">Here is an example of a time series describing the number of cars entering a gas station.</figcaption></figure><h1 id="dcb8" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">为什么要寻找异常点？</h1><p id="a73f" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">与时间序列相关的主要任务是分析和预测。<br/>可能需要时间序列分析来监控和响应系统行为的某些变化。</p><p id="6d60" class="pw-post-body-paragraph jd je hi jf b jg kr ji jj jk ks jm jn jo kt jq jr js ku ju jv jw kv jy jz ka hb bi translated">时间序列预测在许多领域都很有趣，例如预测股票市场的汇率或零售商店的顾客流量和产品需求。</p><p id="32d8" class="pw-post-body-paragraph jd je hi jf b jg kr ji jj jk ks jm jn jo kt jq jr js ku ju jv jw kv jy jz ka hb bi translated">异常搜索方法可用于及时响应指标变化或提高预测模型的质量。</p><h1 id="5bb7" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">季节性</h1><p id="a75d" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">异常是数据的一个实例不同于其余实例时的点，或者是相关实例的序列不同于其余数据时的组。<br/>每个时间序列都有三个组成部分:趋势、季节性和残差。季节性是序列的周期性组成部分，它假设序列在一定时期内具有相同的动态。一个例子是杂货店的顾客数量，这样的序列具有明显的每周季节性。<br/>(图为顾客流动)<br/>如果事先知道序列的季节性，那么寻找该季节性的偏差并单独处理异常周期是有意义的。这类异常属于群体异常。</p><h1 id="717d" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">搜索序列的季节性异常</h1><p id="a074" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">季节性根据时期有固定的轮廓。有可能测量与这一季节剖面的偏差，并接受整个周期为异常。</p><p id="55fc" class="pw-post-body-paragraph jd je hi jf b jg kr ji jj jk ks jm jn jo kt jq jr js ku ju jv jw kv jy jz ka hb bi translated">下图显示了俄罗斯一家杂货店销售的商品数量示例。我们知道有一个明显的周季节性，并希望找到异常周。</p><p id="c6b1" class="pw-post-body-paragraph jd je hi jf b jg kr ji jj jk ks jm jn jo kt jq jr js ku ju jv jw kv jy jz ka hb bi translated">为此，我们需要将每个配置文件表示为一个向量，在我们的例子中，它是一周中每一天的7个值的向量。</p><p id="2a8e" class="pw-post-body-paragraph jd je hi jf b jg kr ji jj jk ks jm jn jo kt jq jr js ku ju jv jw kv jy jz ka hb bi translated">作为一种距离度量，您可以采用特定一周的向量与季节性轮廓之间的角度。</p><p id="9691" class="pw-post-body-paragraph jd je hi jf b jg kr ji jj jk ks jm jn jo kt jq jr js ku ju jv jw kv jy jz ka hb bi translated">剩下的只是确定距离阈值，在我们的例子中，我们将通过第90百分位设置它。那些。超过90%的所有值将被视为异常。</p><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es kw"><img src="../Images/da2df27563de0ccdcb3deac14b133765.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dmGLZLsEOhHzvsEF"/></div></div><figcaption class="kn ko et er es kp kq bd b be z dx">the number of items sold in a grocery store in Russia</figcaption></figure><p id="ea86" class="pw-post-body-paragraph jd je hi jf b jg kr ji jj jk ks jm jn jo kt jq jr js ku ju jv jw kv jy jz ka hb bi translated">结果，我们看到包含新年假期的那一周和包含11月4日和2月23日的公共假期的那几周被证明是异常的。3月份的第二周也出现下跌，因为需求的增加与乌克兰冲突的开始有关。</p><p id="3e00" class="pw-post-body-paragraph jd je hi jf b jg kr ji jj jk ks jm jn jo kt jq jr js ku ju jv jw kv jy jz ka hb bi translated">检测器的实现如下所示。</p><pre class="kc kd ke kf fd kx ky kz la aw lb bi"><span id="02ff" class="lc ig hi ky b fi ld le l lf lg"><strong class="ky hj">'''</strong></span><span id="7b10" class="lc ig hi ky b fi lh le l lf lg"><strong class="ky hj">df - dataframe with datetime column and values<br/>column - is column name for search anomalies</strong></span><span id="9ff6" class="lc ig hi ky b fi lh le l lf lg">'''</span><span id="a175" class="lc ig hi ky b fi lh le l lf lg"><strong class="ky hj">def</strong> anomaly_week_detector(df, column, outliers_fraction<strong class="ky hj">=</strong>0.1):<br/>    _df <strong class="ky hj">=</strong> df<strong class="ky hj">.</strong>copy()</span><span id="e007" class="lc ig hi ky b fi lh le l lf lg"># compute average pattern of week<br/>    dfw <strong class="ky hj">=</strong> _df<strong class="ky hj">.</strong>groupby(_df<strong class="ky hj">.</strong>index<strong class="ky hj">.</strong>weekday)<strong class="ky hj">.</strong>mean()<br/>    dfw <strong class="ky hj">=</strong> dfw<strong class="ky hj">/</strong>dfw<strong class="ky hj">.</strong>sum()<br/>    dfw <strong class="ky hj">=</strong> dfw<strong class="ky hj">.</strong>reset_index()<strong class="ky hj">.</strong>rename(columns<strong class="ky hj">=</strong>{'datetime':'dw', column:'tmpl'})<br/><br/>    _df['dw'] <strong class="ky hj">=</strong> _df<strong class="ky hj">.</strong>index<strong class="ky hj">.</strong>weekday #weekday number<br/>    _df['w'] <strong class="ky hj">=</strong> _df<strong class="ky hj">.</strong>index<strong class="ky hj">.</strong>year<strong class="ky hj">*</strong>100 <strong class="ky hj">+</strong> _df<strong class="ky hj">.</strong>index<strong class="ky hj">.</strong>week #index of week</span><span id="3b37" class="lc ig hi ky b fi lh le l lf lg"># calculate sum of each week</span><span id="18ea" class="lc ig hi ky b fi lh le l lf lg">    d1 <strong class="ky hj">=</strong> _df<strong class="ky hj">.</strong>groupby('w')[column]<strong class="ky hj">.</strong>sum()<strong class="ky hj">.</strong>reset_index()<br/>    d1<strong class="ky hj">.</strong>rename(columns<strong class="ky hj">=</strong>{column: 'v_sum'}, inplace<strong class="ky hj">=True</strong>)</span><span id="ba05" class="lc ig hi ky b fi lh le l lf lg">    ddf <strong class="ky hj">=</strong> _df<strong class="ky hj">.</strong>merge(d1)</span><span id="3d34" class="lc ig hi ky b fi lh le l lf lg">    #compute normalize pattern of each week<br/>    ddf['v_norm'] <strong class="ky hj">=</strong> ddf[column] <strong class="ky hj">/</strong> ddf['v_sum']</span><span id="dfa7" class="lc ig hi ky b fi lh le l lf lg">    <br/>    ddf['v_norm_sqr'] <strong class="ky hj">=</strong> ddf['v_norm']<strong class="ky hj">*</strong>ddf['v_norm']<br/>    <br/>    ddf <strong class="ky hj">=</strong> ddf<strong class="ky hj">.</strong>merge(dfw)</span><span id="1a43" class="lc ig hi ky b fi lh le l lf lg">    ddf['tmpl_sqr'] <strong class="ky hj">=</strong> ddf['tmpl']<strong class="ky hj">*</strong>ddf['tmpl']<br/>    ddf['n_tmpl'] <strong class="ky hj">=</strong> ddf['tmpl']<strong class="ky hj">*</strong>ddf['v_norm']<br/>    <br/>    ddf <strong class="ky hj">=</strong> ddf<strong class="ky hj">.</strong>groupby('w')[['v_norm_sqr', 'tmpl_sqr', 'n_tmpl']]<strong class="ky hj">.</strong>sum()<strong class="ky hj">.</strong>reset_index()<br/>    <br/>    ddf['tmpl'] <strong class="ky hj">=</strong> np<strong class="ky hj">.</strong>sqrt(ddf['tmpl_sqr'])<br/>    ddf['v_norm'] <strong class="ky hj">=</strong> np<strong class="ky hj">.</strong>sqrt(ddf['v_norm_sqr'])<br/>    <br/>    ddf['cos'] <strong class="ky hj">=</strong> (ddf['n_tmpl'] <strong class="ky hj">/</strong> (ddf['tmpl']<strong class="ky hj">*</strong>ddf['v_norm']))<br/>    #angle between each week and average pattern<br/>    ddf['angle'] <strong class="ky hj">=</strong> ddf['cos']<strong class="ky hj">.</strong>apply(<strong class="ky hj">lambda</strong> x: math<strong class="ky hj">.</strong>acos(x))<br/>    </span><span id="8907" class="lc ig hi ky b fi lh le l lf lg">    # detect anomalies<br/>    ddf['is_anomaly'] <strong class="ky hj">=</strong> ddf['angle'] <strong class="ky hj">&gt;=</strong> ddf['angle']<strong class="ky hj">.</strong>quantile(q<strong class="ky hj">=</strong>1<strong class="ky hj">-</strong>outliers_fraction)<br/><br/>    df_out <strong class="ky hj">=</strong> _df<strong class="ky hj">.</strong>reset_index()<strong class="ky hj">.</strong>merge(ddf[['w', 'is_anomaly']])<strong class="ky hj">.</strong>set_index('datetime')<br/>    df_out['anomaly'] <strong class="ky hj">=</strong> df_out[df_out['is_anomaly']][column]<br/><br/>    <strong class="ky hj">return</strong> df_out</span></pre><h1 id="8250" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">摘要</h1><p id="e8f6" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">因此，在本文中，我们考虑了在时间序列的季节性中寻找异常的方法。您可以在<a class="ae li" href="https://github.com/stepanovD/ts_anomaly_detection_course" rel="noopener ugc nofollow" target="_blank">这个库</a>中找到使用这个和其他异常检测器的例子。</p></div></div>    
</body>
</html>