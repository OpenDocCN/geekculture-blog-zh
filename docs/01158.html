<html>
<head>
<title>Coordinate Systems in Medical Data Science — a rant</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">医学数据科学中的坐标系统——rant</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/coordinate-systems-in-medical-data-science-a-rant-90394f60b27?source=collection_archive---------4-----------------------#2021-03-30">https://medium.com/geekculture/coordinate-systems-in-medical-data-science-a-rant-90394f60b27?source=collection_archive---------4-----------------------#2021-03-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex if ig ih ii"><div class="bz dy l di"><div class="ij ik l"/></div><figcaption class="il im et er es in io bd b be z dx">Sagittal plane slices of the brain from<a class="ae ip" href="https://theaisummer.com/medical-image-coordinates/#introduction-to-dicom-for-machine-learning-engineers" rel="noopener ugc nofollow" target="_blank"> this source</a></figcaption></figure><p id="5a57" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用医学数据集有时很糟糕！当我开始处理真实世界的数据集时，我没有意识到医疗文件格式缺乏标准化。</p><p id="cffd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我误以为DICOM文件是标准化的，可以像<em class="jo">一样使用。jpg </em>或<em class="jo">。png </em>文件。我希望能够像加载任何其他类型的图像一样加载它们。<strong class="is hj"> <em class="jo">哎呀这是怎么回事。</em>T9】</strong></p><p id="a8ec" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了工作，我建立了一个系统，可以在给定的CT体积内放置手术工具。那么可以在考虑许多物理效应的同时生成投影图像。虽然它在大部分时间<em class="jo">都能正常工作</em>，但偶尔也会出现看似随机的故障，并且会放错工具的位置。</p><p id="e167" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我必须弄清真相。虽然这个帖子是我找到的资源的总结，但它主要是我对悲惨现状的咆哮。</p></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><h2 id="1586" class="jw jx hi bd jy jz ka kb kc kd ke kf kg jb kh ki kj jf kk kl km jj kn ko kp kq bi translated">并非所有的DICOMs都是平等的</h2><p id="277b" class="pw-post-body-paragraph iq ir hi is b it kr iv iw ix ks iz ja jb kt jd je jf ku jh ji jj kv jl jm jn hb bi translated">DICOM的目标是为各种医疗数据提供一个单一的接口。这包括X射线、MRI、超声波图像和各种混合数据集。<em class="jo">(注意:DICOM也包含一个网络协议，但这里不感兴趣)</em></p><p id="721d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">虽然这无疑有利于制造商之间的互操作性，但也带来了一些问题。这些主要是由于缺乏标准化造成的。由于制造商坚持他们的内部约定，他们都被集成到DICOM<em class="jo">‘标准’</em>。</p><blockquote class="kw kx ky"><p id="c4b4" class="iq ir jo is b it iu iv iw ix iy iz ja kz jc jd je la jg jh ji lb jk jl jm jn hb bi translated">示例:CT扫描的切片可以存储在每个切片的单个<strong class="is hj">文件中，或所有切片</strong>的单个<strong class="is hj">文件中。</strong></p></blockquote><p id="d8c8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">虽然这可以用代码来处理，但真正的问题出现在更复杂的层面上。</p></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><h2 id="04ed" class="jw jx hi bd jy jz ka kb kc kd ke kf kg jb kh ki kj jf kk kl km jj kn ko kp kq bi translated">三个坐标系</h2><p id="baa9" class="pw-post-body-paragraph iq ir hi is b it kr iv iw ix ks iz ja jb kt jd je jf ku jh ji jj kv jl jm jn hb bi translated">当采集CT扫描时，患者相对于扫描仪定位。虽然对于固定扫描仪来说，这或多或少是明确定义的，但对于便携式C型臂系统(我主要使用这种系统)来说，这变得更加复杂。扫描仪可以在患者周围任意定位，完全改变了患者在采集图像中的方位！</p><p id="96da" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了保持用于诊断应用的患者方位，要求临床医生在扫描之前提供基本的定位。该信息存储在DICOM元数据中。</p><p id="11ef" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了明确定义患者相对于扫描仪的方向和位置，我们必须定义三个坐标系。</p><figure class="ld le lf lg fd ii er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es lc"><img src="../Images/2750e54afbe934f4fe86ba0644368856.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XdDx2DIna0mXozleFxq8ew.png"/></div></div><figcaption class="il im et er es in io bd b be z dx">the three coordinate systems from <a class="ae ip" href="https://www.slicer.org/wiki/Coordinate_systems" rel="noopener ugc nofollow" target="_blank">here</a>. Defined on MRI but analogous to CT</figcaption></figure><p id="682c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这三个系统都是笛卡尔坐标系，只是在间距、旋转和参考点上有所不同。此外，<em class="jo"> xyz </em>和<em class="jo"> lps </em>系统是连续的，带有单位<em class="jo"> mm </em>，而<em class="jo"> ijk </em>系统是离散的，没有单位。</p><p id="3825" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">所谓的<strong class="is hj">世界系统<em class="jo">XYZ</em>T3】是相对于扫描仪定义的。不同厂商对旋转轴的定义不同(此处<em class="jo"> z </em>)。在CT系统中，原点<em class="jo"> (0，0，0) </em>通常位于旋转中心。</strong></p><p id="c1ea" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">解剖系统<em class="jo">LPS</em>T11】由医学术语定义。两个通常的约定是<strong class="is hj"> <em class="jo"> LPS </em> </strong>或<strong class="is hj"> <em class="jo"> RAS </em> </strong>系统。这里LPS代表(左、后、上),并指示沿定义的轴的向量方向。原点可以任意选择<em class="jo">(或取决于所描绘的解剖结构)</em>，并且通常仅定义在扫描的旋转中心，以简化转换。</strong></p><p id="73b6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">图像系统</strong> <strong class="is hj"> <em class="jo"> ijk </em> </strong>索引扫描仪产生的原始数据阵列。根据定义，原点(0，0，0)位于左上角附近；因此，索引<em class="jo"> i </em>从左到右，索引<em class="jo"> j </em>从上到下，索引<em class="jo"> k </em>从近到远。</p><p id="7e9a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果患者面朝上躺在MRI或CT系统中，如上图所示，<em class="jo"> xyz </em>世界系统和<em class="jo"> lps </em>患者系统将重合。这是DICOM中假定的标准系统。</p><p id="9604" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">澄清这些术语后，让我们看看复杂的部分:如何从DICOM标准中给出的体积重建解剖系统。</p></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><h2 id="025d" class="jw jx hi bd jy jz ka kb kc kd ke kf kg jb kh ki kj jf kk kl km jj kn ko kp kq bi translated">DICOM标准下的帧转换</h2><p id="6db6" class="pw-post-body-paragraph iq ir hi is b it kr iv iw ix ks iz ja jb kt jd je jf ku jh ji jj kv jl jm jn hb bi translated">如前所述，DICOM中的CT图像可以是多切片或单切片数据集。为了将给定的索引从图像坐标系转换到患者参考系统，DICOM提供了两个属性:</p><p id="6461" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae ip" href="https://dicom.innolitics.com/ciods/enhanced-ct-image/enhanced-ct-image-multi-frame-functional-groups/52009229/00209116/00200037" rel="noopener ugc nofollow" target="_blank">图像方向</a>标签指定了轴<em class="jo"> i </em>和<em class="jo"> j </em>指向的解剖空间的矢量方向。这通过两个向量<strong class="is hj"> <em class="jo"> R </em> </strong>和<strong class="is hj"> <em class="jo"> C </em> </strong>给出，这对于数据集中的所有切片都是相同的。</p><p id="6aac" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae ip" href="https://dicom.innolitics.com/ciods/enhanced-ct-image/enhanced-ct-image-multi-frame-functional-groups/52009230/00209113/00200032" rel="noopener ugc nofollow" target="_blank">图像位置</a>标签定义了解剖空间中的点，每个切片的(0，0)索引位于该点。它存在于每个切片中，尽管在大多数情况下只有深度坐标会改变。我们将其表示为<strong class="is hj"> T </strong>用于翻译<strong class="is hj">T57】。T59】</strong></p><p id="dca2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于<strong class="is hj">单层数据集</strong>，这完全有意义，因为将像素索引<em class="jo"> (i，j) </em>映射到解剖框架的仿射变换可以直接定义为:</p><figure class="ld le lf lg fd ii er es paragraph-image"><div class="er es ln"><img src="../Images/aa756b59b04c94c25c563ebe632b46f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:892/format:webp/1*5Lmwdr_RCh4s1WXAxnhXWQ.png"/></div><figcaption class="il im et er es in io bd b be z dx">2d-3d affine transform including a real world example (adapted from <a class="ae ip" href="https://nipy.org/nibabel/dicom/dicom_orientation.html#dicom-affine-formula" rel="noopener ugc nofollow" target="_blank">here</a>)</figcaption></figure><p id="c829" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">其中<strong class="is hj"> R </strong>、<strong class="is hj"> C </strong>和<strong class="is hj"> T </strong>由两个讨论的标签定义，并且沿着<em class="jo"> i </em>和<em class="jo"> j </em>的像素间距也作为<a class="ae ip" href="https://dicom.innolitics.com/ciods/enhanced-ct-image/enhanced-ct-image-multi-frame-functional-groups/52009229/00289110/00280030" rel="noopener ugc nofollow" target="_blank">像素间距</a>标签在元数据中可用。<em class="jo">注意:我们在这里直接使用xyz，因为我们假设了前面讨论过的标准位置。</em></p><blockquote class="kw kx ky"><p id="ea28" class="iq ir jo is b it iu iv iw ix iy iz ja kz jc jd je la jg jh ji lb jk jl jm jn hb bi translated">这是2d-3d转换！</p></blockquote><p id="539c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">右边的矩阵是从真实数据集的第一个切片构建的。如您所见，图像采集开始于解剖空间中的点(80，-80，-80)，但沿<em class="jo"> -x </em>采样。</p><p id="f7fa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于一个<strong class="is hj">多切片数据集</strong>来说，这种切片式的定义没有什么意义。如果给定的<em class="jo"> ijk </em>直接坐标，提供编码<em class="jo"> xyz </em>位置的<em class="jo">单仿射变换</em>会更容易。相反，这种仿射变换必须从DICOM提供给我们的属性中手工计算出来。</p><p id="a2a8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">所以让我们来看看计算…</p></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><h2 id="684e" class="jw jx hi bd jy jz ka kb kc kd ke kf kg jb kh ki kj jf kk kl km jj kn ko kp kq bi translated">多切片仿射变换计算</h2><p id="a283" class="pw-post-body-paragraph iq ir hi is b it kr iv iw ix ks iz ja jb kt jd je jf ku jh ji jj kv jl jm jn hb bi translated">对于多切片数据集，必须根据给定的参数计算3d仿射变换。为此，我们可以从上面的单切片情况开始，为<em class="jo"> k </em>组件添加第三列。</p><blockquote class="kw kx ky"><p id="dcb5" class="iq ir jo is b it iu iv iw ix iy iz ja kz jc jd je la jg jh ji lb jk jl jm jn hb bi translated">按照惯例，DICOM数据按照<strong class="is hj"> (k，j，i) </strong>顺序存储。因为我们的数学模型使用<strong class="is hj"> (i，j，k) </strong>约定，所以我们在加载后立即转置数据数组的轴。在python中:</p></blockquote><blockquote class="lo"><p id="69bc" class="lp lq hi bd lr ls lt lu lv lw lx jn dx translated">data_ijk = data_kji.transpose((2，1，0))。复制()</p></blockquote><p id="b3dd" class="pw-post-body-paragraph iq ir hi is b it ly iv iw ix lz iz ja jb ma jd je jf mb jh ji jj mc jl jm jn hb bi translated"><code class="du md me mf mg b">.copy()</code>重写内存中的数组以实现快速访问。</p><p id="879d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">由于患者空间轴中k的方向没有明确说明，我们必须根据给定的图像位置来推断。记住，图像位置标签<strong class="is hj"> T </strong>给了我们每个切片第一个像素的<em class="jo"> xyz </em>位置！如果我们从第一个切片的标签中减去最后一个切片的标签中的位置，我们就得到一个沿深度方向的矢量分量。</p><p id="bc2b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为<em class="jo"> ijk </em>向量的<em class="jo"> k </em>分量插入这一列，结果如下:</p><figure class="ld le lf lg fd ii er es paragraph-image"><div class="er es mh"><img src="../Images/eaedb8a4bbf86f3d8e6619d81a9f8748.png" data-original-src="https://miro.medium.com/v2/resize:fit:1186/format:webp/1*oPvNbkYE0vdWsLMsvOawaw.png"/></div><figcaption class="il im et er es in io bd b be z dx">multi-slice 3d affine transform from image to anatomical system. (adapted from <a class="ae ip" href="https://nipy.org/nibabel/dicom/dicom_orientation.html#d-affine-formulae" rel="noopener ugc nofollow" target="_blank">here</a>)</figcaption></figure><p id="41c2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请注意，我们必须根据给定切片的数量来归一化这个矢量分量。在大多数在假定的患者位置采集的真实数据集中，这个看起来复杂的等式简化为这个相当简单的旋转和平移变换:</p><figure class="ld le lf lg fd ii er es paragraph-image"><div class="er es mi"><img src="../Images/ff5163f452fc256d23cc87b83e1c354c.png" data-original-src="https://miro.medium.com/v2/resize:fit:906/format:webp/1*HSMV7ey_3IWukhZiQCkMkA.png"/></div><figcaption class="il im et er es in io bd b be z dx">example for a 3d affine matrix</figcaption></figure><p id="1a3d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果图像系统与患者系统对准，由于位置Tx和Ty不沿切片变化，因此k列中的相应条目消失。</p><h2 id="b1a3" class="jw jx hi bd jy jz ka kb kc kd ke kf kg jb kh ki kj jf kk kl km jj kn ko kp kq bi translated">结论</h2><p id="555c" class="pw-post-body-paragraph iq ir hi is b it kr iv iw ix ks iz ja jb kt jd je jf ku jh ji jj kv jl jm jn hb bi translated">利用这种仿射变换，我们能够明确地定位患者空间中的给定体积。恼人的部分:这在其他更专业的标准中很容易得到，比如NIfTI标准。</p><p id="bfa8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">由于其优越性和降低的复杂性<em class="jo"> .nii.gz </em>图像在神经成像中非常常见。如果你可以选择，我强烈推荐你使用它而不是传统的DICOM。省了很多头疼的事。</p></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><p id="2259" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">以下是我在这篇文章中使用的一些好资源:</p><div class="mj mk ez fb ml mm"><a href="https://nipy.org/nibabel/dicom/dicom_orientation.html" rel="noopener  ugc nofollow" target="_blank"><div class="mn ab dw"><div class="mo ab mp cl cj mq"><h2 class="bd hj fi z dy mr ea eb ms ed ef hh bi translated">尼巴贝尔</h2><div class="mt l"><h3 class="bd b fi z dy mr ea eb ms ed ef dx translated">首先，我们定义标准的基于患者的DICOM坐标系。这就是DICOM中x、y和z轴的含义…</h3></div><div class="mu l"><p class="bd b fp z dy mr ea eb ms ed ef dx translated">nipy.org</p></div></div></div></a></div><div class="mj mk ez fb ml mm"><a href="https://theaisummer.com/medical-image-coordinates/#introduction-to-dicom-for-machine-learning-engineers" rel="noopener  ugc nofollow" target="_blank"><div class="mn ab dw"><div class="mo ab mp cl cj mq"><h2 class="bd hj fi z dy mr ea eb ms ed ef hh bi translated">理解用于深度学习医学图像分析的坐标系和DICOM</h2><div class="mt l"><h3 class="bd b fi z dy mr ea eb ms ed ef dx translated">有时候你认为你理解了一些事情，但是你没有解释清楚。这是你必须回头看的时候了…</h3></div><div class="mu l"><p class="bd b fp z dy mr ea eb ms ed ef dx translated">theaisummer.com</p></div></div><div class="mv l"><div class="mw l mx my mz mv na ll mm"/></div></div></a></div><p id="bb6d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae ip" href="http://dicom.nema.org/medical/dicom/current/output/chtml/part03/sect_C.7.6.2.html#sect_C.7.6.2.1.1" rel="noopener ugc nofollow" target="_blank">http://DICOM . NEMA . org/medical/DICOM/current/output/chtml/part 03/Sect _ c . 7 . 6 . 2 . html # Sect _ c . 7 . 6 . 2 . 1 . 1</a></p></div></div>    
</body>
</html>