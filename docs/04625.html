<html>
<head>
<title>How to: rate limit log in attempts while respecting privacy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何:在尊重隐私的同时限制登录尝试次数</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/how-to-rate-limit-log-in-attempts-while-respecting-privacy-a1ae220640e8?source=collection_archive---------35-----------------------#2021-06-30">https://medium.com/geekculture/how-to-rate-limit-log-in-attempts-while-respecting-privacy-a1ae220640e8?source=collection_archive---------35-----------------------#2021-06-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/b14b8abf076001d19f9014d5ee5e1c60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S18WCQPcUdbsqCF2Vf-HfA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Approaching log in limit message on Metamorphic. © Moss Piglet</figcaption></figure><h1 id="7ef3" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">背景</h1><p id="5ac9" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">如果你一直在关注我最近的几篇帖子，那么你会意识到我目前正在开发一种专注于隐私的替代大型科技社交网络(或社交媒体)的产品，名为<em class="kq">变形</em>。</p><p id="8124" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">在我进行的过程中，我分享了我学到的一些我认为很酷或者可能对其他人有用的东西。</p><p id="69ec" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">在这种情况下，我决定对某个人可以尝试登录他们的帐户的次数进行限制，以此来给潜在的恶意行为者增加一些摩擦。</p><p id="c405" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">与此同时，我也在决定如何处理人们以短暂而持久的方式上传的记忆(图像)。这意味着将加密的图像上传到云提供商，用于存储负载；然后在一个人的会话期间实时处理我们服务器上的内存的解密、临时存储和应用程序内使用(人们的内存是不对称加密的，除了内存的所有者和他们选择与之共享的人之外，任何人都不能解密)。</p><p id="42dc" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">当我思考这两个场景时，我不断地回到一件事情上，<a class="ae kw" href="https://erlang.org/doc/man/ets.html" rel="noopener ugc nofollow" target="_blank"> Erlang Term Storage </a> (ETS)。</p><p id="2dcd" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">所以我开始研究ETS，发现了Chris McCord在<a class="ae kw" href="https://dockyard.com/blog/2017/05/19/optimizing-elixir-and-phoenix-with-ets" rel="noopener ugc nofollow" target="_blank">造船厂</a>写的这篇精彩的博客，并决定尝试一下登录速率限制器(以及后来一个更复杂的短暂应用内内存解密实现)。</p><h1 id="a457" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">先决条件</h1><p id="e20e" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">在这篇文章中，我们将做如下假设:</p><ul class=""><li id="1fa5" class="kx ky hi ju b jv kr jz ks kd kz kh la kl lb kp lc ld le lf bi translated">你已经有了一个<a class="ae kw" href="https://phoenixframework.org" rel="noopener ugc nofollow" target="_blank"> Phoenix </a>应用程序，并且正在运行(~ 1.5.9)</li><li id="81b6" class="kx ky hi ju b jv lg jz lh kd li kh lj kl lk kp lc ld le lf bi translated">您已经安装了phx_gen_auth(除非您使用的是Phoenix 1.6以上版本)</li><li id="bb51" class="kx ky hi ju b jv lg jz lh kd li kh lj kl lk kp lc ld le lf bi translated">您已经启动并运行了一个身份验证系统(或者可以理解您自己场景中的等效情况)</li><li id="39fa" class="kx ky hi ju b jv lg jz lh kd li kh lj kl lk kp lc ld le lf bi translated">可选:登录或登录命名(当命名文件或在面向人的场景中讲话时，我在两者之间切换)</li><li id="aade" class="kx ky hi ju b jv lg jz lh kd li kh lj kl lk kp lc ld le lf bi translated">可选:我用一个人/几个人来代表一个/几个用户</li></ul><h1 id="f5d7" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">信用</h1><p id="7242" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">特别感谢<a class="ae kw" href="https://dockyard.com/" rel="noopener ugc nofollow" target="_blank">船坞</a>和Chris McCord的<a class="ae kw" href="https://dockyard.com/blog/2017/05/19/optimizing-elixir-and-phoenix-with-ets" rel="noopener ugc nofollow" target="_blank">博客文章</a>，这是一个巨人，我们特别站在他的肩膀上看这个简短的指南(还有所有其他的巨人… Erlang/Elixir/Phoenix等等)。).如果你需要技术帮助，我强烈推荐你去看看。</p><p id="7729" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">事不宜迟，让我们开始吧。</p><h1 id="5424" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">第一步</h1><p id="54d6" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">第一步，让我们创建一个<a class="ae kw" href="https://elixir-lang.org/getting-started/mix-otp/genserver.html" rel="noopener ugc nofollow" target="_blank"> GenServer </a>处理器来处理我们的登录限制器的编排。</p><p id="b642" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">在应用程序代码的web部分，让我们创建一个名为“extensions”的文件夹，并将我们的<code class="du ll lm ln lo b">max_login_processor.ex</code>文件放入其中。因此，您的文件结构可能如下所示:</p><pre class="lp lq lr ls fd lt lo lu lv aw lw bi"><span id="500f" class="lx iv hi lo b fi ly lz l ma mb">your_app_web<br/>│   ...<br/>└───extensions<br/>│   │   max_login_processor.ex<br/>│   ...</span><span id="c52a" class="lx iv hi lo b fi mc lz l ma mb"># your_app_webb/extensions/max_login_processor.ex</span></pre><p id="3a94" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">您可以随意命名您的文件夹，例如，如果将它与您的身份验证控制器放在一起，您可能会感觉更好。使用extensions文件夹只是为了帮助组织我们的代码。</p><p id="7b63" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">那么，代码呢？</p><p id="8543" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">对于您的<code class="du ll lm ln lo b">max_login_processor.ex</code>文件，您可以复制<a class="ae kw" href="https://dockyard.com/blog/2017/05/19/optimizing-elixir-and-phoenix-with-ets" rel="noopener ugc nofollow" target="_blank"> Chris McCord的示例</a>并进行以下更改:</p><pre class="lp lq lr ls fd lt lo lu lv aw lw bi"><span id="9583" class="lx iv hi lo b fi ly lz l ma mb">defmodule YourAppWeb.Extensions.MaxLoginProcessor do<br/>  @moduledoc """<br/>  A GenServer to limit log in attempts<br/>  to 5 every hour.<br/>  """<br/>  use GenServer<br/>  # remove the require Logger or not</span><span id="f90e" class="lx iv hi lo b fi mc lz l ma mb">  @max_per_hour 5<br/>  @sweep_after :timer.hours(1)<br/>  @tab :rate_limiter_requests</span><span id="1612" class="lx iv hi lo b fi mc lz l ma mb">  ...</span><span id="65d9" class="lx iv hi lo b fi mc lz l ma mb">  def log(sid) do<br/>    case :ets.update_counter(@tab, sid, {2, 1}, {sid, 0}) do<br/>      count when count &gt; @max_per_hour -&gt; {:error, :rate_limited}<br/>      count -&gt; {:ok, count}<br/>    end<br/>  end</span><span id="e24a" class="lx iv hi lo b fi mc lz l ma mb">  def sweep_on_login(sid) do<br/>    case :ets.lookup(@tab, sid) do<br/>      [{session_id, _}] -&gt;<br/>        :ets.delete(@tab, session_id)<br/>      [_] -&gt;<br/>        :ok<br/>    end<br/>  end</span><span id="1724" class="lx iv hi lo b fi mc lz l ma mb">  ## Server</span><span id="d92f" class="lx iv hi lo b fi mc lz l ma mb">  def init(_) do<br/>    # Remove debug logging if removing Logger from above<br/>    ...<br/>  end</span><span id="86c3" class="lx iv hi lo b fi mc lz l ma mb">  ...<br/>end</span></pre><p id="b02b" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">好吧，这里有一个很小的改动:</p><ul class=""><li id="10bb" class="kx ky hi ju b jv kr jz ks kd kz kh la kl lb kp lc ld le lf bi translated">改变了uid -&gt; sid来表示我们正在使用一个人的<code class="du ll lm ln lo b">session_id</code></li><li id="0b07" class="kx ky hi ju b jv lg jz lh kd li kh lj kl lk kp lc ld le lf bi translated">将预定扫描更新为1小时(<code class="du ll lm ln lo b">@sweep_after :timer.hours(1)</code>)</li><li id="c575" class="kx ky hi ju b jv lg jz lh kd li kh lj kl lk kp lc ld le lf bi translated">添加一个<code class="du ll lm ln lo b">sweep_on_login/1</code>功能，当一个人成功登录时清除会话的登录计数(我们不希望人们把自己锁在外面)</li></ul><p id="c1ed" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">完成后，进入第二步，也是最后一步。</p><h1 id="8007" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">第二步</h1><p id="75f3" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">打开您的<code class="du ll lm ln lo b">person_session_controller.ex</code>文件(或等效文件),我们将使用<code class="du ll lm ln lo b">case</code>语句包装我们的日志逻辑:</p><pre class="lp lq lr ls fd lt lo lu lv aw lw bi"><span id="2da1" class="lx iv hi lo b fi ly lz l ma mb">#your_app_web/controllers/person_session_controller.ex</span><span id="bfcd" class="lx iv hi lo b fi mc lz l ma mb">defmodule YourAppWeb.PersonSessionController do<br/>  ...  <br/>  alias YourAppWeb.Accounts<br/>  alias YourAppWeb.Extensions.MaxLoginProcessor <br/>  ...</span><span id="52ae" class="lx iv hi lo b fi mc lz l ma mb">  def create(conn, %{"person" =&gt; person_params}) do<br/>    %{"email" =&gt; email, "password" =&gt; password = person_params<br/>    %{"_csrf_token" =&gt; session_token} = conn |&gt; get_session()</span><span id="0bcd" class="lx iv hi lo b fi mc lz l ma mb">    case MaxLoginProcessor.log(session_token) do<br/>      {:ok, count} -&gt;<br/>        case Accounts.get_person_by_email_and_password(email,<br/>                      password) do<br/>          {:ok, person} -&gt;<br/>            MaxLoginProcessor.sweep_on_login(session_token)<br/>            ...<br/>          # Your errors here<br/>          # You can add logic to display remaining log in attempts<br/>          # alongside your existing auth error logic.<br/>          # Your auth error logic should be redirecting back<br/>          # to log in.<br/>          ...<br/>        end  <br/>      {:error, :rate_limited} -&gt;<br/>        conn<br/>        |&gt; put_flash(:error, "Your message here.")<br/>        |&gt; redirect(to: Routes.person_session_path(conn, :new)<br/>    end<br/>  end</span><span id="72b6" class="lx iv hi lo b fi mc lz l ma mb">  ...<br/>end</span></pre><p id="9fca" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">就是这样！</p><p id="11fe" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">现在，正如我在评论中提到的，你可以微调你向人们显示的信息，但这是它如何工作的总体结构:</p><ol class=""><li id="6710" class="kx ky hi ju b jv kr jz ks kd kz kh la kl lb kp md ld le lf bi translated">如果一个人成功登录，那么我们调用我们的<code class="du ll lm ln lo b">sweep_on_login/1</code>函数，传递这个人的<code class="du ll lm ln lo b">session_token</code>(我们从<code class="du ll lm ln lo b">conn</code>模式匹配而来)，清除任何现有的登录尝试。这确保了一个人可以随心所欲地来去，而不会将自己锁定在帐户之外。</li><li id="bc69" class="kx ky hi ju b jv lg jz lh kd li kh lj kl lk kp md ld le lf bi translated">如果一个人登录失败的次数太多，那么他的帐户将被锁定1小时(我们在<code class="du ll lm ln lo b">max_login_processor</code>中安排的扫描时间)。</li></ol><h1 id="f2f6" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">说明</h1><p id="38de" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">我们选择这种方法有几个原因:</p><ul class=""><li id="f26b" class="kx ky hi ju b jv kr jz ks kd kz kh la kl lb kp lc ld le lf bi translated">增加一个人的暴力尝试的摩擦</li><li id="1fad" class="kx ky hi ju b jv lg jz lh kd li kh lj kl lk kp lc ld le lf bi translated">给意外将自己锁在外面的人增加最小的摩擦</li><li id="ea2d" class="kx ky hi ju b jv lg jz lh kd li kh lj kl lk kp lc ld le lf bi translated">通过使用<code class="du ll lm ln lo b">session_id</code>而不是IP地址来尊重人们的隐私</li><li id="86d8" class="kx ky hi ju b jv lg jz lh kd li kh lj kl lk kp lc ld le lf bi translated">是“盲的”,因为它适用于所有会话，而不管帐户是否存在</li></ul><p id="b4bb" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">稍微详细说明一下，如果有人试图暴力破解一个人的帐户(只有他们可以通过他们的密码访问)，那么暴力攻击者将不得不不断地开始新的会话和/或等待一个小时。这不是不可能的，但它使攻击需要更多的工作(这是游戏的名称)。</p><p id="a784" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">另一方面，如果一个人不小心把自己锁在外面，那么他们可以开始一个新的会话(比如一个匿名窗口)或者等待1个小时。再说一次，我们不想让人们的经历更加痛苦，以防有人试图闯入他们的帐户(已经有其他防御措施，如强密码、可选的2FA和“盲目”错误消息)。</p><p id="2ee8" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">最后，通过使用<code class="du ll lm ln lo b">session_id</code>,我们尊重人们的隐私，不提取和记录(即使是暂时的)他们的IP地址，这可能与他们的位置直接相关(除非在一个良好的VPN后面)。此外，当我们将<code class="du ll lm ln lo b">session_id</code>方法与“盲”错误消息(不显示某人是否拥有我们的帐户的消息)结合使用时，它可以进一步保护人们的隐私，因为如果攻击者试图闯入现有或不存在的帐户，他们也会得到相同的错误。</p><h1 id="2974" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">结论</h1><p id="2bb9" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">原来如此！</p><p id="4a7e" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">如果您正在考虑在您的Elixir/Phoenix应用程序中限制登录尝试，并且希望尊重人们的隐私，希望它能帮助您。</p><p id="0383" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">你可以很容易地定制<code class="du ll lm ln lo b">max_login_processor</code>来进一步满足你的特定需求。</p><blockquote class="me mf mg"><p id="748b" class="js jt kq ju b jv kr jx jy jz ks kb kc mh kt kf kg mi ku kj kk mj kv kn ko kp hb bi translated">如果你有兴趣了解更多关于<em class="hi">变形</em>的信息，那么跟随我们的公司<a class="ae kw" href="https://coretheory.transistor.fm/" rel="noopener ugc nofollow" target="_blank">播客</a>或者在<a class="ae kw" href="https://www.patreon.com/coretheory" rel="noopener ugc nofollow" target="_blank"> Patreon </a>上支持我们，并保持关注——我们的网络生活即将发生变革！</p></blockquote><p id="9187" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">永远欢迎改进和想法，谢谢！</p><p id="8d38" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">💚标记</p></div></div>    
</body>
</html>