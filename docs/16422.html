<html>
<head>
<title>Integration Test for Azure Functions and Cosmos DB walkthrough</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure函数和Cosmos DB演练的集成测试</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/integration-test-for-azure-functions-and-cosmos-db-walkthrough-aec0d4198567?source=collection_archive---------1-----------------------#2022-12-27">https://medium.com/geekculture/integration-test-for-azure-functions-and-cosmos-db-walkthrough-aec0d4198567?source=collection_archive---------1-----------------------#2022-12-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/0b6d1e699afe1597a3a92ef39fcce513.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UO8k9CTWvwlxpAVsUivtkQ.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Photo by <a class="ae iu" href="https://pixabay.com/users/红火-2936866/" rel="noopener ugc nofollow" target="_blank">红火</a> on <a class="ae iu" href="https://pixabay.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Pixabay</a></figcaption></figure><h1 id="830b" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">渴望阅读</h1><p id="f46f" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">用简单的设置运行<em class="kr">集成</em>测试有一个很大的优势。它帮助您在过程的早期发现错误，并确保代码按预期运行。按照下面我的指导运行Azure Function和Cosmos DB的集成测试。</p><h1 id="b852" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">更大的</h1><blockquote class="ks kt ku"><p id="a88a" class="jt ju kr jv b jw kv jy jz ka kw kc kd kx ky kg kh kz la kk kl lb lc ko kp kq hb bi translated"><strong class="jv hj">集成测试</strong> —是一种软件测试，将软件应用程序的不同单元、模块或组件作为一个组合实体进行测试。</p></blockquote><p id="1417" class="pw-post-body-paragraph jt ju hi jv b jw kv jy jz ka kw kc kd ke ky kg kh ki la kk kl km lc ko kp kq hb bi translated">如果可能的话，在本地增加依赖项是一个很好的做法。您应该选择对本地数据库而不是远程数据库运行测试。这有两个优点:</p><ol class=""><li id="77fb" class="ld le hi jv b jw kv ka kw ke lf ki lg km lh kq li lj lk ll bi translated">测试在本地运行比在远程数据库上运行更快。</li><li id="4448" class="ld le hi jv b jw lm ka ln ke lo ki lp km lq kq li lj lk ll bi translated">你独立于其他开发人员运行测试。来自其他机器的测试数据不会影响您的数据库。</li></ol><h1 id="a142" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">被测系统</h1><blockquote class="ks kt ku"><p id="5276" class="jt ju kr jv b jw kv jy jz ka kw kc kd kx ky kg kh kz la kk kl lb lc ko kp kq hb bi translated"><strong class="jv hj"> Azure Functions </strong>是一个按需提供的云服务，提供运行应用程序所需的所有持续更新的基础设施和资源。您专注于对您来说最重要的代码，使用对您来说最有生产力的语言，函数处理剩下的事情。</p></blockquote><p id="c953" class="pw-post-body-paragraph jt ju hi jv b jw kv jy jz ka kw kc kd ke ky kg kh ki la kk kl km lc ko kp kq hb bi translated">对于这个例子，我放入了一个Azure函数。它向<em class="kr">公开一个端点，创建</em>汽车:</p><pre class="lr ls lt lu fd lv lw lx bn ly lz bi"><span id="5b38" class="ma iw hi lw b be mb mc l md me">public class CarFunction<br/>{<br/>    private readonly ICarRepository _carRepository;<br/>    private readonly ILogger&lt;CarFunction&gt; _logger;<br/><br/>    public CarFunction(ICarRepository carRepository, ILogger&lt;CarFunction&gt; logger)<br/>    {<br/>        _carRepository = carRepository ?? throw new ArgumentNullException(nameof(carRepository));<br/>        _logger = logger ?? throw new ArgumentNullException(nameof(logger));<br/>    }<br/><br/>    [FunctionName("CreateCar")]<br/>    public async Task&lt;IActionResult&gt; CreateCar([HttpTrigger(AuthorizationLevel.Anonymous, "post", Route = "cars")] CarRequest request, HttpRequest req)<br/>    {<br/>        try<br/>        {<br/>            if (string.IsNullOrWhiteSpace(request.Name))<br/>                return new BadRequestObjectResult("Name is mandatory.");<br/><br/>            var createdCar = await _carService.CreateCar(request);<br/><br/>            return new CreatedResult("/cars/" + createdCar.Id, createdCar);<br/>        }<br/>        catch (Exception ex)<br/>        {<br/>            return new ObjectResult(ex.Message) { StatusCode = 500 };<br/>        }<br/>    }<br/>}</span></pre><p id="20ae" class="pw-post-body-paragraph jt ju hi jv b jw kv jy jz ka kw kc kd ke ky kg kh ki la kk kl km lc ko kp kq hb bi translated">我们将使用Cosmos DB来存储汽车。下面是存储库的外观:</p><pre class="lr ls lt lu fd lv lw lx bn ly lz bi"><span id="3893" class="ma iw hi lw b be mb mc l md me">public class CarRepository : ICarRepository<br/>{<br/>    private CosmosClient _cosmosClient;<br/>    private Container _container;<br/><br/>   public CarRepository(IOptions&lt;Configuration&gt; configuration)<br/>    {<br/>        this._cosmosClient = new CosmosClient(configuration.Value.ConnectionString);<br/>        this._container = _cosmosClient.GetContainer("CarDatabase", "Cars");<br/>    }<br/>    public async Task&lt;Car&gt; Create(Car car)<br/>    {<br/>        var itemResponse = await _container.CreateItemAsync(car, new PartitionKey(car.Id));<br/>        return itemResponse.Resource;<br/>    }<br/>}</span></pre><p id="03c7" class="pw-post-body-paragraph jt ju hi jv b jw kv jy jz ka kw kc kd ke ky kg kh ki la kk kl km lc ko kp kq hb bi translated">因为我们使用功能应用程序，所以我们必须有<code class="du mf mg mh lw b">Startup.cs</code>:</p><pre class="lr ls lt lu fd lv lw lx bn ly lz bi"><span id="21b8" class="ma iw hi lw b be mb mc l md me">public class Startup : FunctionsStartup<br/>{<br/>    private const string configurationSection = "Cars:Database";<br/>    <br/>    protected virtual IConfigurationRoot GetConfigurationRoot(IFunctionsHostBuilder functionsHostBuilder)<br/>    {<br/>        var local = new ConfigurationBuilder()<br/>            .AddJsonFile(Path.Combine(Environment.CurrentDirectory, "local.settings.json"), true, true)<br/>            .AddEnvironmentVariables()<br/>            .Build();<br/>        return local;<br/>    }<br/>    <br/>    public override void Configure(IFunctionsHostBuilder builder)<br/>    {<br/>        var local = GetConfigurationRoot(builder);<br/>        var config = new ConfigurationBuilder().AddEnvironmentVariables();<br/>        var configurationSection = local.GetSection(configurationSection);<br/>        builder.Services.Configure&lt;Configuration&gt;(configurationSection);<br/>        var configuration = config.Build();<br/>        builder.Services.AddInfrastructure(configuration);<br/>    }<br/>}</span></pre><h2 id="8206" class="mi iw hi bd ix mj mk ml jb mm mn mo jf ke mp mq jj ki mr ms jn km mt mu jr mv bi translated">Azure Cosmos DB模拟器</h2><p id="b4f2" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">我们将针对Azure CosmosDB的本地实例运行我们的集成测试。此处可下载<a class="ae iu" href="https://aka.ms/cosmosdb-emulator" rel="noopener ugc nofollow" target="_blank">。这是它启动后的样子:</a></p><figure class="lr ls lt lu fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mw"><img src="../Images/f8b62395fee770a9f6bd7496e8cc0358.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6M0gic4v-DyUyOt2l3v4Xg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Azure Cosmos DB Emulator in browser</figcaption></figure><h1 id="ec1d" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">依赖注入</h1><p id="2bb4" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">集成测试设置的关键部分是配置<em class="kr">依赖注入</em>。您需要以下设置类:</p><h2 id="fdaa" class="mi iw hi bd ix mj mk ml jb mm mn mo jf ke mp mq jj ki mr ms jn km mt mu jr mv bi translated">测试启动</h2><p id="9f66" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">我们将从<code class="du mf mg mh lw b">Startup</code>类派生来定义<em class="kr">依赖注入</em>用于我们的测试。</p><pre class="lr ls lt lu fd lv lw lx bn ly lz bi"><span id="25cc" class="ma iw hi lw b be mb mc l md me">public class TestStartup : Startup<br/>{<br/>    protected override IConfigurationRoot GetConfigurationRoot(IFunctionsHostBuilder functionsHostBuilder)<br/>    {<br/>        var currentDirectory = AppDomain.CurrentDomain.BaseDirectory;<br/>        var configuration = new ConfigurationBuilder()<br/>            .SetBasePath(currentDirectory)<br/>            .AddJsonFile("appsettings.json", true, true)<br/>            .AddJsonFile("local.settings.json", true, true)<br/>            .AddEnvironmentVariables()<br/>            .Build();<br/><br/>        return configuration;<br/>      }<br/><br/>      public override void Configure(IFunctionsHostBuilder builder)<br/>      {<br/>          base.Configure(builder);<br/>          builder.Services.AddTransient&lt;CarsFunction&gt;();<br/>      }<br/>  }</span></pre><h1 id="0b48" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">配置</h1><p id="f656" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">在git存储库中存储密钥和秘密是不明智的。对于本地开发，我们可以使用<code class="du mf mg mh lw b">local.settings.json</code>来存储配置。然而我们可以使用<code class="du mf mg mh lw b">appsettings.json</code>来管理配置。例如，我们可以在Azure管道中使用<a class="ae iu" href="https://learn.microsoft.com/en-us/azure/devops/pipelines/process/variables?view=azure-devops&amp;tabs=yaml%2Cbatch" rel="noopener ugc nofollow" target="_blank">管道变量</a>和<a class="ae iu" href="https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/file-transform-v1?view=azure-pipelines" rel="noopener ugc nofollow" target="_blank"> FileTransform </a>。<a class="ae iu" href="https://www.youtube.com/watch?v=_iPfzH3ENAk" rel="noopener ugc nofollow" target="_blank">这里的</a>是我们如何实现它的例子。</p><p id="8cd6" class="pw-post-body-paragraph jt ju hi jv b jw kv jy jz ka kw kc kd ke ky kg kh ki la kk kl km lc ko kp kq hb bi translated"><code class="du mf mg mh lw b">local.settings.json</code>(不该离开你的本地机器):</p><pre class="lr ls lt lu fd lv lw lx bn ly lz bi"><span id="7f2e" class="ma iw hi lw b be mb mc l md me">{<br/>  "Cars": {<br/>    "Database": {<br/>      "ConnectionString": "AccountEndpoint=https://localhost:8081/;AccountKey=C2y6yDjf5/R+ob0N8A7Cgv30VRDJIWEHLM+4QDU5DE2nQ9nDuVTqobD4b8mGGyPMbIZnqyMsEcaGQy67XIw/Jw=="<br/>    }<br/>  }<br/>}</span></pre><p id="b88c" class="pw-post-body-paragraph jt ju hi jv b jw kv jy jz ka kw kc kd ke ky kg kh ki la kk kl km lc ko kp kq hb bi translated"><code class="du mf mg mh lw b">appsettings.json</code>(保持在源代码控制中，并通过CI/CD管道到达)</p><pre class="lr ls lt lu fd lv lw lx bn ly lz bi"><span id="80cf" class="ma iw hi lw b be mb mc l md me">{<br/>  "Cars": {<br/>    "Database": {<br/>      "ConnectionString": ""<br/>    }<br/>  }<br/>}</span></pre><h2 id="89df" class="mi iw hi bd ix mj mk ml jb mm mn mo jf ke mp mq jj ki mr ms jn km mt mu jr mv bi translated">测试初始化器</h2><p id="3d7f" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">我们想使用一个测试主机，通过<code class="du mf mg mh lw b">TestStartup</code>进行<em class="kr">集成测试</em>。</p><pre class="lr ls lt lu fd lv lw lx bn ly lz bi"><span id="0129" class="ma iw hi lw b be mb mc l md me">public class TestsInitializer<br/>{<br/>    public TestsInitializer()<br/>    {<br/>        var host = new HostBuilder()<br/>            .ConfigureWebJobs(builder =&gt; builder.UseWebJobsStartup(typeof(TestStartup), new WebJobsBuilderContext(), NullLoggerFactory.Instance))<br/>            .Build();<br/><br/>        ServiceProvider = host.Services;<br/>    }<br/><br/>    public IServiceProvider ServiceProvider { get; }<br/>}</span></pre><p id="9f1c" class="pw-post-body-paragraph jt ju hi jv b jw kv jy jz ka kw kc kd ke ky kg kh ki la kk kl km lc ko kp kq hb bi translated">我们还需要通过从<code class="du mf mg mh lw b">ICollectionFixture</code>类派生来包含一个<strong class="jv hj">集合定义</strong>。</p><pre class="lr ls lt lu fd lv lw lx bn ly lz bi"><span id="a3cb" class="ma iw hi lw b be mb mc l md me">[CollectionDefinition(Name)]<br/>public class IntegrationTestsCollection : ICollectionFixture&lt;TestsInitializer&gt;<br/>{<br/>    public const string Name = nameof(IntegrationTestsCollection);<br/>}</span></pre><h2 id="681a" class="mi iw hi bd ix mj mk ml jb mm mn mo jf ke mp mq jj ki mr ms jn km mt mu jr mv bi translated">整合测试</h2><p id="176a" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">我们终于可以实现我们的<em class="kr">集成测试</em>:</p><pre class="lr ls lt lu fd lv lw lx bn ly lz bi"><span id="31aa" class="ma iw hi lw b be mb mc l md me">[Collection(IntegrationTestsCollection.Name)]<br/>public class CarFunctionTests : IClassFixture&lt;TestStartup&gt;, IAsyncLifetime<br/>{<br/>    private CarFunction _carFunction;<br/>    private readonly TestsInitializer _testsInitializer;<br/>    private readonly CosmosClient _cosmosClient;<br/>    private Container _container;<br/>    private readonly string _carId;<br/>    <br/>    public CarFunctionTests(TestsInitializer testsInitializer)<br/>    {<br/>        _testsInitializer = testsInitializer;<br/>        <br/>        var cosmosDatabaseConfiguration = testsInitializer.ServiceProvider.GetService&lt;IOptions&lt;CarConfiguration&gt;&gt;();<br/>        _cosmosClient = new CosmosClient(cosmosDatabaseConfiguration.Value.EndpointUri, cosmosDatabaseConfiguration.Value.PrimaryKey);<br/>        _carFunction = _testsInitializer.ServiceProvider.GetService&lt;CarFunction&gt;();<br/>    }<br/>    [Fact]<br/>    public async void TestCreateCar()<br/>    {<br/>        // Arrange<br/>        var carName = $"BMW - {Guid.NewGuid()}";<br/>        var carRequest = new CarRequest { Name = carName };<br/>        <br/>        // Act<br/>        var response = await _carFunction.CreateCar(, new DefaultHttpContext().Request);<br/>        var createdResponse = (CreatedResult)_response;<br/>        _carId = (createdResponse.Value as Car).Id;<br/>        <br/>        // Assert<br/>        Assert.IsType&lt;CreatedResult&gt;(createdResponse);<br/>        Assert.Equal(carName, (createdResponse.Value as Car).Name);<br/>    }<br/>    public async Task InitializeAsync()<br/>    {<br/>        var databaseResponse = await _cosmosClient.CreateDatabaseIfNotExistsAsync("CarDatabase");<br/>        var database = databaseResponse.Database;<br/>        <br/>        var containerResponse = await database.CreateContainerIfNotExistsAsync("Cars", "/id");<br/>        _container = containerResponse.Container;<br/>    }<br/>    public async Task DisposeAsync()<br/>    {<br/>        await _container.DeleteItemAsync&lt;Car&gt;(_carId, new PartitionKey(_carId));<br/>    }<br/>}</span></pre><h2 id="6e70" class="mi iw hi bd ix mj mk ml jb mm mn mo jf ke mp mq jj ki mr ms jn km mt mu jr mv bi translated">运行测试</h2><p id="38a5" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">我们可以用<code class="du mf mg mh lw b">dotnet test</code>命令运行我们的集成测试。</p><figure class="lr ls lt lu fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mx"><img src="../Images/aa7b3500809f424b150e7f8e841915d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kjcS7pDDhgGBIn2pQ5tSbQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Result of running dotnet test command</figcaption></figure><h1 id="7ac1" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">摘要</h1><p id="2b42" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">我们已经为Azure Function和Cosmos DB编写了一个<em class="kr">集成测试</em>。我们还使用了可替换的配置和已配置的依赖注入来为我们工作。</p><h1 id="e264" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">资源</h1><ol class=""><li id="a959" class="ld le hi jv b jw jx ka kb ke my ki mz km na kq li lj lk ll bi translated"><a class="ae iu" href="https://learn.microsoft.com/en-us/azure/cosmos-db/local-emulator?tabs=ssl-netstd21" rel="noopener ugc nofollow" target="_blank">使用Azure Cosmos DB Emulator | Microsoft Learn</a>进行本地安装和开发。</li><li id="86fe" class="ld le hi jv b jw lm ka ln ke lo ki lp km lq kq li lj lk ll bi translated"><a class="ae iu" href="https://www.youtube.com/watch?v=_iPfzH3ENAk" rel="noopener ugc nofollow" target="_blank">应用程序配置的文件转换</a>。</li></ol></div></div>    
</body>
</html>