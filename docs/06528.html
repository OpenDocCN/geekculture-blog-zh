<html>
<head>
<title>Ways to delete multiple keys from Redis cache.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从Redis缓存中删除多个键的方法。</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/how-to-delete-multiple-keys-from-redis-cache-252275a95579?source=collection_archive---------7-----------------------#2021-08-23">https://medium.com/geekculture/how-to-delete-multiple-keys-from-redis-cache-252275a95579?source=collection_archive---------7-----------------------#2021-08-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/1902b77bffc1d8ef78ccd04e0e33afca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lQmVRpemjP6hbvCljYR9Zw.jpeg"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">Photo by <a class="ae hv" href="https://unsplash.com/@ujesh?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Ujesh Krishnan</a> on <a class="ae hv" href="https://unsplash.com/s/photos/delete?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><div class=""/><p id="9d5a" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Redis缓存键可以用两种方法删除。</p><h2 id="3976" class="jt ju hy bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated"><strong class="ak">用按键命令</strong></h2><p id="e05d" class="pw-post-body-paragraph iv iw hy ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">Keys命令将扫描Redis数据库中存在的所有键，匹配的模式作为单次输入提供。如果您有数百万个密钥，扫描生产Redis中的所有密钥将需要时间。众所周知，Redis是单线程的，扫描prod Redis缓存中的所有键会阻止其他Redis命令运行。因此，我们需要避免在prod Redis实例上使用keys命令。</p><h2 id="ef9d" class="jt ju hy bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">带有Lua脚本的扫描命令。</h2><p id="3aa5" class="pw-post-body-paragraph iv iw hy ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">因为<code class="du kt ku kv kw b"><strong class="ix hz">Scan</strong></code>命令允许增量迭代，每次调用只返回少量元素。默认情况下，扫描以10个为一组返回密钥。如果您想要多于或少于10，您可以使用COUNT来指定。请确保不要给计数值太大。如果你给的计数值太大，那么它将只作为按键命令工作。我们可以将扫描命令与Lua脚本结合起来，以利用Lua脚本的优势。下面是使用Lua脚本进行Redis操作的一些优点。</p><p id="59b6" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae hv" href="https://developpaper.com/benefits-and-sample-code-of-redis-executing-lua-scripts/" rel="noopener ugc nofollow" target="_blank">Lua脚本的好处</a> <strong class="ix hz"> : </strong></p><p id="c3ae" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">1.减少网络开销:原来五个网络请求的操作可以用一个请求完成，原来五个请求的逻辑可以在Redis服务器上完成。脚本的使用减少了网络往返延迟。</p><p id="0646" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">2.原子操作:Redis会将整个脚本作为一个整体执行，不会被其他命令插入。</p><p id="df3f" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">3.重用:客户端发送的脚本将永久存储在Redis中，这意味着其他客户端可以重用该脚本，而无需使用代码来完成相同的逻辑。</p><p id="d806" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在让我们看看如何用both方法删除这个键。</p><ul class=""><li id="8ac2" class="kx ky hy ix b iy iz jc jd jg kz jk la jo lb js lc ld le lf bi translated"><strong class="ix hz">通过按键命令</strong> :-</li></ul><p id="d757" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们可以使用如下的keys命令从Redis中删除所有匹配给定模式"<code class="du kt ku kv kw b">user*" </code>的键。</p><pre class="lg lh li lj fd lk kw ll lm aw ln bi"><span id="582d" class="jt ju hy kw b fi lo lp l lq lr"><strong class="kw hz">redis-cli -h {host}-p {port} — raw keys “</strong>users*<strong class="kw hz">” | </strong><strong class="kw hz">xargs redis-cli DEL</strong></span></pre><p id="bfe1" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hz">注意:- </strong>不建议在生产Redis实例上使用。</p><ul class=""><li id="e408" class="kx ky hy ix b iy iz jc jd jg kz jk la jo lb js lc ld le lf bi translated"><strong class="ix hz">用Lua脚本扫描命令删除缓存键:- <br/>这个</strong> <br/>我写过Lua脚本按模式删除多个键。脚本使用scan命令在增量迭代中删除Redis缓存键。请按照以下步骤，通过带有扫描命令的Lua脚本删除带有模式的Redis键。</li><li id="0be4" class="kx ky hy ix b iy ls jc lt jg lu jk lv jo lw js lc ld le lf bi translated">在你的机器上复制下面的Lua脚本，并用。lua扩展。</li></ul><pre class="lg lh li lj fd lk kw ll lm aw ln bi"><span id="f1a2" class="jt ju hy kw b fi lo lp l lq lr">local cursor="0";<br/>local count = 0;<br/>repeat<br/> #replace "REPLACE_ME_IAM_KEY_PATTERN" with your key pattern that you want to delete<br/> local scanResult = redis.call("SCAN", cursor, "MATCH", "REPLACE_ME_IAM_KEY_PATTERN", "COUNT", 100);<br/>	local keys = scanResult[2];<br/>	for i = 1, #keys do<br/>		local key = keys[i];<br/>		redis.replicate_commands()<br/>		redis.call("DEL", key);<br/>		count = count +1;<br/>	end;<br/>	cursor = scanResult[1];<br/>until cursor == "0";<br/>return "Total "..count.." keys Deleted" ;</span></pre><ul class=""><li id="9929" class="kx ky hy ix b iy iz jc jd jg kz jk la jo lb js lc ld le lf bi translated">在本地创建文件后。请确保您对要删除的密钥模式进行了更改。(这一步对于验证您是否要从Redis中删除预期的密钥非常重要)</li><li id="4567" class="kx ky hy ix b iy ls jc lt jg lu jk lv jo lw js lc ld le lf bi translated">请CD到你创建Lua脚本的文件夹</li><li id="f48e" class="kx ky hy ix b iy ls jc lt jg lu jk lv jo lw js lc ld le lf bi translated">通过替换适当的主机，用下面的命令运行Lua脚本。</li><li id="4f3f" class="kx ky hy ix b iy ls jc lt jg lu jk lv jo lw js lc ld le lf bi translated"><strong class="ix hz">Comamnd:-redis-CLI-h</strong><a class="ae hv" href="http://dev-acminterface-new.5gksuj.ng.0001.use1.cache.amazonaws.com" rel="noopener ugc nofollow" target="_blank"><strong class="ix hz">{</strong></a><strong class="ix hz">host }-eval Delete-keys . Lua</strong></li><li id="3f14" class="kx ky hy ix b iy ls jc lt jg lu jk lv jo lw js lc ld le lf bi translated">命令将返回被Lua脚本删除的键的总数。<br/>示例:- <strong class="ix hz">总计“删除100个键”</strong></li></ul><p id="0645" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hz">注意:请注意，EVAL命令还会阻塞Redis实例，直到完成lua脚本。</strong></p><p id="fa6c" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">感谢您的阅读…！！！☺️ </p></div><div class="ab cl lx ly gp lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="hb hc hd he hf"><p id="fb07" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae hv" href="https://developpaper.com/benefits-and-sample-code-of-redis-executing-lua-scripts/" rel="noopener ugc nofollow" target="_blank">Lua脚本的优势</a></p></div></div>    
</body>
</html>