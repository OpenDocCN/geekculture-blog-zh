<html>
<head>
<title>Integrate HashiCorp Vault with CICD tool(Jenkins)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">集成哈希公司保险库与CICD工具(詹金斯)</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/integrate-hashicorp-vault-with-cicd-tool-jenkins-4bf712ad3f45?source=collection_archive---------0-----------------------#2022-02-02">https://medium.com/geekculture/integrate-hashicorp-vault-with-cicd-tool-jenkins-4bf712ad3f45?source=collection_archive---------0-----------------------#2022-02-02</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/b0a793e20666cdbf705b30491fd8fb68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ITIThZ3p_ABXPZlE.png"/></div></div></figure><h1 id="3702" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated"><strong class="ak">什么是跳马？</strong></h1><p id="aaf4" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">HashiCorp Vault旨在帮助组织管理对机密的访问，并在组织内安全地传输它们。机密被定义为需要严格控制和监控的任何形式的敏感凭证，可用于解锁敏感信息。秘密可以是密码、API密钥、SSH密钥、RSA令牌或OTP的形式。</p><p id="6cdd" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">HashiCorp Vault通过为您提供一个单边界面来管理基础架构中的每个秘密，使控制和管理访问变得非常容易。不仅如此，您还可以创建详细的审计日志，并跟踪谁访问了什么。</p><h1 id="9d8d" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated"><strong class="ak">为什么要和詹金斯一起使用金库？</strong></h1><p id="0019" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">将我们的秘密凭证保存在Jenkins中的一个非常常见的问题是pipeline如何处理凭证。每当管道获得一个限定了范围的秘密时，对于管道可以使用它们的数量和方式没有限制。考虑到管道可能与不受控制的外部环境相互作用，这构成了潜在的安全威胁。</p><p id="5fed" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">Jenkins的下一个问题是其加密方法的使用。有一个静态的单个公共主密钥和静态的单个公共hudson.util.Secret对象。这两者结合起来加密我们的凭证。如果对我们的Jenkins主机的访问受到威胁，我们就有泄露这两个密钥的风险，因此凭据将会暴露。</p><p id="7968" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">这就是Vault拯救我们的地方。它做的第一件事是在Jenkins上添加了另一层身份验证。它的下一个优势是它的访问控制策略。我们可以添加多个策略来访问同一个秘密。然后我们可以在管道中调用它，记住我们要给多少访问权。我们甚至可以为机器和程序定义访问权限。这为我们提供了更好的隔离和模式化的访问规则。</p><p id="5496" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">下面是工作流程图，直观地展示了他们是如何相互沟通的。</p><figure class="ks kt ku kv fd ij er es paragraph-image"><div class="er es kr"><img src="../Images/f16db916d9be8891cd8f491834d96b57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*-5g0XNAdNWvb1ErsilccnA.png"/></div><figcaption class="kw kx et er es ky kz bd b be z dx">Workflow diagram</figcaption></figure><h1 id="5da0" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated"><strong class="ak">先决条件</strong></h1><ul class=""><li id="91e6" class="la lb hi jq b jr js jv jw jz lc kd ld kh le kl lf lg lh li bi translated">已安装保险库。</li><li id="fa8e" class="la lb hi jq b jr lj jv lk jz ll kd lm kh ln kl lf lg lh li bi translated">詹金斯安装了。</li><li id="bf93" class="la lb hi jq b jr lj jv lk jz ll kd lm kh ln kl lf lg lh li bi translated">启用对vault的访问需要安装<em class="lo"> hashicorp-vault-plugin </em>和一个正在运行的Vault实例。</li><li id="3043" class="la lb hi jq b jr lj jv lk jz ll kd lm kh ln kl lf lg lh li bi translated">接下来，我们需要决定访问它的身份验证方法。Hashicorp为我们提供了多种身份验证方法，列举如下:<br/>AWS<br/>Azure<br/>Google Cloud<br/>AppRole<br/>GitHub<br/>Kubernetes<br/>LDAP<br/>TLS证书<br/>令牌<br/>用户名和密码<br/> MFA(遗留/不支持)…等等..</li></ul><p id="da5b" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">由于我们的目标是将Jenkins连接到Vault，因此最好的方法是使用AppRole。</p><h1 id="5f14" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">合适的认证方法</h1><p id="9076" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">“AppRole”代表一组保险库策略和登录限制，必须满足这些策略才能接收令牌。可以为一台特定的机器，甚至是该机器上的一个特定用户，或者跨机器的一个服务创建一个AppRole。</p><h1 id="be35" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated"><strong class="ak"> 1。创建AppRole </strong></h1><p id="9e6b" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">要首先启用approle，您必须添加vault url &amp;token以通过vault进行身份验证。在我的例子中，我以dev和local的身份运行vault，因此我给出了环回地址(如下所示)。下面我使用我的测试vault根令牌来连接vault:</p><pre class="ks kt ku kv fd lp lq lr ls aw lt bi"><span id="84e4" class="lu ir hi lq b fi lv lw l lx ly">$ <em class="lo">export VAULT_ADDR='</em><a class="ae lz" href="http://127.0.0.1:8200'" rel="noopener ugc nofollow" target="_blank"><em class="lo">http://127.0.0.1:8200'</em></a><br/><em class="lo">$ export VAULT_TOKEN=”s.qZXTYvG…….ecF9uoX”</em></span></pre><figure class="ks kt ku kv fd ij er es paragraph-image"><div class="er es ma"><img src="../Images/96ea0e89f0974da7c3d47ec9e3cc41e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1008/format:webp/1*TaKMXoIQsN3y70HUwF6CAQ.png"/></div></figure><p id="ea36" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">下面是在vault中启用适当身份验证的命令。</p><pre class="ks kt ku kv fd lp lq lr ls aw lt bi"><span id="e046" class="lu ir hi lq b fi lv lw l lx ly"><em class="lo">$ vault auth enable approle</em></span></pre><figure class="ks kt ku kv fd ij er es paragraph-image"><div class="er es mb"><img src="../Images/b25f2379a2484420e35e498bde0f869a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1006/format:webp/1*JTivaC9qHU6vG0J-2ns0Vw.png"/></div></figure><p id="1651" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">然后，创建一个角色在Jenkins中使用它，</p><pre class="ks kt ku kv fd lp lq lr ls aw lt bi"><span id="e15d" class="lu ir hi lq b fi lv lw l lx ly"><em class="lo">$ </em>vault write auth/approle/role/jenkins-role token_num_uses=0 secret_id_num_uses=0 policies="jenkins"</span></pre><p id="c9ab" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated"><strong class="jq hj"> <em class="lo">注意:</em> </strong> <em class="lo">如果你想让你的token和secret_it_ttl永远存在，那么就把token_ttl和secret_id_ttl设置为0 </em>。</p><figure class="ks kt ku kv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mc"><img src="../Images/ca947a7d9fa37f929d98cab95fea243d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vk5V12LdU74hzV6UX7dk7g.png"/></div></div></figure><p id="2005" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">现在我们已经创建了我们的角色，要成功登录，我们需要角色ID和秘密ID，要获取它们，运行下面的命令。</p><pre class="ks kt ku kv fd lp lq lr ls aw lt bi"><span id="036f" class="lu ir hi lq b fi lv lw l lx ly"><em class="lo">$ vault read auth/approle/role/jenkins-role/role-id</em></span><span id="69ec" class="lu ir hi lq b fi md lw l lx ly"><em class="lo">$ vault write -f auth/approle/role/jenkins-role/secret-id</em></span></pre><figure class="ks kt ku kv fd ij er es paragraph-image"><div class="er es me"><img src="../Images/7057972763d8720606d05e5b9e142f3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1180/format:webp/1*BLSe_1NI7XtBfLwKS8xWFA.png"/></div></figure><p id="b8dd" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">在保管库中创建凭据。(我们在jenkins管道中使用它)，这里我给出了测试凭证。</p><pre class="ks kt ku kv fd lp lq lr ls aw lt bi"><span id="9906" class="lu ir hi lq b fi lv lw l lx ly"><em class="lo">$ </em>vault kv put secret/dev-creds/git-pass test-git-creds=123456789</span></pre><figure class="ks kt ku kv fd ij er es paragraph-image"><div class="er es mf"><img src="../Images/d7bf8c047d85b1e736de8acf60a1df50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1302/format:webp/1*uZNj-MUPlfV8k_nlyB7ZIw.png"/></div></figure><p id="4c5d" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">因此，到目前为止，我们已经在vault中创建了一个approle和凭证，但这并不意味着创建的app role可以自由地获取机密(因为我们已经明确提到approle可以使用特定的策略)。为了解读这些秘密，我们必须创建策略并添加规则。</p><p id="37ee" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">首先，创建一个文件来提到策略，在我的例子中，我创建了<strong class="jq hj"><em class="lo">Jenkins-policy . HCl</em></strong>文件并添加了下面的代码。</p><pre class="ks kt ku kv fd lp lq lr ls aw lt bi"><span id="9cb8" class="lu ir hi lq b fi lv lw l lx ly"><em class="lo">path "secret/data/dev-creds/git-pass" {<br/> capabilities = ["read", "list"]<br/>}</em></span></pre><figure class="ks kt ku kv fd ij er es paragraph-image"><div class="er es mg"><img src="../Images/fe8a5884252d8b5b00174ab4111cdc84.png" data-original-src="https://miro.medium.com/v2/resize:fit:770/format:webp/1*pgChjDdybxAcOR4EbRglBw.png"/></div></figure><p id="35de" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">然后，在此规则的帮助下创建一个jenkins策略。运行下面的命令。</p><pre class="ks kt ku kv fd lp lq lr ls aw lt bi"><span id="23b5" class="lu ir hi lq b fi lv lw l lx ly"><em class="lo">$ vault policy write jenkins jenkins-policy.hcl</em></span></pre><figure class="ks kt ku kv fd ij er es paragraph-image"><div class="er es mh"><img src="../Images/41958a8cd20020dff79524b69712a985.png" data-original-src="https://miro.medium.com/v2/resize:fit:1012/format:webp/1*sdYRI6_NSqvrOTFnlaxyAQ.png"/></div></figure><h1 id="ae38" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">2.安装保险库插件并与Jenkins集成保险库</h1><p id="bb1f" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">首先登录Jenkins，点击管理Jenkins，然后导航到管理插件。</p><figure class="ks kt ku kv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mi"><img src="../Images/256338a778b5e506c3fe97a9dcda9867.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7CFBpg-ewh3zoNe8cr8fSA.png"/></div></div></figure><p id="ca8b" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">然后点击可用，键入哈希公司保险库，然后点击安装。</p><figure class="ks kt ku kv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mj"><img src="../Images/4cea4a045bce29e24c169396e53d281f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bEVF88pBRWWzG5VONLzx6g.png"/></div></div></figure><p id="066e" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">安装插件后，导航到管理詹金斯和配置系统。找到vault插件并填写URL，然后单击添加凭证以添加适当的身份验证，选择种类作为<strong class="jq hj"> <em class="lo"> Vault适当凭证</em> </strong>，并填写<strong class="jq hj"> <em class="lo">角色ID、秘密ID、路径和ID </em> </strong>作为通用名称以进行识别，然后单击添加。</p><figure class="ks kt ku kv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mj"><img src="../Images/d9e659ded350f174636c03120480789c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZP1Lvm0_fxfuW_nG6iABTg.png"/></div></div><figcaption class="kw kx et er es ky kz bd b be z dx">Vault authentication credentials configure in jenkins</figcaption></figure><p id="f459" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">然后单击高级设置禁用ssl证书。(在生产中，不建议禁用它)。(根据这些设置，Jenkins实际上向Vault进行了身份验证。)</p><figure class="ks kt ku kv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mk"><img src="../Images/a51540f81bfac031f28c34229e79016b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KBQjXxX7wz9cjd7IaY-gZw.png"/></div></div><figcaption class="kw kx et er es ky kz bd b be z dx">Vault plugin configure in jenkins</figcaption></figure><p id="69fb" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">现在，创建一个Jenkins管道，并添加下面的管道代码来测试从vault的秘密获取。</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="ml mm l"/></div></figure><figure class="ks kt ku kv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mn"><img src="../Images/2cd9c1b94b9911663b71a6c625c90189.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qIk7xOiXi5gdd1cAUXVagQ.png"/></div></div><figcaption class="kw kx et er es ky kz bd b be z dx">Pipeline configure</figcaption></figure><figure class="ks kt ku kv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mo"><img src="../Images/b9fc2befc0319754e1d1a4b7c06a9b7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RpRQ0Z09ejHg1L4BSk8VpQ.png"/></div></div><figcaption class="kw kx et er es ky kz bd b be z dx">Pipeline Output</figcaption></figure><p id="e6df" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">就这样，正如你看到的，它连接到vault并获取值。因为它是秘密的，所以不会在输出中粘贴实际值。</p><blockquote class="mp mq mr"><p id="2950" class="jo jp lo jq b jr km jt ju jv kn jx jy ms ko kb kc mt kp kf kg mu kq kj kk kl hb bi translated"><strong class="jq hj">注意:<br/>如果任何一步有错误，我们将看到一条拒绝访问的消息，并且环境变量将打印null。(以下是错误截图)</strong></p></blockquote><figure class="ks kt ku kv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mv"><img src="../Images/369629a17ebeb22264c2110a33424328.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GbKAgqfsN39EPZfWpSXiEQ.png"/></div></div><figcaption class="kw kx et er es ky kz bd b be z dx">Failed vault connection pipeline output</figcaption></figure><h1 id="0d07" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated"><strong class="ak">结论:</strong></h1><p id="3953" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">如您所见，将vault集成到Jenkins pipeline并不复杂，如果您做得正确，并在继续之前花一些时间了解您正在使用的引擎和版本。我希望这篇文章对你有帮助，现在集成过程似乎更明显了。</p><p id="7cd5" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">感谢您的阅读。</p></div></div>    
</body>
</html>