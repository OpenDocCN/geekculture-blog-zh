<html>
<head>
<title>Searching Redis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">搜索Redis</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/searching-redis-40e2387376f2?source=collection_archive---------14-----------------------#2021-05-30">https://medium.com/geekculture/searching-redis-40e2387376f2?source=collection_archive---------14-----------------------#2021-05-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="073a" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated"><em class="ix">当按键不行的时候</em></h2></div><figure class="iz ja jb jc fd jd er es paragraph-image"><div role="button" tabindex="0" class="je jf di jg bf jh"><div class="er es iy"><img src="../Images/cfdad14b94c0478ebf8ed13f859fb377.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*FUBvY4D9t-fY0hPs"/></div></div><figcaption class="jk jl et er es jm jn bd b be z dx">Photo by <a class="ae jo" href="https://unsplash.com/@wflwong?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Warren Wong</a> on <a class="ae jo" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="89aa" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">在我的<a class="ae jo" href="https://ranjithzachariah.medium.com/scaling-redis-571568378686" rel="noopener">上一篇文章</a>中，我描述了在扩展一个扫描繁重的redis工作负载时的一些冒险经历。我最终打算探索Redis企业。我希望把这个问题外包给redis背后的团队。</p><p id="dea2" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">事实证明扫描是不可救药的，欧比-万·科博比也救不了我们。但是，Redis Enterprise支持RediSearch模块，这提供了一个优雅的解决方案。</p><h1 id="cf98" class="kl km hi bd kn ko kp kq kr ks kt ku kv io kw ip kx ir ky is kz iu la iv lb lc bi translated">问题和天真的方法</h1><p id="1f22" class="pw-post-body-paragraph jp jq hi jr b js ld ij ju jv le im jx jy lf ka kb kc lg ke kf kg lh ki kj kk hb bi translated">让我们后退。问题中的工作负载来自一个洗车分析平台。下面是存储在redis中的示例键。这些是由前缀、位置id和牌照组成的复合密钥。存储在每个键上的值是一个会话id。</p><pre class="iz ja jb jc fd li lj lk ll aw lm bi"><span id="df36" class="ln km hi lj b fi lo lp l lq lr">“lp-sess:loc:3d5a6232–43b4–4cd8-a423–5f322d05cd85:lp:JT4344”<br/>“lp-sess:loc:84bba9e7–0a8a-4af5–8b23-f1a16844c7bb:lp:HXS290”<br/>“lp-sess:loc:7eae9995–23dd-4f0d-be0c-175979bfdc5b:lp:GMP1936”<br/>“lp-sess:loc:ea9ef92b-1814–4a24-b4b9-ec94a496f301:lp:944101”<br/>“lp-sess:loc:741100c2–4a1c-45b5-a44f-c315b63aa30b:lp:IKR069”<br/>“lp-sess:loc:a1981989-aabf-4e52–9925–78e3b93d5d2e:lp:AJT138”<br/>“lp-sess:loc:f31077cc-0bb5–4157–939c-adc08941e7ed:lp:KDC3600”<br/>“lp-sess:loc:72cf7004-abef-47c5–9d8e-22d32e22f73b:lp:9J1252”<br/>“lp-sess:loc:d76f798e-4653–4240-bb11-ec1981f1f228:lp:P556P”<br/>“lp-sess:loc:a36c0c25–4c68–46bc-962c-47f55c2198c6:lp:M275079”</span></pre><p id="370e" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">当一辆车进入给定摄像机的视野时，我们想知道我们以前是否见过这辆车。这个信息在redis。每当一辆前所未见的车进入视野，我们就把它加入数据库。复杂的因素是车牌匹配应该是模糊的。我们容忍不同板块之间的一些性格差异。</p><p id="c0c9" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">由于这个模糊规则，O(1) redis GET变成了O(n) redis SCAN。</p><p id="5c77" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">下面是令人讨厌的代码。</p><pre class="iz ja jb jc fd li lj lk ll aw lm bi"><span id="8299" class="ln km hi lj b fi lo lp l lq lr">for key in self._redis.scan_iter(match=key_mask):<br/>    _, lp_candidate = key.decode("utf-8").rsplit(":", 1)<br/>    sim = Similarity.lp_similarity_ratio(plate, lp_candidate)    </span><span id="824b" class="ln km hi lj b fi ls lp l lq lr">    if Similarity.is_similar(sim, self.__lp_sim_threshold) and (best_match is None or best_match[1] &lt; sim):<br/>        best_match = LicensePlate(lp_candidate), sim</span></pre><p id="7d9c" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">上面的<em class="lt"> key_mask </em>会将扫描结果过滤到给定的位置。我们迭代这个位置的板块。对于每一个，我们对我们的候选人应用相似性函数来识别<em class="lt">最佳匹配</em>。</p><p id="814a" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">我对SCAN如何在多节点redis集群中工作有一个乐观、错误的看法。我构建了一个分片密钥，它可以将所有密钥放在一个给定的位置。我假设通过仔细的分片和适当的匹配过滤器，我可以将扫描操作限制在单个节点上。我错了。扫描操作迭代数据库中的所有键。在多节点群集中，扫描是一种分布式操作。将该操作乘以一个高吞吐量系统，您就有了一个解决性能瓶颈的方法。</p><h1 id="9b22" class="kl km hi bd kn ko kp kq kr ks kt ku kv io kw ip kx ir ky is kz iu la iv lb lc bi translated">备选方案1:成套设备</h1><p id="aee7" class="pw-post-body-paragraph jp jq hi jr b js ld ij ju jv le im jx jy lf ka kb kc lg ke kf kg lh ki kj kk hb bi translated">Redis提供了几种有用的数据结构。例如，集合。我们可以创建以位置为关键字的集合，并添加盘子作为成员。瞧:一个DIY二级索引。</p><figure class="iz ja jb jc fd jd er es paragraph-image"><div role="button" tabindex="0" class="je jf di jg bf jh"><div class="er es lu"><img src="../Images/44e39a9025396232cbccaa163d35cdf6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hVgxsCDp-cxEsva2sg6oiw.png"/></div></div><figcaption class="jk jl et er es jm jn bd b be z dx">redis set operations</figcaption></figure><p id="4b72" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">这种方法的一个问题是TTL适用于整个集合，而不是单个成员。我们想在两小时后让车牌过期。我们不想让整个位置过期，而只是让一个位置的单个板过期。</p><p id="7342" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">通过在代码中管理超时并显式移除成员，或许可以解决这一限制。不过，这并不优雅。</p><h1 id="166c" class="kl km hi bd kn ko kp kq kr ks kt ku kv io kw ip kx ir ky is kz iu la iv lb lc bi translated">选择2:重新研究</h1><p id="7737" class="pw-post-body-paragraph jp jq hi jr b js ld ij ju jv le im jx jy lf ka kb kc lg ke kf kg lh ki kj kk hb bi translated">Redis Enterprise是Redislabs的托管redis解决方案。它提供redis集群即服务和几个附加模块。其中一个插件是重新搜索。RediSearch允许您在redis数据库中建立搜索索引。它简化了复杂的查询。</p><p id="a239" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">您可以通过将它作为docker容器运行，在本地尝试重新搜索。</p><pre class="iz ja jb jc fd li lj lk ll aw lm bi"><span id="1092" class="ln km hi lj b fi lo lp l lq lr">docker run -it --rm --name redis-search \<br/>   -p 6379:6379 \<br/>   redislabs/redisearch:2.0.0</span></pre><p id="0388" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">您可以使用redis cli或像<a class="ae jo" href="https://redislabs.com/redis-enterprise/redis-insight/" rel="noopener ugc nofollow" target="_blank"> redisinsight </a>这样的GUI客户端连接到您本地的<em class="lt"> redis-search </em>。</p><p id="9441" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">让我们首先用<em class="lt"> loc、</em>和<em class="lt"> sess </em>字段创建几个散列。</p><figure class="iz ja jb jc fd jd er es paragraph-image"><div role="button" tabindex="0" class="je jf di jg bf jh"><div class="er es lv"><img src="../Images/491527871b0633bb2ffaea1b7489d6dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y1WCY0ua-mTukHmF_Zty7w.png"/></div></div><figcaption class="jk jl et er es jm jn bd b be z dx">Use hset to create hash key and fields</figcaption></figure><figure class="iz ja jb jc fd jd er es paragraph-image"><div role="button" tabindex="0" class="je jf di jg bf jh"><div class="er es lw"><img src="../Images/cf239d1c6e401f09e78ccf0cb24e5071.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WhS_t0qME4pnS0u6d6CyGg.png"/></div></div><figcaption class="jk jl et er es jm jn bd b be z dx">Browsing hash values in redisinsight</figcaption></figure><p id="0d60" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">接下来，让我们创建一个搜索索引。该索引包括前缀为<em class="lt"> lp-sess </em>的关键字，我们对<em class="lt"> loc和lp </em>字段进行索引。</p><figure class="iz ja jb jc fd jd er es paragraph-image"><div role="button" tabindex="0" class="je jf di jg bf jh"><div class="er es lx"><img src="../Images/358e724d7a0866ec7666998903b0e50c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MMZlJ0xw5gNFPpdtZnkbPQ.png"/></div></div><figcaption class="jk jl et er es jm jn bd b be z dx">Create a search index in RediSearch</figcaption></figure><p id="c1f7" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">让我们在索引中查询一个位置。</p><figure class="iz ja jb jc fd jd er es paragraph-image"><div role="button" tabindex="0" class="je jf di jg bf jh"><div class="er es ly"><img src="../Images/8f66e4c040f026e4b68fea18dd0a0674.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OEqjlxgPbR0KK6F19isdHw.png"/></div></div><figcaption class="jk jl et er es jm jn bd b be z dx">A location-based search query</figcaption></figure><p id="4e08" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">这已经好多了。我们可以使用搜索索引来查找给定位置的所有车牌。</p><p id="da75" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">此外，我们可以在查询中添加一个板式过滤器。我们可以用%操作符进行模糊匹配，它应用了一个<a class="ae jo" href="https://en.wikipedia.org/wiki/Levenshtein_distance" rel="noopener ugc nofollow" target="_blank"> Levenshtein距离</a>约束。Levenshtein距离为1对应于一个字符的不匹配。过滤器容差对应于%符号的数量。</p><figure class="iz ja jb jc fd jd er es paragraph-image"><div role="button" tabindex="0" class="je jf di jg bf jh"><div class="er es lz"><img src="../Images/e78cabda8be9042d32f621d07ee736ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IaAmpziq_W3yVExtW-oNdg.png"/></div></div><figcaption class="jk jl et er es jm jn bd b be z dx">A composite search query with fuzzy plate matching</figcaption></figure><p id="a523" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">你好，再搜索。这里有一个基于Python实现的<a class="ae jo" href="https://github.com/rzachariah/hello-redis-search" rel="noopener ugc nofollow" target="_blank">示例repo </a>。</p><p id="be1c" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">这是洗车分析平台对搜索性能的影响。</p><figure class="iz ja jb jc fd jd er es paragraph-image"><div role="button" tabindex="0" class="je jf di jg bf jh"><div class="er es ma"><img src="../Images/5e2f97f7afbcaa4a93661b3382010bed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bS9qiJOIyh6Fn7ODmGsn5w.png"/></div></div><figcaption class="jk jl et er es jm jn bd b be z dx">99th percentile fuzzy license plate search [s]</figcaption></figure><p id="c460" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">在第99百分位，平板搜索时间从扫描的10秒减少到重新搜索的40毫秒。</p><p id="c376" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">这个旅程是由redislabs的一些非常明智的建议促成的。谢谢你，欧比旺·克诺比！</p></div></div>    
</body>
</html>