<html>
<head>
<title>How to Start Appium Server Programmatically in Java</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Java中以编程方式启动Appium服务器</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/how-to-start-appium-server-programmatically-in-java-2ae2265cde10?source=collection_archive---------5-----------------------#2021-04-06">https://medium.com/geekculture/how-to-start-appium-server-programmatically-in-java-2ae2265cde10?source=collection_archive---------5-----------------------#2021-04-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/e9e0ae5327cb16286fe19480e44b4bfb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iDe8qZvEPxpbsrcqNMqb3w.png"/></div></div></figure><p id="5797" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">通常，这是刚开始使用appium探索移动测试自动化的人的正常工作流程。首先，他们打开appium桌面，如果你有一台相当硬核的电脑，你足够幸运，但我的电脑通常需要一分多钟才能启动appium桌面。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jo"><img src="../Images/450f77e723c22c7ae8a7367465d5b356.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8SojOLJGHIyH4dFTiiqc7A.png"/></div></div></figure><p id="ac3c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后，他们通过设置主机、端口来配置服务器，并通过点击编辑配置来设置ANDROID_HOME和JAVA_HOME。大多数时候，因为测试只是在本地机器上运行，默认配置就足够了。设置完成后，他们只需单击“启动服务器”按钮，然后“砰”的一声，appium服务器就启动并运行了。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jo"><img src="../Images/974925ad10c6b924fd0367e761d83006.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KZifXniZLGnxRXJHG8cBRw.png"/></div></div></figure><p id="8dd5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这样做其实没什么错。事实上，当我打开appium检查器来定位我的元素时，我就是这么做的。我也是从这个工作流程开始的，因为大多数教程只会显示这个步骤。</p><p id="5db0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">问题是我们正在自动化我们的测试，因为我们想要有效率并且避免一次又一次地做同样的任务。这同样适用于启动我们的服务器。在我们的测试执行中，我们应该尽可能地避免人工干预。我们不希望在每次测试开始和结束时手动启动和停止服务器。我们不希望您在下班时间被打扰，只是为了启动服务器，以便可以执行预定的测试。</p><p id="e66f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，解决方案是以编程方式启动服务器。这并不难做到。你需要的只是<strong class="is hj"><em class="jt">io . appium . Java _ client . service . local</em></strong>包中可用的这两个类<strong class="is hj"><em class="jt">AppiumServiceBuilder</em></strong>和<strong class="is hj"><em class="jt">AppiumDriverLocalService</em></strong>。</p><p id="28d7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"><em class="jt">AppiumServiceBuilder</em></strong>，顾名思义，就是一个构建器。它有用于设置或配置Appium服务器的公共方法。在我们的例子中，我们不会对我们的服务器做任何花哨的事情。我们将只需要这个类中可用的<strong class="is hj"> <em class="jt"> usingPort() </em> </strong>方法。(如需完整文档，请查看此<a class="ae ju" href="https://javadoc.io/doc/io.appium/java-client/latest/io/appium/java_client/service/local/AppiumServiceBuilder.html" rel="noopener ugc nofollow" target="_blank">链接</a>)</p><p id="499c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"><em class="jt">AppiumDriverLocalService</em></strong>，我们将使用它来启动和停止我们的服务器，并将我们的日志重定向到一个外部文件。(如需完整的文档，请查看此<a class="ae ju" href="https://javadoc.io/doc/io.appium/java-client/latest/io/appium/java_client/service/local/AppiumDriverLocalService.html" rel="noopener ugc nofollow" target="_blank">链接</a>)</p><p id="258a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下面是我的简单AppiumServer类</p><pre class="jp jq jr js fd jv jw jx jy aw jz bi"><span id="e993" class="ka kb hi jw b fi kc kd l ke kf">public class AppiumServer {</span><span id="ca59" class="ka kb hi jw b fi kg kd l ke kf">    private final AppiumServiceBuilder serviceBuilder = new AppiumServiceBuilder();</span><span id="f724" class="ka kb hi jw b fi kg kd l ke kf">    private AppiumDriverLocalService server;<br/>    private int port;<br/>    private final String appiumLogsLoc = "appium-logs";<br/>    private final String logFileName = "logs";<br/><em class="jt"><br/>    </em>public AppiumServer() {<br/>        this.port = Utilities.<em class="jt">getAvailablePort</em>();<br/>        this.serviceBuilder.usingPort(port);</span><span id="3856" class="ka kb hi jw b fi kg kd l ke kf">        this.server = AppiumDriverLocalService.<em class="jt">buildService</em>(serviceBuilder);</span><span id="54c0" class="ka kb hi jw b fi kg kd l ke kf">        this.server.start();<br/>    }<br/><br/>    public void stop() {<br/>        this.server.stop();<br/>    }<br/><br/>    public AppiumDriverLocalService get(){<br/>        return this.server;<br/>    }<br/><em class="jt"><br/>    </em>public void redirectLog() {<br/>        this.server.clearOutPutStreams();</span><span id="e128" class="ka kb hi jw b fi kg kd l ke kf">        File directory = new File(Utilities.<em class="jt">getProjectDirectory</em>() + this.appiumLogsLoc);<br/><br/>        Utilities.<em class="jt">makeDirIfItDoNotExist</em>(directory);<br/><br/>        try {</span><span id="5e17" class="ka kb hi jw b fi kg kd l ke kf">            this.server.addOutPutStream(new FileOutputStream(Utilities.<em class="jt">getProjectDirectory</em>() + this.appiumLogsLoc + Utilities.<em class="jt">generateFileName</em>(logFileName)));</span><span id="2d1d" class="ka kb hi jw b fi kg kd l ke kf">        } catch (FileNotFoundException e) {<br/>            e.printStackTrace();<br/>        }<br/>    }</span></pre><p id="f353" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一切都发生在构造函数中。首先，我们自动获得一个空闲端口供Appium服务器使用，这样我们就不必担心使用哪个端口了。这也将确保appium服务器的每个实例都运行在不同的端口上。<strong class="is hj"><em class="jt">getAvailablePort()</em></strong>将在后面讨论。如前所述，我们将只使用来自<strong class="is hj"><em class="jt">AppiumServiceBuilder</em></strong>的一个方法，即<strong class="is hj"> <em class="jt"> usingPort()。</em> </strong>我们将获得的端口号作为参数传递给这个方法，告诉服务器应该在哪个端口上运行。接下来是构建服务。这里我们使用静态方法<strong class="is hj"><em class="jt">buildService()</em></strong>可通过<strong class="is hj"><em class="jt">AppiumDriverLocalService</em></strong>访问，并传递<strong class="is hj"><em class="jt">AppiumServiceBuilder</em></strong>对象作为参数。现在，我们已经设置好了服务器，我们需要做的最后一件事是启动服务器。为此，只需调用<strong class="is hj"><em class="jt">AppiumDriverLocalService的<strong class="is hj"> start() </strong>方法。</em>T29】</strong></p><p id="34fc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们在AppiumServer类中还有其他方法。</p><ol class=""><li id="7f84" class="kh ki hi is b it iu ix iy jb kj jf kk jj kl jn km kn ko kp bi translated">get() →这将返回AppiumDriverLocalService对象。</li><li id="ae20" class="kh ki hi is b it kq ix kr jb ks jf kt jj ku jn km kn ko kp bi translated">stop() →这将停止服务器。</li><li id="1eb0" class="kh ki hi is b it kq ix kr jb ks jf kt jj ku jn km kn ko kp bi translated">redirectLog() →这将把应用程序日志重定向到外部文件。</li></ol><p id="582c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在我们来看看我们是如何自动确定自由端口号的。下面是我们使用的方法的代码。</p><pre class="jp jq jr js fd jv jw jx jy aw jz bi"><span id="254e" class="ka kb hi jw b fi kc kd l ke kf">public static int getAvailablePort() {<br/>    int port = 4723;<br/><br/>    try {<br/>        ServerSocket serverSocket = new ServerSocket(0);<br/>        port = serverSocket.getLocalPort();<br/>        serverSocket.close();<br/><br/>    } catch (IOException e) {<br/>        e.printStackTrace();<br/>    }<br/>    return port;</span><span id="f8b4" class="ka kb hi jw b fi kg kd l ke kf">}</span></pre><p id="f40b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">不知道这是不是一个好主意，但这对我很有用。我使用了<a class="ae ju" href="https://docs.oracle.com/javase/7/docs/api/java/net/ServerSocket.html" rel="noopener ugc nofollow" target="_blank"> ServerSocket </a>类来创建一个服务器套接字。将“0”传递给它的构造函数，它将创建一个到随机可用端口号的服务器套接字。然后，我们使用getLocalPort()方法获取它正在使用的端口，然后关闭服务器套接字。至此，我们知道appium可以免费使用所获得的端口。给你一个提示，当我们试图使用一个已经在使用的端口时，appium会给出这个错误。</p><pre class="jp jq jr js fd jv jw jx jy aw jz bi"><span id="b587" class="ka kb hi jw b fi kc kd l ke kf">Could not start REST http interface listener. The requested port may already be in use. Please make sure there is no other instance of this server running already.<br/>Fatal Error: listen EADDRINUSE</span></pre><p id="7a48" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一旦服务器启动，现在可以将AppiumDriverLocalService对象传递给appium驱动程序构造函数。要获取AppiumDriverLocalService ojbect，只需调用AppiumServer类中可用的get方法。</p><pre class="jp jq jr js fd jv jw jx jy aw jz bi"><span id="cdbf" class="ka kb hi jw b fi kc kd l ke kf">AppiumDriver driver = new AppiumDriver&lt;&gt;(<em class="jt">AppiumDriverLocalService</em> <em class="jt">object</em>, <em class="jt">your desired capabilities</em>)</span></pre><p id="d21b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，这只能在假设除了appium桌面之外，appium也通过npm安装的情况下才能工作。如果您还没有，您可以查看我的另一篇文章<a class="ae ju" rel="noopener" href="/swlh/how-to-set-up-appium-for-test-automation-1d2a4fab1f6a?source=friends_link&amp;sk=6e104be9324f2e7127322a14bfeb5039">如何为测试自动化设置Appium</a>。</p><p id="ec67" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">仅此而已。希望下次执行测试时，启动appium服务器将成为测试执行设置的一部分。</p><p id="b2b9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi">🍻 🍻 🍻</p></div></div>    
</body>
</html>