<html>
<head>
<title>Writing Custom Rake Tasks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">编写自定义Rake任务</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/writing-custom-rake-tasks-f656f43336cc?source=collection_archive---------5-----------------------#2021-07-20">https://medium.com/geekculture/writing-custom-rake-tasks-f656f43336cc?source=collection_archive---------5-----------------------#2021-07-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><h2 id="169f" class="hg hh hi bd b fp hj hk hl hm hn ho dx hp translated" aria-label="kicker paragraph">自动化您的Rails后端</h2><div class=""/><div class=""><h2 id="c614" class="pw-subtitle-paragraph io hr hi bd b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf dx translated">命名空间、模块和元任务</h2></div><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es jg"><img src="../Images/c49856d7da31188adf64e21dfb8f9881.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VSQY02gO6_uyH5R9-LZUVQ.jpeg"/></div></div><figcaption class="js jt et er es ju jv bd b be z dx">Photo by <a class="ae jw" href="https://unsplash.com/@tombyrom?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Tom Byrom</a> on <a class="ae jw" href="https://unsplash.com/s/photos/tool-shed?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="3c36" class="pw-post-body-paragraph jx jy hi jz b ka kb is kc kd ke iv kf kg kh ki kj kk kl km kn ko kp kq kr ks hb bi translated">代表“Ruby Make”的Rake是一个Ruby实用程序，它取代了常见的Unix <code class="du kt ku kv kw b">make</code>实用程序。如果你曾经使用过rails，我相信你会很熟悉使用像<code class="du kt ku kv kw b">rake db:migrate</code>或<code class="du kt ku kv kw b">rake db:rollback</code>这样的命令来管理你的服务器数据库。这些默认的rake任务会自动与rails安装捆绑在一起，但是您也可以编写定制的rake命令来自动化您选择的任何任务。</p><h1 id="3767" class="kx ky hi bd kz la lb lc ld le lf lg lh ix li iy lj ja lk jb ll jd lm je ln lo bi translated">创建我们的Rake文件</h1><p id="f7df" class="pw-post-body-paragraph jx jy hi jz b ka lp is kc kd lq iv kf kg lr ki kj kk ls km kn ko lt kq kr ks hb bi translated">您的定制rake任务必须写在扩展名为<code class="du kt ku kv kw b">.rake</code>的文件中，该文件必须位于<code class="du kt ku kv kw b">./lib/tasks</code>内。</p><pre class="jh ji jj jk fd lu kw lv lw aw lx bi"><span id="6c50" class="ly ky hi kw b fi lz ma l mb mc">touch ./lib/tasks/example.rake</span></pre><h1 id="9a80" class="kx ky hi bd kz la lb lc ld le lf lg lh ix li iy lj ja lk jb ll jd lm je ln lo bi translated">编写任务</h1><p id="8d10" class="pw-post-body-paragraph jx jy hi jz b ka lp is kc kd lq iv kf kg lr ki kj kk ls km kn ko lt kq kr ks hb bi translated">在我们的<code class="du kt ku kv kw b">.rake</code>文件中声明一个任务非常简单</p><figure class="jh ji jj jk fd jl"><div class="bz dy l di"><div class="md me l"/></div></figure><p id="35e1" class="pw-post-body-paragraph jx jy hi jz b ka kb is kc kd ke iv kf kg kh ki kj kk kl km kn ko kp kq kr ks hb bi translated">虽然描述在技术上是可选的，但是需要注意的是，当在命令行中输入 <code class="du kt ku kv kw b"><strong class="jz hs">rake -T</strong></code> <strong class="jz hs">时，没有描述的<strong class="jz hs">任务不会被列出。</strong></strong></p><p id="a3c6" class="pw-post-body-paragraph jx jy hi jz b ka kb is kc kd ke iv kf kg kh ki kj kk kl km kn ko kp kq kr ks hb bi translated">调用上面的例子:</p><pre class="jh ji jj jk fd lu kw lv lw aw lx bi"><span id="f081" class="ly ky hi kw b fi lz ma l mb mc">rake something</span></pre><h1 id="936f" class="kx ky hi bd kz la lb lc ld le lf lg lh ix li iy lj ja lk jb ll jd lm je ln lo bi translated">组织我们的任务</h1><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es mf"><img src="../Images/710fe0f2fcbd11a925756ccc5568b1d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7_Kn3P6unkovDvqOWogPww.png"/></div></div><figcaption class="js jt et er es ju jv bd b be z dx">You can view available rake tasks by typing “rake -T” in the command line</figcaption></figure><p id="3e12" class="pw-post-body-paragraph jx jy hi jz b ka kb is kc kd ke iv kf kg kh ki kj kk kl km kn ko kp kq kr ks hb bi translated">如果你看一下默认的<code class="du kt ku kv kw b">.rake</code>任务，你会看到Rails开发者选择通过命名空间来组织事情。虽然技术上没有要求，但是在一个名称空间中对相似的函数进行分组有助于保持代码的整洁。</p><p id="feec" class="pw-post-body-paragraph jx jy hi jz b ka kb is kc kd ke iv kf kg kh ki kj kk kl km kn ko kp kq kr ks hb bi translated">幸运的是，给你的定制rake任务命名再简单不过了:</p><figure class="jh ji jj jk fd jl"><div class="bz dy l di"><div class="md me l"/></div></figure><p id="a5b4" class="pw-post-body-paragraph jx jy hi jz b ka kb is kc kd ke iv kf kg kh ki kj kk kl km kn ko kp kq kr ks hb bi translated">它在命令行中的调用如下:</p><pre class="jh ji jj jk fd lu kw lv lw aw lx bi"><span id="9dc2" class="ly ky hi kw b fi lz ma l mb mc">rake custom_task:something</span></pre><p id="9a58" class="pw-post-body-paragraph jx jy hi jz b ka kb is kc kd ke iv kf kg kh ki kj kk kl km kn ko kp kq kr ks hb bi translated">您也可以使用嵌套命名空间:</p><figure class="jh ji jj jk fd jl"><div class="bz dy l di"><div class="md me l"/></div></figure><p id="af87" class="pw-post-body-paragraph jx jy hi jz b ka kb is kc kd ke iv kf kg kh ki kj kk kl km kn ko kp kq kr ks hb bi translated">并通过命令行调用:</p><pre class="jh ji jj jk fd lu kw lv lw aw lx bi"><span id="1c73" class="ly ky hi kw b fi lz ma l mb mc">rake custom_tasks:productive:something<br/>rake custom_tasks:unproductive:nothing</span></pre><h1 id="e96d" class="kx ky hi bd kz la lb lc ld le lf lg lh ix li iy lj ja lk jb ll jd lm je ln lo bi translated">在Rake任务中利用模块</h1><p id="71bc" class="pw-post-body-paragraph jx jy hi jz b ka lp is kc kd lq iv kf kg lr ki kj kk ls km kn ko lt kq kr ks hb bi translated"><a class="ae jw" href="https://stackoverflow.com/a/55011187/11035290" rel="noopener ugc nofollow" target="_blank">模块应该包含在每个任务</a>中，并且必须位于文件的顶部。将模块包含在任务中限制了它的范围，防止它被包含在整个应用程序中，这可能会导致意外的错误。</p><figure class="jh ji jj jk fd jl"><div class="bz dy l di"><div class="md me l"/></div></figure><h1 id="b253" class="kx ky hi bd kz la lb lc ld le lf lg lh ix li iy lj ja lk jb ll jd lm je ln lo bi translated">在另一个Rake任务中调用Rake任务</h1><p id="0154" class="pw-post-body-paragraph jx jy hi jz b ka lp is kc kd lq iv kf kg lr ki kj kk ls km kn ko lt kq kr ks hb bi translated">您也可以通过<code class="du kt ku kv kw b">Rake::Task['your_subtask_name_as_a_string'].execute</code>编写调用现有rake任务的元任务。重要的是，使用的字符串要与您通过命令行调用子任务时使用的字符串相匹配。这意味着当从不同的任务内部调用时，命名空间任务必须包括它的命名空间。</p><figure class="jh ji jj jk fd jl"><div class="bz dy l di"><div class="md me l"/></div></figure><h1 id="17e0" class="kx ky hi bd kz la lb lc ld le lf lg lh ix li iy lj ja lk jb ll jd lm je ln lo bi translated">一个例子</h1><p id="50a2" class="pw-post-body-paragraph jx jy hi jz b ka lp is kc kd lq iv kf kg lr ki kj kk ls km kn ko lt kq kr ks hb bi translated">下面是我编写的自定义rake任务，用于自动化我的一个项目的抓取行为。实际的抓取逻辑包含在我的<code class="du kt ku kv kw b">PicParser</code>模块中，而各种任务指定要抓取的URL和时间段。您还会注意到，我使用了<code class="du kt ku kv kw b">:environment</code>标志，允许<code class="du kt ku kv kw b">PicParser</code>模块访问我的应用程序其余部分中使用的模型。</p><figure class="jh ji jj jk fd jl"><div class="bz dy l di"><div class="md me l"/></div></figure></div></div>    
</body>
</html>