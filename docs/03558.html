<html>
<head>
<title>How to use CarProjectionManager</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用CarProjectionManager</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/how-to-use-carprojectionmanager-36a44658dca?source=collection_archive---------17-----------------------#2021-06-10">https://medium.com/geekculture/how-to-use-carprojectionmanager-36a44658dca?source=collection_archive---------17-----------------------#2021-06-10</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/ec5c3da8980ff276cc70e080d755a9b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e9HPz1jjq6VAUBAuPpji9A.jpeg"/></div></div></figure><p id="72b6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">每个人，无论你要去哪里，都可以通过使用Android Auto、苹果CarPlay或其他软件带上副驾驶。Android汽车操作系统能够帮助您集成任何镜像应用程序。</p><p id="6552" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">CarProjectionManager允许实现投影的应用程序向投影管理器注册/注销自己，并监听语音通知。</p><p id="8820" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在<a class="ae jo" href="https://cs.android.com/android/platform/superproject/+/master:packages/services/Car/car-lib/src/android/car/CarProjectionManager.java" rel="noopener ugc nofollow" target="_blank"> CarProjectionManager </a>中，我们有ProjectionStatusListener，只要有新设备连接到系统并且支持投影，我们就会接收数据。</p><h1 id="ea57" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">看起来是这样的:</h1><figure class="kn ko kp kq fd ij"><div class="bz dy l di"><div class="kr ks l"/></div></figure><h2 id="f088" class="kt jq hi bd jr ku kv kw jv kx ky kz jz jb la lb kd jf lc ld kh jj le lf kl lg bi translated">什么是投影状态:</h2><p id="eb44" class="pw-post-body-paragraph iq ir hi is b it lh iv iw ix li iz ja jb lj jd je jf lk jh ji jj ll jl jm jn hb bi translated">根据其可用性，预测状态可能有4种状态:</p><pre class="kn ko kp kq fd lm ln lo lp aw lq bi"><span id="4c24" class="kt jq hi ln b fi lr ls l lt lu">/** This state indicates that projection is not actively running and no compatible mobile<br/>* devices available. *    <br/>public static final int <strong class="ln hj">PROJECTION_STATE_INACTIVE</strong> = 0;</span><span id="d2bb" class="kt jq hi ln b fi lv ls l lt lu">/** At least one phone connected and ready to project. */<br/>public static final int <strong class="ln hj">PROJECTION_STATE_READY_TO_PROJECT</strong> = 1;</span><span id="bc13" class="kt jq hi ln b fi lv ls l lt lu">/** Projecting in the foreground */<br/>public static final int <strong class="ln hj">PROJECTION_STATE_ACTIVE_FOREGROUND</strong> = 2;</span><span id="93ac" class="kt jq hi ln b fi lv ls l lt lu">/** Projection is running in the background */<br/>public static final int <strong class="ln hj">PROJECTION_STATE_ACTIVE_BACKGROUND</strong> = 3;</span></pre><p id="6226" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">关于投影状态对象的更多细节你可以在这里找到<a class="ae jo" href="https://cs.android.com/android/platform/superproject/+/master:packages/services/Car/car-lib/src/android/car/projection/ProjectionStatus.java" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="f857" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可能必须根据预测状态考虑可能的可用运输方式:</p><pre class="kn ko kp kq fd lm ln lo lp aw lq bi"><span id="9eac" class="kt jq hi ln b fi lr ls l lt lu">public static final int <strong class="ln hj">PROJECTION_TRANSPORT_NONE</strong> = 0;<br/>public static final int <strong class="ln hj">PROJECTION_TRANSPORT_USB</strong> = 1;<br/>public static final int <strong class="ln hj">PROJECTION_TRANSPORT_WIFI</strong> = 2;</span></pre><h1 id="8c14" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">它是如何工作的</h1><p id="3bd4" class="pw-post-body-paragraph iq ir hi is b it lh iv iw ix li iz ja jb lj jd je jf lk jh ji jj ll jl jm jn hb bi translated">考虑到上面显示的代码(AOSP平台的一部分)，我将描述以下步骤，我们这样做是为了能够充分解释预测状态监听器的整个功能:</p><ul class=""><li id="9350" class="lw lx hi is b it iu ix iy jb ly jf lz jj ma jn mb mc md me bi translated">在没有连接任何设备的情况下启动系统-&gt;空列表</li><li id="626a" class="lw lx hi is b it mf ix mg jb mh jf mi jj mj jn mb mc md me bi translated">通过USB -&gt;单元素列表插入Android设备</li><li id="6cd4" class="lw lx hi is b it mf ix mg jb mh jf mi jj mj jn mb mc md me bi translated">通过蓝牙连接(进行配对过程)-&gt;列出两个元素</li><li id="1240" class="lw lx hi is b it mf ix mg jb mh jf mi jj mj jn mb mc md me bi translated">在其中一个连接的设备上启动无线投影</li><li id="7320" class="lw lx hi is b it mf ix mg jb mh jf mi jj mj jn mb mc md me bi translated">将投影放在背景中</li><li id="fd7b" class="lw lx hi is b it mf ix mg jb mh jf mi jj mj jn mb mc md me bi translated">停止投射</li></ul><h2 id="66d3" class="kt jq hi bd jr ku kv kw jv kx ky kz jz jb la lb kd jf lc ld kh jj le lf kl lg bi translated">没有连接设备</h2><pre class="kn ko kp kq fd lm ln lo lp aw lq bi"><span id="a3f9" class="kt jq hi ln b fi lr ls l lt lu"><strong class="ln hj">state</strong>: 0</span><span id="13b9" class="kt jq hi ln b fi lv ls l lt lu"><strong class="ln hj">package</strong>: null</span><span id="a893" class="kt jq hi ln b fi lv ls l lt lu"><strong class="ln hj">details</strong>: []</span></pre><p id="44e5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">投影<strong class="is hj">状态</strong>为<strong class="is hj">无效</strong>并且<strong class="is hj">列表</strong>为<strong class="is hj">空</strong>，因为我们没有连接设备。这和<strong class="is hj">空包</strong>是一个道理。</p><h2 id="20fd" class="kt jq hi bd jr ku kv kw jv kx ky kz jz jb la lb kd jf lc ld kh jj le lf kl lg bi translated">一台通过USB连接的设备</h2><pre class="kn ko kp kq fd lm ln lo lp aw lq bi"><span id="fbfe" class="kt jq hi ln b fi lr ls l lt lu"><strong class="ln hj">state</strong>: 1</span><span id="4512" class="kt jq hi ln b fi lv ls l lt lu"><strong class="ln hj">package</strong>: com.google.android.embedded.projection</span><span id="2777" class="kt jq hi ln b fi lv ls l lt lu"><strong class="ln hj">details</strong>: [ProjectionStatus{mPackageName='com.google.android.embedded.projection', mState=1, mTransport=0, mConnectedMobileDevices=[MobileDevice{mId=0, mName='Google Pixel', mAvailableTransports=[1], mProjecting=false, (has extras)}]}]</span></pre><p id="e5e2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">连接的设备</strong>准备好<strong class="is hj">投影</strong>并且<strong class="is hj">包</strong>的目的是突出显示连接设备的类型是<strong class="is hj">安卓</strong>设备。唯一可用的<strong class="is hj">传输</strong>是<strong class="is hj"> USB </strong>，mAvailableTransports列表只有一个元素(1 = PROJECTION_TRANSPORT_USB)。如果实际设备连接了USB和蓝牙两个选项，则列表将包含2个元素，例如:</p><pre class="kn ko kp kq fd lm ln lo lp aw lq bi"><span id="2766" class="kt jq hi ln b fi lr ls l lt lu">[ProjectionStatus{mPackageName='com.google.android.embedded.projection', mState=1, mTransport=0, mConnectedMobileDevices=[MobileDevice{mId=0, mName='Google Pixel', mAvailableTransports=[1, 2], mProjecting=false, (has extras)}]}]</span></pre><h2 id="cfbf" class="kt jq hi bd jr ku kv kw jv kx ky kz jz jb la lb kd jf lc ld kh jj le lf kl lg bi translated">一台设备已经连接，并通过蓝牙添加新设备</h2><pre class="kn ko kp kq fd lm ln lo lp aw lq bi"><span id="c409" class="kt jq hi ln b fi lr ls l lt lu"><strong class="ln hj">state</strong>: 1</span><span id="6823" class="kt jq hi ln b fi lv ls l lt lu"><strong class="ln hj">package</strong>: com.google.android.embedded.projection</span><span id="4bf4" class="kt jq hi ln b fi lv ls l lt lu"><strong class="ln hj">details</strong>: [ProjectionStatus{mPackageName='com.google.android.embedded.projection', mState=1, mTransport=0, mConnectedMobileDevices=[MobileDevice{mId=1, mName='Nexus 5X', mAvailableTransports=[2], mProjecting=false, (has extras)}, MobileDevice{mId=0, mName='Google Pixel', mAvailableTransports=[1], mProjecting=false, (has extras)}]}]</span></pre><p id="eb67" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">至少一个连接的设备<strong class="is hj">准备投射</strong>，状态为1 (READY_TO_PROJECT)的原因。因为我们有2个连接的设备，详细信息列表包含2个元素，<strong class="is hj"> Nexus 5X和谷歌像素</strong>。详细列表的内容显示，Nexus 5X通过蓝牙连接，谷歌Pixel通过USB连接。</p><p id="9a90" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">mTransport = 0表示PROJECTION_TRANSPORT_NONE，并且当投影没有有效运行时接收该值。</p><h2 id="d350" class="kt jq hi bd jr ku kv kw jv kx ky kz jz jb la lb kd jf lc ld kh jj le lf kl lg bi translated">开始投射</h2><pre class="kn ko kp kq fd lm ln lo lp aw lq bi"><span id="25f5" class="kt jq hi ln b fi lr ls l lt lu"><strong class="ln hj">state</strong>: 2</span><span id="2842" class="kt jq hi ln b fi lv ls l lt lu"><strong class="ln hj">package</strong>: com.google.android.embedded.projection</span><span id="9b09" class="kt jq hi ln b fi lv ls l lt lu"><strong class="ln hj">details</strong>: [ProjectionStatus{mPackageName='com.google.android.embedded.projection',mState=2, mTransport=2, mConnectedMobileDevices=[MobileDevice{mId=1, mName='Nexus 5X',mAvailableTransports=[2], mProjecting=true, (has extras)}, MobileDevice{mId=0,mName='Google Pixel', mAvailableTransports=[1], mProjecting=false, (has extras)}]}]</span></pre><p id="2246" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">投影</strong>已经在<strong class="is hj"> Nexus 5X </strong>上<strong class="is hj">开始</strong>，因此当前状态为<strong class="is hj">2 = PROJECTION _ STATE _ ACTIVE _ FOREGROUND</strong>，因为详细信息列表中的一个设备的属性<strong class="is hj"> mProjecting </strong>设置为<strong class="is hj"> TRUE </strong>。</p><p id="247a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> mTransport = 2表示PROJECTION_TRANSPORT_WIFI </strong>,当投影在WIFI上运行时，会收到此消息。</p><h2 id="0766" class="kt jq hi bd jr ku kv kw jv kx ky kz jz jb la lb kd jf lc ld kh jj le lf kl lg bi translated">将投影状态从前景更改为背景</h2><pre class="kn ko kp kq fd lm ln lo lp aw lq bi"><span id="c7f1" class="kt jq hi ln b fi lr ls l lt lu"><strong class="ln hj">state</strong>: 3</span><span id="3c8a" class="kt jq hi ln b fi lv ls l lt lu"><strong class="ln hj">package</strong>: com.google.android.embedded.projection</span><span id="c239" class="kt jq hi ln b fi lv ls l lt lu"><strong class="ln hj">details</strong>: [ProjectionStatus{mPackageName='com.google.android.embedded.projection', mState=3, mTransport=2, mConnectedMobileDevices=[MobileDevice{mId=1, mName='Nexus 5X', mAvailableTransports=[2], mProjecting=true, (has extras)}, MobileDevice{mId=0, mName='Google Pixel', mAvailableTransports=[1], mProjecting=false, (has extras)}]}]</span></pre><p id="a5c8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们有一个<strong class="is hj">正在进行的投影</strong>已经移到了<strong class="is hj">背景</strong>。此时的<strong class="is hj">状态</strong>为<strong class="is hj"> 3 =投影_状态_活动_背景</strong>。<strong class="is hj">投影</strong>标志仍然设置为<strong class="is hj">真</strong>，并且<strong class="is hj">m传输</strong>值不变(<strong class="is hj">投影_传输_WIFI </strong>)。</p><h2 id="316e" class="kt jq hi bd jr ku kv kw jv kx ky kz jz jb la lb kd jf lc ld kh jj le lf kl lg bi translated">停止投射</h2><pre class="kn ko kp kq fd lm ln lo lp aw lq bi"><span id="b567" class="kt jq hi ln b fi lr ls l lt lu"><strong class="ln hj">state</strong>: 1</span><span id="86a0" class="kt jq hi ln b fi lv ls l lt lu"><strong class="ln hj">package</strong>: com.google.android.embedded.projection</span><span id="cc86" class="kt jq hi ln b fi lv ls l lt lu"><strong class="ln hj">details</strong>: [ProjectionStatus{mPackageName='com.google.android.embedded.projection', mState=1, mTransport=0, mConnectedMobileDevices=[MobileDevice{mId=1, mName='Nexus 5X', mAvailableTransports=[2], mProjecting=false, (has extras)}, MobileDevice{mId=0, mName='Google Pixel', mAvailableTransports=[1], mProjecting=false, (has extras)}]}]</span></pre><p id="59ce" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">状态已从PROJECTION _ STATE _ ACTIVE _ FOREGROUND/PROJECTION _ STATE _ ACTIVE _ BACKGROUND更改为PROJECTION _ STATE _ READY _ TO _ PROJECT，因为不再有标记为mProjecting = TRUE的设备。</p><h2 id="575c" class="kt jq hi bd jr ku kv kw jv kx ky kz jz jb la lb kd jf lc ld kh jj le lf kl lg bi translated">当我们有多个产品包可用时的期望</h2><pre class="kn ko kp kq fd lm ln lo lp aw lq bi"><span id="1786" class="kt jq hi ln b fi lr ls l lt lu">[ProjectionStatus{mPackageName='com.google.android.embedded.projection', mState=1, mTransport=0, mConnectedMobileDevices=[MobileDevice{mId=0, mName='LGE Nexus 5X', mAvailableTransports=[1], mProjecting=false, (has extras)}]}, ProjectionStatus{mPackageName='<strong class="ln hj"><em class="mk">another.projection.package</em></strong>', mState=1, mTransport=1, mConnectedMobileDevices=[MobileDevice{mId=1007, mName='Marcel's Device, mAvailableTransports=[1], mProjecting=false, (has extras)}]}]</span></pre><p id="2d70" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">基于包，连接设备的状态、传输和列表将为<strong class="is hj">。</strong></p><h2 id="2969" class="kt jq hi bd jr ku kv kw jv kx ky kz jz jb la lb kd jf lc ld kh jj le lf kl lg bi translated">注意:</h2><p id="02a1" class="pw-post-body-paragraph iq ir hi is b it lh iv iw ix li iz ja jb lj jd je jf lk jh ji jj ll jl jm jn hb bi translated"><em class="mk">如果设备被拔出或断开，详细信息列表将不再包含该设备。在只有一个设备连接的情况下，我们将得到一个空列表。</em></p></div><div class="ab cl ml mm gp mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="hb hc hd he hf"><h1 id="1013" class="jp jq hi bd jr js ms ju jv jw mt jy jz ka mu kc kd ke mv kg kh ki mw kk kl km bi translated">创建新的投影状态对象</h1><p id="3f26" class="pw-post-body-paragraph iq ir hi is b it lh iv iw ix li iz ja jb lj jd je jf lk jh ji jj ll jl jm jn hb bi translated">通过在列表中添加新的投影状态对象，您唯一要做的事情是</p><p id="cfe5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建一个投影状态对象。使用Java代码创建空列表的一个简单示例是:</p><pre class="kn ko kp kq fd lm ln lo lp aw lq bi"><span id="1425" class="kt jq hi ln b fi lr ls l lt lu">pivate ProjectionStatus createProjectionStatus(int event) {<br/>    return ProjectionStatus<br/>            .builder(<em class="mk">PACKAGE_NAME</em>, event)<br/>            .setProjectionTransport(<br/>               ProjectionStatus.PROJECTION_TRANSPORT_NONE<br/>             )<br/>            .build();<br/>}</span></pre></div><div class="ab cl ml mm gp mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="hb hc hd he hf"><h1 id="237c" class="jp jq hi bd jr js ms ju jv jw mt jy jz ka mu kc kd ke mv kg kh ki mw kk kl km bi translated">如何处理不同的蓝牙约束</h1><p id="91fe" class="pw-post-body-paragraph iq ir hi is b it lh iv iw ix li iz ja jb lj jd je jf lk jh ji jj ll jl jm jn hb bi translated">对于不同的技术或OEM约束，您可能需要在投影进行时应用一些蓝牙策略，并在投影停止时返回到之前的状态。</p><p id="0f85" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于这种类型的约束，我们已经由CarProjectionManager提供了一个权力机制来执行，当我们想要<strong class="is hj">断开</strong>一个<strong class="is hj">配置文件</strong>时<strong class="is hj">抑制配置文件</strong>，当我们想要回到先前的状态时<strong class="is hj">释放抑制</strong>。让我们来看看这些方法:</p><figure class="kn ko kp kq fd ij"><div class="bz dy l di"><div class="kr ks l"/></div></figure><p id="2679" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用Kotlin代码禁用由MAC地址标识的设备的HFP配置文件的示例:</p><pre class="kn ko kp kq fd lm ln lo lp aw lq bi"><span id="3cdb" class="kt jq hi ln b fi lr ls l lt lu">private fun disableHfpDevices(macAddress: String?) {<br/>    <em class="mk">logDebug</em>("disableHfp for device: ${macAddress}")<br/>    try {<br/>        val device =   BluetoothAdapter.getDefaultAdapter().getRemoteDevice(macAddress)</span><span id="e391" class="kt jq hi ln b fi lv ls l lt lu">        carProjectionManager.requestBluetoothProfileInhibit(device, 16) // 16 = HFP<br/>    } catch (e: IllegalArgumentException) {<br/>        <em class="mk">logDebug</em>("disableHfp for $macAddress --- ERROR --- $e")<br/>    }<br/>}</span></pre></div><div class="ab cl ml mm gp mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="hb hc hd he hf"><p id="5769" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了能够首先集成任何镜像应用程序，您必须与框架提供商签订合同。对于Android Auto，您必须与谷歌签订合同才能获得Android Auto apk，对于Apple CarPlay，您必须有一个正在进行的合作才能访问他们的框架。一旦签订合同，您将收到关于实施细节和期望的详细文档，以便通过谷歌和苹果的认证。</p><p id="2ccd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">直接码吧！</strong></p></div></div>    
</body>
</html>