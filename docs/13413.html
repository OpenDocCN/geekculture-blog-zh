<html>
<head>
<title>How iOS 16 makes your app launch faster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">iOS 16如何让你的应用启动更快</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/how-ios-16-makes-your-app-launch-faster-1c27fd442738?source=collection_archive---------1-----------------------#2022-07-07">https://medium.com/geekculture/how-ios-16-makes-your-app-launch-faster-1c27fd442738?source=collection_archive---------1-----------------------#2022-07-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/9924651d2a4d21b2e0de152665aa59a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Jqcj6LAYIMSOFDFn852I2w.png"/></div></div></figure><div class=""/><p id="42b6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae jo" href="https://developer.apple.com/videos/play/wwdc2022/102/" rel="noopener ugc nofollow" target="_blank"> WWDC22的国情咨文</a>承诺带来一些重大的发射时间改进:</p><blockquote class="jp jq jr"><p id="ea69" class="iq ir js is b it iu iv iw ix iy iz ja jt jc jd je ju jg jh ji jv jk jl jm jn hb bi translated">由于动态链接器的改进，Lyft或Airbnb等应用程序的启动速度几乎提高了一倍。</p></blockquote><p id="6476" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这种改进来自于加速协议检查，我在之前的一篇博客文章中已经证明了这一点。此外，iOS 16通过减少从磁盘加载的数据量，缩短了加载二进制文件的时间。这也是前一篇文章的主题。</p><p id="65a8" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这些改进归结于dyld的变化，dyld是负责引导应用程序并开始执行您自己的代码的程序。他们还采用了两种相反(但很常见)的方法来提高性能——<strong class="is hu">急切加载</strong>和<strong class="is hu">懒惰评估</strong>。</p><p id="8085" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这篇文章中，我们将看看iOS 16有什么变化，它到底快了多少，以及你如何才能最好地利用你的应用程序中的这些新功能。</p><h1 id="66a6" class="jw jx ht bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">协议检查</h1><p id="b604" class="pw-post-body-paragraph iq ir ht is b it ku iv iw ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn hb bi translated">协议一致性检查发生在Swift运行时，以确定代码的结果，如<code class="du kz la lb lc b">myVar as? MyProtocol</code>。每当一个类型符合一个协议，二进制文件就会包含一个“一致性记录”。当检查一致性时，运行时循环遍历每个一致性记录，以查看是否有与当前操作匹配的记录。这个循环是O(n ),其中n是应用程序中一致性记录的数量。对于大型应用程序，可能有超过十万个，使得每个一致性检查非常慢。</p><p id="5452" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">协议一致性检查在Swift应用中广泛存在，即使您没有编写它们，因为它们也是从像<code class="du kz la lb lc b">String(describing:)</code>或<code class="du kz la lb lc b">AnyHashable</code>这样的常见操作中调用的。对于一些大型Swift应用程序，如Lyft和Airbnb，近一半的启动时间用于协议一致性检查。</p><p id="5274" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最大的变化来自“dyld闭包”，这是一个基于应用的缓存，用于在应用启动期间加速各种dyld操作。<strong class="is hu">闭包现在包含预先计算的一致性</strong>，允许每次查找更快。注意，dyld闭包并不总是被使用，例如，因为它已经过时，或者因为它是从Xcode启动的，这使得事情变得复杂。这一变化在Swift开源项目中实现，作为<a class="ae jo" href="https://github.com/apple/swift/pull/41185" rel="noopener ugc nofollow" target="_blank">迈克·阿什的PR </a>的一部分，增加了dyld API调用:<code class="du kz la lb lc b">_dyld_find_protocol_conformance_on_disk</code>。如果在这个缓存中发现一致性，O(n)操作将被完全跳过，因此我们应该会看到应用程序在大量一致性方面的巨大改进。</p><h2 id="e11d" class="ld jx ht bd jy le lf lg kc lh li lj kg jb lk ll kk jf lm ln ko jj lo lp ks lq bi translated">测试它</h2><p id="683d" class="pw-post-body-paragraph iq ir ht is b it ku iv iw ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn hb bi translated">在Emerge，我们进行了大量性能测试，以确定PRs如何影响应用发布。因此，自然地，我们想要准确地测量这些预先计算的一致性检查将如何影响发布时间。</p><p id="3faa" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因为我们处理的是两个不同的操作系统版本，所以我们不能在同一个设备上测试。相反，我选择用二进制代码中10k、20k、30k、40k和50k的一致性对整个应用程序的一致性检查时间进行微基准测试。每个版本都在iOS 16和iOS 15设备上启动，10k一致性被视为基线，只比较相对于基线的时间。</p><figure class="ls lt lu lv fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lr"><img src="../Images/604e0ab635d0a7c8b4110de0376ddc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CT5zyTmtqFkK5_qY3IlzSw.png"/></div></div></figure><p id="c314" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">很明显，随着更多兼容性的增加，iOS 15变慢了，而iOS 16没有，问题解决了！在实践中，这种封闭并不总是可用的，所以我们必须等到几个月后iOS 16登陆用户设备，才能确切知道这将在多大程度上改变生产中的数字。这一改进适用于所有应用，即使它们的最低部署目标在iOS 16以下。</p><h1 id="6120" class="jw jx ht bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">页面错误</h1><p id="c762" class="pw-post-body-paragraph iq ir ht is b it ku iv iw ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn hb bi translated">第二大改进来自于减少了启动时必须从磁盘加载的数据量。第一次执行一段代码时，内核在一个叫做<strong class="is hu">页面错误</strong>的过程中加载周围的内存块，称为页面。在应用程序启动时，二进制文件的某些部分需要在代码运行之前修复(在之前的博客文章<a class="ae jo" href="https://www.emergetools.com/blog/posts/SwiftReferenceTypes" rel="noopener ugc nofollow" target="_blank">中对此有深入的解释)。在iOS 15上，所有的修复都是在应用程序启动时完成的，这意味着二进制文件中任何需要修复的位置都必须分页。现在，一个名为</a><a class="ae jo" href="https://developer.apple.com/wwdc22/110362" rel="noopener ugc nofollow" target="_blank">页面调入链接</a>的新特性可以缓慢地解决修复问题，只在页面第一次被访问的时候。</p><p id="865f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">去年的WWDC为用于执行这些修正的元数据引入了一种重要的新格式，我当时曾深入讨论过这个问题。这种格式是修复的惰性评估所必需的，因此iOS 16用户只有在您针对iOS 13.4或更高版本时才能获得它。</p><h1 id="adce" class="jw jx ht bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">测试它</h1><p id="7a18" class="pw-post-body-paragraph iq ir ht is b it ku iv iw ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn hb bi translated">在iOS 15上，二进制文件的所有__DATA和__DATA_CONST段都包含修正，所以在代码运行之前页面错误的总数就是这些段的大小。使用Emerge的工具，我们还可以测量你的代码需要运行多少页，这一差异让我们知道你在iOS 16中少了多少页错误。</p><figure class="ls lt lu lv fd hk"><div class="bz dy l di"><div class="lw lx l"/></div></figure><h1 id="3735" class="jw jx ht bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">获得全部利益</h1><p id="3c84" class="pw-post-body-paragraph iq ir ht is b it ku iv iw ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn hb bi translated">这是一个很大的改进，可以立即减少页面错误，但是还有更大的减少。Emerge提供订购文件服务——Launch Booster——自动订购二进制文件，以最大限度地减少页面错误。我们<strong class="is hu">在iOS 15上向应用商店部署订单文件时，平均将启动时间缩短了18% </strong>。现在iOS 16不会自动加载每个页面，订购二进制文件可以让你的应用程序启动时间更快。如果你想了解更多关于如何自动减少启动时间和利用iOS 16改进的信息，<a class="ae jo" href="mailto:team@emergetools.com" rel="noopener ugc nofollow" target="_blank">与Emerge团队联系</a>。</p></div></div>    
</body>
</html>