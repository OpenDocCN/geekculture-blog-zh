<html>
<head>
<title>🔰Using Handlers in Ansible to Achieve Idempotence While Restarting a Service🔰</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">🔰重新启动服务时使用Ansible中的处理程序实现幂等性🔰</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/using-handlers-in-ansible-to-achieve-idempotence-while-restarting-a-service-b97d5a0eace8?source=collection_archive---------23-----------------------#2021-03-15">https://medium.com/geekculture/using-handlers-in-ansible-to-achieve-idempotence-while-restarting-a-service-b97d5a0eace8?source=collection_archive---------23-----------------------#2021-03-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="5744" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi jd translated">如果您熟悉Ansible的使用，您可能会遇到无法从Ansible的幂等性中获益的情况。</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="er es jm"><img src="../Images/b9806b5e05ebcf7ab558330fd8600ac3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Le3URJbb26kihKTaaF8r0Q.jpeg"/></div></div></figure><p id="c9d3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jy">例如，假设我们使用Ansible配置了一个Apache服务器(比如HTTPD)。然后，我们启动了这项服务，并在其上部署了我们的web应用程序/网页。一切正常。</em></p><p id="27a3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，在某种情况下，<strong class="ih hj">我们想对HTTPD服务器</strong>的配置文件做一些更改，比如说我们想更改它运行的端口。更改端口号后，我们还必须重新启动服务。</p><p id="c296" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一切都由Ansible来做。在这里，我们第一次在做出更改后运行剧本，剧本将在重新启动HTTPD服务后成功运行。</p><p id="e908" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是在这里，我们有一个挑战。 <em class="jy">下一次无论何时运行剧本，无论我们是否在配置文件中做了任何更改，它都会重新启动HTTPD服务</em>。这是因为Ansible中有一个重新启动HTTPD服务的任务，它将一直运行，在这里，我们不能利用Ansible的幂等性。</p><h2 id="d2aa" class="jz ka hi bd kb kc kd ke kf kg kh ki kj iq kk kl km iu kn ko kp iy kq kr ks kt bi translated">重新启动服务，一次又一次，将消耗额外的计算，并浪费资源，这根本不是一个好的交易。</h2><p id="3033" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq kw is it iu kx iw ix iy ky ja jb jc hb bi translated"><em class="jy">在这里，我们想要实现这样的设置，即“重新启动服务”任务将仅在配置文件中有任何更改时运行，否则它不应该运行。这就是处理程序的概念开始发挥作用的时候了。</em></p><h1 id="60c8" class="kz ka hi bd kb la lb lc kf ld le lf kj lg lh li km lj lk ll kp lm ln lo ks lp bi translated">这项任务的主要目的是:</h1><figure class="jn jo jp jq fd jr er es paragraph-image"><div class="er es lq"><img src="../Images/1d32b5a1f5810550349b5932d20cbea1.png" data-original-src="https://miro.medium.com/v2/resize:fit:992/format:webp/1*CWiRm5VsD2rrgJ1qESPjLg.png"/></div></figure><blockquote class="lr ls lt"><p id="92f6" class="if ig jy ih b ii ij ik il im in io ip lu ir is it lv iv iw ix lw iz ja jb jc hb bi translated"><strong class="ih hj">✨restarting httpd服务本质上不是等幂的，并且还消耗更多的资源，以建议一种方法来纠正在可回答的playbook✨中的这种挑战</strong></p></blockquote><p id="3f46" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">在这里，我们使用“通知”的概念</strong>。我们将以这样一种方式配置“在配置文件中进行的更改”任务，即无论它何时运行，它都会通知任务重新启动保存在处理程序块中的服务，否则它不会。</p><p id="8a23" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们努力切实做到这一点。</p><p id="eb01" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="jy">下面是我在配置剧本时要遵循的步骤:</em> </strong></p><h2 id="075c" class="jz ka hi bd kb kc kd ke kf kg kh ki kj iq kk kl km iu kn ko kp iy kq kr ks kt bi translated">✨安装网络服务器<br/> ✨部署网页<br/> ✨启动服务</h2><figure class="jn jo jp jq fd jr er es paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="er es lx"><img src="../Images/c6221847d2e9aa9e6ea1ef4da821c486.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TCxNJ3RDDEALq6tTMrH5-w.png"/></div></div></figure><p id="8ab9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">为了方便起见，我只在我的本地主机上运行上面的剧本:</strong></p><figure class="jn jo jp jq fd jr er es paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="er es ly"><img src="../Images/9fc7c6438be5cc085becb63c8c61d46b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vZm1rn_ewTCRaLDYrHfY3w.png"/></div></div></figure><figure class="jn jo jp jq fd jr er es paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="er es lz"><img src="../Images/2088d7635e41884c593e21ac821555cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Nqi7Qp5fFQ8WgTcT06I85w.png"/></div></div></figure><p id="5a32" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">因此，剧本运行成功，网页可访问:</strong></p><figure class="jn jo jp jq fd jr er es paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="er es ma"><img src="../Images/ac588d73c7373f0dd80c65c4bdb69ee7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1_Mc-sLvXBohvLalx7nkgQ.png"/></div></div></figure><p id="4d03" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，假设我想将HTTPD服务器的端口号从80改为85。为此，我必须对HTTPD的配置文件进行修改。</p><p id="dfa2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这里，我将创建任何带有“.conf "扩展名，然后使用Ansible将其传输到/etc/httpd/conf.d/ location。</p><p id="6671" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">要更改端口号，我们有“Listen”关键字。</strong>以下是配置文件:</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="er es mb"><img src="../Images/ff9929769b4bccbdccdedf3b7eeecbb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sXwsyazdwExS-cDa-KkZiA.png"/></div></div></figure><p id="5226" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">现在，下一步是将这个文件复制到所需的位置并重启Webservice。</strong></p><figure class="jn jo jp jq fd jr er es paragraph-image"><div class="er es mc"><img src="../Images/264c32133fb7db5807d266ce5106b287.png" data-original-src="https://miro.medium.com/v2/resize:fit:1350/format:webp/1*p9YX1MYUMkJCVWoK1vqa7A.png"/></div></figure><p id="8e38" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里，我将重启的服务放在处理程序中，因此，它将只在“复制”模块通知它时运行，并且“复制”模块将只在任务中有任何更改时通知它。</p><p id="128b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以，让我们来看看剧本:</p><h2 id="73db" class="jz ka hi bd kb kc kd ke kf kg kh ki kj iq kk kl km iu kn ko kp iy kq kr ks kt bi translated">注意:这里，当你把端口从80改为85时，SELinux可能会引起冲突，为了方便起见，我用“setenfoce 0”禁用了SELinux一段时间。</h2><p id="ea65" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq kw is it iu kx iw ix iy ky ja jb jc hb bi translated">当我执行剧本时，它通过运行处理程序更改了端口并重启了服务:</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="er es md"><img src="../Images/4e48748474e514dc1146e18e93bbb4ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*epEZGi4CYB_3sgcHjfXZSw.png"/></div></div></figure><p id="4cd9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">网页也可以通过端口85访问:</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="er es me"><img src="../Images/ad9f15720082db18ec5ed12f168fea57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vq_kS5O2KyJcTaQvTyvg_w.png"/></div></div></figure><p id="b2f8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jy">但是如果我再次运行同样的剧本会发生什么？</em>让我们来了解一下:</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="er es mf"><img src="../Images/fa219dfce9c85c4f18ed46e98b2d11ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r6PIQzt36dmb_biUMSBQGg.png"/></div></div></figure><p id="6886" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="jy">这一次，当我们再次运行剧本时，配置文件没有变化，因此，它没有通知处理程序。因此，我们成功地实现了重启服务的幂等性。</em> </strong></p><p id="5c9b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你喜欢这篇文章，请鼓掌并分享。</p><p id="47b4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在LinkedIn上与我联系-</p><div class="mg mh ez fb mi mj"><a href="https://www.linkedin.com/in/shubham-mehta-b09335188/" rel="noopener  ugc nofollow" target="_blank"><div class="mk ab dw"><div class="ml ab mm cl cj mn"><h2 class="bd hj fi z dy mo ea eb mp ed ef hh bi translated">Shubham Mehta - S.K.M.U Dumka -印度| LinkedIn</h2><div class="mq l"><h3 class="bd b fi z dy mo ea eb mp ed ef dx translated">✨:我是一个积极的学习者，喜欢以一种敢做的心态挑战每一个问题，以便将任何想法变成现实</h3></div><div class="mr l"><p class="bd b fp z dy mo ea eb mp ed ef dx translated">www.linkedin.com</p></div></div><div class="ms l"><div class="mt l mu mv mw ms mx jw mj"/></div></div></a></div></div></div>    
</body>
</html>