<html>
<head>
<title>How to Host a Personal Email Server on Google Cloud (for Free!): Part II</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Google Cloud上托管个人邮件服务器(免费！):第二部分</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/how-to-host-a-personal-email-server-on-google-cloud-for-free-part-ii-20aaeb0ae9eb?source=collection_archive---------2-----------------------#2022-01-04">https://medium.com/geekculture/how-to-host-a-personal-email-server-on-google-cloud-for-free-part-ii-20aaeb0ae9eb?source=collection_archive---------2-----------------------#2022-01-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="78ec" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">配置后缀、邮件枪和DNS记录</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/6b2e8f16b70af07c66f9c8ac6b6afd8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uZ5IoRx580iym_S42I5RpA.jpeg"/></div></div></figure><h1 id="9df6" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">本系列文章</h1><ol class=""><li id="72bb" class="kb kc hi kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated"><a class="ae kt" href="https://lp3.medium.com/how-to-host-a-personal-email-server-on-google-cloud-for-free-part-i-8124d65d1d25" rel="noopener">简介&amp; GCP设置</a></li><li id="30c1" class="kb kc hi kd b ke ku kg kv ki kw kk kx km ky ko kp kq kr ks bi translated"><strong class="kd hj"> <em class="kz">配置后缀、邮件枪、&amp; DNS记录</em> </strong></li><li id="87c6" class="kb kc hi kd b ke ku kg kv ki kw kk kx km ky ko kp kq kr ks bi translated"><a class="ae kt" href="https://lp3.medium.com/how-to-host-a-personal-email-server-on-google-cloud-for-free-part-iii-15e2db1f1f8e" rel="noopener">配置鸽笼&amp;加密</a></li><li id="3726" class="kb kc hi kd b ke ku kg kv ki kw kk kx km ky ko kp kq kr ks bi translated"><a class="ae kt" href="https://lp3.medium.com/how-to-host-a-personal-email-server-on-google-cloud-for-free-part-iv-1b5142cab9c" rel="noopener">使用MariaDB &amp; Postfixadmin </a>管理虚拟邮箱</li><li id="8930" class="kb kc hi kd b ke ku kg kv ki kw kk kx km ky ko kp kq kr ks bi translated"><a class="ae kt" href="https://lp3.medium.com/how-to-host-a-personal-email-server-on-google-cloud-for-free-part-v-f9a4b3643622" rel="noopener">使用Roundcube托管网络邮件</a></li><li id="b87a" class="kb kc hi kd b ke ku kg kv ki kw kk kx km ky ko kp kq kr ks bi translated"><a class="ae kt" rel="noopener" href="/geekculture/how-to-host-a-personal-email-server-on-google-cloud-for-free-part-vi-6ea09f18d7df">用Rspamd &amp;筛子过滤垃圾邮件</a></li></ol><p id="6962" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">在本系列的第1部分<a class="ae kt" href="https://lp3.medium.com/how-to-host-a-personal-email-server-on-google-cloud-for-free-part-i-8124d65d1d25" rel="noopener">中，我们在GCP上设置了我们的VM实例，配置了防火墙规则来打开发送&amp;接收电子邮件所需的端口，并设置了对我们的VM的SSH访问。现在我们将安装<strong class="kd hj">后缀</strong>，设置我们的DNS记录，并将<strong class="kd hj"> Mailgun </strong>配置为我们的邮件中继。请记住，最后一步是必要的，因为GCP会阻止SMTP端口25上的所有出站流量，以防止滥用。幸运的是，这种方法的一个好处是，我们不需要维护发送电子邮件的IP信誉。这由Mailgun处理。这有助于确保人们在收件箱中收到我们的电子邮件。</a></p><p id="1845" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated"><strong class="kd hj">注意:</strong> Mailgun允许我们每个月免费发送多达30k封邮件，这对于我们的需求应该绰绰有余。</p><p id="1690" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">让我们从<em class="kz">终端</em> (MacOS/Linux)或<em class="kz"> SSH客户端</em> (Windows)连接到我们的虚拟机。在终端中，运行以下命令:</p><pre class="iy iz ja jb fd lp lq lr ls aw lt bi"><span id="65fb" class="lu jk hi lq b fi lv lw l lx ly">ssh -i <strong class="lq hj"><em class="kz">path/to/private_key</em></strong> <strong class="lq hj"><em class="kz">username</em></strong><em class="kz">@</em><strong class="lq hj"><em class="kz">external_ip</em></strong></span></pre><p id="5ab4" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">将<code class="du lz ma mb lq b"><em class="kz">path/to/private_key</em></code>替换为您的<strong class="kd hj">私有密钥</strong>的路径(在第1部分中创建)，将<code class="du lz ma mb lq b"><em class="kz">username</em></code> <em class="kz"> </em>替换为您的用户名(不带@gmail.com)，将<code class="du lz ma mb lq b"><em class="kz">external_ip</em></code>替换为您之前提到的外部ip。同样，这个过程有点不同，所以根据您的SSH客户端进行调整。</p><p id="20d5" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">像往常一样，在Linux上安装新软件时，我们应该首先从我们的库更新我们的包列表，并升级任何已安装的软件。(如果它在<em class="kz">上暂停一会儿，请不要惊慌。)</em></p><pre class="iy iz ja jb fd lp lq lr ls aw lt bi"><span id="5b2f" class="lu jk hi lq b fi lv lw l lx ly">sudo apt update &amp;&amp; sudo apt upgrade -y</span></pre><p id="8112" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">如果您希望设置虚拟机的时区，可以使用以下命令:</p><pre class="iy iz ja jb fd lp lq lr ls aw lt bi"><span id="396e" class="lu jk hi lq b fi lv lw l lx ly">sudo dpkg-reconfigure tzdata</span></pre><p id="e3cd" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">接下来，安装后缀和依赖项。</p><pre class="iy iz ja jb fd lp lq lr ls aw lt bi"><span id="cfe5" class="lu jk hi lq b fi lv lw l lx ly">sudo apt install postfix -y</span></pre><p id="aeee" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">出现提示时，选择默认配置<code class="du lz ma mb lq b"><em class="kz">Internet Site</em></code>。这告诉Postfix我们将使用它来发送和接收来自其他<em class="kz">邮件传输代理(MTA)</em>的电子邮件。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es mc"><img src="../Images/815c36bf7bbda6addae7ce3ad2c44550.png" data-original-src="https://miro.medium.com/v2/resize:fit:1268/format:webp/1*q6D3gWLHGIo0I8bTgwv3pg.png"/></div></figure><p id="feba" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">如果你还不是一个值得骄傲的域名的拥有者，现在是时候去购买一个域名了。为您的服务器将<em class="kz">系统邮件名称</em>更改为<em class="kz">完全限定域名(FDQN) </em>。这方面的惯例是您的域名<em class="kz"> </em>前面加上<code class="du lz ma mb lq b"><em class="kz">mail</em></code> <em class="kz">子域</em>。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es md"><img src="../Images/dbb3b297e0d4b7cb6f22e62aa1712b37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e9m2QobwiHBT81EV0uYrbQ.png"/></div></div></figure><p id="f940" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">安装完成后，打开<code class="du lz ma mb lq b">/etc/postfix/main.cf</code>并设置<code class="du lz ma mb lq b">myhostname = <em class="kz">mail.example.com</em></code>，使用你的邮件子域的值。将我们的更改保存到此文件。</p><h1 id="43b2" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">邮件枪和域名系统</h1><p id="5cd7" class="pw-post-body-paragraph la lb hi kd b ke kf ij ld kg kh im lf ki me lh li kk mf lk ll km mg ln lo ko hb bi translated">我们稍后将回到这个文件，但是首先让我们设置Mailgun和我们的DNS记录。如果您没有Mailgun帐户，请创建一个。如果您喜欢使用SendGrid或Mailjet作为您的邮件中继，您可以按照SendGrid的说明<a class="ae kt" href="https://cloud.google.com/compute/docs/tutorials/sending-mail/using-sendgrid" rel="noopener ugc nofollow" target="_blank">或Mailjet的说明</a><a class="ae kt" href="https://cloud.google.com/compute/docs/tutorials/sending-mail/using-mailjet" rel="noopener ugc nofollow" target="_blank">调整接下来的几个步骤。</a></p><p id="4c46" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">在Mailgun nav抽屉中，选择<em class="kz">发送&gt;域名</em>，然后<em class="kz">添加新域名</em>。输入您的子域，然后选择<em class="kz">添加域</em>。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mh"><img src="../Images/75c2463e09fdf8197f173688506184bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PyjcC8-d2LaQYgsDk9IGbg.png"/></div></div></figure><p id="8fd0" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">现在转到您的域提供商，导航到您的域的DNS设置。(我在图片中使用GoDaddy。)添加一个名为<em class="kz"> mail </em>的新<em class="kz"> A记录</em>，并提供您的VM的<em class="kz">外部ip地址</em>作为值。可以保留默认的<em class="kz"> TTL </em>。这将把我们的<em class="kz">邮件</em>子域的所有流量定向到我们的虚拟机。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mi"><img src="../Images/eef1c42b72075be29cb7d240ad64f6cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nKaXCSeLwPYoBlKGqqqQVQ.png"/></div></div></figure><p id="3789" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">然后，添加一个<em class="kz"> MX记录</em>，名称:【邮件】<em class="kz">，</em>优先级:<em class="kz"> 0 </em>，值:<em class="kz">你的域</em>，<em class="kz">默认</em> TTL。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mj"><img src="../Images/bc64b5fb60e1ce1bd5b152bc24ab7a36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dxr_U6ITRGNeTMfaUQNSJw.png"/></div></div></figure><p id="1f9c" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated"><strong class="kd hj">注意:</strong>创建这两个记录，而不仅仅是一个名为<em class="kz"> mail </em>的<em class="kz"> MX记录</em>，将允许我们稍后托管我们的webmail接口。</p><p id="1edc" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated"><em class="kz"> MX记录</em>用于将您的域的传入邮件定向到您的服务器。现在按照Mailgun说明的第2部分中的步骤，设置允许从您的域发送验证邮件所需的两个<em class="kz"> TXT记录</em>。这些记录用于验证通过Mailgun从您的服务器发送的电子邮件确实是您发送的。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mk"><img src="../Images/c97fc0078a2d5b27f50a8f7fff608eec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q7OubBieP_XCLOctEWzr7w.png"/></div></div></figure><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ml"><img src="../Images/684793d17999234f1f28c8127b5170a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HRM0WHjK0M7xrzTATcG7Rw.png"/></div></div></figure><p id="2367" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">接下来，我们需要设置从Postfix到我们的Mailgun帐户的认证。在Mailgun上选择您的<em class="kz">域设置</em>下的<em class="kz"> SMTP凭证</em>选项卡。您的登录用户名将类似于<strong class="kd hj"><em class="kz">postmaster@mail.example.com</em></strong>。点击<em class="kz">重置密码</em>并复制其创建的密码。我们将使用我们的凭证创建一个文件，然后使用<code class="du lz ma mb lq b">postmap</code>创建一个将被Postfix使用的散列表。使用您最喜欢的编辑器，创建<code class="du lz ma mb lq b">/etc/postfix/sasl_passwd</code>并添加以下行(用Mailgun提供的用户名和<em class="kz">密码</em>替换<em class="kz">用户名和<em class="kz">密码】:</em></em></p><pre class="iy iz ja jb fd lp lq lr ls aw lt bi"><span id="9dd6" class="lu jk hi lq b fi lv lw l lx ly">[smtp.mailgun.org]:2525    <em class="kz">username</em>:<em class="kz">password</em></span></pre><p id="ba95" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">现在创建哈希表。</p><pre class="iy iz ja jb fd lp lq lr ls aw lt bi"><span id="ab63" class="lu jk hi lq b fi lv lw l lx ly">sudo postmap /etc/postfix/sasl_passwd</span></pre><p id="89af" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">然后，删除包含凭据的文件。</p><pre class="iy iz ja jb fd lp lq lr ls aw lt bi"><span id="4e63" class="lu jk hi lq b fi lv lw l lx ly">sudo rm /etc/postfix/sasl_passwd</span></pre><p id="e640" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">在你的<code class="du lz ma mb lq b">.db</code>文件上设置权限。</p><pre class="iy iz ja jb fd lp lq lr ls aw lt bi"><span id="5749" class="lu jk hi lq b fi lv lw l lx ly">sudo chmod 600 /etc/postfix/sasl_passwd.db</span></pre><p id="2953" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">在<code class="du lz ma mb lq b">/etc/postfix/main.cf</code>中添加或编辑这些行:</p><pre class="iy iz ja jb fd lp lq lr ls aw lt bi"><span id="9c10" class="lu jk hi lq b fi lv lw l lx ly">relayhost = [smtp.mailgun.org]:2525</span><span id="ae48" class="lu jk hi lq b fi mm lw l lx ly">smtp_sasl_auth_enable = yes<br/>smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd<br/>smtp_sasl_security_options = noanonymous</span></pre><p id="9e7d" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">我们在这里所做的是告诉Postfix使用Mailgun作为我们的外发邮件中继，并通过端口2525发送外发邮件(因为GCP阻塞了默认端口25上的外发流量)。所配置的密码映射指示Postfix使用Mailgun提供的凭证来验证对所述中继主机的所有请求。我们需要重新启动Postfix服务来应用更改。</p><pre class="iy iz ja jb fd lp lq lr ls aw lt bi"><span id="3c96" class="lu jk hi lq b fi lv lw l lx ly">sudo service postfix restart</span></pre><p id="6b6a" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">现在，我们可以向我们的谷歌帐户发送一封测试电子邮件。</p><pre class="iy iz ja jb fd lp lq lr ls aw lt bi"><span id="0dd5" class="lu jk hi lq b fi lv lw l lx ly">echo 'Test passed!' | sudo sendmail -s <em class="kz">username@gmail.com</em></span></pre><p id="79f6" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">如果您正确遵循了本指南，您应该会收到这封电子邮件。如果有问题，确保你没有错过一个步骤或包括在错别字。检查邮件日志<code class="du lz ma mb lq b">/var/log/mail.err</code> &amp; <code class="du lz ma mb lq b">/var/log/mail.log</code>来查明问题。如果您仍然不知道问题出在哪里，请随时联系我。</p><p id="5563" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated"><strong class="kd hj">注意:</strong>如果您希望在此服务器上托管多个域的电子邮件，请查看补充指南<a class="ae kt" href="https://lp3.medium.com/configuring-postfix-for-multi-domain-mail-relay-d33cd236298a" rel="noopener"> <strong class="kd hj">为多域邮件中继配置Postfix</strong></a>，了解一些需要进行的更改。完成这个系列后，这很容易实现。</p><h1 id="2aad" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">结论</h1><p id="ca5b" class="pw-post-body-paragraph la lb hi kd b ke kf ij ld kg kh im lf ki me lh li kk mf lk ll km mg ln lo ko hb bi translated">干得好！您离在云端托管自己的电子邮件又近了几步！让我们回顾一下本文中所涉及的内容。</p><ul class=""><li id="09b3" class="kb kc hi kd b ke lc kg le ki mn kk mo km mp ko mq kq kr ks bi translated">我们安装并配置了Postfix来发送和接收邮件。</li><li id="b22c" class="kb kc hi kd b ke ku kg kv ki kw kk kx km ky ko mq kq kr ks bi translated">我们设置Mailgun作为我们的电子邮件中继，因为GCP阻止端口25出站。</li><li id="a46f" class="kb kc hi kd b ke ku kg kv ki kw kk kx km ky ko mq kq kr ks bi translated">我们配置了我们域的DNS记录，将电子邮件流量定向到我们的服务器，并通过Mailgun验证来自我们服务器的电子邮件流量。</li></ul><p id="60b0" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">在下一篇文章中，我们将设置Dovecot来管理我们的邮箱并通过IMAP连接到我们的服务器，允许从电子邮件客户端向Postfix提交邮件，并加密我们的流量。</p><p id="8e73" class="pw-post-body-paragraph la lb hi kd b ke lc ij ld kg le im lf ki lg lh li kk lj lk ll km lm ln lo ko hb bi translated">感谢您的阅读！如果你觉得这篇文章很有帮助，并且有兴趣继续关注这个系列的其他部分，请鼓掌并关注即将发布的文章。</p></div></div>    
</body>
</html>