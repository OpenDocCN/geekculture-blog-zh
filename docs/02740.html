<html>
<head>
<title>Creating a Whitelist for a Secrets Manager Secret</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为机密管理器机密创建白名单</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/creating-a-whitelist-for-a-secrets-manager-secret-e4860672cab9?source=collection_archive---------55-----------------------#2021-05-24">https://medium.com/geekculture/creating-a-whitelist-for-a-secrets-manager-secret-e4860672cab9?source=collection_archive---------55-----------------------#2021-05-24</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="fd27" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2021年5月24日</p><p id="2efa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">作者托马斯</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/227f334a97b13dce786c975b93e2c808.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6J8aNCPOiZ2NrYK82qp9Cw.jpeg"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Photo by <a class="ae jt" href="https://unsplash.com/@silas_crioco?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Silas Köhler</a> on <a class="ae jt" href="https://unsplash.com/s/photos/key?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="8cd3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不久前，我试图阻止除了少数IAM角色和用户之外的任何人访问AWS Secrets Manager中的秘密。这看起来似乎是一个简单的任务，但也有一些挑战。我将包含一个模板的片段来检查不同的部分，但如果你宁愿只是抓取整个模板的副本，我已经将它添加到我的<a class="ae jt" href="https://github.com/thomasstep/aws-cloudformation-reference/blob/master/secretsmanager/whitelisted-secret.yml" rel="noopener ugc nofollow" target="_blank">AWS-cloudformation-reference GitHub repo</a>中，以及我作为参考点创建的其他cloud formation模板。以下是附加到机密的资源策略版本，它允许访问特定的IAM角色和用户。</p><pre class="je jf jg jh fd ju jv jw jx aw jy bi"><span id="0bfe" class="jz ka hi jv b fi kb kc l kd ke">Parameters:<br/>  WhitelistedRoleIds:<br/>    Type: CommaDelimitedList<br/>    Description: &gt;<br/>      IDs (AROA*, or AIDA*) to whitelist access for on the created secret.<br/>      Find the Role ID by running aws iam get-role --role-name ROLE-NAME.<br/>      Remember to append :* to the end of the Role IDs.<br/>      Find the User ID by running aws iam get-user --user-name USER-NAME.<br/>      User IDs do not need :* appended to the end.<br/><br/>Resources:<br/>  ...<br/>  SecretResourcePolicy:<br/>    Type: 'AWS::SecretsManager::ResourcePolicy'<br/>    Properties:<br/>        SecretId: !Ref MySecret<br/>        ResourcePolicy:<br/>          Version: 2012-10-17<br/>          Statement:<br/>            - Resource: !Ref MySecret<br/>              Action: 'secretsmanager:GetSecretValue'<br/>              Effect: Deny<br/>              Principal: '*'<br/>              Condition:<br/>                StringNotLike:<br/>                  aws:userId: !Ref WhitelistedRoleIds</span></pre><p id="3477" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有一些值得指出的细微差别是我在弄清楚这个配置时偶然发现的。</p><p id="81e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第一，我想用资源政策打基础。当我遇到这个问题时，我已经知道(尽管没有太多的实践经验)，一些AWS资源允许我们将资源策略附加到它们上面。其他一些资源包括S3和Lambda(关于一个庞大的列表<a class="ae jt" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_aws-services-that-work-with-iam.html" rel="noopener ugc nofollow" target="_blank">查看本页</a>的“基于资源的政策”一栏)。</p><p id="c246" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">资源策略允许我们<a class="ae jt" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_evaluation-logic.html#policy-eval-denyallow" rel="noopener ugc nofollow" target="_blank">基于一些关键属性创建访问和拒绝的捷径</a>，这些属性在资源的大多数API调用中都可用。这意味着，即使IAM角色明确允许访问某个资源，资源策略也可以明确拒绝该角色的访问，从而拒绝承担该角色的资源。反之亦然，如果资源策略明确授予访问权限，则拒绝访问资源的IAM角色将被覆盖。</p><p id="7ae2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我试图在脑海中简化这一点，认为无论什么规则都是最接近资源获胜的。IAM角色可以是一般的东西，但是资源策略直接附加到资源。这意味着资源策略上的规则每次都胜过IAM角色。</p><p id="dcda" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我们的资源策略知识的基础上，我们开始进入这个特定的Secrets Manager资源策略的具体细节。由于我们希望创建一个白名单，并将所有其他IAM资源列入黑名单，因此我们需要明确拒绝除白名单资源之外的所有资源。不幸的是，我们不能将其简化为在一个语句中对所有内容进行显式拒绝，然后在另一个语句中给出显式允许。规则对自身进行优先排序的方式会让“否定一切”优先。</p><p id="d63e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们已经了解了什么是资源策略，下一步是了解在API调用Secret时哪些类型的属性是可用的，根据这些属性我们可以授予或拒绝访问权限。我尝试使用的第一个也是最明显的资源策略配置类型是<code class="du kf kg kh jv b">NotPrincipal</code>。这类似于前述资源策略<a class="ae jt" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notprincipal.html#specifying-notprincipal" rel="noopener ugc nofollow" target="_blank">中的<code class="du kf kg kh jv b">Principal</code>，除了它做相反的事情</a>。我开始尝试完成同样的目标，但是使用了<code class="du kf kg kh jv b">NotPrincipal</code>，我希望它看起来像下面这样。</p><pre class="je jf jg jh fd ju jv jw jx aw jy bi"><span id="f771" class="jz ka hi jv b fi kb kc l kd ke">- Resource: !Ref MySecret<br/>  Action: 'secretsmanager:GetSecretValue'<br/>  Effect: Deny<br/>  NotPrincipal:<br/>    AWS: !Ref WhitelistedPrincipals</span></pre><p id="9bd5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不幸的是，当一个API调用来自一个假定的IAM角色时，它看起来不再像<code class="du kf kg kh jv b">arn:aws:sts::AWS_ACCOUNT_ID:assumed-role/ROLE_NAME/SESSION_NAME</code>，它也被称为假定的角色ARN。由于<code class="du kf kg kh jv b">Principal</code>由IAM角色的ARN和假定角色ARN组成，IAM将拒绝对资源的访问，因为<code class="du kf kg kh jv b">Principal</code>并不完全匹配。</p><p id="74d2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du kf kg kh jv b">aws:userId</code>传入。经过一番搜索，我最终登陆了一个页面<a class="ae jt" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_condition-keys.html#condition-keys-userid" rel="noopener ugc nofollow" target="_blank">，上面列出了IAM策略条件关键字</a>。这是第一部分。第二部分是一篇关于限制使用S3水桶的博文，类似于我想用我的秘密做的事情。这篇文章解释说，已经假定的IAM角色将总是在<code class="du kf kg kh jv b">aws:userId</code>变量中传递相同的角色ID以及会话名称。我喜欢把这个独特的角色ID看作是IAM角色ARN和虚拟角色ARN的混合体。因为它是一个单一变量，所以我们可以在资源策略中基于它授予访问权限。</p><p id="0d75" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果有人好奇，<code class="du kf kg kh jv b">AROA*</code>和<code class="du kf kg kh jv b">AIDA*</code>是由AWS 预定义的<a class="ae jt" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_identifiers.html#identifiers-unique-ids" rel="noopener ugc nofollow" target="_blank">唯一前缀。我记得在浏览一些不相关的日志时注意到了这种模式，并想知道它们是否都有意义。事实证明确实如此。</a></p><p id="df71" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用<code class="du kf kg kh jv b">aws:userId</code>变量允许我们将IAM用户和角色列入白名单。IAM角色需要像<code class="du kf kg kh jv b">AROAJQABLZS4A3QDU576Q:*</code>一样被列入白名单，因为会话名被附加到角色ID的末尾。(在进行API调用之前，必须首先假定角色。)一个IAM用户需要像<code class="du kf kg kh jv b">AIDAJQABLZS4A3QDU576Q</code>一样被列入白名单，但不附加<code class="du kf kg kh jv b">:*</code>。要找到那些看起来很时髦的id，运行<code class="du kf kg kh jv b">aws iam get-role --role-name ROLE_NAME</code>或<code class="du kf kg kh jv b">aws iam get-user --user-name USER_NAME</code>。</p><p id="2df5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我不得不走了好几个兔子洞才弄明白这一点，这就是为什么它需要一个故事而不是一个简单的片段。对于任何可能遇到这种情况并需要更多帮助的人，请随时联系我，我会尽我所能！</p></div><div class="ab cl ki kj gp kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="hb hc hd he hf"><p id="4341" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kp">原载于2021年5月24日https://thomasstep.com</em><em class="kp"/><a class="ae jt" href="https://thomasstep.com/blog/creating-a-whitelist-for-secrets-manager-secret" rel="noopener ugc nofollow" target="_blank"><em class="kp">。</em></a></p></div></div>    
</body>
</html>