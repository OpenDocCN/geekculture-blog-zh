<html>
<head>
<title>Forgot Password in SignUp Application with NodeJs and MongoDB(Part 4)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用NodeJs和MongoDB注册应用程序时忘记了密码(第4部分)</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/forgot-password-in-signup-application-with-nodejs-and-mongodb-part-4-51378dddd716?source=collection_archive---------0-----------------------#2021-04-11">https://medium.com/geekculture/forgot-password-in-signup-application-with-nodejs-and-mongodb-part-4-51378dddd716?source=collection_archive---------0-----------------------#2021-04-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/027712537cab7172137219c167311f8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/format:webp/0*9ywnvEYNioUm3XSm.png"/></div></figure><p id="2cdd" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在本文中，我们将继续讨论注册应用程序。在这一部分，我将写忘记密码，用nodemailer发送电子邮件，以及重置密码。如果你准备好了，我们就开始吧！</p><p id="ed7d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">首先，上一部分我用的是mailgun，不是nodemailer。但是当我搜索发送电子邮件的方法时，我看到了nodemailer，我想用它来区别一下。</p><p id="f5f6" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">对于重置密码，我们在用户模型中需要一个字符串变量。我也创建了一个日期变量，但是我没有使用它，所以你可以传递它。字符串变量被命名为resetPasswordToken。我们需要一个名为crypto的包，我们需要它在上面。</p><p id="d38c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在用户模型中，我们将在这个变量中创建一个名为getResetPasswordToken的方法:</p><p id="0cd9" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><code class="du jk jl jm jn b">const resetToken = crypto.randomBytes(20).toString('hex');</code></p><p id="144e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在，我们需要散列token并设置resetPasswordToken字段，设置expire并返回resetToken。关于getResetPasswordToken的完整代码在这里:</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="er es jo"><img src="../Images/3295e240a9cb293ec32a359f5e168e8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ScFxmdEGJxwY1nuGb20TcA.png"/></div></div><figcaption class="jx jy et er es jz ka bd b be z dx">getResetPasswordToken</figcaption></figure><p id="bb10" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">为了捕捉邮件，我将使用mailgun，创建一个帐户，并获得一些定义。</p><p id="0915" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们将创建一个名为sendEmail的中间件。在这种情况下，我们需要nodemailer，因此我们将停止服务器并使用以下命令安装nodemailer:</p><p id="4c4d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><code class="du jk jl jm jn b">npm install nodemailer</code></p><p id="75ec" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们需要它，在中间件之上。</p><p id="7a83" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在nodemailer网站上，我们将复制这些代码:</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="er es jo"><img src="../Images/eb83d5a19369f2042626db0624d29e93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yAapgkvvktm5oqbllEYWug.png"/></div></div><figcaption class="jx jy et er es jz ka bd b be z dx">nodemailer</figcaption></figure><p id="7bde" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我可以随意改变一些部分。在createTransport中，您可以看到主机、端口和身份验证与网站不同。对于这些，我们会去。env文件并创建SMTP_HOST、SMTP_PORT、SMTP_EMAIL、SMTP_PASSWORD。在mailgun，我们可以看到这些部分，我当然不分享它们。</p><p id="6b67" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在，我们需要一个名为forgotPassword的方法。使用这种方法，我们将接收一封电子邮件并发送一个请求。</p><p id="e815" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><code class="du jk jl jm jn b">const user = await User.findOne({ email: req.body.email });</code></p><p id="634e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果用户不存在，我们将创建一个错误。这些和我之前的文章差不多，就不解释了。</p><pre class="jp jq jr js fd kb jn kc kd aw ke bi"><span id="c055" class="kf kg hi jn b fi kh ki l kj kk">const resetToken = user.getResetPasswordToken();</span><span id="2b12" class="kf kg hi jn b fi kl ki l kj kk">await user.save({ validateBeforeSave: false})</span></pre><p id="ef23" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这样，我们在数据库中有了两个变量，当我们重置密码时，它们将被销毁。</p><p id="772c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们将创建这样一条消息:</p><p id="5743" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">`您收到这封电子邮件是因为您(或其他人)请求重置密码。请向以下地址发出上传请求:\ n \ n $ { resetUrl }</p><p id="dd17" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">因此，当电子邮件消失时，这将解释它为什么会消失。</p><p id="43a7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在，我们创建一个尝试捕捉。</p><pre class="jp jq jr js fd kb jn kc kd aw ke bi"><span id="a92c" class="kf kg hi jn b fi kh ki l kj kk">try {</span><span id="975c" class="kf kg hi jn b fi kl ki l kj kk">await sendEmail({</span><span id="047e" class="kf kg hi jn b fi kl ki l kj kk">email: user.email,</span><span id="13c4" class="kf kg hi jn b fi kl ki l kj kk">subject: 'Password reset token',</span><span id="8a17" class="kf kg hi jn b fi kl ki l kj kk">message</span><span id="6c0b" class="kf kg hi jn b fi kl ki l kj kk">})</span><span id="3204" class="kf kg hi jn b fi kl ki l kj kk">res.status(200).json({ success: true, data:'Email sent' });</span><span id="064d" class="kf kg hi jn b fi kl ki l kj kk">} catch (error) {</span><span id="68fb" class="kf kg hi jn b fi kl ki l kj kk">console.log(err);</span><span id="a2d7" class="kf kg hi jn b fi kl ki l kj kk">user.getResetPasswordToken = undefined;</span><span id="6645" class="kf kg hi jn b fi kl ki l kj kk">user.resetPasswordExpire = undefined;</span><span id="0ede" class="kf kg hi jn b fi kl ki l kj kk">await user.save({ validateBeforeSave: false })</span><span id="fe69" class="kf kg hi jn b fi kl ki l kj kk">return next(new ErrorResponse('Email could not be sent', 500))</span><span id="a294" class="kf kg hi jn b fi kl ki l kj kk">}</span></pre><p id="a165" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这个方法完成了，最后，我们将创建resetPassword函数。我们将通过以下方式获得散列令牌:</p><pre class="jp jq jr js fd kb jn kc kd aw ke bi"><span id="68ea" class="kf kg hi jn b fi kh ki l kj kk">const resetPasswordToken = crypto</span><span id="9517" class="kf kg hi jn b fi kl ki l kj kk">.createHash('sha256')</span><span id="e101" class="kf kg hi jn b fi kl ki l kj kk">.update(req.params.resetToken)</span><span id="62b8" class="kf kg hi jn b fi kl ki l kj kk">.digest('hex');</span></pre><p id="0543" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们将创建一个用户，并使用findOne方法。在此:</p><pre class="jp jq jr js fd kb jn kc kd aw ke bi"><span id="644e" class="kf kg hi jn b fi kh ki l kj kk">const user = await User.findOne({</span><span id="aa88" class="kf kg hi jn b fi kl ki l kj kk">resetPasswordToken,</span><span id="2e97" class="kf kg hi jn b fi kl ki l kj kk">resetPasswordExpire: { $gt: Date.now() }</span><span id="e902" class="kf kg hi jn b fi kl ki l kj kk">});</span></pre><p id="ffb6" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果用户不存在，我们将创建一个错误。现在，我们需要设置一个新密码，并销毁resetPasswordToken和resetPasswordExpire，然后保存用户并发送TokenResponse:</p><pre class="jp jq jr js fd kb jn kc kd aw ke bi"><span id="9df8" class="kf kg hi jn b fi kh ki l kj kk">user.password = req.body.password;</span><span id="29f2" class="kf kg hi jn b fi kl ki l kj kk">user.resetPasswordToken = undefined;</span><span id="509a" class="kf kg hi jn b fi kl ki l kj kk">user.resetPasswordExpire = undefined;</span><span id="1823" class="kf kg hi jn b fi kl ki l kj kk">await user.save();</span><span id="37a3" class="kf kg hi jn b fi kl ki l kj kk">const id = user.getId();</span><span id="da63" class="kf kg hi jn b fi kl ki l kj kk">sendTokenResponse(user, 200, res, id);</span></pre><p id="e873" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">forgotPassword看起来像这样:</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="er es jo"><img src="../Images/1808928747f693f0da7806f1275d8703.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*APSnxCnEJHNdBGK4OnsAqQ.png"/></div></div><figcaption class="jx jy et er es jz ka bd b be z dx">forgotPassword</figcaption></figure><p id="bdf6" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">resetPassword看起来像这样:</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="er es jo"><img src="../Images/79bddfdc856cf91c2b2cee455d30e880.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UNILKIW0rN7MQnjqXYe4JQ.png"/></div></div><figcaption class="jx jy et er es jz ka bd b be z dx">resetPassword</figcaption></figure><p id="8d98" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在routes/auth.js中，我们将需要forgotPassword和resetPassword函数，并在getMe函数中使用它们:</p><pre class="jp jq jr js fd kb jn kc kd aw ke bi"><span id="700a" class="kf kg hi jn b fi kh ki l kj kk">router.post(‘/forgotPassword’, forgotPassword);<br/>router.put(‘/resetPassword/:resetToken’, resetPassword);</span></pre><p id="7b26" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">最后，在Postman中，我们将创建一个Post请求，如下所示</p><p id="832a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><code class="du jk jl jm jn b"><a class="ae km" href="http://localhost:5000/forgotPassword" rel="noopener ugc nofollow" target="_blank">http://localhost:5000/forgotPassword</a></code></p><p id="ac2c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">发送电子邮件，然后查看邮箱，你可以看到一封电子邮件。然后我们回到邮递员那里，写下:</p><pre class="jp jq jr js fd kb jn kc kd aw ke bi"><span id="fb98" class="kf kg hi jn b fi kh ki l kj kk"><a class="ae km" href="http://localhost:5000/resetPassword/3b966021af5e6a5146048787ac3aa5066988dcb4" rel="noopener ugc nofollow" target="_blank">http://localhost:5000/resetPassword</a>/:resetToken</span></pre><p id="f8df" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">并发送put请求，您将看到用户数据、令牌和id。</p><p id="9d69" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">就是这样。感谢阅读。</p></div></div>    
</body>
</html>