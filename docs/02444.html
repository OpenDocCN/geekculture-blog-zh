<html>
<head>
<title>Development Containers and CLI Tools — a Match Made in Heaven</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">开发容器和CLI工具——天作之合</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/building-development-containers-and-cli-tools-a-match-made-in-heaven-a7a0e0719e06?source=collection_archive---------14-----------------------#2021-05-15">https://medium.com/geekculture/building-development-containers-and-cli-tools-a-match-made-in-heaven-a7a0e0719e06?source=collection_archive---------14-----------------------#2021-05-15</a></blockquote><div><div class="dt gx gy gz ha hb"/><div class="hc hd he hf hg"><h2 id="6b94" class="hh hi hj bd b fq hk hl hm hn ho hp dy hq translated" aria-label="kicker paragraph">如何教程</h2><div class=""/><div class=""><h2 id="5520" class="pw-subtitle-paragraph ip hs hj bd b iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg dy translated">第1部分:如何用VS代码和Docker构建一个开发容器(外加一个演示视频)</h2></div><figure class="ji jj jk jl fe jm es et paragraph-image"><div role="button" tabindex="0" class="jn jo di jp bf jq"><div class="es et jh"><img src="../Images/c724900732bbc0fb5034f099f8c3baea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FRJWLYk9-jlJSloj6oTYmQ.jpeg"/></div></div><figcaption class="jt ju eu es et jv jw bd b be z dy">Butterfly Nebula by <a class="ae jx" href="http://www.nasa.gov/" rel="noopener ugc nofollow" target="_blank">NASA</a>, <a class="ae jx" href="http://www.spacetelescope.org/" rel="noopener ugc nofollow" target="_blank">ESA</a>, and the Hubble SM4 ERO Team</figcaption></figure><p id="2df4" class="pw-post-body-paragraph jy jz hj ka b kb kc it kd ke kf iw kg kh ki kj kk kl km kn ko kp kq kr ks kt hc bi ku translated">ev容器和CLI工具在开源和商业项目中越来越受欢迎。最近，我为我参与的开源项目<a class="ae jx" href="https://github.com/SLOCloud/SLOC" rel="noopener ugc nofollow" target="_blank">北极星SLO云</a>构建了一个开发容器。之前，我报道了主要的<a class="ae jx" href="https://stefannastic.medium.com/why-every-open-source-project-needs-a-development-container-b1f5180ad5aa" rel="noopener">经验教训</a>。在这个由两部分组成的系列中，我将给出一个实践教程，介绍如何用VS代码和Docker构建开发容器(第1部分——本文)，以及如何用Nx创建CLI工具(第2部分)。</p></div><div class="ab cl ld le gq lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="hc hd he hf hg"><h1 id="4ee1" class="lk ll hj bd lm ln lo lp lq lr ls lt lu iy lv iz lw jb lx jc ly je lz jf ma mb bi translated">用Docker和VS代码构建一个开发容器</h1><p id="7f72" class="pw-post-body-paragraph jy jz hj ka b kb mc it kd ke md iw kg kh me kj kk kl mf kn ko kp mg kr ks kt hc bi translated">在这一节中，我将展示如何使用VS代码和Docker从头开始构建一个dev容器。在本文的后面，我将展示一个演示视频，演示如何使用Visual Studio Code Remote-Containers扩展来运行dev容器。为了能够跟随并运行演示，您首先需要安装:</p><ul class=""><li id="4606" class="mh mi hj ka b kb kc ke kf kh mj kl mk kp ml kt mm mn mo mp bi translated"><a class="ae jx" href="https://www.docker.com/products/docker-desktop" rel="noopener ugc nofollow" target="_blank">Docker Desktop for Windows/Mac</a>或<a class="ae jx" href="https://docs.docker.com/get-docker/" rel="noopener ugc nofollow" target="_blank"> Linux </a></li><li id="1c62" class="mh mi hj ka b kb mq ke mr kh ms kl mt kp mu kt mm mn mo mp bi translated"><a class="ae jx" href="https://code.visualstudio.com/" rel="noopener ugc nofollow" target="_blank"> Visual Studio代码</a>和<a class="ae jx" href="https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.vscode-remote-extensionpack" rel="noopener ugc nofollow" target="_blank">远程开发扩展包</a></li><li id="2558" class="mh mi hj ka b kb mq ke mr kh ms kl mt kp mu kt mm mn mo mp bi translated"><a class="ae jx" href="https://minikube.sigs.k8s.io/" rel="noopener ugc nofollow" target="_blank"> Minikube </a>(可选；仅需要运行演示)</li></ul><h2 id="ba67" class="mv ll hj bd lm mw mx my lq mz na nb lu kh nc nd lw kl ne nf ly kp ng nh ma hp bi translated">开发环境、源代码和开发容器</h2><p id="2305" class="pw-post-body-paragraph jy jz hj ka b kb mc it kd ke md iw kg kh me kj kk kl mf kn ko kp mg kr ks kt hc bi translated">在本节的最后，我们将能够将运行在主机(例如笔记本电脑)上的IDE(在本例中是VS代码)连接到我们的开发容器。这个容器将运行一个完全配置好的开发环境。最后，我们将能够从我们的Git repo中获取最新版本的源代码，并开始在我们的主机上运行的ide中进行开发。</p><p id="725d" class="pw-post-body-paragraph jy jz hj ka b kb kc it kd ke kf iw kg kh ki kj kk kl km kn ko kp kq kr ks kt hc bi translated">源代码可以克隆在本地文件系统上，也可以克隆在<em class="ni">持久docker卷上。</em>在下面的演示中，我们将展示如何实现后者，因为由于<a class="ae jx" href="https://stefannastic.medium.com/why-every-open-source-project-needs-a-development-container-b1f5180ad5aa" rel="noopener">性能问题，目前不建议从本地文件系统挂载。</a>有趣的是，容器和源代码之间没有依赖关系。这有利于共享开发容器，或者为开发人员提供额外的灵活性。</p><p id="dee5" class="pw-post-body-paragraph jy jz hj ka b kb kc it kd ke kf iw kg kh ki kj kk kl km kn ko kp kq kr ks kt hc bi translated"><em class="ni">完全配置的开发环境</em>应该包含所有必需的开发/构建工具，如语言SDK和Git，运行时服务，如开发数据库，完整的配置模型，如网络和环境变量，以及完全配置的IDE，以及所有必需的扩展、代码风格等等。现在让我们看看如何构建一个dev容器。</p><p id="ef10" class="pw-post-body-paragraph jy jz hj ka b kb kc it kd ke kf iw kg kh ki kj kk kl km kn ko kp kq kr ks kt hc bi translated">两个主要部分组成了一个开发容器:一个<em class="ni"> Dockerfile </em>和一个<em class="ni"> devcontainer.json </em>文件。实际上，通常会有第三个部分——一组自动化任务的shell脚本，例如配置文件管理和处理。为了使存储库“<em class="ni"> dev containers准备好</em>”，需要将所有这些文件放在一个<em class="ni">中。存储库根目录中的devcontainer </em>目录。当存储库是monorepo时，这种方法存在一些问题，但这超出了本文的范围。</p><h2 id="ea9c" class="mv ll hj bd lm mw mx my lq mz na nb lu kh nc nd lw kl ne nf ly kp ng nh ma hp bi translated">从docker文件构建开发容器</h2><p id="95fe" class="pw-post-body-paragraph jy jz hj ka b kb mc it kd ke md iw kg kh me kj kk kl mf kn ko kp mg kr ks kt hc bi translated"><em class="ni"> Dockerfile </em>只是一个普通的Dockerfile，用于为dev容器构建容器映像。使用VS代码的一个好结果是微软提供了许多有用的<a class="ae jx" href="https://github.com/microsoft/vscode-dev-containers/tree/master/containers" rel="noopener ugc nofollow" target="_blank">容器基础映像</a>。</p><figure class="ji jj jk jl fe jm"><div class="bz dz l di"><div class="nj nk l"/></div><figcaption class="jt ju eu es et jv jw bd b be z dy">Dockerfile of our dev container (partial)</figcaption></figure><p id="1af3" class="pw-post-body-paragraph jy jz hj ka b kb kc it kd ke kf iw kg kh ki kj kk kl km kn ko kp kq kr ks kt hc bi translated">在我们的<em class="ni"> Dockerfile </em>中，我们使用typescript-node作为我们的基本映像，它引入了许多有用的工具，比如:typescript、Node.js、Git等等。我们将<em class="ni"> kubectl </em>添加到容器中，因为这是运行我们定制的Kubernetes操作符所必需的。可以在本地运行整个堆栈，也包括Kubernetes集群。目前，我们只支持Minikube上的本地集群，它需要在主机上安装和运行。最后，使用<em class="ni"> Dockerfile </em>，我们还向容器添加了一个定制的bash脚本。该脚本用于挂载主机的<em class="ni">。kubeconfig </em>到容器中，安装网络并配置Kubernetes集群证书。为了保持主机和容器同步，脚本在每次登录时执行，例如，当dev容器从IDE启动时。</p><h2 id="d7aa" class="mv ll hj bd lm mw mx my lq mz na nb lu kh nc nd lw kl ne nf ly kp ng nh ma hp bi translated">用devcontainer.json配置开发容器</h2><p id="3bd7" class="pw-post-body-paragraph jy jz hj ka b kb mc it kd ke md iw kg kh me kj kk kl mf kn ko kp mg kr ks kt hc bi translated">dev容器的第二个关键要素是一个<em class="ni"> devcontainer.json </em>文件，它是特定于VS代码的。它基本上是一个配置文件，告诉VS代码如何构建和启动一个dev容器。它还提供了一些额外的开发环境配置。下面是我们的<em class="ni"> devcontainer.json </em>配置的一个片段。</p><figure class="ji jj jk jl fe jm"><div class="bz dz l di"><div class="nj nk l"/></div><figcaption class="jt ju eu es et jv jw bd b be z dy">Devcontainer.json of our dev container (partial)</figcaption></figure><p id="2a2f" class="pw-post-body-paragraph jy jz hj ka b kb kc it kd ke kf iw kg kh ki kj kk kl km kn ko kp kq kr ks kt hc bi translated">我们可以看到<em class="ni"> devcontainer.json </em>支持配置一些有趣的东西，比如:</p><ul class=""><li id="de23" class="mh mi hj ka b kb kc ke kf kh mj kl mk kp ml kt mm mn mo mp bi translated">通过使用<em class="ni"> remoteEnv </em>对象为dev容器声明环境变量，这比使用Dockerfile要干净一些。在我们的示例中，我们展示了一个简单的env变量<em class="ni">SYNC _ LOCALHOST _ kube config</em>，它由我们的<em class="ni"> copy-kube-config </em> bash脚本使用。</li><li id="3930" class="mh mi hj ka b kb mq ke mr kh ms kl mt kp mu kt mm mn mo mp bi translated">通过简单地声明一个<em class="ni">挂载列表</em>，将目录从主机文件系统挂载到容器文件系统。这里我们展示了如何挂载一个本地。<em class="ni"> kube </em>目录，包含本地(主机)Kubernetes集群的所有配置文件。这使得我们的Kubernetes操作符(运行在我们的dev容器中)能够开箱即用地与本地集群进行交互，而无需任何额外的配置。</li><li id="ec5e" class="mh mi hj ka b kb mq ke mr kh ms kl mt kp mu kt mm mn mo mp bi translated">创建容器后，在容器内安装所需的VS代码<em class="ni">扩展</em>。这实现了统一的开发人员体验，并可用于实施一些公司/组织范围的策略。例如，代码格式化程序和linters。</li><li id="0730" class="mh mi hj ka b kb mq ke mr kh ms kl mt kp mu kt mm mn mo mp bi translated">容器内的转发端口(<em class="ni"> forwardPorts </em>)，以便它们在本地可用。容器启动后，VS代码将在ports选项卡下显示本地地址，例如<em class="ni"> localhost:1234 </em>。这个特性在很多情况下非常有用，比如访问运行在容器中的服务或者在浏览器中查看WebUI。我发现这比使用原生Docker支持更方便，例如，使用原生Docker支持需要知道在Docker中公开和发布端口之间的区别。</li><li id="4288" class="mh mi hj ka b kb mq ke mr kh ms kl mt kp mu kt mm mn mo mp bi translated">公开不同的生命周期挂钩，允许在容器中运行额外的命令。最有用的钩子是<em class="ni">postCreateCommand——它支持</em>安装额外的语言、框架或系统包/依赖项。它在装入源代码后触发。</li></ul><p id="5b81" class="pw-post-body-paragraph jy jz hj ka b kb kc it kd ke kf iw kg kh ki kj kk kl km kn ko kp kq kr ks kt hc bi translated">这里有<em class="ni"> devcontainer.json </em>选项的完整列表<a class="ae jx" href="https://code.visualstudio.com/docs/remote/devcontainerjson-reference" rel="noopener ugc nofollow" target="_blank">。</a></p></div><div class="ab cl ld le gq lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="hc hd he hf hg"><h1 id="28c7" class="lk ll hj bd lm ln lo lp lq lr ls lt lu iy lv iz lw jb lx jc ly je lz jf ma mb bi translated">演示视频</h1><p id="826a" class="pw-post-body-paragraph jy jz hj ka b kb mc it kd ke md iw kg kh me kj kk kl mf kn ko kp mg kr ks kt hc bi translated">下面的2分钟演示展示了我们的dev容器的运行——从<em class="ni"> git克隆</em>到在本地Kubernetes集群上运行定制控制器只需几分钟。</p><figure class="ji jj jk jl fe jm"><div class="bz dz l di"><div class="nl nk l"/></div><figcaption class="jt ju eu es et jv jw bd b be z dy">Development Containers Demo</figcaption></figure></div><div class="ab cl ld le gq lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="hc hd he hf hg"><h1 id="9332" class="lk ll hj bd lm ln lo lp lq lr ls lt lu iy lv iz lw jb lx jc ly je lz jf ma mb bi translated">结束语</h1><p id="fc0f" class="pw-post-body-paragraph jy jz hj ka b kb mc it kd ke md iw kg kh me kj kk kl mf kn ko kp mg kr ks kt hc bi translated">在本文中，我们看到了如何构建一个dev容器。对于本教程，我使用了Docker和VS代码来构建dev容器，但是其他一些框架和工具也可以用于此目的。例如，一个有趣的替代品可能是CNCF的<a class="ae jx" href="https://cnab.io/" rel="noopener ugc nofollow" target="_blank"> CNAB </a>，它带有一个独立的CLI工具。</p><p id="270d" class="pw-post-body-paragraph jy jz hj ka b kb kc it kd ke kf iw kg kh ki kj kk kl km kn ko kp kq kr ks kt hc bi translated">一般来说，如果您有一些容器方面的经验，那么从dev容器开始并不奇怪。正如我们所看到的，它归结为声明一个<em class="ni"> Dockerfile </em>(也有许多很棒的预烘焙容器映像)，配置一个<em class="ni"> devcontainer.json，</em>，并可能添加一些定制脚本，例如，如果需要的话配置网络。就是这样！现在，任何人都可以在几分钟内开始为我们的项目做出贡献。</p><p id="009a" class="pw-post-body-paragraph jy jz hj ka b kb kc it kd ke kf iw kg kh ki kj kk kl km kn ko kp kq kr ks kt hc bi translated">在第2部分中，我将展示如何构建一个CLI工具，并讨论为什么以及如何将它与开发容器结合起来。</p><p id="3fa4" class="pw-post-body-paragraph jy jz hj ka b kb kc it kd ke kf iw kg kh ki kj kk kl km kn ko kp kq kr ks kt hc bi translated">你可以在我之前的文章中读到更多关于开发容器的好处和挑战:<em class="ni"/><a class="ae jx" href="https://stefannastic.medium.com/why-every-open-source-project-needs-a-development-container-b1f5180ad5aa" rel="noopener"><em class="ni">为什么每个开源项目都需要一个开发容器？</em></a><em class="ni"/>。</p><div class="nm nn fa fc no np"><a href="https://stefannastic.medium.com/why-every-open-source-project-needs-a-development-container-b1f5180ad5aa" rel="noopener follow" target="_blank"><div class="nq ab dx"><div class="nr ab ns cl cj nt"><h2 class="bd ht fj z dz nu eb ec nv ee eg hs bi translated">为什么每个开源项目都需要一个开发容器？</h2><div class="nw l"><h3 class="bd b fj z dz nu eb ec nv ee eg dy translated">以及为什么你也应该建立一个…</h3></div><div class="nx l"><p class="bd b fq z dz nu eb ec nv ee eg dy translated">stefannastic.medium.com</p></div></div><div class="ny l"><div class="nz l oa ob oc ny od jr np"/></div></div></a></div><p id="36a7" class="pw-post-body-paragraph jy jz hj ka b kb kc it kd ke kf iw kg kh ki kj kk kl km kn ko kp kq kr ks kt hc bi translated">如果你想了解更多关于我们的北极星SLO云项目，<a class="ae jx" href="https://github.com/SLOCloud/SLOC" rel="noopener ugc nofollow" target="_blank">查看我们的GitHub </a>或者关注我的更新。</p></div></div>    
</body>
</html>