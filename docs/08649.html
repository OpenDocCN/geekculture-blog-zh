<html>
<head>
<title>Uploading to AWS S3 via AWS SDK version 2 and version 3 from Express</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过AWS SDK版本2和版本3从Express上传到AWS S3</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/uploading-to-aws-s3-via-aws-sdk-version-2-and-version-3-from-express-38927787b705?source=collection_archive---------1-----------------------#2021-11-09">https://medium.com/geekculture/uploading-to-aws-s3-via-aws-sdk-version-2-and-version-3-from-express-38927787b705?source=collection_archive---------1-----------------------#2021-11-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="6226" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有3种方式与AWS交互</p><p id="5934" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">1.通过AWS控制台</p><p id="2736" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.通过AWS cli</p><p id="885f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.通过SDK</p><p id="1e00" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这篇文章解释了如何通过SDK从express JS上传对象到S3桶。AWS SDK for javascript有两个版本，版本2和版本3。</p><p id="3d2b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第二版</strong></p><p id="f219" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">设置express服务器后，您将需要安装“aws-sdk”软件包以使用版本2 SDK。要安装它，只需运行“<em class="jd"> npm install aws-sdk </em>”。</p><p id="bd16" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">安装后，创建一个文件，这个文件将存放SDK的配置。</p><p id="1cc4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先在该文件中引入AWS包，然后通过调用AWS.config.update()更新凭证。这个函数调用接受一个对象<em class="jd"> {region，credentials: {accessKeyId，secreteAccessKey}} </em></p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/28afe43b78599304667ff224d26080ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mXYADN19iwx-wezHd-ZQpA.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx">This is what you are expected to have</figcaption></figure><blockquote class="ju jv jw"><p id="0174" class="if ig jd ih b ii ij ik il im in io ip jx ir is it jy iv iw ix jz iz ja jb jc hb bi translated">注意:文件将作为表格数据发送到express。Express本身不能处理表单数据，而是必须安装一个“multer”包来启用express处理表单数据。然后，通过创建一个const upload= multer({})来初始化multer，这应该在索引文件的全局环境中完成，即不在任何路径中。</p></blockquote><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es ka"><img src="../Images/7e01c0d79e7b963da3891c568f6e5fa8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uV0JB_X-yh6YYkGyWbRcBQ.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx">multer is initialized</figcaption></figure><p id="58ac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">之后，导出已配置的AWS对象。创建一个index.js文件，导入上面导入的aws配置，正常设置express server，然后创建一个route，在这个route中你要利用multer提供的中间件来处理文件。定义路由后，调用upload.single('file ')。传递到single中的“file”是我们期望文件在表单中出现的字段的名称。因此，基本上,“文件”可以被重命名为任何名称，只要它与我们期望的表单数据中的文件字段相同。</p><p id="16dd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在快速路由回调函数中，创建一个新的const(姑且称之为AwsUploadClient)并调用对象构造函数ConfiguredAws。S3({})</p><p id="8aad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建一个有3个条目的新对象</p><blockquote class="ju jv jw"><p id="0e82" class="if ig jd ih b ii ij ik il im in io ip jx ir is it jy iv iw ix jz iz ja jb jc hb bi translated">let upload params = { Key:req . file . original name，Bucket: 'Abucket '，Body: req.file.buffer }</p><p id="d558" class="if ig jd ih b ii ij ik il im in io ip jx ir is it jy iv iw ix jz iz ja jb jc hb bi translated">注意:req.file.originalname和req.file.buffer是multer中间件提供给我们的。</p></blockquote><p id="a904" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们将上面定义的AwsUploadClient常量称为AwsUploadClient.upload()，</p><p id="0db0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">传入上传函数的第一个参数是上面定义的对象，第二个参数是接受错误和响应的回调函数。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es kb"><img src="../Images/21a8f17ea8cf84fe769304bc88608f2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gMbFJwz7QlJlBB9Dc9BcuA.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx">callback function of the express route</figcaption></figure><p id="f593" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就是回调的样子，当然当你得到一个响应或者一个错误时，你可以做任何你想做的事情。</p><blockquote class="ju jv jw"><p id="d97f" class="if ig jd ih b ii ij ik il im in io ip jx ir is it jy iv iw ix jz iz ja jb jc hb bi translated">注意:版本2 SDK不支持承诺，因此您必须利用传统的回调</p></blockquote><p id="9225" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第三版</strong></p><p id="37f2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于版本3 SDK，您还必须通过aws安装一个包。在命令提示符下，您输入“npm i @aws-sdk/client-s3”</p><p id="7e10" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在如上所示的安装过程之后，您创建了一个awsClient.js文件。V3 sdk的配置略有不同。与其直接配置AWS凭证，不如调用AWS。S3Client({})，这将返回一个新对象，因为它是一个构造函数。在对象中传递给S3Client一个单独的对象，该对象将包含；1)将具有accessKeyId、secretAccessKey和region的凭证对象</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es kc"><img src="../Images/5930a36f18d8a5fc957699efc92cb99d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iSin0d25rlydYPJCK9buEQ.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx">config for v3 sdk</figcaption></figure><p id="d4f2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后导出S3实例</p><p id="fe7c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意:在这一点上，你应该有multer，express和一个路由设置。有关这方面的更多信息，请参考上文。</p><p id="e4f1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">还要在索引文件中导入导出的s3Instance。如上所述，创建一个uploadparams对象，它将包含3个条目:</p><p id="5699" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">1)密钥:这是密钥，即在你的对象中的文件上的文件名。我们可以使用req . file . origin name，这是由multer中间件提供的。</p><p id="9f82" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2)存储桶:要上传到的存储桶</p><p id="0a8e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3) Body:这是你要上传的文件的缓冲区。在这种情况下，该文件将在req.file.buffer上可用</p><p id="8fb6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后创建所谓的命令。要创建它，您必须从原始的“@aws-sdk/client-s3”引入“PutObjectCommand()”构造器，因此我们必须在索引文件中导入“@aws-sdk/client-s3”。uploadparams也被传递到PutObjectCommand中。</p><p id="ec55" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于版本3支持承诺，我们等待对s3Instance.send(从awsClient文件导入的s3Instance)的调用，然后传递给函数call命令</p><p id="5137" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，你的路线应该是这样的</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es kd"><img src="../Images/75be5e7d4b90801efea36ad89cf1f6d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1396/format:webp/1*hMXk_NnCOixGu0EoaUCITA.png"/></div></figure><p id="ed7a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过这种设置，您可以使用postman测试端点，方法是发送一个post请求，其中包含表单数据，预期字段包含multer.single中的文件(“文件”)。</p><p id="d621" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以观看youtube上的视频来了解这一点；</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="ke kf l"/></div></figure></div></div>    
</body>
</html>