<html>
<head>
<title>Employing R to Serve Excel Spreadsheet: Pivot Table Generation, Multiple Worksheets Creation, and Graph Insertion</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用R服务Excel电子表格:数据透视表生成、多工作表创建和图形插入</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/employing-r-to-serve-excel-spreadsheet-pivot-table-generation-multiple-worksheets-creation-and-6a01751dd767?source=collection_archive---------12-----------------------#2021-04-26">https://medium.com/geekculture/employing-r-to-serve-excel-spreadsheet-pivot-table-generation-multiple-worksheets-creation-and-6a01751dd767?source=collection_archive---------12-----------------------#2021-04-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/66c9c77a2753ebd07dfef1c99727c058.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GnSuGeV2p82SJQmLWfAqDg.jpeg"/></div></div></figure><p id="8bcb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">r用户仍在使用Excel，尤其是在与只依赖Excel的人一起工作时。在许多组织中，将R生成的分析结果共享到Excel是一项常见的任务。因此，非常需要在R和Excel之间建立一个方便、通用的通道。下面是如何建立这样一个通道。</p><p id="0bae" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">尽管R允许将结果导出为Excel可以打开的csv格式，但仍然存在几个主要挑战。首先，您只能在csv文件中插入一张工作表，不能更多。第二，所有非标准字符(例如中文或日文)都不能正确显示，因为csv文件不能处理Unicode/UTF-8。第三，图形不能导出为csv文件。</p><p id="ffcd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一些R包允许导出到Excel文件，但是它们需要安装Java，这造成了额外的障碍。我亲眼目睹有人在他的系统上安装Java失败，结果他不得不更换电脑。</p><p id="3ee9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">感谢openxlsx的开发者，对于在R和Excel之间工作的人来说，上面提到的三个挑战现在都没有了。Java也不需要。下面我使用ggplot2包中提供的著名的免费钻石数据来说明我在标题中承诺的内容:数据透视表生成、多个工作表创建和图形插入。</p><p id="2c00" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于那些不熟悉钻石数据的人来说:该数据集存储了超过5万颗钻石的信息，包括三个分类变量格式的特征，切割、净度和颜色，以及两个数字部分，克拉和价格。</p><p id="71c2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们可以选择任意两个分类特征，比如切割和净度，来创建一个数据透视表，显示切割和净度组合下的平均价格或宝石大小。这项工作是不容易的Excel作为VBA是必需的。但是在R中，借助管道操作(%&gt;%)分两行完成。</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="3b07" class="jx jy hi jt b fi jz ka l kb kc"><strong class="jt hj">require</strong>(ggplot2)<br/><strong class="jt hj">require</strong>(dplyr)<br/>diamonds %&gt;% group_by(cut,<!-- -->color<!-- -->) %&gt;% summarize(<!-- -->mean.value<!-- -->=mean(price)) %&gt;% spread(<!-- -->cut<!-- -->,<!-- -->mean.value<!-- -->)</span></pre><p id="05c3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于所选的汇总统计数据，均值函数可以替换为其他函数，即中值函数、总和函数、计数函数和标准差函数。</p><p id="0b03" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">以下是截色平均价格的结果。我们创建了一个漂亮的表格，总结了每种切割和颜色组合的平均价格。我想将这样的表格导出为电子表格。</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="5b71" class="jx jy hi jt b fi jz ka l kb kc">## # A tibble: 7 x 6<br/>##   color  Fair  Good `Very Good` Premium Ideal<br/>##   &lt;ord&gt; &lt;dbl&gt; &lt;dbl&gt;       &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;<br/>## 1 D     4291. 3405.       3470.   3631. 2629.<br/>## 2 E     3682. 3424.       3215.   3539. 2598.<br/>## 3 F     3827. 3496.       3779.   4325. 3375.<br/>## 4 G     4239. 4123.       3873.   4501. 3721.<br/>## 5 H     5136. 4276.       4535.   5217. 3889.<br/>## 6 I     4685. 5079.       5256.   5946. 4452.<br/>## 7 J     4976. 4574.       5104.   6295. 4918.</span></pre><p id="695a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要导出结果，您必须先保存结果。你需要把它赋给一个数据帧；称之为表1。</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="a438" class="jx jy hi jt b fi jz ka l kb kc">table1= diamonds %&gt;% group_by(cut,<!-- -->color<!-- -->) %&gt;% summarize(<!-- -->mean.value<!-- -->=mean(price)) %&gt;% spread(cut,mean.<!-- -->value<!-- -->)</span></pre><p id="c346" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要创建更多类似上面的表格，我们可以使用不同的菱形功能重复该命令。</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="09f6" class="jx jy hi jt b fi jz ka l kb kc">table2= diamonds %&gt;% group_by(<!-- -->clarity<!-- -->,cut) %&gt;% summarize(<!-- -->mean.value<!-- -->=mean(carat)) %&gt;% spread(clarity,<!-- -->mean.value<!-- -->)</span></pre><p id="43f7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">但是考虑到表创建的重复性，让我们编写一个函数来完成这项工作；称之为excel.func。</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="a50b" class="jx jy hi jt b fi jz ka l kb kc">excel.func=function(x,y,z){<br/>diamonds %&gt;% group_by({{x}},{{y}}) %&gt;% summarize(mean.value=mean({{z}})) %&gt;% spread({{x}},mean.value)<br/>}</span></pre><p id="5873" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请注意，要引用函数参数，应该使用{{x}}。我可能会在以后的另一篇文章中解释这一点。</p><p id="e268" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，我们应用excel.func函数为不同的切割、颜色和净度组合创建三个不同的表格，其中包含价格或克拉的平均值。</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="9a62" class="jx jy hi jt b fi jz ka l kb kc">table1=excel.func(cut,color,price)<br/>table2=excel.func(clarity,cut,carat)<br/>table3=excel.func(color,clarity,price)</span></pre><p id="82c8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来，我们使用openxlsx包将它们导出到电子表格中。</p><p id="036a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">第一个常见的场景是创建一个新的电子表格文件，将每个表写入一个单独的表中。步骤如下。</p><p id="b041" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用createWorkbook在R中创建一个Workbook对象，命名为<em class="kd"> diamond.wb </em>，并使用addWorksheet向其添加三个工作表。这三个表分别叫做我的表1到表3(你想怎么叫都行)。</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="e25d" class="jx jy hi jt b fi jz ka l kb kc"><strong class="jt hj">require</strong>(openxlsx)<br/>diamond.wb &lt;- createWorkbook()<br/>addWorksheet(diamond.wb,"my sheet 1")<br/>addWorksheet(diamond.wb,"my sheet 2")<br/>addWorksheet(diamond.wb,"my sheet 3")</span></pre><p id="9a73" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下一步是使用writeData将data.frames(表1到表3)分别挂钩到<em class="kd"> diamond.wb、</em>中的三个表。</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="ea63" class="jx jy hi jt b fi jz ka l kb kc">writeData(diamond.wb,"my sheet 1",table1)<br/>writeData(diamond.wb,"my sheet 2",table2)<br/>writeData(diamond.wb,"my sheet 3",table3)</span></pre><p id="7e93" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用sapply可以简化上述重复性工作。那将是一个不同的话题。</p><p id="91f4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这三个表现在被保存到r中的工作簿<em class="kd"> diamond.wb </em>中。最后一步很简单:将<em class="kd"> diamond.wb </em>导出到您计算机上的Excel文件中(为了快速验证，我将其放在了F驱动器下)。</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="034f" class="jx jy hi jt b fi jz ka l kb kc">saveWorkbook(diamond.wb, file = "F:/diamonds_summary.xlsx", overwrite = TRUE)</span></pre><p id="03d6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">结果如下:</p><figure class="jo jp jq jr fd ij er es paragraph-image"><div class="er es ke"><img src="../Images/2af4fa2809ad53cd7a02ca195c3ca790.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/1*JkhOKE5PDE1qg9HrDmEaDA.png"/></div></figure><p id="cb54" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">另一种常见的情况是向现有的电子表格中添加新的表格，而不进行覆盖。</p><p id="39c4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们创建另一个切割色平均克拉表，将其命名为table4，并将其保存到“我的工作表1 ”,其中我们已经存储了表1的切割色平均价格信息。</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="1d38" class="jx jy hi jt b fi jz ka l kb kc">table4=excel.func(cut,color,carat)<br/>writeData(diamond.wb,"my sheet 1",table4,startCol = 1,startRow =11)</span></pre><p id="50ea" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请注意，在writeData函数中，我将table4的位置指定在工作表1的第11行第1列，因此它不会覆盖那里的现有信息。</p><p id="b538" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后一步是保存到同一个电子表格文件。但是在继续之前，请确保您已经关闭了打开以供查看的Excel文件。否则，保存将不起作用，也不会有错误消息提醒您。当然，您可以通过更改下面的file参数，将所有四个表格保存到一个新的Excel文件中。</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="2355" class="jx jy hi jt b fi jz ka l kb kc">saveWorkbook(diamond.wb, file = "F:/diamonds_summary.xlsx", overwrite = TRUE)</span></pre><p id="f8fc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">结果如下:</p><figure class="jo jp jq jr fd ij er es paragraph-image"><div class="er es kf"><img src="../Images/37fa05e1fb92a5870736fa9bf2b65f78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1326/format:webp/1*xLcAEtO_T94D_K8OETINgA.png"/></div></figure><p id="c047" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">openxlsx包还允许您将R中创建的图(例如，由ggplot2创建的图)导出到电子表格中。如下图所示，我使用inserPlot来完成这项工作。请注意，inserPlot将仅插入R中显示的最新绘图(可通过print函数加载)。</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="e893" class="jx jy hi jt b fi jz ka l kb kc">addWorksheet(diamond.wb,"my plot")</span><span id="5a59" class="jx jy hi jt b fi kg ka l kb kc">plot1=ggplot(diamonds)+geom_bar(aes(x=clarity,fill=color))<br/>print(plot1)</span><span id="33e0" class="jx jy hi jt b fi kg ka l kb kc">insertPlot(diamond.wb,"my plot",startCol = 3,startRow =4, width = 16, height = 10, fileType = "png", units = "cm")</span><span id="4700" class="jx jy hi jt b fi kg ka l kb kc">saveWorkbook(diamond.wb, file = "F:/diamonds_summary.xlsx", overwrite = TRUE)</span></pre><p id="fda7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">结果如下:</p><figure class="jo jp jq jr fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kh"><img src="../Images/cd762707a1efc709f52e861cc7bd80e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0RSmhdD_o7O3OxAE_igzeg.png"/></div></div></figure><p id="825f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以通过查看addWorkshee和writeData的帮助来获得关于此包的更多帮助，以自定义您的R-&gt;excel操作。</p><p id="a8e6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">感谢阅读。</p><p id="219c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="kd">本文是我的第一篇帖子。我正在分享我的商业分析学生遇到的一些常见问题的解决方案。我希望你也会发现它们是有帮助的。</em></p><p id="01b3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">领英:<a class="ae ki" href="https://www.linkedin.com/in/martin-qiu-46a583b/" rel="noopener ugc nofollow" target="_blank">https://www.linkedin.com/in/martin-qiu-46a583b/</a></p></div></div>    
</body>
</html>