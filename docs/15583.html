<html>
<head>
<title>Journey to update an outdated ejected Expo React Native project</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">更新过时的被驱逐的世博会反应原生项目之旅</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/journey-to-update-an-outdated-ejected-expo-react-native-project-9f808134bf13?source=collection_archive---------7-----------------------#2022-11-09">https://medium.com/geekculture/journey-to-update-an-outdated-ejected-expo-react-native-project-9f808134bf13?source=collection_archive---------7-----------------------#2022-11-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="c812" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">背景</h1><p id="7a0b" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">有一个我正在做的反应性本地项目，如下所示:</p><ol class=""><li id="a093" class="kb kc hi jf b jg kd jk ke jo kf js kg jw kh ka ki kj kk kl bi translated">自然反应0.67</li><li id="de56" class="kb kc hi jf b jg km jk kn jo ko js kp jw kq ka ki kj kk kl bi translated">(弹出)世园会SDK 40</li><li id="a0de" class="kb kc hi jf b jg km jk kn jo ko js kp jw kq ka ki kj kk kl bi translated">反应16.13.1</li><li id="4da3" class="kb kc hi jf b jg km jk kn jo ko js kp jw kq ka ki kj kk kl bi translated">瞄准Android SDK 30</li><li id="90fd" class="kb kc hi jf b jg km jk kn jo ko js kp jw kq ka ki kj kk kl bi translated">瞄准iOS 11</li></ol><p id="c6ea" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">弹出的expo加上旧的react原生包引入了一些问题，比如新的包会与旧的版本冲突，因此构建会失败。</p><p id="1fd7" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">还有一些次要问题，那就是react-native-uni module和expo模块之间的冲突。</p><h1 id="ed6d" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">方法</h1><h2 id="ba88" class="ku ig hi bd ih kv kw kx il ky kz la ip jo lb lc it js ld le ix jw lf lg jb lh bi translated">更清洁的方法(我相信)</h2><p id="67a8" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">即使有一个退出的博览会项目，一篇文章建议删除“ios”和“android”文件夹，升级博览会，然后再次退出，然后跟进</p><p id="57f7" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">我相信，这将使博览会能够解决之前手动引入的所有问题，并遵循最佳实践。</p><p id="6f2a" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">顺便说一下，expo有模板来帮助理解他们的<a class="ae li" href="https://github.com/expo/expo/tree/main/templates" rel="noopener ugc nofollow" target="_blank"> git repo </a>中的预期工作“ios”和“android”文件夹(作为样板),这实际上在整个旅程中对我帮助很大。</p><h2 id="cde6" class="ku ig hi bd ih kv kw kx il ky kz la ip jo lb lc it js ld le ix jw lf lg jb lh bi translated">为什么不采取更干净的方法(对我来说)？</h2><p id="9bf2" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我看到有一些自定义模块引入了对app build.gradle的编辑，以包括一些额外的自定义Java模块以及初始化和注册，通过使用更简洁的方法，可能会破坏或丢失这些代码(我对此并不了解)。</p><h1 id="49c2" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">任务和问题</h1><h2 id="15c0" class="ku ig hi bd ih kv kw kx il ky kz la ip jo lb lc it js ld le ix jw lf lg jb lh bi translated">去除反应-天然-单模块</h2><p id="cb9b" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">即使我们退出了expo，我们的项目中也使用了相当多的expo包，所以仍然会有对expo模块的引用(从Expo SDK43开始，它正在取代react-native-unimodules )?) )，所以我决定一劳永逸地摆脱反应原生单模块。</p><p id="4443" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">任务不知何故是直截了当的，我按照世博会的<a class="ae li" href="https://docs.expo.dev/bare/installing-expo-modules" rel="noopener ugc nofollow" target="_blank">文件如下:</a></p><figure class="lk ll lm ln fd lo er es paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="er es lj"><img src="../Images/3acf4c5b7cd8a828849d280f4708d120.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y8XxiMX4RinBmbDbrnjK6g.png"/></div></div><figcaption class="lv lw et er es lx ly bd b be z dx">follow this link and land at <a class="ae li" href="https://github.com/expo/fyi/blob/main/expo-modules-migration.md" rel="noopener ugc nofollow" target="_blank">https://github.com/expo/fyi/blob/main/expo-modules-migration.md</a></figcaption></figure><figure class="lk ll lm ln fd lo er es paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="er es lz"><img src="../Images/894858b899300802d7c9ccb878d32844.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eXQaUZkTRPEmonSLyhABvQ.png"/></div></div></figure><figure class="lk ll lm ln fd lo er es paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="er es ma"><img src="../Images/0da6542fca5c122b9dcfcadac6a22597.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vepm0fgLkU3XKNQChqCEig.png"/></div></div><figcaption class="lv lw et er es lx ly bd b be z dx">They have steps to edit which file and expected changes</figcaption></figure><p id="e960" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">请注意，上面的文章假设移除了expo-updates包，这对我来说是有意义的，因为我正在退出expo，所以没有必要通过expo-updates更新应用程序(到expo应用程序)。</p><h2 id="29ca" class="ku ig hi bd ih kv kw kx il ky kz la ip jo lb lc it js ld le ix jw lf lg jb lh bi translated">包装升级(使用纱线)</h2><p id="ce39" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">这应该是直截了当的，但是我采取了谨慎的方式来检查是否有任何突破性的变化，比如关于包版本的API变化(例如，react-native-resimated)</p><p id="8878" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated"><strong class="jf hj">问题:得到“任务:Expo-modules-core:configurecmakdebug[arm 64-v8a]FAILED”</strong></p><p id="c770" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">它抱怨fbjni没有兼容库，并显示错误消息“用户正在使用静态STL购买库需要共享STL”</p><p id="1558" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">与下面Expo上的这个<a class="ae li" href="https://github.com/expo/expo/issues/19643" rel="noopener ugc nofollow" target="_blank">问题</a>完全相同的错误(这个问题的解决方案是重建不适合我的环境，另一个提到的<a class="ae li" href="https://github.com/expo/expo/issues/18473" rel="noopener ugc nofollow" target="_blank">问题</a>也不适合我的情况)</p><figure class="lk ll lm ln fd lo er es paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="er es mb"><img src="../Images/050106a992ee3422f155468c2eef61e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kS_ZV4jvYhZjAVAs6Gx4Jw.png"/></div></div></figure><p id="c3d3" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">我尝试更新的东西有几个:app build.gradle(参考<a class="ae li" href="https://github.com/facebookincubator/fbjni/issues/50" rel="noopener ugc nofollow" target="_blank">这个</a>)</p><ol class=""><li id="e2f3" class="kb kc hi jf b jg kd jk ke jo kf js kg jw kh ka ki kj kk kl bi translated">include externalnativebuild . cmake . arguments(包括-DANDROID_STL=c++_shared)配置</li><li id="b9d9" class="kb kc hi jf b jg km jk kn jo ko js kp jw kq ka ki kj kk kl bi translated">add Android . build feature . prefab = true</li><li id="ed18" class="kb kc hi jf b jg km jk kn jo ko js kp jw kq ka ki kj kk kl bi translated">使用NDK建立和设置类似的STL设置</li></ol><p id="d680" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">由于配置试图使用prefab来打包fbjni，而cmake配置位于expo-core-modules中(在node_modules内部),所以上面的方法不起作用，所以我也试图在expo-core-modules中添加externalnativebuild . cmake . arguments，但仍然不起作用。</p><p id="5289" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">我检查了expo-core-modules的cmake.txt已经明确地将stl设置为使用c++_shared，但是expo-core-modules的build文件夹中生成的“prefab_command”仍然将STL设置为c++static。</p><p id="5276" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated"><strong class="jf hj"> <em class="mc">解</em> </strong></p><p id="059e" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">我的解决方案是将世博核心模块从0.11.8(由世博SDK 46作为对等依赖项安装)升级到世博核心模块^1.0.0，这样就不需要进行上述所有“不起作用”的更改，问题也就解决了。</p><p id="1e16" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">请注意，因为Expo SDK 46相关模块(如expokeepalive、expolineargradient、exp localization……)针对的是iOS 12，而expo-core-modules ^1.0.0针对的是iOS13，所以在构建时会有错误。解决方案是转到XCode，在左侧面板Pods &gt; DevelopmentPods组，本地投诉的Pods，打开他们的podspec文件，将目标iOS更新到13，然后进入终端并执行“pod安装”，清理构建和重建，这样就可以工作了。</p><h1 id="9eb6" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">什么没有被改变</h1><p id="c377" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">以下是我没有尝试过的一些事情:</p><p id="f9c8" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">使用世博新架构——因为我们正在开发世博工作流程，所以我不会花时间在这上面</p><p id="76a5" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">使用hermes引擎——这一个被跳过，只是因为在某些时候有一些参考说移除hermes将修复一些问题，并且我不敢回去启用hermes，当事情目前工作正常时。</p><h1 id="faee" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">结论</h1><p id="2f09" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我开始重新考虑react native和Flutter这种一次编写并应用多个平台的方式。</p><p id="8098" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">我仍然喜欢React Native，我喜欢它允许我快速制作原型，但是在某些时候(在我的项目中)，当引入新的包时，我面临的包冲突几乎会时有发生。</p><p id="059b" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">此外，从这次练习中，我学到了很多关于iOS和Android的Gradle设置、部署和打包的知识，我希望它能帮助我在将来排除故障(本机或React本机应用程序)。</p></div></div>    
</body>
</html>