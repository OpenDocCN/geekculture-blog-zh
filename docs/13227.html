<html>
<head>
<title>Back to Basics: Kubernetes Admission Webhooks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">回归基础:Kubernetes入学网挂钩</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/back-to-basics-kubernetes-admission-webhooks-dbf6baffb0f1?source=collection_archive---------3-----------------------#2022-06-27">https://medium.com/geekculture/back-to-basics-kubernetes-admission-webhooks-dbf6baffb0f1?source=collection_archive---------3-----------------------#2022-06-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/c264550265cad5f6f36d2728dcbe36d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*H4ttE1BQTVHNfi2v"/></div></div><figcaption class="iq ir et er es is it bd b be z dx"><a class="ae iu" href="https://unsplash.com/photos/EgtKWM2sNJw" rel="noopener ugc nofollow" target="_blank">Photo</a> by<a class="ae iu" href="https://unsplash.com/@haseebm?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Haseeb Modi</a> on Unsplash</figcaption></figure><p id="32f8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Kubernetes的集装箱服务环境是广泛的。但是，有时需要额外的配置来全面优化基础架构。一些管理员需要准入webhooks提供的可定制性。在这篇文章中，你将了解Kubernetes入学网页挂钩，如何使用它们，以及何时应该使用它们。</p><h1 id="642d" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">入场网钩</h1><figure class="kr ks kt ku fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/8dfc7cc1f557cd172760b98772c8e225.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fouJ_NzQwxToev-h"/></div></div><figcaption class="iq ir et er es is it bd b be z dx"><a class="ae iu" href="https://www.digihunch.com/2022/01/kubernetes-admission-control/" rel="noopener ugc nofollow" target="_blank">Source</a></figcaption></figure><p id="e50c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Webhooks是一种可以验证或更改对象的定制控制器。准入webhooks是HTTP回调，当发出请求时被触发。当在某些Kubernetes资源上执行某些操作时，可以配置Kubernetes中间件来联系服务。这些插件最终控制集群并决定Kubernetes如何使用它们。webhook可以检查新创建的pod，并采取三种操作之一:允许请求、拒绝请求或通过返回变异或更改的版本来修改它。</p><p id="0770" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://www.armosec.io/blog/kubernetes-admission-controller/" rel="noopener ugc nofollow" target="_blank"> Kubernetes准入控制器</a>是一个代码块，它在对象被持久化之前，但在用户被认证和授权之后，拦截对Kubernetes API的请求。</p><p id="fe6a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在Kubernetes中，控制器和webhooks是分开存在的。控制器被编译成Kubernetes <em class="kv"> apiserver </em>二进制文件，只能由集群管理员提供。Webhooks在API中被适当地配置，因为它们直接影响HTTP活动。Webhooks还可以在任何语言或框架中进行简单的适应性编码，允许Kubernetes准入控制器与任何第三方代码集成。</p><p id="b6f0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">准入控制器有能力验证或变异，或做两者的结合。与请求验证控制器相关联的对象不能被它们改变，但是它们可以通过改变控制器来改变。</p><h1 id="a121" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">配置Kubernetes许可网页挂钩</h1><figure class="kr ks kt ku fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kw"><img src="../Images/0c6fb21272e068ac928c3c5c62dfde00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CJ27kFMU4I42BoZB"/></div></div><figcaption class="iq ir et er es is it bd b be z dx"><a class="ae iu" href="https://trstringer.com/kubernetes-mutating-webhook/" rel="noopener ugc nofollow" target="_blank">Source</a></figcaption></figure><p id="f8c3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在配置准入webhook时，要记住的事情包括:检查集群中是否允许准入web hook控制器，如果允许，则配置它们。可以编写一个处理接纳请求的<a class="ae iu" href="https://askmelot.com/what-is-http-callback" rel="noopener ugc nofollow" target="_blank"> HTTP回调</a>(这可以是一个部署到集群的简单HTTP服务器或者一个无服务器函数)。通过ValidatingWebhookConfiguration和MutatingWebhookConfiguration资源配置准入webhook。</p><p id="8868" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在各种情况下，webhooks可以用来为集群管理员的资源准入创建配置。管理员可能面临的情况包括使用RBAC策略、自定义已创建或已修改的资源限制、未经授权的人员无法添加或删除资源、边车容器注入以实现更多日志记录，以及测量和流量控制器。</p><p id="ad8e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你也可以选择允许你的准入网页挂钩返回警告信息。警告代码299可以被编程为出现在给请求服务器的警告报头中。可以根据请求是被接受还是被拒绝来发送警告和响应。</p><p id="f951" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在配置消息时，您必须记住的是:( a)您的消息中不得有前缀“warning ”,( b)您的警告响应中的字符数不得超过120个，这些字符应该解释发出API请求的服务器应该避免或纠正的问题。</p><h1 id="c1bd" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">Kubernetes Apiserver身份验证</h1><p id="d730" class="pw-post-body-paragraph iv iw hi ix b iy kx ja jb jc ky je jf jg kz ji jj jk la jm jn jo lb jq jr js hb bi translated">如果您的准入web挂钩需要认证，您可以定制<em class="kv"> apiserver </em>来利用基本认证、令牌或证书来连接web挂钩。</p><p id="5533" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">完成配置的步骤包括以下内容。</p><p id="81cf" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当启动<em class="kv"> apiserver </em>时，使用—准入控制配置文件标志来指定准入控制配置文件的位置。指示MutatingAdmissionWebhook和ValidatingAdmissionWebhook控制器应在准入控制配置文件中的何处读取凭据。该字段的名称称为kubeConfigFile，因为详细信息存储在kubeConfig文件中。最后，在kubeConfig文件中输入凭证。</p><p id="fd6d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果我们最近创建的webhook配置不支持任何可以被<em class="kv"> apiserver </em>使用的AdmissionReview版本，那么只有第一个版本被发送。并且，对webhook的尝试调用失败，并且受制于失败策略。</p><p id="015e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一旦<em class="kv"> apiserver </em>决定了一个请求应该被路由到webhook，它必须决定如何到达webhook。这需要包含在webhook配置的<em class="kv"> clientConfig </em>节中。Webhooks可以通过一个URL或一个服务引用来访问，如果需要的话，它们可以包含一个用于<a class="ae iu" href="https://support.google.com/a/answer/100181?hl=en#:~:text=Transport%20Layer%20Security%20(TLS)%20is,now%20uses%20TLS%20for%20encryption." rel="noopener ugc nofollow" target="_blank"> TLS连接</a>验证的定制CA包。</p><p id="544d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在生产集群中，正确管理您的TLS证书，尤其是私钥是非常重要的，因此您可能希望使用cert-manager或将您的密钥存储在保险库中，而不是作为普通的Kubernetes秘密。要记住的最重要的事情是在webhook配置中包含相应的<a class="ae iu" href="https://www.namecheap.com/support/knowledgebase/article.aspx/986/69/what-is-ca-bundle/" rel="noopener ugc nofollow" target="_blank"> CA证书</a>，以便<em class="kv"> apiserver </em>知道它应该接受它。</p><h1 id="993b" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">结论</h1><p id="116e" class="pw-post-body-paragraph iv iw hi ix b iy kx ja jb jc ky je jf jg kz ji jj jk la jm jn jo lb jq jr js hb bi translated">准入webhooks为集群管理员提供了一些实施集群安全策略所需的工具。已经向您介绍了Kubernetes的一些基本特性和一些高级特性，比如准入webhooks以及准入控制器如何实现它们。准入控制是保护Kubernetes集群的一个重要工具，如果您处理集群，那么您的工具箱中应该有这个工具。</p></div></div>    
</body>
</html>