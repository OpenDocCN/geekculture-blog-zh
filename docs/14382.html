<html>
<head>
<title>Running Terraform via AWS Developer Tools — Complete CI/CD Guide</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过AWS开发人员工具运行Terraform完整的CI/CD指南</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/running-terraform-via-aws-developer-tools-complete-ci-cd-guide-438cd2be514e?source=collection_archive---------0-----------------------#2022-08-30">https://medium.com/geekculture/running-terraform-via-aws-developer-tools-complete-ci-cd-guide-438cd2be514e?source=collection_archive---------0-----------------------#2022-08-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/f882293274eb605c8fa0b9c0b1345f6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*Oe0NmAbhjmx4OMR614AcWA.gif"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">Created by Raktim using Canva</figcaption></figure><div class=""/><div class=""><h2 id="2caa" class="pw-subtitle-paragraph iu hw hx bd b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl dx translated">了解在AWS CodeCommit中存储Terraform代码的完整流程&amp;使用CodePipeline在CodeBuild中部署该代码，以便在AWS上提供资源。</h2></div><p id="16af" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">在从事各种DevOps项目之后，我注意到CI/CD可以使用不同的服务以多种方式实现，如GitLab、Jenkins、Azure DevOps等。但是AWS Developer Tools与其他AWS服务有一些惊人的集成，这使得CI/CD更加有效。让我们更深入地了解一些AWS开发人员工具服务&amp;然后实施一个真实的工业项目，使用这些令人惊叹的技术学习CI/CD。</p><h1 id="4286" class="ki kj hx bd kk kl km kn ko kp kq kr ks jd kt je ku jg kv jh kw jj kx jk ky kz bi translated">什么是AWS开发者工具？</h1><figure class="lb lc ld le fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es la"><img src="../Images/9f3010e4a490708aa3bef28f72f9231d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*1Y6k6qc_ZrRrY8qQ.jpg"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">Source: Internet</figcaption></figure><p id="c42f" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated"><strong class="jo hy">这是一组服务，主要由DevOps专业人员用来自动化应用程序的持续集成&amp;持续部署。</strong>AWS code commit、CodeBuild、CodeDeploy、CodePipeline等服务。可用于不同的场景，例如构建完整的工作流、测试&amp;部署应用程序代码、运行代码以供应基础架构等。</p><blockquote class="lf lg lh"><p id="4354" class="jm jn li jo b jp jq iy jr js jt jb ju lj jw jx jy lk ka kb kc ll ke kf kg kh hb bi translated"><strong class="jo hy">了解更多:</strong><a class="ae lm" href="https://docs.aws.amazon.com/whitepapers/latest/aws-overview/developer-tools.html" rel="noopener ugc nofollow" target="_blank"><strong class="jo hy">https://docs . AWS . Amazon . com/whites/latest/AWS-overview/developer-tools . html</strong></a></p></blockquote><h1 id="d9ed" class="ki kj hx bd kk kl km kn ko kp kq kr ks jd kt je ku jg kv jh kw jj kx jk ky kz bi translated">代码提交简介:</h1><figure class="lb lc ld le fd hk er es paragraph-image"><div class="er es ln"><img src="../Images/6cf5b9a9b43713e5af23cdf1900dffde.png" data-original-src="https://miro.medium.com/v2/resize:fit:1350/format:webp/1*eURZFkX0BYGsBaO9mFHOTg.png"/></div><figcaption class="hr hs et er es ht hu bd b be z dx">Source: Internet</figcaption></figure><p id="90af" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated"><strong class="jo hy">简单来说，这是一个类似GitHub的云托管&amp;托管版本控制系统。</strong>如今GitHub是最流行的代码维护平台。但是如果你想要一个私有的代码库，在那里你可以实现各种各样的AWS安全特性&amp;可以与其他AWS服务无缝集成，那么更好的选择是使用AWS CodeCommit。一旦我们开始实践，你会发现在AWS CodeCommit上工作非常容易。</p><blockquote class="lf lg lh"><p id="758a" class="jm jn li jo b jp jq iy jr js jt jb ju lj jw jx jy lk ka kb kc ll ke kf kg kh hb bi translated"><strong class="jo hy">官方文档页面:</strong><a class="ae lm" href="https://docs.aws.amazon.com/codecommit/latest/userguide/welcome.html" rel="noopener ugc nofollow" target="_blank"><strong class="jo hy">https://docs . AWS . Amazon . com/code commit/latest/user guide/welcome . html</strong></a></p></blockquote><h1 id="24b1" class="ki kj hx bd kk kl km kn ko kp kq kr ks jd kt je ku jg kv jh kw jj kx jk ky kz bi translated">代码构建简介:</h1><figure class="lb lc ld le fd hk er es paragraph-image"><div class="er es ln"><img src="../Images/9f4b5459276d9b05d4650bc3dd02bb52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1350/format:webp/1*Qrsq47Z670uWAEx4-CZrrQ.png"/></div><figcaption class="hr hs et er es ht hu bd b be z dx">Source: Internet</figcaption></figure><p id="bd9e" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">您可以认为该服务执行一个独立的隔离进程，该进程可以帮助您出于各种目的运行命令——主要是编译/构建代码或运行代码。<strong class="jo hy"> CodeBuild可以提取容器映像&amp;然后它可以运行该映像来创建容器流程。</strong>您可以将CodeBuild与各种AWS服务集成，例如Elastic Container Registry，以获取您自己定制的容器映像，或者让我们说，您可以提供AWS CodeBuild必要的权限，以在CloudWatch日志中存储构建日志等。</p><blockquote class="lf lg lh"><p id="3395" class="jm jn li jo b jp jq iy jr js jt jb ju lj jw jx jy lk ka kb kc ll ke kf kg kh hb bi translated"><strong class="jo hy">官方文档页面:</strong><a class="ae lm" href="https://docs.aws.amazon.com/codebuild/latest/userguide/welcome.html" rel="noopener ugc nofollow" target="_blank"><strong class="jo hy">https://docs . AWS . Amazon . com/code build/latest/user guide/welcome . html</strong></a></p></blockquote><h1 id="9604" class="ki kj hx bd kk kl km kn ko kp kq kr ks jd kt je ku jg kv jh kw jj kx jk ky kz bi translated">简而言之，代码管道:</h1><figure class="lb lc ld le fd hk er es paragraph-image"><div class="er es ln"><img src="../Images/fd988c3d296237e04150b4dec4f6c0d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1350/format:webp/1*4cV-8wQjBkd3Qg8v91QdcQ.png"/></div><figcaption class="hr hs et er es ht hu bd b be z dx">Source: Internet</figcaption></figure><p id="9172" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">这项服务能够在管道中容纳其他服务，这样我们就可以在一个连续的流程中构建、测试和部署我们的应用程序代码。例如，CodePipeline可以从CodeCommit &amp;获取一些代码，然后它可以将这些代码发送到CodeBuild以开始构建过程。一旦构建完成，CodePipeline可以将工件&amp;存储在CodeArtifact或S3中。类似地，它可以集成其他服务，如SNS、SQS，用于发送关于管道的相关信息，甚至可以将CodePipeline与外部代码库集成，如GitHub、Big Bucket等。取出密码。</p><blockquote class="lf lg lh"><p id="1479" class="jm jn li jo b jp jq iy jr js jt jb ju lj jw jx jy lk ka kb kc ll ke kf kg kh hb bi translated"><strong class="jo hy">官方文档页面:</strong><a class="ae lm" href="https://docs.aws.amazon.com/codepipeline/latest/userguide/welcome.html" rel="noopener ugc nofollow" target="_blank"><strong class="jo hy">https://docs . AWS . Amazon . com/code pipeline/latest/user guide/welcome . html</strong></a></p></blockquote><h1 id="23a1" class="ki kj hx bd kk kl km kn ko kp kq kr ks jd kt je ku jg kv jh kw jj kx jk ky kz bi translated">问题陈述:</h1><figure class="lb lc ld le fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lo"><img src="../Images/9af3f2715d710393f84a13ca03456a20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nVjnELWrsY-KeoTT61QDNw.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">Created by Raktim using Canva</figcaption></figure><ul class=""><li id="e53a" class="lp lq hx jo b jp jq js jt jv lr jz ls kd lt kh lu lv lw lx bi translated">在CodeCommit上创建一个存储库来存储terraform代码。将CodeCommit与您的本地计算机连接，以便持续开发terraform代码。</li><li id="1d5e" class="lp lq hx jo b jp ly js lz jv ma jz mb kd mc kh lu lv lw lx bi translated">创建两个CodeBuild项目——首先运行terraform计划，然后应用更改。</li><li id="349e" class="lp lq hx jo b jp ly js lz jv ma jz mb kd mc kh lu lv lw lx bi translated">创建一个CodePipeline，它将从CodeCommit获取代码，并可以运行CodeBuild项目来部署Terraform代码。以便我们可以提供其他资源。</li><li id="f9c0" class="lp lq hx jo b jp ly js lz jv ma jz mb kd mc kh lu lv lw lx bi translated">创建必要的IAM角色和权限。还要在CloudWatch日志中存储CodeBuild过程的日志。</li></ul><p id="8121" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">听起来很有趣……让我们一步一步地解决这个问题。但在开始之前，让我告诉你一些基本要求。</p><h1 id="f4a9" class="ki kj hx bd kk kl km kn ko kp kq kr ks jd kt je ku jg kv jh kw jj kx jk ky kz bi translated">先决条件:</h1><p id="853e" class="pw-post-body-paragraph jm jn hx jo b jp md iy jr js me jb ju jv mf jx jy jz mg kb kc kd mh kf kg kh hb bi translated"><strong class="jo hy">在知识方面，你应该了解Git、Terraform、AWS IAM &amp; S3的基础知识。其余一切，我会详细讨论。当然，你需要一个AWS帐户&amp;我将从该帐户的管理员权力执行一切。</strong></p><p id="caed" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">如果你对Terraform没有基本的了解，那么请关注我下面提到的博客:</p><div class="hh hi ez fb hj mi"><a rel="noopener follow" target="_blank" href="/nerd-for-tech/getting-started-with-aws-terraform-293e9125dff"><div class="mj ab dw"><div class="mk ab ml cl cj mm"><h2 class="bd hy fi z dy mn ea eb mo ed ef hw bi translated">AWS &amp; Terraform入门。</h2><div class="mp l"><h3 class="bd b fi z dy mn ea eb mo ed ef dx translated">如何入门使用Terraform在AWS中构建基础设施？</h3></div><div class="mq l"><p class="bd b fp z dy mn ea eb mo ed ef dx translated">medium.com</p></div></div><div class="mr l"><div class="ms l mt mu mv mr mw hp mi"/></div></div></a></div><p id="9fc5" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">让我们跳进来…</p><blockquote class="lf lg lh"><p id="0fcd" class="jm jn li jo b jp jq iy jr js jt jb ju lj jw jx jy lk ka kb kc ll ke kf kg kh hb bi translated"><strong class="jo hy">注意:想法很简单。最初，我将在我的本地系统上运行Terraform，以提供CodeCommit存储库、CodePipeline中的管道、CodeBuild项目、S3 bucket &amp; IAM角色。</strong></p></blockquote><h2 id="cc9a" class="mx kj hx bd kk my mz na ko nb nc nd ks jv ne nf ku jz ng nh kw kd ni nj ky nk bi translated"><strong class="ak">本博客中指定的所有代码都可以在下面提到的GitHub资源库中找到:</strong></h2><div class="hh hi ez fb hj mi"><a href="https://github.com/raktim00/ci-cd-aws-developer-tools-tf" rel="noopener  ugc nofollow" target="_blank"><div class="mj ab dw"><div class="mk ab ml cl cj mm"><h2 class="bd hy fi z dy mn ea eb mo ed ef hw bi translated">GitHub-rak Tim 00/ci-CD-AWS-开发者-工具-tf</h2><div class="mp l"><h3 class="bd b fi z dy mn ea eb mo ed ef dx translated">使用AWS开发工具开发演示CI/CD环境的代码，以运行Terraform代码…</h3></div><div class="mq l"><p class="bd b fp z dy mn ea eb mo ed ef dx translated">github.com</p></div></div><div class="mr l"><div class="nl l mt mu mv mr mw hp mi"/></div></div></a></div><h1 id="8614" class="ki kj hx bd kk kl km kn ko kp kq kr ks jd kt je ku jg kv jh kw jj kx jk ky kz bi translated">步骤1:提供代码提交存储库和S3存储桶</h1><p id="c501" class="pw-post-body-paragraph jm jn hx jo b jp md iy jr js me jb ju jv mf jx jy jz mg kb kc kd mh kf kg kh hb bi translated">CodeCommit存储库将用于存储Terraform代码，我们将使用这些代码来提供除前面提到的资源之外的其他资源。假设您想要建立一个复杂的VPC架构。这种方法将向您展示如何创建一个CI/CD管道来运行CodeBuild中Terraform以提供VPC。</p><p id="5bf8" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated"><strong class="jo hy">我们将使用S3桶来存储后端状态文件，这样当CodeBuild运行Terraform时，它可以查看这个状态文件。</strong>起初这听起来可能有点混乱，但相信我，一旦你完成了整个设置，就不难理解了。此外，CodePipeline将使用同一个桶来存储工件。同样，当我们设置代码管道时，你会看到它是如何工作的。</p><p id="5b00" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">在您的系统中创建一个工作区文件夹，并将下面提到的代码文件放入其中。请根据您的需要更改参数。</p><figure class="lb lc ld le fd hk"><div class="bz dy l di"><div class="nm nn l"/></div></figure><figure class="lb lc ld le fd hk"><div class="bz dy l di"><div class="nm nn l"/></div></figure><figure class="lb lc ld le fd hk"><div class="bz dy l di"><div class="nm nn l"/></div></figure><ul class=""><li id="6ad8" class="lp lq hx jo b jp jq js jt jv lr jz ls kd lt kh lu lv lw lx bi translated">这些是Terraform中非常基本的文件，用于提供名为“raktim-infra-vpc-backend”的S3存储桶，并启用了私有ACL和版本控制。此外，该文件提供了一个名为“infra-vpc-repo”的CodeCommit存储库。</li><li id="99da" class="lp lq hx jo b jp ly js lz jv ma jz mb kd mc kh lu lv lw lx bi translated">我在S3桶中创建了一个空文件夹来存储Terraform的后端状态文件，它将在将来供应VPC时使用。</li></ul><blockquote class="lf lg lh"><p id="d226" class="jm jn li jo b jp jq iy jr js jt jb ju lj jw jx jy lk ka kb kc ll ke kf kg kh hb bi translated"><strong class="jo hy">注意:我使用一个带有“AdministratorAccess”的AWS IAM帐户，通过本地系统aws cli认证terraform。</strong></p></blockquote><p id="3d4d" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">首先运行“terraform init ”,然后运行“terraform apply ”,以提供S3存储区和代码提交存储库。</p><figure class="lb lc ld le fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es no"><img src="../Images/bf41a52b810a5e9583afbde47fa04bbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yCI5CC90tu0kDgUyxg_7lw.png"/></div></div></figure><p id="abf2" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">现在去AWS帐户，并检查代码提交和S3。</p><figure class="lb lc ld le fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es np"><img src="../Images/73d777a659347667c4969c52b514be49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eyKi6xz1qsMggJ5i70eEzA.png"/></div></div></figure><figure class="lb lc ld le fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es nq"><img src="../Images/5972d953024992bd6e1c686ea83f9bbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e5fDUzYz2MbryYmvHonNug.png"/></div></div></figure><h1 id="c720" class="ki kj hx bd kk kl km kn ko kp kq kr ks jd kt je ku jg kv jh kw jj kx jk ky kz bi translated">步骤2:设置所需的IAM角色</h1><p id="9243" class="pw-post-body-paragraph jm jn hx jo b jp md iy jr js me jb ju jv mf jx jy jz mg kb kc kd mh kf kg kh hb bi translated">同样，我将使用Terraform代码来创建两个IAM角色—</p><ul class=""><li id="2819" class="lp lq hx jo b jp jq js jt jv lr jz ls kd lt kh lu lv lw lx bi translated">第一个是CodeBuild项目，它将查看S3桶以获取terraform状态文件。此外，我们需要为CodeBuild项目提供一定的权力，以便它可以提供资源——比如我们的VPC。</li><li id="7543" class="lp lq hx jo b jp ly js lz jv ma jz mb kd mc kh lu lv lw lx bi translated">第二个是CodePipeline中的管道，它将运行CodeBuild项目。此外，我们将提供从CodeCommit获取代码的权限。</li></ul><p id="1515" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">首先，为了最佳实践，我在“variables.tf”文件中添加了一些变量。</p><figure class="lb lc ld le fd hk"><div class="bz dy l di"><div class="nm nn l"/></div></figure><p id="acf9" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">接下来，我们有代码来为CodeBuild创建IAM角色…</p><figure class="lb lc ld le fd hk"><div class="bz dy l di"><div class="nm nn l"/></div></figure><ul class=""><li id="bd1c" class="lp lq hx jo b jp jq js jt jv lr jz ls kd lt kh lu lv lw lx bi translated">我们正在为CodeBuild项目创建一个IAM角色，它对VPC有权限，在我们指定的S3桶内&amp;对CloudWatch日志有权限。因为CodeBuild项目将使用Terraform为我们提供VPC &amp;它将在S3维护Terraform状态文件。此外，它会将执行日志存储在CloudWatch日志中。</li></ul><p id="76d7" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">运行“terraform apply”并检查日志。另外，在AWS控制台上检查…</p><figure class="lb lc ld le fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es nr"><img src="../Images/8a3697e64992f1808c32290fba0b198c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_enUOgo5zjpdsobCd3mQMg.png"/></div></div></figure><figure class="lb lc ld le fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ns"><img src="../Images/92fa27c548ec066d1ad4167e76d2b6d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bGtkswLm3CKkP2Jmhu8fWw.png"/></div></div></figure><p id="3ca8" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">接下来，我们将为代码管道创建另一个用于设置IAM角色的代码…</p><figure class="lb lc ld le fd hk"><div class="bz dy l di"><div class="nm nn l"/></div></figure><ul class=""><li id="cc02" class="lp lq hx jo b jp jq js jt jv lr jz ls kd lt kh lu lv lw lx bi translated">该角色具有从CodeCommit获取terraform代码的特定权限。接下来，它可以运行我们自己创建的CodeBuild项目。此外，它可以将S3的神器存储在我们指定的桶中。我们正在给予CloudWatch许可，以便将来CodePipeline可以与CloudWatch事件集成。</li><li id="5e3a" class="lp lq hx jo b jp ly js lz jv ma jz mb kd mc kh lu lv lw lx bi translated">我们之所以创建一个名为“account_id”的局部变量，是因为我们还没有创建CodeBuild项目，所以terraform无法访问它的ARN。因此，我们使用变量文件&amp;中的项目名称和帐户id手动创建了ARN。</li></ul><p id="fc3a" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">运行terraform命令并在AWS中检查IAM</p><figure class="lb lc ld le fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es nt"><img src="../Images/b4b3cb4998c27b0cf31c55f0f4712a9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*01i9REfRwIgbdYuC18tUDw.png"/></div></div></figure><figure class="lb lc ld le fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es nu"><img src="../Images/6f09de9b35feae676ff981755dc34a00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L3VIVRTenXI1iGaIy5aNGw.png"/></div></div></figure><h1 id="1b42" class="ki kj hx bd kk kl km kn ko kp kq kr ks jd kt je ku jg kv jh kw jj kx jk ky kz bi translated">步骤3:提供代码构建项目</h1><p id="2a27" class="pw-post-body-paragraph jm jn hx jo b jp md iy jr js me jb ju jv mf jx jy jz mg kb kc kd mh kf kg kh hb bi translated">最后，是时候创建CodeBuild项目了。首先看看下面的代码&amp;之后我会解释它是如何工作的。</p><figure class="lb lc ld le fd hk"><div class="bz dy l di"><div class="nm nn l"/></div></figure><ul class=""><li id="4af1" class="lp lq hx jo b jp jq js jt jv lr jz ls kd lt kh lu lv lw lx bi translated">在这里，我们只是创建两个CodeBuild项目—一个是运行“terraform plan”命令，另一个是运行“terraform apply”命令，这样，如果plan命令失败，我们以后就不会运行apply命令。</li><li id="1cb2" class="lp lq hx jo b jp ly js lz jv ma jz mb kd mc kh lu lv lw lx bi translated">同样，我们可以看到CodeBuild source &amp; artifact是由CodePipeline管理的。现在，当我们调用CodeBuild时，我们将在容器内运行一些terraform命令&amp;为此，我们使用“hashicorp/terraform:latest”容器映像。</li></ul><p id="859f" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">现在我们要写那些我们想在容器中运行的terraform命令。因此，在你的工作区创建一个名为“buildspec”的文件夹，并放入下面提到的两个文件…</p><figure class="lb lc ld le fd hk"><div class="bz dy l di"><div class="nm nn l"/></div></figure><figure class="lb lc ld le fd hk"><div class="bz dy l di"><div class="nm nn l"/></div></figure><p id="8d16" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">我们完了。让我们再次运行terraform命令&amp;在AWS控制台上检查。</p><figure class="lb lc ld le fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es nv"><img src="../Images/74097ce4afcb57747e0ccafc352d3cd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LnwGnLTB3jK3HrTsQqEEog.png"/></div></div></figure><figure class="lb lc ld le fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es nw"><img src="../Images/c989338e8d73e9425f9410f3ff0f8fd9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r3UQ9ocD_ZdFN5cKtzKSxg.png"/></div></div></figure><h1 id="c667" class="ki kj hx bd kk kl km kn ko kp kq kr ks jd kt je ku jg kv jh kw jj kx jk ky kz bi translated">步骤4:提供代码管道项目</h1><p id="ccb1" class="pw-post-body-paragraph jm jn hx jo b jp md iy jr js me jb ju jv mf jx jy jz mg kb kc kd mh kf kg kh hb bi translated">我们非常接近完成我们的整个设置。这是我们为完成整个CI/CD设置而创建的最后一个文件。参见下面的代码。</p><figure class="lb lc ld le fd hk"><div class="bz dy l di"><div class="nm nn l"/></div></figure><ul class=""><li id="0981" class="lp lq hx jo b jp jq js jt jv lr jz ls kd lt kh lu lv lw lx bi translated">代码稍微大一点，但是容易理解。我们在CodePipeline中创建了一个管道，它有三个阶段。现在，代码管道中的一个约束是，您必须提供一个S3存储桶名称，代码管道将在此存储其工件。原因很简单，因为每个代码管道阶段都运行在一个独立的容器中&amp;如果你在第一阶段提取代码，然后在第二阶段使用代码，那么只有当代码管道将代码存储在某个集中的位置时，才能实现这一点。目前，CodePipeline的工作地点是S3。</li><li id="96df" class="lp lq hx jo b jp ly js lz jv ma jz mb kd mc kh lu lv lw lx bi translated">这就是为什么我们可以注意到无论CodePipeline生成什么输出工件，都与我们在第二和第三阶段传递的输入工件完全相同。</li><li id="345c" class="lp lq hx jo b jp ly js lz jv ma jz mb kd mc kh lu lv lw lx bi translated">接下来，在规划和部署阶段，我们运行我们之前创建的两个代码构建项目。</li></ul><p id="5e69" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">让我们最后一次运行terraform应用程序…</p><figure class="lb lc ld le fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es nx"><img src="../Images/3b2188559d4f8f84aa744a6ed9971f6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KlHCLzhiQGsJmT3KDA7TjQ.png"/></div></div></figure><p id="6a51" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">等等…你可能会看到你的代码管道失败了，仅仅是因为它从CodeCommit库获取了代码，但是我们仍然没有在那里创建任何代码。</p><figure class="lb lc ld le fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ny"><img src="../Images/056b955554cb4b903f83661ec0cd7218.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eebwGjZdkUshm9UQY--E9A.png"/></div></div></figure><h1 id="b5a5" class="ki kj hx bd kk kl km kn ko kp kq kr ks jd kt je ku jg kv jh kw jj kx jk ky kz bi translated">步骤4:克隆代码提交存储库</h1><p id="06b8" class="pw-post-body-paragraph jm jn hx jo b jp md iy jr js me jb ju jv mf jx jy jz mg kb kc kd mh kf kg kh hb bi translated"><strong class="jo hy">如果你知道Git &amp; GitHub，那么让我告诉你，当你在GitHub中创建一个没有初始化的库时，它就像一个空白文件夹，仍然没有被Git初始化。</strong>现在有两种技术…</p><ul class=""><li id="c8d2" class="lp lq hx jo b jp jq js jt jv lr jz ls kd lt kh lu lv lw lx bi translated">首先，您可以创建一个本地系统文件夹。使用git初始化该文件夹。输入你的密码。设置远程位置以上传远程存储库中的代码。然后最后做“git推送”。</li><li id="c3f9" class="lp lq hx jo b jp ly js lz jv ma jz mb kd mc kh lu lv lw lx bi translated">第二个简单得多。使用“README.md”文件初始化您的远程存储库。然后在本地系统中克隆存储库。输入你的代码，然后上传代码。</li></ul><p id="c86a" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">我选择第二种方法，所以让我们转到CodeCommit &amp;用README.md文件初始化存储库。</p><p id="987a" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">进入您的存储库→向下滚动并点击“创建文件”</p><figure class="lb lc ld le fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lo"><img src="../Images/47a1085b0dd047ecffbb9059aa325d0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n-0lqT6rFd2UqJfArAHUAQ.png"/></div></div></figure><p id="10f9" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">一旦创建了文件，等待一段时间&amp;由于Poll SCM调用，您的管道将自动启动。这意味着CodePipeline每分钟都在查看CodeCommit是否有变化。但还是会失败。原因很简单，因为我们还没有在知识库中创建任何terraform代码。</p><blockquote class="lf lg lh"><p id="ce84" class="jm jn li jo b jp jq iy jr js jt jb ju lj jw jx jy lk ka kb kc ll ke kf kg kh hb bi translated"><strong class="jo hy">注意:这里我没有创建CloudWatch事件来调用CodePipeline。但是你很容易学会。</strong></p></blockquote><figure class="lb lc ld le fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es nz"><img src="../Images/8db622513b012c6073ee6c3d9746663d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u6b2ZTovcxlfF80Kp_bZ9Q.png"/></div></div></figure><p id="0211" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">因此，让我们在本地系统中克隆CodeCommit存储库&amp;开始编写Terraform代码，以CI/CD方式开发我们的VPC。</p><p id="b507" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">现在有各种方法可以在你的本地系统中克隆CodeCommit库，但是请记住一件事，即<strong class="jo hy"> AWS root帐户不能克隆库。</strong>最初，我告诉你我使用的是一个AWS IAM帐户，该帐户拥有“AdministratorAccess”。我使用那个帐户访问密钥&amp;秘密密钥在我的本地系统上配置AWS CLI。因此，我能够运行Terraform命令。</p><p id="d074" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">您可以使用同一个AWS帐户来克隆存储库&amp;为此，在您本地系统上安装“python 3”&amp;运行下面的命令来安装“git-remote-codecommit”库。</p><figure class="lb lc ld le fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es oa"><img src="../Images/3c00f440ea857514d8f3da374ff4aa36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xaxEBy-BK_gDzH4kpdZ1WA.png"/></div></div></figure><p id="2c89" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">现在，如果您已经配置了AWS CLI，请转到AWS CodeCommit存储库并复制“HTTPS(GRC)”URL。</p><blockquote class="lf lg lh"><p id="a26e" class="jm jn li jo b jp jq iy jr js jt jb ju lj jw jx jy lk ka kb kc ll ke kf kg kh hb bi translated"><strong class="jo hy">参考文档:</strong><a class="ae lm" href="https://docs.aws.amazon.com/codecommit/latest/userguide/setting-up-git-remote-codecommit.html" rel="noopener ugc nofollow" target="_blank"><strong class="jo hy">https://docs . AWS . Amazon . com/code commit/latest/user guide/setting-up-git-remote-code commit . html</strong></a></p></blockquote><p id="71ca" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">最后运行git clone命令&amp;希望您能够克隆存储库。</p><figure class="lb lc ld le fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ob"><img src="../Images/8e7c0a0cece8085fbcc9cb9aa8d2e177.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yChiO6jTHyvVOSkZCGEIpg.png"/></div></div></figure><p id="6ec0" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">在我的例子中，我使用“raktim_cli”作为概要文件，但是它需要默认的概要文件。因此，我将再次设置我的AWS配置。一旦完成，我将拥有默认的概要文件，使用它我可以克隆存储库。</p><figure class="lb lc ld le fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es oc"><img src="../Images/d543e0f0619eed43fd7654f527999331.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J7n7shEc4dTfwnw4rVdHNg.png"/></div></div></figure><h1 id="5e13" class="ki kj hx bd kk kl km kn ko kp kq kr ks jd kt je ku jg kv jh kw jj kx jk ky kz bi translated">步骤5:设置Terraform后端以使用S3桶</h1><p id="09a5" class="pw-post-body-paragraph jm jn hx jo b jp md iy jr js me jb ju jv mf jx jy jz mg kb kc kd mh kf kg kh hb bi translated">现在让我们开始为VPC开发编码。但在此之前，我会要求你去你的S3桶&amp;检查“terraform_backend”文件夹内。它将是空的。</p><p id="43f1" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">首先，我们将为terraform设置“后端”&amp;也就是提供者。因为这些terraform文件将在CodeCommit中运行&amp;它需要从一个集中的位置获取状态文件。</p><p id="8d0f" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">创建以下三个代码文件…</p><figure class="lb lc ld le fd hk"><div class="bz dy l di"><div class="nm nn l"/></div></figure><figure class="lb lc ld le fd hk"><div class="bz dy l di"><div class="nm nn l"/></div></figure><p id="0c37" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">在这个提供者中，我们不需要传递任何配置文件，因为我们已经给了CodeBuild项目VPC完全访问和S3存储桶访问。因此，它可以轻松地在这两种资源上执行任务。</p><figure class="lb lc ld le fd hk"><div class="bz dy l di"><div class="nm nn l"/></div></figure><p id="23b5" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">该文件将有助于维护“terraform_backend”文件夹内S3存储桶中的terraform状态文件。一件非常重要的事情永远记住，你不能参数化这个文件中的任何值，因为通常“地形后端”是固定的。</p><p id="af0f" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">现在，如果您快速提交代码，并在CodeCommit中推送代码。会发生什么，让我们观察一下…</p><figure class="lb lc ld le fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es od"><img src="../Images/cb4d32b4b1ae7f57745614d50d4d9044.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*89CgYYxjim4ZNLRE3zEDmg.png"/></div></div></figure><p id="e644" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">git肯定需要知道作者的名字&amp;作者的电子邮件id来进行提交，就像我们之前在AWS CodeCommit中创建README.md文件时传递的一样。但是我不会将这两个变量设置为本地变量，因为我还有其他连接到GitHub、GitLab等的库。</p><p id="0521" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">因此，运行带有“- local”选项的config命令，仅为该存储库设置用户名和电子邮件。</p><figure class="lb lc ld le fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es oe"><img src="../Images/8acd46628de9fae3578e7280fdc2ddec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DDMbum9CVk1M4h6MNl3qXA.png"/></div></div></figure><p id="7c1e" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">我们已经在CodeCommit中成功上传了代码。现在让我们检查一下AWS控制台。</p><figure class="lb lc ld le fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es of"><img src="../Images/9983436d1faff0787c5c8074a07978b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FXs4Gm3wda2zNt58iwJPMw.png"/></div></div></figure><p id="4d54" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">现在等待一段时间&amp;检查AWS代码管道。</p><figure class="lb lc ld le fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es og"><img src="../Images/24fc996afc9cc5c4eb7e8688217a9f17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BGHpAusQxGW43WyVhmCFkg.png"/></div></div></figure><p id="d24c" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">万岁，我们的代码管道工作顺利。现在去你的S3桶&amp;你会看到你的地形状态文件存在。</p><figure class="lb lc ld le fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es oh"><img src="../Images/415b41e612bcf3a303af52509d82964a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cW1U5B9NPBqBW6c3CTS8tw.png"/></div></div></figure><h1 id="cd84" class="ki kj hx bd kk kl km kn ko kp kq kr ks jd kt je ku jg kv jh kw jj kx jk ky kz bi translated">步骤6:使用CI/CD实现VPC</h1><p id="ea24" class="pw-post-body-paragraph jm jn hx jo b jp md iy jr js me jb ju jv mf jx jy jz mg kb kc kd mh kf kg kh hb bi translated">现在一切都非常自动化&amp;顺利。转到您的本地git存储库&amp;在“beckend.tf”文件旁边创建另一个文件，比如一个示例terraform代码创建一个包含一个子网的VPC。</p><figure class="lb lc ld le fd hk"><div class="bz dy l di"><div class="nm nn l"/></div></figure><p id="6cb1" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">将代码提交到CodeCommit &amp;然后过一段时间检查代码管道和VPC仪表板。</p><figure class="lb lc ld le fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es oi"><img src="../Images/a5af2f3757771c329eec7133e9c4f885.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IzrMQa60cJfTFKbkGmygMA.png"/></div></div></figure><figure class="lb lc ld le fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lo"><img src="../Images/87008ed6e72c1ac115b2c1b3d93f804b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H8HwPinl3WLICM4NPTTqoQ.png"/></div></div></figure><p id="be4f" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">从VPC的标签中，我们可以很容易地验证它是由CodeBuild项目创建的。<strong class="jo hy">同样，有一件小事要记住，CodeBuild之所以能够提供VPC，是因为CodeBuild IAM角色拥有“VPCFullAccess”权限。</strong></p><h1 id="8233" class="ki kj hx bd kk kl km kn ko kp kq kr ks jd kt je ku jg kv jh kw jj kx jk ky kz bi translated">最后的话:</h1><figure class="lb lc ld le fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es oj"><img src="../Images/7fded64c1815e9bb6df4ccbb9848d816.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1lOW8WfgCcLqhRgZ"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">Source: Internet</figcaption></figure><ul class=""><li id="7d14" class="lp lq hx jo b jp jq js jt jv lr jz ls kd lt kh lu lv lw lx bi translated">我知道我知道；这是一次长时间的讨论。但是如果你去任何工业项目，那么这些学习只是整个游戏中很小的一部分。<strong class="jo hy">当然，我相信有一个强大的基础&amp;我希望这个博客能帮助你学习一个很好的用例。</strong></li><li id="b9ca" class="lp lq hx jo b jp ly js lz jv ma jz mb kd mc kh lu lv lw lx bi translated">和往常一样，我会请你在评论中分享你的想法&amp;给这个博客一些掌声。在过去的1.5年里，我一直在写这样的博客&amp;在这个领域已经超过2.5年了。</li><li id="21dc" class="lp lq hx jo b jp ly js lz jv ma jz mb kd mc kh lu lv lw lx bi translated">请务必在LinkedIn上与我联系。我还提供云计算和开发运维方面的技术咨询。希望有一天我们能互相交谈。</li></ul><p id="ece9" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">【https://www.linkedin.com/in/raktimmidya/ T4】</p><p id="4440" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated"><strong class="jo hy">感谢阅读。就这样…结束…😊</strong></p><figure class="lb lc ld le fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ok"><img src="../Images/3c8dea7dd22f0fc68cb23dd63e76c7e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*6S_6BiYdT0EVgXKn.png"/></div></div></figure></div></div>    
</body>
</html>