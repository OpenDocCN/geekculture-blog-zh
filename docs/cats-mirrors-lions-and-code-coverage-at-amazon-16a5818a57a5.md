# 当猫照镜子时，它们看到的是狮子

> 原文：<https://medium.com/geekculture/cats-mirrors-lions-and-code-coverage-at-amazon-16a5818a57a5?source=collection_archive---------16----------------------->

## 我如何改变了亚马逊对待代码覆盖的方式，并且见到了杰夫·贝索斯！

![](img/5f3d8e03e582db7c75b03c54c0d83a3f.png)

我在谷歌、亚马逊和微软工作了很长时间，专注于工程生产力工具和流程。我很感兴趣的是，每个工程师在这里或那里付出的一点点辛劳，如何累积成一家大型软件公司损失的数百万美元的生产力。另外，我对一个简单工具改变整个文化的能力很感兴趣。这是一个关于我写的一个蹩脚的小工具是如何改变了亚马逊的单元测试文化，尤其是测试覆盖率的故事。

在我继续深入之前，代码覆盖率的价值(或缺乏价值)是一个备受争议的话题，双方都有热情。我发现大多数讨论都以哲学、教条和迂腐告终，而我是一个务实的人。我相信这是一个有价值的工具，带有警告和使用常识。[大约一年前，我为谷歌官方测试社区写了一篇博客，阐述了我的想法](https://testing.googleblog.com/2020/08/code-coverage-best-practices.html)，我希望你能阅读。

【2011 年前后，让忙碌的亚马逊开发人员编写合适的单元测试就像拔牙一样困难。人们编写了单元测试，但是 amzn 没有太多的度量标准或门来实际规范。你写了你的代码，你写了一些或多或少看起来不错的单元测试，发送了代码评审，你的评审员通过非常努力地眯着眼睛把单元测试看得一团乱，就是这样。

**快进到 2021 年，**亚马逊的单元测试和代码覆盖文化发生了巨大的变化。代码覆盖率无处不在。

*   *预提交。*每个项目的构建文件都有一个构建代码、运行单元测试和获取代码覆盖率的默认目标。如果代码覆盖率低于某个硬数字，您可以添加规则来使构建失败。
*   *代码审查。*作为评审者，你可以看到测试覆盖了提议变更中的哪些行，哪些没有。不要纠结于教条式的*“嘿，你的代码覆盖率低于 x %”*你可以进行更有意义的、务实的对话*“嘿，我注意到你的测试没有覆盖这一行代码，我认为它非常重要，你应该覆盖它，因为…”*
*   *提交后。*还有一种方法可以在 CI/CD 设置中为整个服务的代码覆盖率添加门控。这个入口更关注*增量*，而不是硬编码的数字(所以，你刚刚检查:你让事情变得更好还是更坏了？[童子军规则](https://deviq.com/principles/boy-scout-rule)。[旁注:如果你想了解更多关于 Amazon 做 CI/CD 的方式，这里有两个好朋友写的很棒的博客:[持续改进和软件自动化](https://aws.amazon.com/builders-library/going-faster-with-continuous-delivery/)和[自动化安全、不干涉的部署](https://aws.amazon.com/builders-library/automating-safe-hands-off-deployments/)。]

那么，亚马逊文化是如何在十年间发生如此大的变化的呢？很多因素。业界开始更加关注单元测试，并将代码覆盖率作为一种更加遵守单元测试的方式。工具变得更好。和我一样的许多人坚持不懈地提倡。

我的代码覆盖率故事始于 2011 年。我试图帮助亚马逊的一个团队识别和理解测试差距。该团队拥有大约 12 个服务，代码分布在数百个 Java 包中，因此很难获得测试的“全貌”并确定测试差距。我写了一个小爬虫，给定一个包列表，从单元测试中获取官方代码覆盖信息，并生成一个 html 报告。它很简陋，但它给了我们一个很好的“这是你的整个世界”的视角。我开始定期在团队会议上展示它，我周围的开发人员似乎喜欢它，并开始关注它。

既然反响不错，我想，也许我应该把它更广泛地宣传给我周围的其他团队。我的第一个脚本有一个硬编码的包列表，所以我必须在扩展之前清理一下。接下来的几个月，我花了大量的空闲时间做一些小的改进。我对它进行了修改，调用代码所有权服务来动态获取团队拥有的包，这样新创建的包就会神奇地出现，并添加通配符来包含或排除包。我添加了发送带有 html 报告的电子邮件的功能。我与副总裁领导的团队一起将它社会化，然后等待。等待着。等待着。没有人上车！这是一次彻底的失败。我觉得我浪费了时间来使我的工具功能更加丰富，人们应该关心用数据和纪律来度量他们的单元测试，当胃口似乎不在那里时，我很难过。

![](img/074aa540a04499695a4e9e4d9133723d.png)

My first attempt at socializing my tool was a failure…

所以我的工具在那里放了几年，积满了灰尘和蜘蛛网。

接下来发生的只是命运的简单转折。我的老板克莱尔休了六个月的产假，她让我在她不在的时候帮忙。我对当经理毫无兴趣，但我认为这是一个有限的承诺，有确切的开始和结束日期。我会在亚马逊学习一两件关于管理的事情，然后当她回来时，我会回去做一名个体贡献者。克莱尔有一份艰难且吃力不讨好的工作，我现在接手了。我是一个 VP 的 QA 经理，组织有大约 40 个团队，我手下有 20 个工程生产力工程师(SDETs)。实际上，我的第一个任务是将 20 名工程师匹配到 40 个团队。一些团队将没有专门的 SDET，或者有一个部分的。但是哪些团队呢？每个团队都觉得自己很重要，足以获得一个。

我疯狂地收集信息。我和每个团队的经理一起喝咖啡，问了很多问题来评估团队在测试实践方面的成熟度，以找出我在哪里可以为我的 20 名工程师获得最好的投资回报。当我完成时，我意识到每个经理都告诉我大致相同的事情:一切都很好。我犯了得到一个*主观*评估的大罪。我需要一个*客观*的评估，用事实和数据，而不是观点和感觉。

我需要做的事情之一是理解整个组织中的测试差距。这时我想起了我写的那个旧的代码覆盖聚合工具。我重新整理了代码，将它指向整个组织，我得到了一个漂亮的 html 报告，向我展示了情况有多糟糕。

这里我们看到的是一只猫看着镜子里的自己，看到了一只狮子。

一些团队(包括一些坚持认为他们的测试很棒的团队)在他们的单元测试中代码覆盖率非常低！令人担忧。我把数据给那些告诉我一切都很好的经理看，他们震惊了！他们不知道。我可以用数据证明*大量的关键代码没有经过任何测试就投入生产。没有人想过采用一种系统的、数据驱动的方法来测量整个组织的覆盖率。我甚至可以展示历史趋势，告诉他们随着工程师增加代码，他们的覆盖率已经越来越差了！*

它不是恶意的。工程师们想做正确的事情。他们只是缺乏数据来证明他们没有做正确的事情。一旦我开始向副总裁和经理发布报告，就有一个新的重点放在提高测试覆盖率上。

那是我点燃导火索所需要的火花。我的东西*很*有用！我应该再次尝试将它与更广泛的观众进行交流。第一次的时候，我最大的遗憾是入职故事很糟糕。当我重新阅读两年前写的说明时，我畏缩了，现在有了一些时间流逝的好处。说明是如此糟糕，我甚至不会登上我自己的工具！所以我专注于让入职故事简单得可笑。

*我做了三个简单的技术决定，这些决定在几个月后以最惊人的方式困扰着我。*我必须让它更快、更可靠。我做的事情之一是调用 RPC 服务，从主分支的负责人那里获取上一次成功签入构建的官方代码覆盖率数字。我注意到调用非常慢，在我的副总裁领导下，针对数百个服务运行该工具需要几个小时(有时中途会失败)。”*啊哈！多线程来拯救！”我想，为自己感到骄傲。所以我把问题扔给了一个有 16 个线程的线程池。尽管调用速度很慢，但我同时进行了 16 次调用，所以速度要快得多。我还对这些 RPC 调用有时会失败感到恼火。*“啊哈！重试救援！”我想，又为自己感到骄傲了。所以我增加了 3 次指数补偿重试。我现在有了一个又快又可靠的脚本。最后，我如何确保我的工具自动按节奏运行？我添加了一个缺省值，在西雅图时间每天午夜作为 cronjob 运行。**

![](img/f106cfad8543f264918f400649b2a66e.png)

(a) Running in a threadpool and (b) adding retries… seemed like good ideas…

我为简化入职体验所做的改变确实扭转了局面。我不知道我那蹩脚的小工具是怎么回事，但它开始像野火一样蔓延。我认为它正好满足了人们的需求，这只是在正确的时间使用正确的工具的意外收获。这个工具本身并不起眼。但它确实创造了人们以前没有的差距意识，并给工程师提供了可操作的数据。它激发了热情。它确实改变了人们对代码覆盖率和单元测试的看法。该工具所推动的文化变革非常迷人。仅仅在最初的几个月，就有数百个团队采用了它，并且这些团队在那几个月中显著地提高了他们的代码覆盖率。

最意想不到的人注意到了这些文化变化。**杰夫·贝索斯！**亚马逊有一个令人垂涎的内部奖项，叫做 *Just Do It Award* 。杰夫·贝索斯每年都会挑选一两个员工，他们通过在日常工作之外创造一些有影响力的东西，来体现创新和行动偏好的核心价值观。杰夫决定把 2013 年的 Just Do It 奖颁给我的破工具。 [**下面是那天的故事**](https://carloarg02.medium.com/how-i-met-jeff-bezos-2013-347f6c33c183)……遇见杰夫是我职业生涯中的一大亮点。

![](img/a583dfd4c301e45068bdebf05c453a1d.png)

Jeff and I, Just Do it Award, 2013

![](img/685d4163917f639b96a6a292371c284f.png)

Brian Valentine on stage announcing the Just Do It Award 2013!

![](img/1bdc8f44ece4091e46555c4a0ac3dbe8.png)

2013 Amazon Company Meeting… stadium filling up!

我告诉过你一些简单的技术决策会以最惊人的方式困扰我。那天晚上就是那个晚上！

“Just Do It”奖是亚马逊网站上最大的亮点。当我走上舞台的时候，体育场里有成千上万的人，这正在向全世界所有的卫星办公室直播。他们中的相当一部分人对此很感兴趣，并决定上船看看他们团队的报告是什么样的。入职很简单，对吧？你只需输入一个命令，这个东西就会作为一个 cronjob 安装到你的机器上。不知不觉中，我制造了一个定时炸弹。在太平洋标准时间的午夜，亚马逊各地成千上万新创建的 cronjobs 醒来，开始运行我的脚本。是的，都在同一时间。不仅如此，这些脚本中的每一个都开始运行 16 个并发线程，所以问题要严重 16 倍。当返回官方代码覆盖度量的 RPC 服务突然遇到流量高峰时，一些调用开始失败。我已经建立了帮助失败的东西:重试！因此，在多线程和重试之间，问题没有恶化 16 倍，而是恶化了 48 倍。总之，那个可怜的毫无防备的 RPC 服务获得了正常流量的 1000 倍。它弯下腰，死了一个不客气的死亡，寻呼各种各样的人在西雅图的午夜睡觉。故障排除是一场噩梦，因为对他们来说，有成千上万台不相关的机器突然调用一个以前没有人真正调用过的晦涩的 API。这不仅仅是一个表现不佳的客户，而是成千上万，遍布亚马逊！就这样，他们停止了，让可怜的 oncall 迷惑不解，但又松了一口气，奇怪的拒绝服务攻击已经停止了。

第二天，太平洋标准时间午夜，完全相同的事情发生了。我第二次关闭了服务。

![](img/ab85ecf10aead1c0753e47fb179d514e.png)

How those simple technical choices put 1000x the normal load onto my dependency (ooops)

我想花了三天才最终找到我。他们的首席工程师严厉地教训了我一顿(从那以后，我们成了真正的好朋友！).我所做的技术决定并不可怕…多线程和重试是常见的。但是我没有想到其中的一些会在大范围内如何表现。最重要的是，我从来没有花时间和拥有这个毫无戒心的 RPC 服务的团队在一起，告诉他们我将会广泛地使用它们。事实证明，RPC 调用非常昂贵，如果我费心与他们交谈，我就会知道有一个更简单、更快、更便宜的 RPC 调用来实现同样的目的。永远和你的依赖者交谈，他们是你一生的伙伴！

我发明的工具早就报废了。没关系:这是当时的正确工具，但其他(更好的)工具随之而来。其他工程师拿起了火炬。让杰夫·贝索斯成为聚光灯下的焦点给这个空间增加了很多可信度。我的工具开创了创新的先河，这就是今天代码覆盖率如何嵌入到亚马逊的代码审查工具(“Coverlay”)和 CI/CD 工具(“代码覆盖率警察”)中。我为我的蹩脚工具写的一些代码今天仍然存在于其他工具中。代码覆盖率从二等公民变成了公司里很多人关心的事情。

***工具从来都不仅仅是工具。仔细思考它改变文化、重新聚焦注意力和激发你周围热情的能力。***

![](img/d8bdf48741133c686332f846f3c93925.png)

Credit [here](https://sketchplanations.com/goodharts-law). Goodhart’s law is a reason Code Coverage conversations can get ratholed sometimes! But I figured engineers are smart and given the right data will do the right thing.