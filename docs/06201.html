<html>
<head>
<title>Validate your Express.js API with Joi.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Joi验证您的Express.js API。</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/express-js-api-validation-with-joi-4840505f1e5f?source=collection_archive---------2-----------------------#2021-08-11">https://medium.com/geekculture/express-js-api-validation-with-joi-4840505f1e5f?source=collection_archive---------2-----------------------#2021-08-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/eab9e22298ca40394f71e75599fa5cc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*haNP-8YxfFubJ5exMSTB5w.jpeg"/></div></div></figure><blockquote class="iq ir is"><p id="481f" class="it iu iv iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在本文中，我们将看到如何用Joi(一个JavaScript数据验证器)来验证我们的Express.js API。我将尽可能保持它的简单，这样任何新手都会发现它很容易实现。</p></blockquote><p id="76c6" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated">在开始之前，我们需要验证Node.js和npm是否安装在我们的系统上。如果安装了，下面的命令将为您提供相同的各自版本。另外，检查是否安装了MySQL。</p><pre class="jv jw jx jy fd jz ka kb kc aw kd bi"><span id="bcd3" class="ke kf hi ka b fi kg kh l ki kj">node -v<br/>npm -v<br/>mysql -V</span></pre><p id="4f31" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated">如果没有安装，可以从<a class="ae kk" href="https://nodejs.org/en/" rel="noopener ugc nofollow" target="_blank">官网</a>下载。对于在Linux系统上安装Node.js、npm和MySQL，最后提供了所有这些的链接以供参考。</p><p id="2474" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated">如果您已经安装了这些，那么我们可以继续进行。</p></div><div class="ab cl kl km gp kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="hb hc hd he hf"><h2 id="ddcb" class="ke kf hi bd ks kt ku kv kw kx ky kz la js lb lc ld jt le lf lg ju lh li lj lk bi translated">步骤1:设置我们的MySQL数据库和表来查询数据:</h2><p id="fabf" class="pw-post-body-paragraph it iu hi iw b ix ll iz ja jb lm jd je js ln jh ji jt lo jl jm ju lp jp jq jr hb bi translated">我们将创建一个新的数据库。这是一个可选步骤，如果您想在现有数据库中创建您的表，那么您可以自由地这样做。首先，使用以下信息登录MySQL:</p><pre class="jv jw jx jy fd jz ka kb kc aw kd bi"><span id="d65e" class="ke kf hi ka b fi kg kh l ki kj">mysql -h HOST -u USER -p</span></pre><p id="cff6" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated">创建新数据库:</p><pre class="jv jw jx jy fd jz ka kb kc aw kd bi"><span id="c661" class="ke kf hi ka b fi kg kh l ki kj">CREATE DATABASE <em class="iv">validate_db</em>;</span></pre><p id="9dc0" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated">使用我们刚刚创建的数据库:</p><pre class="jv jw jx jy fd jz ka kb kc aw kd bi"><span id="98fd" class="ke kf hi ka b fi kg kh l ki kj">USE DATABASE <em class="iv">validate_db</em>;</span></pre><p id="2157" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated">现在，我们将在刚刚创建的数据库中创建我们的表，即进入<strong class="iw hj"> validate_db </strong>。我们将创建一个表，其中包含学生的姓名、年龄、爱好和电子邮件。</p><pre class="jv jw jx jy fd jz ka kb kc aw kd bi"><span id="e8a9" class="ke kf hi ka b fi kg kh l ki kj">CREATE TABLE <em class="iv">students</em> (<br/>    id int NOT NULL AUTO_INCREMENT,<br/>    name varchar(50) NOT NULL,<br/>    age int NOT NULL,<br/>    hobby varchar(50) NOT NULL,<br/>    email varchar(50) NOT NULL,<br/>    PRIMARY KEY (id)<br/>);</span></pre></div><div class="ab cl kl km gp kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="hb hc hd he hf"><h2 id="4270" class="ke kf hi bd ks kt ku kv kw kx ky kz la js lb lc ld jt le lf lg ju lh li lj lk bi translated">步骤2:设置我们的Express.js环境:</h2><p id="94a8" class="pw-post-body-paragraph it iu hi iw b ix ll iz ja jb lm jd je js ln jh ji jt lo jl jm ju lp jp jq jr hb bi translated">现在我们的数据库和表已经创建好了，我们将创建我们的文件夹，在那里我们将设置我们的开发环境。</p><pre class="jv jw jx jy fd jz ka kb kc aw kd bi"><span id="c604" class="ke kf hi ka b fi kg kh l ki kj">mkdir express-joi-validate</span></pre><p id="40c1" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated"><strong class="iw hj">注意:</strong>你可以在系统上任何想要的位置创建文件夹。</p><pre class="jv jw jx jy fd jz ka kb kc aw kd bi"><span id="c550" class="ke kf hi ka b fi kg kh l ki kj">npm init -y</span></pre><p id="8a13" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated">这将在我们的文件夹的根目录下创建一个<strong class="iw hj"> package.json </strong>文件。我们在npm init中提供的'-y '标志自行配置所有的依赖关系和其他命名形式。如果需要，您可以跳过该标志，根据需要手动配置它们。现在我们将安装express、MySQL、Joi和nodemon:</p><pre class="jv jw jx jy fd jz ka kb kc aw kd bi"><span id="3dc0" class="ke kf hi ka b fi kg kh l ki kj">npm i express@4.17.1<br/>npm i joi@17.4.2<br/>npm i nodemon@2.0.12<br/>npm i mysql@2.18.1</span></pre><p id="1d1b" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated">我们已经安装了nodemon，这样我们就不必在每次进行更改并保存它们时手动启动服务器。Nodemon将监视<strong class="iw hj"> mjs </strong>、<strong class="iw hj"> js </strong>和<strong class="iw hj"> json </strong>扩展。接下来，我们在文件夹的根目录下创建<strong class="iw hj"> app.js </strong>。在这里，我们将需要到目前为止我们已经安装的所有依赖项。</p><figure class="jv jw jx jy fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lq"><img src="../Images/3384acc2cf0f378f7d04ab9824da03b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_4vZcRb2QVH3wjnVx2gMYw.png"/></div></div><figcaption class="lr ls et er es lt lu bd b be z dx">Project structure with the installed dependencies in package.json</figcaption></figure><p id="8ca0" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated"><strong class="iw hj">设置app.js </strong></p><p id="553c" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated">在app.js中我们需要express、MySQL和Joi。为了看看服务器是否工作正常，我们对它进行了如下测试:</p><figure class="jv jw jx jy fd ij"><div class="bz dy l di"><div class="lv lw l"/></div><figcaption class="lr ls et er es lt lu bd b be z dx">Testing our Express.js server.</figcaption></figure><p id="9328" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated"><strong class="iw hj">设置MySQL与我们服务器的连接:</strong></p><p id="6117" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated">在我们的app.js文件中，我们将编写下面几行代码来帮助我们建立与数据库的连接。</p><figure class="jv jw jx jy fd ij"><div class="bz dy l di"><div class="lv lw l"/></div><figcaption class="lr ls et er es lt lu bd b be z dx">Setting up MySQL database connection.</figcaption></figure><p id="8ce2" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated">这里，我已经将我的数据库凭证作为环境变量进行了传递。这是一种方法，您可以将您的数据库凭证直接作为字符串传递，但是，当您在生产数据库上工作时，不建议这样做。请注意对象密钥tls，tls代表传输层安全性。通过将rejectUnauthorized设置为true，我们正在验证服务器证书。如果验证失败，则给出一个错误。<strong class="iw hj">注意:</strong>reject authorized key只取<strong class="iw hj">布尔</strong>值，即<strong class="iw hj">真</strong>或<strong class="iw hj">假</strong>。</p><p id="1d58" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated"><strong class="iw hj">向MySQL表发送数据的POST请求:</strong></p><p id="4649" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated">由于我们已经建立了与数据库的连接，我们可以继续向表中插入数据了:</p><figure class="jv jw jx jy fd ij"><div class="bz dy l di"><div class="lv lw l"/></div><figcaption class="lr ls et er es lt lu bd b be z dx">Testing POST request.</figcaption></figure><h2 id="99f6" class="ke kf hi bd ks kt ku kv kw kx ky kz la js lb lc ld jt le lf lg ju lh li lj lk bi translated">步骤3:用Joi验证我们的API:</h2><p id="e8d4" class="pw-post-body-paragraph it iu hi iw b ix ll iz ja jb lm jd je js ln jh ji jt lo jl jm ju lp jp jq jr hb bi translated">Joi将验证所有将值传递给数据库的对象键。然后，经过验证的模式将作为响应发送出去。我们完整的POST请求现在将如下所示:</p><figure class="jv jw jx jy fd ij"><div class="bz dy l di"><div class="lv lw l"/></div><figcaption class="lr ls et er es lt lu bd b be z dx">Validating POST request with Joi.</figcaption></figure><p id="98b8" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated"><strong class="iw hj">schema . validate(req . body)</strong>有一个主对象，它有两个键，值<strong class="iw hj">和错误<strong class="iw hj">作为响应发送。如果没有发现错误，那么只返回带有值键的对象，否则还会获得带有错误详细信息的错误键。</strong></strong></p><p id="fb3a" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated">现在，我们在connection.query外部初始化模式验证器是有原因的。如果我们在connection.query内部初始化模式，即使验证失败，它也会始终向数据库发送数据。为了避免这个问题，我们在它之外定义了模式。此外，我们有条件地处理DB insert查询，这样，如果发现错误，就不会提交响应。如果它通过了所有的验证测试，没有任何错误，那么它将被插入到我们的数据库中。</p><p id="a34a" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated"><strong class="iw hj">发送失眠请求:</strong></p><p id="ca2c" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated">我将用失眠来测试我的反应。您可以随意使用任何其他您喜欢的API开发工具。</p><figure class="jv jw jx jy fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lx"><img src="../Images/ed1a90883d9af0d6912aba52b60a9d13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PxS0u2zvBPUd_ImkNxQpYg.png"/></div></div><figcaption class="lr ls et er es lt lu bd b be z dx">Sending response with incorrect datatype in JSON.</figcaption></figure><figure class="jv jw jx jy fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lx"><img src="../Images/bb7055ffc7f57574b8861460f58c8036.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aHnetNKW2mAYoWpqUe6XIw.png"/></div></div><figcaption class="lr ls et er es lt lu bd b be z dx">Sending response data with all the required datatypes. Success.</figcaption></figure><figure class="jv jw jx jy fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ly"><img src="../Images/1712556051cf4842967c150d770fad80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HaqEd8KJu07J5jJzG44G6A.png"/></div></div><figcaption class="lr ls et er es lt lu bd b be z dx">As seen from our MySQL table.</figcaption></figure><p id="cccc" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated">这样我们就实现了验证Express.js API的目标。</p><p id="7c22" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated"><strong class="iw hj">链接到GitHub资源库:</strong><a class="ae kk" href="https://github.com/chinmaykarmokar/express-joi-validate" rel="noopener ugc nofollow" target="_blank">express-joi-validate</a></p><p id="c5ce" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated"><strong class="iw hj">安装:</strong> <a class="ae kk" href="https://linuxize.com/post/how-to-install-node-js-on-ubuntu-18.04/" rel="noopener ugc nofollow" target="_blank"> Node.js和npm </a>，<a class="ae kk" href="https://www.javahelps.com/2019/08/install-mysql-8-on-ubuntulinux-mint.html" rel="noopener ugc nofollow" target="_blank"> MySQL </a></p></div></div>    
</body>
</html>