<html>
<head>
<title>Quick Intro to SQL With Clause</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">SQL With子句快速介绍</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/quick-intro-to-sql-with-clause-a218067d0ec8?source=collection_archive---------15-----------------------#2022-02-23">https://medium.com/geekculture/quick-intro-to-sql-with-clause-a218067d0ec8?source=collection_archive---------15-----------------------#2022-02-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="143a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您是否想过如何让SQL查询更具可读性？您曾经不得不在一个连接中多次重用同一个子查询吗？或者，您第一次在SQL查询中遇到了“With ”?然后继续阅读，发现SQL中的一个全新的可能性世界！</p></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><h1 id="fa69" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated"><strong class="ak">定义With子句</strong></h1><p id="97b7" class="pw-post-body-paragraph if ig hi ih b ii ki ik il im kj io ip iq kk is it iu kl iw ix iy km ja jb jc hb bi translated">从技术上讲，“With”子句被称为“常用表表达式”，或CTE的。我经历了惨痛的教训，在一次面试中没能提供任何关于“CTE”的描述，却发现在谷歌上搜索这个术语后，我一直在使用它！</p><p id="7eb2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这样一来，CTE就是SQL中一个强大的工具:它们允许我们在查询中构建充当临时表的实体。或者作为复杂查询中可重用的子查询。甚至有可能以递归方式使用CTE的。CTE的类似于视图，除了它们用于特定的用例(即在单个查询中)而不是可用于一般用途。</p><p id="e918" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您的SQL版本的文档可能是了解“With”子句的特定语法的最佳地方，但是在PostgreSQL中，它使用起来非常简单，即使有多个CTE:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="aeb2" class="kw jl hi ks b fi kx ky l kz la">WITH <br/>    <em class="lb">first_cte_name</em> as (<em class="lb">sql_query_here</em>),<br/>    <em class="lb">second_cte_name </em>as (<em class="lb">sql_query_here)</em></span><span id="a459" class="kw jl hi ks b fi lc ky l kz la">SELECT ... FROM ... </span></pre><p id="8a99" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">建立CTE的最基本的方法如上。只需将“With”子句添加到SQL查询中，将CTE命名为“as ”,并在括号内编写一个SQL查询。每个定义都用逗号分隔，直到最后一个定义。然后，像往常一样编写一个SQL查询。CTE可以像任何桌子一样使用。它们可以在“FROM”中引用，在子查询中使用，或者与SQL查询中的现有表连接或垂直合并。</p><p id="22ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用CTE语句不仅限于“选择”语句。它可以与各种语句一起使用，如SELECT INTO、CREATE TABLE AS、CREATE VIEW、DECLARE、EXPLAIN、INSERT INTO … SELECT、PREPARE、UPDATE、DELETE。有关完整列表和适用的特殊语法，请参阅您的文档。</p></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><h1 id="0bcc" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">常用表表达式用例</h1><p id="33ab" class="pw-post-body-paragraph if ig hi ih b ii ki ik il im kj io ip iq kk is it iu kl iw ix iy km ja jb jc hb bi translated">CTE主要用于提高可读性和简化SQL脚本的维护，因为我们能够重用它们。在某些情况下，它们还可以显著提高复杂查询的性能。</p><p id="c72f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">另一个值得一提的用例是递归CTE(是的，SQL中的递归！).</p><p id="fc9d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">CTE的一个用例</strong></p><p id="e96f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">CTE的方法有助于提高SQL脚本的可读性。以这个只有一个join的查询为例(使用关于玩家统计的NHL数据和冰上时间信息):</p><figure class="kn ko kp kq fd le er es paragraph-image"><div class="er es ld"><img src="../Images/ce1bc105807f65e2bf15b783fa8c49f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1194/format:webp/1*E1eVoZ9-EIK1KJ6XFzt-Mg.png"/></div></figure><p id="5ba5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是一个简单的查询。FROM子句中有一个子查询，用于计算一组不同的玩家统计数据。该查询连接到另一个关于icetime信息的子查询。</p><p id="cd09" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，让我们看看使用CTE的构建的相同查询。</p><figure class="kn ko kp kq fd le er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lh"><img src="../Images/443b3c30299f039efc6f3134f9b3fcaf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ONaQ7hWlkB-7rAQuwf5NOg.png"/></div></div></figure><p id="656a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">总行数稍微长了一点，但是现在我们在主查询中所做的事情更加清楚了。</p><p id="67be" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它看起来已经很乱了，但是想象一下如果有几十个子查询呢？或者我们是否想重用子查询？在上面的例子中，对于体育数据，用例可以是从球员的统计表中提取球队列表，并为球队的使用、球队的进攻指标等创建查询。最后，在一个可读性更强、更简单的查询下加入所有这些CTE。</p><h1 id="7815" class="jk jl hi bd jm jn lm jp jq jr ln jt ju jv lo jx jy jz lp kb kc kd lq kf kg kh bi translated">结论</h1><p id="65da" class="pw-post-body-paragraph if ig hi ih b ii ki ik il im kj io ip iq kk is it iu kl iw ix iy km ja jb jc hb bi translated">总之，公共表表达式——With子句——是一个强大而简单的SQL子句，可以与大量语句一起使用，以简化和重用子查询。通过划分子查询，它们可以用来构建可读性更强的复杂SQL语句。甚至，对于最好奇的高级用户来说，CTE可以用于SQL表中的递归。</p></div></div>    
</body>
</html>