<html>
<head>
<title>A Simple Guide To Java Native Interface (JNI) Using Native Maven Plugin</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用本地Maven插件的Java本地接口(JNI)简单指南</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/a-simple-guide-to-java-native-interface-jni-using-native-maven-plugin-e01f4077a8a5?source=collection_archive---------1-----------------------#2021-08-08">https://medium.com/geekculture/a-simple-guide-to-java-native-interface-jni-using-native-maven-plugin-e01f4077a8a5?source=collection_archive---------1-----------------------#2021-08-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/68847fb585720cf63509df915f92d54c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PTRedH3khIsdhe5hVLeXPQ.jpeg"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">Photo by <a class="ae hv" href="https://unsplash.com/@sigmund" rel="noopener ugc nofollow" target="_blank">sigmund</a> on Unsplash</figcaption></figure><div class=""/><p id="4085" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">有时需要从<strong class="ix hz"> Java </strong>中调用<strong class="ix hz"> C/C++ </strong>代码，例如使用<strong class="ix hz"> CUDA/OpenCL </strong>进行<strong class="ix hz"> GPGPU </strong>计算，或者使用<strong class="ix hz"> Vulkan/OpenGL渲染复杂的<strong class="ix hz"> 3D </strong>图形。</strong>在这种情况下，调用<strong class="ix hz"> C++ </strong>函数最简单的方法就是使用<strong class="ix hz"> </strong> <a class="ae hv" href="https://docs.oracle.com/javase/8/docs/technotes/guides/jni/spec/intro.html#java_native_interface_overview" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hz"> Java本地接口</strong> </a> <strong class="ix hz"> (JNI)。</strong>同时，方便将<strong class="ix hz"> C/C++ </strong>和<strong class="ix hz"> Java </strong>源码保存和编译在一起——这就是<a class="ae hv" href="https://www.mojohaus.org/maven-native/native-maven-plugin/" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hz">原生Maven插件</strong> </a> <strong class="ix hz"> </strong>发挥作用的地方。</p><p id="9331" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">本文将提供用于<strong class="ix hz"> Windows </strong>和<strong class="ix hz"> macOS的<strong class="ix hz">原生Maven插件</strong>的配置示例，使用JDK8 </strong>和示例代码从<strong class="ix hz"> Java </strong>调用<strong class="ix hz"> C/C++ </strong>，反之亦然。</p><p id="e474" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这个项目在我的GitHub  这里有<a class="ae hv" href="https://github.com/dredwardhyde/jni-maven-example" rel="noopener ugc nofollow" target="_blank">。</a></p><h2 id="8e45" class="jt ju hy bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">macOS配置</h2><p id="52a0" class="pw-post-body-paragraph iv iw hy ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">这个配置是用最新的<strong class="ix hz"> Xcode </strong>在<strong class="ix hz"> macOS Big Sur上测试的。</strong>请注意，<strong class="ix hz">原生Maven插件</strong>需要<a class="ae hv" href="https://developer.apple.com/forums/thread/652240" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hz">命令</strong> - <strong class="ix hz">线条工具</strong> </a> <strong class="ix hz"> </strong>安装。</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="4465" class="jt ju hy ky b fi lc ld l le lf">&lt;profile&gt;<br/>  &lt;id&gt;<strong class="ky hz">macOS</strong>&lt;/id&gt;<br/>  &lt;activation&gt;<br/>    &lt;os&gt;<br/>      &lt;family&gt;<strong class="ky hz">mac</strong>&lt;/family&gt;<br/>    &lt;/os&gt;<br/>  &lt;/activation&gt;<br/>  &lt;properties&gt;<br/>    &lt;os_name&gt;<strong class="ky hz">mac</strong>&lt;/os_name&gt;<br/>    <strong class="ky hz"><em class="lg">&lt;!-- should follow the pattern lib*library_name*.dylib--&gt;</em></strong><em class="lg"><br/>    </em>&lt;lib_name&gt;<strong class="ky hz">libjnilibrary.dylib</strong>&lt;/lib_name&gt;<br/>  &lt;/properties&gt;<br/>  &lt;build&gt;<br/>    &lt;plugins&gt;<br/>      &lt;plugin&gt;<br/>        &lt;groupId&gt;<strong class="ky hz">org.codehaus.mojo</strong>&lt;/groupId&gt;<br/>        &lt;artifactId&gt;<strong class="ky hz">native-maven-plugin</strong>&lt;/artifactId&gt;<br/>        &lt;version&gt;<strong class="ky hz">1.0-alpha-11</strong>&lt;/version&gt;<br/>        &lt;extensions&gt;<strong class="ky hz">true</strong>&lt;/extensions&gt;<br/>        &lt;configuration&gt;<br/>          &lt;javahOS&gt;<strong class="ky hz">${os_name}</strong>&lt;/javahOS&gt;<br/>          &lt;sources&gt;<br/>            &lt;source&gt;<br/>              <strong class="ky hz"><em class="lg">&lt;!-- path to the C/C++ sources --&gt; <br/>              </em></strong>&lt;directory&gt;<strong class="ky hz">src/native/source</strong>&lt;/directory&gt;<br/>              &lt;fileNames&gt;<br/>                &lt;fileName&gt;<strong class="ky hz">jni.c</strong>&lt;/fileName&gt;<br/>              &lt;/fileNames&gt;<br/>            &lt;/source&gt;<br/>            <strong class="ky hz"><em class="lg">&lt;!-- in this example - path to generated JNI header --&gt;  <br/>            </em></strong>&lt;source&gt;<br/>              &lt;directory&gt;<strong class="ky hz">src/native/include</strong>&lt;/directory&gt;<br/>            &lt;/source&gt;<br/>          &lt;/sources&gt;<br/>          &lt;compilerProvider&gt;<strong class="ky hz">generic-classic</strong>&lt;/compilerProvider&gt;<br/>          &lt;compilerExecutable&gt;<strong class="ky hz">gcc</strong>&lt;/compilerExecutable&gt;<br/>          <strong class="ky hz"><em class="lg">&lt;!-- compiler options --&gt; <br/>          </em></strong>&lt;compilerStartOptions&gt;<br/>            &lt;compilerStartOption&gt;<strong class="ky hz">-m64</strong>&lt;/compilerStartOption&gt;<br/>            &lt;compilerStartOption&gt;<strong class="ky hz">-Wall</strong>&lt;/compilerStartOption&gt;<br/>            &lt;compilerStartOption&gt;<strong class="ky hz">-Wextra</strong>&lt;/compilerStartOption&gt;<br/>            &lt;compilerStartOption&gt;<strong class="ky hz">-O3</strong>&lt;/compilerStartOption&gt;<br/>            &lt;compilerStartOption&gt;<strong class="ky hz">-I</strong>&lt;/compilerStartOption&gt;        <br/>            &lt;compilerStartOption&gt;<br/>                   <strong class="ky hz">${env.JAVA_HOME}/include</strong><br/>            &lt;/compilerStartOption&gt;<br/>            &lt;compilerStartOption&gt;<strong class="ky hz">-I</strong>&lt;/compilerStartOption&gt;     <br/>            &lt;compilerStartOption&gt;<br/>                   <strong class="ky hz">${env.JAVA_HOME}/include/darwin</strong><br/>            &lt;/compilerStartOption&gt;<br/>          &lt;/compilerStartOptions&gt;<br/>          &lt;linkerOutputDirectory&gt;<strong class="ky hz">target</strong>&lt;/linkerOutputDirectory&gt;<br/>          &lt;linkerExecutable&gt;<strong class="ky hz">gcc</strong>&lt;/linkerExecutable&gt;<br/>          <strong class="ky hz"><em class="lg">&lt;!-- linker options --&gt;<br/>          </em></strong>&lt;linkerStartOptions&gt;<br/>            &lt;linkerStartOption&gt;<strong class="ky hz">-m64</strong>&lt;/linkerStartOption&gt;<br/>            &lt;linkerStartOption&gt;<strong class="ky hz">-shared</strong>&lt;/linkerStartOption&gt;<br/>          &lt;/linkerStartOptions&gt;<br/>          &lt;linkerEndOptions&gt;<br/>            &lt;linkerEndOption&gt;<br/>              <strong class="ky hz">-o ${project.build.directory}/${lib_name}</strong><br/>            &lt;/linkerEndOption&gt;<br/>          &lt;/linkerEndOptions&gt;<br/>        &lt;/configuration&gt;<br/>        &lt;executions&gt;<br/>          &lt;execution&gt;<br/>            &lt;id&gt;<strong class="ky hz">javah</strong>&lt;/id&gt;<br/>            &lt;phase&gt;<strong class="ky hz">compile</strong>&lt;/phase&gt;<br/>            &lt;goals&gt;<br/>              &lt;goal&gt;<strong class="ky hz">initialize</strong>&lt;/goal&gt;<br/>              &lt;goal&gt;<strong class="ky hz">compile</strong>&lt;/goal&gt;<br/>              &lt;goal&gt;<strong class="ky hz">link</strong>&lt;/goal&gt;<br/>            &lt;/goals&gt;<br/>          &lt;/execution&gt;<br/>        &lt;/executions&gt;<br/>      &lt;/plugin&gt;<br/>    &lt;/plugins&gt;<br/>  &lt;/build&gt;<br/>&lt;/profile&gt;</span></pre><h2 id="19f8" class="jt ju hy bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">Windows 10 (Visual Studio 2017)配置</h2><p id="e9c9" class="pw-post-body-paragraph iv iw hy ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">遗憾的是，<strong class="ix hz">原生Maven插件</strong> <a class="ae hv" href="https://www.mojohaus.org/maven-native/native-maven-plugin/envfactory.html" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hz">并没有为比MSVC2013 </strong>更新的MSVC <strong class="ix hz">提供</strong> </a> <strong class="ix hz"> </strong>环境工厂，所以我为MSVC2017x64  创建了自己的工厂。<strong class="ix hz"> </strong>你需要克隆<a class="ae hv" href="https://github.com/dredwardhyde/visual-studio-2017-support" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hz">这个</strong> </a> <strong class="ix hz">仓库，使用<em class="lg"> mvn install </em>命令<em class="lg">编译安装。</em>T25】</strong></p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="1a9c" class="jt ju hy ky b fi lc ld l le lf">&lt;profile&gt;<br/>  &lt;id&gt;<strong class="ky hz">windows</strong>&lt;/id&gt;<br/>  &lt;activation&gt;<br/>    &lt;os&gt;<br/>      &lt;family&gt;<strong class="ky hz">windows</strong>&lt;/family&gt;<br/>    &lt;/os&gt;<br/>  &lt;/activation&gt;<br/>  &lt;properties&gt;<br/>    &lt;os_name&gt;<strong class="ky hz">windows</strong>&lt;/os_name&gt;<br/>    <strong class="ky hz"><em class="lg">&lt;!-- note that the libary name differs <br/>         from the macOS configuration--&gt;   <br/>    </em></strong>&lt;lib_name&gt;<strong class="ky hz">jnilibrary</strong>&lt;/lib_name&gt;<br/>  &lt;/properties&gt;<br/>  &lt;build&gt;<br/>    &lt;plugins&gt;<br/>      &lt;plugin&gt;<br/>        &lt;groupId&gt;<strong class="ky hz">org.codehaus.mojo</strong>&lt;/groupId&gt;<br/>        &lt;artifactId&gt;<strong class="ky hz">native-maven-plugin</strong>&lt;/artifactId&gt;<br/>        &lt;version&gt;<strong class="ky hz">1.0-alpha-11</strong>&lt;/version&gt;<br/>        &lt;extensions&gt;<strong class="ky hz">true</strong>&lt;/extensions&gt;<br/>        &lt;dependencies&gt;<br/>          &lt;dependency&gt;<br/>            &lt;groupId&gt;<strong class="ky hz">com.edwardhyde</strong>&lt;/groupId&gt;<br/>            &lt;artifactId&gt;<strong class="ky hz">vc-2017-support</strong>&lt;/artifactId&gt;<br/>            &lt;version&gt;<strong class="ky hz">1.0-SNAPSHOT</strong>&lt;/version&gt;<br/>          &lt;/dependency&gt;<br/>        &lt;/dependencies&gt;<br/>        &lt;configuration&gt;<br/>          &lt;javahOS&gt;<strong class="ky hz">${os_name}</strong>&lt;/javahOS&gt;<br/>          &lt;compilerProvider&gt;<strong class="ky hz">msvc</strong>&lt;/compilerProvider&gt;<br/>          <strong class="ky hz"><em class="lg">&lt;!-- custom environment factory for MSVC2017--&gt; <br/>          </em></strong>&lt;envFactoryName&gt;<br/>              <strong class="ky hz">com.edwardhyde.MSVC2017x64EnvFactory</strong><br/>          &lt;/envFactoryName&gt;<br/>          &lt;sources&gt;<br/>            &lt;source&gt;<br/>              &lt;directory&gt;<strong class="ky hz">src/native/source</strong>&lt;/directory&gt;<br/>              &lt;fileNames&gt;<br/>                &lt;fileName&gt;<strong class="ky hz">jni.c</strong>&lt;/fileName&gt;<br/>              &lt;/fileNames&gt;<br/>            &lt;/source&gt;<br/>            &lt;source&gt;<br/>              &lt;directory&gt;<strong class="ky hz">src/native/include</strong>&lt;/directory&gt;<br/>            &lt;/source&gt;<br/>          &lt;/sources&gt;<br/>          &lt;compilerProvider&gt;<strong class="ky hz">msvc</strong>&lt;/compilerProvider&gt;<br/>          &lt;compilerStartOptions&gt;<br/>            <strong class="ky hz"><em class="lg">&lt;!-- create DLL--&gt;</em></strong>             <br/>            &lt;compilerStartOption&gt;<strong class="ky hz">/LD</strong>&lt;/compilerStartOption&gt;<br/>            &lt;compilerStartOption&gt;<strong class="ky hz">/MD</strong>&lt;/compilerStartOption&gt;<br/>            &lt;compilerStartOption&gt;<strong class="ky hz">-I</strong>&lt;/compilerStartOption&gt;<br/>            &lt;compilerStartOption&gt;<br/>                   <strong class="ky hz">${env.JAVA_HOME}\include</strong><br/>            &lt;/compilerStartOption&gt;<br/>            &lt;compilerStartOption&gt;<strong class="ky hz">-I</strong>&lt;/compilerStartOption&gt;  <br/>            &lt;compilerStartOption&gt;<br/>                   <strong class="ky hz">${env.JAVA_HOME}\include\win32</strong><br/>            &lt;/compilerStartOption&gt;<br/>          &lt;/compilerStartOptions&gt;<br/>          &lt;linkerOutputDirectory&gt;<strong class="ky hz">target</strong>&lt;/linkerOutputDirectory&gt;<br/>          &lt;linkerProvider&gt;<strong class="ky hz">msvc</strong>&lt;/linkerProvider&gt;<br/>          &lt;linkerFinalName&gt;<strong class="ky hz">${lib_name}</strong>&lt;/linkerFinalName&gt;<br/>          &lt;linkerFinalNameExt&gt;<strong class="ky hz">dll</strong>&lt;/linkerFinalNameExt&gt;<br/>          &lt;linkerStartOptions&gt;<br/>            &lt;linkerStartOption&gt;<strong class="ky hz">/INCREMENTAL:NO</strong>&lt;/linkerStartOption&gt;<br/>            &lt;linkerStartOption&gt;<strong class="ky hz">/DLL</strong>&lt;/linkerStartOption&gt;<br/>          &lt;/linkerStartOptions&gt;<br/>        &lt;/configuration&gt;<br/>        &lt;executions&gt;<br/>          &lt;execution&gt;<br/>            &lt;id&gt;<strong class="ky hz">javah</strong>&lt;/id&gt;<br/>            &lt;phase&gt;<strong class="ky hz">compile</strong>&lt;/phase&gt;<br/>            &lt;goals&gt;<br/>              &lt;goal&gt;<strong class="ky hz">initialize</strong>&lt;/goal&gt;<br/>              &lt;goal&gt;<strong class="ky hz">compile</strong>&lt;/goal&gt;<br/>              &lt;goal&gt;<strong class="ky hz">link</strong>&lt;/goal&gt;<br/>            &lt;/goals&gt;<br/>          &lt;/execution&gt;<br/>        &lt;/executions&gt;<br/>      &lt;/plugin&gt;<br/>    &lt;/plugins&gt;<br/>  &lt;/build&gt;<br/>&lt;/profile&gt;</span></pre><p id="662f" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果要从<strong class="ix hz"> Java </strong>中调用<strong class="ix hz"> C/C++ </strong> native函数，需要将需要的方法标记为native，并使用<a class="ae hv" href="https://docs.oracle.com/javase/8/docs/technotes/tools/windows/javah.html" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hz"> javah </strong> </a> <strong class="ix hz">(或者JDK9+ </strong>中的javac -h)命令行工具生成<strong class="ix hz"> JNI </strong>头。</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="53bf" class="jt ju hy ky b fi lc ld l le lf"><strong class="ky hz">package </strong>com.jni.example;<br/><br/><strong class="ky hz">public class </strong>JniWrapper {<br/>    <strong class="ky hz">public native </strong>String getString();<br/>}</span></pre><p id="1ece" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">但是我们可以使用<a class="ae hv" href="https://www.mojohaus.org/exec-maven-plugin/" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hz"> Exec Maven插件</strong> </a> <strong class="ix hz"> : </strong>来实现</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="5196" class="jt ju hy ky b fi lc ld l le lf">&lt;plugins&gt;<br/>  &lt;plugin&gt;<br/>    &lt;groupId&gt;<strong class="ky hz">org.codehaus.mojo</strong>&lt;/groupId&gt;<br/>    &lt;artifactId&gt;<strong class="ky hz">exec-maven-plugin</strong>&lt;/artifactId&gt;<br/>    &lt;version&gt;<strong class="ky hz">1.5.0</strong>&lt;/version&gt;<br/>    &lt;executions&gt;<br/>      &lt;execution&gt;<br/>        &lt;id&gt;<strong class="ky hz">generate-jni-headers</strong>&lt;/id&gt;<br/>        &lt;phase&gt;<strong class="ky hz">generate-sources</strong>&lt;/phase&gt;<br/>        &lt;goals&gt;<br/>          &lt;goal&gt;<strong class="ky hz">exec</strong>&lt;/goal&gt;<br/>        &lt;/goals&gt;<br/>        &lt;configuration&gt;<br/>          &lt;workingDirectory&gt;<strong class="ky hz">${project.basedir}</strong>&lt;/workingDirectory&gt;<br/>          &lt;executable&gt;<strong class="ky hz">javah</strong>&lt;/executable&gt;<br/>          &lt;arguments&gt;<br/>            &lt;argument&gt;<strong class="ky hz">-verbose</strong>&lt;/argument&gt;<br/>            &lt;argument&gt;<strong class="ky hz">-jni</strong>&lt;/argument&gt;<br/>            &lt;argument&gt;<strong class="ky hz">-classpath</strong>&lt;/argument&gt;<br/>            &lt;argument&gt;<strong class="ky hz">${project.build.sourceDirectory}</strong>&lt;/argument&gt;<br/>            &lt;argument&gt;<strong class="ky hz">-d</strong>&lt;/argument&gt;<br/>            <strong class="ky hz"><em class="lg">&lt;!-- directory where generated header will be placed --&gt;<br/></em></strong>            &lt;argument&gt;<br/>                 <strong class="ky hz">${project.basedir}/src/native/include</strong><br/>            &lt;/argument&gt;<br/>            <strong class="ky hz"><em class="lg">&lt;!-- target class--&gt;  <br/>            </em></strong>&lt;argument&gt;<strong class="ky hz">com.jni.example.JniWrapper</strong>&lt;/argument&gt;<br/>          &lt;/arguments&gt;<br/>        &lt;/configuration&gt;<br/>      &lt;/execution&gt;<br/>    &lt;/executions&gt;<br/>  &lt;/plugin&gt;<br/>&lt;/plugins&gt;</span></pre><p id="4e05" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">因此，<strong class="ix hz">com _ JNI _ example _ JNI wrapper . h</strong>将被创建<strong class="ix hz"> : </strong></p><figure class="kt ku kv kw fd hk er es paragraph-image"><div class="er es lh"><img src="../Images/dbc6ced5e25e8d11bf0e051d9a00b1e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:706/format:webp/1*hO9L05gU1ix16_xJmJlufQ.png"/></div><figcaption class="hr hs et er es ht hu bd b be z dx">Project structure</figcaption></figure><p id="8aff" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">正如你在这里看到的，每个<strong class="ix hz"> JNI </strong>方法至少有两个参数:</p><ul class=""><li id="bb1e" class="li lj hy ix b iy iz jc jd jg lk jk ll jo lm js ln lo lp lq bi translated"><strong class="ix hz"> JNIEnv <em class="lg"> — </em> </strong>一个<strong class="ix hz"> <em class="lg"> </em> </strong>指针指向一个存储所有<strong class="ix hz"> JNI </strong>函数指针的结构。</li><li id="96d5" class="li lj hy ix b iy lr jc ls jg lt jk lu jo lv js ln lo lp lq bi translated"><strong class="ix hz">job object—</strong>一个<strong class="ix hz"> </strong>对该方法附加到的Java对象的引用(我们的<strong class="ix hz"> <em class="lg"> JniWrapper </em> </strong>类的实例)。</li></ul><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="08f9" class="jt ju hy ky b fi lc ld l le lf"><em class="lg">/* DO NOT EDIT THIS FILE - it is machine generated */<br/></em><strong class="ky hz">#include </strong>&lt;jni.h&gt;<br/><em class="lg">/* Header for class com_jni_example_JniWrapper */<br/><br/></em><strong class="ky hz">#ifndef </strong>_Included_com_jni_example_JniWrapper<br/><strong class="ky hz">#define </strong>_Included_com_jni_example_JniWrapper<br/><strong class="ky hz">#ifdef </strong>__cplusplus<br/><strong class="ky hz">extern "C" </strong>{<br/><strong class="ky hz">#endif<br/></strong><em class="lg">/*<br/> * Class:     com_jni_example_JniWrapper<br/> * Method:    getString<br/> * Signature: ()Ljava/lang/String;<br/> */<br/></em><strong class="ky hz">JNIEXPORT jstring JNICALL <br/>Java_com_jni_example_JniWrapper_getString(JNIEnv *, jobject);</strong><br/><br/><strong class="ky hz">#ifdef </strong>__cplusplus<br/>}<br/><strong class="ky hz">#endif<br/>#endif</strong></span></pre><p id="a388" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在我们需要实现我们的本机<strong class="ix hz"> getString() </strong>方法。在这里，我将举例说明如何调用<strong class="ix hz">静态和实例方法，用本地代码创建Java对象，以及更多内容:</strong></p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="5abe" class="jt ju hy ky b fi lc ld l le lf"><strong class="ky hz">#include "com_jni_example_JniWrapper.h"<br/>#include </strong>&lt;stdio.h&gt;<br/><br/><strong class="ky hz">#define </strong>STRING_RETURN <strong class="ky hz">"Hello world!"<br/>#define </strong>STRING_CALLBACK <strong class="ky hz">"Hello world callback!"<br/>#define </strong>STRING_CALLBACK_STATIC <strong class="ky hz">"Hello world static callback!"<br/>#define </strong>STRING_PAYLOAD <strong class="ky hz">"Simple payload string"<br/><br/>JNIEXPORT jstring JNICALL Java_com_jni_example_JniWrapper_getString(JNIEnv *env, <br/>                                          jobject thiz) {<br/>    // get the class of an object</strong><br/>    jclass cls_foo = (*env)-&gt;GetObjectClass(<strong class="ky hz">env, thiz</strong>);</span><span id="226f" class="jt ju hy ky b fi lw ld l le lf">    <strong class="ky hz">//</strong> <strong class="ky hz"><em class="lg">callback </em>instance method with one <em class="lg">String </em>parameter <br/>    // and <em class="lg">void </em>result    <br/>    </strong>jmethodID callback = (*env)-&gt;GetMethodID(<strong class="ky hz">env</strong>,<br/>                                           <strong class="ky hz">cls_foo</strong>, <br/>                                           <strong class="ky hz">"callback"</strong>, <br/>                                           <strong class="ky hz">"(Ljava/lang/String;)V"</strong>);</span><span id="33dd" class="jt ju hy ky b fi lw ld l le lf"><strong class="ky hz">    //</strong> <strong class="ky hz"><em class="lg">callbackObject </em>instance method with one <br/>    // <em class="lg">List&lt;String&gt; arrayList</em></strong> <strong class="ky hz">parameter and <em class="lg">String </em>result</strong><br/>    jmethodID callbackWithObject = (*env)-&gt;GetMethodID(<strong class="ky hz">env</strong>,<br/>                             <strong class="ky hz">cls_foo</strong>,<br/>                            <strong class="ky hz">"callbackObject"</strong>,<br/>                            <strong class="ky hz">"(Ljava/util/List;)Ljava/lang/String;"</strong>);</span><span id="3f9b" class="jt ju hy ky b fi lw ld l le lf"><strong class="ky hz">    //</strong> <strong class="ky hz"><em class="lg">callback </em>static<em class="lg"> </em>method with one <em class="lg">String </em>parameter <br/>    // and <em class="lg">void </em>result<br/></strong>    jmethodID callbackStatic = (*env)-&gt;GetStaticMethodID(<strong class="ky hz">env</strong>,<br/>                                           <strong class="ky hz">cls_foo</strong>,<br/>                                           <strong class="ky hz">"callbackStatic"</strong>,<br/>                                           <strong class="ky hz">"(Ljava/lang/String;)V"</strong>);</span><span id="77e0" class="jt ju hy ky b fi lw ld l le lf"><strong class="ky hz">    // construct a new </strong><strong class="ky hz"><em class="lg">java.lang.String</em></strong><strong class="ky hz"> objects from <br/>    // an array of characters in UTF-8 encoding</strong><br/>    jstring jStringRegular = (*env)-&gt;NewStringUTF(<strong class="ky hz">env</strong>,<br/>                                           <strong class="ky hz">STRING_CALLBACK</strong>);<br/><br/>    jstring jStringStatic = (*env)-&gt;NewStringUTF(<strong class="ky hz">env</strong>,<br/>                                           <strong class="ky hz">STRING_CALLBACK_STATIC</strong>);</span><span id="f29e" class="jt ju hy ky b fi lw ld l le lf">    <strong class="ky hz">// call instance method with <em class="lg">void </em>result</strong><br/>    (*env)-&gt;CallVoidMethod(<strong class="ky hz">env, thiz, callback, jStringRegular</strong>);</span><span id="03ec" class="jt ju hy ky b fi lw ld l le lf"><strong class="ky hz">    // call static instance method with <em class="lg">void </em>result  <br/>    </strong>(*env)-&gt;CallStaticVoidMethod(<strong class="ky hz">env, <br/>                                 thiz, </strong><br/>                                 <strong class="ky hz">callbackStatic, <br/>                                 jStringStatic</strong>);</span><span id="7815" class="jt ju hy ky b fi lw ld l le lf">    <strong class="ky hz">// delete the local references</strong><br/>    (*env)-&gt;DeleteLocalRef(<strong class="ky hz">env, jStringRegular</strong>);</span><span id="dbdd" class="jt ju hy ky b fi lw ld l le lf">    (*env)-&gt;DeleteLocalRef(<strong class="ky hz">env, jStringStatic</strong>);<br/><br/>    jclass cls = (*env)-&gt;FindClass(<strong class="ky hz">env, "java/util/ArrayList"</strong>);</span><span id="29f3" class="jt ju hy ky b fi lw ld l le lf">    <strong class="ky hz">// get the default constructor for <em class="lg">java.util.ArrayList</em> class<br/>    </strong>jmethodID constructor = (*env)-&gt;GetMethodID(<strong class="ky hz">env, <br/>                                                cls, <br/>                                                "&lt;init&gt;"</strong>, <br/>                                                <strong class="ky hz">"()V"</strong>);</span><span id="3985" class="jt ju hy ky b fi lw ld l le lf">    <strong class="ky hz">// create a new instance of <em class="lg">java.util.ArrayList</em></strong><br/>    jobject arraylist = (*env)-&gt;NewObject(<strong class="ky hz">env, cls, constructor</strong>);<br/><br/>    jstring jStringPayload = (*env)-&gt;NewStringUTF(<strong class="ky hz">env,  <br/>                                                  STRING_PAYLOAD</strong>);<br/>    <strong class="ky hz">// get the <em class="lg">add </em>method</strong><br/>    jmethodID addMethod = (*env)-&gt;GetMethodID(<strong class="ky hz">env, <br/>                                           cls,</strong> <br/>                                           <strong class="ky hz">"add"</strong>, <br/>                                           <strong class="ky hz">"(Ljava/lang/Object;)Z"</strong>);</span><span id="7340" class="jt ju hy ky b fi lw ld l le lf">    <strong class="ky hz">// call the <em class="lg">add </em>method that returns <em class="lg">boolean <br/></em></strong>    (*env)-&gt;CallBooleanMethod(<strong class="ky hz">env, arraylist,</strong> <br/>                             <strong class="ky hz">addMethod, jStringPayload</strong>);<br/></span><span id="5abc" class="jt ju hy ky b fi lw ld l le lf"><strong class="ky hz">    // call the <em class="lg">callbackObject </em>method that returns <em class="lg">String</em></strong><br/>    jobject resultString = (*env)-&gt;CallObjectMethod(<strong class="ky hz">env,</strong> <br/>                                                 <strong class="ky hz">thiz, </strong><br/>                                                 <strong class="ky hz">callbackWithObject,</strong><br/>                                                 <strong class="ky hz">arraylist</strong>);<br/>    <strong class="ky hz">// convert the <em class="lg">jobject to</em></strong><em class="lg"> </em><strong class="ky hz">an array of characters<br/>    </strong>const char* str = (*env)-&gt;GetStringUTFChars(<strong class="ky hz">env,</strong> <br/>                                             <strong class="ky hz">(jstring) resultString,</strong><br/>                                                <strong class="ky hz">NULL</strong>);<br/>    <strong class="ky hz">// print returned string</strong><br/>    printf(str);</span><span id="8cfc" class="jt ju hy ky b fi lw ld l le lf">    (*env)-&gt;ReleaseStringUTFChars(<strong class="ky hz">env, resultString, str</strong>);</span><span id="80ad" class="jt ju hy ky b fi lw ld l le lf">    (*env)-&gt;DeleteLocalRef(<strong class="ky hz">env, jStringPayload</strong>);</span><span id="2c8c" class="jt ju hy ky b fi lw ld l le lf">    (*env)-&gt;DeleteLocalRef(<strong class="ky hz">env, arraylist</strong>);<br/><br/>    <strong class="ky hz">return </strong>(*env)-&gt;NewStringUTF(<strong class="ky hz">env, STRING_RETURN</strong>);<br/>}</span></pre><p id="11b1" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最后，让我们在<strong class="ix hz"> <em class="lg"> JniWrapper </em> </strong>类中实现相应的<strong class="ix hz"> Java </strong>方法，一起测试一切:</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="e827" class="jt ju hy ky b fi lc ld l le lf"><strong class="ky hz">package com.jni.example;</strong><br/><br/>import java.util.<em class="lg">List</em>;<br/><br/>@SuppressWarnings("unused")<br/><strong class="ky hz">public class JniWrapper {</strong><br/>    <strong class="ky hz">private static final String <em class="lg">LIB_NAME </em>= "jnilibrary";<br/><br/>    static {<br/>        // load the native library<br/>        System.<em class="lg">loadLibrary</em>(<em class="lg">LIB_NAME</em>);<br/>    }<br/></strong><br/>    <strong class="ky hz">public static void callbackStatic(String string)</strong> {<br/>        System.<em class="lg">out</em>.println("Static callback: " + string);<br/>    }<br/><br/>    <strong class="ky hz">public native String getString()</strong>;<br/><br/>    <strong class="ky hz">public void callback(String string)</strong> {<br/>        System.<em class="lg">out</em>.println("Callback: " + string);<br/>    }<br/><br/>    <strong class="ky hz">public String callbackObject(<em class="lg">List</em>&lt;String&gt; arrayList)</strong> {<br/>        System.<em class="lg">out</em>.println("Callback object with size: "<br/>                + arrayList.size()<br/>                + " and payload: "<br/>                + arrayList.get(0));<br/>        <strong class="ky hz">return arrayList.get(0);</strong><br/>    }<br/><br/>    <strong class="ky hz">public static void main(String[] args)</strong> {<br/>        JniWrapper jni = new JniWrapper();<br/>        System.<em class="lg">out</em>.println(jni.getString());<br/>    }<br/>}</span></pre><p id="a4fa" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hz">现在运行<em class="lg"> JniWrapper.main() </em>方法，其中<em class="lg">-djava . library . path</em>JVM选项指向<em class="lg">目标</em>目录:</strong></p><figure class="kt ku kv kw fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lx"><img src="../Images/591a26f150352d42f1ddef40f60090ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DN5c2ziqLWx1J7Exq82AQg.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">Execution results</figcaption></figure></div></div>    
</body>
</html>