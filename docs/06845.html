<html>
<head>
<title>Dynamic search/filter query based on user inputs with Hibernate, MySQL, Spring Boot</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基于用户输入的动态搜索/过滤查询</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/dynamic-search-filter-query-based-on-user-inputs-with-hibernate-mysql-spring-boot-85e842dcf8d?source=collection_archive---------3-----------------------#2021-08-31">https://medium.com/geekculture/dynamic-search-filter-query-based-on-user-inputs-with-hibernate-mysql-spring-boot-85e842dcf8d?source=collection_archive---------3-----------------------#2021-08-31</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="8ae0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">编程之前，我不懂在网上编码模因…</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/0ba5b54b6f53e431423e59d8c67f645b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/0*pWyXfHLcWCHhTdCv.png"/></div></figure><p id="b507" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">…直到我有机会和一个喜欢优化代码的人一起工作。</p><p id="01a7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们项目的一个特点是基于多个输入做一个复杂的过滤，他把这个任务交给了我。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es jl"><img src="../Images/f90584598eff37e8ed8e190e0c5c8857.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*3v0kOFAk0AUMzlvakIEiXQ.gif"/></div></div></figure><p id="b1ef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以基本上，用户可以根据标签、创建时间进行过滤，也可以根据最新/最早的帖子/评论进行排序。有最新评论的帖子总是显示在最前面。</p><p id="0484" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我用Collections和Stream只用了一天就完成了。在测试了所有场景之后，它运行得很好，我自信地提出了一个拉请求，并认为我会睡个好觉。</p><p id="d2c0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，他在午夜给我发了一条消息，说他拒绝接受我的拉请求，因为我的代码不可伸缩，性能也不好。</p><p id="a78d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">“尽量用JPA和Hibernate代替核心Java，性能更好。他说:“你可以在弗拉德·米哈尔恰和T2·索本·让桑的博客文章中读到更多。”。</p><p id="8e40" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为不是从学校学的，一开始很不适应，也很怀疑。更重要的是，如果我改用他的解决方案，我需要删除我的整行代码。</p><blockquote class="jr js jt"><p id="cb08" class="if ig ju ih b ii ij ik il im in io ip jv ir is it jw iv iw ix jx iz ja jb jc hb bi translated">我的重要经验是:在开始编码之前，一定要讨论解决方案</p></blockquote><p id="b415" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">那天晚上我没睡好。看了那两个冬眠大师的帖子，我想也许我的队友是对的，我应该按照他的方向走。</p><p id="1dcb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这项任务有两个主要步骤:</p><ol class=""><li id="44bc" class="jy jz hi ih b ii ij im in iq ka iu kb iy kc jc kd ke kf kg bi translated">编写复杂的SQL查询来按排序顺序生成结果。</li><li id="6c2e" class="jy jz hi ih b ii kh im ki iq kj iu kk iy kl jc kd ke kf kg bi translated">基于用户的输入动态地进行查询(不管输入或排序类型是什么，我只需要一个函数来执行这个任务)。</li></ol><p id="8c04" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">编写复杂的SQL查询来生成排序后的结果。</strong></p><p id="4520" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这一步最棘手的是让有评论的帖子先出现，并显示他们最新的评论者。没有任何评论的帖子，即使是最近创建的，也不会被优先考虑。</p><p id="27a6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我利用我在连接、别名表、条件语句方面的知识来生成如下查询:</p><pre class="je jf jg jh fd km kn ko kp aw kq bi"><span id="ff49" class="kr ks hi kn b fi kt ku l kv kw">SELECT <br/>  * <br/>FROM <br/>  posts p <br/>  LEFT JOIN (<br/>    SELECT <br/>      c.post_id AS belongPost, <br/>      MAX(created_on) AS COMMENT <br/>    FROM <br/>      comments c <br/>    GROUP BY <br/>      belongPost<br/>  ) AS TEMP ON TEMP.belongPost = p.post_id <br/>WHERE <br/>  p.topic_id = 'Assignment_Help' <br/>  AND p.status = 'ACCEPTED' <br/>  AND p.post_tags LIKE "%%" <br/>  AND p.created_on &gt;= 2020 - 12 - 31 <br/>  AND p.created_on &lt;= 2021 - 08 - 30 <br/>ORDER BY <br/>  IF(TEMP.COMMENT IS NULL, 1, 0), <br/>  TEMP.COMMENT desc, <br/>  p.created_on desc;</span></pre><p id="75f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如此庞大的查询！！！</p><p id="87ba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">根据用户的输入进行动态查询</strong></p><p id="53dd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="ju">低性能方法:</em> </strong>如果我不使用动态查询，我需要创建04个其他查询来完成这项任务(升序sortByPost，降序sortByPosts，升序sortByComments和降序sortByComments)。</p><p id="a300" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="ju">更好的解决方案:</em> </strong>使用动态查询</p><p id="9371" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我创建了另一个CustomPostRepository，并且我的PostRepository扩展了CustomPostRepository。</p><pre class="je jf jg jh fd km kn ko kp aw kq bi"><span id="4e31" class="kr ks hi kn b fi kt ku l kv kw">@Repository<br/>public interface PostRepository extends JpaRepository&lt;Post,Integer&gt;,CustomPostRepository{     <br/> // Other functions<br/>}</span></pre><p id="a64d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在CustomPostRepository中，我将函数的签名放在这里:</p><pre class="je jf jg jh fd km kn ko kp aw kq bi"><span id="7ece" class="kr ks hi kn b fi kt ku l kv kw">public interface CustomPostRepository {</span><span id="3227" class="kr ks hi kn b fi kx ku l kv kw">    List&lt;Post&gt; filterPostsBasedOnKeywords(<br/>            String topicID, <br/>            String tags, <br/>            String start, <br/>            String end, <br/>            String sortBy, <br/>            String order, <br/>            Pageable pageable);<br/>}</span></pre><p id="4db6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我将CustomPostRepository设计成一个包含所有动态功能/查询的接口；所以我用PostRepository把它分开了。并且因为PostRepository扩展了custompostportrepository，所以我可以通过注入的PostRepository实例访问custompostportrepository的方法。这个设计遵循了我从<a class="ae jq" href="https://javarevisited.blogspot.com/#axzz759A3LTNj" rel="noopener ugc nofollow" target="_blank">Java reviewed</a>那里学来的立体开/闭原理。</p><p id="7da4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我创建了实现CustomPostRepositoryImpl接口的custompostrepostorypl类。神奇的事情发生了:</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="ky kz l"/></div></figure><p id="c1bf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个想法是根据用户的输入(按升序/降序、帖子/评论排序)使用StringBuilder创建一个动态字符串。然后，</p><pre class="je jf jg jh fd km kn ko kp aw kq bi"><span id="fe8f" class="kr ks hi kn b fi kt ku l kv kw">Query q = entityManager.createNativeQuery(sb.toString(),Post.class);</span></pre><p id="ad30" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">会将该字符串转换为原生查询，而q . get result list()；帮助获取结果列表。</p><p id="323d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，它可以工作，并且比我的旧Java核心解决方案快一点(我想如果我的数据库中有数千条记录，差异会更明显)。</p><p id="c1ac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">顺便说一句，感谢我的队友对代码和对我的严格要求。</p><p id="78bd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">源代码:【https://github.com/trangntt-016/seneca-forum-backend T2】</p><p id="1747" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">如果你喜欢这篇文章，请鼓掌</strong>👏<strong class="ih hj">并分享出来，让别人也能找到！</strong>😄。</p></div></div>    
</body>
</html>