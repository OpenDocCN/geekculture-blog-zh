<html>
<head>
<title>Production-ready CICD setup with Azure DevOps, AWS, and Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Azure DevOps、AWS和Terraform进行生产就绪型CICD设置</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/production-ready-cicd-setup-with-azure-devops-aws-and-terraform-4c87bdef3e41?source=collection_archive---------1-----------------------#2021-11-01">https://medium.com/geekculture/production-ready-cicd-setup-with-azure-devops-aws-and-terraform-4c87bdef3e41?source=collection_archive---------1-----------------------#2021-11-01</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="20e5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">持续集成和持续部署是现代敏捷开发环境中的常见做法，这个概念本身并没有一个固定的、放之四海而皆准的解决方案。它要求你在CICD的核心理念和价值观下进行实践和调整，并适应你自己的流程。这很容易上手，但需要在规划、设计和协作方面付出大量努力，才能让它很好地适应您的环境。在本文中，我们将探索使用Azure DevOps平台的生产就绪CICD设置，使用Terraform部署到AWS环境中。</p></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><h1 id="2ddb" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">为什么选择Azure DevOps和AWS</h1><p id="7a6b" class="pw-post-body-paragraph if ig hi ih b ii ki ik il im kj io ip iq kk is it iu kl iw ix iy km ja jb jc hb bi translated">在我们开始之前，人们会奇怪为什么我们不使用AWS服务来设置CICD。主要原因是Azure DevOps为开发团队提供了完全集成的体验，它涵盖了从问题和票证管理、开发、测试和部署的工作流。一个完全集成的平台允许团队将他们需要的一切集中在一个地方，并减少了环境切换时浪费的资源。</p></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><h1 id="e468" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">你希望知道什么</h1><p id="381c" class="pw-post-body-paragraph if ig hi ih b ii ki ik il im kj io ip iq kk is it iu kl iw ix iy km ja jb jc hb bi translated">这个故事不会教你CICD的基本知识。CICD是一个非常常见的话题，你可以很容易地在其他地方搜索到大量相同的信息。在这个故事中，我们关注运行可伸缩和可维护的CICD架构的高级选项。您应该知道以下内容</p><ol class=""><li id="ee6f" class="kn ko hi ih b ii ij im in iq kp iu kq iy kr jc ks kt ku kv bi translated">基本的CICD知识</li><li id="59ec" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated">基本Yaml脚本</li><li id="347f" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated">基本地形脚本</li><li id="0f8d" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated">基本Azure DevOps配置</li><li id="b921" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated">AWS Elastics集装箱服务的工作经验</li><li id="da3a" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated">码头工人的工作经验</li><li id="ab08" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated">了解微服务概念</li><li id="ad35" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated">了解12因素App原则</li><li id="e665" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated">任何分支战略的工作经验</li></ol><h1 id="7fd9" class="jk jl hi bd jm jn lb jp jq jr lc jt ju jv ld jx jy jz le kb kc kd lf kf kg kh bi translated">项目先决条件</h1><p id="c505" class="pw-post-body-paragraph if ig hi ih b ii ki ik il im kj io ip iq kk is it iu kl iw ix iy km ja jb jc hb bi translated">如果您想按照步骤操作，您需要以下工具和设置:-</p><ol class=""><li id="4e2f" class="kn ko hi ih b ii ij im in iq kp iu kq iy kr jc ks kt ku kv bi translated">Azure DevOps帐户</li><li id="810d" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated">AWS帐户</li><li id="3349" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated">已安装Terraform 1.0+版本</li><li id="413f" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated">已安装码头</li></ol></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><h1 id="4ae8" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">示例项目</h1><p id="1100" class="pw-post-body-paragraph if ig hi ih b ii ki ik il im kj io ip iq kk is it iu kl iw ix iy km ja jb jc hb bi translated">这篇文章将从<a class="ae lg" href="https://github.com/jazztong/node-micro-app-demo" rel="noopener ugc nofollow" target="_blank">到</a>使用一个示例项目。以便我们能够按照项目要求配置CICD。示例应用<strong class="ih hj"> <em class="lh">节点-微应用-演示</em> </strong>由两个API组成，产品API和用户API。它是使用NodeJS Express Backend和TypeScript开发的。每个服务都可以使用Postgres和<a class="ae lg" href="https://www.prisma.io/" rel="noopener ugc nofollow" target="_blank"> Prisma </a>框架访问自己的数据存储。</p><div class="li lj ez fb lk ll"><a href="https://github.com/jazztong/node-micro-app-demo" rel="noopener  ugc nofollow" target="_blank"><div class="lm ab dw"><div class="ln ab lo cl cj lp"><h2 class="bd hj fi z dy lq ea eb lr ed ef hh bi translated">GitHub-jazz tong/node-micro-app-demo:一个示例nodejs微服务演示应用程序</h2><div class="ls l"><h3 class="bd b fi z dy lq ea eb lr ed ef dx translated">一个示例nodejs微服务演示应用程序运行docker Run-d-e POSTGRES _ PASSWORD = PASSWORD-p 5432:5432 POSTGRES…</h3></div><div class="lt l"><p class="bd b fp z dy lq ea eb lr ed ef dx translated">github.com</p></div></div><div class="lu l"><div class="lv l lw lx ly lu lz ma ll"/></div></div></a></div><h1 id="d476" class="jk jl hi bd jm jn lb jp jq jr lc jt ju jv ld jx jy jz le kb kc kd lf kf kg kh bi translated">高层次目标</h1><p id="81cd" class="pw-post-body-paragraph if ig hi ih b ii ki ik il im kj io ip iq kk is it iu kl iw ix iy km ja jb jc hb bi translated">设定以下目标来控制我们的工程范围</p><ol class=""><li id="ca00" class="kn ko hi ih b ii ij im in iq kp iu kq iy kr jc ks kt ku kv bi translated">安装程序继续集成管道以验证代码更改</li><li id="b43b" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated">继续集成管道应该在代码验证后生成新的工件</li><li id="d928" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated">当新配置发生变化时，应继续部署管道</li><li id="93f2" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated">基础架构组件应该能够管理持续部署</li></ol></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><h1 id="d704" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">高级图表</h1><figure class="mc md me mf fd mg er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es mb"><img src="../Images/14f73a3a5e6adf1db8714fc85a2235ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V3HXNUhbuEcRnyhGydVxSg.png"/></div></div></figure><p id="be89" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上图解释了使用AWS ECS Fargate架构的高级集成流程。CICD架构利用Azure DevOps平台来管理源代码和管道。</p></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><h1 id="a327" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">CICD设计与规划</h1><p id="99de" class="pw-post-body-paragraph if ig hi ih b ii ki ik il im kj io ip iq kk is it iu kl iw ix iy km ja jb jc hb bi translated">我们将通过所有的设计和规划因素，给整个CICD建筑更多的背景。</p><h2 id="a5f3" class="mm jl hi bd jm mn mo mp jq mq mr ms ju iq mt mu jy iu mv mw kc iy mx my kg mz bi translated">知识库策略</h2><figure class="mc md me mf fd mg er es paragraph-image"><div class="er es na"><img src="../Images/b62c37ca6705e698eccebffcdac8e6fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1342/format:webp/0*ZS2fWCCoEIpMBFpg.jpeg"/></div><figcaption class="nb nc et er es nd ne bd b be z dx">Credit to <a class="ae lg" rel="noopener" href="/burak-tasci/full-stack-monorepo-part-i-go-services-967bb3527bb8">https://medium.com/burak-tasci/full-stack-monorepo-part-i-go-services-967bb3527bb8</a></figcaption></figure><p id="4954" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个主题提出了以下问题:-</p><ol class=""><li id="541d" class="kn ko hi ih b ii ij im in iq kp iu kq iy kr jc ks kt ku kv bi translated">我们为这个项目选择什么类型的存储库？</li><li id="c59a" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated">这个项目需要多少存储库？</li></ol><blockquote class="nf ng nh"><p id="2a0a" class="if ig lh ih b ii ij ik il im in io ip ni ir is it nj iv iw ix nk iz ja jb jc hb bi translated">回答:-</p></blockquote><ol class=""><li id="daa0" class="kn ko hi ih b ii ij im in iq kp iu kq iy kr jc ks kt ku kv bi translated">我们将为该项目使用<a class="ae lg" href="https://semaphoreci.com/blog/what-is-monorepo#:~:text=A%20monorepo%20is%20a%20version,Monorepos%20can%20reach%20colossal%20sizes." rel="noopener ugc nofollow" target="_blank"> Monorepos </a>设置。与Multirepos设置相比，Monorepos设置有很多好处，我们选择这种设置的主要好处是在执行大规模重构时简化共享模块和自动提交。当你第一次理解Monorepos时，你可能会产生疑问，但请相信我，所有的科技巨头，如<a class="ae lg" href="https://engineering.fb.com/2014/01/07/core-data/scaling-mercurial-at-facebook/" rel="noopener ugc nofollow" target="_blank">【脸书】</a>和<a class="ae lg" href="https://cacm.acm.org/magazines/2016/7/204032-why-google-stores-billions-of-lines-of-code-in-a-single-repository/fulltext" rel="noopener ugc nofollow" target="_blank">谷歌</a>都是通过Monorepos成功开发产品的。</li><li id="cd00" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated">对于这个项目，我们将有3个存储库，1个是<strong class="ih hj"/><strong class="ih hj">世界</strong>存储库，1个是<strong class="ih hj"/><strong class="ih hj">应用</strong>存储库，1个是<strong class="ih hj"/><strong class="ih hj">下</strong>存储库。<strong class="ih hj"/><strong class="ih hj">世界</strong>存储库将存储配置Azure DevOps所需的所有设置，例如管道定义、存储库权限等等，术语<strong class="ih hj">世界</strong>使用这个术语来解释这是您需要配置的第一个存储库。将应用和基础架构配置划分为不同存储库的主要原因是为了符合<a class="ae lg" href="https://12factor.net/" rel="noopener ugc nofollow" target="_blank"> 12因素应用原则</a>。准确的说是<a class="ae lg" href="https://12factor.net/codebase" rel="noopener ugc nofollow" target="_blank">原则I——单代码库</a>、<a class="ae lg" href="https://12factor.net/config" rel="noopener ugc nofollow" target="_blank">原则III——环境中的配置</a>、<a class="ae lg" href="https://12factor.net/build-release-run" rel="noopener ugc nofollow" target="_blank">原则V——构建、发布、运行分离</a>。</li></ol><h2 id="9948" class="mm jl hi bd jm mn mo mp jq mq mr ms ju iq mt mu jy iu mv mw kc iy mx my kg mz bi translated">分支策略</h2><figure class="mc md me mf fd mg er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es nl"><img src="../Images/e13ff01a6629f0f70e5eebfd343ccbb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*J4henfboEK9eG37-"/></div></div><figcaption class="nb nc et er es nd ne bd b be z dx">Credit to <a class="ae lg" href="https://launchdarkly.com/blog/git-branching-strategies-vs-trunk-based-development/" rel="noopener ugc nofollow" target="_blank">https://launchdarkly.com/blog/git-branching-strategies-vs-trunk-based-development/</a></figcaption></figure><p id="0086" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">每个团队和项目都必须有一个他们同意并遵循的分支策略。团队成员必须紧紧跟随开发工作流，CICD工作流将围绕分支策略构建。有许多类型的<a class="ae lg" href="https://launchdarkly.com/blog/git-branching-strategies-vs-trunk-based-development/" rel="noopener ugc nofollow" target="_blank">分支策略</a>，为了本文和CICD演示的简单，我们将使用基于主干的开发(TBD)作为我们的分支策略。TBD强制简化并频繁整合你的代码以减少<a class="ae lg" href="https://www.stxnext.com/blog/escape-merge-hell-why-i-prefer-trunk-based-development-over-feature-branching-and-gitflow" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">合并</strong> </a>的机会。</p><h2 id="2d49" class="mm jl hi bd jm mn mo mp jq mq mr ms ju iq mt mu jy iu mv mw kc iy mx my kg mz bi translated">动态部署或GitOps方法</h2><p id="ddd0" class="pw-post-body-paragraph if ig hi ih b ii ki ik il im kj io ip iq kk is it iu kl iw ix iy km ja jb jc hb bi translated">当您想要向CICD系统提供关于要部署到哪个版本的代码的输入时，有两种部署方法。1是动态部署，您应该听说过在映像工件中使用<strong class="ih hj">最新的</strong>标记、<strong class="ih hj"> </strong>或变量来存储您想要部署的版本，您可以使用管道变量或CICD平台中的全局设置来配置或传递该值。<a class="ae lg" href="https://www.weave.works/blog/gitops-operations-by-pull-request" rel="noopener ugc nofollow" target="_blank"> GitOps方法</a>是另一种实践，因为所有的配置更改都将记录在Git系统中，并且必须使用<a class="ae lg" href="https://docs.github.com/en/github/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/about-pull-requests" rel="noopener ugc nofollow" target="_blank"> Pull Request </a>方法审查更改。在这个演示项目中，我们将使用GitOps方法来记录图像版本。</p><h2 id="a642" class="mm jl hi bd jm mn mo mp jq mq mr ms ju iq mt mu jy iu mv mw kc iy mx my kg mz bi translated">管道配置方法</h2><p id="ddb5" class="pw-post-body-paragraph if ig hi ih b ii ki ik il im kj io ip iq kk is it iu kl iw ix iy km ja jb jc hb bi translated">管道配置方法有两种方式。1是从UI进行管道配置，这是配置管道最常见、最容易开始的方法，但是它有很多问题，比如可伸缩性问题。另一种方法是<a class="ae lg" href="https://about.gitlab.com/topics/ci-cd/pipeline-as-code/" rel="noopener ugc nofollow" target="_blank"> Pipeline as Code </a>方法，它解决了可伸缩性问题，并且更符合开发人员将配置作为代码进行管理的经验。在这个项目中，我们将使用管道作为代码方法。</p><h2 id="1121" class="mm jl hi bd jm mn mo mp jq mq mr ms ju iq mt mu jy iu mv mw kc iy mx my kg mz bi translated">进化数据库设计</h2><p id="a8e9" class="pw-post-body-paragraph if ig hi ih b ii ki ik il im kj io ip iq kk is it iu kl iw ix iy km ja jb jc hb bi translated">在敏捷开发中，大多数时候开发人员会忽略我们应该如何以敏捷或自动化的方式管理数据库变更，数据库的变更和迁移被认为是关键的操作，人们会倾向于使用手动方式来管理数据库变更。有了<a class="ae lg" href="https://martinfowler.com/articles/evodb.html" rel="noopener ugc nofollow" target="_blank">进化数据库设计</a>，数据库中的变化可以像我们管理应用程序代码一样进行管理，同时继续集成和继续部署。在这个项目中，我们将通过<a class="ae lg" href="https://www.prisma.io/" rel="noopener ugc nofollow" target="_blank"> Prisma migration </a>的持续部署来展示进化数据库设计。</p></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><h1 id="9265" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">创建世界知识库和管道</h1><figure class="mc md me mf fd mg er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es nm"><img src="../Images/d58fff641f2ee7e3eaeff88a6445101a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jTQiXZrQel17S8SX"/></div></div><figcaption class="nb nc et er es nd ne bd b be z dx">Credit to <a class="ae lg" href="https://www.nytimes.com/2016/04/17/magazine/the-minecraft-generation.html" rel="noopener ugc nofollow" target="_blank">https://www.nytimes.com/2016/04/17/magazine/the-minecraft-generation.html</a></figcaption></figure><p id="54fd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">世界存储库，或者你可以称之为上帝存储库，是管理我们配置Azure DevOps所需的一切的GitOps存储库。这是您需要手动创建的唯一的存储库和相关管道。其他Azure DevOps配置将依赖于此存储库。</p><h2 id="8bf1" class="mm jl hi bd jm mn mo mp jq mq mr ms ju iq mt mu jy iu mv mw kc iy mx my kg mz bi translated">创建地形S3后端</h2><p id="b131" class="pw-post-body-paragraph if ig hi ih b ii ki ik il im kj io ip iq kk is it iu kl iw ix iy km ja jb jc hb bi translated">我们使用Terraform来提供世界知识库中的所有配置。为了在多个团队成员维护terraform时保持其状态，您需要创建持久存储来存储<a class="ae lg" href="https://www.terraform.io/docs/language/state/index.html" rel="noopener ugc nofollow" target="_blank">状态文件，</a>有多种方式来设置您的Terraform后端，在我们的示例中，我们将使用带有DynamoDb表的S3后端。<a class="ae lg" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html" rel="noopener ugc nofollow" target="_blank">在本地配置</a>您的AWS凭证，并按照步骤操作。</p><p id="0606" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在您的根目录下创建Cloudformation脚本作为backend.yml:-</p><figure class="mc md me mf fd mg"><div class="bz dy l di"><div class="nn no l"/></div></figure><p id="9ea9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用AWS CLI创建后端:-</p><pre class="mc md me mf fd np nq nr ns aw nt bi"><span id="e49e" class="mm jl hi nq b fi nu nv l nw nx">aws cloudformation create-stack --stack-name terraform-backend-setup --template-body file://backend.yml --parameters ParameterKey=LockTableName,ParameterValue=terraform-state-lock ParameterKey=StateBucketName,ParameterValue=terraform-s3-state-random</span></pre><p id="7b67" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用以下命令检查堆栈状态:-</p><pre class="mc md me mf fd np nq nr ns aw nt bi"><span id="468d" class="mm jl hi nq b fi nu nv l nw nx">aws cloudformation describe-stacks --stack-name terraform-backend-setup</span></pre><blockquote class="nf ng nh"><p id="d9dc" class="if ig lh ih b ii ij ik il im in io ip ni ir is it nj iv iw ix nk iz ja jb jc hb bi translated">如果您的堆栈创建不成功，大多数情况下是您的S3存储桶名称不可用，请尝试更改S3存储桶名称并重试。</p></blockquote><h2 id="02f5" class="mm jl hi bd jm mn mo mp jq mq mr ms ju iq mt mu jy iu mv mw kc iy mx my kg mz bi translated">安装Azure DevOps扩展</h2><p id="70ef" class="pw-post-body-paragraph if ig hi ih b ii ki ik il im kj io ip iq kk is it iu kl iw ix iy km ja jb jc hb bi translated">将以下扩展安装到您的Azure DevOps组织，以允许您的Azure DevOps帐户部署Terraform和AWS任务:-</p><ol class=""><li id="0565" class="kn ko hi ih b ii ij im in iq kp iu kq iy kr jc ks kt ku kv bi translated"><a class="ae lg" href="https://marketplace.visualstudio.com/items?itemName=ms-devlabs.custom-terraform-tasks" rel="noopener ugc nofollow" target="_blank">https://marketplace.visualstudio.com/items?itemName = ms-dev labs . custom-terra form-tasks</a></li><li id="f8e0" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated"><a class="ae lg" href="https://marketplace.visualstudio.com/items?itemName=AmazonWebServices.aws-vsts-tools" rel="noopener ugc nofollow" target="_blank">https://marketplace.visualstudio.com/items?itemName = Amazon web services . AWS-vsts-tools</a></li></ol><h2 id="235e" class="mm jl hi bd jm mn mo mp jq mq mr ms ju iq mt mu jy iu mv mw kc iy mx my kg mz bi translated">创建新帐户和项目</h2><p id="7e33" class="pw-post-body-paragraph if ig hi ih b ii ki ik il im kj io ip iq kk is it iu kl iw ix iy km ja jb jc hb bi translated">该项目需要一个Azure DevOps帐户，如果您还没有帐户，请确保在此处注册一个帐户。并为此项目创建一个项目，如下所示:-</p><figure class="mc md me mf fd mg er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es ny"><img src="../Images/36f16d6aa9c623d145f09282df5451ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EMpZcqfgGdsC4Mr61EalAQ.png"/></div></div></figure><p id="98c2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">出于演示目的，建议选择公共可见性，以便您可以通过使用Microsoft托管的代理拥有10个并行作业。</p><h2 id="3088" class="mm jl hi bd jm mn mo mp jq mq mr ms ju iq mt mu jy iu mv mw kc iy mx my kg mz bi translated">创建新的AWS服务连接</h2><p id="8d6f" class="pw-post-body-paragraph if ig hi ih b ii ki ik il im kj io ip iq kk is it iu kl iw ix iy km ja jb jc hb bi translated"><a class="ae lg" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/library/service-endpoints?view=azure-devops&amp;tabs=yaml" rel="noopener ugc nofollow" target="_blank">服务连接</a>是您可以配置以安全访问AWS等各种服务的设置。进入<strong class="ih hj">项目设置</strong> &gt; <strong class="ih hj">服务连接&gt;新建服务连接，并</strong>填写您想要用于Terraform权限的AWS访问和密钥。如果您愿意遵循我的步骤，请给出服务连接名称<strong class="ih hj"> AWS_CONNECTION </strong>。</p><figure class="mc md me mf fd mg er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es nz"><img src="../Images/39b9eb91748878ed630404e7aa60c037.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vw3Imi5W0orAivdQB2W_JA.png"/></div></div></figure><figure class="mc md me mf fd mg er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es oa"><img src="../Images/6e73b289d4b6533934c9526662009fcc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*65bvAtmYEjt06sTpTt5gSg.png"/></div></div></figure><h2 id="6a73" class="mm jl hi bd jm mn mo mp jq mq mr ms ju iq mt mu jy iu mv mw kc iy mx my kg mz bi translated">生成个人访问令牌</h2><p id="a806" class="pw-post-body-paragraph if ig hi ih b ii ki ik il im kj io ip iq kk is it iu kl iw ix iy km ja jb jc hb bi translated">PAT或个人访问令牌是Azure DevOps用来作为服务帐户运行以访问Azure DevOps服务的特殊秘密。我们将生成一个PAT供Terraform使用，以供应我们在CICD的存储库和管道。转到您的个人资料并打开个人访问令牌页面。</p><figure class="mc md me mf fd mg er es paragraph-image"><div class="er es ob"><img src="../Images/d9264ef031a4d8a1192ba16986ea6099.png" data-original-src="https://miro.medium.com/v2/resize:fit:916/format:webp/1*pB5HLKSGaSx43XLAOBsDJQ.png"/></div></figure><p id="62de" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建一个具有<strong class="ih hj">代理池</strong>读取&amp;管理权限、<strong class="ih hj">代码</strong>完全权限和<strong class="ih hj">构建</strong>读取&amp;执行权限的新令牌。</p><figure class="mc md me mf fd mg er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es oc"><img src="../Images/f7f0cb0e500dfd515573d21c552ca0a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ifDlm8irUCc9SxsWdl0KRw.png"/></div></div></figure><figure class="mc md me mf fd mg er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es od"><img src="../Images/5dc11f43bdc15c0026764ced4c759dbc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RBAHoWX2BMuuoQvave_VbQ.png"/></div></div></figure><figure class="mc md me mf fd mg er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es od"><img src="../Images/3b413c4979ec07adf285bf34c8642c6d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ja0_zQdhwFQ7aQHoeDy4gw.png"/></div></div></figure><p id="8667" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="lh">保存您的PAT令牌，以便我们稍后使用。</em></p><h2 id="9451" class="mm jl hi bd jm mn mo mp jq mq mr ms ju iq mt mu jy iu mv mw kc iy mx my kg mz bi translated">配置变量组</h2><figure class="mc md me mf fd mg er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es oe"><img src="../Images/dbe543a10839203fe91efcd3c74d871d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YyVFLMk0tlweFZoXpxDNGA.png"/></div></div></figure><p id="97a1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">变量组是将在管道执行期间使用的环境变量集，我们需要创建一些变量设置来正确配置管道。导航到<strong class="ih hj"> <em class="lh">管道&gt;库&gt; +变量组。</em> </strong></p><p id="7264" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用以下变量创建一个名为<strong class="ih hj"> common-vars </strong>的新变量组:-</p><figure class="mc md me mf fd mg er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es of"><img src="../Images/d8b7a5371840940eca1144b4a92bc01e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-L3YoPz5x4Wq_YB-b5VhzA.png"/></div></div></figure><p id="c270" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该值将按如下方式输入:-</p><ul class=""><li id="e7ff" class="kn ko hi ih b ii ij im in iq kp iu kq iy kr jc og kt ku kv bi translated">AZDO _ PERSONAL _ ACCESS _ TOKEN—<fill in="" your="" pat="" token="" that="" was="" previously="" generated="" enable="" secret="" value=""/></li><li id="a0f9" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc og kt ku kv bi translated">ECR _连接名称—AWS _连接</li><li id="f5b7" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc og kt ku kv bi translated">ECR _项目名称—演示</li><li id="8be1" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc og kt ku kv bi translated">ECR_REGION_NAME — ap-southeast-1</li><li id="f794" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc og kt ku kv bi translated">NODE_BUILD_VERSION — 14.x</li><li id="62e9" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc og kt ku kv bi translated">POOL _ IMAGE—Ubuntu—最新</li><li id="3edb" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc og kt ku kv bi translated">生产_ AWS _连接-AWS _连接</li><li id="f134" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc og kt ku kv bi translated">PROD _ AWS _ REGION-AP-southeast-1</li><li id="1070" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc og kt ku kv bi translated">TF _ back end _ S3 _ BUCKET-terra form-S3-state-random</li><li id="2876" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc og kt ku kv bi translated">TF_BACKEND_S3_DYNAMODB_TABLE —地形-状态-锁定</li><li id="e59c" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc og kt ku kv bi translated">TF _后端_ S3 _地区—AP-东南-1</li><li id="ee28" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc og kt ku kv bi translated">TF_VERSION — 1.0.5</li><li id="5437" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc og kt ku kv bi translated">VSTS _账户— <fill in="" your="" account="" organization="" name=""/></li></ul><h2 id="ec51" class="mm jl hi bd jm mn mo mp jq mq mr ms ju iq mt mu jy iu mv mw kc iy mx my kg mz bi translated">导入世界知识库</h2><p id="bbca" class="pw-post-body-paragraph if ig hi ih b ii ki ik il im kj io ip iq kk is it iu kl iw ix iy km ja jb jc hb bi translated">转到Repos，选择如下导入存储库:-</p><figure class="mc md me mf fd mg er es paragraph-image"><div class="er es oh"><img src="../Images/af7dea87fe05f94169e895c1f9d541b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1008/format:webp/1*gYfXZBw1okqvLpAKXS4yoQ.png"/></div></figure><p id="726c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从https://github.com/jazztong/microservice-theworld克隆而来，并将新的存储库命名为<strong class="ih hj">微服务世界。</strong></p><figure class="mc md me mf fd mg er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es oi"><img src="../Images/7fab22cd5bdfe2460e474a3290edc8fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oiVE15YvDYTH8O5i5ZzDvA.png"/></div></div></figure><p id="c285" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你浏览文件<strong class="ih hj"> azdevops/vars.tf </strong>，为了运行这个演示，它已经填充了默认值。您可以更改自己的项目名称和另一个导入URL。</p><figure class="mc md me mf fd mg"><div class="bz dy l di"><div class="nn no l"/></div></figure><h2 id="cd4a" class="mm jl hi bd jm mn mo mp jq mq mr ms ju iq mt mu jy iu mv mw kc iy mx my kg mz bi translated">配置项目管道权限</h2><p id="ccbd" class="pw-post-body-paragraph if ig hi ih b ii ki ik il im kj io ip iq kk is it iu kl iw ix iy km ja jb jc hb bi translated">项目中的项目交叉引用存储库，我们需要自动创建记录部署历史的环境，在<strong class="ih hj"> <em class="lh">项目设置&gt;管道&gt;设置&gt;常规</em> </strong>中启用管道，如下所示:-</p><figure class="mc md me mf fd mg er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es oj"><img src="../Images/246ceb559e516ecf3f29595f8f553f8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y-QT3ITDR7WZj8MvdGPtDw.png"/></div></div></figure><h2 id="52f0" class="mm jl hi bd jm mn mo mp jq mq mr ms ju iq mt mu jy iu mv mw kc iy mx my kg mz bi translated">配置世界管道</h2><p id="9119" class="pw-post-body-paragraph if ig hi ih b ii ki ik il im kj io ip iq kk is it iu kl iw ix iy km ja jb jc hb bi translated">我们将配置管道，以便世界存储库中的任何更改都可以自动将更改部署到我们的项目中。转到管道&gt;创建管道&gt;选择Azure Repo Git &gt;选择World Repo &gt;选择现有管道文件，如下所示，单击保存并运行管道:-</p><figure class="mc md me mf fd mg er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es ok"><img src="../Images/822cf5937c6a5c6437e2cc1309bcbfe8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JUa7BVDsNVqnHKoZQ6sRvg.png"/></div></div></figure><p id="5e28" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于首次运行，您需要授予对环境和可变组资源的权限。</p><figure class="mc md me mf fd mg er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es ol"><img src="../Images/bd0f8fc144b9d5418c7dc5e9d2f53212.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e0o5iSGgFZW6BiQsMKPevQ.png"/></div></div></figure><figure class="mc md me mf fd mg er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es om"><img src="../Images/3ddda13ec255d8a003f77183d4fbce9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BK-rfu90JMylJRdLdNNUew.png"/></div></div></figure><p id="484b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">成功运行管道后，将创建以下资源:-</p><ol class=""><li id="f05e" class="kn ko hi ih b ii ij im in iq kp iu kq iy kr jc ks kt ku kv bi translated">1个代理池</li><li id="52a6" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated">导入了2个存储库</li><li id="7180" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated">9条管道</li></ol><figure class="mc md me mf fd mg er es paragraph-image"><div class="er es on"><img src="../Images/0748e6471a688c51809227a9a4002e8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1080/format:webp/1*qzBEct9c4C_J8S50WOjm_w.png"/></div></figure><figure class="mc md me mf fd mg er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es oo"><img src="../Images/4d5a53b8e3bf2a9196b149ce59b1debd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a8nih2vCWxsrNzLkiWIFrg.png"/></div></div></figure><figure class="mc md me mf fd mg er es paragraph-image"><div class="er es op"><img src="../Images/510877640e3164720d6353498fbd05e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1384/format:webp/1*TkT-R-xVjPWC744itigyyQ.png"/></div></figure></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><h1 id="3b18" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">供应环境</h1><p id="8c01" class="pw-post-body-paragraph if ig hi ih b ii ki ik il im kj io ip iq kk is it iu kl iw ix iy km ja jb jc hb bi translated">在这一步中，我们将逐个触发管道来构建所有的环境。我们将触发继续集成管道或继续部署管道来构建工件或部署对环境的更改。您应该按顺序遵循管道触发器，因为它们之间存在依赖关系。</p><h2 id="c9e5" class="mm jl hi bd jm mn mo mp jq mq mr ms ju iq mt mu jy iu mv mw kc iy mx my kg mz bi translated">基地继续部署管道</h2><figure class="mc md me mf fd mg er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es oq"><img src="../Images/f280a53d862508888f45c9233c72db37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IIT5k5qhL0gjpoOI9DipXg.png"/></div></div></figure><p id="c2a4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">基础CD是指基础设施的持续部署，它使用地形管理基础设施的所有配置，例如:-</p><ol class=""><li id="93dd" class="kn ko hi ih b ii ij im in iq kp iu kq iy kr jc ks kt ku kv bi translated">ECS集群</li><li id="93ef" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated">应用负载平衡器</li><li id="4582" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated">角色和策略</li><li id="cbc1" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated">安全组</li></ol><p id="a48d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">管道完成后，您可以在您的AWS帐户中验证结果，如下所示</p><figure class="mc md me mf fd mg er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es or"><img src="../Images/933641bb168ccd4d579c41f96f6de93e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6llGP5efWakVoozvpYBuCQ.png"/></div></div></figure><figure class="mc md me mf fd mg er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es os"><img src="../Images/7136debc5e5538efa3abd59f7bb4c1f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YSMW5kznaSoiaf7t3RWyZQ.png"/></div></div></figure><figure class="mc md me mf fd mg er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es ot"><img src="../Images/ad7e06bdd343cd2959c09830331a4ed5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*frEdRT_Ech7pf1EPy0IPAA.png"/></div></div></figure><h2 id="dc85" class="mm jl hi bd jm mn mo mp jq mq mr ms ju iq mt mu jy iu mv mw kc iy mx my kg mz bi translated">数据库继续部署管道</h2><figure class="mc md me mf fd mg er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es ou"><img src="../Images/b9a6a54641d4ad6bf971f2117efe8bc8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HOs5Pd7pAJGr7zhxF6GM0g.png"/></div></div></figure><p id="a1c9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">数据库是服务启动的依赖项之一，因此我们需要在服务启动之前首先提供它。如上所述，在Infra文件夹中运行数据库CD管道。成功运行后，您可以验证在您的AWS帐户中创建的新RDS。</p><figure class="mc md me mf fd mg er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es ov"><img src="../Images/cc792792b05c7d7f558360d7db337806.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6PJ6pQcSrdTXOoqRMbmzZA.png"/></div></div></figure><h2 id="890f" class="mm jl hi bd jm mn mo mp jq mq mr ms ju iq mt mu jy iu mv mw kc iy mx my kg mz bi translated">Azure代理继续部署管道</h2><figure class="mc md me mf fd mg er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es ow"><img src="../Images/b9f2f86373bf949e139f361ece2cb673.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qejg-uwYHJhxlI2gt7bQOQ.png"/></div></div></figure><p id="77c3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Azure Agent CD是提供Azure Agent ECS服务的管道。它将使用作为代理，允许Azure DevOps通过管道部署数据库更改。管道运行成功后，您可以验证它是否在ECS群集中调配了新的ECS服务，如下所示</p><figure class="mc md me mf fd mg er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es ox"><img src="../Images/aacabb0b4f7ea00fc78779baadc38926.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ySN9PV8RlASOw6j5G6z94w.png"/></div></div></figure><p id="d3a1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">ECS服务将作为我们之前创建的代理池中的一个代理运行。您可以在<strong class="ih hj">组织设置&gt;管道&gt;代理池&gt; prod-demo-az-agent </strong>中检查代理是否运行</p><figure class="mc md me mf fd mg er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es oy"><img src="../Images/4f095b8b90943ce6ae0fd67099b2ae66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DsKJjR2RyZrk6tBpH6yDmA.png"/></div></div></figure><h2 id="c5ac" class="mm jl hi bd jm mn mo mp jq mq mr ms ju iq mt mu jy iu mv mw kc iy mx my kg mz bi translated">产品数据库和用户数据库继续部署管道</h2><figure class="mc md me mf fd mg er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es oz"><img src="../Images/55bdbdbe2542c2d17138219b048ddbb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kjYTI-k3gAS_5xnpj3mS5g.png"/></div></div></figure><p id="0402" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们有2个基于服务的数据库部署管道，当有新的模式更新时，它们将部署数据库更改。运行Product-DB CD和User-DB CD来创建服务数据库模式。当您观察管道细节时，它显示迁移已经成功地应用于数据库。</p><figure class="mc md me mf fd mg er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es pa"><img src="../Images/78984c1e983d9ada87bc4bf16b45421f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r4gVEtd_x0s4xfCXlBV1OA.png"/></div></div></figure><figure class="mc md me mf fd mg er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es pb"><img src="../Images/5fbd6905df9620610c6124f756a69177.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5fpHGNWmzWkxzdWLbHuBKw.png"/></div></div></figure><p id="e451" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为它使用我们在ECS群集中部署的托管代理，所以它不需要对您的数据库进行公共访问来运行数据库迁移。</p><h2 id="2445" class="mm jl hi bd jm mn mo mp jq mq mr ms ju iq mt mu jy iu mv mw kc iy mx my kg mz bi translated">产品-应用程序、用户-应用程序继续整合渠道</h2><figure class="mc md me mf fd mg er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es pc"><img src="../Images/1a3886bf4ae8a2add46e9fa8a61671ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pQj0S1qu6LqAjKUHISonZw.png"/></div></div></figure><p id="c9a3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在此步骤中，我们将触发产品应用程序和用户应用程序配置项，以生成docker映像并将其发布到ECR。</p><p id="d265" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">管道成功运行后，它会将docker映像推送到您在AWS服务连接中配置的ECR存储库。</p><blockquote class="nf ng nh"><p id="0ed9" class="if ig lh ih b ii ij ik il im in io ip ni ir is it nj iv iw ix nk iz ja jb jc hb bi translated">您需要授予变量组对管道的权限</p></blockquote><p id="b215" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">登录到您用来生成凭证的AWS帐户，并打开ECR页面，当项目配置到ap-southeast-1区域时，您可以使用此<a class="ae lg" href="https://ap-southeast-1.console.aws.amazon.com/ecr/repositories?region=ap-southeast-1" rel="noopener ugc nofollow" target="_blank">链接</a>来打开页面。</p><figure class="mc md me mf fd mg er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es pd"><img src="../Images/d7f417cd9a7a112c26a12b9b193a983b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A5xpx4NxTII3fy0vb8aZ-Q.png"/></div></div></figure><p id="ab98" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">CI存储库还配置<em class="lh">自动拉请求</em>生成，以将部署更改提交到基础架构存储库，拉请求工作流是GitOps实践之一，它确保所有更改都记录在Git历史记录中，甚至对于基础架构更改也遵循合并流程。</p><p id="63c4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">转到Infra pull request页面，您应该会看到一个使用新的docker映像URI生成的新pull请求，批准该pull请求并完成更改，以便进行服务部署。</p><figure class="mc md me mf fd mg er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es pe"><img src="../Images/ad12de1e926d54853ba34f32c9246439.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QWwROYgRYgG9kpBF7apVzQ.png"/></div></div></figure><figure class="mc md me mf fd mg er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es pf"><img src="../Images/65ed25edb050409050c06c1a3ae694fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QBQWonmuwHo9W24Nrl-X2A.png"/></div></div></figure><p id="01e9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">pull请求是从嵌入在CI脚本中的PowerShell脚本生成的，用于调用Azure DevOps API。它提取Docker URL并将Pull请求提交给服务的CD，该CD位于基础设施repo内部。单击Approve Pull Request并完成它，您应该意识到继续部署管道正在运行。</p><h2 id="d803" class="mm jl hi bd jm mn mo mp jq mq mr ms ju iq mt mu jy iu mv mw kc iy mx my kg mz bi translated">产品服务和用户服务继续部署渠道</h2><figure class="mc md me mf fd mg er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es pg"><img src="../Images/a9bb23a41a11608b0078325ad1ae3a88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n6i76phCNsWtMoFb4oEJZQ.png"/></div></div></figure><p id="c903" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于从先前的用户服务和产品服务的拉请求完成继续，继续部署管道将如上运行。管道完成后，登录您的AWS帐户，您应该注意到创建了两个新服务。</p><figure class="mc md me mf fd mg er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es ph"><img src="../Images/2c02d2b087be87938602fd3a7cb4ef4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mfYQFvO-svRJmMz9--GmCg.png"/></div></div></figure><h2 id="05f5" class="mm jl hi bd jm mn mo mp jq mq mr ms ju iq mt mu jy iu mv mw kc iy mx my kg mz bi translated">测试您的服务</h2><p id="4c84" class="pw-post-body-paragraph if ig hi ih b ii ki ik il im kj io ip iq kk is it iu kl iw ix iy km ja jb jc hb bi translated">现在您的基础设施已经准备好了，您可以执行下面的测试了</p><ol class=""><li id="ba96" class="kn ko hi ih b ii ij im in iq kp iu kq iy kr jc ks kt ku kv bi translated">添加新产品API</li></ol><figure class="mc md me mf fd mg"><div class="bz dy l di"><div class="nn no l"/></div></figure><p id="b15a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.列出产品API</p><figure class="mc md me mf fd mg"><div class="bz dy l di"><div class="nn no l"/></div></figure><p id="ef1a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.添加用户API</p><figure class="mc md me mf fd mg"><div class="bz dy l di"><div class="nn no l"/></div></figure><p id="5a3e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.列出用户API</p><figure class="mc md me mf fd mg"><div class="bz dy l di"><div class="nn no l"/></div></figure><blockquote class="nf ng nh"><p id="d599" class="if ig lh ih b ii ij ik il im in io ip ni ir is it nj iv iw ix nk iz ja jb jc hb bi translated">用您的ABL中的实际CNAME替换您的_ALB_CNAME</p></blockquote></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><h1 id="9488" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">打扫</h1><p id="c554" class="pw-post-body-paragraph if ig hi ih b ii ki ik il im kj io ip iq kk is it iu kl iw ix iy km ja jb jc hb bi translated">像往常一样，当您对结果满意时，您可以执行清理。所有的管道都有一个隐藏的销毁步骤，选择您想要运行的管道，并添加额外的变量，如下所示。</p><figure class="mc md me mf fd mg er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es pi"><img src="../Images/14b8ed4dff747831ac3fd233e5ab9bf7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MiGJGKhcvKNKrjw5wAgWPQ.png"/></div></div></figure><figure class="mc md me mf fd mg er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es pj"><img src="../Images/8d011dcf90605ca8b1c91385713ba797.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*naxV0Aq0Zv0aF6xWRZOC8w.png"/></div></div></figure><blockquote class="nf ng nh"><p id="5ed8" class="if ig lh ih b ii ij ik il im in io ip ni ir is it nj iv iw ix nk iz ja jb jc hb bi translated">名称=销毁，值=真</p></blockquote><p id="b153" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于组件之间存在依赖关系，为了正确清理，您需要按照以下顺序运行销毁步骤</p><ol class=""><li id="1982" class="kn ko hi ih b ii ij im in iq kp iu kq iy kr jc ks kt ku kv bi translated">产品服务光盘</li><li id="007a" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated">用户服务光盘</li><li id="e751" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated">AZ代理CD</li><li id="962c" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated">数据库光盘</li><li id="66ba" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated">基础CD</li><li id="017e" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated">微服务-世界</li></ol><blockquote class="nf ng nh"><p id="b73b" class="if ig lh ih b ii ij ik il im in io ip ni ir is it nj iv iw ix nk iz ja jb jc hb bi translated">销毁微服务世界管道时请小心，它将删除所有的导入库</p></blockquote></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><h1 id="13cf" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">拿走</h1><p id="1314" class="pw-post-body-paragraph if ig hi ih b ii ki ik il im kj io ip iq kk is it iu kl iw ix iy km ja jb jc hb bi translated">我知道，我知道，我们没有完成所有的细节设置。正如在开始时提到的，这是为了分享一个高级工作流和建立一个生产级DevOps代码库，如果你想详细了解它是如何工作的，你需要研究我的代码。可扩展和可维护的管道项目需要大量的设计和测试，尤其是当您迁移到新的DevOps平台时。虽然所有主要的DevOps平台都支持管道作为代码设置，但理论上相同的概念和思想可以应用于任何DevOps平台。如果你想让我解释更多具体的概念和步骤，请给我留言。我希望你喜欢这个项目。</p></div></div>    
</body>
</html>