<html>
<head>
<title>Configure Apache Web Server, HAPROXY and further Auto-Register Backend Server IPs to HAPROXY using Ansible</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">配置Apache Web服务器、HAPROXY，并使用Ansible将后端服务器IPs自动注册到HAPROXY</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/configure-apache-web-server-haproxy-and-further-auto-register-backend-server-ips-to-haproxy-using-b60ec2ae6dc7?source=collection_archive---------8-----------------------#2021-05-18">https://medium.com/geekculture/configure-apache-web-server-haproxy-and-further-auto-register-backend-server-ips-to-haproxy-using-b60ec2ae6dc7?source=collection_archive---------8-----------------------#2021-05-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/84b6bb5ee75beb09604628946a424a0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0C6UMY8gr041g337zLI39g.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">Created by Akanksha</figcaption></figure><div class=""/><div class=""><h2 id="2a32" class="pw-subtitle-paragraph iu hw hx bd b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl dx translated">在HAPROXY.cfg文件中控制web服务器版本和解决主机IPs动态添加到每个托管节点的挑战的角色，这提高了我们站点的可扩展性和高可用性…</h2></div><p id="6b30" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">在这个敏捷的世界中，我们将我们的网站部署到生产环境中。但是，每当我们的Web服务器节点扩展时，我们都必须将其注册到负载平衡器，负载平衡器进而分配流量并管理来自客户端的请求-响应。</p><p id="ce1d" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">现在情况一定很清楚了，我们要在这个博客里讨论什么？是的，它是Web服务器IPs到负载平衡器的自动注册。如果数据中心的系统崩溃，我们可能需要设置整个环境。因此，这个Ansible将使用它的自动声明代码在几分钟内创建整个设置。</p><figure class="kj kk kl km fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ki"><img src="../Images/5dbecc2d8d775b33988a7b17479c8a20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*eLPOEu57mMNlGHgP.png"/></div></div></figure><h2 id="5e32" class="kn ko hx bd kp kq kr ks kt ku kv kw kx jv ky kz la jz lb lc ld kd le lf lg lh bi translated">🤔Ansible是什么？</h2><p id="f3c0" class="pw-post-body-paragraph jm jn hx jo b jp li iy jr js lj jb ju jv lk jx jy jz ll kb kc kd lm kf kg kh hb bi translated">自动化在IT领域已经存在几十年了，但Ansible主要是为"<strong class="jo hy">配置管理</strong>设计的，该工具以高度可伸缩性和启动业务的能力进入市场，而无需向员工支付高额工资，只需编写脚本来继续配置由负载平衡器启动的每个节点……浏览我以前的Ansible博客，在那里我讨论了Ansible的真实行业用例。<a class="ae ln" href="https://akanksha77.medium.com/this-article-will-give-you-an-idea-that-how-advancement-and-automation-made-the-configuration-of-62b15ad680ea" rel="noopener">点击这里！！</a></p><div class="hh hi ez fb hj lo"><a href="https://akanksha77.medium.com/this-article-will-give-you-an-idea-that-how-advancement-and-automation-made-the-configuration-of-62b15ad680ea" rel="noopener follow" target="_blank"><div class="lp ab dw"><div class="lq ab lr cl cj ls"><h2 class="bd hy fi z dy lt ea eb lu ed ef hw bi translated">本文将让您了解进步和自动化是如何使配置…</h2><div class="lv l"><h3 class="bd b fi z dy lt ea eb lu ed ef dx translated">自动化在IT领域已经存在几十年了，但Ansible主要是为“配置管理”而设计的。</h3></div><div class="lw l"><p class="bd b fp z dy lt ea eb lu ed ef dx translated">akanksha77.medium.com</p></div></div><div class="lx l"><div class="ly l lz ma mb lx mc hp lo"/></div></div></a></div><figure class="kj kk kl km fd hk er es paragraph-image"><div class="er es md"><img src="../Images/9e70e6e203474a149b64fea8105384e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:474/0*l2hhHY3YciZUqzHh"/></div></figure><h2 id="76c9" class="kn ko hx bd kp kq kr ks kt ku kv kw kx jv ky kz la jz lb lc ld kd le lf lg lh bi translated">🤔我们为什么使用HAPROXY？</h2><p id="a710" class="pw-post-body-paragraph jm jn hx jo b jp li iy jr js lj jb ju jv lk jx jy jz ll kb kc kd lm kf kg kh hb bi translated">HAProxy代表<strong class="jo hy">高可用性代理</strong>，是一个流行的开源软件TCP/HTTP负载平衡器和代理解决方案，可以在Linux、Solaris和FreeBSD上运行。它最常见的用途是通过在多个服务器(例如web、应用程序、数据库)之间分配工作负载来提高服务器环境的性能和可靠性。</p><p id="3562" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">HAProxy使用健康检查来确定后端服务器是否可用于处理请求。这避免了在服务器变得不可用时必须从后端手动删除服务器。默认的运行状况检查是尝试建立到服务器的TCP连接，即检查后端服务器是否正在侦听配置的IP地址和端口。</p><p id="94e2" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">如果服务器未通过健康检查，因此无法为请求提供服务，它会在后端自动禁用<strong class="jo hy">，即流量不会转发给它，直到它再次恢复健康。如果后端中的所有服务器都出现故障，服务将变得不可用，直到这些后端服务器中至少有一个恢复正常。</strong></p><figure class="kj kk kl km fd hk er es paragraph-image"><div class="er es me"><img src="../Images/6d9999bb50b1ec0537f8b89a8b7dc3bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/0*V-yiwJlsvvqR5bng.jpg"/></div></figure><h2 id="65d7" class="kn ko hx bd kp kq kr ks kt ku kv kw kx jv ky kz la jz lb lc ld kd le lf lg lh bi translated">🤔Apache HTTP Server的工作是什么？</h2><p id="d9f3" class="pw-post-body-paragraph jm jn hx jo b jp li iy jr js lj jb ju jv lk jx jy jz ll kb kc kd lm kf kg kh hb bi translated">所有web服务器的基本工作是<strong class="jo hy">接受来自客户端</strong>的请求(例如，访问者的web浏览器)，然后发送对该请求的响应(例如，访问者想要查看的页面组件)。Apache是最流行的web服务器。</p><p id="e732" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">Apache的功能是使用TCP/IP协议通过网络从客户端到服务器进行通信。Apache可用于多种协议，但最常见的是HTTP/S。HTTP/S或超文本传输协议(S代表安全)是web上的主要协议之一，也是Apache最著名的协议。</p><p id="cb54" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated"><strong class="jo hy"> Apache Web应用架构:</strong></p><p id="0cda" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">Apache只是web应用程序堆栈中交付web内容所需的一个组件。最常见的web应用程序栈之一涉及LAMP或Linux、Apache、MySQL和PHP。</p><p id="4a99" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">Linux是处理应用程序操作的操作系统。Apache是通过HTTP处理请求并提供web资产和内容的web服务器。MySQL是一个以易于查询的格式存储所有信息的数据库。PHP是一种编程语言，它与apache一起帮助创建动态web内容。</p></div><div class="ab cl mf mg gp mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="hb hc hd he hf"><h1 id="608e" class="mm ko hx bd kp mn mo mp kt mq mr ms kx jd mt je la jg mu jh ld jj mv jk lg mw bi translated">在继续进行之前，让我们简要介绍一下我们的计划:</h1><ol class=""><li id="47c6" class="mx my hx jo b jp li js lj jv mz jz na kd nb kh nc nd ne nf bi translated">首先，我们将创建ansible.cfg文件，在该文件中，我们必须提到所有受管节点的IP。</li><li id="30ef" class="mx my hx jo b jp ng js nh jv ni jz nj kd nk kh nc nd ne nf bi translated">为Ansible从控制器节点使用剧本部署创建的SSH连接的所有受管节点元数据创建静态清单。</li><li id="c45b" class="mx my hx jo b jp ng js nh jv ni jz nj kd nk kh nc nd ne nf bi translated">为Apache Web服务器配置创建角色。</li><li id="8a6c" class="mx my hx jo b jp ng js nh jv ni jz nj kd nk kh nc nd ne nf bi translated">为HAPROXY配置和后端Web服务器的自动注册创建角色。</li><li id="4181" class="mx my hx jo b jp ng js nh jv ni jz nj kd nk kh nc nd ne nf bi translated">创建Setup.yml Ansible行动手册文件以部署这些角色，从而达到我们的要求。</li></ol><h2 id="d623" class="kn ko hx bd kp kq kr ks kt ku kv kw kx jv ky kz la jz lb lc ld kd le lf lg lh bi translated">先决条件:</h2><blockquote class="nl nm nn"><p id="9e14" class="jm jn no jo b jp jq iy jr js jt jb ju np jw jx jy nq ka kb kc nr ke kf kg kh hb bi translated">带有RHEL8 Linux机器的✔控制器节点，必须在该机器上安装Python &amp; Ansible 2.10.8。</p><p id="d2b6" class="jm jn no jo b jp jq iy jr js jt jb ju np jw jx jy nq ka kb kc nr ke kf kg kh hb bi translated">web服务器配置的一些受管节点。一个用于HAPROXY配置。</p></blockquote><p id="e374" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">我们正在Ansible-galaxy中创建角色，以便很好地管理我们的声明代码，并通过运行ansible-playbook setup.yml文件的一个命令一步一步地完成这个用例，最终设置将一键完成。</p><p id="b5cd" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated"><strong class="jo hy"> <em class="no">第一步:创建Ansible配置文件:</em> </strong></p><p id="af9a" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">Ansible是一个无代理的自动化工具，它需要控制器节点上的清单文件，我已经提到这是我们的本地系统。清单文件可以在路径(/etc/ansible/ansible.cfg)中的控制器节点内全局创建，也可以在我们将要运行剧本/角色的工作区中创建。</p><p id="b130" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated"><em class="no">为此项目创建工作环境:</em></p><pre class="kj kk kl km fd ns nt nu nv aw nw bi"><span id="0141" class="kn ko hx nt b fi nx ny l nz oa"><strong class="nt hy"># mkdir haproxy-ansible<br/># cd haproxy-ansible<br/># mkdir roles<br/># vim ansible.cfg</strong></span></pre><p id="1829" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">这里我们创建一个本地的Ansible配置文件，如下所示。为此，您只需要创建一个工作区，您将在其中保存Ansible Controller node Playbook配置项目的所有角色、清单和模板。</p><figure class="kj kk kl km fd hk"><div class="bz dy l di"><div class="ob oc l"/></div></figure><p id="e703" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">这里我们有三个可用的系统，一个是[default],在这个系统下我们只需编写<strong class="jo hy"> role_path </strong>:用于定义路径的位置，<strong class="jo hy"> host_key_checking </strong>:用于在SSH远程登录到受管节点时禁止检查主机密钥。最重要的是，<strong class="jo hy">列出了所有被管理主机的地址所在的</strong>文件路径。</p><p id="a9b3" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">在[inventory]系统中，我们有一些插件，这些插件使我们能够对我们的清单文件进行额外的工作，如:Host _ list-列出主机，Script-添加一些脚本，在自动化场景中的Auto-Ansible用法，yaml-了解YAML结构描述，ini-初始化清单列表并收集事实，以及更多的插件，我们可以添加这些插件来获得更多的故障排除和更好的解决方案，以优化我们的工作并使配置管理更简单。</p><p id="ce7f" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">[privilege_escalation]块包含sudo用户的权限和一些权限，我们依次赋予受管节点内核运行程序和配置设置的权限，这些权限或多或少涉及到启动/停止服务和更改关键文件。我们只需要在那里写下我们的要求，比如成为，成为_方法，成为_用户，成为_询问_通过。</p><p id="3e6f" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">有关配置文件设置<a class="ae ln" href="https://docs.ansible.com/ansible/2.4/intro_configuration.html" rel="noopener ugc nofollow" target="_blank">的更多详情，请访问此处！</a>！</p><p id="1723" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated"><strong class="jo hy"> <em class="no">第二步:创建静态存货档案:</em> </strong></p><p id="d7b6" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">Ansible使用称为<strong class="jo hy">清单</strong>的一个列表或一组列表，同时针对基础设施中的多个托管节点或“主机”工作。清单可以由YAML或ini文件构建或提取。我们主要有两种存货:</p><ol class=""><li id="c283" class="mx my hx jo b jp jq js jt jv od jz oe kd of kh nc nd ne nf bi translated"><strong class="jo hy">静态清单</strong>:在这里，您可以使用密码提及多个受管节点的IP或DNS名称，或者可以使用基于密钥的身份验证方法来连接我们的远程实例，以便管理它们的配置。我们可以在此文件中创建我们需要处理的默认组、主机组或主机范围。但是这些对于管理小型基础设施来说很方便。</li><li id="ba95" class="mx my hx jo b jp ng js nh jv ni jz nj kd nk kh nc nd ne nf bi translated"><strong class="jo hy">动态清单</strong>:一些动态清单脚本在本地配置控制器机器上运行，并查找您的远程系统信息，使用这些信息来检索系统的地址或DNS，加载更多角色/行动手册，并在这些清单主机设置上实时运行。这些脚本是可执行程序，当通过ansible.cfg文件或通过-i选项传递远程系统的位置时，它们从外部来源收集信息并以JSON格式输出清单。这个文件总是可执行的，并且适合于我们频繁创建和销毁机器并且需要在那个时候进行配置的环境。</li></ol><p id="464b" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated"><a class="ae ln" href="https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html" rel="noopener ugc nofollow" target="_blank">欲了解更多库存信息，请访问！！</a></p><p id="baf0" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">因此，总结我们的用例，我们只有几个需要配置的系统。这些系统在我们的本地机器上，我们也没有执行任何放大或缩小操作。那么我们需要使用静态库存，如下所示:</p><figure class="kj kk kl km fd hk"><div class="bz dy l di"><div class="ob oc l"/></div></figure><p id="1061" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">这里我们有两个主机组，名为[web]用于web服务，名为[lb]用于负载平衡器信息。文件中的每条记录(行)包含一个受管节点的IP地址、用户名、密码和连接方法信息(例如，如果是Linux，则是SSH，如果是Windows，则是RDP)。</p><p id="007c" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated"><strong class="jo hy"> <em class="no">第三步:创建角色:</em> </strong></p><p id="3a04" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">我们总共有两个角色，名为“web”和“lbrole ”,分别用于配置Webserver和HAPROXY负载平衡器。角色的名字清楚地表明了他们的任务:</p><blockquote class="nl nm nn"><p id="19fc" class="jm jn no jo b jp jq iy jr js jt jb ju np jw jx jy nq ka kb kc nr ke kf kg kh hb bi translated"><strong class="jo hy"> Web角色将做以下事情:</strong> <br/> ◾安装Apache Web服务器(httpd) <br/> ◾复制网页<br/> ◾启动httpd服务</p><p id="ff9c" class="jm jn no jo b jp jq iy jr js jt jb ju np jw jx jy nq ka kb kc nr ke kf kg kh hb bi translated"><strong class="jo hy"> lbrole会做以下事情:</strong> <br/> ◾安装Haproxy负载均衡器<br/> ◾设置haproxy.cfg文件<br/> ◾启动firewalld服务并暴露代理端口<br/> ◾最后启动haproxy服务</p></blockquote><p id="f949" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">为我们的角色创建单独的工作空间总是一个好的做法，这样我们可以很容易地记住文件的层次结构。为此，我们有“角色”工作空间:</p><pre class="kj kk kl km fd ns nt nu nv aw nw bi"><span id="3f26" class="kn ko hx nt b fi nx ny l nz oa"><strong class="nt hy"># mkdir roles<br/># cd roles<br/># ansible-galaxy init web<br/># ansible-galaxy init lbrole</strong></span></pre><p id="1692" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">现在我们已经有了所有的任务、模板、变量文件<em class="no">和其他基于已知文件结构</em>的可解析工件，这些工件已经预嵌入到角色中，我们只需要通过包含模块和jinja属性注释来编写我们所需要的所有东西的声明/描述(用YAML语言)。</p><p id="3b03" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated"><a class="ae ln" href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse_roles.html" rel="noopener ugc nofollow" target="_blank">欲了解更多角色信息，请访问！</a></p><p id="6dc0" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated"><strong class="jo hy"> <em class="no">第四步:创建Web服务器角色:</em> </strong></p><figure class="kj kk kl km fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/eb9cf0af21e75e216d146cb41326a3b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XlyvmCTAcTZvCNe5NdB_SA.png"/></div></div></figure><p id="b5bf" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">在这个角色中，我们有三件事情要做，第一是安装httpd软件，第二是在被管理节点上的特定目的地向被管理节点发送(复制)文件。最后运行httpd Apache Web服务器的服务。它包括我们角色的任务、变量和文件特性。</p><pre class="kj kk kl km fd ns nt nu nv aw nw bi"><span id="2bc1" class="kn ko hx nt b fi nx ny l nz oa"><strong class="nt hy"># cd role/web/tasks<br/># vim main.yml</strong></span></pre><figure class="kj kk kl km fd hk"><div class="bz dy l di"><div class="ob oc l"/></div><figcaption class="hr hs et er es ht hu bd b be z dx">tasks.yml</figcaption></figure><p id="f19f" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">在上面的任务文件中，我使用了我们的web角色的变量和文件特性，下面分别是变量和文件(index.html ):</p><pre class="kj kk kl km fd ns nt nu nv aw nw bi"><span id="aed6" class="kn ko hx nt b fi nx ny l nz oa"><strong class="nt hy"># cd role/web/vars<br/># vim main.yml</strong></span></pre><figure class="kj kk kl km fd hk"><div class="bz dy l di"><div class="ob oc l"/></div><figcaption class="hr hs et er es ht hu bd b be z dx">var.yml</figcaption></figure><pre class="kj kk kl km fd ns nt nu nv aw nw bi"><span id="884b" class="kn ko hx nt b fi nx ny l nz oa"><strong class="nt hy"># cd role/web/files</strong></span></pre><figure class="kj kk kl km fd hk"><div class="bz dy l di"><div class="ob oc l"/></div><figcaption class="hr hs et er es ht hu bd b be z dx">index.html</figcaption></figure><p id="d2d4" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated"><strong class="jo hy"> <em class="no">第五步:创建负载均衡器角色:</em> </strong></p><figure class="kj kk kl km fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/0160b6bb4ae3649ed0577d70f3e07f07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BKoavk1s540wa4q8DjNmzw.png"/></div></div></figure><p id="9972" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">在负载平衡器角色“lbrole”中，它使用HAPROXY软件创建负载平衡器，并使用该软件进一步管理来自客户端的流量负载，并将从前端到后端的请求代理给客户端，后端服务器被自动注册到我们的负载平衡器，并且当负载在会话基础上增加时，我们还可以添加扩大和缩小的设施。</p><pre class="kj kk kl km fd ns nt nu nv aw nw bi"><span id="ed9e" class="kn ko hx nt b fi nx ny l nz oa"><strong class="nt hy"># cd role/lbrole/tasks<br/># vim main.yml</strong></span></pre><p id="14d4" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">HAPROXY负载平衡器角色中包含的任务如下:</p><figure class="kj kk kl km fd hk"><div class="bz dy l di"><div class="ob oc l"/></div><figcaption class="hr hs et er es ht hu bd b be z dx">tasks.yml</figcaption></figure><p id="71ea" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">我们在这里使用了各种可转换模块，如:</p><blockquote class="nl nm nn"><p id="7d6d" class="jm jn no jo b jp jq iy jr js jt jb ju np jw jx jy nq ka kb kc nr ke kf kg kh hb bi translated"><strong class="jo hy">软件包模块:</strong>使用yum/dnf软件包管理器安装、升级、删除和列出软件包和组。</p><p id="85ea" class="jm jn no jo b jp jq iy jr js jt jb ju np jw jx jy nq ka kb kc nr ke kf kg kh hb bi translated"><strong class="jo hy">模板模块:</strong>使用该模块在被管节点上部署jinja2模板文件。与<strong class="jo hy"> src </strong>键相关联的值指定源Jinja2模板，与<strong class="jo hy"> dest </strong>键相关联的值指定要在目的主机上创建的文件。</p><p id="d486" class="jm jn no jo b jp jq iy jr js jt jb ju np jw jx jy nq ka kb kc nr ke kf kg kh hb bi translated"><strong class="jo hy">服务模块</strong>:启动系统或程序服务，停止和重启服务。</p><p id="d931" class="jm jn no jo b jp jq iy jr js jt jb ju np jw jx jy nq ka kb kc nr ke kf kg kh hb bi translated"><strong class="jo hy">命令模块:</strong>附加模块，不处理幂等性，并拥有运行shell命令的能力，就像在受管节点中一样。</p><p id="f09a" class="jm jn no jo b jp jq iy jr js jt jb ju np jw jx jy nq ka kb kc nr ke kf kg kh hb bi translated"><strong class="jo hy">防火墙模块:</strong>该模块允许在运行或永久防火墙规则中添加或删除服务和端口(TCP或UDP)。</p></blockquote><p id="53db" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">这里还要注意一件事，我们在<strong class="jo hy"> jinja2模板</strong>中提供了文件(haproxy.cfg.j2 ),这样它就可以被处理，我们可以使用“for loop”将用于注册目的的web服务器的数量添加到我们的负载平衡器节点。我们正在通过清单中提到的主机组导入IP地址。</p><p id="4788" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">当使用变量和事实部署文件时，模板化文件是管理为受管主机自动定制的配置文件的强大方法。Ansible对内部使用分隔符的模板文件使用<strong class="jo hy"> Jinja2模板系统</strong>。我们可以通过使用支持将文件从<strong class="jo hy"> src </strong>(源)传输到<strong class="jo hy"> dest </strong>(目的地)的<strong class="jo hy">模板</strong>模块，将该文件部署在受管节点中，也就是说，可以使用的控制器节点。我们将<strong class="jo hy">用于</strong>语句，变量包含清单中[web]组中要管理的主机列表，该列表将在文件中列出。</p><p id="1699" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">{ % for web in groups[' web ']% }<br/>{ { web } }<br/>{ % end for % }</p><pre class="kj kk kl km fd ns nt nu nv aw nw bi"><span id="7681" class="kn ko hx nt b fi nx ny l nz oa"><strong class="nt hy"># cd role/lbrole/template</strong></span></pre><figure class="kj kk kl km fd hk"><div class="bz dy l di"><div class="ob oc l"/></div></figure><p id="bf1f" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">变量文件如下，在任务执行时由Ansible任务文件调用。/lbrole/var文件夹包含名为main.yml的变量文件，我们有两个名为<strong class="jo hy"> soft </strong>和<strong class="jo hy"> port_no </strong>的变量。</p><pre class="kj kk kl km fd ns nt nu nv aw nw bi"><span id="7866" class="kn ko hx nt b fi nx ny l nz oa"><strong class="nt hy"># cd role/lbrole/vars<br/># vim main.yml</strong></span></pre><figure class="kj kk kl km fd hk"><div class="bz dy l di"><div class="ob oc l"/></div></figure><p id="da4e" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated"><strong class="jo hy"> <em class="no">第六步:创建运行所有角色的设置剧本:</em> </strong></p><p id="2042" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">最后，编写我们的Setup.yml文件，通过调用这些角色来自动完成所有的任务。我们需要在主工作区内创建文件，即haproxy_ansible:</p><pre class="kj kk kl km fd ns nt nu nv aw nw bi"><span id="c1e2" class="kn ko hx nt b fi nx ny l nz oa"><strong class="nt hy"># cd haproxy_ansible/<br/># vim setup.yml</strong></span></pre><figure class="kj kk kl km fd hk"><div class="bz dy l di"><div class="ob oc l"/></div></figure><p id="08f4" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">因此，它最终将在两个主机组上运行，即web和lb。</p><p id="bd2b" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated"><strong class="jo hy">步骤7:运行行动手册设置。yml: </strong></p><p id="dc18" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">现在只需运行ansible-playbook，在一个playbook中最终执行所有角色和集合。</p><pre class="kj kk kl km fd ns nt nu nv aw nw bi"><span id="a51e" class="kn ko hx nt b fi nx ny l nz oa"><strong class="nt hy"># ansible-playbook setup.yml </strong></span></pre><p id="ab42" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">因此，我们已经实现了我们的目标“配置Apache Web服务器，HAPROXY和进一步自动注册后端服务器IP到HAPROXY”。下面是运行Ansible行动手册时的演示视频:</p><figure class="kj kk kl km fd hk"><div class="bz dy l di"><div class="og oc l"/></div></figure><p id="29d6" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">你可以在我的GitHub上找到这个项目，只要fork和let使这个项目对客户来说更加系统独立和可靠。</p><div class="hh hi ez fb hj lo"><a href="https://github.com/akankshaS77/Haproxy-Apache-Ansible.git" rel="noopener  ugc nofollow" target="_blank"><div class="lp ab dw"><div class="lq ab lr cl cj ls"><h2 class="bd hy fi z dy lt ea eb lu ed ef hw bi translated">akankshas 77/ha proxy-Apache-ansi ble</h2><div class="lv l"><h3 class="bd b fi z dy lt ea eb lu ed ef dx translated">使用可变角色将Apache Web服务器IP动态配置和注册到Haproxy负载平衡器配置文件…</h3></div><div class="lw l"><p class="bd b fp z dy lt ea eb lu ed ef dx translated">github.com</p></div></div><div class="lx l"><div class="oh l lz ma mb lx mc hp lo"/></div></div></a></div><p id="0d28" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">如果您想为这个项目做出贡献，或者有进一步的疑问或意见，您可以通过LinkedIN联系我:</p><div class="hh hi ez fb hj lo"><a href="https://www.linkedin.com/in/akanksha-singh-as/" rel="noopener  ugc nofollow" target="_blank"><div class="lp ab dw"><div class="lq ab lr cl cj ls"><h2 class="bd hy fi z dy lt ea eb lu ed ef hw bi translated">阿康沙·辛格-成功负责人@ ARTH -技术学院- LinuxWorld Informatics Pvt有限公司…</h2><div class="lv l"><h3 class="bd b fi z dy lt ea eb lu ed ef dx translated">在全球最大的职业社区LinkedIn上查看阿康沙·辛格的个人资料。阿康沙有3个工作列在…</h3></div><div class="lw l"><p class="bd b fp z dy lt ea eb lu ed ef dx translated">www.linkedin.com</p></div></div><div class="lx l"><div class="oi l lz ma mb lx mc hp lo"/></div></div></a></div><h1 id="d313" class="mm ko hx bd kp mn oj mp kt mq ok ms kx jd ol je la jg om jh ld jj on jk lg mw bi translated">感谢阅读。希望这个博客给你一些有价值的输入！！</h1><figure class="kj kk kl km fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/91f11c47895599f53e3601b94318961c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oZF0ISEoYeLdEYfVQ_CR9Q.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">(: — )</figcaption></figure></div></div>    
</body>
</html>