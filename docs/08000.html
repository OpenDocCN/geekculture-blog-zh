<html>
<head>
<title>How to control Three.js Camera like a Pro</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何像专业人士一样控制Three.js相机</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/how-to-control-three-js-camera-like-a-pro-a8575a717a2?source=collection_archive---------1-----------------------#2021-10-10">https://medium.com/geekculture/how-to-control-three-js-camera-like-a-pro-a8575a717a2?source=collection_archive---------1-----------------------#2021-10-10</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/0333463a8bad8076a980b0ad8aa37a2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GKR3OcFrKY-lNCB4qmbVEA.jpeg"/></div></div></figure><p id="8cd1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在本指南中，我将带你完成使用<code class="du jo jp jq jr b">FlyControls</code>来获得你想要的相机最佳角度的位置和注视向量的步骤。为了简单起见，我只用<code class="du jo jp jq jr b">PerspectiveCamera</code>来演示。</p></div><div class="ab cl js jt gp ju" role="separator"><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx"/></div><div class="hb hc hd he hf"><p id="ada9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当我第一次开始学习Three.js时，挑战之一是找到正确的角度来查看我的对象。如果你只有一个物体在宇宙的中心(0，0，0)，这不会困扰你。但是一旦你的场景得到越来越多的物体，你可能会发现很难在你的大脑中进行3d矢量计算来为你的相机选择正确的位置和方向。</p><p id="c610" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你可能会说，“嘿，你有轨道控制器来帮你！”嗯，是的，但是在某些情况下<code class="du jo jp jq jr b"><a class="ae jz" href="https://threejs.org/docs/#examples/en/controls/OrbitControls" rel="noopener ugc nofollow" target="_blank">OrbitControls</a></code>可能还不够。有时，您希望相机不仅仅围绕场景中的特定点旋转。</p><h1 id="8d81" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">输入飞行控制</h1><p id="41c2" class="pw-post-body-paragraph iq ir hi is b it ky iv iw ix kz iz ja jb la jd je jf lb jh ji jj lc jl jm jn hb bi translated">有了<code class="du jo jp jq jr b"><a class="ae jz" href="https://threejs.org/docs/#examples/en/controls/FlyControls" rel="noopener ugc nofollow" target="_blank">FlyControls</a></code>，你终于可以带着相机在你的场景里自由的漫游<strong class="is hj"><em class="ld"/></strong>。一旦将它添加到代码中，您就可以使用这些键进行移动:</p><ul class=""><li id="de90" class="le lf hi is b it iu ix iy jb lg jf lh jj li jn lj lk ll lm bi translated">WASD (W:向前，S:向后，A:向左，D:向右)</li><li id="03c8" class="le lf hi is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm bi translated">RF (R:上升，F:下降)</li><li id="b835" class="le lf hi is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm bi translated">QE(卷)</li><li id="428d" class="le lf hi is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm bi translated">↑ ↓(音高)</li><li id="e90c" class="le lf hi is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm bi translated">← →(偏航)</li></ul><p id="2c03" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这一点在<a class="ae jz" href="https://threejs.org/examples/#misc_controls_fly" rel="noopener ugc nofollow" target="_blank"> this three.js示例</a>中有所展示。这个例子的源代码是学习使用<code class="du jo jp jq jr b">FlyControls</code>的一个起点，但是当你只是想学习<code class="du jo jp jq jr b">FlyControls</code>的时候，行星和恒星网格是相当令人分心的。这就是为什么我写这篇文章是为了提供一个更简单、更清晰的例子来展示<code class="du jo jp jq jr b">FlyControls</code>、<strong class="is hj">是如何工作的，只需要3个步骤</strong>。</p><h1 id="3ed3" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">FlyControls用法</h1><p id="15c6" class="pw-post-body-paragraph iq ir hi is b it ky iv iw ix kz iz ja jb la jd je jf lb jh ji jj lc jl jm jn hb bi translated">在这次提交中，我提交了工作代码来演示<code class="du jo jp jq jr b">FlyControls</code> <a class="ae jz" href="https://github.com/franky-adl/threejs-camera-demo/tree/a816f8563694b43fd7864af35ac777c77e73a802" rel="noopener ugc nofollow" target="_blank">在我的Github repo上的基本用法。在下面我正在粘贴的<code class="du jo jp jq jr b">index.js</code>中，跟随编号注释来理解它的用法:</a></p><pre class="ls lt lu lv fd lw jr lx ly aw lz bi"><span id="9739" class="ma kb hi jr b fi mb mc l md me">import './style.css';</span><span id="3487" class="ma kb hi jr b fi mf mc l md me">import * as THREE from 'three';<br/>// 1. import FlyControls<br/>import { FlyControls } from 'three/examples/jsm/controls/FlyControls'</span><span id="7d88" class="ma kb hi jr b fi mf mc l md me">import { addWallLighting, addRoom } from './common';</span><span id="c4e0" class="ma kb hi jr b fi mf mc l md me">let camera, scene, canvas, controls, renderer</span><span id="cc98" class="ma kb hi jr b fi mf mc l md me">init()<br/>animate()</span><span id="f6b3" class="ma kb hi jr b fi mf mc l md me">function init() {<br/>  scene = new THREE.Scene();<br/>  canvas = document.querySelector("#canvas");</span><span id="7b06" class="ma kb hi jr b fi mf mc l md me">  // Set up the renderer<br/>  renderer = new THREE.WebGLRenderer({canvas});<br/>  renderer.setSize( window.innerWidth, window.innerHeight );</span><span id="f855" class="ma kb hi jr b fi mf mc l md me">  // Set up camera<br/>  camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 1, 500);<br/>  camera.position.set( 0, 75, 160 );</span><span id="26de" class="ma kb hi jr b fi mf mc l md me">  // 2. Initiate FlyControls with various params<br/>  controls = new FlyControls( camera, renderer.domElement );<br/>  controls.movementSpeed = 100;<br/>  controls.rollSpeed = Math.PI / 24;<br/>  controls.autoForward = false;<br/>  controls.dragToLook = true;</span><span id="7867" class="ma kb hi jr b fi mf mc l md me">  // set up a basic room scene<br/>  addWallLighting(scene);<br/>  addRoom(scene);<br/>}</span><span id="26ba" class="ma kb hi jr b fi mf mc l md me">// Animate the scene<br/>function animate() {<br/>  renderer.render( scene, camera );</span><span id="2565" class="ma kb hi jr b fi mf mc l md me">  // 3. update controls with a small step value to "power its engines"<br/>  controls.update(0.01)</span><span id="ff4e" class="ma kb hi jr b fi mf mc l md me">  requestAnimationFrame( animate );<br/>};</span></pre><p id="eebe" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">除了编号代码部分之外的其他代码有助于建立一个基本的Three.js场景，即使你是Three.js初学者，你也应该很快认出这个模式。</p><p id="35ed" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我将<code class="du jo jp jq jr b">dragToLook</code>设置为true，这样自由摄像机就不会随着我的鼠标在场景上移动，我之前发现这很烦人。现在，只有当我用鼠标拖动或按键时，它才会移动。</p><p id="212e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du jo jp jq jr b">FlyControls</code>和<code class="du jo jp jq jr b">OrbitControls</code>最大的区别是你需要在你的动画循环中加入第三步<code class="du jo jp jq jr b">controls.update(delta)</code>来让它工作。起初，我不知道需要调用第三步，我想‘WTH，我的相机不动了！’30分钟，因为我最初认为这将是一样的<code class="du jo jp jq jr b">OrbitControls</code>。在检查了<code class="du jo jp jq jr b">FlyControls</code>的源代码后，发现<code class="du jo jp jq jr b">update</code>函数是摄像机移动的驱动程序:</p><pre class="ls lt lu lv fd lw jr lx ly aw lz bi"><span id="e203" class="ma kb hi jr b fi mb mc l md me">this.update = function ( delta ) {</span><span id="4422" class="ma kb hi jr b fi mf mc l md me">    const moveMult = delta * scope.movementSpeed;<br/>    const rotMult = delta * scope.rollSpeed;</span><span id="0ca0" class="ma kb hi jr b fi mf mc l md me">    scope.object.translateX( scope.moveVector.x * moveMult );<br/>    scope.object.translateY( scope.moveVector.y * moveMult );<br/>    scope.object.translateZ( scope.moveVector.z * moveMult );</span><span id="7504" class="ma kb hi jr b fi mf mc l md me">    scope.tmpQuaternion.set( scope.rotationVector.x * rotMult, scope.rotationVector.y * rotMult, scope.rotationVector.z * rotMult, 1 ).normalize();<br/>    scope.object.quaternion.multiply( scope.tmpQuaternion );</span><span id="8c33" class="ma kb hi jr b fi mf mc l md me">    if (<br/>        lastPosition.distanceToSquared( scope.object.position ) &gt; EPS ||<br/>        8 * ( 1 - lastQuaternion.dot( scope.object.quaternion ) ) &gt; EPS<br/>    ) {</span><span id="260f" class="ma kb hi jr b fi mf mc l md me">        scope.dispatchEvent( _changeEvent );<br/>        lastQuaternion.copy( scope.object.quaternion );<br/>        lastPosition.copy( scope.object.position );</span><span id="d549" class="ma kb hi jr b fi mf mc l md me">    }</span><span id="f75e" class="ma kb hi jr b fi mf mc l md me">};</span></pre><p id="192a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">所以有两个地方你可以调整你的<code class="du jo jp jq jr b">FlyControls</code>的飞行速度，第一个是<code class="du jo jp jq jr b">controls.movementSpeed</code>，第二个是你传递给<code class="du jo jp jq jr b">controls.update(step)</code>的步长值，最后两者基本上是相乘的正如你在上面的源代码中看到的。</p><h1 id="f77f" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">获取自由摄像机的位置和注视向量</h1><p id="cb51" class="pw-post-body-paragraph iq ir hi is b it ky iv iw ix kz iz ja jb la jd je jf lb jh ji jj lc jl jm jn hb bi translated">现在我们有了一个可以工作的自由摄像机，当你在场景中飞行时，你可能也想知道摄像机的位置和注视向量。因为如果你正在为你的场景寻找一个完美的角度，你将需要为你的相机设置正确的位置和注视向量。</p><p id="3a09" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">摄像机的位置很容易得到，只需访问position属性的x/y/z属性，就像这样:<code class="du jo jp jq jr b">camera.position.x</code>。但是获取相机的观察向量有点棘手，因为没有直接的方法。不要担心，我会解释我们如何在你飞来飞去的时候在场景中显示相机的位置向量和注视向量。</p><p id="78d8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下面的代码可以在<a class="ae jz" href="https://github.com/franky-adl/threejs-camera-demo/tree/ed8f80e9343d6c76c62d6953d75cee61b698d45e" rel="noopener ugc nofollow" target="_blank">这个提交</a>中找到。</p><p id="be9d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">首先，让我们在<code class="du jo jp jq jr b">index.html</code>中添加span元素:</p><pre class="ls lt lu lv fd lw jr lx ly aw lz bi"><span id="14e0" class="ma kb hi jr b fi mb mc l md me">&lt;!doctype html&gt;<br/>&lt;html class="no-js" lang=""&gt;</span><span id="6f2d" class="ma kb hi jr b fi mf mc l md me">&lt;head&gt;<br/>  &lt;meta charset="utf-8"&gt;<br/>  &lt;title&gt;ThreeJS Camera Demo&lt;/title&gt;<br/>  &lt;meta name="description" content="Your Site Description."&gt;<br/>  &lt;meta name="viewport" content="minimum-scale=1, initial-scale=1, width=device-width"&gt;<br/>&lt;/head&gt;</span><span id="05a8" class="ma kb hi jr b fi mf mc l md me">&lt;body&gt;<br/>  &lt;canvas id="canvas"&gt;&lt;/canvas&gt;<br/>  &lt;!-- 1. create spans for displaying camera position and lookAt vectors --&gt;<br/>  &lt;div id="camera-vectors"&gt;<br/>    &lt;span&gt;Free Camera Vectors:&lt;/span&gt;&lt;br&gt;<br/>    &lt;span id="position"&gt;&lt;/span&gt;&lt;br&gt;<br/>    &lt;span id="lookingAt"&gt;&lt;/span&gt;<br/>  &lt;/div&gt;<br/>&lt;/body&gt;</span><span id="302b" class="ma kb hi jr b fi mf mc l md me">&lt;/html&gt;</span></pre><p id="a706" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后添加css使其位于<code class="du jo jp jq jr b">style.css</code>的右上方:</p><pre class="ls lt lu lv fd lw jr lx ly aw lz bi"><span id="f6a6" class="ma kb hi jr b fi mb mc l md me">body {<br/>  margin: 0;<br/>}</span><span id="fc3b" class="ma kb hi jr b fi mf mc l md me">#canvas {<br/>  width: 100%;<br/>  height: 100%;<br/>  display: block;<br/>}</span><span id="205f" class="ma kb hi jr b fi mf mc l md me">/* 2. set appropriate css for the camera vectors */<br/>#camera-vectors {<br/>  position: absolute;<br/>  top: 0;<br/>  right: 0;<br/>  background: grey;<br/>  padding: 8px;<br/>  color: white;<br/>}</span></pre><p id="9766" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后，按照<code class="du jo jp jq jr b">index.js</code>中的步骤3至5计算并显示位置和注视矢量值:</p><pre class="ls lt lu lv fd lw jr lx ly aw lz bi"><span id="9afe" class="ma kb hi jr b fi mb mc l md me">import './style.css';</span><span id="26e2" class="ma kb hi jr b fi mf mc l md me">import * as THREE from 'three';</span><span id="c1fe" class="ma kb hi jr b fi mf mc l md me">import { FlyControls } from 'three/examples/jsm/controls/FlyControls'</span><span id="d0da" class="ma kb hi jr b fi mf mc l md me">import { addWallLighting, addRoom } from './common';</span><span id="b6c8" class="ma kb hi jr b fi mf mc l md me">let camera, scene, canvas, controls, renderer<br/>// 3. define cameraDirection and span variables<br/>let cameraDirection = new THREE.Vector3()<br/>let camPositionSpan, camLookAtSpan</span><span id="0e99" class="ma kb hi jr b fi mf mc l md me">init()<br/>animate()</span><span id="7100" class="ma kb hi jr b fi mf mc l md me">function init() {<br/>  scene = new THREE.Scene();<br/>  canvas = document.querySelector("#canvas");<br/>  // 4. set the spans with the queried HTML DOM elements<br/>  camPositionSpan = document.querySelector("#position");<br/>  camLookAtSpan = document.querySelector("#lookingAt");</span><span id="0ad5" class="ma kb hi jr b fi mf mc l md me">  // Set up the renderer<br/>  renderer = new THREE.WebGLRenderer({canvas});<br/>  renderer.setSize( window.innerWidth, window.innerHeight );</span><span id="81a9" class="ma kb hi jr b fi mf mc l md me">  // Set up camera<br/>  camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 1, 500);<br/>  camera.position.set(0, 75, 160);</span><span id="2d4d" class="ma kb hi jr b fi mf mc l md me">  // Initiate FlyControls with various params<br/>  controls = new FlyControls( camera, renderer.domElement );<br/>  controls.movementSpeed = 100;<br/>  controls.rollSpeed = Math.PI / 24;<br/>  controls.autoForward = false;<br/>  controls.dragToLook = true;</span><span id="3c39" class="ma kb hi jr b fi mf mc l md me">  // set up a basic room scene<br/>  addWallLighting(scene);<br/>  addRoom(scene);<br/>}</span><span id="fe40" class="ma kb hi jr b fi mf mc l md me">// Animate the scene<br/>function animate() {<br/>  renderer.render( scene, camera );</span><span id="991a" class="ma kb hi jr b fi mf mc l md me">  // update controls with a small step value to "power its engines"<br/>  controls.update(0.01)</span><span id="8429" class="ma kb hi jr b fi mf mc l md me">  // 5. calculate and display the vector values on screen<br/>  // this copies the camera's unit vector direction to cameraDirection<br/>  camera.getWorldDirection(cameraDirection)<br/>  // scale the unit vector up to get a more intuitive value<br/>  cameraDirection.set(cameraDirection.x * 100, cameraDirection.y * 100, cameraDirection.z * 100)<br/>  // update the onscreen spans with the camera's position and lookAt vectors<br/>  camPositionSpan.innerHTML = `Position: (${camera.position.x.toFixed(1)}, ${camera.position.y.toFixed(1)}, ${camera.position.z.toFixed(1)})`<br/>  camLookAtSpan.innerHTML = `LookAt: (${(camera.position.x + cameraDirection.x).toFixed(1)}, ${(camera.position.y + cameraDirection.y).toFixed(1)}, ${(camera.position.z + cameraDirection.z).toFixed(1)})`</span><span id="241f" class="ma kb hi jr b fi mf mc l md me">  requestAnimationFrame( animate );<br/>};</span></pre><p id="c96d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这里的技巧是首先通过<code class="du jo jp jq jr b">camera.<a class="ae jz" href="https://threejs.org/docs/#api/en/cameras/Camera.getWorldDirection" rel="noopener ugc nofollow" target="_blank">getWorldDirection</a></code>得到一个单位向量，这个向量表示相机正在看的世界空间方向。结果正在被复制到<code class="du jo jp jq jr b">cameraDirection</code>中。因为它是一个单位向量，我们想放大这些值，这样这些数字在你的场景中更有意义。然后，为了得到你的摄像机正看着的点的最终世界空间矢量，我们把摄像机的位置矢量和放大的<code class="du jo jp jq jr b">cameraDirection</code>相加。这是<a class="ae jz" href="https://www.intmath.com/vectors/7-vectors-in-3d-space.php#adding" rel="noopener ugc nofollow" target="_blank">我们通常如何做矢量加法</a>，简单地分别把x/y/z相加，你就完成了。</p><p id="d377" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">结果是右上角的这个简洁的小部件显示了我们的免费摄像机在哪里，并实时查看:</p><figure class="ls lt lu lv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mg"><img src="../Images/f61b8256ba8647dbd62b819782a75d87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P4VJ19ctJ6sv1npuCE6m2Q.png"/></div></div></figure></div></div>    
</body>
</html>