<html>
<head>
<title>Microservices as Functions in BigQuery — Language Translation using SQL (Part 1)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">微服务作为BigQuery中的函数——使用SQL进行语言翻译(第1部分)</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/microservices-as-functions-in-bigquery-language-translation-using-sql-part-1-bd875b291338?source=collection_archive---------9-----------------------#2022-12-14">https://medium.com/geekculture/microservices-as-functions-in-bigquery-language-translation-using-sql-part-1-bd875b291338?source=collection_archive---------9-----------------------#2022-12-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="c11a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">了解如何在SQL查询中使用翻译API。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/2aac5bd73ea32d54d8efbaede84432c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XoZTaGE9SVFST_SW"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Photo by <a class="ae jt" href="https://unsplash.com/@patrickian4?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Patrick Fore</a> on <a class="ae jt" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="3f91" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">动机</h1><p id="689c" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">我已经用BigQuery用户定义函数(UDF)进行了一段时间的试验，我发现它们很强大——但也很有限。</p><p id="7bca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">简而言之，UDF允许您定义自己的用SQL或Javascript编写的定制SQL来处理BigQuery中的数据。这样，您可以执行标准BigQuery函数中没有的复杂数据转换或操作。</p><p id="a878" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我注意到的局限性如下:</p><ul class=""><li id="7cbd" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lc ld le lf bi translated">它们不能用于对外部服务进行API调用——这意味着如果您想要从外部服务访问元数据，您将需要使用不同的方法。</li><li id="c508" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">它们只能用Javascript或SQL编写——这意味着如果您更习惯使用另一种编程语言，如Python，您将无法使用UDF。</li></ul><p id="b6be" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">今年早些时候发布了一个解决这些限制的方法，叫做<a class="ae jt" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/remote-functions" rel="noopener ugc nofollow" target="_blank">远程功能</a>。</p><blockquote class="ll lm ln"><p id="4f10" class="if ig lo ih b ii ij ik il im in io ip lp ir is it lq iv iw ix lr iz ja jb jc hb bi translated"><em class="hi"> Google文档:BigQuery远程函数允许你用SQL和Javascript之外的其他语言实现你的函数，或者用BigQuery </em> <a class="ae jt" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/user-defined-functions" rel="noopener ugc nofollow" target="_blank"> <em class="hi">用户自定义函数</em> </a> <em class="hi">中不允许的库或服务实现你的函数。</em></p></blockquote></div><div class="ab cl ls lt gp lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="hb hc hd he hf"><p id="c76d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个由两部分组成的教程中，我们将使用云函数构建两个微服务，并在BigQuery中将它们实现为SQL函数。</p><p id="db7e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在第1部分中，我们将构建一个web应用程序，它使用Azure Translator API获取文本输入并将其翻译成所需的语言。</p><p id="7e8b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在第2部分中，我们将构建一个web应用程序，该应用程序使用MaxMind的离线数据库将IP地址作为输入，并检索地理位置信息，如国家、城市和邮政编码。</p><p id="bba8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这两种情况下，我们都将在BigQuery的玩具数据集中测试最终的SQL函数。</p><h1 id="f4c6" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">运行成本</h1><p id="bdd0" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">现在你应该想知道运行一个web应用程序的成本，以及使用翻译API的成本。值得这么麻烦吗？是的，确实如此。</p><p id="096f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于网络应用，我们将使用谷歌的云功能，这比租用服务器更具成本效益，因为它们只在使用时收费。我们将使用免费层，目前每月免费提供200万次调用。在这里阅读更多<a class="ae jt" href="https://cloud.google.com/functions/pricing" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="50b3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于翻译API，我们将使用Azure的翻译API。我们将使用免费层，目前每月免费提供200万个字符。点击阅读更多<a class="ae jt" href="https://azure.microsoft.com/en-us/pricing/details/cognitive-services/translator/" rel="noopener ugc nofollow" target="_blank">。</a></p><h1 id="b342" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">语言翻译功能</h1><p id="7f26" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">完整的代码可以在这里找到<a class="ae jt" href="https://github.com/justdataplease/bigquery-translation" rel="noopener ugc nofollow" target="_blank">。</a></p><h1 id="53a3" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">0.先决条件</h1><p id="0ec1" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">要继续，我们需要确保完成以下工作:</p><ul class=""><li id="2af5" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lc ld le lf bi translated">启用谷歌云功能。在这里阅读更多<a class="ae jt" href="https://cloud.google.com/functions/docs/create-deploy-gcloud" rel="noopener ugc nofollow" target="_blank"/>。</li><li id="6f37" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">本地安装和配置gcloud CLI。在这里阅读更多<a class="ae jt" href="https://cloud.google.com/sdk/docs/install" rel="noopener ugc nofollow" target="_blank"/>。</li><li id="1c27" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">启用Azure翻译器API。点击阅读更多<a class="ae jt" href="https://learn.microsoft.com/en-us/azure/cognitive-services/translator/translator-text-apis?tabs=csharp" rel="noopener ugc nofollow" target="_blank">。</a></li></ul><p id="4444" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此外，为了运行下面的代码片段，我们需要用我们自己的变量替换下面的变量:</p><ul class=""><li id="c6cf" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lc ld le lf bi translated"><your-project-id/></li><li id="4431" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated"><gcf-conn-name>(第二步)</gcf-conn-name></li><li id="0c9d" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated"><gcf-endpoint>(第四步)</gcf-endpoint></li></ul><p id="b9bb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="lo">遵循教程的一个简单方法是复制Readme.md并搜索——使用编辑器用您自己的值替换上面的值。</em></p><h1 id="47d2" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">1.克隆存储库(CLI)</h1><p id="9816" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">我们将从克隆回购开始。</p><pre class="je jf jg jh fd lz ma mb bn mc md bi"><span id="b076" class="me jv hi ma b be mf mg l mh mi">git clone https://github.com/justdataplease/bigquery-translation.git</span></pre><pre class="mj lz ma mb bn mc md bi"><span id="f180" class="me jv hi ma b be mf mg l mh mi">cd bigquery-translation</span></pre><p id="7081" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">回购目录具有以下结构:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es mk"><img src="../Images/26d5cce88f39753aa41efe3e76b5ac45.png" data-original-src="https://miro.medium.com/v2/resize:fit:674/format:webp/0*Ku2u80uWdqHBOMWN.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx">Language Translation app structure, Photo by Author.</figcaption></figure><p id="fcd6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">。env_sample </strong>:包含带有一些样本值的环境变量。<br/>稍后，我们将从<em class="lo">开始对其进行重命名。env_sample - &gt;。env </em>并用我们自己的值替换样本值。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ml"><img src="../Images/897da7391c1530b83cf8575f84a43210.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*omBSCQYemNJtBPyaNBv6iA.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Variables with sample values in .env file, Photo by Author.</figcaption></figure><p id="b47e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> translation.py </strong>:包含Translator类，用于将文本从一种语言翻译成另一种语言。translate_text()方法接受一个文本字符串和一种目标语言，并返回翻译后的文本。它还提供了指定文本的原始语言(from_language)或自动检测它的选项。对于本教程，我们将自动检测原始语言。Translator类使用Azure的Translator文本API来执行翻译。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mm"><img src="../Images/eb561f3f359e89b836ddfe6915389f23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*WMoRrIkarboI_1wz.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Translator API keys, Photo by Author.</figcaption></figure><p id="696d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> main.py: </strong>包含了我们的云函数的代码。</p><pre class="je jf jg jh fd lz ma mb bn mc md bi"><span id="3a40" class="me jv hi ma b be mf mg l mh mi">import json<br/><br/>import functions_framework<br/>from translation import Translator<br/><br/><br/>@functions_framework.http<br/>def translate(request):<br/>    """<br/>    Defines translate Google Cloud Function<br/>    :param request:<br/>    :return:<br/>    """<br/>    request_json = request.get_json()<br/>    calls = request_json['calls']<br/>    replies = []<br/>    trans = Translator()<br/>    for call in calls:<br/>        text = call[0]<br/>        to_language = call[1]<br/>        rs = trans.translate_text(text=text, to_language=to_language)<br/>        # each reply is a STRING (JSON not currently supported)<br/>        replies.append(json.dumps(rs, ensure_ascii=False))<br/><br/>    return json.dumps({'replies': replies})</span></pre><p id="7045" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了使用BigQuery，这个函数有一个特殊的形式。它应该接受多行(调用)作为输入，并遍历每一行(<em class="lo">调用</em>)来执行翻译过程。对于每一行(<em class="lo">调用</em>，它拉两列(<em class="lo">调用【0】</em><em class="lo">调用【1】</em>)。第一个被视为我们要翻译的文本(<em class="lo"> text = call[0] </em>)，第二个被视为我们要将文本翻译成的所需语言(<em class="lo"> to_language = call[1] </em>)。最后，我们将每个响应收集到一个名为<em class="lo"> replies </em>的列表中，并将这个列表转换成一个字符串。</p><p id="3f80" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">test _ Cloud _ Function . py:</strong>包含测试我们的云函数的代码。我们会在云功能部署后使用。</p><h1 id="635e" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">2.部署云功能(CLI)</h1><p id="963c" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">首先，要部署我们的云功能，我们需要确保</p><ul class=""><li id="833c" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lc ld le lf bi translated">我们位于<em class="lo">大查询翻译</em>目录的根目录。</li><li id="bcd9" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">我们已经改名了。环境样本到。env和我们已经用我们自己的改变了<em class="lo"> AZURE_TRANSLATION_KEY </em>和<em class="lo"> AZURE_TRANSLATION_LOCATION的样本值(我们将在部署云函数后指定<em class="lo"> CLOUD_FUNCTION_URL </em>)。</em></li></ul><p id="b46a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，我们应该运行下面的命令，将我们的目录部署为云功能。要了解所用参数的更多信息，请阅读此处的<a class="ae jt" href="https://cloud.google.com/sdk/gcloud/reference/functions/deploy" rel="noopener ugc nofollow" target="_blank"/>。</p><pre class="je jf jg jh fd lz ma mb bn mc md bi"><span id="2c34" class="me jv hi ma b be mf mg l mh mi">gcloud functions deploy bigquery-translation --gen2 --runtime python39 --trigger-http --project=&lt;your-project-id&gt; --entry-point=translate --source . --region=europe-west3 --memory=128Mi --max-instances=3 --allow-unauthenticated</span></pre><p id="ef73" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> - allow-unauthenticated:为了简单起见，我们添加了这个参数，使我们的函数成为公共函数。如果再现，最好避免使用该参数。</strong></p><p id="b06c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从最后一条命令的输出中，我们应该注意到URI(即https://big query-iplookup-XXXXXX . a . run . app)或者访问<a class="ae jt" href="https://console.cloud.google.com/functions/list" rel="noopener ugc nofollow" target="_blank"> Google Cloud控制台函数</a>。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es mn"><img src="../Images/ca9066fd7725e0c1c2633501a9a825f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/0*EtsUN8dW_SDgiynj.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx">Cloud Function output when deployed successfully, Photo by Author.</figcaption></figure><p id="ea07" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在为了测试云函数，我们可以在我们的<em class="lo">中更新<em class="lo"> CLOUD_FUNCTION_URL </em>。env文件</em>并运行下面的代码。</p><pre class="je jf jg jh fd lz ma mb bn mc md bi"><span id="f487" class="me jv hi ma b be mf mg l mh mi">python test_cloud_function.py</span></pre><pre class="mj lz ma mb bn mc md bi"><span id="e7b4" class="me jv hi ma b be mf mg l mh mi"># Input<br/>data = {<br/>    "calls": [<br/>        ["Programming is great", "es"],<br/>        ["Support me as a writer", "es"]<br/>    ]<br/>}<br/><br/># Output<br/>{'replies': [<br/>'{"detected_lang": "en", "detected_conf": 1.0, <br/>"trans_text": "la programación es genial", "trans_lang": "es", "error": ""}', <br/>'{"detected_lang": "en", "detected_conf": 1.0, <br/>"trans_text": "apóyame como escritor", "trans_lang": "es", "error": ""}'<br/>]}</span></pre><p id="3980" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从我们得到的输出中，我们可以看到我们的云功能正在工作！</p><h1 id="2cb4" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">3.在BigQuery和云函数(CLI)之间创建连接</h1><p id="6ad6" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">我们需要连接BigQuery和云函数，以便将云函数用作远程函数。</p><pre class="je jf jg jh fd lz ma mb bn mc md bi"><span id="dcc2" class="me jv hi ma b be mf mg l mh mi">gcloud components update<br/>bq mk --connection --display_name='my_gcf_conn' --connection_type=CLOUD_RESOURCE --project_id=&lt;your-project-id&gt; --location=EU gcf-conn<br/>bq show --project_id=&lt;your-project-id&gt; --location=EU --connection gcf-conn</span></pre><p id="530b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从最后一个命令的输出(<em class="lo"> bq show </em>)中，我们应该记下这个名称(即xxxxxx.eu.gcf-conn)，因为我们稍后会用到它。</p><h1 id="1e33" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">4.创建玩具数据集(CLI)</h1><p id="87f1" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">为了测试我们的功能，我们将创建一个玩具数据集。这个数据集将包括我们的远程函数和一个包含一些测试数据的表。</p><pre class="je jf jg jh fd lz ma mb bn mc md bi"><span id="0c65" class="me jv hi ma b be mf mg l mh mi">bq mk --dataset_id=&lt;your-project-id&gt;:translation --location=EU</span></pre><h1 id="e2cc" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">5.创建一个示例表(BigQuery)</h1><p id="47a6" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">为了测试我们的远程函数，我们将创建一个包含测试数据的表。</p><pre class="je jf jg jh fd lz ma mb bn mc md bi"><span id="9dcb" class="me jv hi ma b be mf mg l mh mi">CREATE OR REPLACE TABLE `&lt;your-project-id&gt;.translation.example_table` (<br/>      text STRING,<br/>      to_language STRING<br/>    );<br/>    <br/>INSERT INTO `&lt;your-project-id&gt;.translation.example_table`(text, to_language)<br/>    VALUES ('I love programming', 'es'),<br/>           ('We are learning great things today', 'es'),<br/>           ('Support me as a writer', 'es'),<br/>           ('Support me as a writer', 'fr'),<br/>           ('Support me as a writer', 'de');</span></pre><h1 id="70e4" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">6.创建远程函数(BigQuery)</h1><p id="a357" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">最后，我们将创建我们的远程函数。</p><pre class="je jf jg jh fd lz ma mb bn mc md bi"><span id="fb71" class="me jv hi ma b be mf mg l mh mi">CREATE OR REPLACE FUNCTION `&lt;your-project-id&gt;.translation.translate`(text STRING, to_language STRING)<br/>RETURNS STRING<br/>REMOTE WITH CONNECTION `&lt;gcf-conn-name&gt;`<br/>        OPTIONS (<br/>        -- change this to reflect the Trigger URL of your Cloud Function (look   for the TRIGGER tab)<br/>            endpoint = '&lt;gcf-endpoint&gt;'<br/>        );</span></pre><h1 id="7055" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">7.测试远程函数(BigQuery)</h1><p id="7dc0" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">为了测试我们的远程函数，我们将在测试数据上运行它。该函数的输出是一个字符串，所以我们需要解析它，将信息提取到列中。</p><pre class="je jf jg jh fd lz ma mb bn mc md bi"><span id="810c" class="me jv hi ma b be mf mg l mh mi">WITH A AS (SELECT `&lt;your-project-id&gt;.translation.translate`(text,to_language) trans_rs,text origin_text FROM `&lt;your-project-id&gt;.translation.example_table`)<br/>    <br/>select<br/>origin_text,<br/>json_value(trans_rs, '$.detected_lang') detected_lang,<br/>json_value(trans_rs, '$.detected_conf') detected_conf,<br/>json_value(trans_rs, '$.trans_text') trans_text,<br/>json_value(trans_rs, '$.trans_lang') trans_lang,<br/>json_value(trans_rs, '$.error') error<br/>from a A;</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mo"><img src="../Images/1bec1941988992ccb9806ef42ea1cf9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*vtC5wreXxsXwBRTG.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Language Translation using SQL, Photo by Admin.</figcaption></figure><p id="0668" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们做到了！我们的功能起作用了。</p><p id="4fcd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我提醒你，这个功能正在使用付费的外部API，即使我们是免费的，我们也不应该忘记明智地使用它。</p><h1 id="db35" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">8.删除所有内容(CLI)</h1><p id="3bf0" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">要删除云函数、远程函数和玩具数据集，我们需要运行以下命令:</p><pre class="je jf jg jh fd lz ma mb bn mc md bi"><span id="9775" class="me jv hi ma b be mf mg l mh mi"># Remove Cloud Function (gcf)<br/>gcloud functions delete bigquery-translation --region=europe-west3 --project=&lt;your-project-id&gt; --gen2<br/><br/># Remove DATASET<br/>bq rm -r -f -d &lt;your-project-id&gt;:translation<br/><br/># Remove connection between BigQuery and Cloud Functions (gcf-conn)<br/>bq rm --connection --location=EU &lt;gcf-conn-name&gt;</span></pre><h1 id="6f67" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">结论</h1><p id="9639" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">在本系列的第1部分中，我们展示了如何使用SQL执行语言翻译，这是一项用标准的Bigquery UDFs无法完成的任务。在接下来的第2部分中，我们将探索如何在不调用API的情况下查找IP地址来检索地理位置数据，敬请关注！</p></div><div class="ab cl ls lt gp lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="hb hc hd he hf"><p id="d25e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可能还会对我的故事感兴趣，这个故事讲述了如何使用BigQuery Javascript UDFs来执行复杂的预处理任务，比如词干提取。</p><div class="mp mq ez fb mr ms"><a rel="noopener follow" target="_blank" href="/mlearning-ai/extend-bigquery-nlp-armory-with-stemmers-995fae853b0e"><div class="mt ab dw"><div class="mu ab mv cl cj mw"><h2 class="bd hj fi z dy mx ea eb my ed ef hh bi translated">用词干分析器扩展BigQuery NLP库</h2><div class="mz l"><h3 class="bd b fi z dy mx ea eb my ed ef dx translated">使用Javascript UDFs实现英语、西班牙语和希腊语词干分析器。</h3></div><div class="na l"><p class="bd b fp z dy mx ea eb my ed ef dx translated">medium.com</p></div></div><div class="nb l"><div class="nc l nd ne nf nb ng jn ms"/></div></div></a></div></div><div class="ab cl ls lt gp lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="hb hc hd he hf"><p id="bc90" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你喜欢阅读这样的故事，并想支持我作为一名作家，请考虑<strong class="ih hj">跟随我</strong>和<strong class="ih hj">砸那个拍手按钮</strong>。<br/>谢谢你的支持！</p></div></div>    
</body>
</html>