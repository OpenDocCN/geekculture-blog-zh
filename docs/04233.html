<html>
<head>
<title>How iOS 15 makes your app launch faster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">iOS 15如何让你的应用启动更快</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/how-ios-15-makes-your-app-launch-faster-51cf0aa6c520?source=collection_archive---------0-----------------------#2021-06-23">https://medium.com/geekculture/how-ios-15-makes-your-app-launch-faster-51cf0aa6c520?source=collection_archive---------0-----------------------#2021-06-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/8ebcd72966b516e26b4ab70bb397c78f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ce9bGZAEZVIJvhizc4P_Gg.png"/></div></div></figure><div class=""/><div class=""><h2 id="c8c0" class="pw-subtitle-paragraph iq hs ht bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh dx translated">在<a class="ae ji" href="https://www.emergetools.com/blog/posts/iOS15LaunchTime" rel="noopener ugc nofollow" target="_blank"> Emerge Tools博客</a>上阅读这篇文章的完整版本</h2></div><p id="88ed" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">WWDC21最吸引人的功能被深埋在Xcode 13发行说明中:</p><blockquote class="kf kg kh"><p id="a4f3" class="jj jk ki jl b jm jn iu jo jp jq ix jr kj jt ju jv kk jx jy jz kl kb kc kd ke hb bi translated">所有以macOS 12或iOS 15或更高版本为部署目标构建的程序和<code class="du km kn ko kp b">dylibs</code>现在都使用链接修正格式。这使用不同的加载命令和链接编辑数据，不能在旧版本的操作系统上运行或加载。</p></blockquote><p id="911d" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">没有任何文档或会议来了解关于这一变化的更多信息，但我们可以对其进行逆向工程，以了解苹果在新操作系统上有什么不同，以及它是否会对您的应用程序有所帮助。首先，介绍一下控制应用程序启动的程序的背景。</p><h2 id="188c" class="kq kr ht bd ks kt ku kv kw kx ky kz la js lb lc ld jw le lf lg ka lh li lj lk bi translated">见见戴尔</h2><p id="ae72" class="pw-post-body-paragraph jj jk ht jl b jm ll iu jo jp lm ix jr js ln ju jv jw lo jy jz ka lp kc kd ke hb bi translated">动态链接器(dyld)是每个应用程序的入口点。它负责让您的代码准备好运行，因此对dyld的任何改进都会导致应用程序启动时间的缩短。在调用main、运行静态初始化器或设置Objective-C运行时之前，dyld执行修正。这些操作包括rebase和bind操作，它们修改app二进制文件中的指针，以包含在运行时有效的地址。要查看它们的样子，您可以使用<code class="du km kn ko kp b">dyldinfo</code>命令行工具。</p><pre class="lq lr ls lt fd lu kp lv lw aw lx bi"><span id="cd07" class="kq kr ht kp b fi ly lz l ma mb">% xcrun dyldinfo -rebase -bind Snapchat.app/Snapchat<br/>rebase information (from compressed dyld info):<br/>segment section          address     type<br/>__DATA  __got            0x10748C0C8  pointer<br/>...<br/>bind information:<br/>segment section address     type    addend dylib        symbol<br/>__DATA  __const 0x107595A70 pointer 0      libswiftCore _$sSHMp</span></pre><p id="6241" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">这意味着地址<code class="du km kn ko kp b">0x10748C0C8</code>位于<code class="du km kn ko kp b">__DATA/__got</code>中，需要移动一个常数值(称为滑动)。而地址<code class="du km kn ko kp b">0x107595A70</code>在<code class="du km kn ko kp b">__DATA/__const</code>中，并且应该指向在<code class="du km kn ko kp b">libswiftCore.dylib</code>中找到的has able[1]的协议描述符</p><p id="170f" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">dyld使用<code class="du km kn ko kp b">LC_DYLD_INFO</code> load命令和<code class="du km kn ko kp b"><a class="ae ji" href="https://developer.apple.com/documentation/kernel/dyld_info_command" rel="noopener ugc nofollow" target="_blank">dyld_info_command</a></code> struct来确定二进制中rebases、binds和<a class="ae ji" href="https://github.com/qyang-nj/llios/blob/main/exported_symbol/README.md" rel="noopener ugc nofollow" target="_blank">导出符号</a> [2]的位置和大小。<a class="ae ji" href="https://emergetools.com" rel="noopener ugc nofollow" target="_blank">涌现</a>(免责声明:我是创始人😬)，解析这些数据，让您直观地看到它们对二进制文件大小的影响，并建议链接器标志使它们变小:</p><figure class="lq lr ls lt fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mc"><img src="../Images/66a8f63f81002c444d2d52f1e8f3c5cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xuvbj8du9_jfDScrZ9lTRA.png"/></div></div></figure><h2 id="16a0" class="kq kr ht bd ks kt ku kv kw kx ky kz la js lb lc ld jw le lf lg ka lh li lj lk bi translated">新的格式</h2><p id="6e2f" class="pw-post-body-paragraph jj jk ht jl b jm ll iu jo jp lm ix jr js ln ju jv jw lo jy jz ka lp kc kd ke hb bi translated">当我第一次上传一个为iOS 15构建的应用程序到<a class="ae ji" href="https://emergetools.com" rel="noopener ugc nofollow" target="_blank"> Emerge </a>时，没有dyld修复的可视化。这是因为<code class="du km kn ko kp b">LC_DYLD_INFO_ONLY</code>加载命令丢失，它已被<code class="du km kn ko kp b">LC_DYLD_CHAINED_FIXUPS</code>和<code class="du km kn ko kp b">LC_DYLD_EXPORTS_TRIE</code>取代。</p><pre class="lq lr ls lt fd lu kp lv lw aw lx bi"><span id="e775" class="kq kr ht kp b fi ly lz l ma mb">% otool -l iOS14Example.app/iOS14Example | grep LC_DYLD<br/>      cmd LC_DYLD_INFO_ONLY</span><span id="b8c1" class="kq kr ht kp b fi md lz l ma mb">% otool -l iOS15Example.app/iOS15Example | grep LC_DYLD<br/>      cmd LC_DYLD_CHAINED_FIXUPS<br/>      cmd LC_DYLD_EXPORTS_TRIE</span></pre><p id="080d" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">导出的数据与之前完全相同，是一个trie，其中每个节点代表一个符号名的一部分。</p><figure class="lq lr ls lt fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es me"><img src="../Images/50b2bba7eabc72f47499df134e5bd9f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5K-xerw4dop2E_Um-slQMQ.png"/></div></div><figcaption class="mf mg et er es mh mi bd b be z dx">Portion of the exports trie for Wikipedia</figcaption></figure><p id="2d8e" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">iOS 15中唯一的变化是数据现在被一个包含第一个节点偏移量的<code class="du km kn ko kp b"><a class="ae ji" href="https://developer.apple.com/documentation/kernel/linkedit_data_command" rel="noopener ugc nofollow" target="_blank">linkedit_data_command</a></code>引用。为了验证这一点，我编写了一个简短的Swift应用程序来解析iOS 15二进制文件并打印每个符号:</p><figure class="lq lr ls lt fd hk"><div class="bz dy l di"><div class="mj mk l"/></div></figure><h2 id="9466" class="kq kr ht bd ks kt ku kv kw kx ky kz la js lb lc ld jw le lf lg ka lh li lj lk bi translated">链接</h2><p id="0c74" class="pw-post-body-paragraph jj jk ht jl b jm ll iu jo jp lm ix jr js ln ju jv jw lo jy jz ka lp kc kd ke hb bi translated">真正的变化在<code class="du km kn ko kp b">LC_DYLD_CHAINED_FIXUPS</code>。在iOS 15之前，rebases、bind和lazy binds各自存储在一个单独的表中。现在它们已经被组合成链，指针指向包含在这个新的load命令中的链的起点…</p><h2 id="ae9b" class="kq kr ht bd ks kt ku kv kw kx ky kz la js lb lc ld jw le lf lg ka lh li lj lk bi translated">在<a class="ae ji" href="https://www.emergetools.com/blog/posts/iOS15LaunchTime" rel="noopener ugc nofollow" target="_blank"> Emerge Tools博客</a>上阅读这篇文章的完整版本</h2></div></div>    
</body>
</html>