<html>
<head>
<title>Angular VS Lighthouse — Part 3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">角度与灯塔—第三部分</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/angular-vs-lighthouse-part-3-848761a629f0?source=collection_archive---------16-----------------------#2021-05-13">https://medium.com/geekculture/angular-vs-lighthouse-part-3-848761a629f0?source=collection_archive---------16-----------------------#2021-05-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="3e2a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">提高分数的技巧和窍门。</p><p id="36b3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是一些有用的技巧和诀窍的第3部分，以增加灯塔得分，从而减少首页加载时间。你可以在这里  <strong class="ih hj"> </strong>找到Part 1 <a class="ae jd" rel="noopener" href="/geekculture/angular-vs-lighthouse-part-1-27a9ac6584f"> <strong class="ih hj">，在这里</strong> </a>找到Part 2 <a class="ae jd" rel="noopener" href="/geekculture/angular-vs-lighthouse-part-2-1ae627ca9aab"> <strong class="ih hj">。</strong></a></p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es je"><img src="../Images/77865610fdd5a05374e88ec3912cdd46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*LtCLhVq2W4mfx8atI83FKw.png"/></div></figure></div><div class="ab cl jm jn gp jo" role="separator"><span class="jp bw bk jq jr js"/><span class="jp bw bk jq jr js"/><span class="jp bw bk jq jr"/></div><div class="hb hc hd he hf"><h2 id="edeb" class="jt ju hi bd jv jw jx jy jz ka kb kc kd iq ke kf kg iu kh ki kj iy kk kl km kn bi translated">高的</h2><p id="1e21" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">如果您的项目需要下载一个外部文件翻译(比如使用<a class="ae jd" href="http://twitter.com/ngx" rel="noopener ugc nofollow" target="_blank"> @ngx </a> -translate和<a class="ae jd" href="http://twitter.com/ngx" rel="noopener ugc nofollow" target="_blank">@ ngx</a>-translate/HTTP-loader和一个. json翻译文件)，然后将这个文件包含到main.js包中。</p><p id="b4cf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果没有这种技术，Angular启动后，当翻译文件下载完成时，浏览器会重新绘制整个页面。因此，您将有一个双页重新绘制/重新布局，这可能会导致累积布局转移(CLS)了。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es kt"><img src="../Images/67638db57089f7d86ab1a12181ceafab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4sHZ4mo2diaSJZ0NMGDixA.png"/></div></div><figcaption class="ky kz et er es la lb bd b be z dx">Download translation file after Angular was started. Between SSR (server side rendering) and CSR (client side rendering) there are no translations provided so for each key there is a “<strong class="bd jv">…</strong>” instead</figcaption></figure><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es lc"><img src="../Images/abb848749a359e1c23c1836906f14c7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FgIN50NqZ6rwGTIzhYIgbw.png"/></div></div><figcaption class="ky kz et er es la lb bd b be z dx">Relative Lighthouse penalty in score and CLS</figcaption></figure><p id="2cf9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要将翻译文件包含到main.js包中，请遵循以下步骤:<br/> <strong class="ih hj"> 1) </strong>为了方便起见，在environments文件夹下创建一个环境文件:</p><pre class="jf jg jh ji fd ld le lf lg aw lh bi"><span id="463d" class="jt ju hi le b fi li lj l lk ll"><strong class="le hj">env_lang.ts</strong></span><span id="c4ac" class="jt ju hi le b fi lm lj l lk ll">export const env_lang = {<br/>  defaultLanguage: 'en',<br/>  inlineTranslations: require('../assets/i18n/en.json')<br/>};</span></pre><p id="ff03" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 2) </strong>创建一个实现TranslateLoader的服务:</p><pre class="jf jg jh ji fd ld le lf lg aw lh bi"><span id="7975" class="jt ju hi le b fi li lj l lk ll"><strong class="le hj">language-loader.ts</strong></span><span id="003b" class="jt ju hi le b fi lm lj l lk ll">const translations = env_lang.inlineTranslations;</span><span id="10ae" class="jt ju hi le b fi lm lj l lk ll"><a class="ae jd" href="http://twitter.com/Injectable" rel="noopener ugc nofollow" target="_blank">@Injectable</a>({providedIn: 'root'})<br/>export class LanguageLoader implements TranslateLoader {<br/>  constructor(private http: HttpClient) {}</span><span id="8947" class="jt ju hi le b fi lm lj l lk ll">getTranslation(lang: string) {<br/>    if (translations &amp;&amp; lang === env_lang.defaultLanguage) {<br/>      return of(translations);<br/>    } else {<br/>      return this.http.get(`./assets/i18n/${lang}.json`);<br/>    }<br/>  }<br/>}</span></pre><p id="5e4f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 3) </strong>在TranslateModule配置中提供LanguageLoader服务(在app模块导入中):</p><pre class="jf jg jh ji fd ld le lf lg aw lh bi"><span id="8340" class="jt ju hi le b fi li lj l lk ll"><strong class="le hj">app.module.ts</strong></span><span id="94d7" class="jt ju hi le b fi lm lj l lk ll">imports: [<br/>...<br/> TranslateModule.forRoot({<br/>  loader: {<br/>    provide: TranslateLoader,<br/>    useExisting: <strong class="le hj">LanguageLoader</strong>,<br/>    deps: [PLATFORM_ID, HttpClient]<br/>  }<br/>   })<br/>...<br/>]</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es lc"><img src="../Images/9df16435c1ae1e779ff2767e9208a57b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XgXM0HdMHmauBH75Nt8-Mg.png"/></div></div><figcaption class="ky kz et er es la lb bd b be z dx">Translation file included into main causes no difference between SSR and CSR</figcaption></figure><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es lc"><img src="../Images/fb025714a78f33c71eb9f67dca759222.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MULBFcSjhnxOTlymSfTVXQ.png"/></div></div><figcaption class="ky kz et er es la lb bd b be z dx">No CLS! No wait for download another file! +10 points!</figcaption></figure><p id="6736" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您的翻译文件太大，请尝试只包含优化页面所需的子集，并延迟下载整个文件。<br/>这不是一个简单的任务，但提高分数非常重要。如果有人对如何实现它感兴趣，请留下评论，我会准备一篇专门的文章。</p><p id="aa3e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意:</strong>一般来说，当加载一个&lt; div &gt;(或类似的)的内容时会发生CLS，它会改变div本身的高度或宽度，所以尽量设置一个固定的大小。当字体改变div的大小时，也会发生CLS。</p></div><div class="ab cl jm jn gp jo" role="separator"><span class="jp bw bk jq jr js"/><span class="jp bw bk jq jr js"/><span class="jp bw bk jq jr"/></div><div class="hb hc hd he hf"><h2 id="8018" class="jt ju hi bd jv jw jx jy jz ka kb kc kd iq ke kf kg iu kh ki kj iy kk kl km kn bi translated">低/中</h2><p id="b59d" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">通常我们为一个主题组织和分组代码，这是一个很好的实践。但是，如果我们希望更好地执行的页面只使用了一部分，那么我们必须分成两个不同的组:一个只用于最少的必要部分，另一个用于其余部分。<br/>如果另一页只使用第一组的一部分，理想的做法是另一次拆分。这个过程可以无限期地进行，但是你可以决定重复几次，因为你会在开发阶段失去一些轻松。这个问题通常出现在服务中，我们在服务中放了很多关于问题域的方法。</p></div><div class="ab cl jm jn gp jo" role="separator"><span class="jp bw bk jq jr js"/><span class="jp bw bk jq jr js"/><span class="jp bw bk jq jr"/></div><div class="hb hc hd he hf"><h2 id="6011" class="jt ju hi bd jv jw jx jy jz ka kb kc kd iq ke kf kg iu kh ki kj iy kk kl km kn bi translated">低的</h2><p id="7edf" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">下面你会发现几个小技巧。</p><ul class=""><li id="6927" class="ln lo hi ih b ii ij im in iq lp iu lq iy lr jc ls lt lu lv bi translated">移除旧的浏览器支持:</li></ul><pre class="jf jg jh ji fd ld le lf lg aw lh bi"><span id="7d0c" class="jt ju hi le b fi li lj l lk ll"><strong class="le hj">.browserslistsrc</strong></span><span id="4466" class="jt ju hi le b fi lm lj l lk ll">&gt; 0.5%<br/>last 2 versions<br/>Firefox ESR<br/>not dead<br/><strong class="le hj">IE 11 // Or remove totally IE support</strong></span></pre><ul class=""><li id="5ba6" class="ln lo hi ih b ii ij im in iq lp iu lq iy lr jc ls lt lu lv bi translated">尝试删除HTML中的空格:</li></ul><pre class="jf jg jh ji fd ld le lf lg aw lh bi"><span id="85f3" class="jt ju hi le b fi li lj l lk ll"><strong class="le hj">tsconfig.app.json</strong></span><span id="78fb" class="jt ju hi le b fi lm lj l lk ll">{<br/>  ...<br/>  "angularCompilerOptions": {<br/>    <strong class="le hj">"preserveWhitespaces": false</strong><br/>  }<br/>  ...<br/>}</span></pre><ul class=""><li id="c30b" class="ln lo hi ih b ii ij im in iq lp iu lq iy lr jc ls lt lu lv bi translated">rxjs类的错误导入:</li></ul><pre class="jf jg jh ji fd ld le lf lg aw lh bi"><span id="ea8e" class="jt ju hi le b fi li lj l lk ll"><strong class="le hj">Bad</strong><br/>import {Subscription} from 'rxjs/index';</span><span id="bd2a" class="jt ju hi le b fi lm lj l lk ll"><strong class="le hj">Good</strong><br/>import {Subscription} from 'rxjs';</span></pre><ul class=""><li id="0afa" class="ln lo hi ih b ii ij im in iq lp iu lq iy lr jc ls lt lu lv bi translated">如果您有一个大查找表，则将每个键拆分成一个单独的“导出常量”，并在为每个键生成一个文件后:</li></ul><pre class="jf jg jh ji fd ld le lf lg aw lh bi"><span id="1e0c" class="jt ju hi le b fi li lj l lk ll"><strong class="le hj">lookup_data.ts</strong></span><span id="bada" class="jt ju hi le b fi lm lj l lk ll">export const features = {<br/>  'feature1' : 1,<br/>  'feature2' : 2,<br/>  ...<br/>};<br/>export const status = {<br/>  'new' : 0,<br/>  'active' : 1,<br/>  'closed' : 3,<br/>  ...<br/>};<br/>...</span></pre><p id="0cc0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为轻松生成文件创建脚本:</p><pre class="jf jg jh ji fd ld le lf lg aw lh bi"><span id="a729" class="jt ju hi le b fi li lj l lk ll"><strong class="le hj">generate_keys_file.ts</strong></span><span id="978f" class="jt ju hi le b fi lm lj l lk ll">const fs = require('fs-extra');<br/>import * as datas from './src/app/shared/lookup_data';</span><span id="eca9" class="jt ju hi le b fi lm lj l lk ll">Object.keys(datas).map(value =&gt; {<br/>  fs.writeFileSync('./src/app/shared/' + value + '.ts' ,<br/>    'export const ' + value + ' = ' + JSON.stringify(datas[value]) + ';', {encoding: 'utf-8'});<br/>});</span></pre><p id="74a7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行这个脚本后，您将拥有<strong class="ih hj"> features.ts </strong>、<strong class="ih hj"> status.ts </strong> (etc)文件，这样您就可以只导入您需要的文件。</p><ul class=""><li id="f6bb" class="ln lo hi ih b ii ij im in iq lp iu lq iy lr jc ls lt lu lv bi translated">如果您使用moment js，您可能不需要他的语言环境，因此不需要他们创建webpack配置文件:</li></ul><pre class="jf jg jh ji fd ld le lf lg aw lh bi"><span id="5ae1" class="jt ju hi le b fi li lj l lk ll"><strong class="le hj">extra-webpack.config.ts</strong></span><span id="b70d" class="jt ju hi le b fi lm lj l lk ll">const webpack = require('webpack');<br/>module.exports = {<br/>  plugins: [<br/>    new webpack.IgnorePlugin(/^\.\/locale$/, /moment$/),<br/>  ]<br/>};</span></pre><p id="2cc9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">修改angular.json文件:</p><pre class="jf jg jh ji fd ld le lf lg aw lh bi"><span id="5422" class="jt ju hi le b fi li lj l lk ll"><strong class="le hj">angular.json</strong></span><span id="16d1" class="jt ju hi le b fi lm lj l lk ll">{<br/> ...<br/>  "projects": {<br/>    "myproject": {<br/>      ...<br/>      "architect": {<br/>        "build": {<br/>          "builder": "<a class="ae jd" href="http://twitter.com/angular" rel="noopener ugc nofollow" target="_blank">@angular</a>-builders/custom-webpack:browser",<br/>          "options": {<br/>            "customWebpackConfig": {<br/>              "path": "./extra-webpack.config.js",<br/>              "mergeStrategies": {<br/>                "loaders": "replace"<br/>              },<br/>              "replaceDuplicatePlugins": true<br/>            }<br/>         }<br/>   ...<br/>}</span></pre></div><div class="ab cl jm jn gp jo" role="separator"><span class="jp bw bk jq jr js"/><span class="jp bw bk jq jr js"/><span class="jp bw bk jq jr"/></div><div class="hb hc hd he hf"><p id="9b4b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Lighthouse一直在不断发展，随着时间的推移，它已经改变了指标和相对分数，因此页面优化过程永远不会结束。<br/>我希望这些建议对我有所帮助，我邀请你留下评论和/或澄清。</p></div></div>    
</body>
</html>