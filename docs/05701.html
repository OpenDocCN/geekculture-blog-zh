<html>
<head>
<title>Rails Migration — Part 3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Rails迁移—第3部分</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/rails-migration-part-3-11ae1c2c1b0a?source=collection_archive---------17-----------------------#2021-07-28">https://medium.com/geekculture/rails-migration-part-3-11ae1c2c1b0a?source=collection_archive---------17-----------------------#2021-07-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="f41d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用不同的<em class="jd">迁移方法</em>更新现有的<em class="jd">表</em>。</p><h1 id="5eec" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">先决条件:</h1><p id="c1eb" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">本文是前几篇文章的延续:</p><ul class=""><li id="d2ee" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated"><a class="ae kq" href="https://juzer-shakir.medium.com/rails-migration-part-1-8ce3af467ace" rel="noopener"> <strong class="ih hj"> Rails迁移—第一部分</strong>(生成<em class="jd">迁移文件</em> ) </a></li><li id="fe4a" class="kh ki hi ih b ii kr im ks iq kt iu ku iy kv jc km kn ko kp bi translated"><a class="ae kq" href="https://juzer-shakir.medium.com/rails-migration-part-2-c2ca189e9f57" rel="noopener"> <strong class="ih hj"> Rails迁移—第二部分</strong>(执行<em class="jd">迁移文件</em> ) </a></li></ul></div><div class="ab cl kw kx gp ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="hb hc hd he hf"><h1 id="adaf" class="je jf hi bd jg jh ld jj jk jl le jn jo jp lf jr js jt lg jv jw jx lh jz ka kb bi translated">目录</h1><p id="d748" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">↦ <a class="ae kq" href="#d8c6" rel="noopener ugc nofollow"> <strong class="ih hj">单机迁移</strong> </a></p><p id="a526" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">↦ <a class="ae kq" href="#528b" rel="noopener ugc nofollow"> <strong class="ih hj">迁移方法</strong> </a> <br/> ↪ <a class="ae kq" href="#831b" rel="noopener ugc nofollow">改变</a> <br/> ↪ ↪ <a class="ae kq" href="#972e" rel="noopener ugc nofollow">属性修改器</a> <br/> ↪ <a class="ae kq" href="#a86c" rel="noopener ugc nofollow">改变_表格</a> <br/> ↪ <a class="ae kq" href="#7620" rel="noopener ugc nofollow">向上&amp;向下</a> <br/> ↪ <a class="ae kq" href="#a029" rel="noopener ugc nofollow">可逆</a></p></div><div class="ab cl kw kx gp ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="hb hc hd he hf"><figure class="lj lk ll lm fd ln er es paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="er es li"><img src="../Images/92e2790c30bc9ec2259ad81a438d1198.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A6A1wlVVyQWaUTgec_8bsw.png"/></div></div><figcaption class="lu lv et er es lw lx bd b be z dx">Topics covered in this article</figcaption></figure></div><div class="ab cl kw kx gp ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="hb hc hd he hf"><h1 id="d8c6" class="je jf hi bd jg jh ld jj jk jl le jn jo jp lf jr js jt lg jv jw jx lh jz ka kb bi translated">独立迁移</h1><p id="3c4e" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">在我的<a class="ae kq" href="https://juzer-shakir.medium.com/rails-migration-part-2-c2ca189e9f57#:~:text=Executing%20Migration%20file%3A" rel="noopener">上一篇文章</a>中，我们有两个迁移文件，在运行迁移之后，它们创建了两个带有一些属性的表<code class="du ly lz ma mb b">author</code>和<code class="du ly lz ma mb b">book</code>。现在让我们通过生成一个新的<em class="jd">迁移文件</em>来修改我们的<em class="jd">表</em>:</p><pre class="lj lk ll lm fd mc mb md me aw mf bi"><span id="cd04" class="mg jf hi mb b fi mh mi l mj mk">rails g migration AddColumnsToAuthors </span></pre><p id="9572" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将创建以下文件:</p><pre class="lj lk ll lm fd mc mb md me aw mf bi"><span id="d305" class="mg jf hi mb b fi mh mi l mj mk">db/migrate/20210725125500_add_columns_to_authors.rb</span></pre><p id="8169" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将创建一个空的<em class="jd">迁移文件</em>，也称为<em class="jd">独立迁移文件</em>:</p><figure class="lj lk ll lm fd ln"><div class="bz dy l di"><div class="ml mm l"/></div></figure><p id="f1df" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是如果我们把<em class="jd">属性名</em>和它的<em class="jd">类型</em>给上面的<em class="jd">迁移任务</em>，比如:</p><pre class="lj lk ll lm fd mc mb md me aw mf bi"><span id="a3cf" class="mg jf hi mb b fi mh mi l mj mk">rails g migration AddColumnsToAuthors nationality:string</span></pre><p id="d376" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后生成<em class="jd">迁移文件</em>，如下所示:</p><figure class="lj lk ll lm fd ln"><div class="bz dy l di"><div class="ml mm l"/></div></figure><p id="6f22" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们看到它隐式地将带有<em class="jd">属性</em> <em class="jd">名称</em> <code class="du ly lz ma mb b">nationality</code>的<code class="du ly lz ma mb b">add_column</code>方法作为<code class="du ly lz ma mb b">string</code>类型添加到<code class="du ly lz ma mb b">authors</code> <em class="jd">表</em>中。</p><p id="a8e4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">表单<code class="du ly lz ma mb b">AddXxxToTable</code>的<em class="jd">迁移名称</em>后跟<em class="jd">属性名称</em>和<em class="jd">类型</em>，<code class="du ly lz ma mb b">attribute_name:attribute_type</code>，将调用<code class="du ly lz ma mb b">add_column</code>方法将属性添加到适当的<em class="jd">表</em>，如迁移名称<code class="du ly lz ma mb b">Table</code>中所述。</p><p id="0bee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">记住<em class="jd">迁移名称</em>应该在<em class="jd">驼峰</em>中，列名在<em class="jd"> snake_case </em>中。</strong></p><p id="01e9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">类似地，如果我们有形式为<code class="du ly lz ma mb b">RemoveXxxFromTable</code>的<em class="jd">迁移名称</em>，后跟<em class="jd">属性名称</em>和<em class="jd">类型，</em>它将调用<code class="du ly lz ma mb b">remove_column</code>方法，如下所示:</p><pre class="lj lk ll lm fd mc mb md me aw mf bi"><span id="d72a" class="mg jf hi mb b fi mh mi l mj mk">rails g migration RemoveColumnsFromAuthors nationality:string</span></pre><p id="805f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它生成一个<em class="jd">迁移文件</em>，如下所示:</p><figure class="lj lk ll lm fd ln"><div class="bz dy l di"><div class="ml mm l"/></div></figure><p id="5651" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们总共有4个<em class="jd">迁移文件</em>，如果我们运行<code class="du ly lz ma mb b">db:migrate</code>，这不会以任何方式<em class="jd">修改<em class="jd">表</em>，因为第三次迁移<em class="jd">创建</em>属性，第四次迁移<em class="jd">删除</em>属性，它不会以任何有意义的方式更新我们的模式文件，所以让我们删除第三次和第四次<em class="jd">迁移文件</em>。我们可以使用GUI或CMD手动删除这两个文件。我们可以运行以下命令:</em></p><pre class="lj lk ll lm fd mc mb md me aw mf bi"><span id="fe0f" class="mg jf hi mb b fi mh mi l mj mk">$ rails d migration RemoveColumnsFromAuthors</span><span id="7cc5" class="mg jf hi mb b fi mn mi l mj mk">remove    db/migrate/20210725132852_remove_something_from_authors.rb</span><span id="adae" class="mg jf hi mb b fi mn mi l mj mk">$ rails d migration AddColumnsToAuthors</span><span id="6d9c" class="mg jf hi mb b fi mn mi l mj mk">remove    db/migrate/20210725131028_add_something_to_authors.rb</span></pre><p id="fae9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们给出命令<code class="du ly lz ma mb b">d</code>，简称<code class="du ly lz ma mb b">destroy</code>，后跟<em class="jd">迁移文件</em>的名称..与命令<code class="du ly lz ma mb b">g</code> / <code class="du ly lz ma mb b">generate</code> <em class="jd">相反，迁移任务</em>。</p><blockquote class="mo mp mq"><p id="6a91" class="if ig jd ih b ii ij ik il im in io ip mr ir is it ms iv iw ix mt iz ja jb jc hb bi translated"><strong class="ih hj">注意:不要删除迁移的文件。首先回滚这些，然后删除它。</strong></p></blockquote><p id="4432" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，我们不仅仅局限于<code class="du ly lz ma mb b">add_column</code>和<code class="du ly lz ma mb b">remove_column</code>方法。</p></div><div class="ab cl kw kx gp ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="hb hc hd he hf"><h1 id="528b" class="je jf hi bd jg jh ld jj jk jl le jn jo jp lf jr js jt lg jv jw jx lh jz ka kb bi translated">迁移方法</h1><h2 id="831b" class="mg jf hi bd jg mu mv mw jk mx my mz jo iq na nb js iu nc nd jw iy ne nf ka ng bi translated">改变方法</h2><p id="4d32" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated"><a class="ae kq" href="https://api.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html" rel="noopener ugc nofollow" target="_blank">官方ruby </a>文档列出了<em class="jd">迁移文件</em>中<code class="du ly lz ma mb b">change</code> <em class="jd">方法</em>下可用的每一个<em class="jd">方法</em>。这是它的一个快照:</p><figure class="lj lk ll lm fd ln er es paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="er es nh"><img src="../Images/f1d48203e631fe882bd25d30dc259932.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dvJwrYes2_YVJfU7n9qS6w.png"/></div></div></figure><p id="049e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，<strong class="ih hj">不是所有的方法都是可逆的</strong>。这里有一个<a class="ae kq" href="https://guides.rubyonrails.org/active_record_migrations.html#using-the-change-method" rel="noopener ugc nofollow" target="_blank">可逆方法列表</a>。除了这些方法，还有几个:<code class="du ly lz ma mb b">change_column_comment</code> &amp; <code class="du ly lz ma mb b">change_table_comment</code>，为了使这两个方法可逆，我们需要<strong class="ih hj">传递包含<code class="du ly lz ma mb b">:from</code>和<code class="du ly lz ma mb b">:to</code>的哈希</strong>。对于<strong class="ih hj">不</strong>可逆的方法，使用<code class="du ly lz ma mb b">up</code> &amp; <code class="du ly lz ma mb b">down</code>方法或<code class="du ly lz ma mb b">reversible</code>方法下的方法，而不是<code class="du ly lz ma mb b">change</code>方法。(在后面的章节中详细阐述)</p><p id="0750" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以让我们应用一些<em class="jd">迁移方法</em>来修改数据库中的<em class="jd">表</em>。</p><h2 id="d4e5" class="mg jf hi bd jg mu mv mw jk mx my mz jo iq na nb js iu nc nd jw iy ne nf ka ng bi translated">要做:</h2><p id="451e" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">在<code class="du ly lz ma mb b">authors</code>表中:</p><ul class=""><li id="0915" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated">将属性名<code class="du ly lz ma mb b">name</code>更改为<code class="du ly lz ma mb b">full_name</code>。</li><li id="8c29" class="kh ki hi ih b ii kr im ks iq kt iu ku iy kv jc km kn ko kp bi translated">添加新属性:<code class="du ly lz ma mb b">original_language</code>、<code class="du ly lz ma mb b">nationality</code>、<code class="du ly lz ma mb b">genre</code>作为<code class="du ly lz ma mb b">string</code>类型。</li><li id="39d8" class="kh ki hi ih b ii kr im ks iq kt iu ku iy kv jc km kn ko kp bi translated">添加新属性:<code class="du ly lz ma mb b">fiction</code>作为<code class="du ly lz ma mb b">boolean</code>类型，设置<code class="du ly lz ma mb b">default</code>为真。</li><li id="5896" class="kh ki hi ih b ii kr im ks iq kt iu ku iy kv jc km kn ko kp bi translated">添加新属性:<code class="du ly lz ma mb b">max_est_sales</code>(最高预计销售额)作为<code class="du ly lz ma mb b">integer</code>类型，并将其<code class="du ly lz ma mb b">limit</code>设置为<code class="du ly lz ma mb b">8</code>。</li><li id="b7f4" class="kh ki hi ih b ii kr im ks iq kt iu ku iy kv jc km kn ko kp bi translated">添加新属性:<code class="du ly lz ma mb b">major_works</code>作为<code class="du ly lz ma mb b">text</code>类型。</li></ul><h2 id="972e" class="mg jf hi bd jg mu mv mw jk mx my mz jo iq na nb js iu nc nd jw iy ne nf ka ng bi translated">属性修饰符:</h2><p id="27ac" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">这些是<strong class="ih hj"> <em class="jd">修饰符</em> </strong>，当我们想要<em class="jd">创建</em>或<em class="jd">改变</em>一个表格的<em class="jd">属性</em>时，它们是可用的:</p><p id="718c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du ly lz ma mb b"><strong class="ih hj">:limit</strong></code>👉设置<code class="du ly lz ma mb b">:string</code>属性类型的最大字符限制，而对于<code class="du ly lz ma mb b">:text</code>、<code class="du ly lz ma mb b">:binary</code>和<code class="du ly lz ma mb b">:integer</code>属性类型，设置最大字节数。</p><p id="52d9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du ly lz ma mb b"><strong class="ih hj">:default</strong></code>👉设置属性的默认值。将<code class="du ly lz ma mb b">nil</code>用于<code class="du ly lz ma mb b">NULL</code>。(<strong class="ih hj">不能通过命令行提供</strong>)</p><p id="7e45" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du ly lz ma mb b"><strong class="ih hj">:null</strong></code>👉允许或禁止列中的<code class="du ly lz ma mb b">NULL</code>值。设置<code class="du ly lz ma mb b">false</code>不允许空值。默认情况下，所有<em class="jd">属性</em>的空值都被设置为<code class="du ly lz ma mb b">true</code>。(<strong class="ih hj">无法通过命令行提供</strong>)。</p><p id="11f1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du ly lz ma mb b"><strong class="ih hj">:precision</strong></code>👉允许小数点前后的总位数。例如，如果某个属性的<code class="du ly lz ma mb b">precision</code>被设置为<code class="du ly lz ma mb b">5</code>，则它可以具有以下形式的值:99999、999.99、9.9999等。我们可以为这些属性类型指定<code class="du ly lz ma mb b">precision</code>:<code class="du ly lz ma mb b">:decimal</code>，<code class="du ly lz ma mb b">:numeric</code>，<code class="du ly lz ma mb b">:datetime</code>和<code class="du ly lz ma mb b">:time</code>。</p><p id="794f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du ly lz ma mb b"><strong class="ih hj">:scale</strong></code>👉小数点后允许的总位数。我们可以为这些属性类型指定<code class="du ly lz ma mb b">precision</code>:<code class="du ly lz ma mb b">:decimal</code>和<code class="du ly lz ma mb b">:numeric</code>。</p><p id="d4bc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du ly lz ma mb b"><strong class="ih hj">:comment</strong></code>👉指定列的注释。也可以为表指定。</p><p id="5bc9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du ly lz ma mb b"><strong class="ih hj">:if_not_exists</strong></code>👉如果该列已经存在，不要尝试重新添加它。这将避免重复的列错误。</p><p id="2dd5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所有这些修饰符都是我们在<em class="jd">表</em>中存储所需值的好工具。我们将使用一些修饰符<code class="du ly lz ma mb b">default</code>和<code class="du ly lz ma mb b">limit</code>来完成“待办事项”任务。</p><blockquote class="mo mp mq"><p id="9dfe" class="if ig jd ih b ii ij ik il im in io ip mr ir is it ms iv iw ix mt iz ja jb jc hb bi translated">注意:有许多其他的修改器可用于其他方法，更多关于这个<a class="ae kq" href="https://api.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html" rel="noopener ugc nofollow" target="_blank">这里</a>。</p></blockquote><p id="b4ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了完成我们的“待办”任务，让我们给出一个独立的迁移，如下所示:</p><pre class="lj lk ll lm fd mc mb md me aw mf bi"><span id="1011" class="mg jf hi mb b fi mh mi l mj mk">rails g migration AddDetailsToAuthors</span></pre><p id="773e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将<code class="du ly lz ma mb b">fiction</code>和<code class="du ly lz ma mb b">max_est_sales</code>属性及其<em class="jd">修改器</em>添加到<em class="jd">迁移文件</em>:</p><figure class="lj lk ll lm fd ln"><div class="bz dy l di"><div class="ml mm l"/></div></figure><pre class="lj lk ll lm fd mc mb md me aw mf bi"><span id="daf6" class="mg jf hi mb b fi mh mi l mj mk">rails db:migrate</span></pre><p id="95dc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们的模式文件:</p><figure class="lj lk ll lm fd ln"><div class="bz dy l di"><div class="ml mm l"/></div></figure><h2 id="a86c" class="mg jf hi bd jg mu mv mw jk mx my mz jo iq na nb js iu nc nd jw iy ne nf ka ng bi translated">更改表格方法</h2><p id="8209" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">类似于我们在<a class="ae kq" href="https://juzer-shakir.medium.com/rails-migration-part-1-8ce3af467ace#:~:text=and%20ActiveRecord%20classes.-,create_table,-create_table%20method%20takes" rel="noopener">第一部分</a>中看到的<code class="du ly lz ma mb b">create_table</code>方法，<code class="du ly lz ma mb b"><a class="ae kq" href="https://api.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/Table.html" rel="noopener ugc nofollow" target="_blank">change_table</a></code>用于更新我们数据库中现有的<em class="jd">表</em>，它有更多可用的方法。并且它也被定义在<em class="jd">迁移文件</em>中的<code class="du ly lz ma mb b">change</code>方法的范围内。</p><p id="d5cb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">可供使用的方法列表:</p><figure class="lj lk ll lm fd ln er es paragraph-image"><div class="er es ni"><img src="../Images/a468ffff86b7072792bee58495387cbe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1032/format:webp/1*7FHv91D4oTF0a1bDdGeyOQ.png"/></div></figure><p id="c267" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们的“待办事项”任务尚未完成，因为我们必须向表中添加更多的属性。让我们创建另一个独立迁移并使用<code class="du ly lz ma mb b">change_table</code>方法。</p><p id="83c1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们的迁移文件:</p><figure class="lj lk ll lm fd ln"><div class="bz dy l di"><div class="ml mm l"/></div></figure><p id="42f0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">除了使用<code class="du ly lz ma mb b">change_table</code>方法，我们还可以使用<code class="du ly lz ma mb b">add_column</code>方法来完成下面的任务，但是我们需要在每次给<code class="du ly lz ma mb b">add_column</code>方法时明确指定表名<code class="du ly lz ma mb b">:authors</code>。所以，<code class="du ly lz ma mb b">change_table</code>通过让出<code class="du ly lz ma mb b">change_table</code>的<em class="jd">块</em>内的<em class="jd">表</em> <code class="du ly lz ma mb b">:authors</code>提供了一点快捷方式。</p><p id="c6ff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将相应地更新我们的<em class="jd">模式文件</em>。</p><p id="b5e3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">除了<code class="du ly lz ma mb b">change</code>、<code class="du ly lz ma mb b">change_default</code>、<code class="du ly lz ma mb b">remove</code>之外，<code class="du ly lz ma mb b">change_table</code>的所有方法都是可逆的。因此，如果我们在<code class="du ly lz ma mb b">change_table</code>方法中给出这3个方法中的任何一个，并执行<code class="du ly lz ma mb b">db:rollback</code>(假设它们被迁移了)，那么<strong class="ih hj">就会产生一个错误</strong>。</p><p id="5dee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们通过用<code class="du ly lz ma mb b">remove</code>方法删除<code class="du ly lz ma mb b">fiction</code>属性来尝试一下。</p><figure class="lj lk ll lm fd ln"><div class="bz dy l di"><div class="ml mm l"/></div></figure><p id="2812" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<em class="jd">迁移该文件</em>后，如果我们<em class="jd">用<code class="du ly lz ma mb b">rails db:rollback</code>反转</em>该<em class="jd">迁移文件</em>，将会给出如下错误:</p><pre class="lj lk ll lm fd mc mb md me aw mf bi"><span id="93e2" class="mg jf hi mb b fi mh mi l mj mk">Caused by:<br/>ActiveRecord::IrreversibleMigration:</span><span id="f871" class="mg jf hi mb b fi mn mi l mj mk">This migration uses remove_columns, which is not automatically reversible.<br/>To make the migration reversible you can either:<br/>1. Define #up and #down methods in place of the #change method.<br/>2. Use the #reversible method to define reversible behavior.</span></pre><p id="fe64" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它调用了<code class="du ly lz ma mb b">IrreversibleMigration</code>类，告诉我们如何克服这个错误。有2种方法，不用<code class="du ly lz ma mb b">change</code>法，用<code class="du ly lz ma mb b">up</code> &amp; <code class="du ly lz ma mb b">down</code>或<code class="du ly lz ma mb b">reversible</code>法。</p><h2 id="7620" class="mg jf hi bd jg mu mv mw jk mx my mz jo iq na nb js iu nc nd jw iy ne nf ka ng bi translated">升降法</h2><figure class="lj lk ll lm fd ln"><div class="bz dy l di"><div class="ml mm l"/></div></figure><p id="4f7f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">代替<code class="du ly lz ma mb b">change</code>方法，我们给出了2个方法，<code class="du ly lz ma mb b">up</code> &amp; <code class="du ly lz ma mb b">down</code>。当运行<code class="du ly lz ma mb b">rails db:migrate</code>时，它触发执行每个迁移文件的<code class="du ly lz ma mb b">up</code>或<code class="du ly lz ma mb b">change</code>方法，在本例中，它执行删除指定属性的<code class="du ly lz ma mb b">up</code>方法。当运行<code class="du ly lz ma mb b">rails db:rollback</code>时，它执行<code class="du ly lz ma mb b">down</code>方法，该方法创建被删除的属性。</p><blockquote class="mo mp mq"><p id="3de9" class="if ig jd ih b ii ij ik il im in io ip mr ir is it ms iv iw ix mt iz ja jb jc hb bi translated">简而言之，<code class="du ly lz ma mb b">up</code>方法应该描述您想要对模式进行的转换，而<code class="du ly lz ma mb b">down</code>方法应该恢复由<code class="du ly lz ma mb b">up</code>方法完成的转换。换句话说，如果您在执行<code class="du ly lz ma mb b">up</code>之后执行<code class="du ly lz ma mb b">down</code>，那么数据库模式应该是不变的。例如，如果您在<code class="du ly lz ma mb b">up</code>方法中创建了一个表，那么您应该在<code class="du ly lz ma mb b">down</code>方法中删除它。</p></blockquote><p id="e6ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果由于某种原因迁移是不可逆的，那么我们应该在<code class="du ly lz ma mb b">down</code>方法中引发<code class="du ly lz ma mb b">ActiveRecord::IrreversibleMigration</code>，这样如果有人试图恢复我们的迁移，就会显示一条错误消息，说这是不可能的。</p><h2 id="a029" class="mg jf hi bd jg mu mv mw jk mx my mz jo iq na nb js iu nc nd jw iy ne nf ka ng bi translated">可逆方法</h2><p id="8052" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">在<code class="du ly lz ma mb b">change</code>方法中，我们给出了<code class="du ly lz ma mb b">reversible</code>方法，并在其<em class="jd">块</em>中给出了<code class="du ly lz ma mb b">up</code>和<code class="du ly lz ma mb b">down</code>方法。</p><figure class="lj lk ll lm fd ln"><div class="bz dy l di"><div class="ml mm l"/></div></figure><p id="61d1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du ly lz ma mb b">up</code> &amp; <code class="du ly lz ma mb b">down</code>和<code class="du ly lz ma mb b">reversible</code>方法的区别在于在<code class="du ly lz ma mb b">reversible</code>中，<code class="du ly lz ma mb b">up</code> &amp; <code class="du ly lz ma mb b">down</code>方法在<code class="du ly lz ma mb b">reversible</code>的<em class="jd">块</em>内，而<em class="jd">块又在<code class="du ly lz ma mb b">change</code>方法的<em class="jd">块</em>内。这是句法上的差异，而不是逻辑上的差异。你可以使用这两种适合你的方法中的任何一种。</em></p><p id="7d25" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当活动记录不能逆转一小部分迁移时，例如当使用原始SQL语句时，应该使用这些方法。</p></div><div class="ab cl kw kx gp ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="hb hc hd he hf"><p id="c982" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">好了，这就是我们需要了解的关于AR迁移的所有基础知识。这是一篇很长的3篇文章，涵盖了AR迁移的不同方面，如果你已经阅读了所有的文章，我很荣幸，我真诚地感谢你。</p></div><div class="ab cl kw kx gp ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="hb hc hd he hf"><h1 id="e0c6" class="je jf hi bd jg jh ld jj jk jl le jn jo jp lf jr js jt lg jv jw jx lh jz ka kb bi translated">额外资源</h1><div class="nj nk ez fb nl nm"><a href="https://rxbsxn.medium.com/how-to-keep-your-activerecord-migrations-clean-6d135730e076" rel="noopener follow" target="_blank"><div class="nn ab dw"><div class="no ab np cl cj nq"><h2 class="bd hj fi z dy nr ea eb ns ed ef hh bi translated">如何保持您的活动记录迁移干净</h2><div class="nt l"><h3 class="bd b fi z dy nr ea eb ns ed ef dx translated">作为一名Ruby on Rails开发人员，您经常要处理迁移问题。您创建迁移，同时将新模型添加到…</h3></div><div class="nu l"><p class="bd b fp z dy nr ea eb ns ed ef dx translated">rxbsxn.medium.com</p></div></div><div class="nv l"><div class="nw l nx ny nz nv oa ls nm"/></div></div></a></div><figure class="lj lk ll lm fd ln"><div class="bz dy l di"><div class="ob mm l"/></div></figure></div></div>    
</body>
</html>