<html>
<head>
<title>Why We Shouldn’t Ignore Null Values and How to Treat Them</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为什么我们不应该忽略空值以及如何对待它们</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/why-we-shouldnt-ignore-null-values-and-how-to-treat-them-22e0e7f9b7de?source=collection_archive---------34-----------------------#2021-07-05">https://medium.com/geekculture/why-we-shouldnt-ignore-null-values-and-how-to-treat-them-22e0e7f9b7de?source=collection_archive---------34-----------------------#2021-07-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="f54b" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">使用Google BigQuery SQL进行数据清理</h2></div><p id="5055" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi jt translated"><span class="l ju jv jw bm jx jy jz ka kb di"> D </span>处理数据聚合通常很棘手，尤其是当涉及到无法手动处理且包含空值的大数据时(是的，在现实中，没有100%干净的数据)。此外，使用不同的工具进行数据清理可能需要不同的方法，因为不存在一刀切的做法。不清理空值而直接汇总数字可能会导致我们提供误导性的数据并得出错误的结论。</p><p id="3776" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">例如，我们想计算零售商店的<strong class="iz hj">净利润率</strong>是多少。我们将数据存储在名为<em class="kc">‘事务_数据’</em>的表中，如下所示:</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div class="er es kd"><img src="../Images/38a80a436805ad9a530d3672875f979d.png" data-original-src="https://miro.medium.com/v2/resize:fit:964/format:webp/1*LiIjmqJeRDLZNbScFnLLpQ.png"/></div><figcaption class="kl km et er es kn ko bd b be z dx">Raw data from <em class="kp">transactions_data table</em></figcaption></figure><p id="a18e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">该零售店目前正在将赠品作为其向市场推出新产品的促销计划的一部分。每个赠品都记录在一个唯一的<em class="kc"> transaction_id </em>中，但是由于每个产品都是免费赠送的，因此没有销售记录(空)。</p><p id="a186" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果我们使用Excel/Google电子表格手动计算净利润率，我们可以如下确定净利润率:</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div class="er es kq"><img src="../Images/adf7194779c236ce529d2d9306cd6e3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*gI4VjS1D03fINWiIPdw5XA.png"/></div><figcaption class="kl km et er es kn ko bd b be z dx">Net margin calculation using Excel/Google Spreadsheets</figcaption></figure><p id="46ac" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">请注意，我们可以确定<strong class="iz hj">的净利润率为1.52% </strong>，这并不算高，因为我们花费的成本导致赠品交易的净利润率为负。但是，想象一下，如果有数百万笔交易需要处理，因此行数超过了Excel/Google电子表格的限制，我们需要利用更高级的工具来计算净利润率。对于这种情况，我将使用使用Google BigQuery SQL的例子。</p></div><div class="ab cl kr ks gp kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="hb hc hd he hf"><h2 id="1225" class="ky kz hi bd la lb lc ld le lf lg lh li jg lj lk ll jk lm ln lo jo lp lq lr ls bi translated"><strong class="ak">注意事项</strong></h2><p id="f3d9" class="pw-post-body-paragraph ix iy hi iz b ja lt ij jc jd lu im jf jg lv ji jj jk lw jm jn jo lx jq jr js hb bi translated">如果我们直接计算净利润率，而不首先使用以下查询处理空值:</p><pre class="ke kf kg kh fd ly lz ma mb aw mc bi"><span id="f3db" class="ky kz hi lz b fi md me l mf mg">WITH<br/>raw_data AS (<br/>   SELECT *,<br/>      sales - cost AS margin<br/>   FROM transactions_data<br/>)</span><span id="9505" class="ky kz hi lz b fi mh me l mf mg">SELECT SUM(margin)/SUM(cost) AS net_margin<br/>FROM raw_data</span></pre><p id="8287" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">输出可能会产生如下误导:</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div class="er es mi"><img src="../Images/fe8a5cb2544a8b26088b53bbb18485a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1208/format:webp/1*oLAHvzqGa6aYKXAIzmCp0A.png"/></div></figure><p id="676a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">交易C3和E5的利润计算将返回null(不是-70，000和-50，000)，因为一旦Google BigQuery在公式(<em class="kc"> sales - cost </em>)中遇到null值，它也会将公式的结果返回为null。在处理大数据的时候，我们并不是把所有的输出都逐行打印出来，而是直接用SUM(<em class="kc">margin</em>)/SUM(<em class="kc">cost</em>)等数据进行汇总，会把净利润率的输出打印成19.70%(完全误导！).看到如此高的净利润率，我们会得出零售商店足够盈利的结论，<strong class="iz hj">而实际上我们正在为赠品烧钱，将净利润率拉低至接近于零</strong>。</p><p id="a4bb" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">那么，我们应该如何对待空值呢？</p></div><div class="ab cl kr ks gp kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="hb hc hd he hf"><h2 id="3e95" class="ky kz hi bd la lb lc ld le lf lg lh li jg lj lk ll jk lm ln lo jo lp lq lr ls bi translated">该做的事</h2><p id="fb1b" class="pw-post-body-paragraph ix iy hi iz b ja lt ij jc jd lu im jf jg lv ji jj jk lw jm jn jo lx jq jr js hb bi translated"><strong class="iz hj">选项#1: </strong>增加附加列<em class="kc"> sales_clean </em>用0替换空值(当时使用<strong class="iz hj"> CASE)，然后计算<em class="kc"> margin_clean </em>。<strong class="iz hj"> </strong>查询应该是这样的:</strong></p><pre class="ke kf kg kh fd ly lz ma mb aw mc bi"><span id="9e18" class="ky kz hi lz b fi md me l mf mg">WITH<br/>add_sales_clean AS (<br/>   SELECT *,<br/>     <strong class="lz hj"> CASE WHEN sales IS NULL<br/>         THEN 0<br/>         ELSE sales<br/>         END<br/>         AS sales_clean</strong><br/>   FROM transactions_data<br/>),</span><span id="440d" class="ky kz hi lz b fi mh me l mf mg">add_margin_clean AS (<br/>   SELECT *,<br/>     <strong class="lz hj"> sales_clean - cost AS margin_clean</strong><br/>   FROM add_sales_clean<br/>)</span><span id="6bcb" class="ky kz hi lz b fi mh me l mf mg">SELECT SUM(margin_clean)/SUM(cost) AS net_margin<br/>FROM add_margin_clean</span></pre><p id="9ac1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在后端，该查询将在聚合之前返回另外两列:</p><ol class=""><li id="a28d" class="mj mk hi iz b ja jb jd je jg ml jk mm jo mn js mo mp mq mr bi translated"><em class="kc"> sales_clean </em>:与<em class="kc"> sales </em>列类似，但将空值替换为0。</li><li id="eea6" class="mj mk hi iz b ja ms jd mt jg mu jk mv jo mw js mo mp mq mr bi translated"><em class="kc">毛利_清洁</em>:用<em class="kc">成本减去<em class="kc">销售_清洁</em>。</em></li></ol><p id="8487" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，数据聚合的输出将如下所示:</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="er es mx"><img src="../Images/8b536ce300b4d192945168f96ee5f3f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J273r0K-MJ5fQm3akNLCsQ.png"/></div></div></figure><p id="bfbf" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">对数据进行清洗后，可以得到净利润率的正确结果:1.52%。</p><p id="d4d1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi">—</p><p id="fbe3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">选项#2 </strong>:使用语法时的<strong class="iz hj"> CASE直接计算<em class="kc"> margin_clean </em>(但是，一定要注意，如果公式很复杂，这种方法会很痛苦)。查询应该是这样的:</strong></p><pre class="ke kf kg kh fd ly lz ma mb aw mc bi"><span id="4f75" class="ky kz hi lz b fi md me l mf mg">WITH<br/>add_margin_clean AS (<br/>   SELECT *,<br/>      <strong class="lz hj">CASE WHEN sales IS NULL<br/>         THEN 0 - cost<br/>         ELSE sales - cost<br/>         END<br/>         AS margin_clean</strong><br/>   FROM transactions_data<br/> )</span><span id="27b5" class="ky kz hi lz b fi mh me l mf mg">SELECT SUM(margin_clean)/SUM(cost) AS net_margin<br/>FROM add_margin_clean</span></pre><p id="89a0" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">聚合后的输出如下所示:</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div class="er es nc"><img src="../Images/03501867e12ed5eb921cdd16813e7145.png" data-original-src="https://miro.medium.com/v2/resize:fit:1206/format:webp/1*mByljSCTsnYXX1-GrPSeXA.png"/></div></figure><p id="0718" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">该方法类似于选项#1，并返回相同的聚合结果。不同之处只是我们直接计算列<em class="kc"> margin_clean </em>而不是先创建列<em class="kc"> sales_clean </em>。</p><p id="82de" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi">—</p><p id="cf4c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">选项#3 </strong>:使用<strong class="iz hj">合并</strong>或<strong class="iz hj"> IFNULL </strong>函数替换空值。查询应该是这样的:</p><pre class="ke kf kg kh fd ly lz ma mb aw mc bi"><span id="cc6c" class="ky kz hi lz b fi md me l mf mg">WITH<br/>add_margin_clean AS (<br/>   SELECT *,<br/>      <strong class="lz hj">COALESCE(sales, 0) - cost AS margin_clean</strong><br/>   FROM transactions_data<br/>)</span><span id="07dc" class="ky kz hi lz b fi mh me l mf mg">SELECT SUM(margin_clean)/SUM(cost) AS net_margin<br/>FROM add_margin_clean</span></pre><p id="0bb8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">或者我们也可以用IFNULL替换COALESCE函数，它将返回相同的输出。这两个函数的区别在于COALESCE的逻辑可以用于两个以上的条件，而IFNULL只能包含两个条件。但是由于我们只有两个条件(return 0或者<em class="kc"> sales </em> value)，所以两个函数都没问题。<strong class="iz hj">输出将与选项#2完全相同，并且查询要简单得多。</strong></p><p id="18db" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi">—</p><p id="2e3a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">附加</strong>:我们也可以通过使用<strong class="iz hj"> WHERE </strong>语法过滤掉空值的交易来计算<strong class="iz hj">毛利率</strong>(不包括赠品交易)。查询应该是这样的:</p><pre class="ke kf kg kh fd ly lz ma mb aw mc bi"><span id="6d97" class="ky kz hi lz b fi md me l mf mg">WITH<br/>filter_giveaway_transactions AS (<br/>   SELECT *,<br/>      sales - cost AS margin<br/>   FROM transactions_data<br/><strong class="lz hj">   WHERE sales IS NOT NULL</strong><br/>)</span><span id="18c0" class="ky kz hi lz b fi mh me l mf mg">SELECT SUM(margin)/SUM(cost) AS gross_margin<br/>FROM filter_giveaway_transactions</span></pre><p id="2ed0" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">该查询将过滤掉交易C3和E5，因为它们在<em class="kc">销售</em>列中有空值。因此，计算的输出将是这样的:</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div class="er es mi"><img src="../Images/e6dd9b6ad7088cf3414b07b26ad47a90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1208/format:webp/1*Rnqx_SLWvnRYTcDkv2rd1g.png"/></div></figure><p id="12a6" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">通过排除赠品交易，我们可以了解到最终<strong class="iz hj">毛利润</strong>几乎占到产品成本的四分之一(<strong class="iz hj"> 24.07% </strong>)。这表明我们可能在赠品计划上花费了太多成本，需要探索如何优化成本的方法，例如:</p><ul class=""><li id="ee05" class="mj mk hi iz b ja jb jd je jg ml jk mm jo mn js nd mp mq mr bi translated">用更便宜的产品替代</li><li id="46a9" class="mj mk hi iz b ja ms jd mt jg mu jk mv jo mw js nd mp mq mr bi translated">减少赠品获奖者的数量</li><li id="dec8" class="mj mk hi iz b ja ms jd mt jg mu jk mv jo mw js nd mp mq mr bi translated">调整赠品交易相对于销售交易的比率</li><li id="d712" class="mj mk hi iz b ja ms jd mt jg mu jk mv jo mw js nd mp mq mr bi translated">等等。</li></ul></div><div class="ab cl kr ks gp kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="hb hc hd he hf"><p id="7303" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">数据清理可能不是最令人兴奋的工作，但如果忽略了这一点，后果可能对业务至关重要——做出错误的结论和决策。因此，值得注意的是，数据分析不仅仅是从Stackoverflow修改一个语法(我知道我们都需要这个gem)并运行它，我们还需要了解查询是如何工作的。快乐分析！</p></div></div>    
</body>
</html>