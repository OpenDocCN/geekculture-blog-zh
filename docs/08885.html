<html>
<head>
<title>Configuring Vault with Spring Boot</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Spring Boot配置保管库</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/configuring-vault-with-spring-boot-100889961b50?source=collection_archive---------1-----------------------#2021-11-18">https://medium.com/geekculture/configuring-vault-with-spring-boot-100889961b50?source=collection_archive---------1-----------------------#2021-11-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="1788" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">根据Spring Cloud Vault和Spring Boot的版本，保管库属性的配置会有所不同。</p><p id="75e3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在Spring Cloud Vault 3.0和Spring Boot 2.4中，属性源的引导上下文初始化(<code class="du jd je jf jg b">bootstrap.yml</code>、<code class="du jd je jf jg b">bootstrap.properties</code>)不再使用<strong class="ih hj">。<br/>最新版本的新增强可以参考<a class="ae jh" href="https://docs.spring.io/spring-cloud-vault/docs/current/reference/html/#new-in-3.0.0" rel="noopener ugc nofollow" target="_blank">https://docs . spring . io/spring-cloud-vault/docs/current/reference/html/# new-in-3 . 0 . 0</a>。</strong></p><h2 id="14aa" class="ji jj hi bd jk jl jm jn jo jp jq jr js iq jt ju jv iu jw jx jy iy jz ka kb kc bi translated">相关性设置</h2><p id="0072" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">首先，我们将把spring cloud vault配置依赖项添加到我们的<code class="du jd je jf jg b">pom.xml</code>中</p><pre class="ki kj kk kl fd km jg kn ko aw kp bi"><span id="86a3" class="ji jj hi jg b fi kq kr l ks kt">&lt;dependency&gt;<br/>     &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br/>     &lt;artifactId&gt;spring-cloud-starter-vault-config&lt;/artifactId&gt;<br/>     &lt;version&gt;{project-version}&lt;/version&gt;<br/>&lt;/dependency&gt;</span></pre><p id="3301" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们将了解如何为不同版本配置vault属性。</p><h2 id="0ddf" class="ji jj hi bd jk jl jm jn jo jp jq jr js iq jt ju jv iu jw jx jy iy jz ka kb kc bi translated">支持引导上下文的配置</h2><p id="8abe" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">在早期版本中，spring cloud vault在引导上下文中运行，最初获取配置属性，因此它可以将这些属性提供给自动配置和我们的应用程序本身。</p><p id="0761" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以用<code class="du jd je jf jg b">bootstrap.yml</code>或<code class="du jd je jf jg b">bootstrap.properties</code>来配置我们的应用</p><pre class="ki kj kk kl fd km jg kn ko aw kp bi"><span id="6638" class="ji jj hi jg b fi kq kr l ks kt">spring:<br/>  cloud:<br/>    vault:<br/>      enabled: true<br/>      kv:<br/>        backend: &lt;secret&gt;<br/>        enabled: true<br/>        application-name: &lt;vault-application-name&gt;<br/>      authentication: APPROLE<br/>      app-role:<br/>        role-id: &lt;role-id&gt;<br/>        secret-id: &lt;secret-id&gt;<br/>        app-auth-path: approle<br/>      scheme: https<br/>      uri: &lt;vault-server&gt;<br/>      connection-timeout: 5000<br/>      read-timeout: 15000</span></pre><ul class=""><li id="fd51" class="ku kv hi ih b ii ij im in iq kw iu kx iy ky jc kz la lb lc bi translated"><code class="du jd je jf jg b">scheme</code>将方案设置为<code class="du jd je jf jg b">http</code>将使用普通HTTP。支持的方案有<code class="du jd je jf jg b">http</code>和<code class="du jd je jf jg b">https</code>。</li><li id="391f" class="ku kv hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated"><code class="du jd je jf jg b">uri</code>用URI配置Vault端点。优先于主机/端口/方案配置</li><li id="ea9f" class="ku kv hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated"><code class="du jd je jf jg b">connection-timeout</code>以毫秒为单位设置连接超时</li><li id="6c96" class="ku kv hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated"><code class="du jd je jf jg b">read-timeout</code>以毫秒为单位设置读取超时</li><li id="65de" class="ku kv hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated"><code class="du jd je jf jg b">authentication</code>设置认证机制以授权客户端请求。Spring Cloud Vault支持多种身份验证机制，通过Vault对应用程序进行身份验证。请参考<a class="ae jh" href="https://docs.spring.io/spring-cloud-vault/docs/current/reference/html/#authentication" rel="noopener ugc nofollow" target="_blank">https://docs . spring . io/spring-cloud-vault/docs/current/reference/html/# authentic ation</a></li><li id="1dde" class="ku kv hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated"><code class="du jd je jf jg b">kv</code>设置键值配置</li></ul><h2 id="9db3" class="ji jj hi bd jk jl jm jn jo jp jq jr js iq jt ju jv iu jw jx jy iy jz ka kb kc bi translated">不支持引导上下文的配置</h2><p id="e35c" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">这可以通过两种方式实现:</p><p id="4818" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 1。</strong>使用Spring Boot 2.4配置数据API(首选)</p><p id="33b2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Spring Cloud Vault的新版本支持Spring Boot的配置数据API，它允许从Vault导入配置。</p><p id="237a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将所有属性从<code class="du jd je jf jg b">bootstarp.yml</code>文件移动到<code class="du jd je jf jg b">application.yml</code>文件。<code class="du jd je jf jg b">aaplication.yml</code>文件会是什么样子</p><pre class="ki kj kk kl fd km jg kn ko aw kp bi"><span id="bf36" class="ji jj hi jg b fi kq kr l ks kt">spring:<br/>  cloud:<br/>    vault:<br/>      authentication: APPROLE<br/>      app-role:<br/>        role-id: &lt;role-id&gt;<br/>        secret-id: &lt;secret-id&gt;<br/>        app-auth-path: approle<br/>      uri: &lt;vault-server&gt;<br/>      connection-timeout: 5000<br/>      read-timeout: 15000<br/>  config:<br/>    import: vault://&lt;secret&gt;/&lt;vault-application-name&gt;</span></pre><p id="b3f4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du jd je jf jg b">spring.config.import</code>设置vault键值后端的挂载路径。</p><p id="a1af" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个属性文件也可以以下面的格式提供</p><pre class="ki kj kk kl fd km jg kn ko aw kp bi"><span id="e817" class="ji jj hi jg b fi kq kr l ks kt">spring:<br/>  cloud:<br/>    vault:<br/>      enabled: true<br/>      kv:<br/>        backend: &lt;secret&gt;<br/>        enabled: true<br/>        application-name: &lt;vault-application-name&gt;<br/>      authentication: APPROLE<br/>      app-role:<br/>        role-id: &lt;role-id&gt;<br/>        secret-id: &lt;secret-id&gt;<br/>        app-auth-path: approle<br/>      scheme: https<br/>      uri: &lt;vault-server&gt;<br/>      connection-timeout: 5000<br/>      read-timeout: 15000<br/>  config:<br/>    import: optional:vault://</span></pre><p id="56c9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du jd je jf jg b">spring.cloud.vault.enabled</code>用于启用/禁用保险库。当vault被禁用时，在应用程序启动期间将跳过作为<code class="du jd je jf jg b">optional</code>提供的配置位置。</p><p id="37cd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 2。</strong>如果我们仍然想使用引导上下文，我们可以通过<br/>包括下面对<code class="du jd je jf jg b">pom.xml</code>的依赖来启用它</p><pre class="ki kj kk kl fd km jg kn ko aw kp bi"><span id="4c8d" class="ji jj hi jg b fi kq kr l ks kt">&lt;dependency&gt;<br/>    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br/>    &lt;artifactId&gt;spring-cloud-starter-bootstrap&lt;/artifactId&gt;<br/>&lt;/dependency&gt;</span></pre><p id="6660" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">并将该配置属性<code class="du jd je jf jg b">spring.cloud.bootstrap.enabled=true</code>添加到<code class="du jd je jf jg b">application.yml</code>文件中。</p><h1 id="8e67" class="li jj hi bd jk lj lk ll jo lm ln lo js lp lq lr jv ls lt lu jy lv lw lx kb ly bi translated">参考</h1><p id="e3ef" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">[1]<a class="ae jh" href="https://docs.spring.io/spring-cloud-vault/docs/current/reference/html/#client-side-usage" rel="noopener ugc nofollow" target="_blank">https://docs . spring . io/spring-cloud-vault/docs/current/reference/html/# client-side-usage</a></p><p id="2250" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">[2]<a class="ae jh" href="https://cloud.spring.io/spring-cloud-vault/reference/html/#_client_side_usage" rel="noopener ugc nofollow" target="_blank">https://cloud . spring . io/spring-cloud-vault/reference/html/# _ client _ side _ usage</a></p></div></div>    
</body>
</html>