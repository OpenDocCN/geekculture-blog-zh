<html>
<head>
<title>Data Preprocess with AWS Glue</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用AWS Glue进行数据预处理</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/data-preprocess-with-aws-glue-27890c69a8ee?source=collection_archive---------23-----------------------#2021-08-25">https://medium.com/geekculture/data-preprocess-with-aws-glue-27890c69a8ee?source=collection_archive---------23-----------------------#2021-08-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/188e54a69d2943052f459671005b40e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aTwZq7ceSHClNuAconBNig.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Photo by <a class="ae iu" href="https://unsplash.com/@mbaumi?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Mika Baumeister</a> on <a class="ae iu" href="https://unsplash.com/s/photos/big-data?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="004b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果你是AWS上的新手，使用AWS服务是非常混乱的。我敢打赌你不知道从哪里或者如何开始你的任务。如果你已经做了一些入门的例子，但仍然不知道概念或机制，那么我推荐你也阅读一下<a class="ae iu" href="https://aws.amazon.com/glue/faqs/" rel="noopener ugc nofollow" target="_blank"> AWS Glue FAQ </a>。虽然会有点无聊，但我听说FAQ对SAA(AWS认证解决方案架构师；助理认证)。你不需要什么都懂，AWS的世界会比你想象的要大。</p><p id="134a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">开发环境</strong></p><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jt"><img src="../Images/191042ac331dd9cab9098cacf2e838aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zzNZGQthRhOcTLlxJZ4iBg.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Photo by <a class="ae iu" href="https://unsplash.com/@markusspiske?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Markus Spiske</a> on <a class="ae iu" href="https://unsplash.com/s/photos/sandbox?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="e1f7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在大多数情况下，你的任务会比基本的例子更复杂，你需要在Glue Studio GUI之外定制脚本。AWS Glue Studio不方便测试调试源代码。所以在本地使用docker映像进行开发会更容易。<br/>T5】https://AWS . Amazon . com/blogs/big-data/developing-AWS-glue-ETL-jobs-locally-using-a-container/</p><p id="1c34" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">但是有一些限制，现在只支持glue 1.0，不支持AWS Glue Parquet writer(<a class="ae iu" href="https://docs.aws.amazon.com/glue/latest/dg/aws-glue-programming-etl-format.html#aws-glue-programming-etl-format-glue-parquet" rel="noopener ugc nofollow" target="_blank">format = " Glue Parquet</a>")。<br/>没有容器，如果想本地开发，查看更多限制，关注下一个链接<br/><a class="ae iu" href="https://docs.aws.amazon.com/glue/latest/dg/aws-glue-programming-etl-libraries.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/glue/latest/DG/AWS-glue-programming-ETL-libraries . html</a></p><p id="2218" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果你成功创建了一个带有胶水图像的docker容器，你可以通过<a class="ae iu" href="http://localhost:8888" rel="noopener ugc nofollow" target="_blank"><em class="jy">http://localhost:8888</em></a>访问jupyter notebook。以我来说，我已经有了jupyter笔记本端口8888。所以我换到了8080端口。</p><pre class="ju jv jw jx fd jz ka kb kc aw kd bi"><span id="d17a" class="ke kf hi ka b fi kg kh l ki kj">docker run -itd -p 8080:8888 -p 4040:4040 -v ~/.aws:/root/.aws:ro --name glue_jupyter amazon/aws-glue-libs:glue_libs_1.0.0_image_01 /home/jupyter/jupyter_start.sh</span></pre><p id="b4bd" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您应该在运行此命令之前完成“aws配置”。</p><p id="d303" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以选择PySpark、Python 3、Spark和SparkR等新笔记本。默认的粘合脚本包括“从pyspark.context导入spark context”py spark将是正确的选择。</p><p id="85e9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">首先我推荐使用Glue Studio的Job可视化编辑器。在设置了诸如S3桶源和目标这样的基本东西之后，重用一个自动生成的脚本是有帮助的。复制或下载。</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es kk"><img src="../Images/14d9e33fbaed9de48fd91eb49da6eb1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:530/format:webp/1*TipxBnJK6-3cf-1wDhfkdA.png"/></div><figcaption class="iq ir et er es is it bd b be z dx">Glue Job Visual Editor — Default flow</figcaption></figure><p id="910c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">因为没有'<em class="jy"> sys.argv </em>'值，所以您应该为开发环境中自动生成的脚本修复一个。</p><pre class="ju jv jw jx fd jz ka kb kc aw kd bi"><span id="21d5" class="ke kf hi ka b fi kg kh l ki kj">## <a class="ae iu" href="http://twitter.com/params" rel="noopener ugc nofollow" target="_blank">@params</a>: [JOB_NAME]<br/># args = getResolvedOptions(sys.argv, ['JOB_NAME'])<br/>args = { "JOB_NAME": "job0"}</span></pre><p id="9acd" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当只有导入脚本行作为一个单元正确运行时，您可以看到下面的输出图像，包括“可用的火花视觉”。</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es kl"><img src="../Images/c604fab9ba7ed71eda97b2f9eab15082.png" data-original-src="https://miro.medium.com/v2/resize:fit:1266/format:webp/1*QYQd81lTu_YnNJN8AEC-AQ.png"/></div><figcaption class="iq ir et er es is it bd b be z dx">screenshot after running an import cell</figcaption></figure><p id="54a0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">任务</strong></p><p id="f634" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我的任务是将天气数据添加到时间序列数据集中。使用了3个数据集。<br/> - OBS:观察有其ID、名称、位置等等。<br/> - Weathers:每日天气数据包含时间戳、平均温度、雨滴、观测的平均风速<br/> - Auctions:每日时间序列数据集包含item_id、时间戳、target_value、纬度和经度。</p><p id="ac68" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">它需要两个步骤。<br/> 1。寻找最近的OBS <br/> 2。将天气数据与OBS结合</p><p id="f92a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">使用自定义项</strong></p><p id="fadd" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这是udf的基本用法(来自pyspark.sql.functions)。DataSource1有一个位置字段，其值的示例是“35.1234_127.1234”。我不得不离开，去另一个新的专栏。类型来自“pyspark.sql.types”。</p><pre class="ju jv jw jx fd jz ka kb kc aw kd bi"><span id="9247" class="ke kf hi ka b fi kg kh l ki kj">get_lat = udf(lambda x: float(x.split('_')[0]), FloatType())<br/>get_lon = udf(lambda x: float(x.split('_')[1]), FloatType())</span><span id="d754" class="ke kf hi ka b fi km kh l ki kj">df1 = DataSource1.toDF()<br/>df1 = df1.withColumn('lat', get_lat(df1['location']))\<br/>    .withColumn('lon', get_lon(df1['location']))\<br/>    .drop('location')</span><span id="3219" class="ke kf hi ka b fi km kh l ki kj">df1.printSchema()</span></pre><p id="5752" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> DynamicFrame.fromDF </strong></p><p id="b33a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要将结果写入S3，需要'<em class="jy"> awsglue.dynamicframe </em>'中的DynamicFrame。如前所述，您不能在这个开发环境中使用“glueparquet”格式。在控制台中的生产模式下进行更改，或者您可以使用参数。</p><pre class="ju jv jw jx fd jz ka kb kc aw kd bi"><span id="2c12" class="ke kf hi ka b fi kg kh l ki kj">DataSink0 = glueContext.write_dynamic_frame.from_options(frame = DynamicFrame.fromDF(df1, glueContext, 'OBS'), connection_type = "s3", format = "csv", connection_options = {"path": "s3://target/to/path/", "partitionKeys": []}, transformation_ctx = "DataSink0")<br/>job.commit()</span></pre><p id="b8bb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">胶水1.0 vs胶水2.0 </strong></p><p id="28f1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://aws.amazon.com/blogs/aws/aws-glue-version-2-0-featuring-10x-faster-job-start-times-and-1-minute-minimum-billing-duration/?nc1=h_ls" rel="noopener ugc nofollow" target="_blank">AWS Glue 2.0版的作业启动时间加快了10倍，最短计费时间为1分钟。</a>在我的例子中，Glue 1.0在AWS cloud上运行一个作业多花了大约5分钟。找不到不用胶水2.0的理由。然而，我们还不能在使用docker容器的开发环境中逃脱Glue 1.0。我们的测试环境也很快。<a class="ae iu" href="https://docs.aws.amazon.com/glue/latest/dg/release-notes.html" rel="noopener ugc nofollow" target="_blank">两者都支持Spark 2.4.3 </a>，但是当'<em class="jy"> udf </em>'返回类型被写成字符串时，有时会显示不同的结果，一个成功开发(Glue 1.0)，另一个在AWS Glue控制台运行(Glue 2.0)失败。</p><pre class="ju jv jw jx fd jz ka kb kc aw kd bi"><span id="64b5" class="ke kf hi ka b fi kg kh l ki kj">AttributeError: 'NoneType' object has no attribute '_jvm'</span></pre><p id="b02d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这可能是一部分。然而，glue 2.0设置建议在控制台环境中作为产品使用。是的，还是会有点混乱。</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kn"><img src="../Images/a15976396dc1e4688b07a99ef2447d28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1206/format:webp/1*cuTfRZiOPFPKxsFs50K1RQ.png"/></div></div></figure><p id="ed27" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">同列</strong></p><p id="3bf7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这是一些源代码找到最近的观察与纬度和经度。<em class="jy"> df0 </em>是观察值，<em class="jy"> df1 </em>是具有位置的拍卖数据集。因此，这是将最接近的观察ID附加到df1上。起初，我认为使用2列和双循环需要行迭代，但是使用带有列的“<em class="jy">是可能的。</em></p><pre class="ju jv jw jx fd jz ka kb kc aw kd bi"><span id="329c" class="ke kf hi ka b fi kg kh l ki kj"># source from <a class="ae iu" href="https://stackoverflow.com/a/41337005/14539284" rel="noopener ugc nofollow" target="_blank">https://stackoverflow.com/a/41337005/14539284</a><br/>def distance(lat1, lon1, lat2, lon2):<br/>    p = 0.017453292519943295<br/>    hav = 0.5 - cos((lat2-lat1)*p)/2 + cos(lat1*p)*cos(lat2*p) * (1-cos((lon2-lon1)*p)) / 2<br/>    return 12742 * asin(sqrt(hav))</span><span id="2bb2" class="ke kf hi ka b fi km kh l ki kj">def closest(data, v):<br/>    return min(data, key=lambda p: distance(v['lat'],v['lon'],p['lat'],p['lon']))</span><span id="b504" class="ke kf hi ka b fi km kh l ki kj">obs = list(map(lambda row: row.asDict(), df0.collect()))<br/>set_obs = udf(lambda x, y: closest(obs, { "lat": x, "lon": y })['id'])</span><span id="75ba" class="ke kf hi ka b fi km kh l ki kj">df1 = df1.withColumn('obs', set_obs(df1["lat"], df1["lon"]))<br/>df1.printSchema()</span></pre><p id="1434" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> iterrows </strong></p><p id="b30f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">其实我也是spark上的新手。只是，我有过用spark 3.0使用'<em class="jy"> applyInPandas' </em>的体验。但是我在这种环境下大部分方法都失败了。我们处于支持spark 2.4的受限环境AWS Glue 1.0。(最近Glue 3.0在控制台可用，支持spark 3.1)。有一些用spark dataframe循环行的方法，但是我不能这样做。我可能应用了一些错误的东西，但是它失败了，至少在我的开发环境中是这样。你可以查看更多pyspark技术作为下一个链接。<br/><em class="jy">-</em><a class="ae iu" href="https://towardsdatascience.com/5-ways-to-add-a-new-column-in-a-pyspark-dataframe-4e75c2fd8c08" rel="noopener" target="_blank"><em class="jy">https://towardsdatascience . com/5-ways-to-add-a-new-column-in-a-py spark-data frame-4e 75 C2 FD 8c 08</em></a><em class="jy"><br/>-</em><a class="ae iu" href="https://sparkbyexamples.com/pyspark/pyspark-loop-iterate-through-rows-in-dataframe/" rel="noopener ugc nofollow" target="_blank"><em class="jy">https://sparkbyexamples . com/py spark-loop-iterate-through-rows-in-data frame/</em></a></p><p id="6a30" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">重启内核或spark.stop() </strong></p><p id="7212" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在工作期间，您可能会看到下一个错误。完成工作后，只需在每个任务上运行“spark.stop()”或重启内核继续工作。</p><pre class="ju jv jw jx fd jz ka kb kc aw kd bi"><span id="faa7" class="ke kf hi ka b fi kg kh l ki kj">An error was encountered:<br/>Invalid status code '404' from <a class="ae iu" href="http://localhost:8998/sessions/8" rel="noopener ugc nofollow" target="_blank">http://localhost:8998/sessions/8</a> with error payload: {"msg":"Session '8' not found."}</span></pre><p id="be75" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">加入天气数据</strong></p><p id="dbc1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最后，用上面的结果和天气数据集创建了一个新作业。“左连接”使用obs(观察id)和时间戳作为关键字。它只使用Glue Studio GUI来完成。</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ko"><img src="../Images/f730ddf4555e7d4f0432b9d2836186de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Lv9FjlcsRGtlJiVzCHSkVQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Glue Studio Job — Left Join datasets</figcaption></figure></div></div>    
</body>
</html>