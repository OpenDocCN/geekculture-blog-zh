<html>
<head>
<title>SRIOV on Mellanox ConnectX-6 Infiniband: Struggles &amp; Learnings</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Mellanox ConnectX-6 Infiniband上的SRIOV:奋斗与学习</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/sriov-on-mellanox-connectx-6-infiniband-struggles-learnings-26fd49db6fc2?source=collection_archive---------4-----------------------#2022-06-05">https://medium.com/geekculture/sriov-on-mellanox-connectx-6-infiniband-struggles-learnings-26fd49db6fc2?source=collection_archive---------4-----------------------#2022-06-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="6fdc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我在将虚拟机连接到infiniband分配的虚拟功能的过程中获得的重要经验。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/81ff2693bf56cda28be4559488d51996.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/format:webp/1*8E9wLpAil5KEEk49tO-snw.png"/></div><figcaption class="jl jm et er es jn jo bd b be z dx">Image courtesy <a class="ae jp" href="https://www.flaticon.com/free-icon/network_660502?term=network&amp;related_id=660502" rel="noopener ugc nofollow" target="_blank">Flat Icons</a></figcaption></figure><p id="078e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">按照<a class="ae jp" href="https://docs.nvidia.com/networking/pages/viewpage.action?pageId=39279752#SingleRootIOVirtualization(SRIOV)-ConfiguringSR-IOV(InfiniBand)" rel="noopener ugc nofollow" target="_blank">文档</a>在带有Mellanox Infiniband卡的系统上配置SRIOV，除了虚拟机&amp; infiniband之间的连接因为虚拟功能状态为down而无法工作之外，一切都按预期工作。</p><pre class="je jf jg jh fd jq jr js jt aw ju bi"><span id="f624" class="jv jw hi jr b fi jx jy l jz ka">[root@mymy858 ~]# ibstat<br/>CA 'mlx5_0'<br/>        CA type: MT4124<br/>        Number of ports: 1<br/>        Firmware version: 20.28.4512<br/>        Hardware version: 0<br/>        Node GUID: 0x000000<br/>        System image GUID: 0xbbbbbb<br/>        Port 1:<br/>                State: Down<br/>                Physical state: LinkUp<br/>                Rate: 10<br/>                Base lid: 65535<br/>                LMC: 0<br/>                SM lid: 1<br/>                Capability mask: 0x22221<br/>                Port GUID: 0x000000<br/>                Link layer: InfiniBand</span></pre><p id="1cf1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在虚拟机中，如果您运行<code class="du kb kc kd jr b">ip a</code>，您可能会注意到在虚拟机内部看到的ib0链接上的<code class="du kb kc kd jr b">&lt;NO-CARRIER&gt;</code>。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es ke"><img src="../Images/34472a4ff7db357099bc63f2d9ffdb3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1260/format:webp/1*WSCpi4EL_qfi3hI-mqmDng.png"/></div></figure><h2 id="0206" class="jv jw hi bd kf kg kh ki kj kk kl km kn iq ko kp kq iu kr ks kt iy ku kv kw kx bi translated">发现的问题</h2><ul class=""><li id="10f3" class="ky kz hi ih b ii la im lb iq lc iu ld iy le jc lf lg lh li bi translated">在此环境中，多个子网管理器(opensm)在不同的系统上运行。</li><li id="5394" class="ky kz hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated">其中一些子网管理器没有配置默认的<code class="du kb kc kd jr b">priorities</code></li><li id="719e" class="ky kz hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated">我们不知道哪个子网管理器是主管理器，也不知道它是否启用了<code class="du kb kc kd jr b">virtualisation</code>？</li></ul><h2 id="2e3e" class="jv jw hi bd kf kg kh ki kj kk kl km kn iq ko kp kq iu kr ks kt iy ku kv kw kx bi translated">学习</h2><ul class=""><li id="d4a5" class="ky kz hi ih b ii la im lb iq lc iu ld iy le jc lf lg lh li bi translated">不要配置多个子网管理器。默认情况下，mellanox交换机上带有一个SM。将此SM作为您的主要SM。您可以通过交换机UI将该SM的优先级设置为15(最大值)。</li><li id="5878" class="ky kz hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated">确定有多少SM正在运行。运行<code class="du kb kc kd jr b">ibdiagnet</code>来找出正在运行的SM的数量以及哪个具有最高优先级。您将在<code class="du kb kc kd jr b">ibdiagnet</code>的输出中找到这些信息。</li></ul><pre class="je jf jg jh fd jq jr js jt aw ju bi"><span id="b906" class="jv jw hi jr b fi jx jy l jz ka">Master SM: Port=0 LID=1 GUID=0x0abcdefghijkl devid=123456 Priority:14 Node_Type=SW Node_Description=MF0;switch-bkbkbk:MSB0012/U1<br/>Standby SM : No Standby SM</span></pre><ul class=""><li id="6be8" class="ky kz hi ih b ii ij im in iq lo iu lp iy lq jc lf lg lh li bi translated">在大多数情况下，最好只让一个SM运行，最好是在交换机上。</li><li id="62c3" class="ky kz hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated">通过mellanox交换机控制台执行以下命令，在交换机上运行的SM上启用虚拟化。</li></ul><pre class="je jf jg jh fd jq jr js jt aw ju bi"><span id="e7a7" class="jv jw hi jr b fi jx jy l jz ka">ib sm virt enable</span></pre><p id="9464" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，虚拟功能链路启动，虚拟机到infiniband ib0的连接正常🍪</p><pre class="je jf jg jh fd jq jr js jt aw ju bi"><span id="da90" class="jv jw hi jr b fi jx jy l jz ka">[root@mymy858 ~]# ibstat<br/>CA 'mlx5_0'<br/>        CA type: MT4124<br/>        Number of ports: 1<br/>        Firmware version: 20.28.4512<br/>        Hardware version: 0<br/>        Node GUID: 0x000000<br/>        System image GUID: 0xbbbbbb<br/>        Port 1:<br/>                State: Active<br/>                Physical state: LinkUp<br/>                Rate: 100<br/>                Base lid: 11<br/>                LMC: 0<br/>                SM lid: 1<br/>                Capability mask: 0x22221<br/>                Port GUID: 0x000000<br/>                Link layer: InfiniBand</span></pre><h1 id="364f" class="lr jw hi bd kf ls lt lu kj lv lw lx kn ly lz ma kq mb mc md kt me mf mg kw mh bi translated">摘要</h1><p id="091f" class="pw-post-body-paragraph if ig hi ih b ii la ik il im lb io ip iq mi is it iu mj iw ix iy mk ja jb jc hb bi translated">我希望这篇文章能为陷入这种困境的人提供有用的指导。如果您对infiniband上的SRIOV有任何疑问，请随时发表评论。</p><p id="7c08" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">祝你好运。</p><p id="0dca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi">— — — — — —</p></div></div>    
</body>
</html>