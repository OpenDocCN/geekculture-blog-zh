<html>
<head>
<title>Create a Twitch Chat Bot with Bitmart Integration</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">创建一个与Bitmart集成的Twitch聊天机器人</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/create-a-twitch-chat-bot-with-bitmart-integration-b2e024a34b6d?source=collection_archive---------42-----------------------#2021-06-17">https://medium.com/geekculture/create-a-twitch-chat-bot-with-bitmart-integration-b2e024a34b6d?source=collection_archive---------42-----------------------#2021-06-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/52effda1ba10eadbf9bbee234bada6e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dsrCMvym8Eng0Ii4"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Photo by <a class="ae iu" href="https://unsplash.com/@peiobty?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Pierre Borthiry</a> on <a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="6e59" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated"><strong class="ak">简介</strong></h1><p id="e139" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">在本文中，我们研究了如何使用node.js和tmi.js创建Twitch聊天机器人。我们涵盖了应用程序和理论，以了解底层技术，同时学习如何将提供的示例扩展到其他项目中。</p><h1 id="8581" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated"><strong class="ak">项目设置&amp;密钥生成</strong></h1><p id="a05f" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">如果你还没有为你选择的操作系统下载并安装Node.js 。在您的系统上创建一个名为“project”的空文件夹，或者使用您选择的命名并运行<code class="du kr ks kt ku b">npm init -y</code>为您的节点项目创建一个新的文件夹。</p><p id="2190" class="pw-post-body-paragraph jt ju hi jv b jw kv jy jz ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq hb bi translated">我们继续在项目目录的根目录下创建twitchscript.js以及一个名为。env用于存储环境变量。要创建此文件:</p><p id="984a" class="pw-post-body-paragraph jt ju hi jv b jw kv jy jz ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq hb bi translated">Windows:在项目的根目录下创建一个空白文件，并将其重命名。包封/包围（动词envelop的简写）</p><p id="ef5f" class="pw-post-body-paragraph jt ju hi jv b jw kv jy jz ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq hb bi translated">Mac:使用“cd”命令导航到终端中的根目录，然后，</p><pre class="la lb lc ld fd le ku lf lg aw lh bi"><span id="545e" class="li iw hi ku b fi lj lk l ll lm">$ touch .env</span></pre><p id="6cd3" class="pw-post-body-paragraph jt ju hi jv b jw kv jy jz ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq hb bi translated">Command + Shift +。将允许文件出现在Finder中。基本文件结构应该如下所示:</p><p id="aacf" class="pw-post-body-paragraph jt ju hi jv b jw kv jy jz ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq hb bi translated">项目/ <br/>。env<br/>twitch script . js<br/>node _ modules</p><p id="82b6" class="pw-post-body-paragraph jt ju hi jv b jw kv jy jz ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq hb bi translated">我们将在. env后面添加三行文本，分别是用户名、密码和频道。</p><p id="ece2" class="pw-post-body-paragraph jt ju hi jv b jw kv jy jz ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq hb bi translated">Username是bot帐户的显示名称，password对应于API密钥，channels是客户端要与之交互的通道的逗号分隔列表。<a class="ae iu" href="https://twitchapps.com/tmi/" rel="noopener ugc nofollow" target="_blank">https://twitchapps.com/tmi/</a>为你的账户生成一个令牌。请注意，在creds.txt中,' oauth:'被添加到键的前面。在大多数情况下，创建一个额外的帐户来区分开发人员和个人的偏好更容易。</p><p id="3b49" class="pw-post-body-paragraph jt ju hi jv b jw kv jy jz ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq hb bi translated">您的文件应该类似于:</p><p id="38ff" class="pw-post-body-paragraph jt ju hi jv b jw kv jy jz ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq hb bi translated">用户名= '用户名'<br/>密码= '密码'<br/>频道= '频道'</p><p id="c2af" class="pw-post-body-paragraph jt ju hi jv b jw kv jy jz ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq hb bi translated">就我而言:</p><p id="b952" class="pw-post-body-paragraph jt ju hi jv b jw kv jy jz ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq hb bi translated">username = tbot 8001<br/>password = oauth:KEY<br/>channel = tbot 8001</p><h1 id="4312" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated"><strong class="ak">依赖关系</strong></h1><p id="5d41" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">Node.js是一个通用的javascript运行时，有一系列的用例。在这个项目的主页上有这样的描述:“作为一个异步事件驱动的JavaScript运行时，Node.js旨在构建可扩展的网络应用。”tmi.js框架提供了Twitch的<a class="ae iu" href="https://dev.twitch.tv/docs/irc" rel="noopener ugc nofollow" target="_blank"> IRC API </a>和Node之间的桥梁，使得为一系列聊天动作声明多个事件监听器变得容易。</p><p id="1c8f" class="pw-post-body-paragraph jt ju hi jv b jw kv jy jz ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq hb bi translated">本指南使用tmi的客户端类监听聊天消息，以返回一个介于1和6之间的整数when！“骰子”被输入到聊天中。Node.js执行函数来根据聊天输入限定要采取的动作。最后，我们使用dotenv来管理我们想要隐藏的环境变量，比如我们的API键。如果还没有完成，确保通过运行以下命令导入dotenv、node-fetch和tmi</p><p id="065e" class="pw-post-body-paragraph jt ju hi jv b jw kv jy jz ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq hb bi translated">npm安装dotenv节点-获取tmi</p><p id="50a2" class="pw-post-body-paragraph jt ju hi jv b jw kv jy jz ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq hb bi translated">请注意，这些命令应该在项目的根目录下运行。要全局安装这些程序包，以便可以在任何节点项目中使用它们，请在命令末尾附加— global，例如npm install package_name — global。</p><h1 id="880e" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated"><strong class="ak">认证</strong></h1><p id="463e" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">在所有这些背景知识之后，我们可以进入教程的功能部分。打开twitchbot.js，开始写下面的内容。</p><pre class="la lb lc ld fd le ku lf lg aw lh bi"><span id="3794" class="li iw hi ku b fi lj lk l ll lm">//import dependencies<br/>const tmi = require('tmi.js');<br/>const fetch = require("node-fetch");<br/>require('dotenv').config();<br/><br/>//setting up tmi client connection<br/>const client = new tmi.Client({<br/>   connection: {<br/>       secure: true,<br/>       reconnect: true<br/>   },<br/>   identity: {<br/>       username: process.env.username,<br/>       password: process.env.password<br/>   },<br/>   channels: [process.env.channel]<br/>});<br/>client.connect();</span></pre><p id="704e" class="pw-post-body-paragraph jt ju hi jv b jw kv jy jz ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq hb bi translated">这个客户端抽象了Twitch的认证和连接工作，dotenv从当前节点<a class="ae iu" href="https://nodejs.org/docs/latest/api/process.html#process_process_env" rel="noopener ugc nofollow" target="_blank">进程</a>的env对象中提取您的凭证。</p><h1 id="cc15" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated"><strong class="ak">聊天事件</strong></h1><p id="56fd" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">聊天事件触发一个匿名函数，该函数输出响应聊天的信息。该函数用箭头符号表示；如果你不熟悉，你可以在这里查看快速参考<a class="ae iu" href="https://dmitripavlutin.com/6-ways-to-declare-javascript-functions/#4-arrow-function" rel="noopener ugc nofollow" target="_blank"/>。任何标准的函数符号都足够了，所以请随意使用您最熟悉的约定。</p><p id="387c" class="pw-post-body-paragraph jt ju hi jv b jw kv jy jz ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq hb bi translated">作为一个调试特性，我们添加以下代码片段，将所有聊天消息回显到触发节点的控制台。此外，该函数处理聊天事件的所有实例。</p><pre class="la lb lc ld fd le ku lf lg aw lh bi"><span id="d3de" class="li iw hi ku b fi lj lk l ll lm">//handles all events caused by chat input<br/>client.on('chat', (channel, tags, message) =&gt; {<br/>   //log all chat messages to console<br/>   console.log(`${tags['display-name']}: ${message}`);<br/>}</span></pre><p id="e504" class="pw-post-body-paragraph jt ju hi jv b jw kv jy jz ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq hb bi translated">我们实现的第一个交互式示例是一个骰子函数。任何匹配字符串'的聊天消息！“骰子”将触发tbot8001发送一个1到6之间的数字。在上面的console.log调用之后编写下面的代码。</p><pre class="la lb lc ld fd le ku lf lg aw lh bi"><span id="48a3" class="li iw hi ku b fi lj lk l ll lm">//logic for dice rolls. Returns a random integer from 1-6<br/>if (message == '!dice') {<br/>    client.say(channel, (1 + Math.floor(Math.random() * 6)).toString());<br/>}</span></pre><p id="d0d3" class="pw-post-body-paragraph jt ju hi jv b jw kv jy jz ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq hb bi translated">至此，twitchscript.js应该看起来像这样:</p><pre class="la lb lc ld fd le ku lf lg aw lh bi"><span id="5090" class="li iw hi ku b fi lj lk l ll lm">//import dependencies<br/>const tmi = require('tmi.js');<br/>const fetch = require("node-fetch");<br/>require('dotenv').config();<br/><br/>//setting up tmi client connection<br/><br/>const client = new tmi.Client({<br/>   connection: {<br/>       secure: true,<br/>       reconnect: true<br/>   },<br/>   identity: {<br/>       username: process.env.username,<br/>       password: process.env.password<br/>   },<br/>   channels: [process.env.channel]<br/>});<br/>client.connect();<br/><br/>//handles all events caused by chat input<br/>client.on('chat', (channel, tags, message) =&gt; {<br/>   //log all chat messages to console<br/>   console.log(`${tags['display-name']}: ${message}`);<br/><br/>   //logic for dice rolls. Returns a random integer from 1-6<br/>   if (message == '!dice') {<br/>       client.say(channel, (1 + Math.floor(Math.random() * 6)).toString());<br/>   }<br/>})</span></pre><p id="dce8" class="pw-post-body-paragraph jt ju hi jv b jw kv jy jz ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq hb bi translated">为了确保事情按照我们的计划进行，在您首选的CLI中导航到您的项目的根目录，并运行node twitchscript.js。然后，导航到您的Twitch聊天并键入！骰子。您应该会看到类似这样的内容:</p><figure class="la lb lc ld fd ij er es paragraph-image"><div class="er es ln"><img src="../Images/cd7c8efb0d32db29fe650b92be5ae719.png" data-original-src="https://miro.medium.com/v2/resize:fit:1364/0*dDhYvyQ211mgKs1-"/></div></figure><p id="2cdd" class="pw-post-body-paragraph jt ju hi jv b jw kv jy jz ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq hb bi translated">恭喜你走到这一步，你已经创建了第一个正常工作的抽搐机器人！在继续Bitmart集成之前，这里有另一个对你的机器人有用的功能:</p><pre class="la lb lc ld fd le ku lf lg aw lh bi"><span id="3bdb" class="li iw hi ku b fi lj lk l ll lm">if (message == '!clear' and username == 'tbot8001') {<br/>  client.clear(channel);<br/>}</span></pre><p id="46df" class="pw-post-body-paragraph jt ju hi jv b jw kv jy jz ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq hb bi translated">请务必将“tbot8001”更改为您的用户名。</p><h1 id="be32" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated"><strong class="ak"> Bitmart集成</strong></h1><p id="9c62" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">让我们实现一个与Bitmart的公共<a class="ae iu" href="https://developer-pro.bitmart.com/en/spot/basic/public.html" rel="noopener ugc nofollow" target="_blank">现货交易API </a>通信的函数。Bitmart是一个流行的加密货币交易所，免费向用户和非用户提供API。下面的代码片段包含了大量的信息，但提供了完整的功能，用户可以输入！“价格曲线”来获得资产价格。</p><pre class="la lb lc ld fd le ku lf lg aw lh bi"><span id="45b2" class="li iw hi ku b fi lj lk l ll lm">//logic for returning a specific price on command<br/>if (message.startsWith('!price ')) {<br/> ccy = message.substring(7)<br/> fetch(`https://api-cloud.bitmart.com/spot/v1/ticker?symbol=${ccy}`)<br/>   .then(response =&gt; response.json())<br/>   .then((data) =&gt; {<br/>     pair_info = data['data']['tickers'][0]<br/>     client.say(client.channels[0], `${pair_info['symbol']} | ${pair_info['last_price']}`);<br/>   })<br/>   .catch((err) =&gt; {<br/>     client.say(client.channels[0], `Invalid input.`)<br/>     console.log('Fetch Error :-S', err);<br/>   })<br/>}</span></pre><p id="2a43" class="pw-post-body-paragraph jt ju hi jv b jw kv jy jz ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq hb bi translated">很简单，我们扫描以'开头的邮件。价格'来触发我们的决策树。变量ccy读取跟在'后面的子字符串。“价格”应该是平台支持的加密货币的名称。最后，我们实现了与Bitmart的连接。</p><p id="3d8e" class="pw-post-body-paragraph jt ju hi jv b jw kv jy jz ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq hb bi translated">在进入ping Bitmart服务器的fetch部分之前，我们定义了一个promise对象。根据<a class="ae iu" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise" rel="noopener ugc nofollow" target="_blank"> MDN网络文档</a>:</p><p id="ea7f" class="pw-post-body-paragraph jt ju hi jv b jw kv jy jz ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq hb bi translated">承诺对象表示异步操作的最终完成(或失败)及其结果值。</p><p id="bb4c" class="pw-post-body-paragraph jt ju hi jv b jw kv jy jz ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq hb bi translated">此外，</p><p id="af11" class="pw-post-body-paragraph jt ju hi jv b jw kv jy jz ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq hb bi translated">承诺处于以下状态之一:</p><ul class=""><li id="fead" class="lo lp hi jv b jw kv ka kw ke lq ki lr km ls kq lt lu lv lw bi translated"><em class="lx">待定</em>:初始状态，未履行，未拒绝。</li><li id="0119" class="lo lp hi jv b jw ly ka lz ke ma ki mb km mc kq lt lu lv lw bi translated"><em class="lx">完成</em>:表示操作成功完成。</li><li id="37c8" class="lo lp hi jv b jw ly ka lz ke ma ki mb km mc kq lt lu lv lw bi translated"><em class="lx">拒绝</em>:表示操作失败。</li></ul><p id="1619" class="pw-post-body-paragraph jt ju hi jv b jw kv jy jz ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq hb bi translated">在我们的代码中，对fetch的调用返回一个承诺，当这个承诺被解析时，要么返回资产的价格，要么向控制台和聊天返回一个失败消息。我们必须使用fetch的原因是，数据不是从代码中的某个函数返回的，而是从外部服务器返回的，而外部服务器不会立即或可靠地返回数据。</p><p id="b673" class="pw-post-body-paragraph jt ju hi jv b jw kv jy jz ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq hb bi translated">测试这个函数我们看到:</p><figure class="la lb lc ld fd ij er es paragraph-image"><div class="er es md"><img src="../Images/da5a5335c0b40440f33430f0fbfc49ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1352/format:webp/1*PyKb_z7KaBcWdL3tjazJWg.png"/></div></figure><h1 id="3844" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated"><strong class="ak">结论</strong></h1><p id="832a" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">我们现在有一个功能正常的Twitch机器人，可以连接到第三方服务。本教程应该作为创建聊天机器人和API交互的快速介绍，可以扩展到其他平台和用例。在本指南结束时，您的代码应该类似于:</p><pre class="la lb lc ld fd le ku lf lg aw lh bi"><span id="9fa6" class="li iw hi ku b fi lj lk l ll lm">//import dependencies<br/>const tmi = require('tmi.js');<br/>const fetch = require("node-fetch");<br/>require('dotenv').config();<br/><br/>//setting up tmi client connection<br/><br/>const client = new tmi.Client({<br/> connection: {<br/>   secure: true,<br/>   reconnect: true<br/> },<br/> identity: {<br/>   username: process.env.username,<br/>   password: process.env.password<br/> },<br/> channels: [process.env.channel]<br/>});<br/>client.connect();<br/><br/>//handles all events caused by chat input<br/>client.on('chat', (channel, tags, message) =&gt; {<br/> //log all chat messages to console<br/> console.log(`${tags['display-name']}: ${message}`);<br/><br/> //logic for dice rolls. Returns a random integer from 1-6<br/> if (message == '!dice') {<br/>   client.say(channel, (1 + Math.floor(Math.random() * 6)).toString());<br/> }<br/><br/> if (message == '!clear' and username == 'tbot8001') {<br/>   client.clear(channel);<br/> }<br/><br/> //logic for returning a specific price on command<br/> if (message.startsWith('!price ')) {<br/>   ccy = message.substring(7)<br/>   fetch(`https://api-cloud.bitmart.com/spot/v1/ticker?symbol=${ccy}`)<br/>     .then(response =&gt; response.json())<br/>     .then((data) =&gt; {<br/>       pair_info = data['data']['tickers'][0]<br/>       client.say(client.channels[0], `${pair_info['symbol']} | ${pair_info['last_price']}`);<br/>     })<br/>     .catch((err) =&gt; {<br/>       client.say(client.channels[0], `Invalid input.`)<br/>       console.log('Fetch Error: ', err);<br/>     })<br/><br/> }<br/>});</span></pre><p id="9d3e" class="pw-post-body-paragraph jt ju hi jv b jw kv jy jz ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq hb bi translated">感谢阅读，我们下次再见。</p></div></div>    
</body>
</html>