<html>
<head>
<title>Handling multipart form requests with React.js, Express API, and MySQL via Axios and uploading files with Multer.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过Axios使用React.js、Express API和MySQL处理多部分表单请求，并使用Multer上传文件。</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/handling-multipart-form-requests-with-react-js-5d773856cf86?source=collection_archive---------4-----------------------#2021-08-05">https://medium.com/geekculture/handling-multipart-form-requests-with-react-js-5d773856cf86?source=collection_archive---------4-----------------------#2021-08-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/></div><div class="ab cl if ig gp ih" role="separator"><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik"/></div><div class="hb hc hd he hf"><blockquote class="im in io"><p id="bc04" class="ip iq ir is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在本文中，我们将看到如何在React.js和Express.js中处理来自多部分表单的post请求，以及针对各种输入类型的Axios和Multer。我会尽可能用最简单易懂的方式记录下来。</p><p id="d443" class="ip iq ir is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我在几个地方保存了<strong class="is hj"> console.log </strong>语句，因为它们对理解代码的行为非常有帮助。根据您的要求，您可以随意保留或删除它们。</p></blockquote><p id="cbfd" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jo jc jd je jp jg jh ji jq jk jl jm jn hb bi translated">在开始主题的实际开发之前，我们需要确保Node和npm已经安装。如果已安装，使用以下命令检查您的节点版本和npm版本；</p><pre class="jr js jt ju fd jv jw jx jy aw jz bi"><span id="3af5" class="ka kb hi jw b fi kc kd l ke kf">node -v // for checking version of node if installed.<br/>npm -v  // for checking version of npm if installed.</span></pre><p id="c82d" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jo jc jd je jp jg jh ji jq jk jl jm jn hb bi translated">同样，我们需要看到我们的系统上安装了MySQL。</p><pre class="jr js jt ju fd jv jw jx jy aw jz bi"><span id="21de" class="ka kb hi jw b fi kc kd l ke kf">mysql -V </span></pre><p id="d9c5" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jo jc jd je jp jg jh ji jq jk jl jm jn hb bi translated">现在我们可以继续讨论我们文章的主要目标了。</p></div><div class="ab cl if ig gp ih" role="separator"><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik"/></div><div class="hb hc hd he hf"><h2 id="47ef" class="ka kb hi bd kg kh ki kj kk kl km kn ko jo kp kq kr jp ks kt ku jq kv kw kx ky bi translated"><strong class="ak">第一步:设置MySQL数据库和表来查询数据:</strong></h2><p id="dce0" class="pw-post-body-paragraph ip iq hi is b it kz iv iw ix la iz ja jo lb jd je jp lc jh ji jq ld jl jm jn hb bi translated">我们将首先通过运行以下查询来创建一个新数据库(取决于您的需求，如果您愿意，可以在现有的数据库中创建您的表):</p><pre class="jr js jt ju fd jv jw jx jy aw jz bi"><span id="bfa1" class="ka kb hi jw b fi kc kd l ke kf">CREATE DATABASE <em class="ir">products_db</em>;</span></pre><p id="f7f8" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jo jc jd je jp jg jh ji jq jk jl jm jn hb bi translated">成功创建数据库后，使用以下命令开始使用数据库:</p><pre class="jr js jt ju fd jv jw jx jy aw jz bi"><span id="d8cf" class="ka kb hi jw b fi kc kd l ke kf">USE DATABASE <em class="ir">products_db</em>;</span></pre><p id="78ea" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jo jc jd je jp jg jh ji jq jk jl jm jn hb bi translated">现在，我们将创建一个表，用于存储我们产品的详细信息，随着我们的进一步发展，我们最终会添加这些信息。我们将创建包含以下各列的表:name、price和file。</p><pre class="jr js jt ju fd jv jw jx jy aw jz bi"><span id="6e65" class="ka kb hi jw b fi kc kd l ke kf">CREATE TABLE products (<br/>  product_id int NOT NULL AUTO_INCREMENT,<br/>  name varchar(50) NOT NULL,<br/>  price int NOT NULL,<br/>  file varchar(50) NOT NULL,<br/>  PRIMARY KEY (product_id)<br/>);</span></pre></div><div class="ab cl if ig gp ih" role="separator"><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik"/></div><div class="hb hc hd he hf"><h2 id="b18c" class="ka kb hi bd kg kh ki kj kk kl km kn ko jo kp kq kr jp ks kt ku jq kv kw kx ky bi translated"><strong class="ak">第二步:设置我们的快递环境:</strong></h2><p id="4e24" class="pw-post-body-paragraph ip iq hi is b it kz iv iw ix la iz ja jo lb jd je jp lc jh ji jq ld jl jm jn hb bi translated">首先，我们将创建我们想要执行后端操作的目录。为此，请在系统中您觉得合适的任何位置创建一个目录…</p><pre class="jr js jt ju fd jv jw jx jy aw jz bi"><span id="c1a4" class="ka kb hi jw b fi kc kd l ke kf">mkdir express_backend</span></pre><p id="0434" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jo jc jd je jp jg jh ji jq jk jl jm jn hb bi translated">现在我们有了自己的文件夹，我们将初始化其中的开发环境。在终端中运行以下命令来设置您的环境。</p><pre class="jr js jt ju fd jv jw jx jy aw jz bi"><span id="11ae" class="ka kb hi jw b fi kc kd l ke kf">npm init -y </span></pre><p id="1cfe" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jo jc jd je jp jg jh ji jq jk jl jm jn hb bi translated">成功运行这个命令将在您的项目目录中创建一个<strong class="is hj"> package.json </strong>文件。我们已经使用了'-y '标志来初始化环境，而没有经过所有的命名手续，npm将配置它，这是完全可选的。接下来，我们将在您的项目结构的根目录下创建一个名为<strong class="is hj"> app.js </strong>(您可以根据自己的选择命名)<strong class="is hj"> </strong>的文件。这个app.js文件将保存我们所有的Express API路由。现在，我们继续安装我们在开发过程中需要的所有依赖项。</p><p id="4f72" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jo jc jd je jp jg jh ji jq jk jl jm jn hb bi translated">对于我们的主题，如前所述，我们将使用express、MySQL、Axios(参见下面的React.js部分)和Multer。要安装这些依赖项，请运行:</p><pre class="jr js jt ju fd jv jw jx jy aw jz bi"><span id="9399" class="ka kb hi jw b fi kc kd l ke kf">npm i express@4.17.1 // install express<br/>npm i cors@2.8.5   // install cors<br/>npm i mysql@2.18.1   // install mysql<br/>npm i multer@1.4.2   // install multer<br/>npm i nodemon@2.0.12 // install nodemon</span></pre><p id="ff92" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jo jc jd je jp jg jh ji jq jk jl jm jn hb bi translated">我们安装nodemon是为了在每次进行和保存更改时不用手动启动服务器。Nodemon将监视<strong class="is hj"> mjs、js和json </strong>扩展。现在，我们已经拥有了所有必需的依赖项。这就是完成这些步骤后项目结构和<strong class="is hj"> package.json </strong>的样子。</p><figure class="jr js jt ju fd lf er es paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="er es le"><img src="../Images/65e4f3abe7ccd9355e497995b5226236.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XMJmwEKCAU0exB19cqtLPg.png"/></div></div><figcaption class="lm ln et er es lo lp bd b be z dx">Project Structure for the Express API and installed dependencies in package.json</figcaption></figure><p id="5f16" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jo jc jd je jp jg jh ji jq jk jl jm jn hb bi translated">我们还增加了CORS套餐。<strong class="is hj"/>代表<strong class="is hj">跨产地资源共享</strong>。我们使用CORS的原因是，如果客户机(在我们的例子中是react.js应用程序)和服务器(我们创建的express服务器)不在同一个地方，浏览器默认情况下会阻止请求。CORS允许客户端和服务器之间基于两个不同来源的通信。现在我们需要app.js文件中的依赖项。参见下面的代码:</p><figure class="jr js jt ju fd lf"><div class="bz dy l di"><div class="lq lr l"/></div></figure><p id="b487" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jo jc jd je jp jg jh ji jq jk jl jm jn hb bi translated">我们的服务器应该在“localhost:3000”上。接下来，我们将建立到MySQL数据库的连接:</p><figure class="jr js jt ju fd lf"><div class="bz dy l di"><div class="lq lr l"/></div></figure><p id="d432" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jo jc jd je jp jg jh ji jq jk jl jm jn hb bi translated">我已经将我的数据库凭证作为环境变量传递，如果您在本地进行测试，那么您的主机将是host: 'localhost '和user: 'root '(在大多数情况下)，使用您为访问MySQL设置的任何密码。请注意connection内部名为tls的对象键。tls (TLS)代表传输层安全性(参考链接在最后给出)。这里，我们将tls rejectUnauthorized设置为false，这意味着您基本上禁用了服务器证书验证。<strong class="is hj">警告:</strong>这种方法只适用于本地开发，不适用于生产。</p></div><div class="ab cl if ig gp ih" role="separator"><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik"/></div><div class="hb hc hd he hf"><h2 id="89dd" class="ka kb hi bd kg kh ki kj kk kl km kn ko jo kp kq kr jp ks kt ku jq kv kw kx ky bi translated"><strong class="ak">步骤3:设置Multer: </strong></h2><p id="99d8" class="pw-post-body-paragraph ip iq hi is b it kz iv iw ix la iz ja jo lb jd je jp lc jh ji jq ld jl jm jn hb bi translated">我们将使用Multer上传文件到我们的服务器。我们已经在app.js中安装并要求了Multer(见上文)。Multer是一个Node.js中间件，我们用它来处理来自<strong class="is hj"> multipart/form-data </strong>的请求，特别是处理文件上传。</p><p id="4738" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jo jc jd je jp jg jh ji jq jk jl jm jn hb bi translated"><strong class="is hj">设置:</strong>将下面几行代码添加到app.js本身。或者，如果您愿意，也可以将它作为一个模块从另一个文件中导出。</p><figure class="jr js jt ju fd lf"><div class="bz dy l di"><div class="lq lr l"/></div></figure><p id="f140" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jo jc jd je jp jg jh ji jq jk jl jm jn hb bi translated">在项目结构的根级别创建一个名为<strong class="is hj"> uploads </strong>的新路径。接下来，我们为API创建post路由，以处理来自表单的POST请求。</p><figure class="jr js jt ju fd lf"><div class="bz dy l di"><div class="lq lr l"/></div><figcaption class="lm ln et er es lo lp bd b be z dx">POST Request for uploading the file to DB</figcaption></figure><p id="f422" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jo jc jd je jp jg jh ji jq jk jl jm jn hb bi translated">记住<strong class="is hj">上传</strong>将是一个静态文件夹，它将存储我们上传到其中的所有文件。因此，我们需要提供静态文件，我们将通过以下方式做到这一点:</p><pre class="jr js jt ju fd jv jw jx jy aw jz bi"><span id="b38d" class="ka kb hi jw b fi kc kd l ke kf">// Serve Static Files</span><span id="5339" class="ka kb hi jw b fi ls kd l ke kf">app.use(express.static('uploads'));</span></pre><p id="d91c" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jo jc jd je jp jg jh ji jq jk jl jm jn hb bi translated">使用Multer，我们可以指定是上传单个文件还是多个文件，因此在这里，我们指定<strong class="is hj"> upload.single('file') </strong>作为app.post()中的参数。请注意，在upload.single()中，我指定了一个名为“file”的字符串。我将很快回来讨论它(参见React.js一节)。至此，我们已经完成了我们的明确要求，现在可以继续我们的主题部分了，在这里我们用React.js绑定所有内容。</p></div><div class="ab cl if ig gp ih" role="separator"><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik"/></div><div class="hb hc hd he hf"><h2 id="a7e8" class="ka kb hi bd kg kh ki kj kk kl km kn ko jo kp kq kr jp ks kt ku jq kv kw kx ky bi translated">步骤4:设置React.js:</h2><p id="61c5" class="pw-post-body-paragraph ip iq hi is b it kz iv iw ix la iz ja jo lb jd je jp lc jh ji jq ld jl jm jn hb bi translated">如果您的系统上没有安装React.js，请通过以下方式安装它:</p><pre class="jr js jt ju fd jv jw jx jy aw jz bi"><span id="45db" class="ka kb hi jw b fi kc kd l ke kf">npm install -g create-react-app</span></pre><p id="c1c7" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jo jc jd je jp jg jh ji jq jk jl jm jn hb bi translated">现在我们将创建react应用程序，它将向我们的后端提供数据。对于该运行:</p><pre class="jr js jt ju fd jv jw jx jy aw jz bi"><span id="1a2c" class="ka kb hi jw b fi kc kd l ke kf">npx create-react-app multipart-form</span></pre><p id="3c2d" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jo jc jd je jp jg jh ji jq jk jl jm jn hb bi translated">您可以在您希望安装react应用程序的系统目录中运行这个命令。安装后，我们将设置基本结构。我在src文件夹中的components文件夹下创建了一个名为<strong class="is hj"> multiform.js </strong>的文件，并将其导入到我的<strong class="is hj"> App.js </strong>中。</p><figure class="jr js jt ju fd lf"><div class="bz dy l di"><div class="lq lr l"/></div></figure><p id="77e3" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jo jc jd je jp jg jh ji jq jk jl jm jn hb bi translated"><strong class="is hj">注意</strong>:为我们的表单提供encType是很重要的，在我们的例子中是multipart/form，因为Multer不处理任何不是multipart的表单。另外，请注意，我在POST请求中提到的参数<strong class="is hj">‘file’</strong>实际上是file类型的输入字段的名称。现在在<strong class="is hj"> App.js </strong>中:</p><figure class="jr js jt ju fd lf"><div class="bz dy l di"><div class="lq lr l"/></div></figure><p id="5e8b" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jo jc jd je jp jg jh ji jq jk jl jm jn hb bi translated">这是该文件夹的结构外观:</p><figure class="jr js jt ju fd lf er es paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="er es le"><img src="../Images/9ea4137e811d07db764f4d3d110255c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VXxsAM0D-YiaLqJUk-phNQ.png"/></div></div><figcaption class="lm ln et er es lo lp bd b be z dx">React.js Project Structure</figcaption></figure><p id="a562" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jo jc jd je jp jg jh ji jq jk jl jm jn hb bi translated"><strong class="is hj">创建变更和处理表单提交的事件处理程序:</strong></p><p id="e9f9" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jo jc jd je jp jg jh ji jq jk jl jm jn hb bi translated">我们现在将创建三个事件处理程序，第一个是handleChange处理程序，第二个是fileSelectedHandler，最后一个是fileUploadHandler。为此，我们将首先在React应用程序中安装Axios，以便向服务器发出POST请求:</p><pre class="jr js jt ju fd jv jw jx jy aw jz bi"><span id="3f57" class="ka kb hi jw b fi kc kd l ke kf">npm i axios@0.21.1  // install axios</span></pre><p id="86fe" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jo jc jd je jp jg jh ji jq jk jl jm jn hb bi translated">然后使用以下命令导入multiform.js文件中的Axios:</p><pre class="jr js jt ju fd jv jw jx jy aw jz bi"><span id="a5c4" class="ka kb hi jw b fi kc kd l ke kf">import axios from 'axios';</span></pre><p id="07f7" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jo jc jd je jp jg jh ji jq jk jl jm jn hb bi translated">创建各种处理程序，它们的名字我已经在上面提到过了:</p><figure class="jr js jt ju fd lf"><div class="bz dy l di"><div class="lq lr l"/></div></figure><p id="1765" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jo jc jd je jp jg jh ji jq jk jl jm jn hb bi translated">在<strong class="is hj"> handleChange </strong>处理程序中，我们通过从表单接收的值来设置名称和价格的状态。在<strong class="is hj"> fileSelectedHandler </strong>中，我们为文件名和将要上传的文件设置状态。</p><p id="0222" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jo jc jd je jp jg jh ji jq jk jl jm jn hb bi translated">我们将我们的值追加到<strong class="is hj"> formData </strong>中，然后我们将它和一个配置对象一起传递给我们的Axios post处理程序，该配置对象指定我们正在发送一个多部分表单数据<strong class="is hj">‘多部分/表单’</strong>。<strong class="is hj">注意</strong>:在调用<strong class="is hj"> render () {} </strong>方法<strong class="is hj"> </strong>之前，指定你的状态和处理程序。否则，您将得到错误，指出XYZ处理程序未定义，状态未定义，等等。</p><p id="ac83" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jo jc jd je jp jg jh ji jq jk jl jm jn hb bi translated">完成以下步骤后，我们的文件上传系统就可以使用React、Express和Multer了！</p></div><div class="ab cl if ig gp ih" role="separator"><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik"/></div><div class="hb hc hd he hf"><blockquote class="im in io"><p id="aadf" class="ip iq ir is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">问:如何查看我用localhost上传的文件？</p></blockquote><p id="3da1" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jo jc jd je jp jg jh ji jq jk jl jm jn hb bi translated">在浏览器的URL中，只需输入<strong class="is hj">localhost</strong>T30】/nameoftefilethayouhaveuploaded。在我的情况下，我有一个PDF文件，我已经上传到我的express服务器，这是如何查看它:</p><figure class="jr js jt ju fd lf er es paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="er es lt"><img src="../Images/d408daccba26704e1d50537550a98acb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mAUw-M0Z7n93oioiweg9xw.png"/></div></div><figcaption class="lm ln et er es lo lp bd b be z dx">Uploaded PDF as viewed from our express server on localhost:3000.</figcaption></figure><h2 id="3419" class="ka kb hi bd kg kh ki kj kk kl km kn ko jo kp kq kr jp ks kt ku jq kv kw kx ky bi translated">第5步:从React.js查看您上传的文件:</h2><p id="41e4" class="pw-post-body-paragraph ip iq hi is b it kz iv iw ix la iz ja jo lb jd je jp lc jh ji jq ld jl jm jn hb bi translated">这是我们话题的最后一步。我们将从用户界面访问我们的文件。为此，我们将创建一个名为<strong class="is hj"> viewpdf.js </strong>的新文件。在viewpdf.js文件中，我们将为文件列表设置一个状态。</p><figure class="jr js jt ju fd lf"><div class="bz dy l di"><div class="lq lr l"/></div></figure><p id="b57e" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jo jc jd je jp jg jh ji jq jk jl jm jn hb bi translated">我们根据从API接收到的数据设置<strong class="is hj"> listOfItems </strong>的状态。然后，我们通过状态映射来显示我们的数据和查看我们的文件。最后，我们将它导入回我们的App.js。</p><pre class="jr js jt ju fd jv jw jx jy aw jz bi"><span id="4137" class="ka kb hi jw b fi kc kd l ke kf">import ViewPDF from "./components/viewpdf";</span></pre><p id="cbbd" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jo jc jd je jp jg jh ji jq jk jl jm jn hb bi translated">就是这样！我将添加一点点的风格，这是你可以选择的，因为你可以用自己的方式来设计。谢谢你。</p><h2 id="c1ea" class="ka kb hi bd kg kh ki kj kk kl km kn ko jo kp kq kr jp ks kt ku jq kv kw kx ky bi translated">GitHub资源库的链接:</h2><p id="db54" class="pw-post-body-paragraph ip iq hi is b it kz iv iw ix la iz ja jo lb jd je jp lc jh ji jq ld jl jm jn hb bi translated"><em class="ir">快递服务器</em> : <a class="ae lu" href="https://github.com/chinmaykarmokar/multer-express-server" rel="noopener ugc nofollow" target="_blank">链接到GitHub仓库。</a></p><p id="5ad3" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jo jc jd je jp jg jh ji jq jk jl jm jn hb bi translated"><em class="ir"> React App </em> : <a class="ae lu" href="https://github.com/chinmaykarmokar/react-multipart-form" rel="noopener ugc nofollow" target="_blank">链接到GitHub库。</a></p><h2 id="54b0" class="ka kb hi bd kg kh ki kj kk kl km kn ko jo kp kq kr jp ks kt ku jq kv kw kx ky bi translated">参考资料:</h2><p id="f9ef" class="pw-post-body-paragraph ip iq hi is b it kz iv iw ix la iz ja jo lb jd je jp lc jh ji jq ld jl jm jn hb bi translated"><em class="ir"> TLS </em> : <a class="ae lu" href="https://levelup.gitconnected.com/how-to-resolve-certificate-errors-in-nodejs-app-involving-ssl-calls-781ce48daded" rel="noopener ugc nofollow" target="_blank">点击这里了解更多。</a></p></div></div>    
</body>
</html>