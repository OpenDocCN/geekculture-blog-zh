<html>
<head>
<title>Avoid Memory Leaks in your React App by canceling API calls</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过取消API调用来避免React应用程序中的内存泄漏</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/avoid-memory-leaks-in-your-react-app-by-canceling-api-calls-9cf692c06573?source=collection_archive---------2-----------------------#2021-10-29">https://medium.com/geekculture/avoid-memory-leaks-in-your-react-app-by-canceling-api-calls-9cf692c06573?source=collection_archive---------2-----------------------#2021-10-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/97f94998a3a585bf2128d4f2352ff76c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qbW-3prta82yTJWA"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Photo by <a class="ae iu" href="https://unsplash.com/@sanatoga?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Joe Zlomek</a> on <a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><figure class="iw ix iy iz fd ij er es paragraph-image"><div class="er es iv"><img src="../Images/effd53aa24e798024477be31fad207cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:858/format:webp/1*z_-fJYFHALIfUpDYr8u6QQ.png"/></div></figure><p id="052e" class="pw-post-body-paragraph ja jb hi jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx hb bi translated">你肯定在使用React应用程序时遇到过这个警告。即使JavaScript语言有一个自动化的内存管理机制，如果我们不小心实现程序，内存泄漏仍然有可能发生。这同样适用于React应用程序。内存泄漏不是一个好现象，应该避免。</p><p id="94f0" class="pw-post-body-paragraph ja jb hi jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx hb bi translated">内存泄漏最容易被忽视的原因是API调用处理不当。因为对API的调用是异步的，所以在请求完成之前，启动任务的组件可能会被卸载。例如，当用户转到另一个页面而当前页面尚未完成加载时，就会发生这种情况。</p><h1 id="9b35" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">演示</h1><p id="d53d" class="pw-post-body-paragraph ja jb hi jc b jd kw jf jg jh kx jj jk jl ky jn jo jp kz jr js jt la jv jw jx hb bi translated">为了演示，让我们使用一个简单的React应用程序，它有两个组件，<code class="du lb lc ld le b">Home</code>和<code class="du lb lc ld le b">About</code>，还有一个在两者之间切换的按钮。<code class="du lb lc ld le b">Home</code>组件从我们将使用<code class="du lb lc ld le b">json-server</code>设置的API中获取博客文章数据。我们还将把服务器的响应时间延迟到3秒，这样我们就有足够的时间在API请求完成之前在两个组件之间进行切换。</p><figure class="iw ix iy iz fd ij"><div class="bz dy l di"><div class="lf lg l"/></div></figure><p id="056c" class="pw-post-body-paragraph ja jb hi jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx hb bi translated">在我们的<code class="du lb lc ld le b">App.jsx</code>中，我们有一个按钮来切换<code class="du lb lc ld le b">isHome</code>状态，并有条件地呈现<code class="du lb lc ld le b">Home</code>或<code class="du lb lc ld le b">About</code>组件。</p><figure class="iw ix iy iz fd ij"><div class="bz dy l di"><div class="lf lg l"/></div></figure><p id="7703" class="pw-post-body-paragraph ja jb hi jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx hb bi translated">在初始渲染期间,<code class="du lb lc ld le b">Home</code>组件从我们的API服务器获取博客文章数据。</p><figure class="iw ix iy iz fd ij"><div class="bz dy l di"><div class="lf lg l"/></div></figure><p id="6bf4" class="pw-post-body-paragraph ja jb hi jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx hb bi translated"><code class="du lb lc ld le b">About</code>组件只包含一些要在DOM中呈现的文本。</p><p id="fd25" class="pw-post-body-paragraph ja jb hi jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx hb bi translated">我们还需要添加<code class="du lb lc ld le b">json-server</code>，并在我们的<code class="du lb lc ld le b">package.json</code>文件中将其配置为3秒的响应延迟。</p><pre class="iw ix iy iz fd lh le li lj aw lk bi"><span id="5aaa" class="ll jz hi le b fi lm ln l lo lp">{<br/> "scripts":{<br/>     ...<br/>    "server": "json-server --watch db.json --port 3001 --delay 3000"<br/>}<br/>}</span></pre><p id="68bf" class="pw-post-body-paragraph ja jb hi jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx hb bi translated">现在，如果我们在加载过程中运行我们的项目并点击“About Page”按钮，我们将在控制台上得到一个内存泄漏警告。</p><figure class="iw ix iy iz fd ij er es paragraph-image"><div class="er es lq"><img src="../Images/c6eb2e747bd25518437df17937486102.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*zYYGTaPoIBOLQliFQsyvBw.gif"/></div><figcaption class="iq ir et er es is it bd b be z dx">Memory leak warning shows up on the console</figcaption></figure><h1 id="13a8" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">解决方案</h1><p id="5c4a" class="pw-post-body-paragraph ja jb hi jc b jd kw jf jg jh kx jj jk jl ky jn jo jp kz jr js jt la jv jw jx hb bi translated">解决这个问题的方法是在调用<code class="du lb lc ld le b">useEffect</code>清理函数时取消API请求。取消请求的首选方式是使用<code class="du lb lc ld le b">AbortController</code>，如<a class="ae iu" href="https://developer.mozilla.org/en-US/docs/Web/API/AbortController" rel="noopener ugc nofollow" target="_blank"> Web API文档</a>中所述。通过将<code class="du lb lc ld le b">AbortSignal</code>传递给<code class="du lb lc ld le b">fetch</code>方法，然后在卸载组件之前调用<code class="du lb lc ld le b">abort</code>,<code class="du lb lc ld le b">AbortController</code>将允许我们中止web请求。</p><p id="96e0" class="pw-post-body-paragraph ja jb hi jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx hb bi translated">我们需要对我们的<code class="du lb lc ld le b">Home</code>组件稍作修改，以避免内存泄漏问题。我们初始化一个新的<code class="du lb lc ld le b">AbortController</code>实例，并将来自控制器的信号作为信号属性传递给我们的<code class="du lb lc ld le b">fetch</code>方法。然后我们在我们的<code class="du lb lc ld le b">useEffect</code>钩子的返回函数上调用<code class="du lb lc ld le b">controller.abort</code>。</p><figure class="iw ix iy iz fd ij"><div class="bz dy l di"><div class="lf lg l"/></div></figure><p id="5478" class="pw-post-body-paragraph ja jb hi jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx hb bi translated">现在，如果我们像以前一样尝试，在加载过程中切换到<code class="du lb lc ld le b">About</code>组件，内存泄漏警告将不会出现在控制台中。</p><h1 id="8bcb" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">结论</h1><p id="fba9" class="pw-post-body-paragraph ja jb hi jc b jd kw jf jg jh kx jj jk jl ky jn jo jp kz jr js jt la jv jw jx hb bi translated">好了，这就是这篇文章。希望你喜欢读它。你可以在这里找到演示<a class="ae iu" href="https://github.com/eyuelberga/react-memory-leak-demo" rel="noopener ugc nofollow" target="_blank">的源代码。</a></p></div></div>    
</body>
</html>