<html>
<head>
<title>Data Version Control (DVC) with Google Cloud Storage and Python for ML</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Google云存储和Python进行ML的数据版本控制(DVC)</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/data-version-control-dvc-with-google-cloud-storage-and-python-for-ml-fe99dc7d338?source=collection_archive---------4-----------------------#2021-06-13">https://medium.com/geekculture/data-version-control-dvc-with-google-cloud-storage-and-python-for-ml-fe99dc7d338?source=collection_archive---------4-----------------------#2021-06-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="6c1d" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">数据版本控制是一个即将到来的领域，需要更快地实现机器学习迭代，并仍然跟踪数据和模型的变化。</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/117226eb69cb724399a39a79ce9afb5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vms_o3edyKdVSX8G4AhMAg.png"/></div></div></figure><h1 id="3df1" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">介绍</h1><p id="9e2a" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">机器学习项目生命周期不同于正常的软件生命周期，正常的软件生命周期不太依赖于数据，而在机器学习中，每个模型都依赖于底层数据，并且当数据改变时，模型的行为也不同。</p><blockquote class="kx ky kz"><p id="ccee" class="kb kc la kd b ke lb ij kg kh lc im kj ld le km kn lf lg kq kr lh li ku kv kw hb bi translated">简单来说——数据变化&gt; ml代码需要重新校准&gt;模型变化</p></blockquote><p id="736e" class="pw-post-body-paragraph kb kc hi kd b ke lb ij kg kh lc im kj kk le km kn ko lg kq kr ks li ku kv kw hb bi translated">所以绝对需要跟踪的不仅仅是代码，还有用于构建模型的数据。</p><h1 id="4d32" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">欢迎使用数据版本控制</h1><p id="7bab" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">在这篇文章中，我们将看到一个叫做<code class="du lj lk ll lm b">dvc</code>的工具，它与<code class="du lj lk ll lm b">git</code>非常相似，但是用于数据。对于不熟悉git的人来说，<code class="du lj lk ll lm b">git</code>是一个开源版本控制系统，用于跟踪文件集的变化，并保存这些变化的历史。这主要用于所有软件开发生命周期，是DevOps的组成部分之一。(我们将在另一篇文章中讨论类似的MLOps概念)。</p><p id="6f01" class="pw-post-body-paragraph kb kc hi kd b ke lb ij kg kh lc im kj kk le km kn ko lg kq kr ks li ku kv kw hb bi translated">这里的核心概念是，我们跟踪文件更改，并使用推送命令将文件更改存储在具有标识符<code class="du lj lk ll lm b">hash</code>的远程位置，稍后当我们需要代码/数据的版本时可以获取这些更改。</p><p id="f17f" class="pw-post-body-paragraph kb kc hi kd b ke lb ij kg kh lc im kj kk le km kn ko lg kq kr ks li ku kv kw hb bi translated">对于使用<code class="du lj lk ll lm b">git</code>的代码变更，我们有GitHub、BitBucket、GitLab等选项..类似地，对于数据更改(我们正在谈论的是巨大的文件)，我们需要一个位置来在远程存储中存储这些文件。</p><p id="91cb" class="pw-post-body-paragraph kb kc hi kd b ke lb ij kg kh lc im kj kk le km kn ko lg kq kr ks li ku kv kw hb bi translated">使用这种方法，我们将数据从代码中分离出来，并且可以根据需求提取数据。</p><p id="2656" class="pw-post-body-paragraph kb kc hi kd b ke lb ij kg kh lc im kj kk le km kn ko lg kq kr ks li ku kv kw hb bi translated">虽然<code class="du lj lk ll lm b">dvc</code>可以用于在各种平台上远程存储数据，包括(但不限于)AWS、Google Drive、Local Folder、SSH，但在本文中，我将使用Google云存储(因为我很难端到端地完成它，包括更改ml代码，并且我无法在一个地方找到所有指令。)</p><h2 id="0dea" class="ln jk hi bd jl lo lp lq jp lr ls lt jt kk lu lv jv ko lw lx jx ks ly lz jz ma bi translated">先决条件</h2><p id="aec0" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">您已经安装了Google Cloud SDK，并且凭证(最终用户或服务帐户)保存在一个位置，该位置作为<code class="du lj lk ll lm b">GOOGLE_APPLICATION_CREDENTIALS</code>添加到您的环境变量中。这个过程不在本文的讨论范围之内。</p><p id="8012" class="pw-post-body-paragraph kb kc hi kd b ke lb ij kg kh lc im kj kk le km kn ko lg kq kr ks li ku kv kw hb bi translated">让我用我的一个git repo来演示一下。</p><pre class="iy iz ja jb fd mb lm mc md aw me bi"><span id="2c12" class="ln jk hi lm b fi mf mg l mh mi">git clone <a class="ae mj" href="https://github.com/avinashknmr/predict-game-result.git" rel="noopener ugc nofollow" target="_blank">https://github.com/avinashknmr/predict-game-result.git</a><br/>cd predict-game-result</span></pre><p id="5d94" class="pw-post-body-paragraph kb kc hi kd b ke lb ij kg kh lc im kj kk le km kn ko lg kq kr ks li ku kv kw hb bi translated">文件夹结构如下</p><pre class="iy iz ja jb fd mb lm mc md aw me bi"><span id="a266" class="ln jk hi lm b fi mf mg l mh mi">predict-game-result<br/>├── Pipfile<br/>├── Pipfile.lock<br/>├── compare.py<br/>├── data<br/>│   ├── game_results.csv<br/>│   ├── player_details.csv<br/>│   ├── player_type.csv<br/>│   ├── prediction.csv<br/>│   ├── team_data.csv<br/>│   ├── upcoming_fixtures.csv<br/>├── download.py<br/>└── predict.py</span></pre><p id="ad3e" class="pw-post-body-paragraph kb kc hi kd b ke lb ij kg kh lc im kj kk le km kn ko lg kq kr ks li ku kv kw hb bi translated">接下来，我们将设置DVC并向其中添加文件。为此，首先，让我们使用您喜欢的安装程序安装<code class="du lj lk ll lm b">dvc</code>。我使用<code class="du lj lk ll lm b">pipenv</code>,但是这个命令对于<code class="du lj lk ll lm b">pip</code>也是一样的。对于macOS，你可以通过自制软件<code class="du lj lk ll lm b">brew install dvc</code>安装，但是如果你在虚拟环境中使用它，你的代码需要有<code class="du lj lk ll lm b">[gs]</code>，也需要安装在虚拟环境中。欲了解详细文档，请访问dvc.org<a class="ae mj" href="https://dvc.org/" rel="noopener ugc nofollow" target="_blank"/>。</p><pre class="iy iz ja jb fd mb lm mc md aw me bi"><span id="2270" class="ln jk hi lm b fi mf mg l mh mi">pipenv install "dvc[gs]"</span><span id="d28b" class="ln jk hi lm b fi mk mg l mh mi">pip install "dvc[gs]"</span></pre><p id="f66b" class="pw-post-body-paragraph kb kc hi kd b ke lb ij kg kh lc im kj kk le km kn ko lg kq kr ks li ku kv kw hb bi translated"><code class="du lj lk ll lm b">[gs]</code>需要使用Google云存储进行此演示。并且假设我们已经配置了<code class="du lj lk ll lm b">GOOGLE_APPLICATION_CREDENTIALS</code>。否则，该设置的后续部分将无法将数据推送到Google云存储中。</p><p id="6006" class="pw-post-body-paragraph kb kc hi kd b ke lb ij kg kh lc im kj kk le km kn ko lg kq kr ks li ku kv kw hb bi translated">开始<code class="du lj lk ll lm b">dvc</code>吧。许多<code class="du lj lk ll lm b">dvc</code>命令与<code class="du lj lk ll lm b">git</code>相似，因为它是在它的基础上构建的，除了一些变化。</p><pre class="iy iz ja jb fd mb lm mc md aw me bi"><span id="5624" class="ln jk hi lm b fi mf mg l mh mi">dvc init</span></pre><p id="c01c" class="pw-post-body-paragraph kb kc hi kd b ke lb ij kg kh lc im kj kk le km kn ko lg kq kr ks li ku kv kw hb bi translated">让我们将Google云存储作为默认远程存储添加到这个repo中。</p><pre class="iy iz ja jb fd mb lm mc md aw me bi"><span id="e740" class="ln jk hi lm b fi mf mg l mh mi"># dvc remote add -d remote_storage gs://&lt;bucket-name&gt;/&lt;folder-name&gt;<br/>dvc remote add -d remote_storage gs://ai-ml-dvc/predict-game-result</span></pre><p id="3018" class="pw-post-body-paragraph kb kc hi kd b ke lb ij kg kh lc im kj kk le km kn ko lg kq kr ks li ku kv kw hb bi translated">dvc配置文件看起来像这样<code class="du lj lk ll lm b">.dvc/config/</code></p><pre class="iy iz ja jb fd mb lm mc md aw me bi"><span id="9119" class="ln jk hi lm b fi mf mg l mh mi">[core]<br/>    analytics = false<br/>    remote = remote_storage<br/>['remote "remote_storage"']<br/>    url = gs://ai-ml-dvc/predict-game-result</span></pre><p id="a6f7" class="pw-post-body-paragraph kb kc hi kd b ke lb ij kg kh lc im kj kk le km kn ko lg kq kr ks li ku kv kw hb bi translated">接下来，让我们为数据版本控制添加所有数据文件</p><pre class="iy iz ja jb fd mb lm mc md aw me bi"><span id="2549" class="ln jk hi lm b fi mf mg l mh mi">dvc add data/*.csv</span></pre><p id="cd2b" class="pw-post-body-paragraph kb kc hi kd b ke lb ij kg kh lc im kj kk le km kn ko lg kq kr ks li ku kv kw hb bi translated">此时<code class="du lj lk ll lm b">.csv.dvc</code>被创建在<code class="du lj lk ll lm b">data</code>文件夹下，该文件夹跟踪数据版本。现在让我们看看一个<code class="du lj lk ll lm b">.csv.dvc</code>文件的内容。它包含一个链接到原始文件的<code class="du lj lk ll lm b">md5 hash</code>。稍后，当我们将数据推送到remote_storage时，文件将使用此哈希名称保存。当文件改变时，<code class="du lj lk ll lm b">md5 hash</code>改变，并通过<code class="du lj lk ll lm b">git</code>跟踪。</p><pre class="iy iz ja jb fd mb lm mc md aw me bi"><span id="81ab" class="ln jk hi lm b fi mf mg l mh mi">outs:<br/>- md5: 1df2045c428b6bbb05a4218328ee8bff<br/>  size: 225002<br/>  path: game_results.csv</span></pre><p id="727d" class="pw-post-body-paragraph kb kc hi kd b ke lb ij kg kh lc im kj kk le km kn ko lg kq kr ks li ku kv kw hb bi translated">让我们添加所有未分级的更改</p><pre class="iy iz ja jb fd mb lm mc md aw me bi"><span id="de1c" class="ln jk hi lm b fi mf mg l mh mi">git add .</span></pre><p id="c4df" class="pw-post-body-paragraph kb kc hi kd b ke lb ij kg kh lc im kj kk le km kn ko lg kq kr ks li ku kv kw hb bi translated">提交所有阶段性更改</p><pre class="iy iz ja jb fd mb lm mc md aw me bi"><span id="eee8" class="ln jk hi lm b fi mf mg l mh mi">git commit -m "first commit with dvc files"</span></pre><p id="11f2" class="pw-post-body-paragraph kb kc hi kd b ke lb ij kg kh lc im kj kk le km kn ko lg kq kr ks li ku kv kw hb bi translated">现在让我们将数据文件推送到谷歌云存储中，使用—</p><pre class="iy iz ja jb fd mb lm mc md aw me bi"><span id="f924" class="ln jk hi lm b fi mf mg l mh mi">dvc push</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ml"><img src="../Images/1ebdc8a8d40c7cf7b73a0a563f851e8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YMHFeFWftNLmzIUrev2szg.png"/></div></div></figure><p id="5f24" class="pw-post-body-paragraph kb kc hi kd b ke lb ij kg kh lc im kj kk le km kn ko lg kq kr ks li ku kv kw hb bi translated">接下来，我们将把更改推送到git存储库，以便跟踪和保存更改。</p><pre class="iy iz ja jb fd mb lm mc md aw me bi"><span id="3e63" class="ln jk hi lm b fi mf mg l mh mi">git push -u origin develop</span></pre><p id="c556" class="pw-post-body-paragraph kb kc hi kd b ke lb ij kg kh lc im kj kk le km kn ko lg kq kr ks li ku kv kw hb bi translated">现在让我们检查一下我们的云存储空间，您会发现每个文件都有一个文件夹，其中前2个字符是<code class="du lj lk ll lm b">md5 hash</code>，其余字符是文件夹中的文件名。下一次，当文件改变时，随着<code class="du lj lk ll lm b">md5 hash</code>的改变，创建不同的文件夹。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mm"><img src="../Images/19e4d62029294a6a278212397632da0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5vD8U4bhwSBEHzp-VqNRLw.png"/></div></div></figure><h1 id="dc75" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">如何在我们的ML代码中使用数据？</h1><p id="d031" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">只有<code class="du lj lk ll lm b">.csv.dvc</code>文件知道文件名，因此不删除这些文件非常重要，否则我们无法从云存储中获取文件。</p><p id="fbb4" class="pw-post-body-paragraph kb kc hi kd b ke lb ij kg kh lc im kj kk le km kn ko lg kq kr ks li ku kv kw hb bi translated">现在，在我们的脚本中，我们为各种操作导入了<code class="du lj lk ll lm b">dvc.api</code>,而<code class="du lj lk ll lm b">get_url</code>是获取被跟踪文件的链接的一个绝对基本的方法。</p><pre class="iy iz ja jb fd mb lm mc md aw me bi"><span id="81cd" class="ln jk hi lm b fi mf mg l mh mi">&gt;&gt;&gt; import dvc.api<br/>&gt;&gt;&gt; dvc.api.get_url('data/game_results.csv')<br/>'gs://ai-ml-dvc/predict-game-result/1d/f2045c428b6bbb05a4218328ee8bff'<br/>&gt;&gt;&gt; data_path = dvc.api.get_url('data/game_results.csv')</span></pre><p id="7545" class="pw-post-body-paragraph kb kc hi kd b ke lb ij kg kh lc im kj kk le km kn ko lg kq kr ks li ku kv kw hb bi translated">代码的其余部分保持不变，除非文件名改变，否则不需要改变代码。</p><pre class="iy iz ja jb fd mb lm mc md aw me bi"><span id="983f" class="ln jk hi lm b fi mf mg l mh mi">&gt;&gt;&gt; import pandas as pd<br/>&gt;&gt;&gt; df = pd.read_csv(data_path)<br/>&gt;&gt;&gt; df.shape<br/>(125, 37)</span></pre><p id="a5a0" class="pw-post-body-paragraph kb kc hi kd b ke lb ij kg kh lc im kj kk le km kn ko lg kq kr ks li ku kv kw hb bi translated">数据版本由<code class="du lj lk ll lm b">dvc</code>跟踪，而dvc配置文件和代码版本由<code class="du lj lk ll lm b">git</code>跟踪。</p><p id="be29" class="pw-post-body-paragraph kb kc hi kd b ke lb ij kg kh lc im kj kk le km kn ko lg kq kr ks li ku kv kw hb bi translated">这是跟踪数据变更的完美方式，包括模型对象和指标。此外，这将数据与代码分开，但仍会跟踪数据变化，这是机器学习项目的先决条件。</p><h1 id="beed" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">结论</h1><p id="85b8" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated"><code class="du lj lk ll lm b">dvc</code>与<code class="du lj lk ll lm b">git</code>一起工作，是使用CI/CD工具进行持续机器学习的核心组件，也是MLOps流程中第一步也是最重要的一步。<code class="du lj lk ll lm b">git</code>对代码做了什么，<code class="du lj lk ll lm b">dvc</code>对数据做了什么——跟踪和维护变更，并在需要时检索版本。此外，这两个工具保持了代码的整洁，将代码与数据分离开来(数据通常很大，存在安全问题),我们可以更好地控制整个过程。我们已经考虑过建立一个这样的存储(云存储)，但是如果在小项目上工作，我们可以使用AWS、Azure、SSH、HTTP甚至Google Drive。</p></div></div>    
</body>
</html>