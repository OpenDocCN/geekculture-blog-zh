<html>
<head>
<title>Deploying InfluxDB 2.0 Using Docker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Docker部署InfluxDB 2.0</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/deploying-influxdb-2-0-using-docker-6334ced65b6c?source=collection_archive---------0-----------------------#2021-08-01">https://medium.com/geekculture/deploying-influxdb-2-0-using-docker-6334ced65b6c?source=collection_archive---------0-----------------------#2021-08-01</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/396c654cade7f30a5ab368200853615d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*L4rlJyor6EKcqgcX.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">InfluxDB 2.0, the image belongs to InfluxData.</figcaption></figure><p id="5f44" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">InfluxDB 2.0一般都有。这个版本的InfluxDB提供了时间序列数据库和一组工具，可以使用查询构建器或手动编写Flux查询来创建漂亮的仪表板。您还可以计划任务，并在测量值超过特定阈值时配置警报。</p><p id="db08" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">几个月前，我总是将InfluxDB与Grafana或Chronograf一起部署以实现可视化。现在，我只需要在我开发的应用程序旁边部署InfluxDB 2.0映像。</p><p id="199f" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我们开始吧！</p><p id="3077" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">首先，InfluxData提供了使用docker部署InfluxDB 2.0的全面指南。所以，我不打算详细描述一切。相反，我将描述如何使用bash脚本来自动化配置或设置过程。</p><p id="e6a6" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">您需要使用以下命令从docker hub中提取映像:</p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="e19c" class="kb kc hi jx b fi kd ke l kf kg">docker pull influxdb:2.0.7</span></pre><p id="16f7" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">如果您想要定制配置，您将需要创建config.yml文件，并将其作为一个卷挂载到docker容器</p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="1e67" class="kb kc hi jx b fi kd ke l kf kg">docker run --rm influxdb:2.0.7 influxd print-config &gt; config.yml</span></pre><p id="1135" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">将在您的工作目录中创建一个config.yml文件。</p><p id="f303" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">现在，如果希望在主机上持久化数据库，可以创建一个目录，并将其挂载到容器上的/var/lib/influxd 2。</p><p id="6916" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">因此，让我们创建容器</p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="03fc" class="kb kc hi jx b fi kd ke l kf kg">docker run --name influxdb -d \<br/>-p 8086:8086 \<br/>--volume `pwd`/influxdb2:/var/lib/influxdb2 \<br/>--volume `pwd`/config.yml:/etc/influxdb2/config.yml \<br/>influxdb:2.0.7</span></pre><p id="be51" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">上面的命令将创建一个名为<code class="du kh ki kj jx b">influxdb</code>的容器，并在工作目录中挂载config.yml文件和influxdb2目录。它还将您的主机的8086端口绑定到容器的8086端口，假设您的主机上没有运行和使用该端口的任何软件。</p><p id="ff44" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">请记住，我们的目标是创建一个能够自动化配置过程的bash脚本。但是我们将手动完成每个过程。</p><p id="7210" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">接下来，我们将设置一个帐户，我们可以使用它来访问仪表板、写入和查询数据库中的数据。为此，我们需要使用<code class="du kh ki kj jx b">influx</code>命令行界面工具的<code class="du kh ki kj jx b">setup</code>命令。</p><p id="cbcb" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">您可以在这里看到该命令<a class="ae kk" href="https://docs.influxdata.com/influxdb/v2.0/reference/cli/influx/setup/#flags" rel="noopener ugc nofollow" target="_blank">的完整标志。但是我们将使用一些标志，如以下命令所示:</a></p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="ddad" class="kb kc hi jx b fi kd ke l kf kg">docker exec influxdb influx setup \<br/>  --bucket BUCKET_NAME \<br/>  --org ORG_NAME \<br/>  --password PASSWORD \<br/>  --username USERNAME \<br/>  --force</span></pre><p id="2bd3" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">一个桶是一组测量值。您可以将bucket看作关系数据库中的数据库，将measurements看作表。您需要提供铲斗的名称并替换<code class="du kh ki kj jx b">BUCKET_NAME</code>。</p><p id="a51d" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">接下来，你必须输入你的组织的名称，并替换掉<code class="du kh ki kj jx b">ORG_NAME</code>。</p><p id="48ba" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">然后，您需要提供组织所有者的用户名和密码。此用户名和密码将用作您登录仪表板的密码。</p><p id="a41f" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">如果您打算探索InfluxDB 2.0的特性，而不编写任何软件来写入或查询数据库中的数据，那么您就完成了。您可以访问http://localhost:8086，登录，然后探索这些功能。</p><p id="36da" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">但是，如果您已经有了一个可以写和/或查询数据的应用程序，并且您需要以编程方式获得访问令牌，那么您可以继续读取。</p><p id="1107" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我提到的令牌用于对将要写入和/或查询数据的客户端进行身份验证和授权。它在控制面板上可用，但我们不会为此目的而打开控制面板。</p><p id="5220" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">您可以使用以下命令使用<code class="du kh ki kj jx b">influx</code> CLI检索令牌:</p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="e9ab" class="kb kc hi jx b fi kd ke l kf kg">docker exec influxdb influx auth list</span></pre><p id="09f3" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">该命令将产生以下输出:</p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="e4a6" class="kb kc hi jx b fi kd ke l kf kg">ID   Description Token            User Name User ID   Permissions</span><span id="1f82" class="kb kc hi jx b fi kl ke l kf kg">07ec335d5c118000 admin's Token TOKEN_REDACTED admin  07ec335d32118000 [read:authorizations write:authorizations read:buckets write:buckets read:dashboards write:dashboards read:orgs write:orgs read:sources write:sources read:tasks write:tasks read:telegrafs write:telegrafs read:users write:users read:variables write:variables read:scrapers write:scrapers read:secrets write:secrets read:labels write:labels read:views write:views read:documents write:documents read:notificationRules write:notificationRules read:notificationEndpoints write:notificationEndpoints read:checks write:checks read:dbrp write:dbrp]</span></pre><p id="d997" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">如您所见，输出中包含大量信息。例如，我们有一个用户名为<code class="du kh ki kj jx b">admin</code>的账户。该帐户被指定为组织的所有者，这就是为什么有许多权限被分配给该帐户的原因。</p><p id="0789" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">但是，我们是来拿令牌的，对吧？是的，您可以从输出中看到令牌。但是你可能需要缩小你的视野来寻找令牌。</p><p id="9b31" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">您可能已经注意到输出的格式类似于表格。如果我们通过使用<code class="du kh ki kj jx b">awk</code>将输出中的每一行用空格分割成一个类似数组的类型，那么这个令牌被存储为第4个条目。但这并不总是对的。</p><p id="5284" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">令牌的索引取决于描述的内容。默认情况下，令牌的描述遵循以下格式:</p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="38dd" class="kb kc hi jx b fi kd ke l kf kg">USERNAME's Token</span></pre><p id="6e7c" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这种情况下是<code class="du kh ki kj jx b">admin’s Token</code>。如果我们尝试将阵列可视化，它看起来会是这样:</p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="c6c9" class="kb kc hi jx b fi kd ke l kf kg">["07ec335d5c118000", "admin's", "Token", "REDACTED_TOKEN", "admin", ...]</span></pre><p id="9b78" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">你可以用<code class="du kh ki kj jx b">awk</code>来确认这一点</p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="bbf5" class="kb kc hi jx b fi kd ke l kf kg">docker exec influxdb influx auth list | awk '/admin/ {print $4 " "}'</span></pre><p id="058b" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">上面的命令将在一行包含<code class="du kh ki kj jx b">admin</code>的文本中打印令牌。我们现在有令牌了。</p><p id="115d" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">完事了吗？不，还没有。</p><p id="d81b" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">至此，我们已经完成了所有需要做的事情(不包括将所有命令放入一个bash脚本文件中)。但是我想通过问这个问题来强调最后一点:如果用户名不是<code class="du kh ki kj jx b">admin</code>呢？</p><p id="4817" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">当然，你可以用别的东西来改变命令行中的<code class="du kh ki kj jx b">admin</code>。但是一旦一切都在bash脚本文件中，您将需要为不同的用户更改文件。你不会想这么做的，相信我。</p><p id="b4eb" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">不必惊慌，有一个简单的方法。</p><p id="d673" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">您可以使用一个环境变量来提供用户名，并将其分配给<code class="du kh ki kj jx b">awk</code>变量，并将其用作匹配<code class="du kh ki kj jx b">influx auth list</code>输出中的行的模式。</p><p id="2852" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">例如，我们将使用<code class="du kh ki kj jx b">INFLUXDB_USERNAME</code>环境变量来存储用户名，并将值传递给<code class="du kh ki kj jx b">awk</code>中的<code class="du kh ki kj jx b">username</code>变量。</p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="2698" class="kb kc hi jx b fi kd ke l kf kg">export INFLUXDB_USERNAME=otheruser<br/>docker exec influxdb influx auth list | awk -v username=$INFLUXDB_USERNAME '$5 ~ username {print $4 " "}'</span></pre><p id="13cb" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">请注意，我们针对数组中的第5个元素测试了<code class="du kh ki kj jx b">username</code>变量，该数组包含influx CLI输出中列出的用户名，如下所示:</p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="974b" class="kb kc hi jx b fi kd ke l kf kg">$5 ~ username</span></pre><p id="90f7" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">所以，现在你不需要每次使用不同的用户名时都改变命令行。你只需要改变环境变量<code class="du kh ki kj jx b">INFLUXDB_USERNAME</code>的值。</p><p id="f457" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">让我们把所有东西都放到一个bash脚本文件中。</p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="2eb1" class="kb kc hi jx b fi kd ke l kf kg">#!/bin/bash</span><span id="115b" class="kb kc hi jx b fi kl ke l kf kg"># create config file</span><span id="53ac" class="kb kc hi jx b fi kl ke l kf kg">docker run --rm influxdb:2.0.7 influxd print-config &gt; config.yml</span><span id="17a9" class="kb kc hi jx b fi kl ke l kf kg"># create the container</span><span id="98f1" class="kb kc hi jx b fi kl ke l kf kg">docker run --name influxdb -d \<br/>  -p 8086:8086 \<br/>  --volume `pwd`/influxdb2:/var/lib/influxdb2 \<br/>  --volume `pwd`/config.yml:/etc/influxdb2/config.yml \<br/>  influxdb:2.0.7</span><span id="62b5" class="kb kc hi jx b fi kl ke l kf kg"># configure influxdb</span><span id="3619" class="kb kc hi jx b fi kl ke l kf kg">docker exec influxdb influx setup \<br/>  --bucket $INFLUXDB_BUCKET \<br/>  --org $INFLUXDB_ORG \<br/>  --password $INFLUXDB_PASSWORD \<br/>  --username $INFLUXDB_USERNAME \<br/>  --force</span><span id="6453" class="kb kc hi jx b fi kl ke l kf kg"># get the token</span><span id="857e" class="kb kc hi jx b fi kl ke l kf kg">docker exec influxdb influx auth list | \<br/>awk -v username=$INFLUXDB_USERNAME '$5 ~ username {print $4 " "}'</span></pre><p id="e88c" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">注意，我们使用环境变量为<code class="du kh ki kj jx b">influx setup</code>命令提供信息。</p><p id="c4b6" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我们完了！但是我想我们可能漏掉了一些东西。<br/>如果我们运行setup命令时数据库服务器没有准备好怎么办？</p><p id="3a56" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我们如何处理这种情况？</p><p id="a9df" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">放松，我们可以使用<code class="du kh ki kj jx b">influx ping</code>命令来检查服务器状态。</p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="f12c" class="kb kc hi jx b fi kd ke l kf kg">until docker exec influxdb influx ping<br/>do<br/>  echo "Retrying..."<br/>  sleep 5<br/>done</span></pre><p id="9723" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">如果服务器尚未准备好或遇到致命错误，<code class="du kh ki kj jx b">docker exec influxdb influx ping</code>命令将失败，而<code class="du kh ki kj jx b">until</code>块中的命令将被执行。这样，我们可以尝试等待五秒钟再重试。</p><p id="fbf7" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">让我们把所有的东西放在一起</p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="5b93" class="kb kc hi jx b fi kd ke l kf kg">#!/bin/bash</span><span id="92ac" class="kb kc hi jx b fi kl ke l kf kg"># create config file</span><span id="e472" class="kb kc hi jx b fi kl ke l kf kg">docker run --rm influxdb:2.0.7 influxd print-config &gt; config.yml</span><span id="a057" class="kb kc hi jx b fi kl ke l kf kg"># create the container</span><span id="87e4" class="kb kc hi jx b fi kl ke l kf kg">docker run --name influxdb -d \<br/>  -p 8086:8086 \<br/>  --volume `pwd`/influxdb2:/var/lib/influxdb2 \<br/>  --volume `pwd`/config.yml:/etc/influxdb2/config.yml \<br/>  influxdb:2.0.7</span><span id="0e5d" class="kb kc hi jx b fi kl ke l kf kg"># wait until the database server is ready</span><span id="bd15" class="kb kc hi jx b fi kl ke l kf kg">until docker exec influxdb influx ping<br/>do<br/>  echo "Retrying..."<br/>  sleep 5<br/>done</span><span id="a8c0" class="kb kc hi jx b fi kl ke l kf kg"># configure influxdb</span><span id="b399" class="kb kc hi jx b fi kl ke l kf kg">docker exec influxdb influx setup \<br/>  --bucket $INFLUXDB_BUCKET \<br/>  --org $INFLUXDB_ORG \<br/>  --password $INFLUXDB_PASSWORD \<br/>  --username $INFLUXDB_USERNAME \<br/>  --force</span><span id="6fc9" class="kb kc hi jx b fi kl ke l kf kg"># get the token</span><span id="6326" class="kb kc hi jx b fi kl ke l kf kg">docker exec influxdb influx auth list | \<br/>awk -v username=$INFLUXDB_USERNAME '$5 ~ username {print $4 " "}'</span></pre><p id="8e81" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我们终于完成了！</p><p id="d5c1" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">感谢您的阅读！保持安全和健康！</p></div><div class="ab cl km kn gp ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="hb hc hd he hf"><h2 id="7adb" class="kb kc hi bd kt ku kv kw kx ky kz la lb jf lc ld le jj lf lg lh jn li lj lk ll bi translated">2022年1月24日更新</h2><p id="3844" class="pw-post-body-paragraph iu iv hi iw b ix lm iz ja jb ln jd je jf lo jh ji jj lp jl jm jn lq jp jq jr hb bi translated">根据<a class="lr ls ge" href="https://medium.com/u/a87942f89d4c?source=post_page-----6334ced65b6c--------------------------------" rel="noopener" target="_blank"> Ruslan Valiyev </a>指出的问题，为<code class="du kh ki kj jx b">docker run</code>命令添加了缺失的<code class="du kh ki kj jx b">-d</code>标志。</p></div></div>    
</body>
</html>