<html>
<head>
<title>CloudFormation Example For CodeBuild With A Webhook</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Webhook构建代码的CloudFormation示例</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/cloudformation-example-for-codebuild-with-a-webhook-b442b827e92f?source=collection_archive---------54-----------------------#2021-06-17">https://medium.com/geekculture/cloudformation-example-for-codebuild-with-a-webhook-b442b827e92f?source=collection_archive---------54-----------------------#2021-06-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="2898" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2021年6月17日</p><p id="16a5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">作者托马斯</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/cb1fe3e7304e1339dcaafcb08cd8563c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7BXb0oFeIN4W4cfRlg6d2w.jpeg"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Photo by <a class="ae jt" href="https://unsplash.com/@gigalilac?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Grace To</a> on <a class="ae jt" href="https://unsplash.com/s/photos/hook?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="e9c3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在不久前构建一个小项目时，我最终想只使用CodeBuild来实现我的CI/CD。我以前使用CodePipeline创建过管道，可以自动从给定的GitHub存储库中提取最新的更改并对其进行操作。我知道可以基于webhooks配置CodeBuild来做类似的事情，但我从未实现过它。设置并不太难，但我确实遇到了一个小问题，我想在这篇文章中强调并解释一下。</p><p id="e7da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下段落有一些关于AWS帐户设置的重要信息，所以请不要跳到模板的底部。</p><p id="3a8e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">CodeBuild实例和模板没有什么特别的。IAM角色告诉CodeBuild我能做什么，然后CodeBuild项目本身被定义。吸引我的一件事是配置<a class="ae jt" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-codebuild-sourcecredential.html" rel="noopener ugc nofollow" target="_blank">源凭证</a>。</p><p id="dc35" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我最初实现它时，我在与我的CodeBuild项目相同的模板中定义了源凭证。每当我想启动另一个实例时(比方说，一个新的环境)，我都会在一个我知道有效的模板上遇到错误。事实证明，每个AWS帐户的每个提供者的源凭证必须是唯一的。这意味着每个<code class="du ju jv jw jx b">ServerType</code>应该只使用一次<code class="du ju jv jw jx b">AWS::CodeBuild::SourceCredential</code>资源类型。不幸的是，我花了将近一个小时四处寻找，试图解决这个问题。阻碍我的错误大概是这样的</p><pre class="je jf jg jh fd jy jx jz ka aw kb bi"><span id="8e78" class="kc kd hi jx b fi ke kf l kg kh">Failed to call ImportSourceCredentials, reason: Access token with server type GITHUB already exists. Delete its source credential and try again.</span></pre><p id="edbb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果将来有人偶然发现这个问题，要知道，AWS有不好的错误消息不是你的错。</p><p id="1482" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我想首先给出一个如何创建源凭证的模板，然后给出CodeBuild项目本身的模板。这些模板也可以在我的<a class="ae jt" href="https://github.com/thomasstep/aws-cloudformation-reference/tree/0d6d79f9db33e8ff3f07c9588a822ddff5ad5109/cicd/codebuild" rel="noopener ugc nofollow" target="_blank"> AWS CloudFormation参考GitHub资源库</a>中找到，还有一些其他有用的模板。</p><p id="97cc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先是源凭证的创建。请记住，每个客户只需记住一次。我目前设置了<code class="du ju jv jw jx b">Parameters</code>，假设存在一个名为<code class="du ju jv jw jx b">codebuild-github-token</code>的SSM参数。您可以随意更改名称，但是我不建议将个人访问令牌直接复制和粘贴到CloudFormation参数中。</p><pre class="je jf jg jh fd jy jx jz ka aw kb bi"><span id="f5ca" class="kc kd hi jx b fi ke kf l kg kh">Parameters:<br/>  GitHubAccessToken:<br/>    Type: AWS::SSM::Parameter::Value&lt;String&gt;<br/>    Description: Name of parameter with GitHub access token<br/>    Default: codebuild-github-token<br/>    NoEcho: True<br/><br/>Resources:<br/>  CodeBuildCredentials:<br/>    Type: AWS::CodeBuild::SourceCredential<br/>    Properties:<br/>      ServerType: GITHUB<br/>      AuthType: PERSONAL_ACCESS_TOKEN<br/>      Token: !Ref GitHubAccessToken</span></pre><p id="20e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建源凭据后，我们可以创建CodeBuild项目。</p><pre class="je jf jg jh fd jy jx jz ka aw kb bi"><span id="0e3b" class="kc kd hi jx b fi ke kf l kg kh">Parameters:<br/>  GitHubUrl:<br/>    Type: String<br/>    Description: URL for GitHub repo i.e. https://github.com/username/repository<br/><br/>Resources:<br/>  CodeBuildRole:<br/>    Type: AWS::IAM::Role<br/>    Properties:<br/>      AssumeRolePolicyDocument:<br/>        Version: 2012-10-17<br/>        Statement:<br/>            - Effect: Allow<br/>              Principal:<br/>                  Service:<br/>                    - codebuild.amazonaws.com<br/>              Action:<br/>                - sts:AssumeRole<br/>      Description: !Sub "IAM Role for ${AWS::StackName}"<br/>      Path: '/'<br/>      Policies:<br/>        - PolicyName: root<br/>          PolicyDocument:<br/>            Version: '2012-10-17'<br/>            Statement:<br/>              - Effect: Allow<br/>                Action:<br/>                  - cloudformation:*<br/>                  - codebuild:*<br/>                  - logs:*<br/>                Resource: '*'<br/>  CodeBuild:<br/>    Type: AWS::CodeBuild::Project<br/>    Properties:<br/>      Description: CodeBuild with GitHub webhook<br/>      Triggers:<br/>        BuildType: BUILD<br/>        Webhook: True<br/>        FilterGroups:<br/>        - - Type: EVENT<br/>            Pattern: PUSH,PULL_REQUEST_MERGED<br/>          - Type: HEAD_REF<br/>            Pattern: ^refs/heads/main$<br/>            ExcludeMatchedPattern: false<br/>      ServiceRole: !GetAtt CodeBuildRole.Arn<br/>      Artifacts:<br/>        Type: NO_ARTIFACTS<br/>      Environment:<br/>        Type: LINUX_CONTAINER<br/>        ComputeType: BUILD_GENERAL1_SMALL<br/>        Image: aws/codebuild/standard:4.0<br/>        EnvironmentVariables:<br/>          - Name: MY_ENV_VAR<br/>            Value: something<br/>            Type: PLAINTEXT<br/>      Source:<br/>        Type: GITHUB<br/>        Location: !Ref GitHubUrl<br/>      TimeoutInMinutes: 10<br/>  CodeBuildLogGroup:<br/>    Type: AWS::Logs::LogGroup<br/>    Properties:<br/>      LogGroupName: !Sub "/aws/codebuild/${CodeBuild}"<br/>      RetentionInDays: 7<br/><br/>Outputs:<br/>  ProjectName:<br/>    Value: !Ref CodeBuild<br/>    Description: CodeBuild project name</span></pre><p id="338c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">关于这个模板，有一些重要的事情需要注意。首先，IAM角色需要调整，以允许CodeBuild执行特定于您的项目的操作。第二，<code class="du ju jv jw jx b">FilterGroups</code>目前被设置为仅触发合并，并直接推送到一个名为<code class="du ju jv jw jx b">main</code>的分支，这可能需要根据您的需求进行更改。最后，CodeBuild实例需要一个名为<code class="du ju jv jw jx b">buildspec.yml</code>的文件出现在repo的根目录中。如果你不知道什么是<code class="du ju jv jw jx b">buildspec</code>，请阅读<a class="ae jt" href="https://docs.aws.amazon.com/codebuild/latest/userguide/build-spec-ref.html" rel="noopener ugc nofollow" target="_blank">这份文档</a>(它几乎只是一个当代码构建被触发时运行的bash脚本)。</p></div><div class="ab cl ki kj gp kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="hb hc hd he hf"><p id="1962" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kp">原载于2021年6月17日https://thomasstep.com</em><em class="kp"/><a class="ae jt" href="https://thomasstep.com/blog/cloudformation-example-for-codebuild-with-a-webhook" rel="noopener ugc nofollow" target="_blank"><em class="kp">。</em></a></p></div></div>    
</body>
</html>