<html>
<head>
<title>API Monitoring Dashboard using Graylog.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Graylog的API监控仪表板。</h1>
<blockquote>原文：<a href="https://medium.com/geekculture/api-monitoring-dashboard-using-graylog-804bce3d4983?source=collection_archive---------15-----------------------#2021-08-05">https://medium.com/geekculture/api-monitoring-dashboard-using-graylog-804bce3d4983?source=collection_archive---------15-----------------------#2021-08-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/f3e0b9bfd7c77d51d3c640c4e4724670.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3VaBf5HfLXcR1nTQsqCTKQ.jpeg"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">API Monitoring Dashboard using Graylog.</figcaption></figure><div class=""/><p id="3e33" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">API是一种微服务语言。他们本质上是其他团队可以访问的唯一元素。API响应时间和API的一致性是每个团队定义的两个主要SLA。API监控是微服务监控必不可少的一部分。API监控有不同的形式，如API监控频率、API响应时间、API调用模式、API成功率等。所有这些都是需要监控的基本属性。监控这些属性并对其中发现的问题采取行动是保持微服务健康的唯一方法。</p><p id="d63f" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我们在过去也遇到过问题，特别是一个客户端(上下文)面临延迟问题，我们花了相当多的时间来识别有延迟问题的API。为了识别存在延迟问题的API，我们必须深入研究审计日志。通过这次事件，我们发现我们的API监控还有改进的空间。</p><p id="1dc2" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">因此，我们决定构建一个仪表板，在这里我们可以在粒度级别上跟踪API的性能。我们已经确定了一些可以改进监测的领域。以下是我们希望在新的控制面板中监控的属性。</p><ul class=""><li id="b00e" class="js jt hx iw b ix iy jb jc jf ju jj jv jn jw jr jx jy jz ka bi translated"><strong class="iw hy"> API级延迟</strong></li><li id="62b3" class="js jt hx iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated"><strong class="iw hy">上下文级延迟</strong></li><li id="200c" class="js jt hx iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated"><strong class="iw hy">上下文相关API使用量</strong></li><li id="783c" class="js jt hx iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated"><strong class="iw hy"> API明智用法</strong></li><li id="8406" class="js jt hx iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated"><strong class="iw hy">实践智慧API延迟</strong></li><li id="9e43" class="js jt hx iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated"><strong class="iw hy">用户智能API延迟</strong></li><li id="4796" class="js jt hx iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated"><strong class="iw hy"> API错误洞察。</strong></li><li id="b90f" class="js jt hx iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated"><strong class="iw hy">服务平均延迟</strong></li><li id="6eed" class="js jt hx iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated"><strong class="iw hy">服务响应时间百分比</strong></li><li id="dcb4" class="js jt hx iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated"><strong class="iw hy">服务提供的API请求总数。</strong></li></ul><p id="2b53" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我们用来创建新仪表板的内容。</p><ul class=""><li id="1202" class="js jt hx iw b ix iy jb jc jf ju jj jv jn jw jr jx jy jz ka bi translated">灰色日志</li><li id="9f4e" class="js jt hx iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated"><strong class="iw hy">格拉夫纳</strong></li><li id="b956" class="js jt hx iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated"><strong class="iw hy">弹性搜索</strong></li></ul><h1 id="5aa7" class="kg kh hx bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated"><strong class="ak">灰色日志</strong></h1><p id="c60f" class="pw-post-body-paragraph iu iv hx iw b ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn li jp jq jr hb bi translated">我们使用Graylog作为我们服务的日志聚合器。虽然我们的服务服务于任何API请求，但它拥有创建新仪表板所需的所有细节。为了监控我们的服务以达到上述目的，我们需要一些正在被服务的请求的细节。下面是我们监控API性能所需的关键信息</p><ul class=""><li id="027c" class="js jt hx iw b ix iy jb jc jf ju jj jv jn jw jr jx jy jz ka bi translated"><strong class="iw hy"> API正在被调用</strong></li><li id="970f" class="js jt hx iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated"><strong class="iw hy">请求的练习id</strong></li><li id="cd3e" class="js jt hx iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated"><strong class="iw hy">请求的用户</strong></li><li id="b8e6" class="js jt hx iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated"><strong class="iw hy">以毫秒为单位的请求响应时间</strong></li><li id="4874" class="js jt hx iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated"><strong class="iw hy"> Http状态码</strong></li></ul><p id="df4f" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我们只在服务中添加了一个简单的日志行来记录这些细节。这个简单的日志行如下所示。</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="66a7" class="ls kh hx lo b fi lt lu l lv lw">LOGGER.error(“REQUEST_DETAILS {0} {1} {2} {3} {4} {5}”, statusCode , userDetails.getString(“username”),<br/> request.getHeader(PRACTICE_ID), request.response().headers().get(“x-response-time”), request.path());</span></pre><p id="b207" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">该日志行将导致下面的简单日志。</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="3b21" class="ls kh hx lo b fi lt lu l lv lw">2021-08-03 12:11:36 SEVERE com.companydomain.mw.integration.verticle.ResponseHeaderHandler REQUEST_DETAILS 200 nchinchore 432 81 /v2/TextMacros</span></pre><p id="07e2" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">有了这个日志行，我们就有了我们想要记录的所有细节来生成一个新的仪表板，但是所有这些细节都是消息字段的一部分。但是要查询API请求的每个属性，我们需要将这些属性作为单独的字段添加到弹性搜索中。</p><p id="6a87" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">因此，为了从日志消息中提取字段，我们使用了一个Graylog <a class="ae lx" href="https://docs.graylog.org/en/4.0/pages/extractors.html" rel="noopener ugc nofollow" target="_blank">提取器</a>。我们使用grok extractor从消息字符串中提取字段。Grok extractor使用Grok语言从字符串中提取数据。到Grok提取器文档的链接是这里的<a class="ae lx" href="https://docs.graylog.org/en/4.0/pages/extractors.html#using-grok-patterns-to-extract-data" rel="noopener ugc nofollow" target="_blank"/>。我们提取了像上下文id、HTTP状态、请求的响应时间、Api URI、用户名这样的字段。我们已经编写了下面的Grok模式来从消息字段中提取细节。</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="0616" class="ls kh hx lo b fi lt lu l lv lw">Condition Will only attempt to run if the message includes the string REQUEST_DETAILS Configuration grok_pattern: %{TIMESTAMP_ISO8601:time}%{SPACE}%{USERNAME:logLevel}%{SPACE}%{USERNAME:class}%{SPACE}%{USERNAME:logType}%{SPACE}%{NUMBER:httpstatus}%{SPACE}%{SPACE}%{USERNAME:username}%{SPACE}%{NUMBER:practiceid}%{SPACE}%{NUMBER:responseTime}%{SPACE}%{URIPATHPARAM:uri} named_captures_only:</span></pre><ul class=""><li id="4eaf" class="js jt hx iw b ix iy jb jc jf ju jj jv jn jw jr jx jy jz ka bi translated">从语义上讲，用grok模式提取任何字段后，这些字段将被存储为字符串，但是字符串字段不能应用平均和百分比度量。</li><li id="f18a" class="js jt hx iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">因此，为了将<strong class="iw hy">response time</strong>和p<strong class="iw hy">racce id</strong>从字符串数据类型转换为数字数据类型，我们添加了两个<strong class="iw hy">复制输入</strong>提取器。</li><li id="0360" class="js jt hx iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">在应用了所有3个提取器后，我们的日志线看起来会像下面的灰色日志。</li></ul><figure class="lj lk ll lm fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ly"><img src="../Images/cc1451304e3481925df049793939ca0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NUQ274N63S1o6Uby7XnyQg.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">Extracted log details with grok pattern</figcaption></figure><h1 id="13d7" class="kg kh hx bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated"><strong class="ak">格拉夫纳</strong></h1><p id="b9d0" class="pw-post-body-paragraph iu iv hx iw b ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn li jp jq jr hb bi translated">提取所有这些字段后，我们使用Grafana进行可视化和弹性搜索，作为Grafana的数据源。在所有这些变化之后，我们能够构建非常好的仪表板，在那里我们可以在粒度级别跟踪我们的API的性能，如上所述。</p><p id="6cb0" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">下面是我们新仪表板的一些屏幕截图。<strong class="iw hy">请注意，响应时间以毫秒为单位。</strong></p><p id="72c8" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">下面是一些新Grafana仪表板的屏幕截图。</p><div class="lj lk ll lm fd ab cb"><figure class="lz hk ma mb mc md me paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><img src="../Images/236ddaa5c6d22070898766dfb4335d76.png" data-original-src="https://miro.medium.com/v2/resize:fit:598/format:webp/1*oBLllyB4Q6N05qamymF7qQ.png"/></div></figure><figure class="lz hk mf mb mc md me paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><img src="../Images/64ebad90a4bb3654195dad6aa5c21fd4.png" data-original-src="https://miro.medium.com/v2/resize:fit:802/format:webp/1*FbSKriqc5-SSYJ38HmFVEg.png"/></div></figure><figure class="lz hk mg mb mc md me paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><img src="../Images/529acf5e6ce0cc2de43c0eae40416589.png" data-original-src="https://miro.medium.com/v2/resize:fit:604/format:webp/1*AzDWWrU8BvWdB1zrveM1Yw.png"/></div></figure></div><div class="ab cb"><figure class="lz hk mh mb mc md me paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><img src="../Images/3cc6ad09ea7adb718a7b0a630af049a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:662/format:webp/1*0JlEJ6ms6Ux48zVHf4o1Sw.png"/></div></figure><figure class="lz hk mi mb mc md me paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><img src="../Images/612dc8f04757fe0206847e409e3622b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:666/format:webp/1*jvh9NOd-jsgBPiGiS5guiw.png"/></div></figure><figure class="lz hk mj mb mc md me paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><img src="../Images/93e301f4c5d97cbe68c9750b95908213.png" data-original-src="https://miro.medium.com/v2/resize:fit:674/format:webp/1*WtGhNnE9jPTk5DYp0P_DOQ.png"/></div><figcaption class="hr hs et er es ht hu bd b be z dx mk di ml mm">Grafana DashBoard Images</figcaption></figure></div><h2 id="c74c" class="ls kh hx bd ki mn mo mp km mq mr ms kq jf mt mu ku jj mv mw ky jn mx my lc mz bi translated">如何为您的服务创建仪表板</h2><p id="3e9a" class="pw-post-body-paragraph iu iv hx iw b ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn li jp jq jr hb bi translated">您还可以使用Graylog、Grafana和Elastic search为您服务构建类似的仪表板。按照以下步骤构建仪表板。</p><ul class=""><li id="6132" class="js jt hx iw b ix iy jb jc jf ju jj jv jn jw jr jx jy jz ka bi translated"><strong class="iw hy">代码变更</strong></li></ul><p id="5700" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在您的服务代码中添加日志，其中包含您希望在<a class="ae lx" href="http://Graylog.eg" rel="noopener ugc nofollow" target="_blank"> Graylog.eg </a>中包含的所有详细信息:在我们的示例中，我们添加了logger . error(" REQUEST _ DETAILS { 0 } { 1 } { 2 } { 3 } { 4 } { 5 } "、statusCode、user DETAILS . getstring(" username ")、request.getHeader(PRACTICE_ID)、request.response()。标题()。get("x-response-time ")，request . path())；</p><ul class=""><li id="b47f" class="js jt hx iw b ix iy jb jc jf ju jj jv jn jw jr jx jy jz ka bi translated"><strong class="iw hy">灰色日志变化</strong></li></ul><p id="3fcc" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">1.在消息字段上创建grok提取器，以提取响应时间和您想要查询的其他字段。在我们的例子中，我们提取了实践id、响应时间、用户名、请求路径、Http状态代码，以便我们可以查询每个字段。</p><p id="8a61" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hy"> 2。创建grok模式的步骤</strong></p><ul class=""><li id="e553" class="js jt hx iw b ix iy jb jc jf ju jj jv jn jw jr jx jy jz ka bi translated">登录灰色日志</li><li id="249c" class="js jt hx iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">导航到系统/输入→输入→您的日志输入(我们的日志输入是默认的GELF输入)→管理提取器→添加提取器→开始→加载带有消息id和灰色日志索引的消息</li></ul><figure class="lj lk ll lm fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ly"><img src="../Images/565568f7f3c5c3ecd8af35c8084caf76.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FnaYjyZ4nsUX4phXgy5Yng.png"/></div></div></figure><ul class=""><li id="e476" class="js jt hx iw b ix iy jb jc jf ju jj jv jn jw jr jx jy jz ka bi translated">然后创建一个grok模式并测试它，看看是否提取了所需的字段</li><li id="90b6" class="js jt hx iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">然后创建一个grok模式并测试它，看看是否提取了所需的字段</li></ul><figure class="lj lk ll lm fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ly"><img src="../Images/898478294673c87138fc18215b811843.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-UG3VVHpm23QnI6bjdHoHw.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">Try Extracting fields with grok pattern</figcaption></figure><figure class="lj lk ll lm fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ly"><img src="../Images/12d48b98b278d3bfe1fd318a853b16e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V9gT0aPOFnPZvz72KzJX9Q.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">Log fields will get extracted</figcaption></figure><h1 id="2727" class="kg kh hx bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">格拉夫纳变化</h1><ul class=""><li id="e91a" class="js jt hx iw b ix le jb lf jf na jj nb jn nc jr jx jy jz ka bi translated">登录Grafana</li><li id="00fc" class="js jt hx iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">添加弹性搜索作为数据源</li><li id="ad1b" class="js jt hx iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">然后创建dashboardAdd小部件，并根据需要编写小部件的查询。</li></ul></div></div>    
</body>
</html>